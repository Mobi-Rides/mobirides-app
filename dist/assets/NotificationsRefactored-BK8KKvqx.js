import{a as Y,u as z,b as F,j as e}from"./query-vendor-Bsfdn-Hb.js";import{r as B,u as I}from"./react-vendor-mnpoGfEl.js";import{a3 as E,s as l,J as P,n as y,B as k,C as H,X as K,ak as L,y as O,W as U,D as G,al as J,b as V,d as W,e as X,I as Z,af as ee,ag as te,ah as b,ai as ae}from"./index-CEKMvnhM.js";import{N as R}from"./Navigation-DrpfU0Fc.js";import{C as se,d as re}from"./card-DVWWM3IP.js";import{N as h,n as w}from"./notificationHelpers-By0WKI5A.js";import{B as q}from"./bell-B1Cg_jQL.js";import{M as ie}from"./message-square-CfnZ98V9.js";import{C as ne}from"./calendar-BxEe8nw1.js";import{C as oe}from"./credit-card-CocXzOfZ.js";import{C as ce}from"./car-CVWSXvWw.js";import{f as de}from"./date-vendor-Dhms5dOu.js";import{S as $}from"./skeleton-CHo5tvc9.js";import{S as le}from"./settings-Bd5GrtQ9.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./map-pin-DSx0xkt_.js";import"./user-C-qQU3Ry.js";const me=()=>{const{user:t}=E(),s=Y(),{data:m=[],isLoading:i,error:g}=z({queryKey:["notifications",t==null?void 0:t.id],queryFn:async()=>{if(!(t!=null&&t.id))return[];const{data:o,error:d}=await l.from("notifications").select(`
          *,
          bookings:related_booking_id (
            id,
            start_date,
            end_date,
            total_price,
            status,
            cars (
              id,
              brand,
              model,
              image_url
            )
          ),
          cars:related_car_id (
            id,
            brand,
            model,
            image_url
          )
        `).eq("user_id",t.id).order("created_at",{ascending:!1});if(d)throw d;return o||[]},enabled:!!(t!=null&&t.id)}),n=m.filter(o=>!o.is_read).length;return B.useEffect(()=>{if(!(t!=null&&t.id))return;const o=l.channel("notifications-changes").on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["notifications",t.id]})}).subscribe();return()=>{l.removeChannel(o)}},[t==null?void 0:t.id,s]),{notifications:m,unreadCount:n,isLoading:i,error:g,markAsRead:async o=>{const{error:d}=await l.from("notifications").update({is_read:!0}).eq("id",o);return d||s.invalidateQueries({queryKey:["notifications",t==null?void 0:t.id]}),{error:d}},markAllAsRead:async()=>{if(!(t!=null&&t.id))return{error:new Error("No user")};const{error:o}=await l.from("notifications").update({is_read:!0}).eq("user_id",t.id).eq("is_read",!1);return o||s.invalidateQueries({queryKey:["notifications",t.id]}),{error:o}},deleteNotification:async o=>{const{error:d}=await l.from("notifications").delete().eq("id",o);return d||s.invalidateQueries({queryKey:["notifications",t==null?void 0:t.id]}),{error:d}}}};class ue{static async createBookingReminders(){try{const s=new Date,m=new Date(s);m.setDate(m.getDate()+1);const i=new Date(s);i.setHours(i.getHours()+2);const g=new Date(s);g.setMinutes(g.getMinutes()+30);const{data:n}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",m.toISOString().split("T")[0]).eq("preparation_reminder_sent",!1),{data:c}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",s.toISOString().split("T")[0]),{data:u}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",s.toISOString().split("T")[0]);if(n)for(const a of n){const o=`${a.cars.brand} ${a.cars.model}`;await l.from("notifications").insert({user_id:a.renter_id,type:"pickup_reminder_renter",title:"Pickup Reminder",description:`Your rental of ${o} starts tomorrow at ${a.start_time}. Please prepare for pickup.`,content:`Your rental of ${o} starts tomorrow at ${a.start_time}. Please prepare for pickup.`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:a.cars.owner_id,type:"pickup_reminder_host",title:"Pickup Reminder",description:`Your ${o} rental starts tomorrow at ${a.start_time}. Please prepare for handover.`,content:`Your ${o} rental starts tomorrow at ${a.start_time}. Please prepare for handover.`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"host_only",metadata:{}}),await l.from("bookings").update({preparation_reminder_sent:!0}).eq("id",a.id)}if(c)for(const a of c){const p=(new Date(`${a.start_date}T${a.start_time}`).getTime()-s.getTime())/(1e3*60*60);if(p<=2.5&&p>=1.5){const f=`${a.cars.brand} ${a.cars.model}`;await l.from("notifications").insert({user_id:a.renter_id,type:"pickup_reminder_renter",title:"2 Hour Pickup Reminder",description:`Your rental of ${f} starts in 2 hours at ${a.start_time}. Time to head to pickup location!`,content:`Your rental of ${f} starts in 2 hours at ${a.start_time}. Time to head to pickup location!`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:a.cars.owner_id,type:"pickup_reminder_host",title:"2 Hour Pickup Reminder",description:`Your ${f} handover is in 2 hours at ${a.start_time}. Please ensure the car is ready.`,content:`Your ${f} handover is in 2 hours at ${a.start_time}. Please ensure the car is ready.`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"host_only",metadata:{}})}}if(u)for(const a of u){const p=(new Date(`${a.start_date}T${a.start_time}`).getTime()-s.getTime())/(1e3*60);if(p<=35&&p>=25){const f=`${a.cars.brand} ${a.cars.model}`;await l.from("notifications").insert({user_id:a.renter_id,type:"pickup_reminder_renter",title:"30 Minute Pickup Reminder",description:`Your rental of ${f} starts in 30 minutes! Time for final preparations.`,content:`Your rental of ${f} starts in 30 minutes! Time for final preparations.`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:a.cars.owner_id,type:"pickup_reminder_host",title:"30 Minute Pickup Reminder",description:`Your ${f} handover is in 30 minutes! Please be ready at the pickup location.`,content:`Your ${f} handover is in 30 minutes! Please be ready at the pickup location.`,related_booking_id:a.id,related_car_id:a.cars.id,role_target:"host_only",metadata:{}})}}}catch(s){console.error("Error creating booking reminders:",s)}}static async sendPostConfirmationGuidance(s,m){try{const{data:i}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("id",s).single();if(!i)return;const g=`${i.cars.brand} ${i.cars.model}`,n=`${i.start_date} at ${i.start_time}`;m==="host"?await l.from("notifications").insert({user_id:i.cars.owner_id,type:"booking_confirmed_host",title:"Booking Confirmed - Next Steps",description:`Booking confirmed! Next steps: 1) Prepare your ${g} for handover on ${n}. 2) Ensure fuel tank is full. 3) Clean the vehicle. 4) Be ready 15 minutes early.`,content:`Booking confirmed! Next steps: 1) Prepare your ${g} for handover on ${n}. 2) Ensure fuel tank is full. 3) Clean the vehicle. 4) Be ready 15 minutes early.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"host_only",metadata:{}}):await l.from("notifications").insert({user_id:i.renter_id,type:"booking_confirmed_renter",title:"Booking Confirmed - Next Steps",description:`Booking confirmed! Next steps: 1) Prepare for pickup on ${n}. 2) Bring your driver's license. 3) Complete any required verification. 4) Arrive 15 minutes early.`,content:`Booking confirmed! Next steps: 1) Prepare for pickup on ${n}. 2) Bring your driver's license. 3) Complete any required verification. 4) Arrive 15 minutes early.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"renter_only",metadata:{}})}catch(i){console.error("Error sending post-confirmation guidance:",i)}}}const fe=()=>{const t=Y(),{user:s}=E(),m=F({mutationFn:async({bookingId:n,status:c})=>{const{error:u}=await l.from("bookings").update({status:c}).eq("id",n);if(u)throw u},onSuccess:(n,c)=>{const u=c.status==="confirmed"?"approved":"cancelled";P.success(`Booking ${u}`),c.status==="confirmed"&&s&&ue.sendPostConfirmationGuidance(c.bookingId,"host"),t.invalidateQueries({queryKey:["booking-request",c.bookingId]}),t.invalidateQueries({queryKey:["notifications"]}),t.invalidateQueries({queryKey:["bookings"]})},onError:n=>{P.error("Failed to update the booking status. Please try again.")}});return{acceptBooking:n=>{m.mutate({bookingId:n,status:"confirmed"})},declineBooking:n=>{m.mutate({bookingId:n,status:"cancelled"})},isLoading:m.status==="pending",error:m.error}};function M({notification:t,onMarkAsRead:s,onDelete:m,onAcceptBooking:i,onDeclineBooking:g,compact:n=!1}){const c=I(),u=h.classifyNotification(t),a=()=>{switch(u.type){case"booking":return e.jsx(ce,{className:"h-5 w-5"});case"payment":return e.jsx(oe,{className:"h-5 w-5"});case"handover":return e.jsx(ne,{className:"h-5 w-5"});case"message":return e.jsx(ie,{className:"h-5 w-5"});default:return e.jsx(q,{className:"h-5 w-5"})}},o=()=>{switch(u.type){case"booking":return t.type.includes("booking_confirmed")?"text-green-600":t.type.includes("booking_cancelled")?"text-red-600":"text-blue-600";case"payment":return"text-emerald-600";case"handover":return"text-orange-600";case"message":return"text-purple-600";default:return"text-gray-600"}},d=()=>{switch(u.type){case"booking":return t.type.includes("booking_confirmed")?"default":t.type.includes("booking_cancelled")?"destructive":"secondary";case"payment":return"default";case"handover":return"secondary";case"message":return"outline";default:return"outline"}},p=()=>{!t.is_read&&s&&s(t.id),h.isHandoverNotification(t)?t.related_booking_id?c(`/map?booking=${t.related_booking_id}&handover=true`):c("/map"):h.isActiveRentalNotification(t)?t.related_booking_id?c(`/rental-details/${t.related_booking_id}`):c(`/notifications/${t.id}`):u.type==="booking"&&t.related_booking_id?c(`/bookings/${t.related_booking_id}`):u.type==="payment"||h.isPaymentNotification(t)?c("/wallet"):h.isMessageNotification(t)?c("/messages"):c(`/notifications/${t.id}`)},f=t.type.includes("booking_request")&&!t.is_read&&i&&g;return e.jsx(se,{className:`
        transition-all duration-200 hover:shadow-md cursor-pointer
        ${t.is_read?"hover:bg-muted/50":"border-primary/50 bg-primary/5"}
        ${n?"p-3":""}
      `,onClick:p,children:e.jsx(re,{className:n?"p-0":"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`mt-1 ${o()}`,children:a()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm ${t.is_read?"":"font-medium"}`,children:t.content}),t.bookings&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[t.bookings.brand," ",t.bookings.model]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx(y,{variant:d(),className:"text-xs",children:u.type}),e.jsx("span",{className:"text-xs text-muted-foreground",children:de(new Date(t.created_at),{addSuffix:!0})})]})]}),f&&e.jsxs("div",{className:"flex gap-2 mt-3",onClick:x=>x.stopPropagation(),children:[e.jsxs(k,{size:"sm",onClick:()=>i(t.related_booking_id),className:"flex-1",children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),"Accept"]}),e.jsxs(k,{size:"sm",variant:"outline",onClick:()=>g(t.related_booking_id),className:"flex-1",children:[e.jsx(K,{className:"h-4 w-4 mr-1"}),"Decline"]})]}),!n&&e.jsxs("div",{className:"flex items-center gap-2 mt-3",onClick:x=>x.stopPropagation(),children:[!t.is_read&&s&&e.jsxs(k,{size:"sm",variant:"ghost",onClick:()=>s(t.id),children:[e.jsx(L,{className:"h-4 w-4 mr-1"}),"Mark as read"]}),m&&e.jsxs(k,{size:"sm",variant:"ghost",onClick:()=>m(t.id),children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),"Delete"]}),e.jsx("div",{className:"flex-1"}),e.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]})]})]})})})}const Ae=()=>{const{notifications:t,unreadCount:s,isLoading:m,markAsRead:i,markAllAsRead:g,deleteNotification:n}=me(),{acceptBooking:c,declineBooking:u}=fe(),[a,o]=B.useState(""),[d,p]=B.useState("all"),f=t.filter(r=>{const _=w(r),v=`${_.content} ${_.title||""}`.toLowerCase();return a&&!v.includes(a.toLowerCase())?!1:d==="all"?!0:d==="active_rentals"?h.isActiveRentalNotification(_):h.classifyNotification(_).type===d}),x=f.filter(r=>!r.is_read),C=f.filter(r=>r.is_read),T=async r=>{await i(r)},S=async r=>{await n(r)},Q=async()=>{await g()},D=async r=>{await c(r)},A=async r=>{await u(r)},N=(()=>{const r={all:t.length,booking:0,payment:0,active_rentals:0,system:0};return t.forEach(_=>{const v=w(_),j=h.classifyNotification(v);j.type==="booking"&&r.booking++,j.type==="payment"&&r.payment++,j.type==="system"&&r.system++,h.isActiveRentalNotification(v)&&r.active_rentals++}),r})();return m?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx($,{className:"h-8 w-32"}),e.jsx($,{className:"h-8 w-8 rounded-full"})]}),e.jsx($,{className:"h-10 w-full"}),e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((r,_)=>e.jsx($,{className:"h-20 w-full"},_))})]}),e.jsx(R,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(q,{className:"h-6 w-6 text-primary"}),e.jsx("h1",{className:"text-2xl font-bold",children:"Notifications"}),s>0&&e.jsx(y,{variant:"destructive",className:"ml-2",children:s})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(G,{children:[e.jsx(J,{asChild:!0,children:e.jsx(k,{variant:"outline",size:"sm",children:e.jsx(le,{className:"h-4 w-4"})})}),e.jsxs(V,{children:[e.jsx(W,{children:e.jsx(X,{children:"Notification Settings"})}),e.jsx("div",{className:"p-4",children:e.jsx("p",{className:"text-muted-foreground",children:"Notification preferences coming soon..."})})]})]}),s>0&&e.jsx(k,{onClick:Q,variant:"outline",size:"sm",children:"Mark all read"})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(Z,{placeholder:"Search notifications...",value:a,onChange:r=>o(r.target.value),className:"w-full"})}),e.jsxs(ee,{value:d,onValueChange:p,className:"w-full mb-6",children:[e.jsxs(te,{className:"grid w-full grid-cols-5",children:[e.jsxs(b,{value:"all",className:"flex items-center gap-2",children:["All",e.jsx(y,{variant:"secondary",className:"text-xs",children:N.all})]}),e.jsxs(b,{value:"booking",className:"flex items-center gap-2",children:["Bookings",e.jsx(y,{variant:"secondary",className:"text-xs",children:N.booking})]}),e.jsxs(b,{value:"payment",className:"flex items-center gap-2",children:["Payments",e.jsx(y,{variant:"secondary",className:"text-xs",children:N.payment})]}),e.jsxs(b,{value:"active_rentals",className:"flex items-center gap-2",children:["Rentals",e.jsx(y,{variant:"secondary",className:"text-xs",children:N.active_rentals})]}),e.jsxs(b,{value:"system",className:"flex items-center gap-2",children:["System",e.jsx(y,{variant:"secondary",className:"text-xs",children:N.system})]})]}),e.jsx(ae,{value:d,className:"mt-4",children:e.jsxs("div",{className:"space-y-4",children:[x.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-medium text-muted-foreground",children:["Unread (",x.length,")"]}),x.map(r=>e.jsx(M,{notification:w(r),onMarkAsRead:T,onDelete:S,onAcceptBooking:D,onDeclineBooking:A},`unread-${r.id}`))]}),C.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h3",{className:"text-sm font-medium text-muted-foreground",children:["Read (",C.length,")"]}),C.map(r=>e.jsx(M,{notification:w(r),onMarkAsRead:T,onDelete:S,onAcceptBooking:D,onDeclineBooking:A},`read-${r.id}`))]}),f.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(q,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No notifications found"}),e.jsx("p",{className:"text-muted-foreground",children:a?"Try adjusting your search terms":d==="all"?"You're all caught up!":`No ${d} notifications found`})]})]})})]})]}),e.jsx(R,{})]})};export{Ae as default};
