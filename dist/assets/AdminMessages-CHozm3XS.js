import{j as e,u as L}from"./query-vendor-C7aRRP05.js";import{T as S,a as F,b as g,c as r,d as k,e as t,A as B,f as R}from"./table-Cp77iLe1.js";import{r as q}from"./react-vendor-mnpoGfEl.js";import{ao as D,I as E,v as H,B as v,K as I,s as h,J as d}from"./index-CV3rVyoS.js";import{C as _,d as w,a as U,b as z}from"./card-BYz0HUlZ.js";import{S as x}from"./skeleton-CYOfnvba.js";import{F as J}from"./flag-Jmb_KKpw.js";import"./separator-BbjXUszL.js";import"./sheet-DfZNt5dY.js";import"./car-Bf051nla.js";import"./credit-card-BGIopqiK.js";import"./message-square-INBje8qK.js";import"./house-DsXGOxyt.js";import"./settings-CzuPzsxf.js";import"./log-out-BFJYZr5x.js";import"./useIsAdmin-kJkO2aIO.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./date-vendor-Dhms5dOu.js";const K=()=>L({queryKey:["admin-messages"],queryFn:async()=>{const{data:n,error:o}=await h.from("conversation_messages").select(`
          id, content, created_at, message_type, sender_id, conversation_id, related_car_id,
          sender:profiles!sender_id (
            id,
            full_name,
            avatar_url
          ),
          conversation:conversations!conversation_id (
            id,
            type,
            participants:conversation_participants (
              user_id,
              profiles!user_id (
                full_name
              )
            )
          ),
          cars:related_car_id (brand, model)
        `).order("created_at",{ascending:!1}).limit(100);if(o)throw o;return n||[]}}),$=()=>{const[n,o]=q.useState(""),{data:m,isLoading:y,error:N,refetch:u}=K(),p=(m==null?void 0:m.filter(s=>{var a,i,c,l;return s.content.toLowerCase().includes(n.toLowerCase())||((i=(a=s.sender)==null?void 0:a.full_name)==null?void 0:i.toLowerCase().includes(n.toLowerCase()))||((l=(c=s.conversation)==null?void 0:c.participants)==null?void 0:l.some(A=>{var f,j;return(j=(f=A.profiles)==null?void 0:f.full_name)==null?void 0:j.toLowerCase().includes(n.toLowerCase())}))}))||[],C=s=>{switch(s){case"text":return"default";case"image":return"secondary";case"file":return"outline";default:return"outline"}},b=s=>{var i,c;if(!((i=s.conversation)!=null&&i.participants))return"Unknown";const a=s.conversation.participants.find(l=>l.user_id!==s.sender_id);return((c=a==null?void 0:a.profiles)==null?void 0:c.full_name)||"Unknown"},M=async s=>{try{const{error:a}=await h.from("conversation_messages").update({metadata:{flagged:!0,flagged_at:new Date().toISOString()}}).eq("id",s);if(a)throw a;u(),d.success("Message flagged successfully")}catch(a){console.error("Error flagging message:",a),d.error("Failed to flag message")}},T=async s=>{if(confirm("Are you sure you want to delete this message?"))try{const{error:a}=await h.from("conversation_messages").delete().eq("id",s);if(a)throw a;u(),d.success("Message deleted successfully")}catch(a){console.error("Error deleting message:",a),d.error("Failed to delete message")}};return N?e.jsx(_,{children:e.jsx(w,{className:"p-6",children:e.jsx("p",{className:"text-destructive",children:"Failed to load messages"})})}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(D,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(E,{placeholder:"Search messages...",value:n,onChange:s=>o(s.target.value),className:"pl-8"})]})}),e.jsxs(_,{children:[e.jsx(U,{children:e.jsxs(z,{children:["Messages (",p.length,")"]})}),e.jsx(w,{children:y?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((s,a)=>e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(x,{className:"h-12 w-12"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:"h-4 w-[200px]"}),e.jsx(x,{className:"h-4 w-[100px]"})]})]},a))}):e.jsxs(S,{children:[e.jsx(F,{children:e.jsxs(g,{children:[e.jsx(r,{children:"From"}),e.jsx(r,{children:"To"}),e.jsx(r,{children:"Message"}),e.jsx(r,{children:"Related Car"}),e.jsx(r,{children:"Type"}),e.jsx(r,{children:"Date"}),e.jsx(r,{children:"Actions"})]})}),e.jsx(k,{children:p.map(s=>{var a;return e.jsxs(g,{children:[e.jsx(t,{className:"font-medium",children:((a=s.sender)==null?void 0:a.full_name)||"Unknown"}),e.jsx(t,{children:b(s)}),e.jsx(t,{className:"max-w-xs",children:e.jsx("div",{className:"truncate",children:s.content})}),e.jsx(t,{children:s.cars?`${s.cars.brand} ${s.cars.model}`:"N/A"}),e.jsx(t,{children:e.jsx(H,{variant:C(s.message_type),children:s.message_type})}),e.jsx(t,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(t,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>M(s.id),disabled:!1,children:e.jsx(J,{className:"h-4 w-4"})}),e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>T(s.id),children:e.jsx(I,{className:"h-4 w-4 text-destructive"})})]})})]},s.id)})})]})})]})]})},de=()=>e.jsx(B,{children:e.jsx(R,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Message Management"}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor platform communications and moderate content"})]}),e.jsx($,{})]})})});export{de as default};
