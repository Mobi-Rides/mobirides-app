import{a3 as v,n as w,s as t,k as q,r as M,j as e,B as A,aA as S,aB as E,aC as N,aD as j,J as u}from"./index-B1v-fdDy.js";import{B as L,N as B}from"./Navigation-B7IoAuwX.js";import{B as g}from"./badge-CMWgFMV2.js";import{S as y}from"./scroll-area-DG1WSctR.js";import{S as K}from"./separator-BMDiheLN.js";import{C as Q}from"./ChatDrawer-CK7-6vcM.js";import{S as c}from"./skeleton-B5zSXtNC.js";import{M as U}from"./mail-DK2js5Ys.js";import"./user-ClMVbWgE.js";import"./index-BdQq_4o_.js";import"./avatar-BcfxHyyU.js";import"./chevron-right-CgiltgM9.js";import"./textarea-iq9NORl0.js";import"./send-BDkAZ2Oi.js";const D=()=>{const h=v(),{data:o,isLoading:d}=w({queryKey:["messages"],queryFn:async()=>{console.log("Fetching messages");const{data:{user:a}}=await t.auth.getUser();if(!a)return[];const{data:i,error:n}=await t.from("messages").select(`
          id,
          content,
          created_at,
          sender_id,
          receiver_id,
          status,
          related_car_id,
          sender:profiles!messages_sender_id_fkey (
            id,
            full_name,
            avatar_url
          )
        `).eq("receiver_id",a.id).order("created_at",{ascending:!1});return n?(console.error("Error fetching messages:",n),[]):(console.log("Messages fetched:",i),i)},refetchInterval:5e3});return{messages:o,isLoading:d,markMessageAsRead:async a=>{const{data:{user:i}}=await t.auth.getUser();if(!i)return;const{error:n}=await t.from("messages").update({status:"read"}).eq("sender_id",a).eq("receiver_id",i.id).eq("status","sent");n?console.error("Error updating message status:",n):h.invalidateQueries({queryKey:["messages"]})}}},Y=()=>{const h=q(),o=v(),[d,x]=M.useState({isOpen:!1,senderId:"",senderName:""}),{messages:a,markMessageAsRead:i,isLoading:n}=D(),f=(a==null?void 0:a.filter(s=>s.status==="sent").length)||0,{data:l,isLoading:b}=w({queryKey:["notifications"],queryFn:async()=>{const{data:s,error:r}=await t.from("notifications").select("*").order("created_at",{ascending:!1});if(r)throw r;return s||[]}}),p=(l==null?void 0:l.filter(s=>!s.is_read).length)||0,k=async(s,r)=>{await i(s),x({isOpen:!0,senderId:s,senderName:r||"Unknown User"})},_=s=>{console.log("Navigating to notification:",s),h(`/notifications/${s}`)},C=async()=>{try{const{data:{user:s}}=await t.auth.getUser();if(!s)return;const{error:r}=await t.from("notifications").update({is_read:!0}).eq("user_id",s.id).eq("is_read",!1);if(r){console.error("Error marking notifications as read:",r),u.error("Couldn't mark notifications as read");return}const{error:m}=await t.from("messages").update({status:"read"}).eq("receiver_id",s.id).eq("status","sent");if(m){console.error("Error marking messages as read:",m),u.error("Couldn't mark messages as read");return}await o.invalidateQueries({queryKey:["notifications"]}),await o.invalidateQueries({queryKey:["messages"]}),await o.invalidateQueries({queryKey:["unreadMessagesCount"]}),await o.invalidateQueries({queryKey:["unreadNotificationsCount"]}),u.success("All notifications marked as read")}catch(s){console.error("Error in markAllAsRead:",s),u.error("Failed to mark notifications as read")}};return e.jsxs("div",{className:"min-h-screen pb-24",children:[e.jsxs("header",{className:"bg-white dark:bg-gray-900 p-4 sticky top-0 z-10 shadow-sm flex justify-between items-center",children:[e.jsx("h1",{className:"text-xl font-semibold",children:"Notifications"}),(f>0||p>0)&&e.jsx(A,{variant:"outline",size:"sm",onClick:C,children:"Mark all as read"})]}),e.jsx("main",{className:"p-4",children:e.jsxs(S,{defaultValue:"inbox",className:"w-full",children:[e.jsxs(E,{className:"grid w-full grid-cols-2",children:[e.jsxs(N,{value:"inbox",className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4"}),"Messages",f>0&&e.jsx(g,{variant:"destructive",className:"ml-2",children:f})]}),e.jsxs(N,{value:"notifications",className:"flex items-center gap-2",children:[e.jsx(L,{className:"h-4 w-4"}),"Notifications",p>0&&e.jsx(g,{variant:"destructive",className:"ml-2",children:p})]})]}),e.jsx(j,{value:"inbox",children:n?e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsx(c,{className:"h-20 w-full"}),e.jsx(c,{className:"h-20 w-full"}),e.jsx(c,{className:"h-20 w-full"})]}):a&&a.length>0?e.jsx(y,{className:"h-[calc(100vh-200px)] rounded-md border p-4",children:a.map(s=>{var r;return e.jsxs("div",{className:`mb-4 cursor-pointer hover:bg-muted p-2 rounded-md transition-colors ${s.status==="sent"?"bg-blue-50 dark:bg-blue-900/20":""}`,onClick:()=>{var m;return k(s.sender_id,((m=s.sender)==null?void 0:m.full_name)||null)},children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:((r=s.sender)==null?void 0:r.full_name)||"Unknown User"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:new Date(s.created_at).toLocaleDateString()}),s.status==="sent"&&e.jsx(g,{variant:"success",className:"ml-auto",children:"New"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.content}),e.jsx(K,{className:"my-2"})]},s.id)})}):e.jsx("div",{className:"text-center py-10 text-muted-foreground",children:e.jsx("p",{children:"No messages yet"})})}),e.jsx(j,{value:"notifications",children:b?e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsx(c,{className:"h-20 w-full"}),e.jsx(c,{className:"h-20 w-full"}),e.jsx(c,{className:"h-20 w-full"})]}):l&&l.length>0?e.jsx(y,{className:"h-[calc(100vh-200px)] rounded-md border p-4",children:e.jsx("div",{className:"space-y-4",children:l.map(s=>e.jsxs("div",{className:`p-4 rounded-lg border ${s.is_read?"bg-white dark:bg-gray-900":"bg-blue-50 dark:bg-blue-900/20"} cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors`,onClick:()=>_(s.id),children:[e.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300",children:s.content}),e.jsxs("div",{className:"flex justify-between items-center mt-2",children:[e.jsx("span",{className:"text-xs text-gray-400",children:new Date(s.created_at).toLocaleDateString()}),!s.is_read&&e.jsx(g,{variant:"success",children:"New"})]})]},s.id))})}):e.jsx("div",{className:"text-center py-10 text-muted-foreground",children:e.jsx("p",{children:"No notifications yet"})})})]})}),e.jsx(Q,{isOpen:d.isOpen,onClose:()=>x({isOpen:!1,senderId:"",senderName:""}),receiverId:d.senderId,receiverName:d.senderName}),e.jsx(B,{})]})};export{Y as default};
