import{ar as f,M as J,u as K,r as g,j as t,B as j,s as d,J as P}from"./index-BAM2AQzj.js";import{a as Y}from"./useQuery-BBHzqejZ.js";import{C as R,a as I,b as D,d as k}from"./card-C82ETfr4.js";import{T as G}from"./textarea-D1hXqD0k.js";import{I as Q}from"./ImageUpload-9eNnYZKF.js";import{S as N}from"./separator-BlDr0iOF.js";import{A as L}from"./arrow-left-ZSxCSMqd.js";import{S as V}from"./star-gaaEOnOW.js";import"./camera-DYAoZQND.js";var F={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},B=f.createContext&&f.createContext(F),X=["attr","size","title"];function Z(e,r){if(e==null)return{};var s=ee(e,r),a,l;if(Object.getOwnPropertySymbols){var m=Object.getOwnPropertySymbols(e);for(l=0;l<m.length;l++)a=m[l],!(r.indexOf(a)>=0)&&Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}function ee(e,r){if(e==null)return{};var s={};for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){if(r.indexOf(a)>=0)continue;s[a]=e[a]}return s}function b(){return b=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e},b.apply(this,arguments)}function z(e,r){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,a)}return s}function y(e){for(var r=1;r<arguments.length;r++){var s=arguments[r]!=null?arguments[r]:{};r%2?z(Object(s),!0).forEach(function(a){te(e,a,s[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):z(Object(s)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(s,a))})}return e}function te(e,r,s){return r=re(r),r in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}function re(e){var r=se(e,"string");return typeof r=="symbol"?r:r+""}function se(e,r){if(typeof e!="object"||!e)return e;var s=e[Symbol.toPrimitive];if(s!==void 0){var a=s.call(e,r||"default");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(e)}function U(e){return e&&e.map((r,s)=>f.createElement(r.tag,y({key:s},r.attr),U(r.child)))}function ae(e){return r=>f.createElement(ne,b({attr:y({},e.attr)},r),U(e.child))}function ne(e){var r=s=>{var{attr:a,size:l,title:m}=e,w=Z(e,X),p=l||s.size||"1em",c;return s.className&&(c=s.className),e.className&&(c=(c?c+" ":"")+e.className),f.createElement("svg",b({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},s.attr,a,w,{className:c,style:y(y({color:e.color||s.color},s.style),e.style),height:p,width:p,xmlns:"http://www.w3.org/2000/svg"}),m&&f.createElement("title",null,m),e.children)};return B!==void 0?f.createElement(B.Consumer,null,s=>r(s)):r(F)}function ie(e){return ae({tag:"svg",attr:{viewBox:"0 0 576 512"},child:[{tag:"path",attr:{d:"M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z"},child:[]}]})(e)}const pe=()=>{const{bookingId:e}=J(),r=K(),[s,a]=g.useState(0),[l,m]=g.useState(""),[w,p]=g.useState(!1),[c,q]=g.useState([]),[O,T]=g.useState(!1),{data:i,isLoading:$}=Y({queryKey:["booking-review",e],queryFn:async()=>{const{data:n,error:o}=await d.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            owner_id,
            vehicle_type,
            image_url
          ),
          renter:profiles!renter_id(
            full_name
          ),
          owner:profiles(
            full_name
          )
        `).eq("id",e).single();if(o)throw o;const{data:{user:x}}=await d.auth.getUser(),v=(x==null?void 0:x.id)===n.renter_id;if(v&&(!n.owner||!n.owner.full_name)){const{data:u,error:h}=await d.from("profiles").select("full_name").eq("id",n.cars.owner_id).single();!h&&u&&(n.owner=u)}else if(!v&&(!n.renter||!n.renter.full_name)){const{data:u,error:h}=await d.from("profiles").select("full_name").eq("id",n.renter_id).single();!h&&u&&(n.renter=u)}return console.log("Booking data:",n),n}});g.useEffect(()=>{(async()=>{const{data:{user:o}}=await d.auth.getUser();i&&o&&T(o.id===i.renter_id)})()},[i]);const A=n=>{if(n.target.files){const o=Array.from(n.target.files);q(o)}},M=async()=>{var n;try{p(!0);const{data:{user:o}}=await d.auth.getUser();if(!o)throw new Error("No authenticated user");const x=O?(n=i==null?void 0:i.cars)==null?void 0:n.owner_id:i==null?void 0:i.renter_id;if(!x)throw new Error("No reviewee found");const v=c.map(async C=>{const W=C.name.split(".").pop(),H=`${Date.now()}-${Math.random().toString(36).substring(7)}.${W}`,E=`${i==null?void 0:i.id}/${H}`,{error:S,data:oe}=await d.storage.from("return-photos").upload(E,C);if(S)throw S;return E}),u=await Promise.all(v),{error:h}=await d.from("reviews").insert({booking_id:e,reviewer_id:o.id,reviewee_id:x,rating:s,comment:l,images:u,review_type:"renter",updated_at:new Date().toISOString()});if(h)throw h;const{error:_}=await d.from("bookings").update({status:"completed"}).eq("id",e);if(_)throw _;P.success("Review submitted successfully"),r("/dashboard")}catch(o){console.error("Error submitting review:",o),P.error("Failed to submit review")}finally{p(!1)}};return $?t.jsx("div",{children:"Loading..."}):!i||!i.cars?t.jsxs("div",{className:"container max-w-2xl py-8",children:[t.jsxs(j,{variant:"ghost",onClick:()=>r(-1),className:"",children:[t.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]}),t.jsxs(R,{children:[t.jsx(I,{className:"text-left",children:t.jsx(D,{children:"Booking Not Found"})}),t.jsx(k,{children:t.jsx("p",{children:"This booking doesn't exist or has been removed."})})]})]}):t.jsxs("div",{className:"container max-w-2xl py-8",children:[t.jsx("div",{className:"  rounded-lg overflow-hidden mb-6",children:t.jsxs("div",{className:"flex items-center mb-4 relative ",children:[t.jsx("div",{className:"absolute left-0",children:t.jsx(j,{variant:"ghost",onClick:()=>r(-1),className:"p-0",children:t.jsx("div",{className:"flex items-center bg-gray-200 rounded-full p-1",children:t.jsx(L,{className:"h-10 w-10"})})})}),t.jsx("div",{className:"flex-1 text-center",children:t.jsx("h2",{className:"text-base md:text-lg text-slate-800 font-semibold",children:"Leave Review"})})]})}),t.jsxs(R,{className:"rounded-lg overflow-hidden border-none",children:[t.jsx("div",{className:"flex justify-center mt-8",children:t.jsx("img",{src:i.cars.image_url,alt:"Car Image",className:"w-80 h-full rounded-2xl"})}),t.jsxs(I,{className:"text-left",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"px-3 py-1 rounded-2xl text-sm bg-[#F1F0FB] text-[#7C3AED] w-fit mb-2",children:i.cars.vehicle_type}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(ie,{className:"h-4 w-4 text-yellow-400"}),t.jsx("p",{className:"text-sm md:text-base font-medium text-gray-300",children:"4.9"})]})]}),t.jsx(D,{children:t.jsxs("h3",{className:"font-medium mb-4 text-left text-lg md:text-xl text-gray-800",children:[i.cars.brand," ",i.cars.model]})}),t.jsx(N,{})]}),t.jsxs(k,{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium mb-4 text-left text-2xl md:text-2xl text-gray-800 text-center",children:"How is Your Rental Experience?"}),t.jsx(N,{})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx("h6",{className:"font-normal text-gray-400 text-sm md:text-base text-center",children:"Your Overall Rating"}),t.jsx("div",{className:"flex gap-1 text-center justify-center",children:[1,2,3,4,5].map(n=>t.jsx(j,{variant:"ghost",size:"sm",className:n<=s?"text-yellow-500":"",onClick:()=>a(n),children:t.jsx(V,{className:"h-8 w-8 ",fill:n<=s?"currentColor":"none",stroke:(n<=s,"currentColor")})},n))}),t.jsx(N,{})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx("h6",{className:"font-medium text-xs",children:"Enter Detailed Review"}),t.jsx(G,{placeholder:`Share your experience with this ${O?"host":"renter"}...`,value:l,onChange:n=>m(n.target.value),className:"min-h-[100px] bg-gray-200 rounded-2xl p-4 placeholder:text-xs"})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx(Q,{onImageChange:A}),c.length>0&&t.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.length," photo(s) selected"]})]}),t.jsx(j,{onClick:M,disabled:s===0||w,className:"w-full",children:w?"Submitting...":"Submit Review"})]})]})]})};export{pe as RentalReview,pe as default};
