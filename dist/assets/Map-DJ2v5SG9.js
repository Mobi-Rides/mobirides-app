var zt=Object.defineProperty;var Ft=(s,r,t)=>r in s?zt(s,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[r]=t;var fe=(s,r,t)=>Ft(s,typeof r!="symbol"?r+"":r,t);import{j as e,u as Bt}from"./query-vendor-C7aRRP05.js";import{r as l,u as at,d as Vt,h as ot}from"./react-vendor-mnpoGfEl.js";import{N as Ot}from"./Navigation-BQmAR9Jk.js";import{m as K}from"./mapbox-vendor-fnXFVHMy.js";import{G as qt}from"./mapbox-gl-BSycVi1q.js";import{c as ae,B as U,y as Kt,z as Gt,s as V,X as Ee,E as it,v as ne,F as lt,J as Ne,G as E,C as Ue,H as ct,K as dt,M as ut,T as mt,I as ht,S as Yt,g as Wt,h as Xt,i as Qt,k as Te,N as Jt,O as Zt,Q as es,R as we,V as Me,W as ke,Y as ts,Z as ft,_ as ss,$ as rs,a0 as ns,f as Je,a1 as as,a2 as gt,a3 as os,a4 as is,a5 as ls,a6 as cs,a7 as ds,m as us,n as ms,a8 as Ze,a9 as hs,u as fs,aa as gs,ab as ps,ac as xs}from"./index-6IS4AKTX.js";import{A as vs}from"./arrow-right-C0HAR5oA.js";import{O as ys}from"./OnlineStatusToggle-BKqWbasD.js";import{U as pt}from"./user-BZvrovAH.js";import{S as ze}from"./star-CtuliYYI.js";import{C as G,d as Y,a as me,b as he}from"./card-BUcHLe5F.js";import{C as xt}from"./car-2iUFJCfP.js";import{M as De}from"./map-pin-FLVtiGuW.js";import{P as _e}from"./progress-D1GGjrLg.js";import{C as Se}from"./camera-BjK9jpet.js";import{U as vt}from"./upload-CIPG2AjH.js";import{C as $e}from"./checkbox-BJEVpui9.js";import{K as js}from"./key-DDGolrKq.js";import{C as ue}from"./circle-check-big-d5A8z5yQ.js";import{R as ws}from"./rotate-ccw-CFBGzNS_.js";import{C as Ke}from"./clock-CB1OvN9s.js";import{F as bs}from"./flag-BnyJdV8A.js";import{N as et}from"./navigation-CKvLcMTn.js";import{C as Re}from"./circle-alert-Daz2DWEY.js";import{L as Ns}from"./loader-circle-Ot9Hz-N1.js";import{u as Ss}from"./useAuthStatus-rMpbrno3.js";import{C as _s}from"./calendar-YxHZMy97.js";import{D as ks}from"./dollar-sign-63-VeiGp.js";import{a as tt}from"./date-vendor-Dhms5dOu.js";import{H as Cs}from"./house-C9ZVp3VQ.js";import"./bell-ClNaiYuo.js";import"./supabase-vendor-BOn0LdFJ.js";import"./switch-B8vlZbHE.js";import"./index-DE7TNQN2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=ae("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rs=ae("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=ae("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ds=ae("GripHorizontal",[["circle",{cx:"12",cy:"9",r:"1",key:"124mty"}],["circle",{cx:"19",cy:"9",r:"1",key:"1ruzo2"}],["circle",{cx:"5",cy:"9",r:"1",key:"1a8b28"}],["circle",{cx:"12",cy:"15",r:"1",key:"1e56xg"}],["circle",{cx:"19",cy:"15",r:"1",key:"1a92ep"}],["circle",{cx:"5",cy:"15",r:"1",key:"5r1jwy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Is=ae("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=ae("Navigation2",[["polygon",{points:"12 2 19 21 12 17 5 21 12 2",key:"x8c0qg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hs=ae("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yt=ae("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ps=ae("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ls=ae("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);function Ts({onUp:s,onDown:r,onLeft:t,onRight:n,onReset:o}){return e.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[e.jsx("div",{className:"flex gap-1",children:e.jsx(U,{variant:"default",onClick:s,style:{height:40},children:e.jsx(Rs,{name:"arrow-up",size:24,color:"white"})})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(U,{variant:"default",onClick:t,style:{width:20},children:e.jsx(Kt,{name:"arrow-left",size:24,color:"white"})}),e.jsx(U,{variant:"default",onClick:o,children:e.jsx(Gt,{name:"arrow-left",size:24,color:"white"})}),e.jsx(U,{variant:"default",onClick:n,style:{width:20},children:e.jsx(vs,{name:"arrow-right",size:24,color:"white"})})]}),e.jsx("div",{className:"flex gap-1",children:e.jsx(U,{variant:"default",onClick:r,style:{height:40},children:e.jsx(Es,{name:"arrow-down",size:24,color:"white"})})})]})}const $s=({host:s,onViewCars:r})=>{const t=()=>s.avatar_url?V.storage.from("avatars").getPublicUrl(s.avatar_url).data.publicUrl:"/placeholder.svg";return e.jsx("div",{className:"bg-background border rounded-lg shadow-lg p-3 min-w-[200px] cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>r(s.id),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex items-center justify-center",children:s.avatar_url?e.jsx("img",{src:t(),alt:s.full_name||"Host",className:"w-full h-full object-cover"}):e.jsx(pt,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:s.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(ze,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32)"})]}),e.jsx("p",{className:"text-xs text-primary mt-1",children:"View available cars →"})]})]})})},As=({isOpen:s,onClose:r,host:t})=>{const[n,o]=l.useState([]),[a,m]=l.useState(!1),g=at();l.useEffect(()=>{s&&(t!=null&&t.id)&&i(t.id)},[s,t==null?void 0:t.id]);const i=async h=>{m(!0);try{const{data:_,error:c}=await V.from("cars").select("*").eq("owner_id",h).eq("is_available",!0);if(c){console.error("Error fetching host cars:",c);return}o(_||[])}catch(_){console.error("Error in fetchHostCars:",_)}finally{m(!1)}},u=h=>{if(!h)return console.warn("No image URL provided, using placeholder"),"/placeholder.svg";try{return h.startsWith("http://")||h.startsWith("https://")?h:V.storage.from("car-images").getPublicUrl(h).data.publicUrl}catch(_){return console.error("Error processing image URL:",_,"Original URL:",h),"/placeholder.svg"}},y=()=>t!=null&&t.avatar_url?V.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",d=h=>{g(`/cars/${h}`),r()};return s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:r}),e.jsx("div",{className:"fixed left-0 top-0 h-full w-80 bg-background border-r shadow-xl z-50 transform transition-transform duration-300",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Host's Cars"}),e.jsx(U,{variant:"ghost",size:"sm",onClick:r,children:e.jsx(Ee,{className:"w-4 h-4"})})]}),t&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:y(),alt:t.full_name||"Host",className:"w-10 h-10 rounded-full object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ze,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32 reviews)"})]})]})]})]}),e.jsx(it,{className:"flex-1",children:e.jsx("div",{className:"p-4 space-y-4",children:a?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."})}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(xt,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No available cars"})]}):n.map(h=>e.jsx(G,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>d(h.id),children:e.jsxs(Y,{className:"p-3",children:[e.jsx("div",{className:"aspect-video w-full mb-3 rounded-lg overflow-hidden bg-muted",children:e.jsx("img",{src:u(h.image_url),alt:`${h.brand} ${h.model}`,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm",children:[h.brand," ",h.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:h.year})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-sm",children:["P",h.price_per_day]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"per day"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(De,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:h.location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(ne,{variant:"secondary",className:"text-xs px-2 py-1",children:h.vehicle_type}),e.jsxs("span",{className:"text-muted-foreground",children:[h.seats," seats"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:h.transmission})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ze,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.5 (12)"})]})]})]})},h.id))})})]})})]}):null},Us=({mapbox_token:s,longitude:r,latitude:t,onlineHosts:n,mapStyle:o="mapbox://styles/mapbox/streets-v12",isHandoverMode:a=!1,bookingId:m,zoom:g,interactive:i,dpad:u,locationToggle:y,destination:d,returnLocation:h})=>{const _=l.useRef(null),c=l.useRef(null),p=l.useRef(null),[f,j]=l.useState(!1),[w,L]=l.useState({latitude:t,longitude:r}),[k,z]=l.useState([]),[$,q]=l.useState([]),[I,F]=l.useState(null),[C,S]=l.useState(!1),b=lt(),D=a?b:null;l.useEffect(()=>{if(!h)return;const P=w.longitude,R=w.latitude;h(P,R)},[w]),l.useEffect(()=>{if(s&&(K.accessToken=s),!c.current&&_.current&&s){c.current=new K.Map({container:_.current,style:o,center:[r,t],zoom:g||14,interactive:i||!0}),c.current.addControl(new K.NavigationControl,"top-right");const P=new K.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});c.current.addControl(P,"top-right"),p.current=P,P.on("error",R=>{console.error("Geolocation error:",R),Ne.error("Unable to access your location. Please check your browser permissions."),a&&D&&Ne.error("Location sharing is required for the handover process. Please enable location access.")}),c.current.on("load",()=>{console.log("Map loaded successfully"),j(!0),p.current&&p.current.on("geolocate",R=>{console.log("Geolocate event fired:",R.coords);const x={longitude:R.coords.longitude,latitude:R.coords.latitude};L(x),console.log("User location updated:",x),a&&D&&(console.log("In handover mode, updating handover location..."),T(x.latitude,x.longitude).then(M=>{console.log("Address fetched:",M),D.updateLocation({latitude:x.latitude,longitude:x.longitude,address:M||"Unknown location"})}))}),setTimeout(()=>{p.current&&p.current.trigger()},1e3)}),c.current.on("error",R=>{console.error("Map error:",R),Ne.error("Error loading map. Please refresh.")}),h&&c.current.on("click",R=>{console.log("Map clicked at coordinates:",R.lngLat),h(R.lngLat.lng,R.lngLat.lat)})}return()=>{c.current&&(c.current.remove(),c.current=null)}},[s,r,t,o,a,D]);const T=async(P,R)=>{try{const M=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${R},${P}.json?access_token=${s}`)).json();return M.features&&M.features.length>0?M.features[0].place_name:null}catch(x){return console.error("Error fetching address:",x),null}};l.useEffect(()=>{c.current&&f&&c.current.setStyle(o)},[o,f]);const W=P=>{console.log("Trying to view cars for host:",P);const R=n==null?void 0:n.find(x=>x.id===P);if(console.log("Found host:",R),R){const x={id:R.id,full_name:R.full_name,avatar_url:R.avatar_url,latitude:R.latitude,longitude:R.longitude,updated_at:R.updated_at};console.log("Setting selected host:",x),F(x),S(!0)}else console.log("No host found with ID:",P)},X=P=>{if(!c.current||!f||!w.latitude||!w.longitude)return;(async()=>{try{const M=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${P.longitude},${P.latitude}?geometries=geojson&access_token=${K.accessToken}`)).json();if(M.routes&&M.routes.length>0){const Z=M.routes[0].geometry;c.current.getSource("host-route")?c.current.getSource("host-route").setData(Z):(c.current.addSource("host-route",{type:"geojson",data:Z}),c.current.addLayer({id:"host-route",type:"line",source:"host-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":P.isActiveHandover?"#ef4444":"#3b82f6","line-width":P.isActiveHandover?6:4}}));const se=new K.LngLatBounds().extend([w.longitude,w.latitude]).extend([P.longitude,P.latitude]);c.current.fitBounds(se,{padding:50,maxZoom:15})}}catch(x){console.error("Error fetching route to host:",x),Ne.error("Unable to calculate route")}})()};l.useEffect(()=>{if(!c.current||!f||!(n!=null&&n.length))return;k.forEach(x=>x.remove()),z([]);const P=n.map(x=>{if(!x.latitude||!x.longitude)return null;const M=document.createElement("div");M.className="host-marker",M.style.width=x.isActiveHandover?"24px":"20px",M.style.height=x.isActiveHandover?"24px":"20px",M.style.borderRadius="50%",M.style.backgroundColor=x.isActiveHandover?"#ef4444":"#4ade80",M.style.border=x.isActiveHandover?"3px solid white":"2px solid white",M.style.boxShadow=x.isActiveHandover?"0 0 15px rgba(239, 68, 68, 0.5)":"0 0 10px rgba(0, 0, 0, 0.3)",M.style.cursor="pointer",x.isActiveHandover&&(M.style.animation="pulse 2s infinite");const Z=document.createElement("div"),se=new K.Marker(M).setLngLat([x.longitude,x.latitude]).addTo(c.current);return M.addEventListener("mouseenter",()=>{Vt.render(e.jsx($s,{host:x,onViewCars:W}),Z);const ie=new K.Popup({offset:25,closeButton:!1,closeOnClick:!1,className:"host-popup"}).setDOMContent(Z).addTo(c.current);se.setPopup(ie),ie.addTo(c.current)}),M.addEventListener("mouseleave",()=>{setTimeout(()=>{const ie=se.getPopup();ie&&ie.remove()},100)}),M.addEventListener("click",()=>{W(x.id),c.current&&f&&(async()=>{try{const le=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${x.longitude},${x.latitude}?geometries=geojson&access_token=${K.accessToken}`)).json();if(le.routes&&le.routes.length>0){const ce=le.routes[0].geometry;c.current.getSource("route")?c.current.getSource("route").setData(ce):(c.current.addSource("route",{type:"geojson",data:ce}),c.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}));const pe=new K.LngLatBounds().extend([w.longitude,w.latitude]).extend([x.longitude,x.latitude]);c.current.fitBounds(pe,{padding:50,maxZoom:15})}}catch(ye){console.error("Error fetching route to host:",ye),Ne.error("Unable to calculate route")}})()}),se}).filter(Boolean);z(P);const R=n==null?void 0:n.find(x=>x.isActiveHandover);R&&w.latitude&&w.longitude&&setTimeout(()=>{X(R)},1e3)},[n,f,a,w]),l.useEffect(()=>{if(!c.current||!f||!d)return;const{latitude:P,longitude:R}=d,x=document.createElement("div");x.className="destination-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#f59e0b",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const M=new K.Marker(x).setLngLat([R,P]).setPopup(new K.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(c.current);return()=>{M.remove()}}),l.useEffect(()=>{if(!c.current||!f||!d)return;const{latitude:P,longitude:R}=d;return(async()=>{try{const Z=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${R},${P}?geometries=geojson&access_token=${K.accessToken}`)).json();if(Z.routes&&Z.routes.length>0){const se=Z.routes[0].geometry;c.current.getSource("route")?c.current.getSource("route").setData(se):(c.current.addSource("route",{type:"geojson",data:se}),c.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(M){console.error("Error fetching route:",M)}})(),()=>{c.current&&(c.current.getStyle()&&c.current.getLayer("route")&&c.current.removeLayer("route"),c.current.getStyle()&&c.current.getSource("route")&&c.current.removeSource("route"))}},[f,d,w]),l.useEffect(()=>{if(!c.current||!f||!a||!(D!=null&&D.handoverStatus))return;$.forEach(R=>R.remove()),q([]);const P=[];if(D.handoverStatus.host_location){const R=D.handoverStatus.host_location,x=document.createElement("div");x.className="host-handover-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#3b82f6",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const M=new K.Marker(x).setLngLat([R.longitude,R.latitude]).setPopup(new K.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${R.address}</p>`)).addTo(c.current);P.push(M)}if(D.handoverStatus.renter_location){const R=D.handoverStatus.renter_location,x=document.createElement("div");x.className="renter-handover-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#ec4899",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const M=new K.Marker(x).setLngLat([R.longitude,R.latitude]).setPopup(new K.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${R.address}</p>`)).addTo(c.current);P.push(M)}if(P.length===2&&c.current){const R=new K.LngLatBounds;P.forEach(x=>{R.extend(x.getLngLat())}),c.current.fitBounds(R,{padding:100,maxZoom:15})}q(P)},[D==null?void 0:D.handoverStatus,f,a]);const J=()=>{c.current&&c.current.panBy([0,-100],{duration:500})},Q=()=>{c.current&&c.current.panBy([0,100],{duration:500})},oe=()=>{c.current&&c.current.panBy([-100,0],{duration:500})},ge=()=>{c.current&&c.current.panBy([100,0],{duration:500})},te=()=>{c.current&&c.current.flyTo({center:[w.longitude,w.latitude],zoom:20,essential:!0})};return e.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[e.jsx("div",{ref:_,className:"w-full h-full"}),!a&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:y&&e.jsx(ys,{lat:w.latitude,long:w.longitude})})}),a&&(D==null?void 0:D.handoverStatus)&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm font-medium",children:[D.isHost?"Host":"Renter"," Mode"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:D.handoverStatus.host_location&&D.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),u&&e.jsx(Ts,{onUp:J,onDown:Q,onLeft:oe,onRight:ge,onReset:te}),e.jsx(As,{isOpen:C,onClose:()=>S(!1),host:I})]})},zs=async()=>{try{const{data:s,error:r}=await V.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(r)return console.error("Error checking location columns:",r),!1;if(!s||s.length===0)return console.error("No profiles found to check columns"),!1;const t=s[0];return t?"latitude"in t&&"longitude"in t&&"is_sharing_location"in t:!1}catch(s){return console.error("Error in checkLocationColumns:",s),!1}},Fs=s=>!s||typeof s!="object"?null:{id:typeof s.id=="string"?s.id:"",full_name:s.full_name||null,avatar_url:s.avatar_url||null,latitude:typeof s.latitude=="number"?s.latitude:null,longitude:typeof s.longitude=="number"?s.longitude:null,updated_at:s.updated_at||null},Bs=async()=>{try{if(console.log("Fetching online hosts..."),!await zs())return console.error("Required location columns don't exist in profiles table"),[];const{data:r,error:t}=await V.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(t)return console.error("Error fetching online hosts:",t),[];if(!r||!Array.isArray(r))return console.error("Expected array of hosts but got:",r),[];console.log(`Found ${r.length} online hosts`);const n=[];for(const o of r){const a=Fs(o);a&&n.push(a)}return n}catch(s){return console.error("Error in fetchOnlineHosts:",s),[]}},Vs={maxWidth:1920,maxHeight:1080,quality:.8,maxSizeKB:1024},jt=async(s,r={})=>{const t={...Vs,...r};return s.size<=t.maxSizeKB*1024?s:new Promise((n,o)=>{const a=document.createElement("canvas"),m=a.getContext("2d"),g=new Image;g.onload=()=>{try{URL.revokeObjectURL(i);const{width:u,height:y}=Os(g.width,g.height,t.maxWidth,t.maxHeight);a.width=u,a.height=y,m.drawImage(g,0,0,u,y),a.toBlob(d=>{if(!d){o(new Error("Failed to compress image"));return}const h=new File([d],s.name,{type:d.type||s.type,lastModified:Date.now()});if(h.size>t.maxSizeKB*1024&&t.quality>.3){const _={...t,quality:Math.max(.3,t.quality-.2)};jt(s,_).then(n).catch(o)}else n(h)},s.type.startsWith("image/")?s.type:"image/jpeg",t.quality)}catch(u){o(u)}},g.onerror=()=>{o(new Error("Failed to load image"))};const i=URL.createObjectURL(s);g.src=i})},Os=(s,r,t,n)=>{let{width:o,height:a}={width:s,height:r};return o>t&&(a=a*t/o,o=t),a>n&&(o=o*n/a,a=n),{width:Math.round(o),height:Math.round(a)}},Ae=s=>{if(s===0)return"0 Bytes";const r=1024,t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(s)/Math.log(r));return parseFloat((s/Math.pow(r,n)).toFixed(2))+" "+t[n]},qs=s=>s.type.startsWith("image/"),Ce=[{name:"navigation",order:1,title:"Navigate to Location",description:"Get directions to the handover location"},{name:"identity_verification",order:2,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:3,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:4,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:5,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:6,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:7,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:8,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:9,title:"Handover Complete",description:"Finalize the handover process"}],Ks=async s=>{try{const{data:r}=await V.from("handover_step_completion").select("id").eq("handover_session_id",s);if(r&&r.length>0)return!0;const t=Ce.map(o=>({handover_session_id:s,step_name:o.name,step_order:o.order,is_completed:!1})),{error:n}=await V.from("handover_step_completion").insert(t);if(n)throw n;return!0}catch(r){return console.error("Error initializing handover steps:",r),E.error("Failed to initialize handover steps"),!1}},st=async s=>{try{const{data:r,error:t}=await V.from("handover_step_completion").select("*").eq("handover_session_id",s).order("step_order");if(t)throw t;return r||[]}catch(r){return console.error("Error fetching handover steps:",r),[]}},Gs=async(s,r,t)=>{var n;try{const{data:o}=await V.auth.getUser();if(!((n=o==null?void 0:o.user)!=null&&n.id))throw new Error("User not authenticated");const{data:a,error:m}=await V.from("handover_step_completion").select("step_order, is_completed").eq("handover_session_id",s).eq("step_name",r).single();if(m)throw new Error(`Step lookup failed: ${m.message}`);if(!a)throw new Error("Step not found");if(a.is_completed)return E.info(`${r.replace("_"," ")} is already completed`),!0;const g=await Ys(s,r,t);if(!g.isValid)return E.error(g.message),!1;const i={is_completed:!0,completed_by:o.user.id,completion_data:t,completed_at:new Date().toISOString()},{error:u}=await V.from("handover_step_completion").update(i).eq("handover_session_id",s).eq("step_name",r);if(u){if(u.message.includes("Previous steps must be completed"))E.error("Please complete previous steps first");else throw console.error("Database update error:",u),u;return!1}return E.success(`${r.replace("_"," ")} completed`),!0}catch(o){return console.error(`Error completing handover step ${r}:`,o),o.message.includes("Previous steps must be completed")?E.error("Please complete previous steps in order"):E.error(`Failed to complete handover step: ${o.message}`),!1}},Ys=async(s,r,t)=>{switch(r){case"fuel_mileage_check":if(!(t!=null&&t.fuel_level)||!(t!=null&&t.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};const n=Number(t.fuel_level);if(n<0||n>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(Number(t.mileage)<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(t!=null&&t.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},Ge=async(s,r,t,n=3,o)=>{var m;let a=0;for(;a<n;)try{const{data:g}=await V.auth.getUser();if(!((m=g==null?void 0:g.user)!=null&&m.id))throw new Error("User not authenticated");o==null||o(10);let i=s;if(qs(s)&&s.size>500*1024){const c=Ae(s.size);try{i=await jt(s,{maxWidth:1920,maxHeight:1080,quality:.8,maxSizeKB:1024});const p=Ae(i.size),f=((s.size-i.size)/s.size*100).toFixed(1);console.log(`Image compressed: ${c} → ${p} (${f}% reduction)`),E.success(`Image optimized: ${f}% smaller`)}catch(p){console.warn("Image compression failed, uploading original:",p),E.info("Uploading original image (compression failed)"),i=s}}o==null||o(30);const u=i.name.split(".").pop(),y=`${g.user.id}/${r}/${t}_${Date.now()}.${u}`;o==null||o(50);const{error:d}=await V.storage.from("handover-photos").upload(y,i);if(d)throw d;o==null||o(80);const{data:{publicUrl:h}}=V.storage.from("handover-photos").getPublicUrl(y);o==null||o(100);const _=Ae(i.size);return E.success(`Photo uploaded successfully (${_})`),h}catch(g){if(a++,console.error(`Photo upload attempt ${a} failed:`,g),a>=n)return E.error("Failed to upload photo after multiple attempts"),o==null||o(0),null;E.info(`Upload failed, retrying... (${a}/${n})`),o==null||o(0),await new Promise(i=>setTimeout(i,1e3*a))}return null},Ws=async s=>{var r;try{const{data:t}=await V.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const n={handover_session_id:s.handover_session_id,booking_id:s.booking_id,car_id:s.car_id,report_type:s.report_type,vehicle_photos:JSON.stringify(s.vehicle_photos),damage_reports:JSON.stringify(s.damage_reports),fuel_level:s.fuel_level,mileage:s.mileage,exterior_condition_notes:s.exterior_condition_notes,interior_condition_notes:s.interior_condition_notes,additional_notes:s.additional_notes,digital_signature_data:s.digital_signature_data,is_acknowledged:s.is_acknowledged,reporter_id:s.reporter_id||t.user.id},{data:o,error:a}=await V.from("vehicle_condition_reports").insert(n).select().single();if(a)throw a;return o}catch(t){return console.error("Error creating vehicle condition report:",t),E.error("Failed to create condition report"),null}},Xs=async s=>{var r;try{const{data:t}=await V.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const n={handover_session_id:s.handover_session_id,verifier_id:t.user.id,verified_user_id:s.verified_user_id,verification_photo_url:s.verification_photo_url,license_photo_url:s.license_photo_url,verification_status:s.verification_status,verification_notes:s.verification_notes},{data:o,error:a}=await V.from("identity_verification_checks").insert(n).select().single();if(a)throw a;return o}catch(t){return console.error("Error creating identity verification check:",t),E.error("Failed to create identity verification"),null}},Qs=({handoverSessionId:s,otherUserId:r,otherUserName:t,isHost:n,onStepComplete:o})=>{const[a,m]=l.useState(null),[g,i]=l.useState(!1),[u,y]=l.useState(0),[d,h]=l.useState("pending"),[_,c]=l.useState(""),[p,f]=l.useState(!1),j=async L=>{var z;const k=(z=L.target.files)==null?void 0:z[0];if(k){i(!0),y(0);try{const $=await Ge(k,s,"identity_verification",3,q=>y(q));$&&(m($),await Xs({handover_session_id:s,verifier_id:"",verified_user_id:r,verification_photo_url:$,verification_status:"pending"}))}catch{E.error("Failed to upload verification photo")}finally{i(!1),y(0)}}},w=async L=>{f(!0);try{h(L),L==="verified"?(E.success(`${t}'s identity verified successfully`),o()):E.error("Identity verification failed")}catch{E.error("Failed to update verification status")}finally{f(!1)}};return e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",t,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx(Y,{className:"space-y-4",children:a?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:a,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(ne,{variant:d==="verified"?"default":d==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[d==="verified"&&e.jsx(Ue,{className:"h-3 w-3 mr-1"}),d==="failed"&&e.jsx(Ee,{className:"h-3 w-3 mr-1"}),d.charAt(0).toUpperCase()+d.slice(1)]})]}),d==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(ct,{placeholder:"Add any notes about the verification...",value:_,onChange:L=>c(L.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(U,{onClick:()=>w("verified"),disabled:p,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(U,{onClick:()=>w("failed"),disabled:p,variant:"destructive",className:"flex-1",children:[e.jsx(Ee,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),d==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),d==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(Se,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",t," for identity verification"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:j,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:g}),e.jsx(U,{disabled:g,className:"flex items-center gap-2",children:g?e.jsxs(e.Fragment,{children:[e.jsx(vt,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"h-4 w-4"}),"Take Photo"]})})]}),g&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{value:u,className:"w-full"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:u<30?"Optimizing image...":u<80?"Uploading...":"Finalizing..."})]})]})]})})]})},Js={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},rt=({handoverSessionId:s,inspectionType:r,onPhotosUpdate:t,onStepComplete:n,initialPhotos:o=[]})=>{const[a,m]=l.useState(o),[g,i]=l.useState(!1),[u,y]=l.useState(null),[d,h]=l.useState({}),_=l.useRef({}),c=Js[r],p=c.filter(I=>I.required),f=p.filter(I=>a.some(F=>F.type===I.type)),j=async(I,F)=>{i(!0),y(I),h(C=>({...C,[I]:0}));try{const C=await Ge(F,s,I,3,S=>h(b=>({...b,[I]:S})));if(C){const S={id:`${Date.now()}-${I}`,type:I,url:C,timestamp:new Date().toISOString()},b=[...a,S];m(b),t(b)}}catch{E.error("Failed to upload photo")}finally{i(!1),y(null),h(C=>({...C,[I]:0}))}},w=I=>{const F=_.current[I];F&&(y(I),F.click())},L=(I,F)=>{var S;const C=(S=I.target.files)==null?void 0:S[0];C&&j(F,C),I.target.value=""},k=I=>{const F=a.filter(C=>C.id!==I);m(F),t(F)},z=I=>a.find(F=>F.type===I),$=f.length===p.length,q=()=>{$&&(n(),E.success(`${r} inspection completed`))};return e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-5 w-5"}),r==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(ne,{variant:$?"default":"secondary",children:[f.length,"/",p.length," Required Photos"]})})]}),e.jsxs(Y,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:c.map(I=>{const F=z(I.type),C=u===I.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:I.label}),I.required&&e.jsx(ne,{variant:"outline",className:"text-xs",children:"Required"})]}),F?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:F.url,alt:I.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(U,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>k(F.id),children:e.jsx(dt,{className:"h-4 w-4"})})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>w(I.type),children:[e.jsx("input",{ref:S=>_.current[I.type]=S,type:"file",accept:"image/*",capture:"environment",onChange:S=>L(S,I.type),className:"hidden"}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full p-2",children:C&&u===I.type?e.jsxs("div",{className:"w-full space-y-2",children:[e.jsx(vt,{className:"h-6 w-6 animate-spin text-gray-400 mx-auto"}),e.jsx(_e,{value:d[I.type]||0,className:"w-full h-2"}),e.jsx("span",{className:"text-xs text-gray-500 text-center block",children:(d[I.type]||0)<30?"Optimizing...":(d[I.type]||0)<80?"Uploading...":"Finalizing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ut,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})]},I.type)})}),$&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(U,{onClick:q,className:"w-full",children:["Complete ",r==="exterior"?"Exterior":"Interior"," Inspection"]})}),!$&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},Zs=({handoverSessionId:s,onDamageReportsUpdate:r,onStepComplete:t,initialReports:n=[]})=>{const[o,a]=l.useState(n),[m,g]=l.useState(!1),[i,u]=l.useState({location:"",severity:"minor",description:"",photos:[]}),[y,d]=l.useState(!1),h=async f=>{d(!0);try{const j=await Ge(f,s,"damage_specific");j&&(u(w=>({...w,photos:[...w.photos,j]})),E.success("Damage photo uploaded"))}catch{E.error("Failed to upload damage photo")}finally{d(!1)}},_=()=>{if(!i.location||!i.description){E.error("Please fill in location and description");return}const f={id:`damage-${Date.now()}`,location:i.location,severity:i.severity,description:i.description,photos:i.photos,timestamp:new Date().toISOString()},j=[...o,f];a(j),r(j),u({location:"",severity:"minor",description:"",photos:[]}),g(!1),E.success("Damage report added")},c=f=>{const j=o.filter(w=>w.id!==f);a(j),r(j)},p=f=>{switch(f){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(mt,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs(Y,{className:"space-y-4",children:[o.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",o.length,")"]}),o.map(f=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:f.location}),e.jsx(ne,{className:`ml-2 ${p(f.severity)}`,children:f.severity})]}),e.jsx(U,{size:"sm",variant:"outline",onClick:()=>c(f.id),children:e.jsx(dt,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:f.description}),f.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:f.photos.map((j,w)=>e.jsx("img",{src:j,alt:`Damage ${w+1}`,className:"w-full h-20 object-cover rounded"},w))})]},f.id))]}),m?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(ht,{placeholder:"e.g., Front bumper, Driver door",value:i.location,onChange:f=>u(j=>({...j,location:f.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(Yt,{value:i.severity,onValueChange:f=>u(j=>({...j,severity:f})),children:[e.jsx(Wt,{children:e.jsx(Xt,{})}),e.jsxs(Qt,{children:[e.jsx(Te,{value:"minor",children:"Minor"}),e.jsx(Te,{value:"moderate",children:"Moderate"}),e.jsx(Te,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(ct,{placeholder:"Describe the damage in detail...",value:i.description,onChange:f=>u(j=>({...j,description:f.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[i.photos.map((f,j)=>e.jsx("img",{src:f,alt:`Damage photo ${j+1}`,className:"w-full h-20 object-cover rounded"},j)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:f=>{var w;const j=(w=f.target.files)==null?void 0:w[0];j&&h(j)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:y}),e.jsx(Se,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{onClick:_,className:"flex-1",children:"Save Damage Report"}),e.jsx(U,{variant:"outline",onClick:()=>g(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(U,{onClick:()=>g(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(U,{onClick:t,className:"w-full",children:o.length>0?`Complete Documentation (${o.length} damage reports)`:"No Damage - Complete Step"})})]})]})};var wt=["PageUp","PageDown"],bt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],Nt={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},be="Slider",[Be,er,tr]=es(be),[St,mn]=Zt(be,[tr]),[sr,Ie]=St(be),_t=l.forwardRef((s,r)=>{const{name:t,min:n=0,max:o=100,step:a=1,orientation:m="horizontal",disabled:g=!1,minStepsBetweenThumbs:i=0,defaultValue:u=[n],value:y,onValueChange:d=()=>{},onValueCommit:h=()=>{},inverted:_=!1,form:c,...p}=s,f=l.useRef(new Set),j=l.useRef(0),L=m==="horizontal"?rr:nr,[k=[],z]=Jt({prop:y,defaultProp:u,onChange:S=>{var D;(D=[...f.current][j.current])==null||D.focus(),d(S)}}),$=l.useRef(k);function q(S){const b=cr(k,S);C(S,b)}function I(S){C(S,j.current)}function F(){const S=$.current[j.current];k[j.current]!==S&&h(k)}function C(S,b,{commit:D}={commit:!1}){const T=hr(a),W=fr(Math.round((S-n)/a)*a+n,T),X=ft(W,[n,o]);z((J=[])=>{const Q=ir(J,X,b);if(mr(Q,i*a)){j.current=Q.indexOf(X);const oe=String(Q)!==String(J);return oe&&D&&h(Q),oe?Q:J}else return J})}return e.jsx(sr,{scope:s.__scopeSlider,name:t,disabled:g,min:n,max:o,valueIndexToChangeRef:j,thumbs:f.current,values:k,orientation:m,form:c,children:e.jsx(Be.Provider,{scope:s.__scopeSlider,children:e.jsx(Be.Slot,{scope:s.__scopeSlider,children:e.jsx(L,{"aria-disabled":g,"data-disabled":g?"":void 0,...p,ref:r,onPointerDown:we(p.onPointerDown,()=>{g||($.current=k)}),min:n,max:o,inverted:_,onSlideStart:g?void 0:q,onSlideMove:g?void 0:I,onSlideEnd:g?void 0:F,onHomeKeyDown:()=>!g&&C(n,0,{commit:!0}),onEndKeyDown:()=>!g&&C(o,k.length-1,{commit:!0}),onStepKeyDown:({event:S,direction:b})=>{if(!g){const W=wt.includes(S.key)||S.shiftKey&&bt.includes(S.key)?10:1,X=j.current,J=k[X],Q=a*W*b;C(J+Q,X,{commit:!0})}}})})})})});_t.displayName=be;var[kt,Ct]=St(be,{startEdge:"left",endEdge:"right",size:"width",direction:1}),rr=l.forwardRef((s,r)=>{const{min:t,max:n,dir:o,inverted:a,onSlideStart:m,onSlideMove:g,onSlideEnd:i,onStepKeyDown:u,...y}=s,[d,h]=l.useState(null),_=ke(r,L=>h(L)),c=l.useRef(),p=ts(o),f=p==="ltr",j=f&&!a||!f&&a;function w(L){const k=c.current||d.getBoundingClientRect(),z=[0,k.width],q=Ye(z,j?[t,n]:[n,t]);return c.current=k,q(L-k.left)}return e.jsx(kt,{scope:s.__scopeSlider,startEdge:j?"left":"right",endEdge:j?"right":"left",direction:j?1:-1,size:"width",children:e.jsx(Et,{dir:p,"data-orientation":"horizontal",...y,ref:_,style:{...y.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:L=>{const k=w(L.clientX);m==null||m(k)},onSlideMove:L=>{const k=w(L.clientX);g==null||g(k)},onSlideEnd:()=>{c.current=void 0,i==null||i()},onStepKeyDown:L=>{const z=Nt[j?"from-left":"from-right"].includes(L.key);u==null||u({event:L,direction:z?-1:1})}})})}),nr=l.forwardRef((s,r)=>{const{min:t,max:n,inverted:o,onSlideStart:a,onSlideMove:m,onSlideEnd:g,onStepKeyDown:i,...u}=s,y=l.useRef(null),d=ke(r,y),h=l.useRef(),_=!o;function c(p){const f=h.current||y.current.getBoundingClientRect(),j=[0,f.height],L=Ye(j,_?[n,t]:[t,n]);return h.current=f,L(p-f.top)}return e.jsx(kt,{scope:s.__scopeSlider,startEdge:_?"bottom":"top",endEdge:_?"top":"bottom",size:"height",direction:_?1:-1,children:e.jsx(Et,{"data-orientation":"vertical",...u,ref:d,style:{...u.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:p=>{const f=c(p.clientY);a==null||a(f)},onSlideMove:p=>{const f=c(p.clientY);m==null||m(f)},onSlideEnd:()=>{h.current=void 0,g==null||g()},onStepKeyDown:p=>{const j=Nt[_?"from-bottom":"from-top"].includes(p.key);i==null||i({event:p,direction:j?-1:1})}})})}),Et=l.forwardRef((s,r)=>{const{__scopeSlider:t,onSlideStart:n,onSlideMove:o,onSlideEnd:a,onHomeKeyDown:m,onEndKeyDown:g,onStepKeyDown:i,...u}=s,y=Ie(be,t);return e.jsx(Me.span,{...u,ref:r,onKeyDown:we(s.onKeyDown,d=>{d.key==="Home"?(m(d),d.preventDefault()):d.key==="End"?(g(d),d.preventDefault()):wt.concat(bt).includes(d.key)&&(i(d),d.preventDefault())}),onPointerDown:we(s.onPointerDown,d=>{const h=d.target;h.setPointerCapture(d.pointerId),d.preventDefault(),y.thumbs.has(h)?h.focus():n(d)}),onPointerMove:we(s.onPointerMove,d=>{d.target.hasPointerCapture(d.pointerId)&&o(d)}),onPointerUp:we(s.onPointerUp,d=>{const h=d.target;h.hasPointerCapture(d.pointerId)&&(h.releasePointerCapture(d.pointerId),a(d))})})}),Rt="SliderTrack",Mt=l.forwardRef((s,r)=>{const{__scopeSlider:t,...n}=s,o=Ie(Rt,t);return e.jsx(Me.span,{"data-disabled":o.disabled?"":void 0,"data-orientation":o.orientation,...n,ref:r})});Mt.displayName=Rt;var Ve="SliderRange",Dt=l.forwardRef((s,r)=>{const{__scopeSlider:t,...n}=s,o=Ie(Ve,t),a=Ct(Ve,t),m=l.useRef(null),g=ke(r,m),i=o.values.length,u=o.values.map(h=>Ht(h,o.min,o.max)),y=i>1?Math.min(...u):0,d=100-Math.max(...u);return e.jsx(Me.span,{"data-orientation":o.orientation,"data-disabled":o.disabled?"":void 0,...n,ref:g,style:{...s.style,[a.startEdge]:y+"%",[a.endEdge]:d+"%"}})});Dt.displayName=Ve;var Oe="SliderThumb",It=l.forwardRef((s,r)=>{const t=er(s.__scopeSlider),[n,o]=l.useState(null),a=ke(r,g=>o(g)),m=l.useMemo(()=>n?t().findIndex(g=>g.ref.current===n):-1,[t,n]);return e.jsx(ar,{...s,ref:a,index:m})}),ar=l.forwardRef((s,r)=>{const{__scopeSlider:t,index:n,name:o,...a}=s,m=Ie(Oe,t),g=Ct(Oe,t),[i,u]=l.useState(null),y=ke(r,w=>u(w)),d=i?m.form||!!i.closest("form"):!0,h=ss(i),_=m.values[n],c=_===void 0?0:Ht(_,m.min,m.max),p=lr(n,m.values.length),f=h==null?void 0:h[g.size],j=f?dr(f,c,g.direction):0;return l.useEffect(()=>{if(i)return m.thumbs.add(i),()=>{m.thumbs.delete(i)}},[i,m.thumbs]),e.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[g.startEdge]:`calc(${c}% + ${j}px)`},children:[e.jsx(Be.ItemSlot,{scope:s.__scopeSlider,children:e.jsx(Me.span,{role:"slider","aria-label":s["aria-label"]||p,"aria-valuemin":m.min,"aria-valuenow":_,"aria-valuemax":m.max,"aria-orientation":m.orientation,"data-orientation":m.orientation,"data-disabled":m.disabled?"":void 0,tabIndex:m.disabled?void 0:0,...a,ref:y,style:_===void 0?{display:"none"}:s.style,onFocus:we(s.onFocus,()=>{m.valueIndexToChangeRef.current=n})})}),d&&e.jsx(or,{name:o??(m.name?m.name+(m.values.length>1?"[]":""):void 0),form:m.form,value:_},n)]})});It.displayName=Oe;var or=s=>{const{value:r,...t}=s,n=l.useRef(null),o=rs(r);return l.useEffect(()=>{const a=n.current,m=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(m,"value").set;if(o!==r&&i){const u=new Event("input",{bubbles:!0});i.call(a,r),a.dispatchEvent(u)}},[o,r]),e.jsx("input",{style:{display:"none"},...t,ref:n,defaultValue:r})};function ir(s=[],r,t){const n=[...s];return n[t]=r,n.sort((o,a)=>o-a)}function Ht(s,r,t){const a=100/(t-r)*(s-r);return ft(a,[0,100])}function lr(s,r){return r>2?`Value ${s+1} of ${r}`:r===2?["Minimum","Maximum"][s]:void 0}function cr(s,r){if(s.length===1)return 0;const t=s.map(o=>Math.abs(o-r)),n=Math.min(...t);return t.indexOf(n)}function dr(s,r,t){const n=s/2,a=Ye([0,50],[0,n]);return(n-a(r)*t)*t}function ur(s){return s.slice(0,-1).map((r,t)=>s[t+1]-r)}function mr(s,r){if(r>0){const t=ur(s);return Math.min(...t)>=r}return!0}function Ye(s,r){return t=>{if(s[0]===s[1]||r[0]===r[1])return r[0];const n=(r[1]-r[0])/(s[1]-s[0]);return r[0]+n*(t-s[0])}}function hr(s){return(String(s).split(".")[1]||"").length}function fr(s,r){const t=Math.pow(10,r);return Math.round(s*t)/t}var Pt=_t,gr=Mt,pr=Dt,xr=It;const Lt=l.forwardRef(({className:s,...r},t)=>e.jsxs(Pt,{ref:t,className:ns("relative flex w-full touch-none select-none items-center",s),...r,children:[e.jsx(gr,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(pr,{className:"absolute h-full bg-primary"})}),e.jsx(xr,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));Lt.displayName=Pt.displayName;const vr=({handoverSessionId:s,onFuelLevelChange:r,onMileageChange:t,onStepComplete:n,initialFuelLevel:o,initialMileage:a})=>{const[m,g]=l.useState(o||50),[i,u]=l.useState((a==null?void 0:a.toString())||""),y=c=>{const p=c[0];g(p),r(p)},d=c=>{u(c);const p=parseInt(c,10);isNaN(p)||t(p)},h=i!==""&&!isNaN(parseInt(i,10))&&parseInt(i,10)>0,_=()=>{h?(n(),E.success("Fuel level and mileage recorded successfully")):E.error("Please enter a valid mileage reading")};return e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(qt,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs(Y,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Je,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(Lt,{value:[m],onValueChange:y,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[m,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${m<=25?"#ef4444":m<=50?"#f59e0b":"#10b981"} 0deg,
                    ${m<=25?"#ef4444":m<=50?"#f59e0b":"#10b981"} ${m/100*360}deg,
                    #e5e7eb ${m/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[m,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Je,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ms,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ht,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:i,onChange:c=>d(c.target.value),className:"pl-10",min:"0"})]}),i&&!isNaN(parseInt(i,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(i,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[m,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:i?`${parseInt(i,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(U,{onClick:_,disabled:!h,className:"w-full",children:"Complete Fuel & Mileage Check"}),!h&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},yr=({handoverSessionId:s,otherUserName:r,isHost:t,onStepComplete:n})=>{const[o,a]=l.useState(!1),[m,g]=l.useState(!1),[i,u]=l.useState(!1),y=o&&m&&i,d=()=>{y&&(n(),E.success("Key transfer completed successfully"))};return e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(js,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?`Transfer vehicle keys to ${r}`:`Receive vehicle keys from ${r}`})]}),e.jsxs(Y,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx($e,{id:"key-transferred",checked:o,onCheckedChange:h=>a(h)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:t?`I have handed over the main vehicle key to ${r}`:`I have received the main vehicle key from ${r}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx($e,{id:"key-received",checked:m,onCheckedChange:h=>g(h)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:t?`${r} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx($e,{id:"spares-confirmed",checked:i,onCheckedChange:h=>u(h)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:o&&m?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(U,{onClick:d,disabled:!y,className:"w-full",children:"Complete Key Transfer"}),!y&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},jr=({handoverSessionId:s,onSignatureComplete:r,initialSignature:t})=>{const n=l.useRef(null),[o,a]=l.useState(!1),[m,g]=l.useState(!!t),[i,u]=l.useState(t||null),y=p=>{p.preventDefault(),a(!0);const f=n.current;if(!f)return;const j=f.getBoundingClientRect(),w=f.width/j.width,L=f.height/j.height,k=f.getContext("2d");if(!k)return;k.lineWidth=2,k.lineCap="round",k.strokeStyle="#000";let z,$;"touches"in p?(z=(p.touches[0].clientX-j.left)*w,$=(p.touches[0].clientY-j.top)*L):(z=(p.clientX-j.left)*w,$=(p.clientY-j.top)*L),k.beginPath(),k.moveTo(z,$)},d=p=>{if(!o)return;p.preventDefault();const f=n.current,j=f==null?void 0:f.getContext("2d");if(!f||!j)return;const w=f.getBoundingClientRect(),L=f.width/w.width,k=f.height/w.height;let z,$;"touches"in p?(z=(p.touches[0].clientX-w.left)*L,$=(p.touches[0].clientY-w.top)*k):(z=(p.clientX-w.left)*L,$=(p.clientY-w.top)*k),j.lineTo(z,$),j.stroke(),g(!0)},h=()=>{a(!1)},_=()=>{const p=n.current,f=p==null?void 0:p.getContext("2d");!p||!f||(f.clearRect(0,0,p.width,p.height),g(!1),u(null))},c=()=>{const p=n.current;if(!p||!m)return;const f=p.toDataURL("image/png");u(f),r(f),E.success("Digital signature captured successfully")};return l.useState(()=>{if(t&&n.current){const f=n.current.getContext("2d"),j=new Image;j.onload=()=>{f==null||f.drawImage(j,0,0)},j.src=t}}),e.jsxs(G,{className:"w-full",children:[e.jsxs(me,{children:[e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(Hs,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs(Y,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:n,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:y,onMouseMove:d,onMouseUp:h,onMouseLeave:h,onTouchStart:y,onTouchMove:d,onTouchEnd:h,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(U,{variant:"outline",onClick:_,disabled:!m,className:"flex-1",children:[e.jsx(ws,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(U,{onClick:c,disabled:!m,className:"flex-1",children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),i&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},wr=({currentStep:s,totalDistance:r,totalDuration:t,isNavigating:n,onToggleVoice:o,isVoiceEnabled:a,onStopNavigation:m,onArrived:g,destination:i,showArrivedButton:u=!1})=>{const[y,d]=l.useState("");l.useEffect(()=>{if(t>0){const c=new Date(Date.now()+t*1e3);d(c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))}},[t]);const h=c=>c<1e3?`${Math.round(c)}m`:`${(c/1e3).toFixed(1)}km`,_=c=>{const p=Math.floor(c/60);if(p<1)return"< 1 min";if(p<60)return`${p} min`;const f=Math.floor(p/60),j=p%60;return`${f}h ${j}m`};return!n||!s?null:e.jsx(G,{className:"mx-4 mt-4 shadow-lg border-primary/20",children:e.jsxs(Y,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(De,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["To ",i]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{variant:"ghost",size:"sm",onClick:o,className:"h-8 w-8 p-0",children:a?e.jsx(Ps,{className:"h-4 w-4"}):e.jsx(Ls,{className:"h-4 w-4"})}),e.jsx(U,{variant:"outline",size:"sm",onClick:m,className:"text-xs",children:"Stop"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg mt-1",children:e.jsx(Fe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground mb-1",children:s.instruction}),s.road_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["on ",s.road_name]}),e.jsx("div",{className:"flex items-center space-x-1 mt-2",children:e.jsx(ne,{variant:"secondary",className:"text-xs",children:h(s.distance)})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(yt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:_(t)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"text-muted-foreground",children:h(r)})}),y&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-muted-foreground",children:["ETA ",y]})]})]}),u&&g&&e.jsx("div",{className:"mt-4 pt-4 border-t border-muted",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Used alternative navigation or already arrived?"}),e.jsx(U,{onClick:g,className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:"I've Arrived"})]})})]})})},br=({steps:s,currentStepIndex:r,onStepClick:t,className:n=""})=>{const o=i=>i<1e3?`${Math.round(i)}m`:`${(i/1e3).toFixed(1)}km`,a=i=>i===0?e.jsx(De,{className:"h-4 w-4"}):i===s.length-1?e.jsx(bs,{className:"h-4 w-4"}):e.jsx(Fe,{className:"h-4 w-4"}),m=i=>i<r?"text-muted-foreground":i===r?"text-primary":"text-foreground",g=i=>i<r?"bg-muted/50":i===r?"bg-primary/10 border-primary/20":"bg-background";return e.jsxs(G,{className:n,children:[e.jsx(me,{className:"pb-3",children:e.jsxs(he,{className:"text-lg flex items-center gap-2",children:[e.jsx(Fe,{className:"h-5 w-5"}),"Turn-by-Turn Directions"]})}),e.jsx(Y,{className:"p-0",children:e.jsx(it,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-2 p-4",children:s.map((i,u)=>e.jsxs("div",{className:`
                  flex items-start space-x-3 p-3 rounded-lg border transition-all
                  ${g(u)}
                  ${t?"cursor-pointer hover:bg-muted/30":""}
                  ${u===r?"border-primary/20":"border-transparent"}
                `,onClick:()=>t==null?void 0:t(u),children:[e.jsx("div",{className:`mt-1 ${m(u)}`,children:a(u)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-medium ${m(u)}`,children:i.instruction}),i.road_name&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["on ",i.road_name]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-2",children:[e.jsx(ne,{variant:"secondary",className:"text-xs shrink-0",children:o(i.distance)}),u===r&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"})]})]})}),t&&e.jsx(as,{className:"h-4 w-4 text-muted-foreground mt-1"})]},u))})})})]})},Nr=()=>{const[s,r]=l.useState(null),[t,n]=l.useState(!1),[o,a]=l.useState(null);return{userLocation:s,isTracking:t,error:o,startTracking:()=>{if(!navigator.geolocation){const d="Geolocation is not supported by this browser";a(d),E.error(d);return}n(!0),a(null);const u={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4},y=navigator.geolocation.watchPosition(d=>{const h={latitude:d.coords.latitude,longitude:d.coords.longitude,accuracy:d.coords.accuracy};r(h),a(null)},d=>{let h="Failed to get location";switch(d.code){case d.PERMISSION_DENIED:h="Location access denied. Please enable location permissions.";break;case d.POSITION_UNAVAILABLE:h="Location information is unavailable.";break;case d.TIMEOUT:h="Location request timed out.";break}a(h),E.error(h),n(!1)},u);return()=>{navigator.geolocation.clearWatch(y),n(!1)}},stopTracking:()=>{n(!1),r(null),a(null)},getCurrentLocation:()=>new Promise((u,y)=>{if(!navigator.geolocation){y(new Error("Geolocation is not supported"));return}navigator.geolocation.getCurrentPosition(d=>{const h={latitude:d.coords.latitude,longitude:d.coords.longitude,accuracy:d.coords.accuracy};u(h)},d=>{let h="Failed to get location";switch(d.code){case d.PERMISSION_DENIED:h="Location access denied";break;case d.POSITION_UNAVAILABLE:h="Location information unavailable";break;case d.TIMEOUT:h="Location request timed out";break}y(new Error(h))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}},ve=class ve{constructor(){fe(this,"mapboxToken",null)}static getInstance(){return ve.instance||(ve.instance=new ve),ve.instance}async initialize(){try{return this.mapboxToken=await gt(),!!this.mapboxToken}catch(r){return console.error("Failed to initialize navigation service:",r),E.error("Navigation service unavailable"),!1}}async getRoute(r){if(!this.mapboxToken&&(await this.initialize(),!this.mapboxToken))throw new Error("Navigation service not initialized");const{origin:t,destination:n,profile:o="driving"}=r;try{const a=await fetch(`https://api.mapbox.com/directions/v5/mapbox/${o}/${t.longitude},${t.latitude};${n.longitude},${n.latitude}?steps=true&geometries=geojson&overview=full&access_token=${this.mapboxToken}`),m=await a.json();if(!a.ok)throw new Error(m.message||"Failed to get route");if(!m.routes||m.routes.length===0)throw new Error("No route found");const g=m.routes[0];return{geometry:g.geometry,distance:g.distance,duration:g.duration,steps:g.legs[0].steps.map(i=>({instruction:i.maneuver.instruction,distance:i.distance,duration:i.duration,maneuver:i.maneuver.type,road_name:i.name,geometry:i.geometry}))}}catch(a){return console.error("Error fetching route:",a),E.error("Unable to calculate route"),null}}async getDirections(r,t){const n=await this.getRoute({origin:r,destination:t});return(n==null?void 0:n.steps)||[]}calculateDistance(r,t,n,o){const m=r*Math.PI/180,g=n*Math.PI/180,i=(n-r)*Math.PI/180,u=(o-t)*Math.PI/180,y=Math.sin(i/2)*Math.sin(i/2)+Math.cos(m)*Math.cos(g)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))}formatDistance(r){return r<1e3?`${Math.round(r)}m`:`${(r/1e3).toFixed(1)}km`}formatDuration(r){const t=Math.floor(r/60);if(t<1)return"< 1 min";if(t<60)return`${t} min`;const n=Math.floor(t/60),o=t%60;return`${n}h ${o}m`}};fe(ve,"instance");let qe=ve;const nt=qe.getInstance(),Sr=({handoverSessionId:s,destinationLocation:r,otherUserName:t,isHost:n,onStepComplete:o,onNavigationStart:a})=>{const{userLocation:m,getCurrentLocation:g}=Nr(),[i,u]=l.useState(!1),[y,d]=l.useState(!1),[h,_]=l.useState([]),[c,p]=l.useState(0),[f,j]=l.useState(0),[w,L]=l.useState(0),[k,z]=l.useState(!1),[$]=l.useState(50),[q,I]=l.useState(!1),[F,C]=l.useState(null),[S,b]=l.useState(!1);l.useEffect(()=>{(async()=>{const M=await nt.initialize();I(M)})()},[]);const D=(x,M,Z,se)=>{const ye=x*Math.PI/180,le=Z*Math.PI/180,ce=(Z-x)*Math.PI/180,pe=(se-M)*Math.PI/180,re=Math.sin(ce/2)*Math.sin(ce/2)+Math.cos(ye)*Math.cos(le)*Math.sin(pe/2)*Math.sin(pe/2);return 6371e3*(2*Math.atan2(Math.sqrt(re),Math.sqrt(1-re)))},T=async()=>{try{const{error:x}=await V.from("notifications").insert({type:"arrival_notification",title:"Renter has arrived",content:"The renter has arrived at the handover location"});x?console.error("Error sending renter arrival notification:",x):console.log("Host notified of renter arrival")}catch(x){console.error("Failed to notify host of renter arrival:",x)}};l.useEffect(()=>{if(!m||!i||y)return;if(D(m.latitude,m.longitude,r.latitude,r.longitude)<=$&&(d(!0),u(!1),E.success("You have arrived at the handover location!"),n||T(),k&&"speechSynthesis"in window)){const M=new SpeechSynthesisUtterance("You have arrived at your destination");speechSynthesis.speak(M)}},[m,r,i,y,$,k,n,s]);const W=async()=>{let x=m;if(!x)try{x=await g(),C(null)}catch{return C("Unable to access your location. Please check your GPS settings."),b(!0),!1}if(!q)return C("Navigation service is not available."),b(!0),!1;try{const M=await nt.getRoute({origin:x,destination:r});if(M)return j(M.distance),L(M.duration),_(M.steps),!0;throw new Error("No route found")}catch(M){return console.error("Error fetching route:",M),C("Unable to calculate route."),b(!0),!1}},X=async()=>{await W()&&(u(!0),p(0),a==null||a(),E.success("Navigation started"))},J=()=>{d(!0),E.success("You've arrived at the handover location!"),n||T()},Q=()=>{u(!1),p(0),E.info("Navigation stopped")},oe=()=>{z(!k),E.info(k?"Voice guidance disabled":"Voice guidance enabled")},ge=()=>{o(),E.success("Ready to begin handover process")},te=()=>{d(!0),u(!1),E.success("Marked as arrived - ready for handover!"),n||T()},P=h[c]||null,R=y?100:c/Math.max(h.length-1,1)*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(G,{children:[e.jsx(me,{children:e.jsxs(he,{className:"flex items-center gap-2",children:[e.jsx(et,{className:"h-5 w-5"}),"Navigate to Handover Location"]})}),e.jsxs(Y,{className:"space-y-4",children:[!i&&!y&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(U,{onClick:X,size:"lg",className:"w-full",disabled:!q,children:[e.jsx(et,{className:"h-4 w-4 mr-2"}),"Start Navigation"]}),e.jsxs(U,{onClick:()=>b(!0),variant:"outline",size:"lg",className:"w-full",children:[e.jsx(Is,{className:"h-4 w-4 mr-2"}),"I've Already Arrived"]}),!q&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx(Re,{className:"h-4 w-4 inline mr-1"}),"Loading navigation service..."]})]}),F&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(Re,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Location Access Issue"}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:F})]})]})}),S&&!y&&e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"Alternative Options"}),e.jsx("p",{className:"text-sm text-blue-700 mb-3",children:"If you're unable to use GPS navigation, you can still proceed:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(U,{onClick:J,size:"lg",className:"w-full",variant:"default",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"I've Arrived at Location"]}),e.jsx(U,{onClick:()=>{b(!1),C(null)},size:"sm",variant:"ghost",className:"w-full",children:"Try Navigation Again"})]})]})}),(i||y)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(yt,{className:"h-4 w-4"}),"Navigation Progress"]}),e.jsxs("span",{children:[Math.round(R),"%"]})]}),e.jsx(_e,{value:R,className:"h-2"})]}),y&&e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx(ue,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-green-800 font-medium",children:"You've arrived at the handover location!"}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:n?"Wait for the renter to arrive":"Look for the host and their vehicle"})]}),e.jsxs(U,{onClick:ge,size:"lg",className:"w-full",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"I'm Ready for Handover"]})]})]})]}),i&&P&&e.jsx(wr,{currentStep:P,totalDistance:f,totalDuration:w,isNavigating:i,onToggleVoice:oe,isVoiceEnabled:k,onStopNavigation:Q,onArrived:te,destination:r.address,showArrivedButton:!0}),i&&h.length>0&&e.jsx(br,{steps:h,currentStepIndex:c,onStepClick:x=>p(x)})]})},_r=({isHost:s,onClose:r,duration:t=3e3})=>{const[n,o]=l.useState(!0);l.useEffect(()=>{console.log("HandoverSuccessPopup mounted with duration:",t);const m=setTimeout(()=>{console.log("HandoverSuccessPopup timer fired, setting invisible"),o(!1),setTimeout(()=>{console.log("HandoverSuccessPopup calling onClose"),r()},300)},t);return()=>{console.log("HandoverSuccessPopup cleanup"),clearTimeout(m)}},[t,r]);const a=s?"See you soon!":"Have a nice trip!";return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsx(G,{className:`
          bg-white/95 backdrop-blur-sm shadow-2xl border-2 border-primary/20 
          p-6 rounded-2xl transition-all duration-300 transform
          ${n?"scale-100 opacity-100":"scale-95 opacity-0"}
        `,children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(xt,{className:"h-8 w-8 text-primary"}),e.jsx(ue,{className:"h-4 w-4 text-green-500 absolute -top-1 -right-1 bg-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-1",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:a})]})]})})})},Tt=s=>{const[r,t]=l.useState(null),[n,o]=l.useState(!0),[a,m]=l.useState(null),g=async()=>{if(!s){o(!1);return}try{o(!0);const{data:i,error:u}=await V.rpc("calculate_handover_progress",{handover_session_id_param:s});if(u)throw u;t(i&&typeof i=="object"?i:null),m(null)}catch(i){console.error("Error fetching handover progress:",i),m("Failed to load handover progress")}finally{o(!1)}};return l.useEffect(()=>{g()},[s]),l.useEffect(()=>{if(!s)return;const i=V.channel(`handover_progress_${s}`).on("postgres_changes",{event:"*",schema:"public",table:"handover_step_completion",filter:`handover_session_id=eq.${s}`},async u=>{var y,d;if(await g(),u.eventType==="UPDATE"&&((y=u.new)!=null&&y.is_completed)){const h=(d=u.new.step_name)==null?void 0:d.replace(/_/g," ");E.success(`${h} completed!`)}}).on("postgres_changes",{event:"*",schema:"public",table:"handover_sessions",filter:`id=eq.${s}`},u=>{var y;u.eventType==="UPDATE"&&((y=u.new)!=null&&y.handover_completed)&&E.success("Handover process completed successfully!")}).subscribe(u=>{u==="CHANNEL_ERROR"&&(console.error("Failed to subscribe to handover updates"),m("Real-time updates unavailable"))});return()=>{V.removeChannel(i)}},[s]),{handoverProgress:r,isLoading:n,error:a}},kr=({handoverSessionId:s,showDetailed:r=!1})=>{const{handoverProgress:t,isLoading:n,error:o}=Tt(s);if(n)return e.jsx(G,{className:"w-full",children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(Ns,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading progress..."})]})})});if(o||!t)return e.jsx(G,{className:"w-full",children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-destructive",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:o||"Unable to load progress"})]})})});const a=()=>t.is_completed?e.jsx(ue,{className:"h-5 w-5 text-green-600"}):e.jsx(Ke,{className:"h-5 w-5 text-blue-600"}),m=()=>t.is_completed?"Handover Complete":`Step ${t.current_step} of ${t.total_steps}`;return r?e.jsxs(G,{className:"w-full",children:[e.jsx(me,{className:"pb-3",children:e.jsxs(he,{className:"flex items-center space-x-2",children:[a(),e.jsx("span",{children:"Handover Progress"})]})}),e.jsxs(Y,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:m()}),e.jsxs(ne,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]}),e.jsx(_e,{value:t.progress_percentage,className:"h-3"})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:[t.completed_steps," completed"]}),e.jsxs("span",{children:[t.total_steps-t.completed_steps," remaining"]})]}),t.is_completed&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ue,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"All handover steps completed successfully!"})]})})]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[a(),e.jsx("div",{className:"flex-1",children:e.jsx(_e,{value:t.progress_percentage,className:"h-2"})}),e.jsxs(ne,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]})},Cr=({isOpen:s,onClose:r,bookingId:t})=>{var Xe,Qe;const n=at(),[o]=ot(),{isLoading:a,isHandoverSessionLoading:m,isHost:g,bookingDetails:i,handoverId:u,currentUserId:y,handoverStatus:d}=lt();Tt(u);const[h,_]=l.useState(0),[c,p]=l.useState([]),[f,j]=l.useState([]),[w,L]=l.useState([]),[k,z]=l.useState(),[$,q]=l.useState(),[I,F]=l.useState(),[C,S]=l.useState(!1),[b,D]=l.useState(90),[T,W]=l.useState(!1),[X,J]=l.useState(0),[Q,oe]=l.useState(90),ge=l.useRef(null),te=40,P=95;l.useEffect(()=>{const v=localStorage.getItem("handover-sheet-height");if(v){const H=parseInt(v,10);H>=te&&H<=P&&D(H)}},[]),l.useEffect(()=>{localStorage.setItem("handover-sheet-height",b.toString())},[b]);const R=l.useCallback(v=>{v.preventDefault(),W(!0),J(v.clientY),oe(b),document.body.style.userSelect="none"},[b]),x=l.useCallback(v=>{if(!T)return;const H=X-v.clientY,N=window.innerHeight,A=H/N*100,B=Math.min(P,Math.max(te,Q+A));D(B)},[T,X,Q]),M=l.useCallback(()=>{W(!1),document.body.style.userSelect=""},[]);l.useEffect(()=>{if(T)return document.addEventListener("mousemove",x),document.addEventListener("mouseup",M),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",M)}},[T,x,M]);const Z=l.useCallback(()=>{if(!ge.current||T)return;const v=ge.current.querySelector('[data-content="true"]');if(!v)return;const H=window.innerHeight,ee=(v.scrollHeight+40+48)/H*100;!(localStorage.getItem("handover-sheet-user-resized")==="true")&&ee>b&&ee<=P&&D(Math.min(P,Math.max(te,ee)))},[b,T]);l.useEffect(()=>{Z()},[h,c,Z]),l.useEffect(()=>{const v=()=>{const H=b/100*window.innerHeight,N=te/100*window.innerHeight,A=P/100*window.innerHeight;H<N?D(te):H>A&&D(P)};return window.addEventListener("resize",v),()=>window.removeEventListener("resize",v)},[b]);const se=l.useCallback(v=>{localStorage.setItem("handover-sheet-user-resized","true"),R(v)},[R]),ie=l.useCallback(v=>{if(v.key==="ArrowUp"||v.key==="ArrowDown"){v.preventDefault();const H=v.shiftKey?10:5,N=v.key==="ArrowUp"?1:-1,A=Math.min(P,Math.max(te,b+H*N));D(A),localStorage.setItem("handover-sheet-user-resized","true")}},[b]),ye=l.useCallback(v=>{if(v.touches.length===1){const H=v.touches[0];W(!0),J(H.clientY),oe(b),localStorage.setItem("handover-sheet-user-resized","true")}},[b]),le=l.useCallback(v=>{if(!T||v.touches.length!==1)return;v.preventDefault();const H=v.touches[0],N=X-H.clientY,A=window.innerHeight,B=N/A*100,ee=Math.min(P,Math.max(te,Q+B));D(ee)},[T,X,Q]),ce=l.useCallback(()=>{W(!1)},[]);l.useEffect(()=>{if(T)return document.addEventListener("touchmove",le,{passive:!1}),document.addEventListener("touchend",ce),()=>{document.removeEventListener("touchmove",le),document.removeEventListener("touchend",ce)}},[T,le,ce]),l.useEffect(()=>{const v=()=>{const H=window.innerWidth<768,N=window.innerWidth>window.innerHeight;H&&N&&b>85&&D(85)};return window.addEventListener("orientationchange",v),window.addEventListener("resize",v),()=>{window.removeEventListener("orientationchange",v),window.removeEventListener("resize",v)}},[b]);const pe=l.useCallback(async()=>{if(!u){console.error("Cannot initialize handover: missing handover session ID"),E.error("Handover session not found");return}console.log("Initializing handover for session:",u);try{await Ks(u);const v=await st(u);console.log("Loaded handover steps:",v),console.log("Steps completion status:",v.map(B=>({name:B.step_name,completed:B.is_completed}))),p(v);const H=v.findIndex(B=>!B.is_completed),N=H>=0?H:v.length;console.log("First incomplete step index:",H),console.log("Setting current step to:",N),_(N);const A=v.filter(B=>B.is_completed).length;A>0&&E.success(`Continuing handover process - ${A}/${v.length} steps completed`),console.log("Handover initialized successfully")}catch(v){console.error("Error initializing handover:",v),E.error("Failed to initialize handover process")}},[u]);l.useEffect(()=>{u&&s&&!m&&pe()},[u,s,m,pe]),l.useEffect(()=>{if(s&&d&&c){console.log("🔍 DEBUG: Checking handover completion status..."),console.log("🔍 DEBUG: Handover status:",d),console.log("🔍 DEBUG: Completed steps:",c),console.log("🔍 DEBUG: isReturnHandover():",He());const v=c.every(H=>H.is_completed);if(d.handover_completed&&v){console.log("✅ Current handover session completed with all steps done, showing success popup"),S(!0);return}if(!d.handover_completed||!v){console.log("🔄 Handover not completed or steps incomplete, ensuring completion state is reset"),S(!1);const H=c.findIndex(N=>!N.is_completed);H>=0&&_(H)}}},[s,d,c,o]);const re=async(v,H)=>{if(console.log(`🚀 handleStepComplete called for step: ${v}`),console.log(`📋 Handover session ID: ${u}`),console.log("📊 Completion data:",H),!u){console.error("❌ No handover session ID available"),E.error("Handover session not found");return}console.log(`🔄 Attempting to complete step: ${v}`,{completionData:H});const N=await Gs(u,v,H);if(console.log(`📋 Step completion result for ${v}:`,N),N){console.log(`✅ Step ${v} completed successfully, refreshing steps...`);const A=await st(u);p(A);const B=A.findIndex(ee=>!ee.is_completed);console.log("🔍 Next incomplete step index:",B),B>=0?(console.log(`➡️ Moving to next step: ${B}`),_(B)):(console.log("🎉 All steps completed, initiating handover completion"),console.log("All steps completed, checking if handover should be finalized"),A.every(xe=>xe.is_completed)&&await We())}else console.error(`❌ Step ${v} completion failed`)},We=async()=>{console.log("Starting handover completion...");try{if(u&&(console.log("Completing handover session:",u),await os(u)),f.length>0||w.length>0||k!==void 0||$!==void 0){console.log("Creating vehicle condition report...");const v=He()?"return":"pickup";console.log("Report type determined as:",v);const H={handover_session_id:u,booking_id:(i==null?void 0:i.id)||"",car_id:(i==null?void 0:i.car_id)||"",report_type:v,vehicle_photos:f,damage_reports:w,fuel_level:k,mileage:$,digital_signature_data:I,is_acknowledged:!0,reporter_id:y};if(!await Ws(H))throw new Error("Failed to create vehicle condition report");console.log("Vehicle condition report created successfully")}console.log("Setting handover completed to true, isHost:",g),S(!0)}catch(v){console.error("Error completing handover:",v),E.error("Failed to complete handover. Please try again.")}},He=()=>{const v=o.get("handoverType");if(console.log("🔍 DEBUG: URL handoverType parameter:",v),console.log("🔍 DEBUG: All URL search params:",Object.fromEntries(o.entries())),v){console.log("✅ Using handoverType from URL:",v);const de=v==="return";return console.log("✅ isReturnHandover result from URL:",de),de}if(console.log("⚠️ No handoverType in URL, checking handover session type"),d!=null&&d.handover_type){console.log("✅ Using handover_type from session:",d.handover_type);const de=d.handover_type==="return";return console.log("✅ isReturnHandover result from session:",de),de}if(console.log("⚠️ No handover_type in session, falling back to automatic detection"),!i)return console.log("❌ Missing bookingDetails for automatic detection"),!1;const H=i,N=new Date(H.start_date),A=new Date(H.end_date),B=new Date;if(console.log("📅 Booking dates - Start:",N.toISOString(),"End:",A.toISOString()),console.log("📅 Current time:",B.toISOString()),B<N)return console.log("✅ Before booking start date - this is a pickup"),!1;if(B>=A)return console.log("✅ Past booking end date - this is a return"),!0;const ee=Math.abs(B.getTime()-N.getTime()),xe=Math.abs(B.getTime()-A.getTime()),O=B>=N&&xe<ee;return console.log("✅ Time-based determination - isReturn:",O),O},$t=()=>{console.log("🎉 Success popup closing - starting redirection logic"),console.log("👤 User role - isHost:",g),console.log("📋 Booking ID:",t);const v=He();console.log("🔄 Handover type determination - isReturnHandover():",v),S(!1);const H=new URL(window.location.href);if(H.searchParams.delete("mode"),H.searchParams.delete("bookingId"),window.history.replaceState({},"",H.pathname+H.search),r(),!g&&v){console.log("🔄 Return handover completed - redirecting renter to review page"),console.log("🚀 Navigating to:",`/rental-review/${t}`),n(`/rental-review/${t}`);return}g?(console.log("🏠 Host user - navigating to host-bookings"),console.log("🚀 Navigating to: /host-bookings"),n("/host-bookings")):(console.log("🚗 Renter user - pickup completed, navigating to renter-bookings"),console.log("🚀 Navigating to: /renter-bookings"),n("/renter-bookings"))},At=v=>{switch(v){case"navigation":return!0;case"identity_verification":return!0;case"vehicle_inspection_exterior":return f.filter(N=>N.type&&N.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return f.filter(N=>N.type&&(N.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(N.type))).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return k!==void 0&&$!==void 0;case"key_transfer":return!0;case"digital_signature":return I!==void 0;default:return!0}},Ut=(v,H)=>{var B,ee,xe,Le;const N=i,A=g?N==null?void 0:N.renter:(B=N==null?void 0:N.cars)==null?void 0:B.owner;switch(v.name){case"navigation":{const O={latitude:(N==null?void 0:N.latitude)||((ee=N==null?void 0:N.cars)==null?void 0:ee.latitude)||-24.65451,longitude:(N==null?void 0:N.longitude)||((xe=N==null?void 0:N.cars)==null?void 0:xe.longitude)||25.90859,address:((Le=N==null?void 0:N.cars)==null?void 0:Le.location)||"Handover Location"};return e.jsx(Sr,{handoverSessionId:u||"",destinationLocation:O,otherUserName:(A==null?void 0:A.full_name)||"User",isHost:g,onStepComplete:()=>re(v.name),onNavigationStart:()=>E.info("Navigation started. Follow the directions to reach the handover location.")})}case"identity_verification":return e.jsx(Qs,{handoverSessionId:u||"",otherUserId:(A==null?void 0:A.id)||"",otherUserName:(A==null?void 0:A.full_name)||"User",isHost:g,onStepComplete:()=>re(v.name)});case"vehicle_inspection_exterior":return f.filter(O=>O.type.startsWith("exterior_")),e.jsx(rt,{handoverSessionId:u||"",inspectionType:"exterior",onPhotosUpdate:O=>{const de=f.filter(je=>je.type&&!je.type.startsWith("exterior_"));j([...de,...O])},onStepComplete:()=>re(v.name),initialPhotos:f.filter(O=>O.type&&O.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return f.filter(O=>O.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(O.type)),e.jsx(rt,{handoverSessionId:u||"",inspectionType:"interior",onPhotosUpdate:O=>{const de=f.filter(je=>je.type&&!je.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(je.type));j([...de,...O])},onStepComplete:()=>re(v.name),initialPhotos:f.filter(O=>O.type&&(O.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(O.type)))});case"damage_documentation":return e.jsx(Zs,{handoverSessionId:u||"",onDamageReportsUpdate:L,onStepComplete:()=>re(v.name),initialReports:w});case"fuel_mileage_check":return e.jsx(vr,{handoverSessionId:u||"",onFuelLevelChange:z,onMileageChange:q,onStepComplete:()=>re(v.name,{fuel_level:k,mileage:$}),initialFuelLevel:k,initialMileage:$});case"key_transfer":return e.jsx(yr,{handoverSessionId:u||"",otherUserName:(A==null?void 0:A.full_name)||"User",isHost:g,onStepComplete:()=>re(v.name)});case"digital_signature":return e.jsx(jr,{handoverSessionId:u||"",onSignatureComplete:O=>{F(O),re(v.name,{signature:O})},initialSignature:I});default:return e.jsx(G,{children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:v.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:v.description}),e.jsxs(U,{onClick:()=>re(v.name),disabled:!At(v.name),children:["Complete ",v.title]})]})})})}};if(a||m)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(G,{className:"w-96",children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:m?"Setting up handover session...":"Loading handover process..."})]})})})});if(!u&&!m)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(G,{className:"w-96",children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Re,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Session Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load the handover session. Please try refreshing the page."}),e.jsx(U,{onClick:r,variant:"outline",children:"Close"})]})})})});c.filter(v=>v.is_completed).length/Ce.length*100;const Pe=Ce[h];return e.jsxs(e.Fragment,{children:[C&&e.jsx(_r,{isHost:g,onClose:$t}),e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:s?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:r}),e.jsxs("div",{ref:ge,className:`absolute bottom-0 left-0 right-0 bg-background rounded-t-xl shadow-lg overflow-hidden pointer-events-auto transition-all duration-200 ease-out ${T?"select-none shadow-xl":""}`,style:{height:`${b}vh`,transform:T?"scale(1.001)":"scale(1)",borderTop:T?"2px solid hsl(var(--primary))":"1px solid hsl(var(--border))"},children:[e.jsxs("div",{className:`flex items-center justify-center py-2 cursor-ns-resize hover:bg-muted/50 transition-all duration-150 ${T?"bg-primary/10 border-b border-primary/20":""}`,onMouseDown:se,onTouchStart:ye,onKeyDown:ie,role:"slider",tabIndex:0,"aria-label":`Resize handover sheet. Current height: ${Math.round(b)}% of viewport. Use arrow keys to adjust.`,"aria-valuemin":te,"aria-valuemax":P,"aria-valuenow":Math.round(b),"aria-orientation":"vertical",title:"Drag to resize or use arrow keys (Shift for larger steps)",children:[e.jsx(Ds,{className:`h-4 w-4 transition-colors duration-150 ${T?"text-primary":"text-muted-foreground"}`}),T&&e.jsxs("div",{className:"absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-full bg-primary text-primary-foreground px-2 py-1 rounded text-xs font-medium shadow-md z-50",children:[Math.round(b),"vh"]})]}),e.jsx("div",{className:"overflow-y-auto",style:{height:"calc(100% - 40px)"},children:e.jsxs("div",{className:"p-6","data-content":"true",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(Xe=i==null?void 0:i.cars)==null?void 0:Xe.brand," ",(Qe=i==null?void 0:i.cars)==null?void 0:Qe.model]})]}),e.jsx("button",{onClick:r,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(Ee,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(kr,{handoverSessionId:u,showDetailed:!1})}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:Ce.map((v,H)=>{const N=c.find(ee=>ee.step_name===v.name),A=(N==null?void 0:N.is_completed)||!1,B=H===h;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${A?"bg-green-50 border-green-200 text-green-800":B?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:A?e.jsx(ue,{className:"h-4 w-4"}):B?e.jsx(Ke,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:v.title})]},v.name)})})}),Pe?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(ne,{variant:"outline",children:["Step ",h+1]}),e.jsx("span",{className:"font-medium",children:Pe.title})]}),Ut(Pe)]}):e.jsx(G,{children:e.jsx(Y,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ue,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})]})]})},Er=({onBookingClick:s})=>{const{userId:r,userRole:t}=Ss(),{data:n=[]}=Bt({queryKey:["handover-bookings",r,t],queryFn:async()=>{try{if(!r||!t)return console.log("HandoverBookingButtons: No userId or userRole"),[];const a=new Date,m=new Date().toISOString().split("T")[0],g=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];console.log("HandoverBookingButtons: Fetching bookings",{userId:r,userRole:t,today:m,tomorrow:g});let i=V.from("bookings").select(`
            *,
            cars (
              brand,
              model,
              location,
              image_url,
              owner_id,
              price_per_day
            ),
            renter:profiles!renter_id (
              id,
              full_name,
              avatar_url,
              phone_number
            ),
            handover_sessions (
              id,
              handover_completed,
              created_at
            )
          `).eq("status","confirmed").or(`start_date.eq.${m},start_date.eq.${g},end_date.eq.${m}`);t==="renter"?i=i.eq("renter_id",r):t==="host"&&(i=i.eq("cars.owner_id",r));const{data:u,error:y}=await i;if(y)throw console.error("HandoverBookingButtons: Error fetching bookings:",y),new Error(`Failed to fetch handover bookings: ${y.message}`);if(!u)return console.log("HandoverBookingButtons: No data returned"),[];console.log("HandoverBookingButtons: Raw bookings data",u);const d=u.filter(h=>{var k;const _=new Date(h.start_date),c=new Date(h.end_date),p=(k=h.handover_sessions)==null?void 0:k[0];if(p!=null&&p.handover_completed)return!1;const j=_.toDateString()===a.toDateString()&&!p,L=c.toDateString()===a.toDateString()&&p&&!p.handover_completed;return j||L});return console.log("HandoverBookingButtons: Filtered bookings",d),d}catch(a){return console.error("HandoverBookingButtons: Query failed:",a),[]}},enabled:!!r&&!!t,refetchInterval:3e4,retry:(a,m)=>(console.warn("HandoverBookingButtons: Query failed, retry attempt",{failureCount:a,error:m}),a<2),retryDelay:a=>Math.min(1e3*2**a,3e4)}),o=({booking:a,index:m})=>{var p,f,j,w,L,k,z;const g=((p=a.cars)==null?void 0:p.image_url)||"/placeholder.svg",i=new Date,u=new Date(a.start_date),y=new Date(a.end_date),d=(f=a.handover_sessions)==null?void 0:f[0],h=u.toDateString()===i.toDateString(),_=y.toDateString()===i.toDateString();let c="pickup";return _&&d&&!d.handover_completed?c="return":h&&!d&&(c="pickup"),e.jsx(is,{children:e.jsxs(ls,{children:[e.jsx(cs,{asChild:!0,children:e.jsx("button",{onClick:$=>{$.preventDefault(),console.log("Handover button clicked for booking:",a.id,"type:",c),s(a.id,c)},className:`
                w-16 h-16 rounded-full border-4 border-primary/30 
                overflow-hidden shadow-lg hover:shadow-xl
                transition-all duration-300 hover:scale-110
                animate-pulse bg-background
                mb-3
              `,style:{animationDuration:`${2+m*.5}s`},children:e.jsx("img",{src:g,alt:`${(j=a.cars)==null?void 0:j.brand} ${(w=a.cars)==null?void 0:w.model}`,className:"w-full h-full object-cover",onError:$=>{$.currentTarget.src="/placeholder.svg"}})})}),e.jsx(ds,{side:"right",className:"max-w-xs p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-sm",children:[(L=a.cars)==null?void 0:L.brand," ",(k=a.cars)==null?void 0:k.model]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(_s,{className:"h-3 w-3 mr-1"}),tt(new Date(a.start_date),"MMM dd")," - ",tt(new Date(a.end_date),"MMM dd")]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(De,{className:"h-3 w-3 mr-1"}),(z=a.cars)==null?void 0:z.location]}),t==="host"&&a.renter&&e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(pt,{className:"h-3 w-3 mr-1"}),a.renter.full_name]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(ks,{className:"h-3 w-3 mr-1"}),"BWP ",a.total_price]}),e.jsx("div",{className:"text-xs text-primary font-medium mt-2",children:"Click for handover details"})]})})]})},a.id)};return n.length?(console.log("Rendering handover buttons for bookings:",n.map(a=>a.id)),e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col",children:n.map((a,m)=>e.jsx(o,{booking:a,index:m},a.id))})):(console.log("No handover bookings found for user:",r,"role:",t),null)};class Rr extends l.Component{constructor(){super(...arguments);fe(this,"maxRetries",3);fe(this,"state",{hasError:!1,error:null,errorInfo:null,retryCount:0});fe(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries?(this.setState(t=>({hasError:!1,error:null,errorInfo:null,retryCount:t.retryCount+1})),E.info("Retrying handover process...")):E.error("Maximum retry attempts reached. Please refresh the page.")});fe(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,retryCount:0})});fe(this,"handleNavigateHome",()=>{const t=new URL(window.location.href);t.searchParams.delete("mode"),t.searchParams.delete("bookingId"),window.history.replaceState({},"",t.pathname),window.location.href="/"})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,n){console.error("HandoverErrorBoundary caught an error:",t,n),this.setState({errorInfo:n}),this.props.onError&&this.props.onError(t,n);const o={error:t.message,stack:t.stack,componentStack:n.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent};console.error("Handover Error Report:",o),E.error("A handover system error occurred. Please try again.")}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const n=this.state.retryCount<this.maxRetries,o=((t=this.state.error)==null?void 0:t.message)||"An unexpected error occurred";return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs(us,{className:"max-w-md",children:[e.jsx(mt,{className:"h-4 w-4"}),e.jsxs(ms,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Handover System Error"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:o}),this.state.retryCount>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Retry attempt: ",this.state.retryCount,"/",this.maxRetries]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[n&&e.jsxs(U,{onClick:this.handleRetry,className:"w-full",variant:"outline",children:[e.jsx(Ze,{className:"mr-2 h-4 w-4"}),"Retry Handover"]}),e.jsxs(U,{onClick:this.handleReset,className:"w-full",variant:"outline",children:[e.jsx(Ze,{className:"mr-2 h-4 w-4"}),"Reset Process"]}),e.jsxs(U,{onClick:this.handleNavigateHome,className:"w-full",variant:"secondary",children:[e.jsx(Cs,{className:"mr-2 h-4 w-4"}),"Return to Dashboard"]})]}),!1]})]})})}return this.props.children}}const hn=()=>{const[s]=ot(),r=s.get("mode"),t=s.get("bookingId"),{user:n}=hs(),[o,a]=l.useState(""),[m,g]=l.useState(!0),[i,u]=l.useState([]),[y,d]=l.useState(!1),[h]=l.useState({latitude:null,longitude:null}),{theme:_}=fs(),[c,p]=l.useState(!1),[f,j]=l.useState(!1),[w]=l.useState(null),L=async C=>{var S;try{const{data:b,error:D}=await V.from("bookings").select(`
          id, 
          status, 
          start_date, 
          end_date, 
          renter_id,
          cars!inner (
            owner_id
          )
        `).eq("id",C).eq("status","confirmed").single();if(D||!b)return console.log("Booking not found or not confirmed:",C),!1;const T=(S=b.cars)==null?void 0:S.owner_id;if(!n||n.id!==b.renter_id&&n.id!==T)return console.log("User does not have permission to access booking:",C),!1;const W=new Date().toISOString().split("T")[0],X=b.start_date===W,J=b.end_date===W;return!X&&!J?(console.log("Booking is not eligible for handover today:",C),!1):!0}catch(b){return console.error("Error validating booking:",b),!1}};l.useEffect(()=>{(async()=>{if(!(r==="handover"&&t)){p(!1);return}if(!n)return;if(j(!0),await L(t))p(!0);else{const D=new URL(window.location.href);D.searchParams.delete("mode"),D.searchParams.delete("bookingId"),window.history.replaceState({},"",D.pathname+D.search),E.info("Invalid handover request - showing standard map"),p(!1)}j(!1)})()},[r,t,n]),l.useEffect(()=>{c&&!y&&d(!0)},[c]),l.useEffect(()=>{(async()=>{g(!0);try{const S=await gt();if(!S){E.error("Failed to get the map token"),console.error("Failed to get the map token");return}a(S)}catch(S){console.error("Error getting the map token:",S),E.error("Failed to get the map token")}finally{g(!1)}})()},[]);const k=async()=>{var C,S;if(!n)return null;try{const{data:b,error:D}=await V.from("handover_sessions").select(`
          host_id,
          host_location,
          bookings!inner(
            car_id,
            cars!inner(
              owner_id,
              profiles!owner_id(id, full_name, avatar_url, latitude, longitude)
            )
          )
        `).eq("renter_id",n.id).eq("handover_completed",!1).single();if(D||!b)return console.log("No active handover session found"),null;const T=(S=(C=b.bookings)==null?void 0:C.cars)==null?void 0:S.profiles;if(T!=null&&T.latitude&&(T!=null&&T.longitude))return{id:T.id,full_name:T.full_name,avatar_url:T.avatar_url,latitude:T.latitude,longitude:T.longitude,updated_at:null,isActiveHandover:!0}}catch(b){console.error("Error fetching active handover host:",b)}return null},z=async()=>{console.log("Fetching host locations...");try{const C=await Bs();console.log("Online hosts fetched:",C);const S=await k();console.log("Active handover host:",S);const b=[...C];if(S){const D=b.findIndex(T=>T.id===S.id);D>=0?b[D]=S:b.push(S)}b.length||E.info("No hosts are currently online"),console.log("All host locations to display:",b),u(b)}catch(C){console.error("Error fetching host locations:",C),E.error("Failed to fetch host locations")}};l.useEffect(()=>{c||(z(),console.log("Location",h))},[c]);const $=()=>_==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",q=()=>m||f?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:f?"Validating handover...":"Loading map..."}),e.jsx(xs,{color:"#7c3aed",width:100})]}):o?e.jsx(Us,{mapbox_token:o,longitude:25.90859,latitude:-24.65451,onlineHosts:c?[]:i,mapStyle:$(),isHandoverMode:c,bookingId:t,dpad:!0,locationToggle:!0,destination:h}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]}),I=!!n&&c,F=e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("main",{className:"flex-1 relative overflow-hidden",children:[q(),I&&e.jsxs(Rr,{children:[e.jsx(Er,{onBookingClick:(C,S)=>{if(console.log("Map received booking click for:",C,"type:",S),console.log("Current booking ID from URL:",t),console.log("Current handover sheet state:",y),S==="return"){window.location.href=`/rental-details/${C}`;return}C!==t&&(console.log("Updating URL with new booking ID"),window.history.replaceState({},"",`/map?mode=handover&bookingId=${C}`)),console.log("Opening handover sheet"),d(!0)}}),e.jsx(Cr,{isOpen:y,onClose:()=>{d(!1);const C=new URL(window.location.href);C.searchParams.delete("mode"),C.searchParams.delete("bookingId"),window.history.replaceState({},"",C.pathname+C.search)},bookingId:t||""})]})]}),e.jsx(Ot,{})]});return e.jsx(gs,{children:I?e.jsx(ps,{children:F}):F})};export{hn as default};
