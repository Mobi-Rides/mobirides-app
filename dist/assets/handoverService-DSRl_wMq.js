import{s,F as f}from"./index-BAM2AQzj.js";const v=async(n,r,o,u)=>{var a;try{const{data:e}=await s.auth.getUser(),i=(a=e==null?void 0:e.user)==null?void 0:a.id;if(!i)throw new Error("User not authenticated");if(i!==r&&i!==o)throw new Error("Only the host or renter can create a handover session");const{data:g,error:c}=await s.from("handover_sessions").insert({booking_id:n,host_id:r,renter_id:o,host_ready:!1,renter_ready:!1,handover_completed:!1}).select().single();if(c){if(c.code==="42501")console.error("RLS policy violation:",c),f.error("Permission denied: You don't have access to create a handover session");else throw c;return null}if(i===r)try{const{data:t}=await s.from("profiles").select("full_name").eq("id",r).single(),_=(t==null?void 0:t.full_name)||"The host",{data:l}=await s.from("bookings").select("car_id").eq("id",n).single(),h=l==null?void 0:l.car_id;if(h){const y=`${_} is requesting your location for car handover. Please share your location to proceed with the handover process.`,{error:d}=await s.from("notifications").insert({user_id:o,type:"message_received",content:y,related_car_id:h,related_booking_id:n});d?console.error("Error creating notification:",d.message||JSON.stringify(d,null,2)):console.log("Location request notification sent to renter")}}catch(t){console.error("Error sending notification:",t instanceof Error?t.message:JSON.stringify(t,null,2))}return g}catch(e){return console.error("Error creating handover session:",e instanceof Error?e.message:JSON.stringify(e,null,2)),f.error(`Failed to create handover session: ${e instanceof Error?e.message:"Unknown error"}`),null}},w=async n=>{try{const{data:r,error:o}=await s.from("handover_sessions").select("*").eq("booking_id",n).single();if(o)throw o;return r}catch(r){return console.error("Error fetching handover session:",r instanceof Error?r.message:JSON.stringify(r,null,2)),null}},p=async(n,r,o,u)=>{try{const a=o?"host_location":"renter_location",{error:e}=await s.from("handover_sessions").update({[a]:u,updated_at:new Date().toISOString()}).eq("id",n).eq(o?"host_id":"renter_id",r);if(e)throw e;return!0}catch(a){return console.error("Error updating location:",a),f.error("Failed to update your location"),!1}};export{v as c,w as g,p as u};
