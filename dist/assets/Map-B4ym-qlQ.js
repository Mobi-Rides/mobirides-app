var We=Object.defineProperty;var Ke=(r,s,t)=>s in r?We(r,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[s]=t;var ae=(r,s,t)=>Ke(r,typeof s!="symbol"?s+"":s,t);import{j as e,u as Ge}from"./query-vendor-BOSMW7hd.js";import{r as c,u as Re,d as Ye,h as Xe}from"./react-vendor-DmU5vXC9.js";import{N as Qe}from"./Navigation-k0oYb1zd.js";import{m as z}from"./mapbox-vendor-ueN8uhVJ.js";import{G as Je}from"./mapbox-gl-BYA3sVwJ.js";import{c as Q,B as L,q as Ze,r as et,s as $,X as he,t as He,n as X,v as Le,J as ce,w as _,C as ve,x as Te,y as De,z as $e,T as Ae,I as Fe,f as ke,E as tt,F as Ue,G as st,H as rt,K as at,M as ot,N as nt,g as it,h as lt,R as Se,O as ct,u as dt,Q as ut,V as mt,W as ht}from"./index-BnOLzhwz.js";import{A as gt}from"./arrow-right-CmTw-G4o.js";import{O as ft}from"./OnlineStatusToggle-CjYhPyte.js";import{U as Ve}from"./user-txy-ji6A.js";import{S as je}from"./star-CW-HfHZw.js";import{C as B,d as O,a as te,b as se}from"./card-CDc_xlrS.js";import{C as qe}from"./car-CQMiUMTl.js";import{M as fe}from"./map-pin-cZ2IpURy.js";import{C as de}from"./camera-D8Q8anJf.js";import{U as ze}from"./upload-D0lxYQEY.js";import{S as xt,a as pt,b as vt,c as jt,d as xe}from"./select-BMlCfmgX.js";import{S as yt}from"./slider-CCNNU4Oy.js";import{C as pe}from"./checkbox-UydronK6.js";import{C as ee}from"./circle-check-big-Bkn7QkAB.js";import{R as Nt,P as ye}from"./progress-5bJbFhCm.js";import{C as be}from"./clock-C62Gyxh0.js";import{F as wt}from"./flag-Bukph9oH.js";import{N as Ce}from"./navigation-DqpSjE7a.js";import{C as ge}from"./circle-alert-FqYpxmOc.js";import{L as bt}from"./loader-circle-0W2tavOT.js";import{u as _t}from"./useAuthStatus-C5dzrHBE.js";import{C as kt}from"./calendar-BNv8_YNk.js";import{D as St}from"./dollar-sign-R6wyBvSV.js";import{a as Ee}from"./date-vendor-Dhms5dOu.js";import{H as Ct}from"./house-D-hWTk5i.js";import"./bell-Ogze43Aj.js";import"./supabase-vendor-B3A6ooRR.js";import"./switch-DOsSF0bp.js";import"./index-CEVvJeOa.js";import"./index-Bad3wlzf.js";import"./chevron-down-BUo5rrj4.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Et=Q("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=Q("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=Q("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=Q("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=Q("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=Q("Navigation2",[["polygon",{points:"12 2 19 21 12 17 5 21 12 2",key:"x8c0qg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=Q("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=Q("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=Q("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=Q("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);function Dt({onUp:r,onDown:s,onLeft:t,onRight:i,onReset:m}){return e.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[e.jsx("div",{className:"flex gap-1",children:e.jsx(L,{variant:"default",onClick:r,style:{height:40},children:e.jsx(Pt,{name:"arrow-up",size:24,color:"white"})})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(L,{variant:"default",onClick:t,style:{width:20},children:e.jsx(Ze,{name:"arrow-left",size:24,color:"white"})}),e.jsx(L,{variant:"default",onClick:m,children:e.jsx(et,{name:"arrow-left",size:24,color:"white"})}),e.jsx(L,{variant:"default",onClick:i,style:{width:20},children:e.jsx(gt,{name:"arrow-right",size:24,color:"white"})})]}),e.jsx("div",{className:"flex gap-1",children:e.jsx(L,{variant:"default",onClick:s,style:{height:40},children:e.jsx(Et,{name:"arrow-down",size:24,color:"white"})})})]})}const $t=({host:r,onViewCars:s})=>{const t=()=>r.avatar_url?$.storage.from("avatars").getPublicUrl(r.avatar_url).data.publicUrl:"/placeholder.svg";return e.jsx("div",{className:"bg-background border rounded-lg shadow-lg p-3 min-w-[200px] cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>s(r.id),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex items-center justify-center",children:r.avatar_url?e.jsx("img",{src:t(),alt:r.full_name||"Host",className:"w-full h-full object-cover"}):e.jsx(Ve,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:r.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(je,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32)"})]}),e.jsx("p",{className:"text-xs text-primary mt-1",children:"View available cars →"})]})]})})},At=({isOpen:r,onClose:s,host:t})=>{const[i,m]=c.useState([]),[n,d]=c.useState(!1),p=Re();c.useEffect(()=>{r&&(t!=null&&t.id)&&a(t.id)},[r,t==null?void 0:t.id]);const a=async u=>{d(!0),console.log("Fetching cars for host:",u);try{console.log("Step 1: Checking if host has any cars...");const{data:R,error:o}=await $.from("cars").select("*").eq("owner_id",u);console.log("All cars for host:",R),o&&console.error("Error fetching all cars:",o),console.log("Step 2: Checking available cars...");const{data:f,error:h}=await $.from("cars").select("*").eq("owner_id",u).eq("is_available",!0);if(console.log("Available cars for host:",f),h&&console.error("Error fetching available cars:",h),f&&f.length>0){console.log("Step 3: Checking car images...");const k=f.map(H=>H.id),{data:A,error:w}=await $.from("car_images").select("*").in("car_id",k);console.log("Car images:",A),w&&console.error("Error fetching car images:",w)}console.log("Step 4: Trying with left join...");const{data:v,error:y}=await $.from("cars").select(`
          *,
          car_images(
            image_url,
            is_primary
          )
        `).eq("owner_id",u).eq("is_available",!0);if(y){console.error("Error fetching host cars with left join:",y);return}console.log("Cars with left join:",v);const F=(v==null?void 0:v.map(k=>{var w,H,U;const A=(w=k.car_images)==null?void 0:w.find(V=>V.is_primary);return{...k,image_url:(A==null?void 0:A.image_url)||((U=(H=k.car_images)==null?void 0:H[0])==null?void 0:U.image_url)||k.image_url}}))||[];console.log("Transformed cars:",F),m(F)}catch(R){console.error("Error in fetchHostCars:",R)}finally{d(!1)}},g=u=>u?$.storage.from("car-images").getPublicUrl(u).data.publicUrl:"/placeholder.svg",N=()=>t!=null&&t.avatar_url?$.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",j=u=>{p(`/cars/${u}`),s()};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:s}),e.jsx("div",{className:"fixed left-0 top-0 h-full w-80 bg-background border-r shadow-xl z-50 transform transition-transform duration-300",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Host's Cars"}),e.jsx(L,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(he,{className:"w-4 h-4"})})]}),t&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:N(),alt:t.full_name||"Host",className:"w-10 h-10 rounded-full object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(je,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32 reviews)"})]})]})]})]}),e.jsx(He,{className:"flex-1",children:e.jsx("div",{className:"p-4 space-y-4",children:n?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."})}):i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(qe,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No available cars"})]}):i.map(u=>e.jsx(B,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>j(u.id),children:e.jsxs(O,{className:"p-3",children:[e.jsx("div",{className:"aspect-video w-full mb-3 rounded-lg overflow-hidden bg-muted",children:e.jsx("img",{src:g(u.image_url),alt:`${u.brand} ${u.model}`,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm",children:[u.brand," ",u.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u.year})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-sm",children:["P",u.price_per_day]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"per day"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(fe,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:u.location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(X,{variant:"secondary",className:"text-xs px-2 py-1",children:u.vehicle_type}),e.jsxs("span",{className:"text-muted-foreground",children:[u.seats," seats"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:u.transmission})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(je,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.5 (12)"})]})]})]})},u.id))})})]})})]}):null},Ft=({mapbox_token:r,longitude:s,latitude:t,onlineHosts:i,mapStyle:m="mapbox://styles/mapbox/streets-v12",isHandoverMode:n=!1,bookingId:d,zoom:p,interactive:a,dpad:g,locationToggle:N,destination:j,returnLocation:u})=>{const R=c.useRef(null),o=c.useRef(null),f=c.useRef(null),[h,v]=c.useState(!1),[y,F]=c.useState({latitude:t,longitude:s}),[k,A]=c.useState([]),[w,H]=c.useState([]),[U,V]=c.useState(null),[P,M]=c.useState(!1),T=Le(),I=n?T:null;c.useEffect(()=>{if(!u)return;const b=y.longitude,x=y.latitude;u(b,x)},[y]),c.useEffect(()=>{if(r&&(z.accessToken=r),!o.current&&R.current&&r){o.current=new z.Map({container:R.current,style:m,center:[s,t],zoom:p||14,interactive:a||!0}),o.current.addControl(new z.NavigationControl,"top-right");const b=new z.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});o.current.addControl(b,"top-right"),f.current=b,b.on("error",x=>{console.error("Geolocation error:",x),ce.error("Unable to access your location. Please check your browser permissions."),n&&I&&ce.error("Location sharing is required for the handover process. Please enable location access.")}),o.current.on("load",()=>{console.log("Map loaded successfully"),v(!0),f.current&&f.current.on("geolocate",x=>{console.log("Geolocate event fired:",x.coords);const l={longitude:x.coords.longitude,latitude:x.coords.latitude};F(l),console.log("User location updated:",l),n&&I&&(console.log("In handover mode, updating handover location..."),q(l.latitude,l.longitude).then(E=>{console.log("Address fetched:",E),I.updateLocation({latitude:l.latitude,longitude:l.longitude,address:E||"Unknown location"})}))}),setTimeout(()=>{f.current&&f.current.trigger()},1e3)}),o.current.on("error",x=>{console.error("Map error:",x),ce.error("Error loading map. Please refresh.")}),u&&o.current.on("click",x=>{console.log("Map clicked at coordinates:",x.lngLat),u(x.lngLat.lng,x.lngLat.lat)})}return()=>{o.current&&(o.current.remove(),o.current=null)}},[r,s,t,m,n,I]);const q=async(b,x)=>{try{const E=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${x},${b}.json?access_token=${r}`)).json();return E.features&&E.features.length>0?E.features[0].place_name:null}catch(l){return console.error("Error fetching address:",l),null}};c.useEffect(()=>{o.current&&h&&o.current.setStyle(m)},[m,h]);const J=b=>{console.log("Trying to view cars for host:",b);const x=i==null?void 0:i.find(l=>l.id===b);if(console.log("Found host:",x),x){const l={id:x.id,full_name:x.full_name,avatar_url:x.avatar_url,latitude:x.latitude,longitude:x.longitude,updated_at:x.updated_at};console.log("Setting selected host:",l),V(l),M(!0)}else console.log("No host found with ID:",b)},Z=b=>{if(!o.current||!h||!y.latitude||!y.longitude)return;(async()=>{try{const E=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${y.longitude},${y.latitude};${b.longitude},${b.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(E.routes&&E.routes.length>0){const K=E.routes[0].geometry;o.current.getSource("host-route")?o.current.getSource("host-route").setData(K):(o.current.addSource("host-route",{type:"geojson",data:K}),o.current.addLayer({id:"host-route",type:"line",source:"host-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":b.isActiveHandover?"#ef4444":"#3b82f6","line-width":b.isActiveHandover?6:4}}));const D=new z.LngLatBounds().extend([y.longitude,y.latitude]).extend([b.longitude,b.latitude]);o.current.fitBounds(D,{padding:50,maxZoom:15})}}catch(l){console.error("Error fetching route to host:",l),ce.error("Unable to calculate route")}})()};c.useEffect(()=>{if(!o.current||!h||!(i!=null&&i.length))return;k.forEach(l=>l.remove()),A([]);const b=i.map(l=>{if(!l.latitude||!l.longitude)return null;const E=document.createElement("div");E.className="host-marker",E.style.width=l.isActiveHandover?"24px":"20px",E.style.height=l.isActiveHandover?"24px":"20px",E.style.borderRadius="50%",E.style.backgroundColor=l.isActiveHandover?"#ef4444":"#4ade80",E.style.border=l.isActiveHandover?"3px solid white":"2px solid white",E.style.boxShadow=l.isActiveHandover?"0 0 15px rgba(239, 68, 68, 0.5)":"0 0 10px rgba(0, 0, 0, 0.3)",E.style.cursor="pointer",l.isActiveHandover&&(E.style.animation="pulse 2s infinite");const K=document.createElement("div"),D=new z.Marker(E).setLngLat([l.longitude,l.latitude]).addTo(o.current);return E.addEventListener("mouseenter",()=>{Ye.render(e.jsx($t,{host:l,onViewCars:J}),K);const G=new z.Popup({offset:25,closeButton:!1,closeOnClick:!1,className:"host-popup"}).setDOMContent(K).addTo(o.current);D.setPopup(G),G.addTo(o.current)}),E.addEventListener("mouseleave",()=>{setTimeout(()=>{const G=D.getPopup();G&&G.remove()},100)}),E.addEventListener("click",()=>{J(l.id),o.current&&h&&(async()=>{try{const ie=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${y.longitude},${y.latitude};${l.longitude},${l.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(ie.routes&&ie.routes.length>0){const le=ie.routes[0].geometry;o.current.getSource("route")?o.current.getSource("route").setData(le):(o.current.addSource("route",{type:"geojson",data:le}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}));const ue=new z.LngLatBounds().extend([y.longitude,y.latitude]).extend([l.longitude,l.latitude]);o.current.fitBounds(ue,{padding:50,maxZoom:15})}}catch(Y){console.error("Error fetching route to host:",Y),ce.error("Unable to calculate route")}})()}),D}).filter(Boolean);A(b);const x=i==null?void 0:i.find(l=>l.isActiveHandover);x&&y.latitude&&y.longitude&&setTimeout(()=>{Z(x)},1e3)},[i,h,n,y]),c.useEffect(()=>{if(!o.current||!h||!j)return;const{latitude:b,longitude:x}=j,l=document.createElement("div");l.className="destination-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#f59e0b",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const E=new z.Marker(l).setLngLat([x,b]).setPopup(new z.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(o.current);return()=>{E.remove()}}),c.useEffect(()=>{if(!o.current||!h||!j)return;const{latitude:b,longitude:x}=j;return(async()=>{try{const K=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${y.longitude},${y.latitude};${x},${b}?geometries=geojson&access_token=${z.accessToken}`)).json();if(K.routes&&K.routes.length>0){const D=K.routes[0].geometry;o.current.getSource("route")?o.current.getSource("route").setData(D):(o.current.addSource("route",{type:"geojson",data:D}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(E){console.error("Error fetching route:",E)}})(),()=>{o.current&&(o.current.getStyle()&&o.current.getLayer("route")&&o.current.removeLayer("route"),o.current.getStyle()&&o.current.getSource("route")&&o.current.removeSource("route"))}},[h,j,y]),c.useEffect(()=>{if(!o.current||!h||!n||!(I!=null&&I.handoverStatus))return;w.forEach(x=>x.remove()),H([]);const b=[];if(I.handoverStatus.host_location){const x=I.handoverStatus.host_location,l=document.createElement("div");l.className="host-handover-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#3b82f6",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const E=new z.Marker(l).setLngLat([x.longitude,x.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${x.address}</p>`)).addTo(o.current);b.push(E)}if(I.handoverStatus.renter_location){const x=I.handoverStatus.renter_location,l=document.createElement("div");l.className="renter-handover-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#ec4899",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const E=new z.Marker(l).setLngLat([x.longitude,x.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${x.address}</p>`)).addTo(o.current);b.push(E)}if(b.length===2&&o.current){const x=new z.LngLatBounds;b.forEach(l=>{x.extend(l.getLngLat())}),o.current.fitBounds(x,{padding:100,maxZoom:15})}H(b)},[I==null?void 0:I.handoverStatus,h,n]);const re=()=>{o.current&&o.current.panBy([0,-100],{duration:500})},ne=()=>{o.current&&o.current.panBy([0,100],{duration:500})},S=()=>{o.current&&o.current.panBy([-100,0],{duration:500})},W=()=>{o.current&&o.current.panBy([100,0],{duration:500})},C=()=>{o.current&&o.current.flyTo({center:[y.longitude,y.latitude],zoom:20,essential:!0})};return e.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[e.jsx("div",{ref:R,className:"w-full h-full"}),!n&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:N&&e.jsx(ft,{lat:y.latitude,long:y.longitude})})}),n&&(I==null?void 0:I.handoverStatus)&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm font-medium",children:[I.isHost?"Host":"Renter"," Mode"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:I.handoverStatus.host_location&&I.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),g&&e.jsx(Dt,{onUp:re,onDown:ne,onLeft:S,onRight:W,onReset:C}),e.jsx(At,{isOpen:P,onClose:()=>M(!1),host:U})]})},Ut=async()=>{try{const{data:r,error:s}=await $.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(s)return console.error("Error checking location columns:",s),!1;if(!r||r.length===0)return console.error("No profiles found to check columns"),!1;const t=r[0];return t?"latitude"in t&&"longitude"in t&&"is_sharing_location"in t:!1}catch(r){return console.error("Error in checkLocationColumns:",r),!1}},Vt=r=>!r||typeof r!="object"?null:{id:typeof r.id=="string"?r.id:"",full_name:r.full_name||null,avatar_url:r.avatar_url||null,latitude:typeof r.latitude=="number"?r.latitude:null,longitude:typeof r.longitude=="number"?r.longitude:null,updated_at:r.updated_at||null},qt=async()=>{try{if(console.log("Fetching online hosts..."),!await Ut())return console.error("Required location columns don't exist in profiles table"),[];const{data:s,error:t}=await $.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(t)return console.error("Error fetching online hosts:",t),[];if(!s||!Array.isArray(s))return console.error("Expected array of hosts but got:",s),[];console.log(`Found ${s.length} online hosts`);const i=[];for(const m of s){const n=Vt(m);n&&i.push(n)}return i}catch(r){return console.error("Error in fetchOnlineHosts:",r),[]}},me=[{name:"navigation",order:1,title:"Navigate to Location",description:"Get directions to the handover location"},{name:"identity_verification",order:2,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:3,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:4,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:5,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:6,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:7,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:8,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:9,title:"Handover Complete",description:"Finalize the handover process"}],zt=async r=>{try{const{data:s}=await $.from("handover_step_completion").select("id").eq("handover_session_id",r);if(s&&s.length>0)return console.log("Handover steps already initialized"),!0;const t=me.map(m=>({handover_session_id:r,step_name:m.name,step_order:m.order,is_completed:!1})),{error:i}=await $.from("handover_step_completion").insert(t);if(i)throw i;return console.log("Handover steps initialized successfully"),!0}catch(s){return console.error("Error initializing handover steps:",s),_.error("Failed to initialize handover steps"),!1}},Pe=async r=>{try{const{data:s,error:t}=await $.from("handover_step_completion").select("*").eq("handover_session_id",r).order("step_order");if(t)throw t;return s||[]}catch(s){return console.error("Error fetching handover steps:",s),[]}},Bt=async(r,s,t)=>{var i;try{const{data:m}=await $.auth.getUser();if(!((i=m==null?void 0:m.user)!=null&&i.id))throw new Error("User not authenticated");const{data:n}=await $.from("handover_step_completion").select("step_order").eq("handover_session_id",r).eq("step_name",s).single();if(!n)throw new Error("Step not found");const d=await Ot(r,s,t);if(!d.isValid)return _.error(d.message),!1;const{error:p}=await $.from("handover_step_completion").update({is_completed:!0,completed_by:m.user.id,completion_data:t,completed_at:new Date().toISOString()}).eq("handover_session_id",r).eq("step_name",s);if(p){if(p.message.includes("Previous steps must be completed"))_.error("Please complete previous steps first");else throw p;return!1}return console.log(`Step ${s} completed successfully`),_.success(`${s.replace("_"," ")} completed`),!0}catch(m){return console.error("Error completing handover step:",m),m.message.includes("Previous steps must be completed")?_.error("Please complete previous steps in order"):_.error("Failed to complete handover step"),!1}},Ot=async(r,s,t)=>{switch(s){case"fuel_mileage_check":if(!(t!=null&&t.fuel_level)||!(t!=null&&t.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};if(t.fuel_level<0||t.fuel_level>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(t.mileage<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(t!=null&&t.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},_e=async(r,s,t,i=3)=>{var n;let m=0;for(;m<i;)try{const{data:d}=await $.auth.getUser();if(!((n=d==null?void 0:d.user)!=null&&n.id))throw new Error("User not authenticated");const p=r.name.split(".").pop(),a=`${d.user.id}/${s}/${t}_${Date.now()}.${p}`,{error:g}=await $.storage.from("handover-photos").upload(a,r);if(g)throw g;const{data:{publicUrl:N}}=$.storage.from("handover-photos").getPublicUrl(a);return console.log(`Photo uploaded successfully: ${a}`),N}catch(d){if(m++,console.error(`Photo upload attempt ${m} failed:`,d),m>=i)return _.error("Failed to upload photo after multiple attempts"),null;await new Promise(p=>setTimeout(p,1e3*m))}return null},Wt=async r=>{var s;try{const{data:t}=await $.auth.getUser();if(!((s=t==null?void 0:t.user)!=null&&s.id))throw new Error("User not authenticated");const i={handover_session_id:r.handover_session_id,booking_id:r.booking_id,car_id:r.car_id,report_type:r.report_type,vehicle_photos:JSON.stringify(r.vehicle_photos),damage_reports:JSON.stringify(r.damage_reports),fuel_level:r.fuel_level,mileage:r.mileage,exterior_condition_notes:r.exterior_condition_notes,interior_condition_notes:r.interior_condition_notes,additional_notes:r.additional_notes,digital_signature_data:r.digital_signature_data,is_acknowledged:r.is_acknowledged,reporter_id:r.reporter_id||t.user.id},{data:m,error:n}=await $.from("vehicle_condition_reports").insert(i).select().single();if(n)throw n;return console.log("Vehicle condition report created successfully"),m}catch(t){return console.error("Error creating vehicle condition report:",t),_.error("Failed to create condition report"),null}},Kt=async r=>{var s;try{const{data:t}=await $.auth.getUser();if(!((s=t==null?void 0:t.user)!=null&&s.id))throw new Error("User not authenticated");const i={handover_session_id:r.handover_session_id,verifier_id:t.user.id,verified_user_id:r.verified_user_id,verification_photo_url:r.verification_photo_url,license_photo_url:r.license_photo_url,verification_status:r.verification_status,verification_notes:r.verification_notes},{data:m,error:n}=await $.from("identity_verification_checks").insert(i).select().single();if(n)throw n;return m}catch(t){return console.error("Error creating identity verification check:",t),_.error("Failed to create identity verification"),null}},Gt=({handoverSessionId:r,otherUserId:s,otherUserName:t,isHost:i,onStepComplete:m})=>{const[n,d]=c.useState(null),[p,a]=c.useState(!1),[g,N]=c.useState("pending"),[j,u]=c.useState(""),[R,o]=c.useState(!1),f=async v=>{var F;const y=(F=v.target.files)==null?void 0:F[0];if(y){a(!0);try{const k=await _e(y,r,"identity_verification");k&&(d(k),await Kt({handover_session_id:r,verifier_id:"",verified_user_id:s,verification_photo_url:k,verification_status:"pending"}),_.success("Verification photo uploaded successfully"))}catch{_.error("Failed to upload verification photo")}finally{a(!1)}}},h=async v=>{o(!0);try{N(v),v==="verified"?(_.success(`${t}'s identity verified successfully`),m()):_.error("Identity verification failed")}catch{_.error("Failed to update verification status")}finally{o(!1)}};return e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",t,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx(O,{className:"space-y-4",children:n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:n,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(X,{variant:g==="verified"?"default":g==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[g==="verified"&&e.jsx(ve,{className:"h-3 w-3 mr-1"}),g==="failed"&&e.jsx(he,{className:"h-3 w-3 mr-1"}),g.charAt(0).toUpperCase()+g.slice(1)]})]}),g==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{placeholder:"Add any notes about the verification...",value:j,onChange:v=>u(v.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(L,{onClick:()=>h("verified"),disabled:R,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(L,{onClick:()=>h("failed"),disabled:R,variant:"destructive",className:"flex-1",children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),g==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),g==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(de,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",t," for identity verification"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:f,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:p}),e.jsx(L,{disabled:p,className:"flex items-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-4 w-4"}),"Take Photo"]})})]})]})})]})},Yt={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},Ie=({handoverSessionId:r,inspectionType:s,onPhotosUpdate:t,onStepComplete:i,initialPhotos:m=[]})=>{const[n,d]=c.useState(m),[p,a]=c.useState(!1),[g,N]=c.useState(null),j=c.useRef({}),u=Yt[s],R=u.filter(w=>w.required),o=R.filter(w=>n.some(H=>H.type===w.type)),f=async(w,H)=>{a(!0),N(w);try{const U=await _e(H,r,w);if(U){const V={id:`${Date.now()}-${w}`,type:w,url:U,timestamp:new Date().toISOString()},P=[...n,V];d(P),t(P),_.success("Photo uploaded successfully")}}catch{_.error("Failed to upload photo")}finally{a(!1),N(null)}},h=w=>{const H=j.current[w];H&&(N(w),H.click())},v=(w,H)=>{var V;const U=(V=w.target.files)==null?void 0:V[0];U&&f(H,U),w.target.value=""},y=w=>{const H=n.filter(U=>U.id!==w);d(H),t(H)},F=w=>n.find(H=>H.type===w),k=o.length===R.length,A=()=>{k&&(i(),_.success(`${s} inspection completed`))};return e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5"}),s==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(X,{variant:k?"default":"secondary",children:[o.length,"/",R.length," Required Photos"]})})]}),e.jsxs(O,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:u.map(w=>{const H=F(w.type),U=g===w.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:w.label}),w.required&&e.jsx(X,{variant:"outline",className:"text-xs",children:"Required"})]}),H?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:H.url,alt:w.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(L,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>y(H.id),children:e.jsx(De,{className:"h-4 w-4"})})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>h(w.type),children:[e.jsx("input",{ref:V=>j.current[w.type]=V,type:"file",accept:"image/*",capture:"environment",onChange:V=>v(V,w.type),className:"hidden"}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:U&&g===w.type?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-6 w-6 animate-spin text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})]},w.type)})}),k&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(L,{onClick:A,className:"w-full",children:["Complete ",s==="exterior"?"Exterior":"Interior"," Inspection"]})}),!k&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},Xt=({handoverSessionId:r,onDamageReportsUpdate:s,onStepComplete:t,initialReports:i=[]})=>{const[m,n]=c.useState(i),[d,p]=c.useState(!1),[a,g]=c.useState({location:"",severity:"minor",description:"",photos:[]}),[N,j]=c.useState(!1),u=async h=>{j(!0);try{const v=await _e(h,r,"damage_specific");v&&(g(y=>({...y,photos:[...y.photos,v]})),_.success("Damage photo uploaded"))}catch{_.error("Failed to upload damage photo")}finally{j(!1)}},R=()=>{if(!a.location||!a.description){_.error("Please fill in location and description");return}const h={id:`damage-${Date.now()}`,location:a.location,severity:a.severity,description:a.description,photos:a.photos,timestamp:new Date().toISOString()},v=[...m,h];n(v),s(v),g({location:"",severity:"minor",description:"",photos:[]}),p(!1),_.success("Damage report added")},o=h=>{const v=m.filter(y=>y.id!==h);n(v),s(v)},f=h=>{switch(h){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs(O,{className:"space-y-4",children:[m.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",m.length,")"]}),m.map(h=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:h.location}),e.jsx(X,{className:`ml-2 ${f(h.severity)}`,children:h.severity})]}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>o(h.id),children:e.jsx(De,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:h.description}),h.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:h.photos.map((v,y)=>e.jsx("img",{src:v,alt:`Damage ${y+1}`,className:"w-full h-20 object-cover rounded"},y))})]},h.id))]}),d?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(Fe,{placeholder:"e.g., Front bumper, Driver door",value:a.location,onChange:h=>g(v=>({...v,location:h.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(xt,{value:a.severity,onValueChange:h=>g(v=>({...v,severity:h})),children:[e.jsx(pt,{children:e.jsx(vt,{})}),e.jsxs(jt,{children:[e.jsx(xe,{value:"minor",children:"Minor"}),e.jsx(xe,{value:"moderate",children:"Moderate"}),e.jsx(xe,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(Te,{placeholder:"Describe the damage in detail...",value:a.description,onChange:h=>g(v=>({...v,description:h.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[a.photos.map((h,v)=>e.jsx("img",{src:h,alt:`Damage photo ${v+1}`,className:"w-full h-20 object-cover rounded"},v)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:h=>{var y;const v=(y=h.target.files)==null?void 0:y[0];v&&u(v)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:N}),e.jsx(de,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{onClick:R,className:"flex-1",children:"Save Damage Report"}),e.jsx(L,{variant:"outline",onClick:()=>p(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(L,{onClick:()=>p(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(L,{onClick:t,className:"w-full",children:m.length>0?`Complete Documentation (${m.length} damage reports)`:"No Damage - Complete Step"})})]})]})},Qt=({handoverSessionId:r,onFuelLevelChange:s,onMileageChange:t,onStepComplete:i,initialFuelLevel:m,initialMileage:n})=>{const[d,p]=c.useState(m||50),[a,g]=c.useState((n==null?void 0:n.toString())||""),N=o=>{const f=o[0];p(f),s(f)},j=o=>{g(o);const f=parseInt(o,10);isNaN(f)||t(f)},u=a!==""&&!isNaN(parseInt(a,10))&&parseInt(a,10)>0,R=()=>{u?(i(),_.success("Fuel level and mileage recorded successfully")):_.error("Please enter a valid mileage reading")};return e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Je,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs(O,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(ke,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(yt,{value:[d],onValueChange:N,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[d,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${d<=25?"#ef4444":d<=50?"#f59e0b":"#10b981"} 0deg,
                    ${d<=25?"#ef4444":d<=50?"#f59e0b":"#10b981"} ${d/100*360}deg,
                    #e5e7eb ${d/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[d,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ke,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(It,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Fe,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:a,onChange:o=>j(o.target.value),className:"pl-10",min:"0"})]}),a&&!isNaN(parseInt(a,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(a,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[d,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:a?`${parseInt(a,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(L,{onClick:R,disabled:!u,className:"w-full",children:"Complete Fuel & Mileage Check"}),!u&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},Jt=({handoverSessionId:r,otherUserName:s,isHost:t,onStepComplete:i})=>{const[m,n]=c.useState(!1),[d,p]=c.useState(!1),[a,g]=c.useState(!1),N=m&&d&&a,j=()=>{N&&(i(),_.success("Key transfer completed successfully"))};return e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?`Transfer vehicle keys to ${s}`:`Receive vehicle keys from ${s}`})]}),e.jsxs(O,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(pe,{id:"key-transferred",checked:m,onCheckedChange:u=>n(u)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:t?`I have handed over the main vehicle key to ${s}`:`I have received the main vehicle key from ${s}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(pe,{id:"key-received",checked:d,onCheckedChange:u=>p(u)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:t?`${s} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(pe,{id:"spares-confirmed",checked:a,onCheckedChange:u=>g(u)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:m&&d?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(L,{onClick:j,disabled:!N,className:"w-full",children:"Complete Key Transfer"}),!N&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},Zt=({handoverSessionId:r,onSignatureComplete:s,initialSignature:t})=>{const i=c.useRef(null),[m,n]=c.useState(!1),[d,p]=c.useState(!!t),[a,g]=c.useState(t||null),N=f=>{f.preventDefault(),n(!0);const h=i.current;if(!h)return;const v=h.getBoundingClientRect(),y=h.width/v.width,F=h.height/v.height,k=h.getContext("2d");if(!k)return;k.lineWidth=2,k.lineCap="round",k.strokeStyle="#000";let A,w;"touches"in f?(A=(f.touches[0].clientX-v.left)*y,w=(f.touches[0].clientY-v.top)*F):(A=(f.clientX-v.left)*y,w=(f.clientY-v.top)*F),k.beginPath(),k.moveTo(A,w)},j=f=>{if(!m)return;f.preventDefault();const h=i.current,v=h==null?void 0:h.getContext("2d");if(!h||!v)return;const y=h.getBoundingClientRect(),F=h.width/y.width,k=h.height/y.height;let A,w;"touches"in f?(A=(f.touches[0].clientX-y.left)*F,w=(f.touches[0].clientY-y.top)*k):(A=(f.clientX-y.left)*F,w=(f.clientY-y.top)*k),v.lineTo(A,w),v.stroke(),p(!0)},u=()=>{n(!1)},R=()=>{const f=i.current,h=f==null?void 0:f.getContext("2d");!f||!h||(h.clearRect(0,0,f.width,f.height),p(!1),g(null))},o=()=>{const f=i.current;if(!f||!d)return;const h=f.toDataURL("image/png");g(h),s(h),_.success("Digital signature captured successfully")};return c.useState(()=>{if(t&&i.current){const h=i.current.getContext("2d"),v=new Image;v.onload=()=>{h==null||h.drawImage(v,0,0)},v.src=t}}),e.jsxs(B,{className:"w-full",children:[e.jsxs(te,{children:[e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:i,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:N,onMouseMove:j,onMouseUp:u,onMouseLeave:u,onTouchStart:N,onTouchMove:j,onTouchEnd:u,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{variant:"outline",onClick:R,disabled:!d,className:"flex-1",children:[e.jsx(Nt,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(L,{onClick:o,disabled:!d,className:"flex-1",children:[e.jsx(ve,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),a&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},es=({currentStep:r,totalDistance:s,totalDuration:t,isNavigating:i,onToggleVoice:m,isVoiceEnabled:n,onStopNavigation:d,onArrived:p,destination:a,showArrivedButton:g=!1})=>{const[N,j]=c.useState("");c.useEffect(()=>{if(t>0){const o=new Date(Date.now()+t*1e3);j(o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))}},[t]);const u=o=>o<1e3?`${Math.round(o)}m`:`${(o/1e3).toFixed(1)}km`,R=o=>{const f=Math.floor(o/60);if(f<1)return"< 1 min";if(f<60)return`${f} min`;const h=Math.floor(f/60),v=f%60;return`${h}h ${v}m`};return!i||!r?null:e.jsx(B,{className:"mx-4 mt-4 shadow-lg border-primary/20",children:e.jsxs(O,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(fe,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["To ",a]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 p-0",children:n?e.jsx(Lt,{className:"h-4 w-4"}):e.jsx(Tt,{className:"h-4 w-4"})}),e.jsx(L,{variant:"outline",size:"sm",onClick:d,className:"text-xs",children:"Stop"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg mt-1",children:e.jsx(Ne,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground mb-1",children:r.instruction}),r.road_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["on ",r.road_name]}),e.jsx("div",{className:"flex items-center space-x-1 mt-2",children:e.jsx(X,{variant:"secondary",className:"text-xs",children:u(r.distance)})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Be,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:R(t)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"text-muted-foreground",children:u(s)})}),N&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(be,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-muted-foreground",children:["ETA ",N]})]})]}),g&&p&&e.jsx("div",{className:"mt-4 pt-4 border-t border-muted",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Used alternative navigation or already arrived?"}),e.jsx(L,{onClick:p,className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:"I've Arrived"})]})})]})})},ts=({steps:r,currentStepIndex:s,onStepClick:t,className:i=""})=>{const m=a=>a<1e3?`${Math.round(a)}m`:`${(a/1e3).toFixed(1)}km`,n=a=>a===0?e.jsx(fe,{className:"h-4 w-4"}):a===r.length-1?e.jsx(wt,{className:"h-4 w-4"}):e.jsx(Ne,{className:"h-4 w-4"}),d=a=>a<s?"text-muted-foreground":a===s?"text-primary":"text-foreground",p=a=>a<s?"bg-muted/50":a===s?"bg-primary/10 border-primary/20":"bg-background";return e.jsxs(B,{className:i,children:[e.jsx(te,{className:"pb-3",children:e.jsxs(se,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Turn-by-Turn Directions"]})}),e.jsx(O,{className:"p-0",children:e.jsx(He,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-2 p-4",children:r.map((a,g)=>e.jsxs("div",{className:`
                  flex items-start space-x-3 p-3 rounded-lg border transition-all
                  ${p(g)}
                  ${t?"cursor-pointer hover:bg-muted/30":""}
                  ${g===s?"border-primary/20":"border-transparent"}
                `,onClick:()=>t==null?void 0:t(g),children:[e.jsx("div",{className:`mt-1 ${d(g)}`,children:n(g)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-medium ${d(g)}`,children:a.instruction}),a.road_name&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["on ",a.road_name]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-2",children:[e.jsx(X,{variant:"secondary",className:"text-xs shrink-0",children:m(a.distance)}),g===s&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"})]})]})}),t&&e.jsx(tt,{className:"h-4 w-4 text-muted-foreground mt-1"})]},g))})})})]})},ss=()=>{const[r,s]=c.useState(null),[t,i]=c.useState(!1),[m,n]=c.useState(null);return{userLocation:r,isTracking:t,error:m,startTracking:()=>{if(!navigator.geolocation){const j="Geolocation is not supported by this browser";n(j),_.error(j);return}i(!0),n(null);const g={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4},N=navigator.geolocation.watchPosition(j=>{const u={latitude:j.coords.latitude,longitude:j.coords.longitude,accuracy:j.coords.accuracy};s(u),n(null)},j=>{let u="Failed to get location";switch(j.code){case j.PERMISSION_DENIED:u="Location access denied. Please enable location permissions.";break;case j.POSITION_UNAVAILABLE:u="Location information is unavailable.";break;case j.TIMEOUT:u="Location request timed out.";break}n(u),_.error(u),i(!1)},g);return()=>{navigator.geolocation.clearWatch(N),i(!1)}},stopTracking:()=>{i(!1),s(null),n(null)},getCurrentLocation:()=>new Promise((g,N)=>{if(!navigator.geolocation){N(new Error("Geolocation is not supported"));return}navigator.geolocation.getCurrentPosition(j=>{const u={latitude:j.coords.latitude,longitude:j.coords.longitude,accuracy:j.coords.accuracy};g(u)},j=>{let u="Failed to get location";switch(j.code){case j.PERMISSION_DENIED:u="Location access denied";break;case j.POSITION_UNAVAILABLE:u="Location information unavailable";break;case j.TIMEOUT:u="Location request timed out";break}N(new Error(u))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}},oe=class oe{constructor(){ae(this,"mapboxToken",null)}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}async initialize(){try{return this.mapboxToken=await Ue(),!!this.mapboxToken}catch(s){return console.error("Failed to initialize navigation service:",s),_.error("Navigation service unavailable"),!1}}async getRoute(s){if(!this.mapboxToken&&(await this.initialize(),!this.mapboxToken))throw new Error("Navigation service not initialized");const{origin:t,destination:i,profile:m="driving"}=s;try{const n=await fetch(`https://api.mapbox.com/directions/v5/mapbox/${m}/${t.longitude},${t.latitude};${i.longitude},${i.latitude}?steps=true&geometries=geojson&overview=full&access_token=${this.mapboxToken}`),d=await n.json();if(!n.ok)throw new Error(d.message||"Failed to get route");if(!d.routes||d.routes.length===0)throw new Error("No route found");const p=d.routes[0];return{geometry:p.geometry,distance:p.distance,duration:p.duration,steps:p.legs[0].steps.map(a=>({instruction:a.maneuver.instruction,distance:a.distance,duration:a.duration,maneuver:a.maneuver.type,road_name:a.name,geometry:a.geometry}))}}catch(n){return console.error("Error fetching route:",n),_.error("Unable to calculate route"),null}}async getDirections(s,t){const i=await this.getRoute({origin:s,destination:t});return(i==null?void 0:i.steps)||[]}calculateDistance(s,t,i,m){const d=s*Math.PI/180,p=i*Math.PI/180,a=(i-s)*Math.PI/180,g=(m-t)*Math.PI/180,N=Math.sin(a/2)*Math.sin(a/2)+Math.cos(d)*Math.cos(p)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(N),Math.sqrt(1-N)))}formatDistance(s){return s<1e3?`${Math.round(s)}m`:`${(s/1e3).toFixed(1)}km`}formatDuration(s){const t=Math.floor(s/60);if(t<1)return"< 1 min";if(t<60)return`${t} min`;const i=Math.floor(t/60),m=t%60;return`${i}h ${m}m`}};ae(oe,"instance");let we=oe;const Me=we.getInstance(),rs=({handoverSessionId:r,destinationLocation:s,otherUserName:t,isHost:i,onStepComplete:m,onNavigationStart:n})=>{const{userLocation:d,getCurrentLocation:p}=ss(),[a,g]=c.useState(!1),[N,j]=c.useState(!1),[u,R]=c.useState([]),[o,f]=c.useState(0),[h,v]=c.useState(0),[y,F]=c.useState(0),[k,A]=c.useState(!1),[w]=c.useState(50),[H,U]=c.useState(!1),[V,P]=c.useState(null),[M,T]=c.useState(!1);c.useEffect(()=>{(async()=>{const l=await Me.initialize();U(l)})()},[]);const I=(x,l,E,K)=>{const G=x*Math.PI/180,Y=E*Math.PI/180,ie=(E-x)*Math.PI/180,le=(K-l)*Math.PI/180,ue=Math.sin(ie/2)*Math.sin(ie/2)+Math.cos(G)*Math.cos(Y)*Math.sin(le/2)*Math.sin(le/2);return 6371e3*(2*Math.atan2(Math.sqrt(ue),Math.sqrt(1-ue)))};c.useEffect(()=>{if(!d||!a||N)return;if(I(d.latitude,d.longitude,s.latitude,s.longitude)<=w&&(j(!0),g(!1),_.success("You have arrived at the handover location!"),k&&"speechSynthesis"in window)){const l=new SpeechSynthesisUtterance("You have arrived at your destination");speechSynthesis.speak(l)}},[d,s,a,N,w,k]);const q=async()=>{let x=d;if(!x)try{x=await p(),P(null)}catch{return P("Unable to access your location. Please check your GPS settings."),T(!0),!1}if(!H)return P("Navigation service is not available."),T(!0),!1;try{const l=await Me.getRoute({origin:x,destination:s});if(l)return v(l.distance),F(l.duration),R(l.steps),!0;throw new Error("No route found")}catch(l){return console.error("Error fetching route:",l),P("Unable to calculate route."),T(!0),!1}},J=async()=>{await q()&&(g(!0),f(0),n==null||n(),_.success("Navigation started"))},Z=()=>{j(!0),_.success("You've arrived at the handover location!")},re=()=>{g(!1),f(0),_.info("Navigation stopped")},ne=()=>{A(!k),_.info(k?"Voice guidance disabled":"Voice guidance enabled")},S=()=>{m(),_.success("Ready to begin handover process")},W=()=>{j(!0),g(!1),_.success("Marked as arrived - ready for handover!")},C=u[o]||null,b=N?100:o/Math.max(u.length-1,1)*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(B,{children:[e.jsx(te,{children:e.jsxs(se,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"Navigate to Handover Location"]})}),e.jsxs(O,{className:"space-y-4",children:[!a&&!N&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(L,{onClick:J,size:"lg",className:"w-full",disabled:!H,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Start Navigation"]}),e.jsxs(L,{onClick:()=>T(!0),variant:"outline",size:"lg",className:"w-full",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"I've Already Arrived"]}),!H&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx(ge,{className:"h-4 w-4 inline mr-1"}),"Loading navigation service..."]})]}),V&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ge,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Location Access Issue"}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:V})]})]})}),M&&!N&&e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"Alternative Options"}),e.jsx("p",{className:"text-sm text-blue-700 mb-3",children:"If you're unable to use GPS navigation, you can still proceed:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(L,{onClick:Z,size:"lg",className:"w-full",variant:"default",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"I've Arrived at Location"]}),e.jsx(L,{onClick:()=>{T(!1),P(null)},size:"sm",variant:"ghost",className:"w-full",children:"Try Navigation Again"})]})]})}),(a||N)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Be,{className:"h-4 w-4"}),"Navigation Progress"]}),e.jsxs("span",{children:[Math.round(b),"%"]})]}),e.jsx(ye,{value:b,className:"h-2"})]}),N&&e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx(ee,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-green-800 font-medium",children:"You've arrived at the handover location!"}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:i?"Wait for the renter to arrive":"Look for the host and their vehicle"})]}),e.jsxs(L,{onClick:S,size:"lg",className:"w-full",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"I'm Ready for Handover"]})]})]})]}),a&&C&&e.jsx(es,{currentStep:C,totalDistance:h,totalDuration:y,isNavigating:a,onToggleVoice:ne,isVoiceEnabled:k,onStopNavigation:re,onArrived:W,destination:s.address,showArrivedButton:!0}),a&&u.length>0&&e.jsx(ts,{steps:u,currentStepIndex:o,onStepClick:x=>f(x)})]})},as=({isHost:r,onClose:s,duration:t=3e3})=>{const[i,m]=c.useState(!0);c.useEffect(()=>{console.log("HandoverSuccessPopup mounted with duration:",t);const d=setTimeout(()=>{console.log("HandoverSuccessPopup timer fired, setting invisible"),m(!1),setTimeout(()=>{console.log("HandoverSuccessPopup calling onClose"),s()},300)},t);return()=>{console.log("HandoverSuccessPopup cleanup"),clearTimeout(d)}},[t,s]);const n=r?"See you soon!":"Have a nice trip!";return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsx(B,{className:`
          bg-white/95 backdrop-blur-sm shadow-2xl border-2 border-primary/20 
          p-6 rounded-2xl transition-all duration-300 transform
          ${i?"scale-100 opacity-100":"scale-95 opacity-0"}
        `,children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(qe,{className:"h-8 w-8 text-primary"}),e.jsx(ee,{className:"h-4 w-4 text-green-500 absolute -top-1 -right-1 bg-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-1",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:n})]})]})})})},Oe=r=>{const[s,t]=c.useState(null),[i,m]=c.useState(!0),[n,d]=c.useState(null),p=async()=>{if(!r){m(!1);return}try{m(!0);const{data:a,error:g}=await $.rpc("calculate_handover_progress",{handover_session_id_param:r});if(g)throw g;t(a&&typeof a=="object"?a:null),d(null)}catch(a){console.error("Error fetching handover progress:",a),d("Failed to load handover progress")}finally{m(!1)}};return c.useEffect(()=>{p()},[r]),c.useEffect(()=>{if(!r)return;console.log("Setting up real-time subscription for handover:",r);const a=$.channel(`handover_progress_${r}`).on("postgres_changes",{event:"*",schema:"public",table:"handover_step_completion",filter:`handover_session_id=eq.${r}`},async g=>{var N,j;if(console.log("Handover step completion changed:",g),await p(),g.eventType==="UPDATE"&&((N=g.new)!=null&&N.is_completed)){const u=(j=g.new.step_name)==null?void 0:j.replace(/_/g," ");_.success(`${u} completed!`)}}).on("postgres_changes",{event:"*",schema:"public",table:"handover_sessions",filter:`id=eq.${r}`},g=>{var N;console.log("Handover session changed:",g),g.eventType==="UPDATE"&&((N=g.new)!=null&&N.handover_completed)&&_.success("Handover process completed successfully!")}).subscribe(g=>{console.log("Real-time subscription status:",g),g==="SUBSCRIBED"?console.log("Successfully subscribed to handover updates"):g==="CHANNEL_ERROR"&&(console.error("Failed to subscribe to handover updates"),d("Real-time updates unavailable"))});return()=>{console.log("Cleaning up handover real-time subscription"),$.removeChannel(a)}},[r]),{handoverProgress:s,isLoading:i,error:n}},os=({handoverSessionId:r,showDetailed:s=!1})=>{const{handoverProgress:t,isLoading:i,error:m}=Oe(r);if(i)return e.jsx(B,{className:"w-full",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(bt,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading progress..."})]})})});if(m||!t)return e.jsx(B,{className:"w-full",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-destructive",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:m||"Unable to load progress"})]})})});const n=()=>t.is_completed?e.jsx(ee,{className:"h-5 w-5 text-green-600"}):e.jsx(be,{className:"h-5 w-5 text-blue-600"}),d=()=>t.is_completed?"Handover Complete":`Step ${t.current_step} of ${t.total_steps}`;return s?e.jsxs(B,{className:"w-full",children:[e.jsx(te,{className:"pb-3",children:e.jsxs(se,{className:"flex items-center space-x-2",children:[n(),e.jsx("span",{children:"Handover Progress"})]})}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:d()}),e.jsxs(X,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]}),e.jsx(ye,{value:t.progress_percentage,className:"h-3"})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:[t.completed_steps," completed"]}),e.jsxs("span",{children:[t.total_steps-t.completed_steps," remaining"]})]}),t.is_completed&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"All handover steps completed successfully!"})]})})]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[n(),e.jsx("div",{className:"flex-1",children:e.jsx(ye,{value:t.progress_percentage,className:"h-2"})}),e.jsxs(X,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]})},ns=({isOpen:r,onClose:s,bookingId:t})=>{var re,ne;const i=Re(),{isLoading:m,isHandoverSessionLoading:n,isHost:d,bookingDetails:p,handoverId:a,currentUserId:g}=Le();Oe(a);const[N,j]=c.useState(0),[u,R]=c.useState([]),[o,f]=c.useState([]),[h,v]=c.useState([]),[y,F]=c.useState(),[k,A]=c.useState(),[w,H]=c.useState(),[U,V]=c.useState(!1),P=c.useCallback(async()=>{if(!a){console.error("Cannot initialize handover: missing handover session ID"),_.error("Handover session not found");return}console.log("Initializing handover for session:",a);try{await zt(a);const S=await Pe(a);console.log("Loaded handover steps:",S),console.log("Steps completion status:",S.map(x=>({name:x.step_name,completed:x.is_completed}))),R(S);const W=S.findIndex(x=>!x.is_completed),C=W>=0?W:S.length;console.log("First incomplete step index:",W),console.log("Setting current step to:",C),j(C);const b=S.filter(x=>x.is_completed).length;b>0&&_.success(`Continuing handover process - ${b}/${S.length} steps completed`),console.log("Handover initialized successfully")}catch(S){console.error("Error initializing handover:",S),_.error("Failed to initialize handover process")}},[a]);c.useEffect(()=>{a&&r&&!n&&P()},[a,r,n,P]);const M=async(S,W)=>{if(!a){_.error("Handover session not found");return}if(console.log(`Attempting to complete step: ${S}`),await Bt(a,S,W)){const b=await Pe(a);R(b);const x=b.findIndex(l=>!l.is_completed);x>=0?(j(x),console.log(`Moving to next step: ${x}`)):(console.log("All steps completed, checking if handover should be finalized"),b.every(E=>E.is_completed)&&await T())}},T=async()=>{console.log("Starting handover completion...");try{if(a&&(console.log("Completing handover session:",a),await st(a)),o.length>0||h.length>0||y!==void 0||k!==void 0){console.log("Creating vehicle condition report...");const S={handover_session_id:a,booking_id:(p==null?void 0:p.id)||"",car_id:(p==null?void 0:p.car_id)||"",report_type:"pickup",vehicle_photos:o,damage_reports:h,fuel_level:y,mileage:k,digital_signature_data:w,is_acknowledged:!0,reporter_id:g};if(!await Wt(S))throw new Error("Failed to create vehicle condition report");console.log("Vehicle condition report created successfully")}console.log("Setting handover completed to true, isHost:",d),V(!0)}catch(S){console.error("Error completing handover:",S),_.error("Failed to complete handover. Please try again.")}},I=()=>{console.log("Success popup closing, isHost:",d),V(!1);const S=new URL(window.location.href);S.searchParams.delete("mode"),S.searchParams.delete("bookingId"),window.history.replaceState({},"",S.pathname+S.search),s(),d?(console.log("Navigating to host-bookings"),i("/host-bookings")):(console.log("Navigating to renter-bookings"),i("/renter-bookings"))},q=S=>{switch(S){case"navigation":return!0;case"identity_verification":return!0;case"vehicle_inspection_exterior":return o.filter(C=>C.type&&C.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return o.filter(C=>C.type&&(C.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(C.type))).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return y!==void 0&&k!==void 0;case"key_transfer":return!0;case"digital_signature":return w!==void 0;default:return!0}},J=(S,W)=>{var x,l,E,K;const C=p,b=d?C==null?void 0:C.renter:(x=C==null?void 0:C.cars)==null?void 0:x.owner;switch(S.name){case"navigation":{const D={latitude:(C==null?void 0:C.latitude)||((l=C==null?void 0:C.cars)==null?void 0:l.latitude)||-24.65451,longitude:(C==null?void 0:C.longitude)||((E=C==null?void 0:C.cars)==null?void 0:E.longitude)||25.90859,address:((K=C==null?void 0:C.cars)==null?void 0:K.location)||"Handover Location"};return e.jsx(rs,{handoverSessionId:a||"",destinationLocation:D,otherUserName:(b==null?void 0:b.full_name)||"User",isHost:d,onStepComplete:()=>M(S.name),onNavigationStart:()=>_.info("Navigation started. Follow the directions to reach the handover location.")})}case"identity_verification":return e.jsx(Gt,{handoverSessionId:a||"",otherUserId:(b==null?void 0:b.id)||"",otherUserName:(b==null?void 0:b.full_name)||"User",isHost:d,onStepComplete:()=>M(S.name)});case"vehicle_inspection_exterior":return o.filter(D=>D.type.startsWith("exterior_")),e.jsx(Ie,{handoverSessionId:a||"",inspectionType:"exterior",onPhotosUpdate:D=>{const G=o.filter(Y=>Y.type&&!Y.type.startsWith("exterior_"));f([...G,...D])},onStepComplete:()=>M(S.name),initialPhotos:o.filter(D=>D.type&&D.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return o.filter(D=>D.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(D.type)),e.jsx(Ie,{handoverSessionId:a||"",inspectionType:"interior",onPhotosUpdate:D=>{const G=o.filter(Y=>Y.type&&!Y.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(Y.type));f([...G,...D])},onStepComplete:()=>M(S.name),initialPhotos:o.filter(D=>D.type&&(D.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(D.type)))});case"damage_documentation":return e.jsx(Xt,{handoverSessionId:a||"",onDamageReportsUpdate:v,onStepComplete:()=>M(S.name),initialReports:h});case"fuel_mileage_check":return e.jsx(Qt,{handoverSessionId:a||"",onFuelLevelChange:F,onMileageChange:A,onStepComplete:()=>M(S.name,{fuel_level:y,mileage:k}),initialFuelLevel:y,initialMileage:k});case"key_transfer":return e.jsx(Jt,{handoverSessionId:a||"",otherUserName:(b==null?void 0:b.full_name)||"User",isHost:d,onStepComplete:()=>M(S.name)});case"digital_signature":return e.jsx(Zt,{handoverSessionId:a||"",onSignatureComplete:D=>{H(D),M(S.name,{signature:D})},initialSignature:w});default:return e.jsx(B,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:S.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:S.description}),e.jsxs(L,{onClick:()=>M(S.name),disabled:!q(S.name),children:["Complete ",S.title]})]})})})}};if(m||n)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(B,{className:"w-96",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:n?"Setting up handover session...":"Loading handover process..."})]})})})});if(!a&&!n)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(B,{className:"w-96",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ge,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Session Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load the handover session. Please try refreshing the page."}),e.jsx(L,{onClick:s,variant:"outline",children:"Close"})]})})})});u.filter(S=>S.is_completed).length/me.length*100;const Z=me[N];return e.jsxs(e.Fragment,{children:[U&&e.jsxs(e.Fragment,{children:[console.log("Rendering HandoverSuccessPopup with isHost:",d),e.jsx(as,{isHost:d,onClose:I})]}),e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:r?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:s}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[90vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(re=p==null?void 0:p.cars)==null?void 0:re.brand," ",(ne=p==null?void 0:p.cars)==null?void 0:ne.model]})]}),e.jsx("button",{onClick:s,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(he,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(os,{handoverSessionId:a,showDetailed:!1})}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:me.map((S,W)=>{const C=u.find(l=>l.step_name===S.name),b=(C==null?void 0:C.is_completed)||!1,x=W===N;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${b?"bg-green-50 border-green-200 text-green-800":x?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:b?e.jsx(ee,{className:"h-4 w-4"}):x?e.jsx(be,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:S.title})]},S.name)})})}),Z?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(X,{variant:"outline",children:["Step ",N+1]}),e.jsx("span",{className:"font-medium",children:Z.title})]}),J(Z)]}):e.jsx(B,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})]})},is=({onBookingClick:r})=>{const{userId:s,userRole:t}=_t(),{data:i=[]}=Ge({queryKey:["handover-bookings",s,t],queryFn:async()=>{try{if(!s||!t)return console.log("HandoverBookingButtons: No userId or userRole"),[];const n=new Date,d=new Date().toISOString().split("T")[0],p=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];console.log("HandoverBookingButtons: Fetching bookings",{userId:s,userRole:t,today:d,tomorrow:p});let a=$.from("bookings").select(`
            *,
            cars (
              brand,
              model,
              location,
              image_url,
              owner_id,
              price_per_day
            ),
            renter:profiles!renter_id (
              id,
              full_name,
              avatar_url,
              phone_number
            ),
            handover_sessions (
              id,
              handover_completed,
              created_at
            )
          `).eq("status","confirmed").or(`start_date.eq.${d},start_date.eq.${p},end_date.eq.${d}`);t==="renter"?a=a.eq("renter_id",s):t==="host"&&(a=a.eq("cars.owner_id",s));const{data:g,error:N}=await a;if(N)throw console.error("HandoverBookingButtons: Error fetching bookings:",N),new Error(`Failed to fetch handover bookings: ${N.message}`);if(!g)return console.log("HandoverBookingButtons: No data returned"),[];console.log("HandoverBookingButtons: Raw bookings data",g);const j=g.filter(u=>{var k;const R=new Date(u.start_date),o=new Date(u.end_date),f=(k=u.handover_sessions)==null?void 0:k[0];if(f!=null&&f.handover_completed)return!1;const v=R.toDateString()===n.toDateString()&&!f,F=o.toDateString()===n.toDateString()&&f&&!f.handover_completed;return v||F});return console.log("HandoverBookingButtons: Filtered bookings",j),j}catch(n){return console.error("HandoverBookingButtons: Query failed:",n),[]}},enabled:!!s&&!!t,refetchInterval:3e4,retry:(n,d)=>(console.warn("HandoverBookingButtons: Query failed, retry attempt",{failureCount:n,error:d}),n<2),retryDelay:n=>Math.min(1e3*2**n,3e4)}),m=({booking:n,index:d})=>{var f,h,v,y,F,k,A;const p=((f=n.cars)==null?void 0:f.image_url)||"/placeholder.svg",a=new Date,g=new Date(n.start_date),N=new Date(n.end_date),j=(h=n.handover_sessions)==null?void 0:h[0],u=g.toDateString()===a.toDateString(),R=N.toDateString()===a.toDateString();let o="pickup";return R&&j&&!j.handover_completed?o="return":u&&!j&&(o="pickup"),e.jsx(rt,{children:e.jsxs(at,{children:[e.jsx(ot,{asChild:!0,children:e.jsx("button",{onClick:w=>{w.preventDefault(),console.log("Handover button clicked for booking:",n.id,"type:",o),r(n.id,o)},className:`
                w-16 h-16 rounded-full border-4 border-primary/30 
                overflow-hidden shadow-lg hover:shadow-xl
                transition-all duration-300 hover:scale-110
                animate-pulse bg-background
                mb-3
              `,style:{animationDuration:`${2+d*.5}s`},children:e.jsx("img",{src:p,alt:`${(v=n.cars)==null?void 0:v.brand} ${(y=n.cars)==null?void 0:y.model}`,className:"w-full h-full object-cover",onError:w=>{w.currentTarget.src="/placeholder.svg"}})})}),e.jsx(nt,{side:"right",className:"max-w-xs p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-sm",children:[(F=n.cars)==null?void 0:F.brand," ",(k=n.cars)==null?void 0:k.model]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(kt,{className:"h-3 w-3 mr-1"}),Ee(new Date(n.start_date),"MMM dd")," - ",Ee(new Date(n.end_date),"MMM dd")]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(fe,{className:"h-3 w-3 mr-1"}),(A=n.cars)==null?void 0:A.location]}),t==="host"&&n.renter&&e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(Ve,{className:"h-3 w-3 mr-1"}),n.renter.full_name]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(St,{className:"h-3 w-3 mr-1"}),"BWP ",n.total_price]}),e.jsx("div",{className:"text-xs text-primary font-medium mt-2",children:"Click for handover details"})]})})]})},n.id)};return i.length?(console.log("Rendering handover buttons for bookings:",i.map(n=>n.id)),e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col",children:i.map((n,d)=>e.jsx(m,{booking:n,index:d},n.id))})):(console.log("No handover bookings found for user:",s,"role:",t),null)};class ls extends c.Component{constructor(){super(...arguments);ae(this,"maxRetries",3);ae(this,"state",{hasError:!1,error:null,errorInfo:null,retryCount:0});ae(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries?(this.setState(t=>({hasError:!1,error:null,errorInfo:null,retryCount:t.retryCount+1})),_.info("Retrying handover process...")):_.error("Maximum retry attempts reached. Please refresh the page.")});ae(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,retryCount:0})});ae(this,"handleNavigateHome",()=>{const t=new URL(window.location.href);t.searchParams.delete("mode"),t.searchParams.delete("bookingId"),window.history.replaceState({},"",t.pathname),window.location.href="/"})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,i){console.error("HandoverErrorBoundary caught an error:",t,i),this.setState({errorInfo:i}),this.props.onError&&this.props.onError(t,i);const m={error:t.message,stack:t.stack,componentStack:i.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent};console.error("Handover Error Report:",m),_.error("A handover system error occurred. Please try again.")}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const i=this.state.retryCount<this.maxRetries,m=((t=this.state.error)==null?void 0:t.message)||"An unexpected error occurred";return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs(it,{className:"max-w-md",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsxs(lt,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Handover System Error"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:m}),this.state.retryCount>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Retry attempt: ",this.state.retryCount,"/",this.maxRetries]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[i&&e.jsxs(L,{onClick:this.handleRetry,className:"w-full",variant:"outline",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Retry Handover"]}),e.jsxs(L,{onClick:this.handleReset,className:"w-full",variant:"outline",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Reset Process"]}),e.jsxs(L,{onClick:this.handleNavigateHome,className:"w-full",variant:"secondary",children:[e.jsx(Ct,{className:"mr-2 h-4 w-4"}),"Return to Dashboard"]})]}),!1]})]})})}return this.props.children}}const Ks=()=>{const[r]=Xe(),s=r.get("mode"),t=r.get("bookingId"),{user:i}=ct(),[m,n]=c.useState(""),[d,p]=c.useState(!0),[a,g]=c.useState([]),[N,j]=c.useState(!1),[u]=c.useState({latitude:null,longitude:null}),{theme:R}=dt(),[o,f]=c.useState(!1),[h,v]=c.useState(!1),[y]=c.useState(null),F=async P=>{var M;try{const{data:T,error:I}=await $.from("bookings").select(`
          id, 
          status, 
          start_date, 
          end_date, 
          renter_id,
          cars!inner (
            owner_id
          )
        `).eq("id",P).eq("status","confirmed").single();if(I||!T)return console.log("Booking not found or not confirmed:",P),!1;const q=(M=T.cars)==null?void 0:M.owner_id;if(!i||i.id!==T.renter_id&&i.id!==q)return console.log("User does not have permission to access booking:",P),!1;const J=new Date().toISOString().split("T")[0],Z=T.start_date===J,re=T.end_date===J;return!Z&&!re?(console.log("Booking is not eligible for handover today:",P),!1):!0}catch(T){return console.error("Error validating booking:",T),!1}};c.useEffect(()=>{(async()=>{if(!(s==="handover"&&t)){f(!1);return}if(!i)return;if(v(!0),await F(t))f(!0);else{const I=new URL(window.location.href);I.searchParams.delete("mode"),I.searchParams.delete("bookingId"),window.history.replaceState({},"",I.pathname+I.search),_.info("Invalid handover request - showing standard map"),f(!1)}v(!1)})()},[s,t,i]),c.useEffect(()=>{o&&!N&&j(!0)},[o]),c.useEffect(()=>{(async()=>{p(!0);try{const M=await Ue();if(!M){_.error("Failed to get the map token"),console.error("Failed to get the map token");return}n(M)}catch(M){console.error("Error getting the map token:",M),_.error("Failed to get the map token")}finally{p(!1)}})()},[]);const k=async()=>{var P,M;if(!i)return null;try{const{data:T,error:I}=await $.from("handover_sessions").select(`
          host_id,
          host_location,
          bookings!inner(
            car_id,
            cars!inner(
              owner_id,
              profiles!owner_id(id, full_name, avatar_url, latitude, longitude)
            )
          )
        `).eq("renter_id",i.id).eq("handover_completed",!1).single();if(I||!T)return console.log("No active handover session found"),null;const q=(M=(P=T.bookings)==null?void 0:P.cars)==null?void 0:M.profiles;if(q!=null&&q.latitude&&(q!=null&&q.longitude))return{id:q.id,full_name:q.full_name,avatar_url:q.avatar_url,latitude:q.latitude,longitude:q.longitude,updated_at:null,isActiveHandover:!0}}catch(T){console.error("Error fetching active handover host:",T)}return null},A=async()=>{console.log("Fetching host locations...");try{const P=await qt();console.log("Online hosts fetched:",P);const M=await k();console.log("Active handover host:",M);const T=[...P];if(M){const I=T.findIndex(q=>q.id===M.id);I>=0?T[I]=M:T.push(M)}T.length||_.info("No hosts are currently online"),console.log("All host locations to display:",T),g(T)}catch(P){console.error("Error fetching host locations:",P),_.error("Failed to fetch host locations")}};c.useEffect(()=>{o||(A(),console.log("Location",u))},[o]);const w=()=>R==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",H=()=>d||h?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:h?"Validating handover...":"Loading map..."}),e.jsx(ht,{color:"#7c3aed",width:100})]}):m?e.jsx(Ft,{mapbox_token:m,longitude:25.90859,latitude:-24.65451,onlineHosts:o?[]:a,mapStyle:w(),isHandoverMode:o,bookingId:t,dpad:!0,locationToggle:!0,destination:u}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]}),U=!!i&&o,V=e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("main",{className:"flex-1 relative overflow-hidden",children:[H(),U&&e.jsxs(ls,{children:[e.jsx(is,{onBookingClick:(P,M)=>{if(console.log("Map received booking click for:",P,"type:",M),console.log("Current booking ID from URL:",t),console.log("Current handover sheet state:",N),M==="return"){window.location.href=`/rental-details/${P}`;return}P!==t&&(console.log("Updating URL with new booking ID"),window.history.replaceState({},"",`/map?mode=handover&bookingId=${P}`)),console.log("Opening handover sheet"),j(!0)}}),e.jsx(ns,{isOpen:N,onClose:()=>{j(!1);const P=new URL(window.location.href);P.searchParams.delete("mode"),P.searchParams.delete("bookingId"),window.history.replaceState({},"",P.pathname+P.search)},bookingId:t||""})]})]}),e.jsx(Qe,{})]});return e.jsx(ut,{children:U?e.jsx(mt,{children:V}):V})};export{Ks as default};
