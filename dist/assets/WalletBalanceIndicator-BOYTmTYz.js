import{u as x,j as e}from"./query-vendor-BOSMW7hd.js";import{s as u,J as h,n as _,B as j,z as y,Y as F,T as B}from"./index-ByqmTec-.js";import{T as C,w as P}from"./TopUpModal-BpSgFFFs.js";import{C as E,d as k}from"./card-Dn1_7TKZ.js";import{r as R}from"./react-vendor-DmU5vXC9.js";import{W as b}from"./wallet-BBXAdpKD.js";const p=async()=>{try{console.log("CommissionRates: Fetching current commission rate");const{data:s,error:t}=await u.from("commission_rates").select("rate").lte("effective_from",new Date().toISOString()).or("effective_until.is.null,effective_until.gt."+new Date().toISOString()).order("effective_from",{ascending:!1}).limit(1).single();return t?(console.error("CommissionRates: Error fetching commission rate:",t),.15):(console.log("CommissionRates: Commission rate fetched:",s.rate),s.rate)}catch(s){return console.error("CommissionRates: Unexpected error fetching commission rate:",s),.15}},g=(s,t)=>{const n=Math.round(s*t*100)/100,i=s-n;return{bookingTotal:s,commissionRate:t,commissionAmount:n,hostReceives:i}},v=async(s,t)=>{try{console.log("WalletValidation: Checking if host can accept booking",{hostId:s,bookingTotal:t});const n=await p(),i=g(t,n),{data:c,error:o}=await u.from("host_wallets").select("balance").eq("host_id",s).single();if(o)return console.error("WalletValidation: Error fetching wallet:",o),{canAccept:!1,commissionAmount:i.commissionAmount,currentBalance:0,message:"Wallet not found. Please contact support."};const l=c.balance||0,m=50,a=m+i.commissionAmount,r=l>=a;return console.log("WalletValidation: Booking acceptance check result",{canAccept:r,commissionAmount:i.commissionAmount,currentBalance:l,minimumRequired:m,totalRequired:a}),{canAccept:r,commissionAmount:i.commissionAmount,currentBalance:l,message:r?void 0:`Insufficient wallet balance. Need at least P${a.toFixed(2)} (P${m} minimum + P${i.commissionAmount.toFixed(2)} commission), have P${l.toFixed(2)}`}}catch(n){return console.error("WalletValidation: Error checking booking acceptance:",n),{canAccept:!1,commissionAmount:0,currentBalance:0,message:"Error checking wallet balance. Please try again."}}},q=async(s,t,n)=>{try{console.log("CommissionDeduction: Processing commission from wallet balance",{hostId:s,bookingId:t,bookingTotal:n});const i=await p(),c=g(n,i),o=await v(s,n);if(!o.canAccept)return console.error("CommissionDeduction: Host cannot accept booking due to insufficient funds"),h.error(o.message||"Insufficient wallet balance"),!1;const{data:l,error:m}=await u.from("host_wallets").select("id, balance").eq("host_id",s).single();if(m)return console.error("CommissionDeduction: Error fetching wallet for commission deduction:",m),!1;const a=l.balance-c.commissionAmount,{error:r}=await u.from("host_wallets").update({balance:a,updated_at:new Date().toISOString()}).eq("id",l.id);if(r)return console.error("CommissionDeduction: Error updating wallet balance:",r),!1;const{error:d}=await u.from("wallet_transactions").insert({wallet_id:l.id,booking_id:t,transaction_type:"commission_deduction",amount:-c.commissionAmount,balance_before:l.balance,balance_after:a,description:`Platform commission (${(c.commissionRate*100).toFixed(1)}%) deducted from wallet`,status:"completed",commission_rate:c.commissionRate,booking_reference:`BOOKING_${t.slice(-8)}`});d&&console.error("CommissionDeduction: Error recording commission transaction:",d);const{error:f}=await u.from("bookings").update({commission_amount:c.commissionAmount,commission_status:"deducted"}).eq("id",t);return f&&console.error("CommissionDeduction: Error updating booking commission info:",f),console.log("CommissionDeduction: Commission deducted successfully from wallet"),h.success(`Booking confirmed! Commission of P${c.commissionAmount.toFixed(2)} deducted from wallet`),!0}catch(i){return console.error("CommissionDeduction: Error processing commission:",i),h.error("Failed to process commission. Please try again."),!1}};class S{async getCurrentCommissionRate(){return p()}async calculateCommission(t){const n=await p();return g(t,n)}async checkHostCanAcceptBooking(t,n){return v(t,n)}async processCommissionOnBookingConfirmation(t,n,i){return q(t,n,i)}}const N=new S,M=({bookingTotal:s,showCommissionBreakdown:t=!1,compact:n=!1})=>{const[i,c]=R.useState(!1),{data:o}=x({queryKey:["current-user"],queryFn:async()=>{const{data:{user:A}}=await u.auth.getUser();return A}}),{data:l,refetch:m}=x({queryKey:["wallet-balance",o==null?void 0:o.id],queryFn:async()=>o!=null&&o.id?await P.getWalletBalance(o.id):null,enabled:!!(o!=null&&o.id)}),{data:a}=x({queryKey:["commission-calculation",s],queryFn:async()=>s?await N.calculateCommission(s):null,enabled:!!s}),{data:r}=x({queryKey:["booking-acceptance-check",o==null?void 0:o.id,s],queryFn:async()=>!(o!=null&&o.id)||!s?null:await N.checkHostCanAcceptBooking(o.id,s),enabled:!!(o!=null&&o.id)&&!!s}),d=(l==null?void 0:l.balance)||0;a!=null&&a.commissionAmount;const f=(r==null?void 0:r.canAccept)??!0,w=()=>{m(),c(!1)};return n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-4 w-4"}),e.jsxs("span",{className:"text-sm font-medium",children:["P",d.toFixed(2)]}),s&&!f&&e.jsx(_,{variant:"destructive",className:"text-xs",children:"Low Balance"}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>c(!0),className:"h-6 px-2 text-xs",children:e.jsx(y,{className:"h-3 w-3"})})]}),e.jsx(C,{isOpen:i,onClose:()=>c(!1),onSuccess:w,currentBalance:d})]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:`${f?"":"border-destructive bg-destructive/5"}`,children:e.jsx(k,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Wallet Balance"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("p",{className:"text-2xl font-bold",children:["P",d.toFixed(2)]}),t&&a&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-blue-50 dark:bg-blue-950 rounded-lg",children:[e.jsx(F,{className:"h-4 w-4 text-blue-600 dark:text-blue-400"}),e.jsxs("div",{className:"text-xs text-blue-700 dark:text-blue-300",children:[e.jsx("p",{className:"font-medium",children:"Commission is deducted from your wallet balance"}),e.jsxs("p",{children:["You receive the full rental earnings (P",a.bookingTotal.toFixed(2),")"]})]})]}),e.jsxs("div",{className:"space-y-1 text-sm text-muted-foreground",children:[e.jsxs("p",{children:["Booking Total: P",a.bookingTotal.toFixed(2)]}),e.jsxs("p",{children:["Commission (",(a.commissionRate*100).toFixed(1),"%): P",a.commissionAmount.toFixed(2)]}),e.jsxs("p",{className:"font-medium text-foreground",children:["You'll earn: P",a.bookingTotal.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Commission paid from wallet: P",a.commissionAmount.toFixed(2)]})]})]})]}),!f&&(r==null?void 0:r.message)&&e.jsxs("div",{className:"flex items-start gap-2 mt-2",children:[e.jsx(B,{className:"h-4 w-4 text-destructive mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-destructive",children:r.message})]})]}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>c(!0),className:"flex items-center gap-2",children:[e.jsx(y,{className:"h-4 w-4"}),"Top Up"]})]})})}),e.jsx(C,{isOpen:i,onClose:()=>c(!1),onSuccess:w,currentBalance:d})]})};export{M as W,N as c};
