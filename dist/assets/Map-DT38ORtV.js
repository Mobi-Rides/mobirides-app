var We=Object.defineProperty;var Ke=(r,s,t)=>s in r?We(r,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[s]=t;var ae=(r,s,t)=>Ke(r,typeof s!="symbol"?s+"":s,t);import{j as e,u as Ge}from"./query-vendor-BOSMW7hd.js";import{r as d,u as Re,d as Xe,h as Ye}from"./react-vendor-DmU5vXC9.js";import{N as Qe}from"./Navigation-fdodg-AN.js";import{m as z}from"./mapbox-vendor-ueN8uhVJ.js";/* empty css                  */import{c as te,B as T,q as Je,r as Ze,s as D,X as de,t as Me,n as Y,v as He,J as ne,w as _,C as ge,x as Le,y as Te,z as De,T as $e,I as Ae,f as _e,E as et,F as Ue,U as tt,G as st,H as rt,K as at,M as ot,N as nt,g as it,h as lt,R as ke,O as ct,u as dt,Q as ut,V as mt,W as ht}from"./index-ByqmTec-.js";import{A as gt}from"./arrow-right-RRvKZqjh.js";import{O as ft}from"./OnlineStatusToggle-D3TljP2l.js";import{U as Fe}from"./user-CrwdbYLY.js";import{S as fe}from"./star-Dt-lKoZi.js";import{C as O,d as W,a as se,b as re}from"./card-Dn1_7TKZ.js";import{C as Ve}from"./car-DcHPLaSp.js";import{M as le}from"./map-pin-B-9tSSOy.js";import{C as ie}from"./camera-DAu_2Lp7.js";import{U as qe}from"./upload-B2QBpx4x.js";import{S as xt,a as pt,b as vt,c as jt,d as me}from"./select-qP77FLvJ.js";import{S as yt}from"./slider-BxgBER1A.js";import{G as Nt}from"./gauge-C7Kjsj0L.js";import{C as he}from"./checkbox-D4Yx9lnD.js";import{C as ee}from"./circle-check-big-BdHHmxBu.js";import{R as wt,P as xe}from"./progress-CXS1UcDG.js";import{C as je}from"./clock-Dg92kA5o.js";import{F as bt}from"./flag-BcuAdPDn.js";import{N as Se}from"./navigation-BoaKLUi7.js";import{C as ye}from"./circle-alert-CcellCUN.js";import{L as _t}from"./loader-circle-9OeoyYcF.js";import{u as kt}from"./useAuthStatus-hqGqvzqY.js";import{C as St}from"./calendar-Cn2gPQb0.js";import{D as Ct}from"./dollar-sign-BxxqWD8M.js";import{a as Ce}from"./date-vendor-Dhms5dOu.js";import{H as Et}from"./house-BXQSFKXu.js";import"./bell-sR4KUoYm.js";import"./supabase-vendor-B3A6ooRR.js";import"./switch-BC4DIA0f.js";import"./index-CEVvJeOa.js";import"./index-Bad3wlzf.js";import"./chevron-down-CR2ALfoj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=te("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=te("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=te("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mt=te("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=te("Navigation2",[["polygon",{points:"12 2 19 21 12 17 5 21 12 2",key:"x8c0qg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=te("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=te("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=te("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=te("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);function Dt({onUp:r,onDown:s,onLeft:t,onRight:i,onReset:m}){return e.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[e.jsx("div",{className:"flex gap-1",children:e.jsx(T,{variant:"default",onClick:r,style:{height:40},children:e.jsx(It,{name:"arrow-up",size:24,color:"white"})})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(T,{variant:"default",onClick:t,style:{width:20},children:e.jsx(Je,{name:"arrow-left",size:24,color:"white"})}),e.jsx(T,{variant:"default",onClick:m,children:e.jsx(Ze,{name:"arrow-left",size:24,color:"white"})}),e.jsx(T,{variant:"default",onClick:i,style:{width:20},children:e.jsx(gt,{name:"arrow-right",size:24,color:"white"})})]}),e.jsx("div",{className:"flex gap-1",children:e.jsx(T,{variant:"default",onClick:s,style:{height:40},children:e.jsx(Pt,{name:"arrow-down",size:24,color:"white"})})})]})}const $t=({host:r,onViewCars:s})=>{const t=()=>r.avatar_url?D.storage.from("avatars").getPublicUrl(r.avatar_url).data.publicUrl:"/placeholder.svg";return e.jsx("div",{className:"bg-background border rounded-lg shadow-lg p-3 min-w-[200px] cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>s(r.id),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex items-center justify-center",children:r.avatar_url?e.jsx("img",{src:t(),alt:r.full_name||"Host",className:"w-full h-full object-cover"}):e.jsx(Fe,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:r.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(fe,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32)"})]}),e.jsx("p",{className:"text-xs text-primary mt-1",children:"View available cars →"})]})]})})},At=({isOpen:r,onClose:s,host:t})=>{const[i,m]=d.useState([]),[n,l]=d.useState(!1),c=Re();d.useEffect(()=>{r&&(t!=null&&t.id)&&a(t.id)},[r,t==null?void 0:t.id]);const a=async u=>{l(!0),console.log("Fetching cars for host:",u);try{console.log("Step 1: Checking if host has any cars...");const{data:I,error:o}=await D.from("cars").select("*").eq("owner_id",u);console.log("All cars for host:",I),o&&console.error("Error fetching all cars:",o),console.log("Step 2: Checking available cars...");const{data:x,error:h}=await D.from("cars").select("*").eq("owner_id",u).eq("is_available",!0);if(console.log("Available cars for host:",x),h&&console.error("Error fetching available cars:",h),x&&x.length>0){console.log("Step 3: Checking car images...");const k=x.map(R=>R.id),{data:$,error:b}=await D.from("car_images").select("*").in("car_id",k);console.log("Car images:",$),b&&console.error("Error fetching car images:",b)}console.log("Step 4: Trying with left join...");const{data:p,error:j}=await D.from("cars").select(`
          *,
          car_images(
            image_url,
            is_primary
          )
        `).eq("owner_id",u).eq("is_available",!0);if(j){console.error("Error fetching host cars with left join:",j);return}console.log("Cars with left join:",p);const A=(p==null?void 0:p.map(k=>{var b,R,F;const $=(b=k.car_images)==null?void 0:b.find(q=>q.is_primary);return{...k,image_url:($==null?void 0:$.image_url)||((F=(R=k.car_images)==null?void 0:R[0])==null?void 0:F.image_url)||k.image_url}}))||[];console.log("Transformed cars:",A),m(A)}catch(I){console.error("Error in fetchHostCars:",I)}finally{l(!1)}},g=u=>u?D.storage.from("car-images").getPublicUrl(u).data.publicUrl:"/placeholder.svg",N=()=>t!=null&&t.avatar_url?D.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",v=u=>{c(`/car/${u}`),s()};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:s}),e.jsx("div",{className:"fixed left-0 top-0 h-full w-80 bg-background border-r shadow-xl z-50 transform transition-transform duration-300",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Host's Cars"}),e.jsx(T,{variant:"ghost",size:"sm",onClick:s,children:e.jsx(de,{className:"w-4 h-4"})})]}),t&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:N(),alt:t.full_name||"Host",className:"w-10 h-10 rounded-full object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32 reviews)"})]})]})]})]}),e.jsx(Me,{className:"flex-1",children:e.jsx("div",{className:"p-4 space-y-4",children:n?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."})}):i.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ve,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No available cars"})]}):i.map(u=>e.jsx(O,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>v(u.id),children:e.jsxs(W,{className:"p-3",children:[e.jsx("div",{className:"aspect-video w-full mb-3 rounded-lg overflow-hidden bg-muted",children:e.jsx("img",{src:g(u.image_url),alt:`${u.brand} ${u.model}`,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm",children:[u.brand," ",u.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u.year})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-sm",children:["P",u.price_per_day]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"per day"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(le,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:u.location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(Y,{variant:"secondary",className:"text-xs px-2 py-1",children:u.vehicle_type}),e.jsxs("span",{className:"text-muted-foreground",children:[u.seats," seats"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:u.transmission})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.5 (12)"})]})]})]})},u.id))})})]})})]}):null},Ut=({mapbox_token:r,longitude:s,latitude:t,onlineHosts:i,mapStyle:m="mapbox://styles/mapbox/streets-v12",isHandoverMode:n=!1,bookingId:l,zoom:c,interactive:a,dpad:g,locationToggle:N,destination:v,returnLocation:u})=>{const I=d.useRef(null),o=d.useRef(null),x=d.useRef(null),[h,p]=d.useState(!1),[j,A]=d.useState({latitude:t,longitude:s}),[k,$]=d.useState([]),[b,R]=d.useState([]),[F,q]=d.useState(null),[M,P]=d.useState(!1),U=He(),E=n?U:null;d.useEffect(()=>{if(!u)return;const S=j.longitude,y=j.latitude;u(S,y)},[j]),d.useEffect(()=>{if(r&&(z.accessToken=r),!o.current&&I.current&&r){o.current=new z.Map({container:I.current,style:m,center:[s,t],zoom:c||14,interactive:a||!0}),o.current.addControl(new z.NavigationControl,"top-right");const S=new z.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});o.current.addControl(S,"top-right"),x.current=S,S.on("error",y=>{console.error("Geolocation error:",y),ne.error("Unable to access your location. Please check your browser permissions."),n&&E&&ne.error("Location sharing is required for the handover process. Please enable location access.")}),o.current.on("load",()=>{console.log("Map loaded successfully"),p(!0),x.current&&x.current.on("geolocate",y=>{console.log("Geolocate event fired:",y.coords);const f={longitude:y.coords.longitude,latitude:y.coords.latitude};A(f),console.log("User location updated:",f),n&&E&&(console.log("In handover mode, updating handover location..."),V(f.latitude,f.longitude).then(C=>{console.log("Address fetched:",C),E.updateLocation({latitude:f.latitude,longitude:f.longitude,address:C||"Unknown location"})}))}),setTimeout(()=>{x.current&&x.current.trigger()},1e3)}),o.current.on("error",y=>{console.error("Map error:",y),ne.error("Error loading map. Please refresh.")}),u&&o.current.on("click",y=>{console.log("Map clicked at coordinates:",y.lngLat),u(y.lngLat.lng,y.lngLat.lat)})}return()=>{o.current&&(o.current.remove(),o.current=null)}},[r,s,t,m,n,E]);const V=async(S,y)=>{try{const C=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${y},${S}.json?access_token=${r}`)).json();return C.features&&C.features.length>0?C.features[0].place_name:null}catch(f){return console.error("Error fetching address:",f),null}};d.useEffect(()=>{o.current&&h&&o.current.setStyle(m)},[m,h]);const J=S=>{console.log("Trying to view cars for host:",S);const y=i==null?void 0:i.find(f=>f.id===S);if(console.log("Found host:",y),y){const f={id:y.id,full_name:y.full_name,avatar_url:y.avatar_url,latitude:y.latitude,longitude:y.longitude,updated_at:y.updated_at};console.log("Setting selected host:",f),q(f),P(!0)}else console.log("No host found with ID:",S)},Q=S=>{if(!o.current||!h||!j.latitude||!j.longitude)return;(async()=>{try{const C=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${j.longitude},${j.latitude};${S.longitude},${S.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(C.routes&&C.routes.length>0){const H=C.routes[0].geometry;o.current.getSource("host-route")?o.current.getSource("host-route").setData(H):(o.current.addSource("host-route",{type:"geojson",data:H}),o.current.addLayer({id:"host-route",type:"line",source:"host-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":S.isActiveHandover?"#ef4444":"#3b82f6","line-width":S.isActiveHandover?6:4}}));const G=new z.LngLatBounds().extend([j.longitude,j.latitude]).extend([S.longitude,S.latitude]);o.current.fitBounds(G,{padding:50,maxZoom:15})}}catch(f){console.error("Error fetching route to host:",f),ne.error("Unable to calculate route")}})()};d.useEffect(()=>{if(!o.current||!h||!(i!=null&&i.length))return;k.forEach(f=>f.remove()),$([]);const S=i.map(f=>{if(!f.latitude||!f.longitude)return null;const C=document.createElement("div");C.className="host-marker",C.style.width=f.isActiveHandover?"24px":"20px",C.style.height=f.isActiveHandover?"24px":"20px",C.style.borderRadius="50%",C.style.backgroundColor=f.isActiveHandover?"#ef4444":"#4ade80",C.style.border=f.isActiveHandover?"3px solid white":"2px solid white",C.style.boxShadow=f.isActiveHandover?"0 0 15px rgba(239, 68, 68, 0.5)":"0 0 10px rgba(0, 0, 0, 0.3)",C.style.cursor="pointer",f.isActiveHandover&&(C.style.animation="pulse 2s infinite");const H=document.createElement("div"),G=new z.Marker(C).setLngLat([f.longitude,f.latitude]).addTo(o.current);return C.addEventListener("mouseenter",()=>{Xe.render(e.jsx($t,{host:f,onViewCars:J}),H);const X=new z.Popup({offset:25,closeButton:!1,closeOnClick:!1,className:"host-popup"}).setDOMContent(H).addTo(o.current);G.setPopup(X),X.addTo(o.current)}),C.addEventListener("mouseleave",()=>{setTimeout(()=>{const X=G.getPopup();X&&X.remove()},100)}),C.addEventListener("click",()=>{J(f.id),o.current&&h&&(async()=>{try{const ue=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${j.longitude},${j.latitude};${f.longitude},${f.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(ue.routes&&ue.routes.length>0){const be=ue.routes[0].geometry;o.current.getSource("route")?o.current.getSource("route").setData(be):(o.current.addSource("route",{type:"geojson",data:be}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}));const Oe=new z.LngLatBounds().extend([j.longitude,j.latitude]).extend([f.longitude,f.latitude]);o.current.fitBounds(Oe,{padding:50,maxZoom:15})}}catch(we){console.error("Error fetching route to host:",we),ne.error("Unable to calculate route")}})()}),G}).filter(Boolean);$(S);const y=i==null?void 0:i.find(f=>f.isActiveHandover);y&&j.latitude&&j.longitude&&setTimeout(()=>{Q(y)},1e3)},[i,h,n,j]),d.useEffect(()=>{if(!o.current||!h||!v)return;const{latitude:S,longitude:y}=v,f=document.createElement("div");f.className="destination-marker",f.style.width="24px",f.style.height="24px",f.style.borderRadius="50%",f.style.backgroundColor="#f59e0b",f.style.border="3px solid white",f.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const C=new z.Marker(f).setLngLat([y,S]).setPopup(new z.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(o.current);return()=>{C.remove()}}),d.useEffect(()=>{if(!o.current||!h||!v)return;const{latitude:S,longitude:y}=v;return(async()=>{try{const H=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${j.longitude},${j.latitude};${y},${S}?geometries=geojson&access_token=${z.accessToken}`)).json();if(H.routes&&H.routes.length>0){const G=H.routes[0].geometry;o.current.getSource("route")?o.current.getSource("route").setData(G):(o.current.addSource("route",{type:"geojson",data:G}),o.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(C){console.error("Error fetching route:",C)}})(),()=>{o.current&&(o.current.getStyle()&&o.current.getLayer("route")&&o.current.removeLayer("route"),o.current.getStyle()&&o.current.getSource("route")&&o.current.removeSource("route"))}},[h,v,j]),d.useEffect(()=>{if(!o.current||!h||!n||!(E!=null&&E.handoverStatus))return;b.forEach(y=>y.remove()),R([]);const S=[];if(E.handoverStatus.host_location){const y=E.handoverStatus.host_location,f=document.createElement("div");f.className="host-handover-marker",f.style.width="24px",f.style.height="24px",f.style.borderRadius="50%",f.style.backgroundColor="#3b82f6",f.style.border="3px solid white",f.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const C=new z.Marker(f).setLngLat([y.longitude,y.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${y.address}</p>`)).addTo(o.current);S.push(C)}if(E.handoverStatus.renter_location){const y=E.handoverStatus.renter_location,f=document.createElement("div");f.className="renter-handover-marker",f.style.width="24px",f.style.height="24px",f.style.borderRadius="50%",f.style.backgroundColor="#ec4899",f.style.border="3px solid white",f.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const C=new z.Marker(f).setLngLat([y.longitude,y.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${y.address}</p>`)).addTo(o.current);S.push(C)}if(S.length===2&&o.current){const y=new z.LngLatBounds;S.forEach(f=>{y.extend(f.getLngLat())}),o.current.fitBounds(y,{padding:100,maxZoom:15})}R(S)},[E==null?void 0:E.handoverStatus,h,n]);const Z=()=>{o.current&&o.current.panBy([0,-100],{duration:500})},K=()=>{o.current&&o.current.panBy([0,100],{duration:500})},w=()=>{o.current&&o.current.panBy([-100,0],{duration:500})},B=()=>{o.current&&o.current.panBy([100,0],{duration:500})},L=()=>{o.current&&o.current.flyTo({center:[j.longitude,j.latitude],zoom:20,essential:!0})};return e.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[e.jsx("div",{ref:I,className:"w-full h-full"}),!n&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:N&&e.jsx(ft,{lat:j.latitude,long:j.longitude})})}),n&&(E==null?void 0:E.handoverStatus)&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm font-medium",children:[E.isHost?"Host":"Renter"," Mode"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:E.handoverStatus.host_location&&E.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),g&&e.jsx(Dt,{onUp:Z,onDown:K,onLeft:w,onRight:B,onReset:L}),e.jsx(At,{isOpen:M,onClose:()=>P(!1),host:F})]})},Ft=async()=>{try{const{data:r,error:s}=await D.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(s)return console.error("Error checking location columns:",s),!1;if(!r||r.length===0)return console.error("No profiles found to check columns"),!1;const t=r[0];return t?"latitude"in t&&"longitude"in t&&"is_sharing_location"in t:!1}catch(r){return console.error("Error in checkLocationColumns:",r),!1}},Vt=r=>!r||typeof r!="object"?null:{id:typeof r.id=="string"?r.id:"",full_name:r.full_name||null,avatar_url:r.avatar_url||null,latitude:typeof r.latitude=="number"?r.latitude:null,longitude:typeof r.longitude=="number"?r.longitude:null,updated_at:r.updated_at||null},qt=async()=>{try{if(console.log("Fetching online hosts..."),!await Ft())return console.error("Required location columns don't exist in profiles table"),[];const{data:s,error:t}=await D.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(t)return console.error("Error fetching online hosts:",t),[];if(!s||!Array.isArray(s))return console.error("Expected array of hosts but got:",s),[];console.log(`Found ${s.length} online hosts`);const i=[];for(const m of s){const n=Vt(m);n&&i.push(n)}return i}catch(r){return console.error("Error in fetchOnlineHosts:",r),[]}},ce=[{name:"navigation",order:1,title:"Navigate to Location",description:"Get directions to the handover location"},{name:"identity_verification",order:2,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:3,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:4,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:5,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:6,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:7,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:8,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:9,title:"Handover Complete",description:"Finalize the handover process"}],Bt=async r=>{try{const{data:s}=await D.from("handover_step_completion").select("id").eq("handover_session_id",r);if(s&&s.length>0)return console.log("Handover steps already initialized"),!0;const t=ce.map(m=>({handover_session_id:r,step_name:m.name,step_order:m.order,is_completed:!1})),{error:i}=await D.from("handover_step_completion").insert(t);if(i)throw i;return console.log("Handover steps initialized successfully"),!0}catch(s){return console.error("Error initializing handover steps:",s),_.error("Failed to initialize handover steps"),!1}},Ee=async r=>{try{const{data:s,error:t}=await D.from("handover_step_completion").select("*").eq("handover_session_id",r).order("step_order");if(t)throw t;return s||[]}catch(s){return console.error("Error fetching handover steps:",s),[]}},zt=async(r,s,t)=>{var i;try{const{data:m}=await D.auth.getUser();if(!((i=m==null?void 0:m.user)!=null&&i.id))throw new Error("User not authenticated");const{data:n}=await D.from("handover_step_completion").select("step_order").eq("handover_session_id",r).eq("step_name",s).single();if(!n)throw new Error("Step not found");const l=await Ot(r,s,t);if(!l.isValid)return _.error(l.message),!1;const{error:c}=await D.from("handover_step_completion").update({is_completed:!0,completed_by:m.user.id,completion_data:t,completed_at:new Date().toISOString()}).eq("handover_session_id",r).eq("step_name",s);if(c){if(c.message.includes("Previous steps must be completed"))_.error("Please complete previous steps first");else throw c;return!1}return console.log(`Step ${s} completed successfully`),_.success(`${s.replace("_"," ")} completed`),!0}catch(m){return console.error("Error completing handover step:",m),m.message.includes("Previous steps must be completed")?_.error("Please complete previous steps in order"):_.error("Failed to complete handover step"),!1}},Ot=async(r,s,t)=>{switch(s){case"fuel_mileage_check":if(!(t!=null&&t.fuel_level)||!(t!=null&&t.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};if(t.fuel_level<0||t.fuel_level>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(t.mileage<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(t!=null&&t.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},Ne=async(r,s,t,i=3)=>{var n;let m=0;for(;m<i;)try{const{data:l}=await D.auth.getUser();if(!((n=l==null?void 0:l.user)!=null&&n.id))throw new Error("User not authenticated");const c=r.name.split(".").pop(),a=`${l.user.id}/${s}/${t}_${Date.now()}.${c}`,{error:g}=await D.storage.from("handover-photos").upload(a,r);if(g)throw g;const{data:{publicUrl:N}}=D.storage.from("handover-photos").getPublicUrl(a);return console.log(`Photo uploaded successfully: ${a}`),N}catch(l){if(m++,console.error(`Photo upload attempt ${m} failed:`,l),m>=i)return _.error("Failed to upload photo after multiple attempts"),null;await new Promise(c=>setTimeout(c,1e3*m))}return null},Wt=async r=>{var s;try{const{data:t}=await D.auth.getUser();if(!((s=t==null?void 0:t.user)!=null&&s.id))throw new Error("User not authenticated");const i={handover_session_id:r.handover_session_id,booking_id:r.booking_id,car_id:r.car_id,report_type:r.report_type,vehicle_photos:JSON.stringify(r.vehicle_photos),damage_reports:JSON.stringify(r.damage_reports),fuel_level:r.fuel_level,mileage:r.mileage,exterior_condition_notes:r.exterior_condition_notes,interior_condition_notes:r.interior_condition_notes,additional_notes:r.additional_notes,digital_signature_data:r.digital_signature_data,is_acknowledged:r.is_acknowledged,reporter_id:r.reporter_id||t.user.id},{data:m,error:n}=await D.from("vehicle_condition_reports").insert(i).select().single();if(n)throw n;return console.log("Vehicle condition report created successfully"),m}catch(t){return console.error("Error creating vehicle condition report:",t),_.error("Failed to create condition report"),null}},Kt=async r=>{var s;try{const{data:t}=await D.auth.getUser();if(!((s=t==null?void 0:t.user)!=null&&s.id))throw new Error("User not authenticated");const i={handover_session_id:r.handover_session_id,verifier_id:t.user.id,verified_user_id:r.verified_user_id,verification_photo_url:r.verification_photo_url,license_photo_url:r.license_photo_url,verification_status:r.verification_status,verification_notes:r.verification_notes},{data:m,error:n}=await D.from("identity_verification_checks").insert(i).select().single();if(n)throw n;return m}catch(t){return console.error("Error creating identity verification check:",t),_.error("Failed to create identity verification"),null}},Gt=({handoverSessionId:r,otherUserId:s,otherUserName:t,isHost:i,onStepComplete:m})=>{const[n,l]=d.useState(null),[c,a]=d.useState(!1),[g,N]=d.useState("pending"),[v,u]=d.useState(""),[I,o]=d.useState(!1),x=async p=>{var A;const j=(A=p.target.files)==null?void 0:A[0];if(j){a(!0);try{const k=await Ne(j,r,"identity_verification");k&&(l(k),await Kt({handover_session_id:r,verifier_id:"",verified_user_id:s,verification_photo_url:k,verification_status:"pending"}),_.success("Verification photo uploaded successfully"))}catch{_.error("Failed to upload verification photo")}finally{a(!1)}}},h=async p=>{o(!0);try{N(p),p==="verified"?(_.success(`${t}'s identity verified successfully`),m()):_.error("Identity verification failed")}catch{_.error("Failed to update verification status")}finally{o(!1)}};return e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",t,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx(W,{className:"space-y-4",children:n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:n,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(Y,{variant:g==="verified"?"default":g==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[g==="verified"&&e.jsx(ge,{className:"h-3 w-3 mr-1"}),g==="failed"&&e.jsx(de,{className:"h-3 w-3 mr-1"}),g.charAt(0).toUpperCase()+g.slice(1)]})]}),g==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(Le,{placeholder:"Add any notes about the verification...",value:v,onChange:p=>u(p.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(T,{onClick:()=>h("verified"),disabled:I,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(T,{onClick:()=>h("failed"),disabled:I,variant:"destructive",className:"flex-1",children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),g==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),g==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(ie,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",t," for identity verification"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:x,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:c}),e.jsx(T,{disabled:c,className:"flex items-center gap-2",children:c?e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4"}),"Take Photo"]})})]})]})})]})},Xt={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},Pe=({handoverSessionId:r,inspectionType:s,onPhotosUpdate:t,onStepComplete:i,initialPhotos:m=[]})=>{const[n,l]=d.useState(m),[c,a]=d.useState(!1),[g,N]=d.useState(null),v=d.useRef({}),u=Xt[s],I=u.filter(b=>b.required),o=I.filter(b=>n.some(R=>R.type===b.type)),x=async(b,R)=>{a(!0),N(b);try{const F=await Ne(R,r,b);if(F){const q={id:`${Date.now()}-${b}`,type:b,url:F,timestamp:new Date().toISOString()},M=[...n,q];l(M),t(M),_.success("Photo uploaded successfully")}}catch{_.error("Failed to upload photo")}finally{a(!1),N(null)}},h=b=>{const R=v.current[b];R&&(N(b),R.click())},p=(b,R)=>{var q;const F=(q=b.target.files)==null?void 0:q[0];F&&x(R,F),b.target.value=""},j=b=>{const R=n.filter(F=>F.id!==b);l(R),t(R)},A=b=>n.find(R=>R.type===b),k=o.length===I.length,$=()=>{k&&(i(),_.success(`${s} inspection completed`))};return e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-5 w-5"}),s==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(Y,{variant:k?"default":"secondary",children:[o.length,"/",I.length," Required Photos"]})})]}),e.jsxs(W,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:u.map(b=>{const R=A(b.type),F=g===b.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:b.label}),b.required&&e.jsx(Y,{variant:"outline",className:"text-xs",children:"Required"})]}),R?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:R.url,alt:b.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(T,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>j(R.id),children:e.jsx(Te,{className:"h-4 w-4"})})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>h(b.type),children:[e.jsx("input",{ref:q=>v.current[b.type]=q,type:"file",accept:"image/*",capture:"environment",onChange:q=>p(q,b.type),className:"hidden"}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:F&&g===b.type?e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"h-6 w-6 animate-spin text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(De,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})]},b.type)})}),k&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(T,{onClick:$,className:"w-full",children:["Complete ",s==="exterior"?"Exterior":"Interior"," Inspection"]})}),!k&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},Yt=({handoverSessionId:r,onDamageReportsUpdate:s,onStepComplete:t,initialReports:i=[]})=>{const[m,n]=d.useState(i),[l,c]=d.useState(!1),[a,g]=d.useState({location:"",severity:"minor",description:"",photos:[]}),[N,v]=d.useState(!1),u=async h=>{v(!0);try{const p=await Ne(h,r,"damage_specific");p&&(g(j=>({...j,photos:[...j.photos,p]})),_.success("Damage photo uploaded"))}catch{_.error("Failed to upload damage photo")}finally{v(!1)}},I=()=>{if(!a.location||!a.description){_.error("Please fill in location and description");return}const h={id:`damage-${Date.now()}`,location:a.location,severity:a.severity,description:a.description,photos:a.photos,timestamp:new Date().toISOString()},p=[...m,h];n(p),s(p),g({location:"",severity:"minor",description:"",photos:[]}),c(!1),_.success("Damage report added")},o=h=>{const p=m.filter(j=>j.id!==h);n(p),s(p)},x=h=>{switch(h){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx($e,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs(W,{className:"space-y-4",children:[m.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",m.length,")"]}),m.map(h=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:h.location}),e.jsx(Y,{className:`ml-2 ${x(h.severity)}`,children:h.severity})]}),e.jsx(T,{size:"sm",variant:"outline",onClick:()=>o(h.id),children:e.jsx(Te,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:h.description}),h.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:h.photos.map((p,j)=>e.jsx("img",{src:p,alt:`Damage ${j+1}`,className:"w-full h-20 object-cover rounded"},j))})]},h.id))]}),l?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(Ae,{placeholder:"e.g., Front bumper, Driver door",value:a.location,onChange:h=>g(p=>({...p,location:h.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(xt,{value:a.severity,onValueChange:h=>g(p=>({...p,severity:h})),children:[e.jsx(pt,{children:e.jsx(vt,{})}),e.jsxs(jt,{children:[e.jsx(me,{value:"minor",children:"Minor"}),e.jsx(me,{value:"moderate",children:"Moderate"}),e.jsx(me,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(Le,{placeholder:"Describe the damage in detail...",value:a.description,onChange:h=>g(p=>({...p,description:h.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[a.photos.map((h,p)=>e.jsx("img",{src:h,alt:`Damage photo ${p+1}`,className:"w-full h-20 object-cover rounded"},p)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:h=>{var j;const p=(j=h.target.files)==null?void 0:j[0];p&&u(p)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:N}),e.jsx(ie,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{onClick:I,className:"flex-1",children:"Save Damage Report"}),e.jsx(T,{variant:"outline",onClick:()=>c(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(T,{onClick:()=>c(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(T,{onClick:t,className:"w-full",children:m.length>0?`Complete Documentation (${m.length} damage reports)`:"No Damage - Complete Step"})})]})]})},Qt=({handoverSessionId:r,onFuelLevelChange:s,onMileageChange:t,onStepComplete:i,initialFuelLevel:m,initialMileage:n})=>{const[l,c]=d.useState(m||50),[a,g]=d.useState((n==null?void 0:n.toString())||""),N=o=>{const x=o[0];c(x),s(x)},v=o=>{g(o);const x=parseInt(o,10);isNaN(x)||t(x)},u=a!==""&&!isNaN(parseInt(a,10))&&parseInt(a,10)>0,I=()=>{u?(i(),_.success("Fuel level and mileage recorded successfully")):_.error("Please enter a valid mileage reading")};return e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(Nt,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs(W,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(_e,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(yt,{value:[l],onValueChange:N,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[l,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${l<=25?"#ef4444":l<=50?"#f59e0b":"#10b981"} 0deg,
                    ${l<=25?"#ef4444":l<=50?"#f59e0b":"#10b981"} ${l/100*360}deg,
                    #e5e7eb ${l/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[l,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_e,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(Rt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ae,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:a,onChange:o=>v(o.target.value),className:"pl-10",min:"0"})]}),a&&!isNaN(parseInt(a,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(a,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[l,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:a?`${parseInt(a,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(T,{onClick:I,disabled:!u,className:"w-full",children:"Complete Fuel & Mileage Check"}),!u&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},Jt=({handoverSessionId:r,otherUserName:s,isHost:t,onStepComplete:i})=>{const[m,n]=d.useState(!1),[l,c]=d.useState(!1),[a,g]=d.useState(!1),N=m&&l&&a,v=()=>{N&&(i(),_.success("Key transfer completed successfully"))};return e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?`Transfer vehicle keys to ${s}`:`Receive vehicle keys from ${s}`})]}),e.jsxs(W,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(he,{id:"key-transferred",checked:m,onCheckedChange:u=>n(u)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:t?`I have handed over the main vehicle key to ${s}`:`I have received the main vehicle key from ${s}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(he,{id:"key-received",checked:l,onCheckedChange:u=>c(u)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:t?`${s} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(he,{id:"spares-confirmed",checked:a,onCheckedChange:u=>g(u)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:m&&l?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(T,{onClick:v,disabled:!N,className:"w-full",children:"Complete Key Transfer"}),!N&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},Zt=({handoverSessionId:r,onSignatureComplete:s,initialSignature:t})=>{const i=d.useRef(null),[m,n]=d.useState(!1),[l,c]=d.useState(!!t),[a,g]=d.useState(t||null),N=x=>{x.preventDefault(),n(!0);const h=i.current;if(!h)return;const p=h.getBoundingClientRect(),j=h.width/p.width,A=h.height/p.height,k=h.getContext("2d");if(!k)return;k.lineWidth=2,k.lineCap="round",k.strokeStyle="#000";let $,b;"touches"in x?($=(x.touches[0].clientX-p.left)*j,b=(x.touches[0].clientY-p.top)*A):($=(x.clientX-p.left)*j,b=(x.clientY-p.top)*A),k.beginPath(),k.moveTo($,b)},v=x=>{if(!m)return;x.preventDefault();const h=i.current,p=h==null?void 0:h.getContext("2d");if(!h||!p)return;const j=h.getBoundingClientRect(),A=h.width/j.width,k=h.height/j.height;let $,b;"touches"in x?($=(x.touches[0].clientX-j.left)*A,b=(x.touches[0].clientY-j.top)*k):($=(x.clientX-j.left)*A,b=(x.clientY-j.top)*k),p.lineTo($,b),p.stroke(),c(!0)},u=()=>{n(!1)},I=()=>{const x=i.current,h=x==null?void 0:x.getContext("2d");!x||!h||(h.clearRect(0,0,x.width,x.height),c(!1),g(null))},o=()=>{const x=i.current;if(!x||!l)return;const h=x.toDataURL("image/png");g(h),s(h),_.success("Digital signature captured successfully")};return d.useState(()=>{if(t&&i.current){const h=i.current.getContext("2d"),p=new Image;p.onload=()=>{h==null||h.drawImage(p,0,0)},p.src=t}}),e.jsxs(O,{className:"w-full",children:[e.jsxs(se,{children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs(W,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:i,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:N,onMouseMove:v,onMouseUp:u,onMouseLeave:u,onTouchStart:N,onTouchMove:v,onTouchEnd:u,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(T,{variant:"outline",onClick:I,disabled:!l,className:"flex-1",children:[e.jsx(wt,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(T,{onClick:o,disabled:!l,className:"flex-1",children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),a&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},es=({currentStep:r,totalDistance:s,totalDuration:t,isNavigating:i,onToggleVoice:m,isVoiceEnabled:n,onStopNavigation:l,onArrived:c,destination:a,showArrivedButton:g=!1})=>{const[N,v]=d.useState("");d.useEffect(()=>{if(t>0){const o=new Date(Date.now()+t*1e3);v(o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))}},[t]);const u=o=>o<1e3?`${Math.round(o)}m`:`${(o/1e3).toFixed(1)}km`,I=o=>{const x=Math.floor(o/60);if(x<1)return"< 1 min";if(x<60)return`${x} min`;const h=Math.floor(x/60),p=x%60;return`${h}h ${p}m`};return!i||!r?null:e.jsx(O,{className:"mx-4 mt-4 shadow-lg border-primary/20",children:e.jsxs(W,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(le,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["To ",a]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{variant:"ghost",size:"sm",onClick:m,className:"h-8 w-8 p-0",children:n?e.jsx(Lt,{className:"h-4 w-4"}):e.jsx(Tt,{className:"h-4 w-4"})}),e.jsx(T,{variant:"outline",size:"sm",onClick:l,className:"text-xs",children:"Stop"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg mt-1",children:e.jsx(pe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground mb-1",children:r.instruction}),r.road_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["on ",r.road_name]}),e.jsx("div",{className:"flex items-center space-x-1 mt-2",children:e.jsx(Y,{variant:"secondary",className:"text-xs",children:u(r.distance)})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Be,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:I(t)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"text-muted-foreground",children:u(s)})}),N&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(je,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-muted-foreground",children:["ETA ",N]})]})]}),g&&c&&e.jsx("div",{className:"mt-4 pt-4 border-t border-muted",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Used alternative navigation or already arrived?"}),e.jsx(T,{onClick:c,className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:"I've Arrived"})]})})]})})},ts=({steps:r,currentStepIndex:s,onStepClick:t,className:i=""})=>{const m=a=>a<1e3?`${Math.round(a)}m`:`${(a/1e3).toFixed(1)}km`,n=a=>a===0?e.jsx(le,{className:"h-4 w-4"}):a===r.length-1?e.jsx(bt,{className:"h-4 w-4"}):e.jsx(pe,{className:"h-4 w-4"}),l=a=>a<s?"text-muted-foreground":a===s?"text-primary":"text-foreground",c=a=>a<s?"bg-muted/50":a===s?"bg-primary/10 border-primary/20":"bg-background";return e.jsxs(O,{className:i,children:[e.jsx(se,{className:"pb-3",children:e.jsxs(re,{className:"text-lg flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Turn-by-Turn Directions"]})}),e.jsx(W,{className:"p-0",children:e.jsx(Me,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-2 p-4",children:r.map((a,g)=>e.jsxs("div",{className:`
                  flex items-start space-x-3 p-3 rounded-lg border transition-all
                  ${c(g)}
                  ${t?"cursor-pointer hover:bg-muted/30":""}
                  ${g===s?"border-primary/20":"border-transparent"}
                `,onClick:()=>t==null?void 0:t(g),children:[e.jsx("div",{className:`mt-1 ${l(g)}`,children:n(g)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-medium ${l(g)}`,children:a.instruction}),a.road_name&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["on ",a.road_name]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-2",children:[e.jsx(Y,{variant:"secondary",className:"text-xs shrink-0",children:m(a.distance)}),g===s&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"})]})]})}),t&&e.jsx(et,{className:"h-4 w-4 text-muted-foreground mt-1"})]},g))})})})]})},ss=()=>{const[r,s]=d.useState(null),[t,i]=d.useState(!1),[m,n]=d.useState(null);return{userLocation:r,isTracking:t,error:m,startTracking:()=>{if(!navigator.geolocation){const v="Geolocation is not supported by this browser";n(v),_.error(v);return}i(!0),n(null);const g={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4},N=navigator.geolocation.watchPosition(v=>{const u={latitude:v.coords.latitude,longitude:v.coords.longitude,accuracy:v.coords.accuracy};s(u),n(null)},v=>{let u="Failed to get location";switch(v.code){case v.PERMISSION_DENIED:u="Location access denied. Please enable location permissions.";break;case v.POSITION_UNAVAILABLE:u="Location information is unavailable.";break;case v.TIMEOUT:u="Location request timed out.";break}n(u),_.error(u),i(!1)},g);return()=>{navigator.geolocation.clearWatch(N),i(!1)}},stopTracking:()=>{i(!1),s(null),n(null)},getCurrentLocation:()=>new Promise((g,N)=>{if(!navigator.geolocation){N(new Error("Geolocation is not supported"));return}navigator.geolocation.getCurrentPosition(v=>{const u={latitude:v.coords.latitude,longitude:v.coords.longitude,accuracy:v.coords.accuracy};g(u)},v=>{let u="Failed to get location";switch(v.code){case v.PERMISSION_DENIED:u="Location access denied";break;case v.POSITION_UNAVAILABLE:u="Location information unavailable";break;case v.TIMEOUT:u="Location request timed out";break}N(new Error(u))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}},oe=class oe{constructor(){ae(this,"mapboxToken",null)}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}async initialize(){try{return this.mapboxToken=await Ue(),!!this.mapboxToken}catch(s){return console.error("Failed to initialize navigation service:",s),_.error("Navigation service unavailable"),!1}}async getRoute(s){if(!this.mapboxToken&&(await this.initialize(),!this.mapboxToken))throw new Error("Navigation service not initialized");const{origin:t,destination:i,profile:m="driving"}=s;try{const n=await fetch(`https://api.mapbox.com/directions/v5/mapbox/${m}/${t.longitude},${t.latitude};${i.longitude},${i.latitude}?steps=true&geometries=geojson&overview=full&access_token=${this.mapboxToken}`),l=await n.json();if(!n.ok)throw new Error(l.message||"Failed to get route");if(!l.routes||l.routes.length===0)throw new Error("No route found");const c=l.routes[0];return{geometry:c.geometry,distance:c.distance,duration:c.duration,steps:c.legs[0].steps.map(a=>({instruction:a.maneuver.instruction,distance:a.distance,duration:a.duration,maneuver:a.maneuver.type,road_name:a.name,geometry:a.geometry}))}}catch(n){return console.error("Error fetching route:",n),_.error("Unable to calculate route"),null}}async getDirections(s,t){const i=await this.getRoute({origin:s,destination:t});return(i==null?void 0:i.steps)||[]}calculateDistance(s,t,i,m){const l=s*Math.PI/180,c=i*Math.PI/180,a=(i-s)*Math.PI/180,g=(m-t)*Math.PI/180,N=Math.sin(a/2)*Math.sin(a/2)+Math.cos(l)*Math.cos(c)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(N),Math.sqrt(1-N)))}formatDistance(s){return s<1e3?`${Math.round(s)}m`:`${(s/1e3).toFixed(1)}km`}formatDuration(s){const t=Math.floor(s/60);if(t<1)return"< 1 min";if(t<60)return`${t} min`;const i=Math.floor(t/60),m=t%60;return`${i}h ${m}m`}};ae(oe,"instance");let ve=oe;const Ie=ve.getInstance(),rs=({handoverSessionId:r,destinationLocation:s,otherUserName:t,isHost:i,onStepComplete:m,onNavigationStart:n})=>{const{userLocation:l,getCurrentLocation:c}=ss(),[a,g]=d.useState(!1),[N,v]=d.useState(!1),[u,I]=d.useState([]),[o,x]=d.useState(0),[h,p]=d.useState(0),[j,A]=d.useState(0),[k,$]=d.useState(!1),[b]=d.useState(50),[R,F]=d.useState(!1);d.useEffect(()=>{(async()=>{const w=await Ie.initialize();F(w)})()},[]);const q=(K,w,B,L)=>{const y=K*Math.PI/180,f=B*Math.PI/180,C=(B-K)*Math.PI/180,H=(L-w)*Math.PI/180,G=Math.sin(C/2)*Math.sin(C/2)+Math.cos(y)*Math.cos(f)*Math.sin(H/2)*Math.sin(H/2);return 6371e3*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))};d.useEffect(()=>{if(!l||!a||N)return;if(q(l.latitude,l.longitude,s.latitude,s.longitude)<=b&&(v(!0),g(!1),_.success("You have arrived at the handover location!"),k&&"speechSynthesis"in window)){const w=new SpeechSynthesisUtterance("You have arrived at your destination");speechSynthesis.speak(w)}},[l,s,a,N,b,k]);const M=async()=>{let K=l;if(!K)try{K=await c()}catch{return _.error("Unable to get your current location"),!1}if(!R)return _.error("Navigation service not available"),!1;try{const w=await Ie.getRoute({origin:K,destination:s});if(w)return p(w.distance),A(w.duration),I(w.steps),!0;throw new Error("No route found")}catch(w){return console.error("Error fetching route:",w),_.error("Unable to calculate route. Please try again."),!1}},P=async()=>{await M()&&(g(!0),x(0),n==null||n(),_.success("Navigation started"))},U=()=>{g(!1),x(0),_.info("Navigation stopped")},E=()=>{$(!k),_.info(k?"Voice guidance disabled":"Voice guidance enabled")},V=()=>{m(),_.success("Ready to begin handover process")},J=()=>{v(!0),g(!1),_.success("Marked as arrived - ready for handover!")},Q=u[o]||null,Z=N?100:o/Math.max(u.length-1,1)*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(O,{children:[e.jsx(se,{children:e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-5 w-5"}),"Navigate to Handover Location"]})}),e.jsxs(W,{className:"space-y-4",children:[e.jsx("div",{className:"bg-muted/50 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg",children:e.jsx(le,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Meeting Location"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.address}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(tt,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Meet ",t," here"]})]})]})]}),N&&e.jsxs(Y,{variant:"default",className:"bg-green-100 text-green-800",children:[e.jsx(ee,{className:"h-3 w-3 mr-1"}),"Arrived"]})]})}),!a&&!N&&e.jsxs("div",{className:"text-center",children:[e.jsxs(T,{onClick:P,size:"lg",className:"w-full",disabled:!R,children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Start Navigation"]}),!R&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:[e.jsx(ye,{className:"h-4 w-4 inline mr-1"}),"Loading navigation service..."]})]}),(a||N)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Be,{className:"h-4 w-4"}),"Navigation Progress"]}),e.jsxs("span",{children:[Math.round(Z),"%"]})]}),e.jsx(xe,{value:Z,className:"h-2"})]}),N&&e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx(ee,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-green-800 font-medium",children:"You've arrived at the handover location!"}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:i?"Wait for the renter to arrive":"Look for the host and their vehicle"})]}),e.jsxs(T,{onClick:V,size:"lg",className:"w-full",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"I'm Ready for Handover"]})]})]})]}),a&&Q&&e.jsx(es,{currentStep:Q,totalDistance:h,totalDuration:j,isNavigating:a,onToggleVoice:E,isVoiceEnabled:k,onStopNavigation:U,onArrived:J,destination:s.address,showArrivedButton:!0}),a&&u.length>0&&e.jsx(ts,{steps:u,currentStepIndex:o,onStepClick:K=>x(K)})]})},as=({isHost:r,onClose:s,duration:t=3e3})=>{const[i,m]=d.useState(!0);d.useEffect(()=>{console.log("HandoverSuccessPopup mounted with duration:",t);const l=setTimeout(()=>{console.log("HandoverSuccessPopup timer fired, setting invisible"),m(!1),setTimeout(()=>{console.log("HandoverSuccessPopup calling onClose"),s()},300)},t);return()=>{console.log("HandoverSuccessPopup cleanup"),clearTimeout(l)}},[t,s]);const n=r?"See you soon!":"Have a nice trip!";return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsx(O,{className:`
          bg-white/95 backdrop-blur-sm shadow-2xl border-2 border-primary/20 
          p-6 rounded-2xl transition-all duration-300 transform
          ${i?"scale-100 opacity-100":"scale-95 opacity-0"}
        `,children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ve,{className:"h-8 w-8 text-primary"}),e.jsx(ee,{className:"h-4 w-4 text-green-500 absolute -top-1 -right-1 bg-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-1",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:n})]})]})})})},ze=r=>{const[s,t]=d.useState(null),[i,m]=d.useState(!0),[n,l]=d.useState(null),c=async()=>{if(!r){m(!1);return}try{m(!0);const{data:a,error:g}=await D.rpc("calculate_handover_progress",{handover_session_id_param:r});if(g)throw g;t(a&&typeof a=="object"?a:null),l(null)}catch(a){console.error("Error fetching handover progress:",a),l("Failed to load handover progress")}finally{m(!1)}};return d.useEffect(()=>{c()},[r]),d.useEffect(()=>{if(!r)return;console.log("Setting up real-time subscription for handover:",r);const a=D.channel(`handover_progress_${r}`).on("postgres_changes",{event:"*",schema:"public",table:"handover_step_completion",filter:`handover_session_id=eq.${r}`},async g=>{var N,v;if(console.log("Handover step completion changed:",g),await c(),g.eventType==="UPDATE"&&((N=g.new)!=null&&N.is_completed)){const u=(v=g.new.step_name)==null?void 0:v.replace(/_/g," ");_.success(`${u} completed!`)}}).on("postgres_changes",{event:"*",schema:"public",table:"handover_sessions",filter:`id=eq.${r}`},g=>{var N;console.log("Handover session changed:",g),g.eventType==="UPDATE"&&((N=g.new)!=null&&N.handover_completed)&&_.success("Handover process completed successfully!")}).subscribe(g=>{console.log("Real-time subscription status:",g),g==="SUBSCRIBED"?console.log("Successfully subscribed to handover updates"):g==="CHANNEL_ERROR"&&(console.error("Failed to subscribe to handover updates"),l("Real-time updates unavailable"))});return()=>{console.log("Cleaning up handover real-time subscription"),D.removeChannel(a)}},[r]),{handoverProgress:s,isLoading:i,error:n}},os=({handoverSessionId:r,showDetailed:s=!1})=>{const{handoverProgress:t,isLoading:i,error:m}=ze(r);if(i)return e.jsx(O,{className:"w-full",children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(_t,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading progress..."})]})})});if(m||!t)return e.jsx(O,{className:"w-full",children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-destructive",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:m||"Unable to load progress"})]})})});const n=()=>t.is_completed?e.jsx(ee,{className:"h-5 w-5 text-green-600"}):e.jsx(je,{className:"h-5 w-5 text-blue-600"}),l=()=>t.is_completed?"Handover Complete":`Step ${t.current_step} of ${t.total_steps}`;return s?e.jsxs(O,{className:"w-full",children:[e.jsx(se,{className:"pb-3",children:e.jsxs(re,{className:"flex items-center space-x-2",children:[n(),e.jsx("span",{children:"Handover Progress"})]})}),e.jsxs(W,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:l()}),e.jsxs(Y,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]}),e.jsx(xe,{value:t.progress_percentage,className:"h-3"})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:[t.completed_steps," completed"]}),e.jsxs("span",{children:[t.total_steps-t.completed_steps," remaining"]})]}),t.is_completed&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ee,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"All handover steps completed successfully!"})]})})]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[n(),e.jsx("div",{className:"flex-1",children:e.jsx(xe,{value:t.progress_percentage,className:"h-2"})}),e.jsxs(Y,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]})},ns=({isOpen:r,onClose:s,bookingId:t})=>{var Z,K;const i=Re(),{isLoading:m,isHandoverSessionLoading:n,isHost:l,bookingDetails:c,handoverId:a,currentUserId:g}=He();ze(a);const[N,v]=d.useState(0),[u,I]=d.useState([]),[o,x]=d.useState([]),[h,p]=d.useState([]),[j,A]=d.useState(),[k,$]=d.useState(),[b,R]=d.useState(),[F,q]=d.useState(!1);d.useEffect(()=>{a&&r&&!n&&M()},[a,r,n]);const M=async()=>{if(!a){console.error("Cannot initialize handover: missing handover session ID"),_.error("Handover session not found");return}console.log("Initializing handover for session:",a);try{await Bt(a);const w=await Ee(a);console.log("Loaded handover steps:",w),console.log("Steps completion status:",w.map(y=>({name:y.step_name,completed:y.is_completed}))),I(w);const B=w.findIndex(y=>!y.is_completed),L=B>=0?B:w.length;console.log("First incomplete step index:",B),console.log("Setting current step to:",L),v(L);const S=w.filter(y=>y.is_completed).length;S>0&&_.success(`Continuing handover process - ${S}/${w.length} steps completed`),console.log("Handover initialized successfully")}catch(w){console.error("Error initializing handover:",w),_.error("Failed to initialize handover process")}},P=async(w,B)=>{if(!a){_.error("Handover session not found");return}if(console.log(`Attempting to complete step: ${w}`),await zt(a,w,B)){const S=await Ee(a);I(S);const y=S.findIndex(f=>!f.is_completed);y>=0?(v(y),console.log(`Moving to next step: ${y}`)):(console.log("All steps completed, checking if handover should be finalized"),S.every(C=>C.is_completed)&&await U())}},U=async()=>{var w;console.log("Starting handover completion...");try{if(a&&(console.log("Completing handover session:",a),await st(a)),o.length>0||h.length>0||j!==void 0||k!==void 0){console.log("Creating vehicle condition report...");const B={handover_session_id:a,booking_id:(c==null?void 0:c.id)||"",car_id:((w=c==null?void 0:c.car)==null?void 0:w.id)||"",report_type:"pickup",vehicle_photos:o,damage_reports:h,fuel_level:j,mileage:k,digital_signature_data:b,is_acknowledged:!0,reporter_id:g};if(!await Wt(B))throw new Error("Failed to create vehicle condition report");console.log("Vehicle condition report created successfully")}console.log("Setting handover completed to true, isHost:",l),q(!0)}catch(B){console.error("Error completing handover:",B),_.error("Failed to complete handover. Please try again.")}},E=()=>{console.log("Success popup closing, isHost:",l),q(!1);const w=new URL(window.location.href);w.searchParams.delete("mode"),w.searchParams.delete("bookingId"),window.history.replaceState({},"",w.pathname+w.search),s(),l?(console.log("Navigating to host-bookings"),i("/host-bookings")):(console.log("Navigating to renter-bookings"),i("/renter-bookings"))},V=w=>{switch(w){case"navigation":return!0;case"identity_verification":return!0;case"vehicle_inspection_exterior":return o.filter(L=>L.type&&L.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return o.filter(L=>L.type&&(L.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(L.type))).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return j!==void 0&&k!==void 0;case"key_transfer":return!0;case"digital_signature":return b!==void 0;default:return!0}},J=(w,B)=>{var S,y,f,C;const L=l?c==null?void 0:c.renter:(S=c==null?void 0:c.car)==null?void 0:S.owner;switch(w.name){case"navigation":{const H={latitude:(c==null?void 0:c.latitude)||((y=c==null?void 0:c.car)==null?void 0:y.latitude)||-24.65451,longitude:(c==null?void 0:c.longitude)||((f=c==null?void 0:c.car)==null?void 0:f.longitude)||25.90859,address:((C=c==null?void 0:c.car)==null?void 0:C.location)||"Handover Location"};return e.jsx(rs,{handoverSessionId:a||"",destinationLocation:H,otherUserName:(L==null?void 0:L.full_name)||"User",isHost:l,onStepComplete:()=>P(w.name),onNavigationStart:()=>_.info("Navigation started. Follow the directions to reach the handover location.")})}case"identity_verification":return e.jsx(Gt,{handoverSessionId:a||"",otherUserId:(L==null?void 0:L.id)||"",otherUserName:(L==null?void 0:L.full_name)||"User",isHost:l,onStepComplete:()=>P(w.name)});case"vehicle_inspection_exterior":return o.filter(H=>H.type.startsWith("exterior_")),e.jsx(Pe,{handoverSessionId:a||"",inspectionType:"exterior",onPhotosUpdate:H=>{const G=o.filter(X=>X.type&&!X.type.startsWith("exterior_"));x([...G,...H])},onStepComplete:()=>P(w.name),initialPhotos:o.filter(H=>H.type&&H.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return o.filter(H=>H.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(H.type)),e.jsx(Pe,{handoverSessionId:a||"",inspectionType:"interior",onPhotosUpdate:H=>{const G=o.filter(X=>X.type&&!X.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(X.type));x([...G,...H])},onStepComplete:()=>P(w.name),initialPhotos:o.filter(H=>H.type&&(H.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(H.type)))});case"damage_documentation":return e.jsx(Yt,{handoverSessionId:a||"",onDamageReportsUpdate:p,onStepComplete:()=>P(w.name),initialReports:h});case"fuel_mileage_check":return e.jsx(Qt,{handoverSessionId:a||"",onFuelLevelChange:A,onMileageChange:$,onStepComplete:()=>P(w.name,{fuel_level:j,mileage:k}),initialFuelLevel:j,initialMileage:k});case"key_transfer":return e.jsx(Jt,{handoverSessionId:a||"",otherUserName:(L==null?void 0:L.full_name)||"User",isHost:l,onStepComplete:()=>P(w.name)});case"digital_signature":return e.jsx(Zt,{handoverSessionId:a||"",onSignatureComplete:H=>{R(H),P(w.name,{signature:H})},initialSignature:b});default:return e.jsx(O,{children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:w.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:w.description}),e.jsxs(T,{onClick:()=>P(w.name),disabled:!V(w.name),children:["Complete ",w.title]})]})})})}};if(m||n)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(O,{className:"w-96",children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:n?"Setting up handover session...":"Loading handover process..."})]})})})});if(!a&&!n)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(O,{className:"w-96",children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ye,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Session Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load the handover session. Please try refreshing the page."}),e.jsx(T,{onClick:s,variant:"outline",children:"Close"})]})})})});u.filter(w=>w.is_completed).length/ce.length*100;const Q=ce[N];return e.jsxs(e.Fragment,{children:[F&&e.jsxs(e.Fragment,{children:[console.log("Rendering HandoverSuccessPopup with isHost:",l),e.jsx(as,{isHost:l,onClose:E})]}),e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:r?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:s}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[90vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(Z=c==null?void 0:c.car)==null?void 0:Z.brand," ",(K=c==null?void 0:c.car)==null?void 0:K.model]})]}),e.jsx("button",{onClick:s,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(de,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(os,{handoverSessionId:a,showDetailed:!1})}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:ce.map((w,B)=>{const L=u.find(f=>f.step_name===w.name),S=(L==null?void 0:L.is_completed)||!1,y=B===N;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${S?"bg-green-50 border-green-200 text-green-800":y?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:S?e.jsx(ee,{className:"h-4 w-4"}):y?e.jsx(je,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:w.title})]},w.name)})})}),Q?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(Y,{variant:"outline",children:["Step ",N+1]}),e.jsx("span",{className:"font-medium",children:Q.title})]}),J(Q)]}):e.jsx(O,{children:e.jsx(W,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ee,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})]})},is=({onBookingClick:r})=>{const{userId:s,userRole:t}=kt(),{data:i=[]}=Ge({queryKey:["handover-bookings",s,t],queryFn:async()=>{try{if(!s||!t)return console.log("HandoverBookingButtons: No userId or userRole"),[];const n=new Date,l=new Date().toISOString().split("T")[0],c=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];console.log("HandoverBookingButtons: Fetching bookings",{userId:s,userRole:t,today:l,tomorrow:c});let a=D.from("bookings").select(`
            *,
            cars (
              brand,
              model,
              location,
              image_url,
              owner_id,
              price_per_day
            ),
            renter:profiles!renter_id (
              full_name,
              avatar_url,
              phone_number
            ),
            handover_sessions (
              handover_completed,
              created_at
            )
          `).eq("status","confirmed").or(`start_date.eq.${l},start_date.eq.${c},end_date.eq.${l}`);t==="renter"?a=a.eq("renter_id",s):t==="host"&&(a=a.eq("cars.owner_id",s));const{data:g,error:N}=await a;if(N)throw console.error("HandoverBookingButtons: Error fetching bookings:",N),new Error(`Failed to fetch handover bookings: ${N.message}`);if(!g)return console.log("HandoverBookingButtons: No data returned"),[];console.log("HandoverBookingButtons: Raw bookings data",g);const v=g.filter(u=>{var k;const I=new Date(u.start_date),o=new Date(u.end_date),x=(k=u.handover_sessions)==null?void 0:k[0];if(x!=null&&x.handover_completed)return!1;const p=I.toDateString()===n.toDateString()&&!x,A=o.toDateString()===n.toDateString()&&x&&!x.handover_completed;return p||A});return console.log("HandoverBookingButtons: Filtered bookings",v),v}catch(n){return console.error("HandoverBookingButtons: Query failed:",n),[]}},enabled:!!s&&!!t,refetchInterval:3e4,retry:(n,l)=>(console.warn("HandoverBookingButtons: Query failed, retry attempt",{failureCount:n,error:l}),n<2),retryDelay:n=>Math.min(1e3*2**n,3e4)}),m=({booking:n,index:l})=>{var x,h,p,j,A,k,$;const c=((x=n.cars)==null?void 0:x.image_url)||"/placeholder.svg",a=new Date,g=new Date(n.start_date),N=new Date(n.end_date),v=(h=n.handover_sessions)==null?void 0:h[0],u=g.toDateString()===a.toDateString(),I=N.toDateString()===a.toDateString();let o="pickup";return I&&v&&!v.handover_completed?o="return":u&&!v&&(o="pickup"),e.jsx(rt,{children:e.jsxs(at,{children:[e.jsx(ot,{asChild:!0,children:e.jsx("button",{onClick:b=>{b.preventDefault(),console.log("Handover button clicked for booking:",n.id,"type:",o),r(n.id,o)},className:`
                w-16 h-16 rounded-full border-4 border-primary/30 
                overflow-hidden shadow-lg hover:shadow-xl
                transition-all duration-300 hover:scale-110
                animate-pulse bg-background
                mb-3
              `,style:{animationDuration:`${2+l*.5}s`},children:e.jsx("img",{src:c,alt:`${(p=n.cars)==null?void 0:p.brand} ${(j=n.cars)==null?void 0:j.model}`,className:"w-full h-full object-cover",onError:b=>{b.currentTarget.src="/placeholder.svg"}})})}),e.jsx(nt,{side:"right",className:"max-w-xs p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-sm",children:[(A=n.cars)==null?void 0:A.brand," ",(k=n.cars)==null?void 0:k.model]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(St,{className:"h-3 w-3 mr-1"}),Ce(new Date(n.start_date),"MMM dd")," - ",Ce(new Date(n.end_date),"MMM dd")]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(le,{className:"h-3 w-3 mr-1"}),($=n.cars)==null?void 0:$.location]}),t==="host"&&n.renter&&e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(Fe,{className:"h-3 w-3 mr-1"}),n.renter.full_name]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(Ct,{className:"h-3 w-3 mr-1"}),"BWP ",n.total_price]}),e.jsx("div",{className:"text-xs text-primary font-medium mt-2",children:"Click for handover details"})]})})]})},n.id)};return i.length?(console.log("Rendering handover buttons for bookings:",i.map(n=>n.id)),e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col",children:i.map((n,l)=>e.jsx(m,{booking:n,index:l},n.id))})):(console.log("No handover bookings found for user:",s,"role:",t),null)};class ls extends d.Component{constructor(){super(...arguments);ae(this,"maxRetries",3);ae(this,"state",{hasError:!1,error:null,errorInfo:null,retryCount:0});ae(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries?(this.setState(t=>({hasError:!1,error:null,errorInfo:null,retryCount:t.retryCount+1})),_.info("Retrying handover process...")):_.error("Maximum retry attempts reached. Please refresh the page.")});ae(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,retryCount:0})});ae(this,"handleNavigateHome",()=>{const t=new URL(window.location.href);t.searchParams.delete("mode"),t.searchParams.delete("bookingId"),window.history.replaceState({},"",t.pathname),window.location.href="/"})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,i){console.error("HandoverErrorBoundary caught an error:",t,i),this.setState({errorInfo:i}),this.props.onError&&this.props.onError(t,i);const m={error:t.message,stack:t.stack,componentStack:i.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent};console.error("Handover Error Report:",m),_.error("A handover system error occurred. Please try again.")}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const i=this.state.retryCount<this.maxRetries,m=((t=this.state.error)==null?void 0:t.message)||"An unexpected error occurred";return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs(it,{className:"max-w-md",children:[e.jsx($e,{className:"h-4 w-4"}),e.jsxs(lt,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Handover System Error"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:m}),this.state.retryCount>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Retry attempt: ",this.state.retryCount,"/",this.maxRetries]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[i&&e.jsxs(T,{onClick:this.handleRetry,className:"w-full",variant:"outline",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"Retry Handover"]}),e.jsxs(T,{onClick:this.handleReset,className:"w-full",variant:"outline",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"Reset Process"]}),e.jsxs(T,{onClick:this.handleNavigateHome,className:"w-full",variant:"secondary",children:[e.jsx(Et,{className:"mr-2 h-4 w-4"}),"Return to Dashboard"]})]}),!1]})]})})}return this.props.children}}const Ks=()=>{const[r]=Ye(),s=r.get("mode"),t=r.get("bookingId"),{user:i}=ct(),[m,n]=d.useState(""),[l,c]=d.useState(!0),[a,g]=d.useState([]),[N,v]=d.useState(!1),[u]=d.useState({latitude:null,longitude:null}),{theme:I}=dt(),[o,x]=d.useState(!1),[h,p]=d.useState(!1),[j]=d.useState(null),A=async M=>{var P;try{const{data:U,error:E}=await D.from("bookings").select(`
          id, 
          status, 
          start_date, 
          end_date, 
          renter_id,
          cars!inner (
            owner_id
          )
        `).eq("id",M).eq("status","confirmed").single();if(E||!U)return console.log("Booking not found or not confirmed:",M),!1;const V=(P=U.cars)==null?void 0:P.owner_id;if(!i||i.id!==U.renter_id&&i.id!==V)return console.log("User does not have permission to access booking:",M),!1;const J=new Date().toISOString().split("T")[0],Q=U.start_date===J,Z=U.end_date===J;return!Q&&!Z?(console.log("Booking is not eligible for handover today:",M),!1):!0}catch(U){return console.error("Error validating booking:",U),!1}};d.useEffect(()=>{(async()=>{if(!(s==="handover"&&t)){x(!1);return}if(!i)return;if(p(!0),await A(t))x(!0);else{const E=new URL(window.location.href);E.searchParams.delete("mode"),E.searchParams.delete("bookingId"),window.history.replaceState({},"",E.pathname+E.search),_.info("Invalid handover request - showing standard map"),x(!1)}p(!1)})()},[s,t,i]),d.useEffect(()=>{o&&!N&&v(!0)},[o]),d.useEffect(()=>{(async()=>{c(!0);try{const P=await Ue();if(!P){_.error("Failed to get the map token"),console.error("Failed to get the map token");return}n(P)}catch(P){console.error("Error getting the map token:",P),_.error("Failed to get the map token")}finally{c(!1)}})()},[]);const k=async()=>{var M,P;if(!i)return null;try{const{data:U,error:E}=await D.from("handover_sessions").select(`
          host_id,
          host_location,
          bookings!inner(
            car_id,
            cars!inner(
              owner_id,
              profiles!owner_id(id, full_name, avatar_url, latitude, longitude)
            )
          )
        `).eq("renter_id",i.id).eq("handover_completed",!1).single();if(E||!U)return console.log("No active handover session found"),null;const V=(P=(M=U.bookings)==null?void 0:M.cars)==null?void 0:P.profiles;if(V!=null&&V.latitude&&(V!=null&&V.longitude))return{id:V.id,full_name:V.full_name,avatar_url:V.avatar_url,latitude:V.latitude,longitude:V.longitude,updated_at:null,isActiveHandover:!0}}catch(U){console.error("Error fetching active handover host:",U)}return null},$=async()=>{console.log("Fetching host locations...");try{const M=await qt();console.log("Online hosts fetched:",M);const P=await k();console.log("Active handover host:",P);let U=[...M];if(P){const E=U.findIndex(V=>V.id===P.id);E>=0?U[E]=P:U.push(P)}U.length||_.info("No hosts are currently online"),console.log("All host locations to display:",U),g(U)}catch(M){console.error("Error fetching host locations:",M),_.error("Failed to fetch host locations")}};d.useEffect(()=>{o||($(),console.log("Location",u))},[o]);const b=()=>I==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",R=()=>l||h?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:h?"Validating handover...":"Loading map..."}),e.jsx(ht,{color:"#7c3aed",width:100})]}):m?e.jsx(Ut,{mapbox_token:m,longitude:25.90859,latitude:-24.65451,onlineHosts:o?[]:a,mapStyle:b(),isHandoverMode:o,bookingId:t,dpad:!0,locationToggle:!0,destination:u}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]}),F=!!i&&o,q=e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("main",{className:"flex-1 relative overflow-hidden",children:[R(),F&&e.jsxs(ls,{children:[e.jsx(is,{onBookingClick:(M,P)=>{if(console.log("Map received booking click for:",M,"type:",P),console.log("Current booking ID from URL:",t),console.log("Current handover sheet state:",N),P==="return"){window.location.href=`/rental-details/${M}`;return}M!==t&&(console.log("Updating URL with new booking ID"),window.history.replaceState({},"",`/map?mode=handover&bookingId=${M}`)),console.log("Opening handover sheet"),v(!0)}}),e.jsx(ns,{isOpen:N,onClose:()=>{v(!1);const M=new URL(window.location.href);M.searchParams.delete("mode"),M.searchParams.delete("bookingId"),window.history.replaceState({},"",M.pathname+M.search)},bookingId:t||""})]})]}),e.jsx(Qe,{})]});return e.jsx(ut,{children:F?e.jsx(mt,{children:q}):q})};export{Ks as default};
