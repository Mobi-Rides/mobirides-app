var wt=Object.defineProperty;var bt=(s,r,t)=>r in s?wt(s,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[r]=t;var ne=(s,r,t)=>bt(s,typeof r!="symbol"?r+"":r,t);import{j as e,u as Nt}from"./query-vendor-C7aRRP05.js";import{r as f,u as Ve,d as _t,h as Oe}from"./react-vendor-mnpoGfEl.js";import{N as St}from"./Navigation-PKFoOZ-i.js";import{m as V}from"./mapbox-vendor-fnXFVHMy.js";import{G as kt}from"./mapbox-gl-BjqMLktz.js";import{c as te,B as L,y as Ct,z as Rt,s as U,X as xe,E as qe,v as ee,F as Ke,J as me,G as C,C as Se,H as Ge,K as We,M as Ye,T as Xe,I as Qe,S as Et,g as Mt,h as Dt,i as It,k as be,N as Pt,O as Tt,Q as Ht,R as de,V as ye,W as ge,Y as Lt,Z as Je,_ as $t,$ as At,a0 as Ut,f as Le,a1 as se,a2 as Ft,a3 as Ze,a4 as zt,a5 as Bt,a6 as Vt,a7 as Ot,a8 as qt,m as Kt,n as Gt,a9 as $e,aa as Wt,u as Yt,ab as Xt,ac as Qt,ad as Jt}from"./index-DJr5SZzu.js";import{A as Zt}from"./arrow-right-Bms2Nl_L.js";import{O as es}from"./OnlineStatusToggle-Bv1_gyXg.js";import{U as et}from"./user-CCMNZbkj.js";import{S as ke}from"./star-DQurhe2X.js";import{C as O,d as q,a as re,b as ae}from"./card-DMFn2_TK.js";import{C as tt}from"./car-DLlpGS8d.js";import{M as je}from"./map-pin-ZtPByMlX.js";import{P as fe}from"./progress-e9bpCaWM.js";import{C as he}from"./camera-BcCOKkLE.js";import{U as st}from"./upload-BrtqAdnD.js";import{C as Ne}from"./checkbox-lMgypCjf.js";import{R as ts}from"./rotate-ccw-CXKklzxO.js";import{C as Ie}from"./clock-B-BcoQFY.js";import{F as ss}from"./flag-CcElMTIP.js";import{N as Ae}from"./navigation-BDD7imCe.js";import{C as ve}from"./circle-alert-rcKd2uBC.js";import{L as rs}from"./loader-circle-B7c4mGQa.js";import{u as as}from"./useAuthStatus-DsPl9L_E.js";import{C as os}from"./calendar-DXV6iOkH.js";import{D as ns}from"./dollar-sign-pFeiRHgp.js";import{a as Ue}from"./date-vendor-Dhms5dOu.js";import{H as is}from"./house-Q4mvWeIi.js";import"./bell-B7yjendS.js";import"./supabase-vendor-BOn0LdFJ.js";import"./switch-B9wK1Y5N.js";import"./index-DE7TNQN2.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=te("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=te("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=te("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=te("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=te("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=te("Navigation2",[["polygon",{points:"12 2 19 21 12 17 5 21 12 2",key:"x8c0qg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=te("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=te("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fs=te("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gs=te("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);function ps({onUp:s,onDown:r,onLeft:t,onRight:a,onReset:n}){return e.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[e.jsx("div",{className:"flex gap-1",children:e.jsx(L,{variant:"default",onClick:s,style:{height:40},children:e.jsx(cs,{name:"arrow-up",size:24,color:"white"})})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(L,{variant:"default",onClick:t,style:{width:20},children:e.jsx(Ct,{name:"arrow-left",size:24,color:"white"})}),e.jsx(L,{variant:"default",onClick:n,children:e.jsx(Rt,{name:"arrow-left",size:24,color:"white"})}),e.jsx(L,{variant:"default",onClick:a,style:{width:20},children:e.jsx(Zt,{name:"arrow-right",size:24,color:"white"})})]}),e.jsx("div",{className:"flex gap-1",children:e.jsx(L,{variant:"default",onClick:r,style:{height:40},children:e.jsx(ls,{name:"arrow-down",size:24,color:"white"})})})]})}const xs=({host:s,onViewCars:r})=>{const t=()=>s.avatar_url?U.storage.from("avatars").getPublicUrl(s.avatar_url).data.publicUrl:"/placeholder.svg";return e.jsx("div",{className:"bg-background border rounded-lg shadow-lg p-3 min-w-[200px] cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>r(s.id),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex items-center justify-center",children:s.avatar_url?e.jsx("img",{src:t(),alt:s.full_name||"Host",className:"w-full h-full object-cover"}):e.jsx(et,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:s.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(ke,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32)"})]}),e.jsx("p",{className:"text-xs text-primary mt-1",children:"View available cars →"})]})]})})},vs=({isOpen:s,onClose:r,host:t})=>{const[a,n]=f.useState([]),[o,m]=f.useState(!1),p=Ve();f.useEffect(()=>{s&&(t!=null&&t.id)&&i(t.id)},[s,t==null?void 0:t.id]);const i=async h=>{m(!0),console.log("Fetching cars for host:",h);try{console.log("Step 1: Checking if host has any cars...");const{data:R,error:d}=await U.from("cars").select("*").eq("owner_id",h);console.log("All cars for host:",R),d&&console.error("Error fetching all cars:",d),console.log("Step 2: Checking available cars...");const{data:x,error:g}=await U.from("cars").select("*").eq("owner_id",h).eq("is_available",!0);if(console.log("Available cars for host:",x),g&&console.error("Error fetching available cars:",g),x&&x.length>0){console.log("Step 3: Checking car images...");const _=x.map(z=>z.id),{data:H,error:I}=await U.from("car_images").select("*").in("car_id",_);console.log("Car images:",H),I&&console.error("Error fetching car images:",I)}console.log("Step 4: Trying with left join...");const{data:y,error:N}=await U.from("cars").select(`
          *,
          car_images(
            image_url,
            is_primary
          )
        `).eq("owner_id",h).eq("is_available",!0);if(N){console.error("Error fetching host cars with left join:",N);return}console.log("Cars with left join:",y);const D=(y==null?void 0:y.map(_=>{var I,z,E;const H=(I=_.car_images)==null?void 0:I.find($=>$.is_primary);return{..._,image_url:(H==null?void 0:H.image_url)||((E=(z=_.car_images)==null?void 0:z[0])==null?void 0:E.image_url)||_.image_url}}))||[];console.log("Transformed cars:",D),n(D)}catch(R){console.error("Error in fetchHostCars:",R)}finally{m(!1)}},u=h=>h?U.storage.from("car-images").getPublicUrl(h).data.publicUrl:"/placeholder.svg",j=()=>t!=null&&t.avatar_url?U.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",c=h=>{p(`/cars/${h}`),r()};return s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:r}),e.jsx("div",{className:"fixed left-0 top-0 h-full w-80 bg-background border-r shadow-xl z-50 transform transition-transform duration-300",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Host's Cars"}),e.jsx(L,{variant:"ghost",size:"sm",onClick:r,children:e.jsx(xe,{className:"w-4 h-4"})})]}),t&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:j(),alt:t.full_name||"Host",className:"w-10 h-10 rounded-full object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ke,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32 reviews)"})]})]})]})]}),e.jsx(qe,{className:"flex-1",children:e.jsx("div",{className:"p-4 space-y-4",children:o?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."})}):a.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(tt,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No available cars"})]}):a.map(h=>e.jsx(O,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>c(h.id),children:e.jsxs(q,{className:"p-3",children:[e.jsx("div",{className:"aspect-video w-full mb-3 rounded-lg overflow-hidden bg-muted",children:e.jsx("img",{src:u(h.image_url),alt:`${h.brand} ${h.model}`,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm",children:[h.brand," ",h.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:h.year})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-sm",children:["P",h.price_per_day]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"per day"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(je,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:h.location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(ee,{variant:"secondary",className:"text-xs px-2 py-1",children:h.vehicle_type}),e.jsxs("span",{className:"text-muted-foreground",children:[h.seats," seats"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:h.transmission})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ke,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.5 (12)"})]})]})]})},h.id))})})]})})]}):null},ys=({mapbox_token:s,longitude:r,latitude:t,onlineHosts:a,mapStyle:n="mapbox://styles/mapbox/streets-v12",isHandoverMode:o=!1,bookingId:m,zoom:p,interactive:i,dpad:u,locationToggle:j,destination:c,returnLocation:h})=>{const R=f.useRef(null),d=f.useRef(null),x=f.useRef(null),[g,y]=f.useState(!1),[N,D]=f.useState({latitude:t,longitude:r}),[_,H]=f.useState([]),[I,z]=f.useState([]),[E,$]=f.useState(null),[k,S]=f.useState(!1),P=Ke(),M=o?P:null;f.useEffect(()=>{if(!h)return;const v=N.longitude,w=N.latitude;h(v,w)},[N]),f.useEffect(()=>{if(s&&(V.accessToken=s),!d.current&&R.current&&s){d.current=new V.Map({container:R.current,style:n,center:[r,t],zoom:p||14,interactive:i||!0}),d.current.addControl(new V.NavigationControl,"top-right");const v=new V.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});d.current.addControl(v,"top-right"),x.current=v,v.on("error",w=>{console.error("Geolocation error:",w),me.error("Unable to access your location. Please check your browser permissions."),o&&M&&me.error("Location sharing is required for the handover process. Please enable location access.")}),d.current.on("load",()=>{console.log("Map loaded successfully"),y(!0),x.current&&x.current.on("geolocate",w=>{console.log("Geolocate event fired:",w.coords);const l={longitude:w.coords.longitude,latitude:w.coords.latitude};D(l),console.log("User location updated:",l),o&&M&&(console.log("In handover mode, updating handover location..."),F(l.latitude,l.longitude).then(b=>{console.log("Address fetched:",b),M.updateLocation({latitude:l.latitude,longitude:l.longitude,address:b||"Unknown location"})}))}),setTimeout(()=>{x.current&&x.current.trigger()},1e3)}),d.current.on("error",w=>{console.error("Map error:",w),me.error("Error loading map. Please refresh.")}),h&&d.current.on("click",w=>{console.log("Map clicked at coordinates:",w.lngLat),h(w.lngLat.lng,w.lngLat.lat)})}return()=>{d.current&&(d.current.remove(),d.current=null)}},[s,r,t,n,o,M]);const F=async(v,w)=>{try{const b=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${w},${v}.json?access_token=${s}`)).json();return b.features&&b.features.length>0?b.features[0].place_name:null}catch(l){return console.error("Error fetching address:",l),null}};f.useEffect(()=>{d.current&&g&&d.current.setStyle(n)},[n,g]);const K=v=>{console.log("Trying to view cars for host:",v);const w=a==null?void 0:a.find(l=>l.id===v);if(console.log("Found host:",w),w){const l={id:w.id,full_name:w.full_name,avatar_url:w.avatar_url,latitude:w.latitude,longitude:w.longitude,updated_at:w.updated_at};console.log("Setting selected host:",l),$(l),S(!0)}else console.log("No host found with ID:",v)},X=v=>{if(!d.current||!g||!N.latitude||!N.longitude)return;(async()=>{try{const b=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${N.longitude},${N.latitude};${v.longitude},${v.latitude}?geometries=geojson&access_token=${V.accessToken}`)).json();if(b.routes&&b.routes.length>0){const T=b.routes[0].geometry;d.current.getSource("host-route")?d.current.getSource("host-route").setData(T):(d.current.addSource("host-route",{type:"geojson",data:T}),d.current.addLayer({id:"host-route",type:"line",source:"host-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":v.isActiveHandover?"#ef4444":"#3b82f6","line-width":v.isActiveHandover?6:4}}));const B=new V.LngLatBounds().extend([N.longitude,N.latitude]).extend([v.longitude,v.latitude]);d.current.fitBounds(B,{padding:50,maxZoom:15})}}catch(l){console.error("Error fetching route to host:",l),me.error("Unable to calculate route")}})()};f.useEffect(()=>{if(!d.current||!g||!(a!=null&&a.length))return;_.forEach(l=>l.remove()),H([]);const v=a.map(l=>{if(!l.latitude||!l.longitude)return null;const b=document.createElement("div");b.className="host-marker",b.style.width=l.isActiveHandover?"24px":"20px",b.style.height=l.isActiveHandover?"24px":"20px",b.style.borderRadius="50%",b.style.backgroundColor=l.isActiveHandover?"#ef4444":"#4ade80",b.style.border=l.isActiveHandover?"3px solid white":"2px solid white",b.style.boxShadow=l.isActiveHandover?"0 0 15px rgba(239, 68, 68, 0.5)":"0 0 10px rgba(0, 0, 0, 0.3)",b.style.cursor="pointer",l.isActiveHandover&&(b.style.animation="pulse 2s infinite");const T=document.createElement("div"),B=new V.Marker(b).setLngLat([l.longitude,l.latitude]).addTo(d.current);return b.addEventListener("mouseenter",()=>{_t.render(e.jsx(xs,{host:l,onViewCars:K}),T);const Y=new V.Popup({offset:25,closeButton:!1,closeOnClick:!1,className:"host-popup"}).setDOMContent(T).addTo(d.current);B.setPopup(Y),Y.addTo(d.current)}),b.addEventListener("mouseleave",()=>{setTimeout(()=>{const Y=B.getPopup();Y&&Y.remove()},100)}),b.addEventListener("click",()=>{K(l.id),d.current&&g&&(async()=>{try{const A=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${N.longitude},${N.latitude};${l.longitude},${l.latitude}?geometries=geojson&access_token=${V.accessToken}`)).json();if(A.routes&&A.routes.length>0){const G=A.routes[0].geometry;d.current.getSource("route")?d.current.getSource("route").setData(G):(d.current.addSource("route",{type:"geojson",data:G}),d.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}));const J=new V.LngLatBounds().extend([N.longitude,N.latitude]).extend([l.longitude,l.latitude]);d.current.fitBounds(J,{padding:50,maxZoom:15})}}catch(oe){console.error("Error fetching route to host:",oe),me.error("Unable to calculate route")}})()}),B}).filter(Boolean);H(v);const w=a==null?void 0:a.find(l=>l.isActiveHandover);w&&N.latitude&&N.longitude&&setTimeout(()=>{X(w)},1e3)},[a,g,o,N]),f.useEffect(()=>{if(!d.current||!g||!c)return;const{latitude:v,longitude:w}=c,l=document.createElement("div");l.className="destination-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#f59e0b",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const b=new V.Marker(l).setLngLat([w,v]).setPopup(new V.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(d.current);return()=>{b.remove()}}),f.useEffect(()=>{if(!d.current||!g||!c)return;const{latitude:v,longitude:w}=c;return(async()=>{try{const T=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${N.longitude},${N.latitude};${w},${v}?geometries=geojson&access_token=${V.accessToken}`)).json();if(T.routes&&T.routes.length>0){const B=T.routes[0].geometry;d.current.getSource("route")?d.current.getSource("route").setData(B):(d.current.addSource("route",{type:"geojson",data:B}),d.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(b){console.error("Error fetching route:",b)}})(),()=>{d.current&&(d.current.getStyle()&&d.current.getLayer("route")&&d.current.removeLayer("route"),d.current.getStyle()&&d.current.getSource("route")&&d.current.removeSource("route"))}},[g,c,N]),f.useEffect(()=>{if(!d.current||!g||!o||!(M!=null&&M.handoverStatus))return;I.forEach(w=>w.remove()),z([]);const v=[];if(M.handoverStatus.host_location){const w=M.handoverStatus.host_location,l=document.createElement("div");l.className="host-handover-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#3b82f6",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const b=new V.Marker(l).setLngLat([w.longitude,w.latitude]).setPopup(new V.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${w.address}</p>`)).addTo(d.current);v.push(b)}if(M.handoverStatus.renter_location){const w=M.handoverStatus.renter_location,l=document.createElement("div");l.className="renter-handover-marker",l.style.width="24px",l.style.height="24px",l.style.borderRadius="50%",l.style.backgroundColor="#ec4899",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const b=new V.Marker(l).setLngLat([w.longitude,w.latitude]).setPopup(new V.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${w.address}</p>`)).addTo(d.current);v.push(b)}if(v.length===2&&d.current){const w=new V.LngLatBounds;v.forEach(l=>{w.extend(l.getLngLat())}),d.current.fitBounds(w,{padding:100,maxZoom:15})}z(v)},[M==null?void 0:M.handoverStatus,g,o]);const W=()=>{d.current&&d.current.panBy([0,-100],{duration:500})},Q=()=>{d.current&&d.current.panBy([0,100],{duration:500})},Z=()=>{d.current&&d.current.panBy([-100,0],{duration:500})},le=()=>{d.current&&d.current.panBy([100,0],{duration:500})},ce=()=>{d.current&&d.current.flyTo({center:[N.longitude,N.latitude],zoom:20,essential:!0})};return e.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[e.jsx("div",{ref:R,className:"w-full h-full"}),!o&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:j&&e.jsx(es,{lat:N.latitude,long:N.longitude})})}),o&&(M==null?void 0:M.handoverStatus)&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm font-medium",children:[M.isHost?"Host":"Renter"," Mode"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:M.handoverStatus.host_location&&M.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),u&&e.jsx(ps,{onUp:W,onDown:Q,onLeft:Z,onRight:le,onReset:ce}),e.jsx(vs,{isOpen:k,onClose:()=>S(!1),host:E})]})},js=async()=>{try{const{data:s,error:r}=await U.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(r)return console.error("Error checking location columns:",r),!1;if(!s||s.length===0)return console.error("No profiles found to check columns"),!1;const t=s[0];return t?"latitude"in t&&"longitude"in t&&"is_sharing_location"in t:!1}catch(s){return console.error("Error in checkLocationColumns:",s),!1}},ws=s=>!s||typeof s!="object"?null:{id:typeof s.id=="string"?s.id:"",full_name:s.full_name||null,avatar_url:s.avatar_url||null,latitude:typeof s.latitude=="number"?s.latitude:null,longitude:typeof s.longitude=="number"?s.longitude:null,updated_at:s.updated_at||null},bs=async()=>{try{if(console.log("Fetching online hosts..."),!await js())return console.error("Required location columns don't exist in profiles table"),[];const{data:r,error:t}=await U.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(t)return console.error("Error fetching online hosts:",t),[];if(!r||!Array.isArray(r))return console.error("Expected array of hosts but got:",r),[];console.log(`Found ${r.length} online hosts`);const a=[];for(const n of r){const o=ws(n);o&&a.push(o)}return a}catch(s){return console.error("Error in fetchOnlineHosts:",s),[]}},Ns={maxWidth:1920,maxHeight:1080,quality:.8,maxSizeKB:1024},at=async(s,r={})=>{const t={...Ns,...r};return s.size<=t.maxSizeKB*1024?s:new Promise((a,n)=>{const o=document.createElement("canvas"),m=o.getContext("2d"),p=new Image;p.onload=()=>{try{const{width:u,height:j}=_s(p.width,p.height,t.maxWidth,t.maxHeight);o.width=u,o.height=j,m.drawImage(p,0,0,u,j),o.toBlob(c=>{if(!c){n(new Error("Failed to compress image"));return}const h=new File([c],s.name,{type:c.type||s.type,lastModified:Date.now()});if(h.size>t.maxSizeKB*1024&&t.quality>.3){const R={...t,quality:Math.max(.3,t.quality-.2)};at(s,R).then(a).catch(n)}else a(h)},s.type.startsWith("image/")?s.type:"image/jpeg",t.quality)}catch(u){n(u)}},p.onerror=()=>{n(new Error("Failed to load image"))};const i=URL.createObjectURL(s);p.src=i,p.onload=()=>{URL.revokeObjectURL(i),p.onload()}})},_s=(s,r,t,a)=>{let{width:n,height:o}={width:s,height:r};return n>t&&(o=o*t/n,n=t),o>a&&(n=n*a/o,o=a),{width:Math.round(n),height:Math.round(o)}},_e=s=>{if(s===0)return"0 Bytes";const r=1024,t=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(s)/Math.log(r));return parseFloat((s/Math.pow(r,a)).toFixed(2))+" "+t[a]},Ss=s=>s.type.startsWith("image/"),pe=[{name:"navigation",order:1,title:"Navigate to Location",description:"Get directions to the handover location"},{name:"identity_verification",order:2,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:3,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:4,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:5,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:6,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:7,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:8,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:9,title:"Handover Complete",description:"Finalize the handover process"}],ks=async s=>{try{const{data:r}=await U.from("handover_step_completion").select("id").eq("handover_session_id",s);if(r&&r.length>0)return!0;const t=pe.map(n=>({handover_session_id:s,step_name:n.name,step_order:n.order,is_completed:!1})),{error:a}=await U.from("handover_step_completion").insert(t);if(a)throw a;return!0}catch(r){return console.error("Error initializing handover steps:",r),C.error("Failed to initialize handover steps"),!1}},Fe=async s=>{try{const{data:r,error:t}=await U.from("handover_step_completion").select("*").eq("handover_session_id",s).order("step_order");if(t)throw t;return r||[]}catch(r){return console.error("Error fetching handover steps:",r),[]}},Cs=async(s,r,t)=>{var a;try{const{data:n}=await U.auth.getUser();if(!((a=n==null?void 0:n.user)!=null&&a.id))throw new Error("User not authenticated");const{data:o,error:m}=await U.from("handover_step_completion").select("step_order, is_completed").eq("handover_session_id",s).eq("step_name",r).single();if(m)throw new Error(`Step lookup failed: ${m.message}`);if(!o)throw new Error("Step not found");if(o.is_completed)return C.info(`${r.replace("_"," ")} is already completed`),!0;const p=await Rs(s,r,t);if(!p.isValid)return C.error(p.message),!1;const i={is_completed:!0,completed_by:n.user.id,completion_data:t,completed_at:new Date().toISOString()},{error:u}=await U.from("handover_step_completion").update(i).eq("handover_session_id",s).eq("step_name",r);if(u){if(u.message.includes("Previous steps must be completed"))C.error("Please complete previous steps first");else throw console.error("Database update error:",u),u;return!1}return C.success(`${r.replace("_"," ")} completed`),!0}catch(n){return console.error(`Error completing handover step ${r}:`,n),n.message.includes("Previous steps must be completed")?C.error("Please complete previous steps in order"):C.error(`Failed to complete handover step: ${n.message}`),!1}},Rs=async(s,r,t)=>{switch(r){case"fuel_mileage_check":if(!(t!=null&&t.fuel_level)||!(t!=null&&t.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};const a=Number(t.fuel_level);if(a<0||a>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(Number(t.mileage)<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(t!=null&&t.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},Pe=async(s,r,t,a=3,n)=>{var m;let o=0;for(;o<a;)try{const{data:p}=await U.auth.getUser();if(!((m=p==null?void 0:p.user)!=null&&m.id))throw new Error("User not authenticated");n==null||n(10);let i=s;if(Ss(s)&&s.size>500*1024){const d=_e(s.size);try{i=await at(s,{maxWidth:1920,maxHeight:1080,quality:.8,maxSizeKB:1024});const x=_e(i.size),g=((s.size-i.size)/s.size*100).toFixed(1);console.log(`Image compressed: ${d} → ${x} (${g}% reduction)`),C.success(`Image optimized: ${g}% smaller`)}catch(x){console.warn("Image compression failed, uploading original:",x),C.info("Uploading original image (compression failed)"),i=s}}n==null||n(30);const u=i.name.split(".").pop(),j=`${p.user.id}/${r}/${t}_${Date.now()}.${u}`;n==null||n(50);const{error:c}=await U.storage.from("handover-photos").upload(j,i);if(c)throw c;n==null||n(80);const{data:{publicUrl:h}}=U.storage.from("handover-photos").getPublicUrl(j);n==null||n(100);const R=_e(i.size);return C.success(`Photo uploaded successfully (${R})`),h}catch(p){if(o++,console.error(`Photo upload attempt ${o} failed:`,p),o>=a)return C.error("Failed to upload photo after multiple attempts"),n==null||n(0),null;C.info(`Upload failed, retrying... (${o}/${a})`),n==null||n(0),await new Promise(i=>setTimeout(i,1e3*o))}return null},Es=async s=>{var r;try{const{data:t}=await U.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const a={handover_session_id:s.handover_session_id,booking_id:s.booking_id,car_id:s.car_id,report_type:s.report_type,vehicle_photos:JSON.stringify(s.vehicle_photos),damage_reports:JSON.stringify(s.damage_reports),fuel_level:s.fuel_level,mileage:s.mileage,exterior_condition_notes:s.exterior_condition_notes,interior_condition_notes:s.interior_condition_notes,additional_notes:s.additional_notes,digital_signature_data:s.digital_signature_data,is_acknowledged:s.is_acknowledged,reporter_id:s.reporter_id||t.user.id},{data:n,error:o}=await U.from("vehicle_condition_reports").insert(a).select().single();if(o)throw o;return n}catch(t){return console.error("Error creating vehicle condition report:",t),C.error("Failed to create condition report"),null}},Ms=async s=>{var r;try{const{data:t}=await U.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const a={handover_session_id:s.handover_session_id,verifier_id:t.user.id,verified_user_id:s.verified_user_id,verification_photo_url:s.verification_photo_url,license_photo_url:s.license_photo_url,verification_status:s.verification_status,verification_notes:s.verification_notes},{data:n,error:o}=await U.from("identity_verification_checks").insert(a).select().single();if(o)throw o;return n}catch(t){return console.error("Error creating identity verification check:",t),C.error("Failed to create identity verification"),null}},Ds=({handoverSessionId:s,otherUserId:r,otherUserName:t,isHost:a,onStepComplete:n})=>{const[o,m]=f.useState(null),[p,i]=f.useState(!1),[u,j]=f.useState(0),[c,h]=f.useState("pending"),[R,d]=f.useState(""),[x,g]=f.useState(!1),y=async D=>{var H;const _=(H=D.target.files)==null?void 0:H[0];if(_){i(!0),j(0);try{const I=await Pe(_,s,"identity_verification",3,z=>j(z));I&&(m(I),await Ms({handover_session_id:s,verifier_id:"",verified_user_id:r,verification_photo_url:I,verification_status:"pending"}))}catch{C.error("Failed to upload verification photo")}finally{i(!1),j(0)}}},N=async D=>{g(!0);try{h(D),D==="verified"?(C.success(`${t}'s identity verified successfully`),n()):C.error("Identity verification failed")}catch{C.error("Failed to update verification status")}finally{g(!1)}};return e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",t,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx(q,{className:"space-y-4",children:o?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:o,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(ee,{variant:c==="verified"?"default":c==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[c==="verified"&&e.jsx(Se,{className:"h-3 w-3 mr-1"}),c==="failed"&&e.jsx(xe,{className:"h-3 w-3 mr-1"}),c.charAt(0).toUpperCase()+c.slice(1)]})]}),c==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(Ge,{placeholder:"Add any notes about the verification...",value:R,onChange:D=>d(D.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(L,{onClick:()=>N("verified"),disabled:x,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(L,{onClick:()=>N("failed"),disabled:x,variant:"destructive",className:"flex-1",children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),c==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),c==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(he,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",t," for identity verification"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:y,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:p}),e.jsx(L,{disabled:p,className:"flex items-center gap-2",children:p?e.jsxs(e.Fragment,{children:[e.jsx(st,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(he,{className:"h-4 w-4"}),"Take Photo"]})})]}),p&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(fe,{value:u,className:"w-full"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:u<30?"Optimizing image...":u<80?"Uploading...":"Finalizing..."})]})]})]})})]})},Is={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},ze=({handoverSessionId:s,inspectionType:r,onPhotosUpdate:t,onStepComplete:a,initialPhotos:n=[]})=>{const[o,m]=f.useState(n),[p,i]=f.useState(!1),[u,j]=f.useState(null),[c,h]=f.useState({}),R=f.useRef({}),d=Is[r],x=d.filter(E=>E.required),g=x.filter(E=>o.some($=>$.type===E.type)),y=async(E,$)=>{i(!0),j(E),h(k=>({...k,[E]:0}));try{const k=await Pe($,s,E,3,S=>h(P=>({...P,[E]:S})));if(k){const S={id:`${Date.now()}-${E}`,type:E,url:k,timestamp:new Date().toISOString()},P=[...o,S];m(P),t(P)}}catch{C.error("Failed to upload photo")}finally{i(!1),j(null),h(k=>({...k,[E]:0}))}},N=E=>{const $=R.current[E];$&&(j(E),$.click())},D=(E,$)=>{var S;const k=(S=E.target.files)==null?void 0:S[0];k&&y($,k),E.target.value=""},_=E=>{const $=o.filter(k=>k.id!==E);m($),t($)},H=E=>o.find($=>$.type===E),I=g.length===x.length,z=()=>{I&&(a(),C.success(`${r} inspection completed`))};return e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),r==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(ee,{variant:I?"default":"secondary",children:[g.length,"/",x.length," Required Photos"]})})]}),e.jsxs(q,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:d.map(E=>{const $=H(E.type),k=u===E.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:E.label}),E.required&&e.jsx(ee,{variant:"outline",className:"text-xs",children:"Required"})]}),$?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:$.url,alt:E.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(L,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>_($.id),children:e.jsx(We,{className:"h-4 w-4"})})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>N(E.type),children:[e.jsx("input",{ref:S=>R.current[E.type]=S,type:"file",accept:"image/*",capture:"environment",onChange:S=>D(S,E.type),className:"hidden"}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full p-2",children:k&&u===E.type?e.jsxs("div",{className:"w-full space-y-2",children:[e.jsx(st,{className:"h-6 w-6 animate-spin text-gray-400 mx-auto"}),e.jsx(fe,{value:c[E.type]||0,className:"w-full h-2"}),e.jsx("span",{className:"text-xs text-gray-500 text-center block",children:(c[E.type]||0)<30?"Optimizing...":(c[E.type]||0)<80?"Uploading...":"Finalizing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})]},E.type)})}),I&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(L,{onClick:z,className:"w-full",children:["Complete ",r==="exterior"?"Exterior":"Interior"," Inspection"]})}),!I&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},Ps=({handoverSessionId:s,onDamageReportsUpdate:r,onStepComplete:t,initialReports:a=[]})=>{const[n,o]=f.useState(a),[m,p]=f.useState(!1),[i,u]=f.useState({location:"",severity:"minor",description:"",photos:[]}),[j,c]=f.useState(!1),h=async g=>{c(!0);try{const y=await Pe(g,s,"damage_specific");y&&(u(N=>({...N,photos:[...N.photos,y]})),C.success("Damage photo uploaded"))}catch{C.error("Failed to upload damage photo")}finally{c(!1)}},R=()=>{if(!i.location||!i.description){C.error("Please fill in location and description");return}const g={id:`damage-${Date.now()}`,location:i.location,severity:i.severity,description:i.description,photos:i.photos,timestamp:new Date().toISOString()},y=[...n,g];o(y),r(y),u({location:"",severity:"minor",description:"",photos:[]}),p(!1),C.success("Damage report added")},d=g=>{const y=n.filter(N=>N.id!==g);o(y),r(y)},x=g=>{switch(g){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs(q,{className:"space-y-4",children:[n.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",n.length,")"]}),n.map(g=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:g.location}),e.jsx(ee,{className:`ml-2 ${x(g.severity)}`,children:g.severity})]}),e.jsx(L,{size:"sm",variant:"outline",onClick:()=>d(g.id),children:e.jsx(We,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:g.description}),g.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:g.photos.map((y,N)=>e.jsx("img",{src:y,alt:`Damage ${N+1}`,className:"w-full h-20 object-cover rounded"},N))})]},g.id))]}),m?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(Qe,{placeholder:"e.g., Front bumper, Driver door",value:i.location,onChange:g=>u(y=>({...y,location:g.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(Et,{value:i.severity,onValueChange:g=>u(y=>({...y,severity:g})),children:[e.jsx(Mt,{children:e.jsx(Dt,{})}),e.jsxs(It,{children:[e.jsx(be,{value:"minor",children:"Minor"}),e.jsx(be,{value:"moderate",children:"Moderate"}),e.jsx(be,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(Ge,{placeholder:"Describe the damage in detail...",value:i.description,onChange:g=>u(y=>({...y,description:g.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[i.photos.map((g,y)=>e.jsx("img",{src:g,alt:`Damage photo ${y+1}`,className:"w-full h-20 object-cover rounded"},y)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:g=>{var N;const y=(N=g.target.files)==null?void 0:N[0];y&&h(y)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:j}),e.jsx(he,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(L,{onClick:R,className:"flex-1",children:"Save Damage Report"}),e.jsx(L,{variant:"outline",onClick:()=>p(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(L,{onClick:()=>p(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx(Ye,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(L,{onClick:t,className:"w-full",children:n.length>0?`Complete Documentation (${n.length} damage reports)`:"No Damage - Complete Step"})})]})]})};var ot=["PageUp","PageDown"],nt=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],it={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},ue="Slider",[Re,Ts,Hs]=Ht(ue),[lt,Or]=Tt(ue,[Hs]),[Ls,we]=lt(ue),ct=f.forwardRef((s,r)=>{const{name:t,min:a=0,max:n=100,step:o=1,orientation:m="horizontal",disabled:p=!1,minStepsBetweenThumbs:i=0,defaultValue:u=[a],value:j,onValueChange:c=()=>{},onValueCommit:h=()=>{},inverted:R=!1,form:d,...x}=s,g=f.useRef(new Set),y=f.useRef(0),D=m==="horizontal"?$s:As,[_=[],H]=Pt({prop:j,defaultProp:u,onChange:S=>{var M;(M=[...g.current][y.current])==null||M.focus(),c(S)}}),I=f.useRef(_);function z(S){const P=Vs(_,S);k(S,P)}function E(S){k(S,y.current)}function $(){const S=I.current[y.current];_[y.current]!==S&&h(_)}function k(S,P,{commit:M}={commit:!1}){const F=Gs(o),K=Ws(Math.round((S-a)/o)*o+a,F),X=Je(K,[a,n]);H((W=[])=>{const Q=zs(W,X,P);if(Ks(Q,i*o)){y.current=Q.indexOf(X);const Z=String(Q)!==String(W);return Z&&M&&h(Q),Z?Q:W}else return W})}return e.jsx(Ls,{scope:s.__scopeSlider,name:t,disabled:p,min:a,max:n,valueIndexToChangeRef:y,thumbs:g.current,values:_,orientation:m,form:d,children:e.jsx(Re.Provider,{scope:s.__scopeSlider,children:e.jsx(Re.Slot,{scope:s.__scopeSlider,children:e.jsx(D,{"aria-disabled":p,"data-disabled":p?"":void 0,...x,ref:r,onPointerDown:de(x.onPointerDown,()=>{p||(I.current=_)}),min:a,max:n,inverted:R,onSlideStart:p?void 0:z,onSlideMove:p?void 0:E,onSlideEnd:p?void 0:$,onHomeKeyDown:()=>!p&&k(a,0,{commit:!0}),onEndKeyDown:()=>!p&&k(n,_.length-1,{commit:!0}),onStepKeyDown:({event:S,direction:P})=>{if(!p){const K=ot.includes(S.key)||S.shiftKey&&nt.includes(S.key)?10:1,X=y.current,W=_[X],Q=o*K*P;k(W+Q,X,{commit:!0})}}})})})})});ct.displayName=ue;var[dt,ut]=lt(ue,{startEdge:"left",endEdge:"right",size:"width",direction:1}),$s=f.forwardRef((s,r)=>{const{min:t,max:a,dir:n,inverted:o,onSlideStart:m,onSlideMove:p,onSlideEnd:i,onStepKeyDown:u,...j}=s,[c,h]=f.useState(null),R=ge(r,D=>h(D)),d=f.useRef(),x=Lt(n),g=x==="ltr",y=g&&!o||!g&&o;function N(D){const _=d.current||c.getBoundingClientRect(),H=[0,_.width],z=Te(H,y?[t,a]:[a,t]);return d.current=_,z(D-_.left)}return e.jsx(dt,{scope:s.__scopeSlider,startEdge:y?"left":"right",endEdge:y?"right":"left",direction:y?1:-1,size:"width",children:e.jsx(mt,{dir:x,"data-orientation":"horizontal",...j,ref:R,style:{...j.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:D=>{const _=N(D.clientX);m==null||m(_)},onSlideMove:D=>{const _=N(D.clientX);p==null||p(_)},onSlideEnd:()=>{d.current=void 0,i==null||i()},onStepKeyDown:D=>{const H=it[y?"from-left":"from-right"].includes(D.key);u==null||u({event:D,direction:H?-1:1})}})})}),As=f.forwardRef((s,r)=>{const{min:t,max:a,inverted:n,onSlideStart:o,onSlideMove:m,onSlideEnd:p,onStepKeyDown:i,...u}=s,j=f.useRef(null),c=ge(r,j),h=f.useRef(),R=!n;function d(x){const g=h.current||j.current.getBoundingClientRect(),y=[0,g.height],D=Te(y,R?[a,t]:[t,a]);return h.current=g,D(x-g.top)}return e.jsx(dt,{scope:s.__scopeSlider,startEdge:R?"bottom":"top",endEdge:R?"top":"bottom",size:"height",direction:R?1:-1,children:e.jsx(mt,{"data-orientation":"vertical",...u,ref:c,style:{...u.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:x=>{const g=d(x.clientY);o==null||o(g)},onSlideMove:x=>{const g=d(x.clientY);m==null||m(g)},onSlideEnd:()=>{h.current=void 0,p==null||p()},onStepKeyDown:x=>{const y=it[R?"from-bottom":"from-top"].includes(x.key);i==null||i({event:x,direction:y?-1:1})}})})}),mt=f.forwardRef((s,r)=>{const{__scopeSlider:t,onSlideStart:a,onSlideMove:n,onSlideEnd:o,onHomeKeyDown:m,onEndKeyDown:p,onStepKeyDown:i,...u}=s,j=we(ue,t);return e.jsx(ye.span,{...u,ref:r,onKeyDown:de(s.onKeyDown,c=>{c.key==="Home"?(m(c),c.preventDefault()):c.key==="End"?(p(c),c.preventDefault()):ot.concat(nt).includes(c.key)&&(i(c),c.preventDefault())}),onPointerDown:de(s.onPointerDown,c=>{const h=c.target;h.setPointerCapture(c.pointerId),c.preventDefault(),j.thumbs.has(h)?h.focus():a(c)}),onPointerMove:de(s.onPointerMove,c=>{c.target.hasPointerCapture(c.pointerId)&&n(c)}),onPointerUp:de(s.onPointerUp,c=>{const h=c.target;h.hasPointerCapture(c.pointerId)&&(h.releasePointerCapture(c.pointerId),o(c))})})}),ht="SliderTrack",ft=f.forwardRef((s,r)=>{const{__scopeSlider:t,...a}=s,n=we(ht,t);return e.jsx(ye.span,{"data-disabled":n.disabled?"":void 0,"data-orientation":n.orientation,...a,ref:r})});ft.displayName=ht;var Ee="SliderRange",gt=f.forwardRef((s,r)=>{const{__scopeSlider:t,...a}=s,n=we(Ee,t),o=ut(Ee,t),m=f.useRef(null),p=ge(r,m),i=n.values.length,u=n.values.map(h=>xt(h,n.min,n.max)),j=i>1?Math.min(...u):0,c=100-Math.max(...u);return e.jsx(ye.span,{"data-orientation":n.orientation,"data-disabled":n.disabled?"":void 0,...a,ref:p,style:{...s.style,[o.startEdge]:j+"%",[o.endEdge]:c+"%"}})});gt.displayName=Ee;var Me="SliderThumb",pt=f.forwardRef((s,r)=>{const t=Ts(s.__scopeSlider),[a,n]=f.useState(null),o=ge(r,p=>n(p)),m=f.useMemo(()=>a?t().findIndex(p=>p.ref.current===a):-1,[t,a]);return e.jsx(Us,{...s,ref:o,index:m})}),Us=f.forwardRef((s,r)=>{const{__scopeSlider:t,index:a,name:n,...o}=s,m=we(Me,t),p=ut(Me,t),[i,u]=f.useState(null),j=ge(r,N=>u(N)),c=i?m.form||!!i.closest("form"):!0,h=$t(i),R=m.values[a],d=R===void 0?0:xt(R,m.min,m.max),x=Bs(a,m.values.length),g=h==null?void 0:h[p.size],y=g?Os(g,d,p.direction):0;return f.useEffect(()=>{if(i)return m.thumbs.add(i),()=>{m.thumbs.delete(i)}},[i,m.thumbs]),e.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[p.startEdge]:`calc(${d}% + ${y}px)`},children:[e.jsx(Re.ItemSlot,{scope:s.__scopeSlider,children:e.jsx(ye.span,{role:"slider","aria-label":s["aria-label"]||x,"aria-valuemin":m.min,"aria-valuenow":R,"aria-valuemax":m.max,"aria-orientation":m.orientation,"data-orientation":m.orientation,"data-disabled":m.disabled?"":void 0,tabIndex:m.disabled?void 0:0,...o,ref:j,style:R===void 0?{display:"none"}:s.style,onFocus:de(s.onFocus,()=>{m.valueIndexToChangeRef.current=a})})}),c&&e.jsx(Fs,{name:n??(m.name?m.name+(m.values.length>1?"[]":""):void 0),form:m.form,value:R},a)]})});pt.displayName=Me;var Fs=s=>{const{value:r,...t}=s,a=f.useRef(null),n=At(r);return f.useEffect(()=>{const o=a.current,m=window.HTMLInputElement.prototype,i=Object.getOwnPropertyDescriptor(m,"value").set;if(n!==r&&i){const u=new Event("input",{bubbles:!0});i.call(o,r),o.dispatchEvent(u)}},[n,r]),e.jsx("input",{style:{display:"none"},...t,ref:a,defaultValue:r})};function zs(s=[],r,t){const a=[...s];return a[t]=r,a.sort((n,o)=>n-o)}function xt(s,r,t){const o=100/(t-r)*(s-r);return Je(o,[0,100])}function Bs(s,r){return r>2?`Value ${s+1} of ${r}`:r===2?["Minimum","Maximum"][s]:void 0}function Vs(s,r){if(s.length===1)return 0;const t=s.map(n=>Math.abs(n-r)),a=Math.min(...t);return t.indexOf(a)}function Os(s,r,t){const a=s/2,o=Te([0,50],[0,a]);return(a-o(r)*t)*t}function qs(s){return s.slice(0,-1).map((r,t)=>s[t+1]-r)}function Ks(s,r){if(r>0){const t=qs(s);return Math.min(...t)>=r}return!0}function Te(s,r){return t=>{if(s[0]===s[1]||r[0]===r[1])return r[0];const a=(r[1]-r[0])/(s[1]-s[0]);return r[0]+a*(t-s[0])}}function Gs(s){return(String(s).split(".")[1]||"").length}function Ws(s,r){const t=Math.pow(10,r);return Math.round(s*t)/t}var vt=ct,Ys=ft,Xs=gt,Qs=pt;const yt=f.forwardRef(({className:s,...r},t)=>e.jsxs(vt,{ref:t,className:Ut("relative flex w-full touch-none select-none items-center",s),...r,children:[e.jsx(Ys,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(Xs,{className:"absolute h-full bg-primary"})}),e.jsx(Qs,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));yt.displayName=vt.displayName;const Js=({handoverSessionId:s,onFuelLevelChange:r,onMileageChange:t,onStepComplete:a,initialFuelLevel:n,initialMileage:o})=>{const[m,p]=f.useState(n||50),[i,u]=f.useState((o==null?void 0:o.toString())||""),j=d=>{const x=d[0];p(x),r(x)},c=d=>{u(d);const x=parseInt(d,10);isNaN(x)||t(x)},h=i!==""&&!isNaN(parseInt(i,10))&&parseInt(i,10)>0,R=()=>{h?(a(),C.success("Fuel level and mileage recorded successfully")):C.error("Please enter a valid mileage reading")};return e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(kt,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Le,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(yt,{value:[m],onValueChange:j,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[m,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${m<=25?"#ef4444":m<=50?"#f59e0b":"#10b981"} 0deg,
                    ${m<=25?"#ef4444":m<=50?"#f59e0b":"#10b981"} ${m/100*360}deg,
                    #e5e7eb ${m/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[m,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Le,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ds,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Qe,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:i,onChange:d=>c(d.target.value),className:"pl-10",min:"0"})]}),i&&!isNaN(parseInt(i,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(i,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[m,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:i?`${parseInt(i,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(L,{onClick:R,disabled:!h,className:"w-full",children:"Complete Fuel & Mileage Check"}),!h&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},Zs=({handoverSessionId:s,otherUserName:r,isHost:t,onStepComplete:a})=>{const[n,o]=f.useState(!1),[m,p]=f.useState(!1),[i,u]=f.useState(!1),j=n&&m&&i,c=()=>{j&&(a(),C.success("Key transfer completed successfully"))};return e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(us,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?`Transfer vehicle keys to ${r}`:`Receive vehicle keys from ${r}`})]}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ne,{id:"key-transferred",checked:n,onCheckedChange:h=>o(h)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:t?`I have handed over the main vehicle key to ${r}`:`I have received the main vehicle key from ${r}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ne,{id:"key-received",checked:m,onCheckedChange:h=>p(h)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:t?`${r} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(Ne,{id:"spares-confirmed",checked:i,onCheckedChange:h=>u(h)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:n&&m?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(L,{onClick:c,disabled:!j,className:"w-full",children:"Complete Key Transfer"}),!j&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},er=({handoverSessionId:s,onSignatureComplete:r,initialSignature:t})=>{const a=f.useRef(null),[n,o]=f.useState(!1),[m,p]=f.useState(!!t),[i,u]=f.useState(t||null),j=x=>{x.preventDefault(),o(!0);const g=a.current;if(!g)return;const y=g.getBoundingClientRect(),N=g.width/y.width,D=g.height/y.height,_=g.getContext("2d");if(!_)return;_.lineWidth=2,_.lineCap="round",_.strokeStyle="#000";let H,I;"touches"in x?(H=(x.touches[0].clientX-y.left)*N,I=(x.touches[0].clientY-y.top)*D):(H=(x.clientX-y.left)*N,I=(x.clientY-y.top)*D),_.beginPath(),_.moveTo(H,I)},c=x=>{if(!n)return;x.preventDefault();const g=a.current,y=g==null?void 0:g.getContext("2d");if(!g||!y)return;const N=g.getBoundingClientRect(),D=g.width/N.width,_=g.height/N.height;let H,I;"touches"in x?(H=(x.touches[0].clientX-N.left)*D,I=(x.touches[0].clientY-N.top)*_):(H=(x.clientX-N.left)*D,I=(x.clientY-N.top)*_),y.lineTo(H,I),y.stroke(),p(!0)},h=()=>{o(!1)},R=()=>{const x=a.current,g=x==null?void 0:x.getContext("2d");!x||!g||(g.clearRect(0,0,x.width,x.height),p(!1),u(null))},d=()=>{const x=a.current;if(!x||!m)return;const g=x.toDataURL("image/png");u(g),r(g),C.success("Digital signature captured successfully")};return f.useState(()=>{if(t&&a.current){const g=a.current.getContext("2d"),y=new Image;y.onload=()=>{g==null||g.drawImage(y,0,0)},y.src=t}}),e.jsxs(O,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:a,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:j,onMouseMove:c,onMouseUp:h,onMouseLeave:h,onTouchStart:j,onTouchMove:c,onTouchEnd:h,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(L,{variant:"outline",onClick:R,disabled:!m,className:"flex-1",children:[e.jsx(ts,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(L,{onClick:d,disabled:!m,className:"flex-1",children:[e.jsx(Se,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),i&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},tr=({currentStep:s,totalDistance:r,totalDuration:t,isNavigating:a,onToggleVoice:n,isVoiceEnabled:o,onStopNavigation:m,onArrived:p,destination:i,showArrivedButton:u=!1})=>{const[j,c]=f.useState("");f.useEffect(()=>{if(t>0){const d=new Date(Date.now()+t*1e3);c(d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))}},[t]);const h=d=>d<1e3?`${Math.round(d)}m`:`${(d/1e3).toFixed(1)}km`,R=d=>{const x=Math.floor(d/60);if(x<1)return"< 1 min";if(x<60)return`${x} min`;const g=Math.floor(x/60),y=x%60;return`${g}h ${y}m`};return!a||!s?null:e.jsx(O,{className:"mx-4 mt-4 shadow-lg border-primary/20",children:e.jsxs(q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(je,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["To ",i]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{variant:"ghost",size:"sm",onClick:n,className:"h-8 w-8 p-0",children:o?e.jsx(fs,{className:"h-4 w-4"}):e.jsx(gs,{className:"h-4 w-4"})}),e.jsx(L,{variant:"outline",size:"sm",onClick:m,className:"text-xs",children:"Stop"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg mt-1",children:e.jsx(Ce,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground mb-1",children:s.instruction}),s.road_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["on ",s.road_name]}),e.jsx("div",{className:"flex items-center space-x-1 mt-2",children:e.jsx(ee,{variant:"secondary",className:"text-xs",children:h(s.distance)})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(rt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:R(t)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"text-muted-foreground",children:h(r)})}),j&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Ie,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-muted-foreground",children:["ETA ",j]})]})]}),u&&p&&e.jsx("div",{className:"mt-4 pt-4 border-t border-muted",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Used alternative navigation or already arrived?"}),e.jsx(L,{onClick:p,className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:"I've Arrived"})]})})]})})},sr=({steps:s,currentStepIndex:r,onStepClick:t,className:a=""})=>{const n=i=>i<1e3?`${Math.round(i)}m`:`${(i/1e3).toFixed(1)}km`,o=i=>i===0?e.jsx(je,{className:"h-4 w-4"}):i===s.length-1?e.jsx(ss,{className:"h-4 w-4"}):e.jsx(Ce,{className:"h-4 w-4"}),m=i=>i<r?"text-muted-foreground":i===r?"text-primary":"text-foreground",p=i=>i<r?"bg-muted/50":i===r?"bg-primary/10 border-primary/20":"bg-background";return e.jsxs(O,{className:a,children:[e.jsx(re,{className:"pb-3",children:e.jsxs(ae,{className:"text-lg flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"Turn-by-Turn Directions"]})}),e.jsx(q,{className:"p-0",children:e.jsx(qe,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-2 p-4",children:s.map((i,u)=>e.jsxs("div",{className:`
                  flex items-start space-x-3 p-3 rounded-lg border transition-all
                  ${p(u)}
                  ${t?"cursor-pointer hover:bg-muted/30":""}
                  ${u===r?"border-primary/20":"border-transparent"}
                `,onClick:()=>t==null?void 0:t(u),children:[e.jsx("div",{className:`mt-1 ${m(u)}`,children:o(u)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-medium ${m(u)}`,children:i.instruction}),i.road_name&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["on ",i.road_name]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-2",children:[e.jsx(ee,{variant:"secondary",className:"text-xs shrink-0",children:n(i.distance)}),u===r&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"})]})]})}),t&&e.jsx(Ft,{className:"h-4 w-4 text-muted-foreground mt-1"})]},u))})})})]})},rr=()=>{const[s,r]=f.useState(null),[t,a]=f.useState(!1),[n,o]=f.useState(null);return{userLocation:s,isTracking:t,error:n,startTracking:()=>{if(!navigator.geolocation){const c="Geolocation is not supported by this browser";o(c),C.error(c);return}a(!0),o(null);const u={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4},j=navigator.geolocation.watchPosition(c=>{const h={latitude:c.coords.latitude,longitude:c.coords.longitude,accuracy:c.coords.accuracy};r(h),o(null)},c=>{let h="Failed to get location";switch(c.code){case c.PERMISSION_DENIED:h="Location access denied. Please enable location permissions.";break;case c.POSITION_UNAVAILABLE:h="Location information is unavailable.";break;case c.TIMEOUT:h="Location request timed out.";break}o(h),C.error(h),a(!1)},u);return()=>{navigator.geolocation.clearWatch(j),a(!1)}},stopTracking:()=>{a(!1),r(null),o(null)},getCurrentLocation:()=>new Promise((u,j)=>{if(!navigator.geolocation){j(new Error("Geolocation is not supported"));return}navigator.geolocation.getCurrentPosition(c=>{const h={latitude:c.coords.latitude,longitude:c.coords.longitude,accuracy:c.coords.accuracy};u(h)},c=>{let h="Failed to get location";switch(c.code){case c.PERMISSION_DENIED:h="Location access denied";break;case c.POSITION_UNAVAILABLE:h="Location information unavailable";break;case c.TIMEOUT:h="Location request timed out";break}j(new Error(h))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}},ie=class ie{constructor(){ne(this,"mapboxToken",null)}static getInstance(){return ie.instance||(ie.instance=new ie),ie.instance}async initialize(){try{return this.mapboxToken=await Ze(),!!this.mapboxToken}catch(r){return console.error("Failed to initialize navigation service:",r),C.error("Navigation service unavailable"),!1}}async getRoute(r){if(!this.mapboxToken&&(await this.initialize(),!this.mapboxToken))throw new Error("Navigation service not initialized");const{origin:t,destination:a,profile:n="driving"}=r;try{const o=await fetch(`https://api.mapbox.com/directions/v5/mapbox/${n}/${t.longitude},${t.latitude};${a.longitude},${a.latitude}?steps=true&geometries=geojson&overview=full&access_token=${this.mapboxToken}`),m=await o.json();if(!o.ok)throw new Error(m.message||"Failed to get route");if(!m.routes||m.routes.length===0)throw new Error("No route found");const p=m.routes[0];return{geometry:p.geometry,distance:p.distance,duration:p.duration,steps:p.legs[0].steps.map(i=>({instruction:i.maneuver.instruction,distance:i.distance,duration:i.duration,maneuver:i.maneuver.type,road_name:i.name,geometry:i.geometry}))}}catch(o){return console.error("Error fetching route:",o),C.error("Unable to calculate route"),null}}async getDirections(r,t){const a=await this.getRoute({origin:r,destination:t});return(a==null?void 0:a.steps)||[]}calculateDistance(r,t,a,n){const m=r*Math.PI/180,p=a*Math.PI/180,i=(a-r)*Math.PI/180,u=(n-t)*Math.PI/180,j=Math.sin(i/2)*Math.sin(i/2)+Math.cos(m)*Math.cos(p)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(j),Math.sqrt(1-j)))}formatDistance(r){return r<1e3?`${Math.round(r)}m`:`${(r/1e3).toFixed(1)}km`}formatDuration(r){const t=Math.floor(r/60);if(t<1)return"< 1 min";if(t<60)return`${t} min`;const a=Math.floor(t/60),n=t%60;return`${a}h ${n}m`}};ne(ie,"instance");let De=ie;const Be=De.getInstance(),ar=({handoverSessionId:s,destinationLocation:r,otherUserName:t,isHost:a,onStepComplete:n,onNavigationStart:o})=>{const{userLocation:m,getCurrentLocation:p}=rr(),[i,u]=f.useState(!1),[j,c]=f.useState(!1),[h,R]=f.useState([]),[d,x]=f.useState(0),[g,y]=f.useState(0),[N,D]=f.useState(0),[_,H]=f.useState(!1),[I]=f.useState(50),[z,E]=f.useState(!1),[$,k]=f.useState(null),[S,P]=f.useState(!1);f.useEffect(()=>{(async()=>{const b=await Be.initialize();E(b)})()},[]);const M=(l,b,T,B)=>{const oe=l*Math.PI/180,A=T*Math.PI/180,G=(T-l)*Math.PI/180,J=(B-b)*Math.PI/180,He=Math.sin(G/2)*Math.sin(G/2)+Math.cos(oe)*Math.cos(A)*Math.sin(J/2)*Math.sin(J/2);return 6371e3*(2*Math.atan2(Math.sqrt(He),Math.sqrt(1-He)))},F=async()=>{try{const{error:l}=await U.rpc("create_renter_arrival_notification",{p_handover_session_id:s});l?console.error("Error sending renter arrival notification:",l):console.log("Host notified of renter arrival")}catch(l){console.error("Failed to notify host of renter arrival:",l)}};f.useEffect(()=>{if(!m||!i||j)return;if(M(m.latitude,m.longitude,r.latitude,r.longitude)<=I&&(c(!0),u(!1),C.success("You have arrived at the handover location!"),a||F(),_&&"speechSynthesis"in window)){const b=new SpeechSynthesisUtterance("You have arrived at your destination");speechSynthesis.speak(b)}},[m,r,i,j,I,_,a,s]);const K=async()=>{let l=m;if(!l)try{l=await p(),k(null)}catch{return k("Unable to access your location. Please check your GPS settings."),P(!0),!1}if(!z)return k("Navigation service is not available."),P(!0),!1;try{const b=await Be.getRoute({origin:l,destination:r});if(b)return y(b.distance),D(b.duration),R(b.steps),!0;throw new Error("No route found")}catch(b){return console.error("Error fetching route:",b),k("Unable to calculate route."),P(!0),!1}},X=async()=>{await K()&&(u(!0),x(0),o==null||o(),C.success("Navigation started"))},W=()=>{c(!0),C.success("You've arrived at the handover location!"),a||F()},Q=()=>{u(!1),x(0),C.info("Navigation stopped")},Z=()=>{H(!_),C.info(_?"Voice guidance disabled":"Voice guidance enabled")},le=()=>{n(),C.success("Ready to begin handover process")},ce=()=>{c(!0),u(!1),C.success("Marked as arrived - ready for handover!"),a||F()},v=h[d]||null,w=j?100:d/Math.max(h.length-1,1)*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(O,{children:[e.jsx(re,{children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"}),"Navigate to Handover Location"]})}),e.jsxs(q,{className:"space-y-4",children:[!i&&!j&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(L,{onClick:X,size:"lg",className:"w-full",disabled:!z,children:[e.jsx(Ae,{className:"h-4 w-4 mr-2"}),"Start Navigation"]}),e.jsxs(L,{onClick:()=>P(!0),variant:"outline",size:"lg",className:"w-full",children:[e.jsx(ms,{className:"h-4 w-4 mr-2"}),"I've Already Arrived"]}),!z&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx(ve,{className:"h-4 w-4 inline mr-1"}),"Loading navigation service..."]})]}),$&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(ve,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Location Access Issue"}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:$})]})]})}),S&&!j&&e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"Alternative Options"}),e.jsx("p",{className:"text-sm text-blue-700 mb-3",children:"If you're unable to use GPS navigation, you can still proceed:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(L,{onClick:W,size:"lg",className:"w-full",variant:"default",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"I've Arrived at Location"]}),e.jsx(L,{onClick:()=>{P(!1),k(null)},size:"sm",variant:"ghost",className:"w-full",children:"Try Navigation Again"})]})]})}),(i||j)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(rt,{className:"h-4 w-4"}),"Navigation Progress"]}),e.jsxs("span",{children:[Math.round(w),"%"]})]}),e.jsx(fe,{value:w,className:"h-2"})]}),j&&e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx(se,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-green-800 font-medium",children:"You've arrived at the handover location!"}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:a?"Wait for the renter to arrive":"Look for the host and their vehicle"})]}),e.jsxs(L,{onClick:le,size:"lg",className:"w-full",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"I'm Ready for Handover"]})]})]})]}),i&&v&&e.jsx(tr,{currentStep:v,totalDistance:g,totalDuration:N,isNavigating:i,onToggleVoice:Z,isVoiceEnabled:_,onStopNavigation:Q,onArrived:ce,destination:r.address,showArrivedButton:!0}),i&&h.length>0&&e.jsx(sr,{steps:h,currentStepIndex:d,onStepClick:l=>x(l)})]})},or=({isHost:s,onClose:r,duration:t=3e3})=>{const[a,n]=f.useState(!0);f.useEffect(()=>{console.log("HandoverSuccessPopup mounted with duration:",t);const m=setTimeout(()=>{console.log("HandoverSuccessPopup timer fired, setting invisible"),n(!1),setTimeout(()=>{console.log("HandoverSuccessPopup calling onClose"),r()},300)},t);return()=>{console.log("HandoverSuccessPopup cleanup"),clearTimeout(m)}},[t,r]);const o=s?"See you soon!":"Have a nice trip!";return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsx(O,{className:`
          bg-white/95 backdrop-blur-sm shadow-2xl border-2 border-primary/20 
          p-6 rounded-2xl transition-all duration-300 transform
          ${a?"scale-100 opacity-100":"scale-95 opacity-0"}
        `,children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(tt,{className:"h-8 w-8 text-primary"}),e.jsx(se,{className:"h-4 w-4 text-green-500 absolute -top-1 -right-1 bg-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-1",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:o})]})]})})})},jt=s=>{const[r,t]=f.useState(null),[a,n]=f.useState(!0),[o,m]=f.useState(null),p=async()=>{if(!s){n(!1);return}try{n(!0);const{data:i,error:u}=await U.rpc("calculate_handover_progress",{handover_session_id_param:s});if(u)throw u;t(i&&typeof i=="object"?i:null),m(null)}catch(i){console.error("Error fetching handover progress:",i),m("Failed to load handover progress")}finally{n(!1)}};return f.useEffect(()=>{p()},[s]),f.useEffect(()=>{if(!s)return;const i=U.channel(`handover_progress_${s}`).on("postgres_changes",{event:"*",schema:"public",table:"handover_step_completion",filter:`handover_session_id=eq.${s}`},async u=>{var j,c;if(await p(),u.eventType==="UPDATE"&&((j=u.new)!=null&&j.is_completed)){const h=(c=u.new.step_name)==null?void 0:c.replace(/_/g," ");C.success(`${h} completed!`)}}).on("postgres_changes",{event:"*",schema:"public",table:"handover_sessions",filter:`id=eq.${s}`},u=>{var j;u.eventType==="UPDATE"&&((j=u.new)!=null&&j.handover_completed)&&C.success("Handover process completed successfully!")}).subscribe(u=>{u==="CHANNEL_ERROR"&&(console.error("Failed to subscribe to handover updates"),m("Real-time updates unavailable"))});return()=>{U.removeChannel(i)}},[s]),{handoverProgress:r,isLoading:a,error:o}},nr=({handoverSessionId:s,showDetailed:r=!1})=>{const{handoverProgress:t,isLoading:a,error:n}=jt(s);if(a)return e.jsx(O,{className:"w-full",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(rs,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading progress..."})]})})});if(n||!t)return e.jsx(O,{className:"w-full",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-destructive",children:[e.jsx(ve,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:n||"Unable to load progress"})]})})});const o=()=>t.is_completed?e.jsx(se,{className:"h-5 w-5 text-green-600"}):e.jsx(Ie,{className:"h-5 w-5 text-blue-600"}),m=()=>t.is_completed?"Handover Complete":`Step ${t.current_step} of ${t.total_steps}`;return r?e.jsxs(O,{className:"w-full",children:[e.jsx(re,{className:"pb-3",children:e.jsxs(ae,{className:"flex items-center space-x-2",children:[o(),e.jsx("span",{children:"Handover Progress"})]})}),e.jsxs(q,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:m()}),e.jsxs(ee,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]}),e.jsx(fe,{value:t.progress_percentage,className:"h-3"})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:[t.completed_steps," completed"]}),e.jsxs("span",{children:[t.total_steps-t.completed_steps," remaining"]})]}),t.is_completed&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(se,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"All handover steps completed successfully!"})]})})]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[o(),e.jsx("div",{className:"flex-1",children:e.jsx(fe,{value:t.progress_percentage,className:"h-2"})}),e.jsxs(ee,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]})},ir=({isOpen:s,onClose:r,bookingId:t})=>{var le,ce;const a=Ve(),[n]=Oe(),{isLoading:o,isHandoverSessionLoading:m,isHost:p,bookingDetails:i,handoverId:u,currentUserId:j,handoverStatus:c}=Ke();jt(u);const[h,R]=f.useState(0),[d,x]=f.useState([]),[g,y]=f.useState([]),[N,D]=f.useState([]),[_,H]=f.useState(),[I,z]=f.useState(),[E,$]=f.useState(),[k,S]=f.useState(!1),P=f.useCallback(async()=>{if(!u){console.error("Cannot initialize handover: missing handover session ID"),C.error("Handover session not found");return}console.log("Initializing handover for session:",u);try{await ks(u);const v=await Fe(u);console.log("Loaded handover steps:",v),console.log("Steps completion status:",v.map(T=>({name:T.step_name,completed:T.is_completed}))),x(v);const w=v.findIndex(T=>!T.is_completed),l=w>=0?w:v.length;console.log("First incomplete step index:",w),console.log("Setting current step to:",l),R(l);const b=v.filter(T=>T.is_completed).length;b>0&&C.success(`Continuing handover process - ${b}/${v.length} steps completed`),console.log("Handover initialized successfully")}catch(v){console.error("Error initializing handover:",v),C.error("Failed to initialize handover process")}},[u]);f.useEffect(()=>{u&&s&&!m&&P()},[u,s,m,P]),f.useEffect(()=>{if(s&&c&&d){console.log("🔍 DEBUG: Checking handover completion status..."),console.log("🔍 DEBUG: Handover status:",c),console.log("🔍 DEBUG: Completed steps:",d),console.log("🔍 DEBUG: isReturnHandover():",K());const v=d.every(w=>w.is_completed);if(c.handover_completed&&v){console.log("✅ Current handover session completed with all steps done, showing success popup"),S(!0);return}if(!c.handover_completed||!v){console.log("🔄 Handover not completed or steps incomplete, ensuring completion state is reset"),S(!1);const w=d.findIndex(l=>!l.is_completed);w>=0&&R(w)}}},[s,c,d,n]);const M=async(v,w)=>{if(console.log(`🚀 handleStepComplete called for step: ${v}`),console.log(`📋 Handover session ID: ${u}`),console.log("📊 Completion data:",w),!u){console.error("❌ No handover session ID available"),C.error("Handover session not found");return}console.log(`🔄 Attempting to complete step: ${v}`,{completionData:w});const l=await Cs(u,v,w);if(console.log(`📋 Step completion result for ${v}:`,l),l){console.log(`✅ Step ${v} completed successfully, refreshing steps...`);const b=await Fe(u);x(b);const T=b.findIndex(B=>!B.is_completed);console.log("🔍 Next incomplete step index:",T),T>=0?(console.log(`➡️ Moving to next step: ${T}`),R(T)):(console.log("🎉 All steps completed, initiating handover completion"),console.log("All steps completed, checking if handover should be finalized"),b.every(Y=>Y.is_completed)&&await F())}else console.error(`❌ Step ${v} completion failed`)},F=async()=>{console.log("Starting handover completion...");try{if(u&&(console.log("Completing handover session:",u),await zt(u)),g.length>0||N.length>0||_!==void 0||I!==void 0){console.log("Creating vehicle condition report...");const v=K()?"return":"pickup";console.log("Report type determined as:",v);const w={handover_session_id:u,booking_id:(i==null?void 0:i.id)||"",car_id:(i==null?void 0:i.car_id)||"",report_type:v,vehicle_photos:g,damage_reports:N,fuel_level:_,mileage:I,digital_signature_data:E,is_acknowledged:!0,reporter_id:j};if(!await Es(w))throw new Error("Failed to create vehicle condition report");console.log("Vehicle condition report created successfully")}console.log("Setting handover completed to true, isHost:",p),S(!0)}catch(v){console.error("Error completing handover:",v),C.error("Failed to complete handover. Please try again.")}},K=()=>{const v=n.get("handoverType");if(console.log("🔍 DEBUG: URL handoverType parameter:",v),console.log("🔍 DEBUG: All URL search params:",Object.fromEntries(n.entries())),v){console.log("✅ Using handoverType from URL:",v);const G=v==="return";return console.log("✅ isReturnHandover result from URL:",G),G}if(console.log("⚠️ No handoverType in URL, checking handover session type"),c!=null&&c.handover_type){console.log("✅ Using handover_type from session:",c.handover_type);const G=c.handover_type==="return";return console.log("✅ isReturnHandover result from session:",G),G}if(console.log("⚠️ No handover_type in session, falling back to automatic detection"),!i)return console.log("❌ Missing bookingDetails for automatic detection"),!1;const w=i,l=new Date(w.start_date),b=new Date(w.end_date),T=new Date;if(console.log("📅 Booking dates - Start:",l.toISOString(),"End:",b.toISOString()),console.log("📅 Current time:",T.toISOString()),T<l)return console.log("✅ Before booking start date - this is a pickup"),!1;if(T>=b)return console.log("✅ Past booking end date - this is a return"),!0;const B=Math.abs(T.getTime()-l.getTime()),Y=Math.abs(T.getTime()-b.getTime()),A=T>=l&&Y<B;return console.log("✅ Time-based determination - isReturn:",A),A},X=()=>{console.log("🎉 Success popup closing - starting redirection logic"),console.log("👤 User role - isHost:",p),console.log("📋 Booking ID:",t);const v=K();console.log("🔄 Handover type determination - isReturnHandover():",v),S(!1);const w=new URL(window.location.href);if(w.searchParams.delete("mode"),w.searchParams.delete("bookingId"),window.history.replaceState({},"",w.pathname+w.search),r(),!p&&v){console.log("🔄 Return handover completed - redirecting renter to review page"),console.log("🚀 Navigating to:",`/rental-review/${t}`),a(`/rental-review/${t}`);return}p?(console.log("🏠 Host user - navigating to host-bookings"),console.log("🚀 Navigating to: /host-bookings"),a("/host-bookings")):(console.log("🚗 Renter user - pickup completed, navigating to renter-bookings"),console.log("🚀 Navigating to: /renter-bookings"),a("/renter-bookings"))},W=v=>{switch(v){case"navigation":return!0;case"identity_verification":return!0;case"vehicle_inspection_exterior":return g.filter(l=>l.type&&l.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return g.filter(l=>l.type&&(l.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(l.type))).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return _!==void 0&&I!==void 0;case"key_transfer":return!0;case"digital_signature":return E!==void 0;default:return!0}},Q=(v,w)=>{var T,B,Y,oe;const l=i,b=p?l==null?void 0:l.renter:(T=l==null?void 0:l.cars)==null?void 0:T.owner;switch(v.name){case"navigation":{const A={latitude:(l==null?void 0:l.latitude)||((B=l==null?void 0:l.cars)==null?void 0:B.latitude)||-24.65451,longitude:(l==null?void 0:l.longitude)||((Y=l==null?void 0:l.cars)==null?void 0:Y.longitude)||25.90859,address:((oe=l==null?void 0:l.cars)==null?void 0:oe.location)||"Handover Location"};return e.jsx(ar,{handoverSessionId:u||"",destinationLocation:A,otherUserName:(b==null?void 0:b.full_name)||"User",isHost:p,onStepComplete:()=>M(v.name),onNavigationStart:()=>C.info("Navigation started. Follow the directions to reach the handover location.")})}case"identity_verification":return e.jsx(Ds,{handoverSessionId:u||"",otherUserId:(b==null?void 0:b.id)||"",otherUserName:(b==null?void 0:b.full_name)||"User",isHost:p,onStepComplete:()=>M(v.name)});case"vehicle_inspection_exterior":return g.filter(A=>A.type.startsWith("exterior_")),e.jsx(ze,{handoverSessionId:u||"",inspectionType:"exterior",onPhotosUpdate:A=>{const G=g.filter(J=>J.type&&!J.type.startsWith("exterior_"));y([...G,...A])},onStepComplete:()=>M(v.name),initialPhotos:g.filter(A=>A.type&&A.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return g.filter(A=>A.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(A.type)),e.jsx(ze,{handoverSessionId:u||"",inspectionType:"interior",onPhotosUpdate:A=>{const G=g.filter(J=>J.type&&!J.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(J.type));y([...G,...A])},onStepComplete:()=>M(v.name),initialPhotos:g.filter(A=>A.type&&(A.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(A.type)))});case"damage_documentation":return e.jsx(Ps,{handoverSessionId:u||"",onDamageReportsUpdate:D,onStepComplete:()=>M(v.name),initialReports:N});case"fuel_mileage_check":return e.jsx(Js,{handoverSessionId:u||"",onFuelLevelChange:H,onMileageChange:z,onStepComplete:()=>M(v.name,{fuel_level:_,mileage:I}),initialFuelLevel:_,initialMileage:I});case"key_transfer":return e.jsx(Zs,{handoverSessionId:u||"",otherUserName:(b==null?void 0:b.full_name)||"User",isHost:p,onStepComplete:()=>M(v.name)});case"digital_signature":return e.jsx(er,{handoverSessionId:u||"",onSignatureComplete:A=>{$(A),M(v.name,{signature:A})},initialSignature:E});default:return e.jsx(O,{children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:v.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:v.description}),e.jsxs(L,{onClick:()=>M(v.name),disabled:!W(v.name),children:["Complete ",v.title]})]})})})}};if(o||m)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(O,{className:"w-96",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:m?"Setting up handover session...":"Loading handover process..."})]})})})});if(!u&&!m)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(O,{className:"w-96",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ve,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Session Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load the handover session. Please try refreshing the page."}),e.jsx(L,{onClick:r,variant:"outline",children:"Close"})]})})})});d.filter(v=>v.is_completed).length/pe.length*100;const Z=pe[h];return e.jsxs(e.Fragment,{children:[k&&e.jsxs(e.Fragment,{children:[console.log("Rendering HandoverSuccessPopup with isHost:",p),e.jsx(or,{isHost:p,onClose:X})]}),e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:s?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:r}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[90vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(le=i==null?void 0:i.cars)==null?void 0:le.brand," ",(ce=i==null?void 0:i.cars)==null?void 0:ce.model]})]}),e.jsx("button",{onClick:r,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(xe,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(nr,{handoverSessionId:u,showDetailed:!1})}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:pe.map((v,w)=>{const l=d.find(B=>B.step_name===v.name),b=(l==null?void 0:l.is_completed)||!1,T=w===h;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${b?"bg-green-50 border-green-200 text-green-800":T?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:b?e.jsx(se,{className:"h-4 w-4"}):T?e.jsx(Ie,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:v.title})]},v.name)})})}),Z?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(ee,{variant:"outline",children:["Step ",h+1]}),e.jsx("span",{className:"font-medium",children:Z.title})]}),Q(Z)]}):e.jsx(O,{children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(se,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})]})},lr=({onBookingClick:s})=>{const{userId:r,userRole:t}=as(),{data:a=[]}=Nt({queryKey:["handover-bookings",r,t],queryFn:async()=>{try{if(!r||!t)return console.log("HandoverBookingButtons: No userId or userRole"),[];const o=new Date,m=new Date().toISOString().split("T")[0],p=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];console.log("HandoverBookingButtons: Fetching bookings",{userId:r,userRole:t,today:m,tomorrow:p});let i=U.from("bookings").select(`
            *,
            cars (
              brand,
              model,
              location,
              image_url,
              owner_id,
              price_per_day
            ),
            renter:profiles!renter_id (
              id,
              full_name,
              avatar_url,
              phone_number
            ),
            handover_sessions (
              id,
              handover_completed,
              created_at
            )
          `).eq("status","confirmed").or(`start_date.eq.${m},start_date.eq.${p},end_date.eq.${m}`);t==="renter"?i=i.eq("renter_id",r):t==="host"&&(i=i.eq("cars.owner_id",r));const{data:u,error:j}=await i;if(j)throw console.error("HandoverBookingButtons: Error fetching bookings:",j),new Error(`Failed to fetch handover bookings: ${j.message}`);if(!u)return console.log("HandoverBookingButtons: No data returned"),[];console.log("HandoverBookingButtons: Raw bookings data",u);const c=u.filter(h=>{var _;const R=new Date(h.start_date),d=new Date(h.end_date),x=(_=h.handover_sessions)==null?void 0:_[0];if(x!=null&&x.handover_completed)return!1;const y=R.toDateString()===o.toDateString()&&!x,D=d.toDateString()===o.toDateString()&&x&&!x.handover_completed;return y||D});return console.log("HandoverBookingButtons: Filtered bookings",c),c}catch(o){return console.error("HandoverBookingButtons: Query failed:",o),[]}},enabled:!!r&&!!t,refetchInterval:3e4,retry:(o,m)=>(console.warn("HandoverBookingButtons: Query failed, retry attempt",{failureCount:o,error:m}),o<2),retryDelay:o=>Math.min(1e3*2**o,3e4)}),n=({booking:o,index:m})=>{var x,g,y,N,D,_,H;const p=((x=o.cars)==null?void 0:x.image_url)||"/placeholder.svg",i=new Date,u=new Date(o.start_date),j=new Date(o.end_date),c=(g=o.handover_sessions)==null?void 0:g[0],h=u.toDateString()===i.toDateString(),R=j.toDateString()===i.toDateString();let d="pickup";return R&&c&&!c.handover_completed?d="return":h&&!c&&(d="pickup"),e.jsx(Bt,{children:e.jsxs(Vt,{children:[e.jsx(Ot,{asChild:!0,children:e.jsx("button",{onClick:I=>{I.preventDefault(),console.log("Handover button clicked for booking:",o.id,"type:",d),s(o.id,d)},className:`
                w-16 h-16 rounded-full border-4 border-primary/30 
                overflow-hidden shadow-lg hover:shadow-xl
                transition-all duration-300 hover:scale-110
                animate-pulse bg-background
                mb-3
              `,style:{animationDuration:`${2+m*.5}s`},children:e.jsx("img",{src:p,alt:`${(y=o.cars)==null?void 0:y.brand} ${(N=o.cars)==null?void 0:N.model}`,className:"w-full h-full object-cover",onError:I=>{I.currentTarget.src="/placeholder.svg"}})})}),e.jsx(qt,{side:"right",className:"max-w-xs p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-sm",children:[(D=o.cars)==null?void 0:D.brand," ",(_=o.cars)==null?void 0:_.model]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(os,{className:"h-3 w-3 mr-1"}),Ue(new Date(o.start_date),"MMM dd")," - ",Ue(new Date(o.end_date),"MMM dd")]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(je,{className:"h-3 w-3 mr-1"}),(H=o.cars)==null?void 0:H.location]}),t==="host"&&o.renter&&e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(et,{className:"h-3 w-3 mr-1"}),o.renter.full_name]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(ns,{className:"h-3 w-3 mr-1"}),"BWP ",o.total_price]}),e.jsx("div",{className:"text-xs text-primary font-medium mt-2",children:"Click for handover details"})]})})]})},o.id)};return a.length?(console.log("Rendering handover buttons for bookings:",a.map(o=>o.id)),e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col",children:a.map((o,m)=>e.jsx(n,{booking:o,index:m},o.id))})):(console.log("No handover bookings found for user:",r,"role:",t),null)};class cr extends f.Component{constructor(){super(...arguments);ne(this,"maxRetries",3);ne(this,"state",{hasError:!1,error:null,errorInfo:null,retryCount:0});ne(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries?(this.setState(t=>({hasError:!1,error:null,errorInfo:null,retryCount:t.retryCount+1})),C.info("Retrying handover process...")):C.error("Maximum retry attempts reached. Please refresh the page.")});ne(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,retryCount:0})});ne(this,"handleNavigateHome",()=>{const t=new URL(window.location.href);t.searchParams.delete("mode"),t.searchParams.delete("bookingId"),window.history.replaceState({},"",t.pathname),window.location.href="/"})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,a){console.error("HandoverErrorBoundary caught an error:",t,a),this.setState({errorInfo:a}),this.props.onError&&this.props.onError(t,a);const n={error:t.message,stack:t.stack,componentStack:a.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent};console.error("Handover Error Report:",n),C.error("A handover system error occurred. Please try again.")}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const a=this.state.retryCount<this.maxRetries,n=((t=this.state.error)==null?void 0:t.message)||"An unexpected error occurred";return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs(Kt,{className:"max-w-md",children:[e.jsx(Xe,{className:"h-4 w-4"}),e.jsxs(Gt,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Handover System Error"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:n}),this.state.retryCount>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Retry attempt: ",this.state.retryCount,"/",this.maxRetries]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[a&&e.jsxs(L,{onClick:this.handleRetry,className:"w-full",variant:"outline",children:[e.jsx($e,{className:"mr-2 h-4 w-4"}),"Retry Handover"]}),e.jsxs(L,{onClick:this.handleReset,className:"w-full",variant:"outline",children:[e.jsx($e,{className:"mr-2 h-4 w-4"}),"Reset Process"]}),e.jsxs(L,{onClick:this.handleNavigateHome,className:"w-full",variant:"secondary",children:[e.jsx(is,{className:"mr-2 h-4 w-4"}),"Return to Dashboard"]})]}),!1]})]})})}return this.props.children}}const qr=()=>{const[s]=Oe(),r=s.get("mode"),t=s.get("bookingId"),{user:a}=Wt(),[n,o]=f.useState(""),[m,p]=f.useState(!0),[i,u]=f.useState([]),[j,c]=f.useState(!1),[h]=f.useState({latitude:null,longitude:null}),{theme:R}=Yt(),[d,x]=f.useState(!1),[g,y]=f.useState(!1),[N]=f.useState(null),D=async k=>{var S;try{const{data:P,error:M}=await U.from("bookings").select(`
          id, 
          status, 
          start_date, 
          end_date, 
          renter_id,
          cars!inner (
            owner_id
          )
        `).eq("id",k).eq("status","confirmed").single();if(M||!P)return console.log("Booking not found or not confirmed:",k),!1;const F=(S=P.cars)==null?void 0:S.owner_id;if(!a||a.id!==P.renter_id&&a.id!==F)return console.log("User does not have permission to access booking:",k),!1;const K=new Date().toISOString().split("T")[0],X=P.start_date===K,W=P.end_date===K;return!X&&!W?(console.log("Booking is not eligible for handover today:",k),!1):!0}catch(P){return console.error("Error validating booking:",P),!1}};f.useEffect(()=>{(async()=>{if(!(r==="handover"&&t)){x(!1);return}if(!a)return;if(y(!0),await D(t))x(!0);else{const M=new URL(window.location.href);M.searchParams.delete("mode"),M.searchParams.delete("bookingId"),window.history.replaceState({},"",M.pathname+M.search),C.info("Invalid handover request - showing standard map"),x(!1)}y(!1)})()},[r,t,a]),f.useEffect(()=>{d&&!j&&c(!0)},[d]),f.useEffect(()=>{(async()=>{p(!0);try{const S=await Ze();if(!S){C.error("Failed to get the map token"),console.error("Failed to get the map token");return}o(S)}catch(S){console.error("Error getting the map token:",S),C.error("Failed to get the map token")}finally{p(!1)}})()},[]);const _=async()=>{var k,S;if(!a)return null;try{const{data:P,error:M}=await U.from("handover_sessions").select(`
          host_id,
          host_location,
          bookings!inner(
            car_id,
            cars!inner(
              owner_id,
              profiles!owner_id(id, full_name, avatar_url, latitude, longitude)
            )
          )
        `).eq("renter_id",a.id).eq("handover_completed",!1).single();if(M||!P)return console.log("No active handover session found"),null;const F=(S=(k=P.bookings)==null?void 0:k.cars)==null?void 0:S.profiles;if(F!=null&&F.latitude&&(F!=null&&F.longitude))return{id:F.id,full_name:F.full_name,avatar_url:F.avatar_url,latitude:F.latitude,longitude:F.longitude,updated_at:null,isActiveHandover:!0}}catch(P){console.error("Error fetching active handover host:",P)}return null},H=async()=>{console.log("Fetching host locations...");try{const k=await bs();console.log("Online hosts fetched:",k);const S=await _();console.log("Active handover host:",S);const P=[...k];if(S){const M=P.findIndex(F=>F.id===S.id);M>=0?P[M]=S:P.push(S)}P.length||C.info("No hosts are currently online"),console.log("All host locations to display:",P),u(P)}catch(k){console.error("Error fetching host locations:",k),C.error("Failed to fetch host locations")}};f.useEffect(()=>{d||(H(),console.log("Location",h))},[d]);const I=()=>R==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",z=()=>m||g?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:g?"Validating handover...":"Loading map..."}),e.jsx(Jt,{color:"#7c3aed",width:100})]}):n?e.jsx(ys,{mapbox_token:n,longitude:25.90859,latitude:-24.65451,onlineHosts:d?[]:i,mapStyle:I(),isHandoverMode:d,bookingId:t,dpad:!0,locationToggle:!0,destination:h}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]}),E=!!a&&d,$=e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("main",{className:"flex-1 relative overflow-hidden",children:[z(),E&&e.jsxs(cr,{children:[e.jsx(lr,{onBookingClick:(k,S)=>{if(console.log("Map received booking click for:",k,"type:",S),console.log("Current booking ID from URL:",t),console.log("Current handover sheet state:",j),S==="return"){window.location.href=`/rental-details/${k}`;return}k!==t&&(console.log("Updating URL with new booking ID"),window.history.replaceState({},"",`/map?mode=handover&bookingId=${k}`)),console.log("Opening handover sheet"),c(!0)}}),e.jsx(ir,{isOpen:j,onClose:()=>{c(!1);const k=new URL(window.location.href);k.searchParams.delete("mode"),k.searchParams.delete("bookingId"),window.history.replaceState({},"",k.pathname+k.search)},bookingId:t||""})]})]}),e.jsx(St,{})]});return e.jsx(Xt,{children:E?e.jsx(Qt,{children:$}):$})};export{qr as default};
