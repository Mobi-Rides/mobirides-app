import{j as t,u as O,d as Y}from"./query-vendor-Bsfdn-Hb.js";import{r as u,u as L,f as $}from"./react-vendor-mnpoGfEl.js";import{H as Q}from"./Header-xO7AOFF_.js";import{N as ee}from"./Navigation-DrpfU0Fc.js";import{u as re}from"./useAuthStatus-Cv5T3520.js";import{c as P,B as C,A as te,T as se,s as S,a as D,J as I,L as ae}from"./index-CEKMvnhM.js";import{C as U}from"./CarGrid-COO1MlRU.js";import{C as ne}from"./card-DVWWM3IP.js";import{C as F}from"./clock-BYxaZ7Am.js";import{M as oe}from"./map-pin-DSx0xkt_.js";import{C as ie}from"./car-CVWSXvWw.js";import{a as ce}from"./date-vendor-Dhms5dOu.js";import{u as z}from"./useHandoverPrompts-v1LSZGjg.js";import"./sheet-CcFgStQt.js";import"./SearchFilters-BAlQluFb.js";import"./popover-CCHOPsgy.js";import"./chevron-left-DfLvTpd6.js";import"./select-BAtoiU29.js";import"./index-DXD4kVr2.js";import"./LocationSearchInput-CZ6FE_Yq.js";import"./star-CEtrV90q.js";import"./calendar-BxEe8nw1.js";import"./arrow-up-down-DH39S7db.js";import"./useVerificationStatus-Cz0yp9hl.js";import"./circle-alert-BQKScKl8.js";import"./shield-DaksOUHr.js";import"./navigation-ClHT2TXa.js";import"./bell-B1Cg_jQL.js";import"./user-C-qQU3Ry.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./savedCarService-CB31jJUv.js";import"./separator-CNMPkK_g.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=P("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=P("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=P("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]),le=()=>{const[e,r]=u.useState(!1),[a,s]=u.useState("signin"),n=L(),o=u.useCallback(()=>{s("signin"),r(!0),n("/?auth=signin",{replace:!0})},[n]),i=u.useCallback(()=>{s("signup"),r(!0),n("/?auth=signup",{replace:!0})},[n]),c=u.useCallback(()=>{r(!1),n("/",{replace:!0})},[n]);return{isOpen:e,defaultTab:a,openSignIn:o,openSignUp:i,close:c,setIsOpen:r}},ue=()=>{const{isOpen:e,defaultTab:r,openSignIn:a,close:s}=le(),n=$();return u.useEffect(()=>{const i=new URLSearchParams(n.search).get("auth");(i==="signin"||i==="signup")&&i==="signin"&&a()},[n.search,a]),t.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[t.jsxs("div",{className:"p-8 rounded-lg",children:[t.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),t.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),t.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:a,children:[t.jsx(de,{className:"h-4 w-4 text-primary"}),t.jsx("span",{className:"hidden md:inline-block",children:t.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),t.jsx(te,{isOpen:e,onClose:s,defaultTab:r,idPrefix:"home"})]})},K=({prompt:e,onStartHandover:r})=>{const a=L(),s=()=>{switch(e.urgencyLevel){case"immediate":return"bg-destructive text-destructive-foreground border-destructive";case"soon":return"bg-orange-50 text-orange-900 border-orange-200 dark:bg-orange-950 dark:text-orange-100 dark:border-orange-800";case"morning":return"bg-blue-50 text-blue-900 border-blue-200 dark:bg-blue-950 dark:text-blue-100 dark:border-blue-800";default:return"bg-muted text-muted-foreground"}},n=()=>{switch(e.urgencyLevel){case"immediate":return t.jsx(se,{className:"h-5 w-5 animate-pulse"});case"soon":return t.jsx(F,{className:"h-5 w-5"});default:return t.jsx(ie,{className:"h-5 w-5"})}},o=()=>{r(e.bookingId)},i=()=>{a(`/rental-details/${e.bookingId}`)};return t.jsx(ne,{className:`p-4 border-l-4 ${s()}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 mt-0.5",children:n()}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("h3",{className:"font-semibold text-sm",children:e.handoverType==="pickup"?"Car Pickup Required":"Car Return Required"}),e.isUrgent&&t.jsx("span",{className:"px-2 py-1 text-xs bg-current/10 rounded-full font-medium",children:"URGENT"})]}),t.jsxs("p",{className:"text-sm opacity-90 mb-2",children:[e.carBrand," ",e.carModel," â€¢ ",e.otherPartyName]}),t.jsxs("div",{className:"flex items-center gap-4 text-xs opacity-75 mb-3",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(F,{className:"h-3 w-3"}),ce(e.handoverType==="pickup"?e.startDate:e.endDate,"MMM d, h:mm a")]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(oe,{className:"h-3 w-3"}),e.location]})]}),t.jsxs("div",{className:"flex gap-2",children:[e.shouldInitiate?t.jsxs(C,{onClick:o,size:"sm",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",variant:"outline",children:["Start ",e.handoverType==="pickup"?"Pickup":"Return"]}):t.jsxs(C,{onClick:i,size:"sm",variant:"outline",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",children:["Prepare for ",e.handoverType==="pickup"?"Pickup":"Return"]}),t.jsx(C,{onClick:i,size:"sm",variant:"ghost",className:"text-current hover:bg-current/10",children:"View Details"})]})]})]})})},he=({searchQuery:e})=>{const[r,a]=u.useState(null),[s,n]=u.useState("asc"),o=u.useRef(null),i=L(),{handoverPrompts:c,hasHandoverPrompts:h,refetch:p}=z(),{data:v,isLoading:y,error:_}=O({queryKey:["host-cars",e,s,r],queryFn:async()=>{var b;console.log("Fetching host cars with search:",e,"brand:",r);const{data:{session:m}}=await S.auth.getSession();if(!((b=m==null?void 0:m.user)!=null&&b.id))return[];let d=S.from("cars").select("*").eq("owner_id",m.user.id);e&&(d=d.or(`brand.ilike.%${e}%,model.ilike.%${e}%`)),r&&(d=d.eq("brand",r)),d=d.order("price_per_day",{ascending:s==="asc"});const{data:g,error:f}=await d;if(f)throw f;return console.log("Host cars fetched:",g),g}}),j=v||[],N=()=>{n(m=>m==="asc"?"desc":"asc")},w=()=>{console.log("Load more triggered in HostView")},k=async m=>{try{console.log("Starting handover for booking:",m);const{data:d,error:g}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",m).single();if(g)throw g;if(!d)throw new Error("Booking not found");const f=d.cars.owner_id,b=d.renter_id;await D(m,f,b,"pickup")&&(I.success("Handover process started"),i(`/map?bookingId=${m}&mode=handover&role=host`),p())}catch(d){console.error("Error starting handover:",d),I.error("Failed to start handover process")}};return t.jsxs("div",{className:"space-y-6",children:[h&&t.jsx("div",{className:"space-y-3",children:c.map(m=>t.jsx(K,{prompt:m,onStartHandover:k},m.id))}),t.jsx("div",{className:"flex justify-end",children:t.jsx(C,{variant:s?"secondary":"outline",onClick:N,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?t.jsxs(t.Fragment,{children:["Price: Low to High",t.jsx(G,{className:"h-4 w-4"})]}):t.jsxs(t.Fragment,{children:["Price: High to Low",t.jsx(Z,{className:"h-4 w-4"})]})})}),t.jsx("div",{className:"text-left flex items-center ",children:t.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),t.jsx(U,{cars:j,isLoading:y,error:_,loadMoreRef:o,onLoadMore:w,isFetchingNextPage:!1,isAuthenticated:!0})]})};var H=new Map,A=new WeakMap,B=0,me=void 0;function ge(e){return e?(A.has(e)||(B+=1,A.set(e,B.toString())),A.get(e)):"0"}function xe(e){return Object.keys(e).sort().filter(r=>e[r]!==void 0).map(r=>`${r}_${r==="root"?ge(e.root):e[r]}`).toString()}function pe(e){const r=xe(e);let a=H.get(r);if(!a){const s=new Map;let n;const o=new IntersectionObserver(i=>{i.forEach(c=>{var h;const p=c.isIntersecting&&n.some(v=>c.intersectionRatio>=v);e.trackVisibility&&typeof c.isVisible>"u"&&(c.isVisible=p),(h=s.get(c.target))==null||h.forEach(v=>{v(p,c)})})},e);n=o.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),a={id:r,observer:o,elements:s},H.set(r,a)}return a}function fe(e,r,a={},s=me){if(typeof window.IntersectionObserver>"u"&&s!==void 0){const h=e.getBoundingClientRect();return r(s,{isIntersecting:s,target:e,intersectionRatio:typeof a.threshold=="number"?a.threshold:0,time:0,boundingClientRect:h,intersectionRect:h,rootBounds:h}),()=>{}}const{id:n,observer:o,elements:i}=pe(a),c=i.get(e)||[];return i.has(e)||i.set(e,c),c.push(r),o.observe(e),function(){c.splice(c.indexOf(r),1),c.length===0&&(i.delete(e),o.unobserve(e)),i.size===0&&(o.disconnect(),H.delete(n))}}function ve({threshold:e,delay:r,trackVisibility:a,rootMargin:s,root:n,triggerOnce:o,skip:i,initialInView:c,fallbackInView:h,onChange:p}={}){var v;const[y,_]=u.useState(null),j=u.useRef(p),[N,w]=u.useState({inView:!!c,entry:void 0});j.current=p,u.useEffect(()=>{if(i||!y)return;let g;return g=fe(y,(f,b)=>{w({inView:f,entry:b}),j.current&&j.current(f,b),b.isIntersecting&&o&&g&&(g(),g=void 0)},{root:n,rootMargin:s,threshold:e,trackVisibility:a,delay:r},h),()=>{g&&g()}},[Array.isArray(e)?e.toString():e,y,n,s,o,i,a,h,r]);const k=(v=N.entry)==null?void 0:v.target,m=u.useRef(void 0);!y&&k&&!o&&!i&&m.current!==k&&(m.current=k,w({inView:!!c,entry:void 0}));const d=[_,N.inView,N.entry];return d.ref=d[0],d.inView=d[1],d.entry=d[2],d}const T=10,be=async({pageParam:e=0,filters:r,searchParams:a})=>{console.log("Starting car fetch with params:",{pageParam:e,filters:r,searchParams:a});let s=S.from("cars").select("*",{count:"exact"});s=s.range(e*T,(e+1)*T-1),a!=null&&a.searchTerm&&(console.log("Applying search term:",a.searchTerm),s=s.or(`brand.ilike.%${a.searchTerm}%,model.ilike.%${a.searchTerm}%`)),a!=null&&a.brand&&(console.log("Filtering by brand:",a.brand),s=s.eq("brand",a.brand)),r!=null&&r.model&&(s=s.ilike("model",`%${r.model}%`)),r!=null&&r.year&&(s=s.eq("year",r.year)),r!=null&&r.minPrice&&(s=s.gte("price_per_day",r.minPrice)),r!=null&&r.maxPrice&&(s=s.lte("price_per_day",r.maxPrice)),r!=null&&r.vehicleType&&(s=s.eq("vehicle_type",r.vehicleType)),r!=null&&r.location&&(s=s.ilike("location",`%${r.location}%`)),(r==null?void 0:r.sortBy)==="price"&&(s=s.order("price_per_day",{ascending:r.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:n,error:o,count:i}=await s;if(o)throw console.error("Error fetching cars:",o),o;const c=(n||[]).filter(h=>h&&h.id&&h.brand&&h.model);return console.log("Valid cars fetched:",c.length,"from",(n==null?void 0:n.length)||0),{data:c,nextPage:c.length===T?e+1:void 0,count:i}},ye=e=>{if(!e||typeof e!="object")throw new Error("Invalid car object provided to toSafeCar");return{...e,description:e.description??"No description available",features:e.features??[],image_url:e.image_url??"/placeholder-car.jpg",latitude:e.latitude??0,longitude:e.longitude??0,is_available:e.is_available??!0}},we=({searchQuery:e,filters:r,onFiltersChange:a})=>{const[s,n]=u.useState(null),[o,i]=u.useState("asc"),{ref:c,inView:h}=ve(),p=u.useRef(null),v=L(),{handoverPrompts:y,hasHandoverPrompts:_,refetch:j}=z(),N=l=>{p.current!==l&&(p.current=l||null),c(l)};u.useEffect(()=>{a({...r,sortOrder:o})},[o,a,r]);const{data:w,isLoading:k,error:m,hasNextPage:d,fetchNextPage:g,isFetchingNextPage:f}=Y({queryKey:["available-cars",s,r,e],queryFn:({pageParam:l=0})=>be({pageParam:l,filters:r,searchParams:{...s?{brand:s}:{},...e?{searchTerm:e}:{}}}),getNextPageParam:l=>l.nextPage||void 0,initialPageParam:0}),{data:b}=O({queryKey:["saved-car-ids"],queryFn:async()=>{var E;console.log("Fetching saved car IDs for home page");const{data:{session:l}}=await S.auth.getSession();if(!((E=l==null?void 0:l.user)!=null&&E.id))return new Set;const{data:x,error:M}=await S.from("saved_cars").select("car_id").eq("user_id",l.user.id);if(M)return console.error("Error fetching saved cars:",M),new Set;const R=new Set(x.map(V=>V.car_id));return console.log("Saved car IDs for home page:",Array.from(R)),R}}),q=b||new Set,J=(w==null?void 0:w.pages.flatMap(l=>l.data.filter(x=>x&&typeof x=="object"&&x.id).map(x=>({...ye(x),isSaved:q.has(x.id)}))))||[];u.useEffect(()=>{h&&d&&!f&&g()},[h,d,f,g]);const W=()=>{i(l=>l==="asc"?"desc":"asc")},X=async l=>{try{console.log("Starting handover for booking:",l);const{data:x,error:M}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",l).single();if(M)throw M;if(!x)throw new Error("Booking not found");const R=x.cars.owner_id,E=x.renter_id;await D(l,R,E,"pickup")&&(I.success("Handover process started"),v(`/map?bookingId=${l}&mode=handover&role=renter`),j())}catch(x){console.error("Error starting handover:",x),I.error("Failed to start handover process")}};return t.jsxs("div",{className:"space-y-6",children:[_&&t.jsx("div",{className:"space-y-3",children:y.map(l=>t.jsx(K,{prompt:l,onStartHandover:X},l.id))}),t.jsx("div",{className:"flex justify-end",children:t.jsx(C,{variant:o?"secondary":"outline",onClick:W,className:`flex items-center gap-2 transition-colors ${o?"bg-accent text-accent-foreground":""}`,children:o==="asc"?t.jsxs(t.Fragment,{children:["Price: Low to High",t.jsx(G,{className:"h-4 w-4"})]}):t.jsxs(t.Fragment,{children:["Price: High to Low",t.jsx(Z,{className:"h-4 w-4"})]})})}),t.jsx("div",{className:"text-left flex items-center ",children:t.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),t.jsx(U,{cars:J,isLoading:k,error:m,loadMoreRef:p,isFetchingNextPage:f,isAuthenticated:!0}),d&&t.jsx("div",{ref:N,className:"h-10 w-full opacity-0",children:"Load more trigger"})]})},rr=()=>{const[e,r]=u.useState(""),[a,s]=u.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),n=$(),{isAuthenticated:o,userRole:i,isLoadingRole:c}=re(),h=u.useCallback(p=>{s(p)},[]);return u.useEffect(()=>{},[n.search]),t.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[t.jsx(Q,{searchQuery:e,onSearchChange:r,onFiltersChange:s}),t.jsx("main",{className:"container mx-auto px-4 py-8",children:c?t.jsx(ae,{}):o?i==="host"?t.jsx(he,{searchQuery:e}):t.jsx(we,{searchQuery:e,filters:a,onFiltersChange:h}):t.jsx(ue,{})}),t.jsx(ee,{})]})};export{rr as default};
