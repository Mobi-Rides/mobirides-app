import{j as e,u as $,a as L}from"./query-vendor-BOSMW7hd.js";import{c as F,a7 as z,I as T,B as _,n as g,C as k,X as R,s as h,l as A,q as S}from"./index-ahmQo-Zq.js";import{C as K,N as P}from"./Navigation-DgaHbxsQ.js";import{S as y}from"./skeleton-DFMY7FuM.js";import{u as q,r as b}from"./react-vendor-DmU5vXC9.js";import{C as v,d as N}from"./card-D4VTtfVn.js";import{S as Q,a as I,b as V,c as Y,d as j}from"./select-BGtNurN5.js";import{M as H}from"./map-pin-BTmNqwoj.js";import{C as D}from"./clock-gtBamCUv.js";import{a as p}from"./date-vendor-Dhms5dOu.js";import{C as U}from"./car-DSCKC0BN.js";import{C as W}from"./circle-check-big-uJiWdFVJ.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./bell-D3eElkfC.js";import"./user-7MMf2PMh.js";import"./index-CEVvJeOa.js";import"./chevron-down-BDcPfNun.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=F("CalendarDays",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]),X=({searchTerm:s,onSearchChange:c,statusFilter:d,onStatusChange:t})=>e.jsx("div",{className:"px-4 space-y-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(T,{placeholder:"Search by car, location...",value:s,onChange:r=>c(r.target.value),className:"pl-10"})]}),e.jsxs(Q,{value:d,onValueChange:t,children:[e.jsx(I,{className:"w-full sm:w-[180px]",children:e.jsx(V,{placeholder:"Filter by status"})}),e.jsxs(Y,{children:[e.jsx(j,{value:"all",children:"All Status"}),e.jsx(j,{value:"pending",children:"Pending"}),e.jsx(j,{value:"confirmed",children:"Confirmed"}),e.jsx(j,{value:"completed",children:"Completed"}),e.jsx(j,{value:"cancelled",children:"Cancelled"})]})]})]})}),G=({booking:s,onCancelBooking:c})=>{const d=q(),t=()=>{d(`/rental-details/${s.id}`)},r=x=>{x.stopPropagation(),c(s.id)},i=()=>{switch(s.status){case"pending":return e.jsxs(g,{variant:"outline",className:"flex items-center gap-1 text-xs",children:[e.jsx(D,{className:"h-3 w-3"})," Pending"]});case"confirmed":return e.jsxs(g,{variant:"success",className:"bg-green-100 text-green-800 flex items-center gap-1 text-xs",children:[e.jsx(k,{className:"h-3 w-3"})," Confirmed"]});case"cancelled":return e.jsxs(g,{variant:"destructive",className:"flex items-center gap-1 text-xs",children:[e.jsx(R,{className:"h-3 w-3"})," Cancelled"]});case"completed":return e.jsxs(g,{variant:"default",className:"flex items-center gap-1 text-xs",children:[e.jsx(k,{className:"h-3 w-3"})," Completed"]});default:return e.jsx(g,{className:"text-xs",children:s.status})}};return e.jsx(v,{className:"cursor-pointer hover:bg-muted/50 transition-colors overflow-hidden",onClick:t,children:e.jsx(N,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("img",{src:s.cars.image_url||"/placeholder.svg",alt:`${s.cars.brand} ${s.cars.model}`,className:"w-20 h-20 object-cover rounded-md flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium truncate",children:[s.cars.brand," ",s.cars.model]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate flex items-center gap-1 mt-1",children:[e.jsx(H,{size:12,className:"text-red-500"}),s.cars.location]})]}),e.jsx("div",{children:i()})]})})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("div",{className:"flex flex-col justify-start items-start",children:e.jsxs("span",{className:"font-medium flex gap-1 text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{size:12,className:"text-blue-500"}),p(new Date(s.start_date),"PP")," -"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{size:12,className:"text-blue-500"}),p(new Date(s.end_date),"PP")]})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium text-base text-primary",children:["BWP ",s.total_price]}),s.status==="pending"&&e.jsx(_,{variant:"outline",size:"sm",onClick:r,children:"Cancel"})]})]})]})})})},M=()=>{const{data:s,isLoading:c}=$({queryKey:["renter-booking-stats"],queryFn:async()=>{const{data:{user:t}}=await h.auth.getUser();if(!t)throw new Error("No user found");const{data:r,error:i}=await h.from("bookings").select("status, start_date, end_date").eq("renter_id",t.id);if(i)throw i;const x=new Date;x.setHours(0,0,0,0);const m=r.length,C=r.filter(o=>o.status==="confirmed"&&new Date(o.start_date)<=x&&new Date(o.end_date)>=x).length,f=r.filter(o=>o.status==="completed").length,w=r.filter(o=>o.status==="pending").length;return{total:m,active:C,completed:f,pending:w}}});if(c)return e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 px-4",children:[...Array(4)].map((t,r)=>e.jsx(y,{className:"h-20 w-full"},r))});const d=[{title:"Total Bookings",value:(s==null?void 0:s.total)||0,icon:U,iconColor:"text-blue-600",bgColor:"bg-blue-50"},{title:"Active Trips",value:(s==null?void 0:s.active)||0,icon:K,iconColor:"text-green-600",bgColor:"bg-green-50"},{title:"Completed",value:(s==null?void 0:s.completed)||0,icon:W,iconColor:"text-purple-600",bgColor:"bg-purple-50"},{title:"Pending",value:(s==null?void 0:s.pending)||0,icon:D,iconColor:"text-amber-600",bgColor:"bg-amber-50"}];return e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 px-4",children:d.map((t,r)=>e.jsx(v,{className:"overflow-hidden",children:e.jsx(N,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:t.title}),e.jsx("p",{className:"text-lg font-bold",children:t.value})]}),e.jsx("div",{className:`p-2 rounded-full ${t.bgColor}`,children:e.jsx(t.icon,{className:`h-4 w-4 ${t.iconColor}`})})]})})},r))})},pe=()=>{const s=q(),{toast:c}=A(),d=L(),[t,r]=b.useState(""),[i,x]=b.useState("all"),{data:m,isLoading:C,error:f}=$({queryKey:["renter-bookings"],queryFn:async()=>{console.log("Fetching renter bookings");const{data:a}=await h.auth.getSession();if(!a.session)throw new Error("No active session found");const{data:n,error:l}=await h.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            image_url,
            owner_id,
            location,
            price_per_day
          ),
          reviews!reviews_booking_id_fkey (
            id
          )
        `).eq("renter_id",a.session.user.id).order("created_at",{ascending:!1});if(l)throw console.error("Error fetching bookings:",l),l;return console.log("Renter bookings fetched:",n),n},retry:2}),w=async a=>{var l;const{data:n}=await h.auth.getSession();(l=n.session)!=null&&l.user&&await h.from("notifications").insert([{user_id:a.cars.owner_id,type:"booking_cancelled",content:`Booking for ${a.cars.brand} ${a.cars.model} from ${p(new Date(a.start_date),"PPP")} to ${p(new Date(a.end_date),"PPP")} has been cancelled.`,related_car_id:a.car_id,related_booking_id:a.id},{user_id:n.session.user.id,type:"booking_cancelled",content:`Your booking for ${a.cars.brand} ${a.cars.model} from ${p(new Date(a.start_date),"PPP")} to ${p(new Date(a.end_date),"PPP")} has been cancelled.`,related_car_id:a.car_id,related_booking_id:a.id}])},o=async a=>{try{const n=m==null?void 0:m.find(E=>E.id===a);if(!n)return;const{error:l}=await h.from("bookings").update({status:"cancelled"}).eq("id",a);if(l)throw console.error("Error updating booking:",l),l;await w(n),await d.invalidateQueries({queryKey:["renter-bookings"]}),c({title:"Success",description:"Booking cancelled successfully",variant:"default"})}catch(n){console.error("Error cancelling booking:",n),c({title:"Error",description:"Failed to cancel booking",variant:"destructive"}),d.invalidateQueries({queryKey:["renter-bookings"]})}},u=m==null?void 0:m.filter(a=>{const n=t===""||a.cars.brand.toLowerCase().includes(t.toLowerCase())||a.cars.model.toLowerCase().includes(t.toLowerCase())||a.cars.location.toLowerCase().includes(t.toLowerCase()),l=i==="all"||a.status===i;return n&&l});return b.useEffect(()=>{f&&(console.error("Booking query error:",f),c({title:"Error loading bookings",description:"Please try again later or contact support",variant:"destructive"}))},[f,c]),C?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(_,{variant:"ghost",size:"icon",disabled:!0,children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Bookings"})]}),e.jsx(M,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(v,{children:e.jsx(N,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})}),e.jsx(v,{children:e.jsx(N,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})}),e.jsx(v,{children:e.jsx(N,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})})]})]}),e.jsx(P,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(_,{variant:"ghost",size:"icon",onClick:()=>s(-1),children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Bookings"})]}),e.jsx(M,{}),e.jsx(X,{searchTerm:t,onSearchChange:r,statusFilter:i,onStatusChange:x}),e.jsx("div",{className:"px-4",children:(u==null?void 0:u.length)===0?e.jsx("div",{className:"text-center py-8 border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:t||i!=="all"?"No bookings match your search criteria.":"You don't have any bookings yet."})}):e.jsx("div",{className:"space-y-4",children:u==null?void 0:u.map(a=>e.jsx(G,{booking:a,onCancelBooking:o},a.id))})})]}),e.jsx(P,{})]})};export{pe as default};
