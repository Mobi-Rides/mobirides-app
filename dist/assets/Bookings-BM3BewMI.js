import{c as z,r as l,j as e,b as x,u as C,B as N,E as w,X as M,q as L,K as q,s as u}from"./index-BAM2AQzj.js";import{a as A}from"./useQuery-BBHzqejZ.js";import{N as _}from"./Navigation-DcFnTla_.js";import{S as y}from"./skeleton-nH5YszIf.js";import{B as o}from"./badge-La64XLSg.js";import{T as F,a as Q,b as H,c as K}from"./tooltip-BIm-gO95.js";import{A as U}from"./arrow-right-CC1csBZ0.js";import{C as k}from"./clock-DcRTzakL.js";import{f as m}from"./format-BOBWS5Wu.js";import{C as g,d as v}from"./card-C82ETfr4.js";import{M as W}from"./map-pin-CoQHT-KY.js";import{A as P}from"./arrow-left-ZSxCSMqd.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const T=z("CalendarDays",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]),E=l.forwardRef(({className:s,...a},t)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:t,className:x("w-full caption-bottom text-sm",s),...a})}));E.displayName="Table";const D=l.forwardRef(({className:s,...a},t)=>e.jsx("thead",{ref:t,className:x("[&_tr]:border-b",s),...a}));D.displayName="TableHeader";const R=l.forwardRef(({className:s,...a},t)=>e.jsx("tbody",{ref:t,className:x("[&_tr:last-child]:border-0",s),...a}));R.displayName="TableBody";const Y=l.forwardRef(({className:s,...a},t)=>e.jsx("tfoot",{ref:t,className:x("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",s),...a}));Y.displayName="TableFooter";const b=l.forwardRef(({className:s,...a},t)=>e.jsx("tr",{ref:t,className:x("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",s),...a}));b.displayName="TableRow";const f=l.forwardRef(({className:s,...a},t)=>e.jsx("th",{ref:t,className:x("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",s),...a}));f.displayName="TableHead";const p=l.forwardRef(({className:s,...a},t)=>e.jsx("td",{ref:t,className:x("p-4 align-middle [&:has([role=checkbox])]:pr-0",s),...a}));p.displayName="TableCell";const V=l.forwardRef(({className:s,...a},t)=>e.jsx("caption",{ref:t,className:x("mt-4 text-sm text-muted-foreground",s),...a}));V.displayName="TableCaption";const X=({booking:s,onCancelBooking:a})=>{const t=C(),r=()=>{t(`/rental-details/${s.id}`)},n=j=>{j.stopPropagation(),a(s.id)},h=()=>{switch(s.status){case"pending":return e.jsxs(o,{variant:"outline",className:"flex items-center gap-1",children:[e.jsx(k,{className:"h-3 w-3"})," Pending"]});case"confirmed":return e.jsxs(o,{variant:"success",className:"bg-green-100 text-green-800 flex items-center gap-1",children:[e.jsx(w,{className:"h-3 w-3"})," Confirmed"]});case"cancelled":return e.jsxs(o,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(M,{className:"h-3 w-3"})," Cancelled"]});case"completed":return e.jsxs(o,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(w,{className:"h-3 w-3"})," Completed"]});default:return e.jsx(o,{children:s.status})}};return e.jsxs(b,{className:"cursor-pointer hover:bg-muted/80 transition-colors",onClick:r,children:[e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:s.cars.image_url||"/placeholder.svg",alt:`${s.cars.brand} ${s.cars.model}`,className:"w-10 h-10 object-cover rounded"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"font-medium truncate",children:[s.cars.brand," ",s.cars.model]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.cars.location})]})]})}),e.jsx(p,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm font-medium",children:m(new Date(s.start_date),"PPP")}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["to ",m(new Date(s.end_date),"PPP")]})]})}),e.jsx(p,{children:h()}),e.jsx(p,{children:e.jsxs("p",{className:"font-medium",children:["BWP ",s.total_price]})}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[s.status==="pending"&&e.jsx(N,{variant:"outline",size:"sm",onClick:n,children:"Cancel"}),e.jsx(F,{children:e.jsxs(Q,{children:[e.jsx(H,{asChild:!0,children:e.jsx(N,{variant:"ghost",size:"icon",children:e.jsx(U,{className:"h-4 w-4"})})}),e.jsx(K,{children:e.jsx("p",{children:"View Details"})})]})})]})})]})},B=s=>typeof window<"u"?window.matchMedia(s).matches:!1;function G(s){const[a,t]=l.useState(B(s));return l.useEffect(()=>{function r(){t(B(s))}const n=window.matchMedia(s);return r(),n.addListener?n.addListener(r):n.addEventListener("change",r),()=>{n.removeListener?n.removeListener(r):n.removeEventListener("change",r)}},[s]),a}const I=({booking:s,onCancelBooking:a})=>{const t=C(),r=()=>{t(`/rental-details/${s.id}`)},n=j=>{j.stopPropagation(),a(s.id)},h=()=>{switch(s.status){case"pending":return e.jsxs(o,{variant:"outline",className:"flex items-center gap-1 w-24  h-2 text-xs ",children:[e.jsx(k,{className:"h-3 w-3"})," Pending"]});case"confirmed":return e.jsxs(o,{variant:"success",className:"bg-green-100 text-green-800 flex items-center gap-1 w-24  h-2text-xs",children:[e.jsx(w,{className:"h-3 w-3"})," Confirmed"]});case"cancelled":return e.jsxs(o,{variant:"destructive",className:"flex items-center gap-1 w-24  h-2text-xs",children:[e.jsx(M,{className:"h-3 w-3"})," Cancelled"]});case"completed":return e.jsxs(o,{variant:"default",className:"flex items-center gap-1 w-24  h-2text-xs",children:[e.jsx(w,{className:"h-3 w-3"})," Completed"]});default:return e.jsx(o,{children:s.status})}};return e.jsx(g,{className:"cursor-pointer hover:bg-muted/50 transition-colors overflow-hidden",onClick:r,children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("img",{src:s.cars.image_url||"/placeholder.svg",alt:`${s.cars.brand} ${s.cars.model}`,className:"w-20 h-20 object-cover rounded-md flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"mb-3",children:h()}),e.jsx("div",{className:"flex justify-between items-start",children:e.jsx("div",{children:e.jsxs("h3",{className:"font-medium truncate",children:[s.cars.brand," ",s.cars.model]})})})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground truncate mb-1 flex items-center gap-1",children:[e.jsx(W,{size:12,className:"text-red-500"})," ",s.cars.location]}),e.jsx("div",{className:"flex flex-col justify-start items-start",children:e.jsxs("span",{className:"font-medium flex gap-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(T,{size:12,className:"text-blue-500"})," ",m(new Date(s.start_date),"PP")," -"]})," ",e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(T,{size:12,className:"text-blue-500"})," ",m(new Date(s.end_date),"PP")]})]})}),e.jsx("div",{className:"flex justify-end items-center",children:e.jsxs("span",{className:"font-medium text-base text-primary",children:["BWP ",s.total_price]})})]}),s.status==="pending"&&e.jsx("div",{className:"flex justify-end mt-1",children:e.jsx(N,{variant:"outline",size:"sm",onClick:n,children:"Cancel"})})]})})})},J=({bookings:s,onCancelBooking:a})=>{console.log("BookingTable received bookings:",s);const t=G("(min-width: 640px)");return s!=null&&s.length?t?e.jsx("div",{className:"rounded-md border overflow-hidden",children:e.jsxs(E,{children:[e.jsx(D,{children:e.jsxs(b,{children:[e.jsx(f,{children:"Car"}),e.jsx(f,{children:"Dates"}),e.jsx(f,{children:"Status"}),e.jsx(f,{children:"Price"}),e.jsx(f,{className:"text-right",children:"Actions"})]})}),e.jsx(R,{children:s.map(r=>e.jsx(X,{booking:r,onCancelBooking:a},r.id))})]})}):e.jsx("div",{className:"space-y-4",children:s.map(r=>e.jsx(I,{booking:r,onCancelBooking:a},r.id))}):e.jsx("div",{className:"text-center py-8 border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:"You don't have any bookings yet."})})},oe=()=>{const s=C(),{toast:a}=L(),t=q();l.useEffect(()=>{(async()=>{const{data:i}=await u.auth.getSession();console.log("Current session:",i.session)})()},[]);const{data:r,isLoading:n,error:h}=A({queryKey:["bookings"],queryFn:async()=>{console.log("Fetching user bookings");const{data:c}=await u.auth.getSession();if(console.log("Current user session:",c.session),!c.session)throw new Error("No active session found");const{data:i,error:d}=await u.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            image_url,
            owner_id,
            location,
            price_per_day
          ),
          reviews!reviews_booking_id_fkey (
            id
          )
        `).eq("renter_id",c.session.user.id).order("created_at",{ascending:!1});if(d)throw console.error("Error fetching bookings:",d),d;return console.log("Bookings fetched:",i),i},retry:2}),j=async c=>{var d;const{data:i}=await u.auth.getSession();(d=i.session)!=null&&d.user&&await u.from("notifications").insert([{user_id:c.cars.owner_id,type:"booking_cancelled",content:`Booking for ${c.cars.brand} ${c.cars.model} from ${m(new Date(c.start_date),"PPP")} to ${m(new Date(c.end_date),"PPP")} has been cancelled.`,related_car_id:c.car_id,related_booking_id:c.id},{user_id:i.session.user.id,type:"booking_cancelled",content:`Your booking for ${c.cars.brand} ${c.cars.model} from ${m(new Date(c.start_date),"PPP")} to ${m(new Date(c.end_date),"PPP")} has been cancelled.`,related_car_id:c.car_id,related_booking_id:c.id}])},$=async c=>{try{const i=r==null?void 0:r.find(S=>S.id===c);if(!i)return;const{error:d}=await u.from("bookings").update({status:"cancelled"}).eq("id",c);if(d)throw console.error("Error updating booking:",d),d;await j(i),await t.invalidateQueries({queryKey:["bookings"]}),a({title:"Success",description:"Booking cancelled successfully",variant:"default"})}catch(i){console.error("Error cancelling booking:",i),a({title:"Error",description:"Failed to cancel booking",variant:"destructive"}),t.invalidateQueries({queryKey:["bookings"]})}};return l.useEffect(()=>{h&&(console.error("Booking query error:",h),a({title:"Error loading bookings",description:"Please try again later or contact support",variant:"destructive"}))},[h,a]),l.useEffect(()=>{!n&&(!r||r.length===0)&&console.log("No bookings found in the query result")},[r,n]),n?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(N,{variant:"ghost",size:"icon",disabled:!0,children:e.jsx(P,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Booking"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{children:e.jsx(v,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})}),e.jsx(g,{children:e.jsx(v,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})}),e.jsx(g,{children:e.jsx(v,{className:"p-4",children:e.jsx(y,{className:"h-20 w-full"})})})]})]}),e.jsx(_,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>s(-1),children:e.jsx(P,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Booking"})]}),e.jsx("div",{className:"px-4",children:e.jsx(J,{bookings:r,onCancelBooking:$})})]}),e.jsx(_,{})]})};export{oe as default};
