import{s as H,r,j as e,X as E,B as k,F as g,G as z,p as R,H as A}from"./index-BAM2AQzj.js";import{N as S}from"./Navigation-DcFnTla_.js";import{u as G,H as U,C as V}from"./CustomMapbox-DZ6yZBZD.js";import{g as X}from"./OnlineStatusToggle-D0TJLYj4.js";import{C as _,d as I}from"./card-C82ETfr4.js";import{P as $}from"./progress-DBm_9X_r.js";import{M as L}from"./map-pin-CoQHT-KY.js";import{C as J}from"./car-BcLi7tRD.js";import"./useQuery-BBHzqejZ.js";import"./badge-La64XLSg.js";import"./arrow-left-ZSxCSMqd.js";import"./send-CyKCJr7A.js";import"./arrow-right-CC1csBZ0.js";import"./handoverService-DSRl_wMq.js";const F=async()=>{try{const{data:s,error:t}=await H.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(t)return console.error("Error checking location columns:",t),!1;if(!s||s.length===0)return console.error("No profiles found to check columns"),!1;const o=s[0];return o?"latitude"in o&&"longitude"in o&&"is_sharing_location"in o:!1}catch(s){return console.error("Error in checkLocationColumns:",s),!1}},M=s=>!s||typeof s!="object"?null:{id:typeof s.id=="string"?s.id:"",full_name:s.full_name||null,avatar_url:s.avatar_url||null,latitude:typeof s.latitude=="number"?s.latitude:null,longitude:typeof s.longitude=="number"?s.longitude:null,updated_at:s.updated_at||null},K=async()=>{try{if(console.log("Fetching online hosts..."),!await F())return console.error("Required location columns don't exist in profiles table"),[];const{data:t,error:o}=await H.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(o)return console.error("Error fetching online hosts:",o),[];if(!t||!Array.isArray(t))return console.error("Expected array of hosts but got:",t),[];console.log(`Found ${t.length} online hosts`);const l=[];for(const f of t){const m=M(f);m&&l.push(m)}return l}catch(s){return console.error("Error in fetchOnlineHosts:",s),[]}},Q=async s=>{try{if(console.log("Fetching host by ID:",s),!await F())return console.error("Required location columns don't exist in profiles table"),null;const{data:o,error:l}=await H.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("id",s).single();return l?(console.error("Error fetching host:",l),null):o?M(o):(console.error("No host found with ID:",s),null)}catch(t){return console.error("Error in fetchHostById:",t),null}},W=({isOpen:s,onClose:t,getDestination:o,getHostID:l,isHostUser:f})=>{var j,c,x,v;const{isLoading:m,isHost:h,bookingDetails:a,destination:i,ownerId:y}=G(),[u,p]=r.useState(1);r.useEffect(()=>{if(i){const{latitude:w,longitude:b}=i;o==null||o(w,b)}},[o,i]),r.useEffect(()=>{h!=null&&(l(y),f(h))},[]);const N=()=>{g.success("Handover process completed successfully!"),t()};return m?e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:s?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:t}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[85vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Car Handover"}),e.jsxs("button",{onClick:t,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(E,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),e.jsx("div",{className:"flex items-center justify-center h-full mt-6",children:e.jsxs("div",{className:"animate-pulse space-y-4 w-full",children:[e.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mx-auto"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})})]})})]}):e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:s?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:t}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[85vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Car Handover"}),e.jsxs("button",{onClick:t,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(E,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx($,{value:u*50,className:"h-2"}),e.jsxs("div",{className:"flex justify-between mt-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:"Start"}),e.jsx("span",{children:"Complete"})]})]}),e.jsx(_,{className:"mt-6",children:e.jsx(I,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(L,{className:"h-5 w-5 text-primary mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"Destination"}),i?e.jsxs("p",{className:"text-sm mt-1",children:["Latitude: ",i.latitude,", Longitude:"," ",i.longitude]}):e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Destination not available"})]})]})})}),e.jsx(_,{className:"mt-4",children:e.jsx(I,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(J,{className:"h-5 w-5 text-primary mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"Vehicle"}),e.jsxs("p",{className:"text-sm mt-1",children:[(j=a==null?void 0:a.car)==null?void 0:j.brand," ",(c=a==null?void 0:a.car)==null?void 0:c.model]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(x=a==null?void 0:a.car)==null?void 0:x.year," â€¢ ",(v=a==null?void 0:a.car)==null?void 0:v.color]})]})]})})}),e.jsxs("div",{className:"mt-6 space-y-3",children:[u===1&&e.jsx(k,{className:"w-full",onClick:()=>p(2),children:"Proceed to Handover"}),u===2&&e.jsx(k,{className:"w-full",onClick:N,children:"Complete Handover"})]})]})})]})},ue=()=>{const[s]=z(),t=s.get("mode"),o=s.get("bookingId"),[l,f]=r.useState(""),[m,h]=r.useState(!0),[a,i]=r.useState([]),[y,u]=r.useState(!1),[p,N]=r.useState({latitude:null,longitude:null}),{theme:j}=R(),c=!!(t==="handover"&&o),[x,v]=r.useState(null),[w,b]=r.useState(!1),P=r.useCallback((n,d)=>{console.log("Setting destination",n,d),N({latitude:n,longitude:d})},[]),T=r.useCallback(n=>{console.log("Handover host",n),v(n)},[]),B=r.useCallback(n=>{console.log("Is user host?",n),b(n)},[]);r.useEffect(()=>{c&&u(!0)},[c]),r.useEffect(()=>{(async()=>{h(!0);try{const d=await X();if(!d){g.error("Failed to get the map token"),console.error("Failed to get the map token");return}f(d)}catch(d){console.error("Error getting the map token:",d),g.error("Failed to get the map token")}finally{h(!1)}})()},[]);const O=async()=>{console.log("Fetching host locations...");try{const n=await K(),d=await Q(x);if(n.length||g.info("No hosts are currently online"),x)return i([d]);console.log("Host locations",n),i(n)}catch(n){console.error("Error fetching host locations:",n),g.error("Failed to fetch host locations")}};r.useEffect(()=>{c||(O(),console.log("Location",p))},[c]);const q=()=>j==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",C=()=>m?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:"Loading map..."}),e.jsx(A,{color:"#7c3aed",width:100})]}):l?e.jsx(V,{mapbox_token:l,longitude:25.90859,latitude:-24.65451,onlineHosts:c?[]:a,mapStyle:q(),isHandoverMode:c,bookingId:o,dpad:!0,locationToggle:!0,destination:p}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]});return e.jsx("div",{className:"min-h-screen bg-background dark:bg-gray-900",children:c?e.jsxs(U,{children:[e.jsxs("main",{className:"pb-16",children:[e.jsx("div",{className:"h-[calc(100vh-4rem)]",children:C()}),e.jsx("div",{className:"fixed bottom-20 left-0 right-0 z-10 flex justify-center",children:e.jsxs(k,{className:"shadow-lg",onClick:()=>u(!0),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Handover Details"]})})]}),e.jsx(W,{isOpen:y,onClose:()=>u(!1),getDestination:P,getHostID:T,isHostUser:B}),e.jsx(S,{})]}):e.jsxs(e.Fragment,{children:[e.jsx("main",{className:"pb-16",children:e.jsx("div",{className:"h-[calc(100vh-4rem)]",children:C()})}),e.jsx(S,{})]})})};export{ue as default};
