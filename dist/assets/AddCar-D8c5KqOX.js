import{k as I,E as V,z as k,r as d,j as i,B as A,s as c}from"./index-B1v-fdDy.js";import{N as L}from"./Navigation-B7IoAuwX.js";import{C as P}from"./CarForm-Dbwh12WY.js";import{V as D}from"./VerificationRequiredDialog-BhXpjI7V.js";import{u as O}from"./useVerificationStatus-BsTQxagy.js";import{A as Y}from"./arrow-left-C5bMyyle.js";import"./badge-CMWgFMV2.js";import"./user-ClMVbWgE.js";import"./select-DXEtncUe.js";import"./index-BdQq_4o_.js";import"./check-BnE2eJB3.js";import"./textarea-iq9NORl0.js";import"./ImageUpload-iLTkREmh.js";import"./camera-BVx23dB2.js";import"./separator-BMDiheLN.js";import"./checkbox-ldtIqlPC.js";import"./shield-BbSxX3Ts.js";import"./file-text-25BybcTk.js";import"./phone-C1RE3XPx.js";import"./circle-check-big-BC5npB6H.js";import"./arrow-right-wlC4lylp.js";const ne=()=>{const p=I(),{toast:f}=V();k();const[v,y]=d.useState(!1),[b,E]=d.useState(null),[S,U]=d.useState([]),[w,x]=d.useState(!1),{isVerified:N,isLoading:_}=O(),j={brand:"",model:"",year:new Date().getFullYear(),vehicle_type:"",price_per_day:"",location:"",transmission:"",fuel:"",seats:0,description:"",latitude:0,longitude:0,features:[]};d.useEffect(()=>{(async()=>{const{data:{session:t}}=await c.auth.getSession();if(!(t!=null&&t.user)){p("/login");return}E(t.user.id)})()},[p]);const h=async(e,t)=>{console.log(`Attempting to upload document to ${t}`);try{const r=e.name.split(".").pop(),u=`${crypto.randomUUID()}.${r}`,s=`${t}/${u}`,{error:a}=await c.storage.from("car-documents").upload(s,e);if(a)return console.error("Error uploading document:",a),null;const{data:{publicUrl:n}}=c.storage.from("car-documents").getPublicUrl(s);return console.log(`Document uploaded successfully to ${n}`),n}catch(r){return console.error("Error in uploadDocument:",r),null}},C=async(e,t,r,u)=>{if(console.log("Starting car submission process..."),console.log("Selected features:",u),console.log("Documents received:",r),!b){f({title:"Error",description:"You must be logged in to add a car",variant:"destructive"});return}if(!N&&!_){x(!0);return}y(!0);try{let s=null;if(t){console.log("Uploading main car image...");const o=t.name.split(".").pop(),g=`${`${crypto.randomUUID()}.${o}`}`,{error:l}=await c.storage.from("car-images").upload(g,t);if(l)throw console.error("Error uploading car image:",l),l;const{data:{publicUrl:F}}=c.storage.from("car-images").getPublicUrl(g);s=F,console.log("Car image uploaded successfully:",s)}const a={};if(r.registration){const o=await h(r.registration,"registration");o&&(a.registration=o)}if(r.insurance){const o=await h(r.insurance,"insurance");o&&(a.insurance=o)}if(r.additional&&r.additional.length>0){const o=[];for(let m=0;m<r.additional.length;m++){const g=r.additional[m],l=await h(g,"additional");l&&o.push(l)}o.length>0&&(a.additional=JSON.stringify(o))}console.log("Inserting car data into database..."),console.log("Features to insert:",u),console.log("Document URLs:",a);const{error:n}=await c.from("cars").insert({owner_id:b,image_url:s,price_per_day:parseFloat(e.price_per_day),year:parseInt(e.year.toString()),seats:e.seats,brand:e.brand,model:e.model,vehicle_type:e.vehicle_type,location:e.location,transmission:e.transmission,fuel:e.fuel,description:e.description,features:u||[],is_available:!0});if(n)throw console.error("Error inserting car data:",n),n;console.log("Car listed successfully!"),f({title:"Success",description:"Your car has been listed successfully!"}),p("/")}catch(s){console.error("Error adding car:",s),f({title:"Error",description:"Failed to add your car. Please try again.",variant:"destructive"})}finally{y(!1)}},$=e=>{console.log("Features changed in AddCar:",e),U(e)};return i.jsxs("div",{className:"min-h-screen bg-background text-foreground pb-20",children:[i.jsxs("div",{className:"max-w-2xl mx-auto p-4",children:[i.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[i.jsx(A,{variant:"ghost",size:"icon",onClick:()=>p(-1),className:"shrink-0",children:i.jsx(Y,{className:"h-5 w-5"})}),i.jsx("h1",{className:"text-2xl font-semibold",children:"List Your Car"})]}),i.jsx(P,{initialData:j,selectedFeatures:S,onFeaturesChange:$,onSubmit:C,isSubmitting:v})]}),i.jsx(L,{}),i.jsx(D,{isOpen:w,onClose:()=>x(!1),action:"listing"})]})};export{ne as default};
