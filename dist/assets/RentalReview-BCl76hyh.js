import{u as A,j as e}from"./query-vendor-C7aRRP05.js";import{k as H,u as J,r as o}from"./react-vendor-mnpoGfEl.js";import{B as x,y as C,H as O,s as a,J as S}from"./index-BG7cKZ7G.js";import{C as E,a as R,b as k,d as I}from"./card-DAgyE8vF.js";import{I as Y}from"./ImageUpload-DjMQo_av.js";import{c as z}from"./index-DqZI11Hc.js";import{S as u}from"./separator-D4a-ShQt.js";import{S as K}from"./star-CWAYPfwJ.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./date-vendor-Dhms5dOu.js";import"./camera-CLqjt2OR.js";const ne=()=>{const{bookingId:d}=H(),f=J(),[l,D]=o.useState(0),[g,F]=o.useState(""),[w,p]=o.useState(!1),[h,U]=o.useState([]),[j,q]=o.useState(!1),{data:s,isLoading:B}=A({queryKey:["booking-review",d],queryFn:async()=>{const{data:t,error:r}=await a.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            owner_id,
            vehicle_type,
            image_url,
            owner:profiles!owner_id(
              full_name
            )
          ),
          renter:profiles!renter_id(
            full_name
          )
        `).eq("id",d).single();if(r)throw r;const{data:{user:n}}=await a.auth.getUser(),m=(n==null?void 0:n.id)===t.renter_id;if(m&&(!t.cars.owner||!t.cars.owner.full_name)){const{data:i,error:c}=await a.from("profiles").select("full_name").eq("id",t.cars.owner_id).single();!c&&i&&(t.cars.owner=i)}else if(!m&&(!t.renter||!t.renter.full_name)){const{data:i,error:c}=await a.from("profiles").select("full_name").eq("id",t.renter_id).single();!c&&i&&(t.renter=i)}return console.log("Booking data:",t),t}});o.useEffect(()=>{(async()=>{const{data:{user:r}}=await a.auth.getUser();s&&r&&q(r.id===s.renter_id)})()},[s]);const $=t=>{if(t.target.files){const r=Array.from(t.target.files);U(r)}},L=async()=>{var t;try{p(!0);const{data:{user:r}}=await a.auth.getUser();if(!r)throw new Error("No authenticated user");const n=j?(t=s==null?void 0:s.cars)==null?void 0:t.owner_id:s==null?void 0:s.renter_id;if(!n)throw new Error("No reviewee found");const m=h.map(async y=>{const P=y.name.split(".").pop(),T=`${Date.now()}-${Math.random().toString(36).substring(7)}.${P}`,b=`${s==null?void 0:s.id}/${T}`,{error:_,data:M}=await a.storage.from("return-photos").upload(b,y);if(_)throw _;return b}),i=await Promise.all(m),c="car",{error:v}=await a.from("reviews").insert({booking_id:d,reviewer_id:r.id,reviewee_id:n,car_id:s.car_id,rating:l,comment:g,review_images:i,review_type:c,updated_at:new Date().toISOString()});if(v)throw v;const{error:N}=await a.from("bookings").update({status:"completed"}).eq("id",d);if(N)throw N;S.success("Review submitted successfully"),f("/dashboard")}catch(r){console.error("Error submitting review:",r),S.error("Failed to submit review")}finally{p(!1)}};return B?e.jsx("div",{children:"Loading..."}):!s||!s.cars?e.jsxs("div",{className:"container max-w-2xl py-8",children:[e.jsxs(x,{variant:"ghost",onClick:()=>f(-1),className:"",children:[e.jsx(C,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs(E,{children:[e.jsx(R,{className:"text-left",children:e.jsx(k,{children:"Booking Not Found"})}),e.jsx(I,{children:e.jsx("p",{children:"This booking doesn't exist or has been removed."})})]})]}):e.jsxs("div",{className:"container max-w-2xl py-8",children:[e.jsx("div",{className:"  rounded-lg overflow-hidden mb-6",children:e.jsxs("div",{className:"flex items-center mb-4 relative ",children:[e.jsx("div",{className:"absolute left-0",children:e.jsx(x,{variant:"ghost",onClick:()=>f(-1),className:"p-0",children:e.jsx("div",{className:"flex items-center bg-gray-200 rounded-full p-1",children:e.jsx(C,{className:"h-10 w-10"})})})}),e.jsx("div",{className:"flex-1 text-center",children:e.jsx("h2",{className:"text-base md:text-lg text-slate-800 font-semibold",children:"Leave Review"})})]})}),e.jsxs(E,{className:"rounded-lg overflow-hidden border-none",children:[e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx("img",{src:s.cars.image_url,alt:"Car Image",className:"w-80 h-full rounded-2xl"})}),e.jsxs(R,{className:"text-left",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"px-3 py-1 rounded-2xl text-sm bg-[#F1F0FB] text-[#7C3AED] w-fit mb-2",children:s.cars.vehicle_type}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"h-4 w-4 text-yellow-400"}),e.jsx("p",{className:"text-sm md:text-base font-medium text-gray-300",children:"4.9"})]})]}),e.jsxs(k,{className:"font-medium mb-4 text-left text-lg md:text-xl text-gray-800",children:[s.cars.brand," ",s.cars.model]}),e.jsx(u,{})]}),e.jsxs(I,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"font-medium mb-4 text-left text-2xl md:text-2xl text-gray-800 text-center",children:"How is Your Rental Experience?"}),e.jsx(u,{})]}),e.jsxs("div",{className:"space-y-2 text-left",children:[e.jsx("h6",{className:"font-normal text-gray-400 text-sm md:text-base text-center",children:"Your Overall Rating"}),e.jsx("div",{className:"flex gap-1 text-center justify-center",children:[1,2,3,4,5].map(t=>e.jsx(x,{variant:"ghost",size:"sm",className:t<=l?"text-yellow-500":"",onClick:()=>D(t),children:e.jsx(K,{className:"h-8 w-8 ",fill:t<=l?"currentColor":"none",stroke:(t<=l,"currentColor")})},t))}),e.jsx(u,{})]}),e.jsxs("div",{className:"space-y-2 text-left",children:[e.jsx("h6",{className:"font-medium text-xs",children:"Enter Detailed Review"}),e.jsx(O,{placeholder:`Share your experience with this ${j?"host":"renter"}...`,value:g,onChange:t=>F(t.target.value),className:"min-h-[100px] bg-gray-200 rounded-2xl p-4 placeholder:text-xs"})]}),e.jsxs("div",{className:"space-y-2 text-left",children:[e.jsx(Y,{onImageChange:$}),h.length>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h.length," photo(s) selected"]})]}),e.jsx(x,{onClick:L,disabled:l===0||w,className:"w-full",children:w?"Submitting...":"Submit Review"})]})]})]})};export{ne as RentalReview,ne as default};
