import{c as F,j as a,B as j,r as s,G as K,s as M,F as P,J as $}from"./index-BAM2AQzj.js";import{m as p,O as Q}from"./OnlineStatusToggle-D0TJLYj4.js";import{A as V}from"./arrow-left-ZSxCSMqd.js";import{S as W}from"./send-CyKCJr7A.js";import{A as Z}from"./arrow-right-CC1csBZ0.js";import{a as X}from"./useQuery-BBHzqejZ.js";import{g as Y,u as ee}from"./handoverService-DSRl_wMq.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=F("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=F("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);function oe({onUp:r,onDown:d,onLeft:u,onRight:f,onReset:y}){return a.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[a.jsx("div",{className:"flex gap-1",children:a.jsx(j,{variant:"default",onClick:r,style:{height:40},children:a.jsx(re,{name:"arrow-up",size:24,color:"white"})})}),a.jsxs("div",{className:"flex gap-1",children:[a.jsx(j,{variant:"default",onClick:u,style:{width:20},children:a.jsx(V,{name:"arrow-left",size:24,color:"white"})}),a.jsx(j,{variant:"default",onClick:y,children:a.jsx(W,{name:"arrow-left",size:24,color:"white"})}),a.jsx(j,{variant:"default",onClick:f,style:{width:20},children:a.jsx(Z,{name:"arrow-right",size:24,color:"white"})})]}),a.jsx("div",{className:"flex gap-1",children:a.jsx(j,{variant:"default",onClick:d,style:{height:40},children:a.jsx(te,{name:"arrow-down",size:24,color:"white"})})})]})}const O=s.createContext(void 0),ne=()=>{const r=s.useContext(O);if(!r)throw new Error("useHandover must be used within a HandoverProvider");return r},q=r=>{if(!r)return null;try{if(typeof r=="string"){const d=JSON.parse(r);return{latitude:d.latitude,longitude:d.longitude,address:d.address||"",timestamp:d.timestamp||Date.now()}}else if(typeof r=="object")return{latitude:r.latitude,longitude:r.longitude,address:r.address||"",timestamp:r.timestamp||Date.now()};return null}catch(d){return console.error("Error converting location data:",d),null}},se=r=>r?{id:r.id,booking_id:r.booking_id,host_id:r.host_id,renter_id:r.renter_id,host_ready:!!r.host_ready,renter_ready:!!r.renter_ready,host_location:q(r.host_location),renter_location:q(r.renter_location),handover_completed:!!r.handover_completed,handover_type:r.handover_type||null,status:r.status||null,created_at:r.created_at,updated_at:r.updated_at}:null,pe=({children:r})=>{const[d]=K(),u=d.get("bookingId"),[f,y]=s.useState(null),[h,A]=s.useState(null),[x,L]=s.useState(null),[_,R]=s.useState(null),[w,E]=s.useState(null),[k,t]=s.useState(null),v=async()=>{if(!u)return;const{data:n,error:c}=await M.from("bookings").select("latitude, longitude, car_id").eq("id",u).single();if(c){P.error("Failed to fetch destination"),console.error(c);return}A({latitude:n.latitude,longitude:n.longitude}),L(n.car_id)},m=async()=>{if(x)try{const{data:n,error:c}=await M.from("cars").select("owner_id").eq("id",x).single();c&&console.error("Error getting ownerId",c),R(n.owner_id);return}catch{}};s.useEffect(()=>{u&&v()},[u]),s.useEffect(()=>{x&&m()},[x]),s.useEffect(()=>{(async()=>{const{data:c}=await M.auth.getUser();c!=null&&c.user&&y(c.user.id)})()},[]),s.useEffect(()=>{(async()=>{if(!(!u||!f))try{const c=await Y(u);if(c){E(c.id);const S=se(c);t(S)}}catch(c){console.error("Error fetching handover session:",c)}})()},[u,f]);const{data:T,isLoading:g}=X({queryKey:["handover-booking",u],queryFn:async()=>{if(!u)return null;const{data:n,error:c}=await M.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            id,
            full_name,
            avatar_url
          ),
          car:cars (
            *,
            owner:profiles!owner_id (
              id,
              full_name,
              avatar_url
            )
          )
        `).eq("id",u).single();if(c)throw c;return n},enabled:!!u}),C=f===_,[D,N]=s.useState(!1),H=()=>{N(!D)},I=async({latitude:n,longitude:c,address:S})=>{if(!w||!f)return P.error("Cannot update location: missing handover session or user ID"),!1;const U={latitude:n,longitude:c,address:S,timestamp:Date.now()};try{const b=await ee(w,f,C,U);return b&&P.success("Location updated successfully"),b}catch(b){return console.error("Error updating location:",b),P.error("Failed to update location"),!1}};return a.jsx(O.Provider,{value:{isLoading:g,isHost:C,bookingDetails:T,debugMode:D,toggleDebugMode:H,currentUserId:f,destination:h,ownerId:_,updateLocation:I,handoverStatus:k},children:r})},he=({mapbox_token:r,longitude:d,latitude:u,onlineHosts:f,mapStyle:y="mapbox://styles/mapbox/streets-v12",isHandoverMode:h=!1,bookingId:A,zoom:x,interactive:L,dpad:_,locationToggle:R,destination:w,returnLocation:E})=>{const k=s.useRef(null),t=s.useRef(null),v=s.useRef(null),[m,T]=s.useState(!1),[g,C]=s.useState({latitude:u,longitude:d}),[D,N]=s.useState([]),[H,I]=s.useState([]),n=h?ne():null;s.useEffect(()=>{if(!E)return;const i=g.longitude,o=g.latitude;E(i,o)},[g]),s.useEffect(()=>{if(r&&(p.accessToken=r),!t.current&&k.current&&r){t.current=new p.Map({container:k.current,style:y,center:[d,u],zoom:x||14,interactive:L||!0}),t.current.addControl(new p.NavigationControl,"top-right");const i=new p.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});t.current.addControl(i,"top-right"),v.current=i,i.on("error",o=>{console.error("Geolocation error:",o),$.error("Unable to access your location. Please check your browser permissions."),h&&n&&$.error("Location sharing is required for the handover process. Please enable location access.")}),t.current.on("load",()=>{console.log("Map loaded successfully"),T(!0),v.current&&v.current.on("geolocate",o=>{const e={longitude:o.coords.longitude,latitude:o.coords.latitude};C(e),h&&n&&c(e.latitude,e.longitude).then(l=>{n.updateLocation({latitude:e.latitude,longitude:e.longitude,address:l||"Unknown location"})})}),setTimeout(()=>{v.current&&v.current.trigger()},1e3)}),t.current.on("error",o=>{console.error("Map error:",o),$.error("Error loading map. Please refresh.")})}return()=>{t.current&&(t.current.remove(),t.current=null)}},[r,d,u,y,h,n]);const c=async(i,o)=>{try{const l=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${o},${i}.json?access_token=${r}`)).json();return l.features&&l.features.length>0?l.features[0].place_name:null}catch(e){return console.error("Error fetching address:",e),null}};s.useEffect(()=>{t.current&&m&&t.current.setStyle(y)},[y,m]),s.useEffect(()=>{if(!t.current||!m||!(f!=null&&f.length)||h)return;D.forEach(o=>o.remove()),N([]);const i=f.map(o=>{if(!o.latitude||!o.longitude)return null;const e=document.createElement("div");return e.className="host-marker",e.style.width="20px",e.style.height="20px",e.style.borderRadius="50%",e.style.backgroundColor="#4ade80",e.style.border="2px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",new p.Marker(e).setLngLat([o.longitude,o.latitude]).setPopup(new p.Popup({offset:25}).setHTML(`<p class="font-medium">${o.full_name||"Host"}</p>`)).addTo(t.current)}).filter(Boolean);N(i)},[f,m,h]),s.useEffect(()=>{if(!t.current||!m||!w)return;const{latitude:i,longitude:o}=w,e=document.createElement("div");e.className="destination-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#f59e0b",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const l=new p.Marker(e).setLngLat([o,i]).setPopup(new p.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(t.current);return()=>{l.remove()}}),s.useEffect(()=>{if(!t.current||!m||!w)return;const{latitude:i,longitude:o}=w;return(async()=>{try{const B=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${g.longitude},${g.latitude};${o},${i}?geometries=geojson&access_token=${p.accessToken}`)).json();if(B.routes&&B.routes.length>0){const z=B.routes[0].geometry;t.current.getSource("route")?t.current.getSource("route").setData(z):(t.current.addSource("route",{type:"geojson",data:z}),t.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(l){console.error("Error fetching route:",l)}})(),()=>{t.current&&(t.current.getStyle()&&t.current.getLayer("route")&&t.current.removeLayer("route"),t.current.getStyle()&&t.current.getSource("route")&&t.current.removeSource("route"))}},[m,w,g]),s.useEffect(()=>{if(!t.current||!m||!h||!(n!=null&&n.handoverStatus))return;H.forEach(o=>o.remove()),I([]);const i=[];if(n.handoverStatus.host_location){const o=n.handoverStatus.host_location,e=document.createElement("div");e.className="host-handover-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#3b82f6",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const l=new p.Marker(e).setLngLat([o.longitude,o.latitude]).setPopup(new p.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${o.address}</p>`)).addTo(t.current);i.push(l)}if(n.handoverStatus.renter_location){const o=n.handoverStatus.renter_location,e=document.createElement("div");e.className="renter-handover-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#ec4899",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const l=new p.Marker(e).setLngLat([o.longitude,o.latitude]).setPopup(new p.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${o.address}</p>`)).addTo(t.current);i.push(l)}if(i.length===2&&t.current){const o=new p.LngLatBounds;i.forEach(e=>{o.extend(e.getLngLat())}),t.current.fitBounds(o,{padding:100,maxZoom:15})}I(i)},[n==null?void 0:n.handoverStatus,m,h]);const S=()=>{t.current&&t.current.panBy([0,-100],{duration:500})},U=()=>{t.current&&t.current.panBy([0,100],{duration:500})},b=()=>{t.current&&t.current.panBy([-100,0],{duration:500})},G=()=>{t.current&&t.current.panBy([100,0],{duration:500})},J=()=>{t.current&&t.current.flyTo({center:[g.longitude,g.latitude],zoom:20,essential:!0})};return a.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[a.jsx("div",{ref:k,className:"w-full h-full"}),!h&&a.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:a.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:R&&a.jsx(Q,{lat:g.latitude,long:g.longitude})})}),h&&(n==null?void 0:n.handoverStatus)&&a.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:a.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:a.jsxs("div",{className:"text-center",children:[a.jsxs("p",{className:"text-sm font-medium",children:[n.isHost?"Host":"Renter"," Mode"]}),a.jsx("p",{className:"text-xs text-muted-foreground",children:n.handoverStatus.host_location&&n.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),_&&a.jsx(oe,{onUp:S,onDown:U,onLeft:b,onRight:G,onReset:J})]})};export{he as C,pe as H,ne as u};
