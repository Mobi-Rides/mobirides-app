var M=t=>{throw TypeError(t)};var P=(t,s,a)=>s.has(t)||M("Cannot "+a);var n=(t,s,a)=>(P(t,s,"read from private field"),a?a.call(t):s.get(t)),j=(t,s,a)=>s.has(t)?M("Cannot add the same private member more than once"):s instanceof WeakSet?s.add(t):s.set(t,a),y=(t,s,a,i)=>(P(t,s,"write to private field"),i?i.call(t,a):s.set(t,a),a),N=(t,s,a)=>(P(t,s,"access private method"),a);import{ah as ee,ai as se,aj as F,ak as te,al as Y,K as $,r as v,c as re,j as e,s as _,B as q,M as ae,u as ie,q as ne}from"./index-BAM2AQzj.js";import{n as le,s as oe,a as A}from"./useQuery-BBHzqejZ.js";import{N as ce}from"./Navigation-DcFnTla_.js";import{u as de}from"./useAuthStatus-DIZuW2dv.js";import{a as me,C as z,d as X,e as R}from"./card-C82ETfr4.js";import{W as ue,u as he,c as S}from"./WalletBalanceIndicator-D8z27UAG.js";import{B as xe}from"./badge-La64XLSg.js";import{S as I}from"./star-gaaEOnOW.js";import{C as pe}from"./car-BcLi7tRD.js";import{M as fe}from"./map-pin-CoQHT-KY.js";import{C as G}from"./credit-card-C7ZeWo_M.js";import{C as E}from"./calendar-m5gla_Sa.js";import{f as K}from"./format-BOBWS5Wu.js";import{A as ge,a as be}from"./alert-7WYzCt2j.js";import{W as je}from"./wallet-Bu1-cXfs.js";import{T as ye}from"./trending-up-B0RoWQRT.js";import{C as J}from"./circle-alert-CkQrh4MB.js";import{T,a as W,b as U,c as H}from"./tooltip-BIm-gO95.js";import{C as Ne}from"./circle-check-big-CU0Wzt6B.js";import{A as ve}from"./arrow-left-ZSxCSMqd.js";import"./TopUpModal-BwRCNlbi.js";import"./plus-bFfdWSCz.js";import"./info-Bq3MZNaT.js";import"./triangle-alert-ey-Y21ny.js";var g,b,o,u,h,B,O,Q,we=(Q=class extends ee{constructor(s,a){super();j(this,h);j(this,g);j(this,b);j(this,o);j(this,u);y(this,g,s),this.setOptions(a),this.bindMethods(),N(this,h,B).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(s){var i;const a=this.options;this.options=n(this,g).defaultMutationOptions(s),se(this.options,a)||n(this,g).getMutationCache().notify({type:"observerOptionsUpdated",mutation:n(this,o),observer:this}),a!=null&&a.mutationKey&&this.options.mutationKey&&F(a.mutationKey)!==F(this.options.mutationKey)?this.reset():((i=n(this,o))==null?void 0:i.state.status)==="pending"&&n(this,o).setOptions(this.options)}onUnsubscribe(){var s;this.hasListeners()||(s=n(this,o))==null||s.removeObserver(this)}onMutationUpdate(s){N(this,h,B).call(this),N(this,h,O).call(this,s)}getCurrentResult(){return n(this,b)}reset(){var s;(s=n(this,o))==null||s.removeObserver(this),y(this,o,void 0),N(this,h,B).call(this),N(this,h,O).call(this)}mutate(s,a){var i;return y(this,u,a),(i=n(this,o))==null||i.removeObserver(this),y(this,o,n(this,g).getMutationCache().build(n(this,g),this.options)),n(this,o).addObserver(this),n(this,o).execute(s)}},g=new WeakMap,b=new WeakMap,o=new WeakMap,u=new WeakMap,h=new WeakSet,B=function(){var a;const s=((a=n(this,o))==null?void 0:a.state)??te();y(this,b,{...s,isPending:s.status==="pending",isSuccess:s.status==="success",isError:s.status==="error",isIdle:s.status==="idle",mutate:this.mutate,reset:this.reset})},O=function(s){Y.batch(()=>{var a,i,l,r,x,m,w,k;if(n(this,u)&&this.hasListeners()){const d=n(this,b).variables,p=n(this,b).context;(s==null?void 0:s.type)==="success"?((i=(a=n(this,u)).onSuccess)==null||i.call(a,s.data,d,p),(r=(l=n(this,u)).onSettled)==null||r.call(l,s.data,null,d,p)):(s==null?void 0:s.type)==="error"&&((m=(x=n(this,u)).onError)==null||m.call(x,s.error,d,p),(k=(w=n(this,u)).onSettled)==null||k.call(w,void 0,s.error,d,p))}this.listeners.forEach(d=>{d(n(this,b))})})},Q);function ke(t,s){const a=$(),[i]=v.useState(()=>new we(a,t));v.useEffect(()=>{i.setOptions(t)},[i,t]);const l=v.useSyncExternalStore(v.useCallback(x=>i.subscribe(Y.batchCalls(x)),[i]),()=>i.getCurrentResult(),()=>i.getCurrentResult()),r=v.useCallback((x,m)=>{i.mutate(x,m).catch(le)},[i]);if(l.error&&oe(i.options.throwOnError,[l.error]))throw l.error;return{...l,mutate:r,mutateAsync:l.mutate}}/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const L=re("CircleX",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),Ce=({status:t})=>{const s=a=>{switch(a){case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"confirmed":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"cancelled":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"completed":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"}};return e.jsx(me,{className:"bg-primary/5 dark:bg-primary/10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-semibold text-primary dark:text-primary-foreground",children:"Booking Request Details"}),e.jsx(xe,{className:s(t),children:t.charAt(0).toUpperCase()+t.slice(1)})]})})},_e=({renter:t,renterRating:s})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(I,{className:"h-4 w-4 text-primary"})}),"Renter Information"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:t.avatar_url?_.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",alt:t.full_name,className:"w-16 h-16 rounded-full object-cover border-2 border-primary/20"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:t.full_name}),typeof s=="number"&&e.jsxs("div",{className:"flex items-center gap-1 text-yellow-500 mt-1",children:[e.jsx(I,{className:"h-4 w-4 fill-current"}),e.jsx("span",{children:s.toFixed(1)})]})]})]})]}),qe=({car:t})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(pe,{className:"h-4 w-4 text-primary"})}),"Requested Car"]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("img",{src:t.image_url||"/placeholder.svg",alt:`${t.brand} ${t.model}`,className:"w-full md:w-48 h-32 object-cover rounded-lg"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"font-medium text-lg text-foreground",children:[t.brand," ",t.model]}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),t.location]}),e.jsxs("p",{className:"text-sm font-medium flex items-center",children:[e.jsx(G,{className:"h-4 w-4 mr-1 text-primary"}),"BWP ",t.price_per_day," per day"]})]})]})]}),Be=({startDate:t,endDate:s})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(E,{className:"h-4 w-4 text-primary"})}),"Booking Dates"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(E,{className:"h-4 w-4 mr-2 text-primary"}),K(new Date(t),"PPP")]})]}),e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"End Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(E,{className:"h-4 w-4 mr-2 text-primary"}),K(new Date(s),"PPP")]})]})]})]}),Pe=({totalPrice:t})=>e.jsx("div",{className:"bg-card rounded-lg p-4 border",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(G,{className:"h-4 w-4 text-primary"})}),e.jsx("p",{className:"font-semibold",children:"Total Price"})]}),e.jsxs("p",{className:"text-xl font-bold",children:["BWP ",t]})]})}),Ae=({bookingTotal:t,canApproveBooking:s})=>{const i=t*.15;return e.jsxs("div",{className:"space-y-4 p-6 border-t",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(je,{className:"h-4 w-4 text-primary"})}),"Wallet & Commission"]}),e.jsx(ue,{bookingTotal:t,showCommissionBreakdown:!0}),e.jsx(z,{className:"bg-blue-50 border-blue-200 dark:bg-blue-950 dark:border-blue-800",children:e.jsx(X,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ye,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-blue-800 dark:text-blue-200",children:"Commission Payment"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-700 dark:text-blue-300",children:[e.jsxs("p",{children:["Total Booking: P",t.toFixed(2)]}),e.jsxs("p",{children:["Platform Commission (15%): P",i.toFixed(2)]}),e.jsx("p",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Will be deducted from your wallet balance"})]}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["You'll receive the full rental amount (P",t.toFixed(2),") while commission is paid from your wallet."]})]})]})})}),!s&&e.jsxs(ge,{variant:"destructive",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsxs(be,{children:["You need sufficient wallet balance to cover the P",i.toFixed(2)," commission plus P50 minimum balance to accept this booking."]})]})]})},Re=({isCarOwner:t,isRenter:s,canApproveBooking:a,onApprove:i,onCancel:l,isLoading:r})=>t?e.jsxs(R,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-4 justify-end",children:[e.jsxs(q,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto",onClick:l,disabled:r,children:[e.jsx(L,{className:"h-4 w-4"}),"Reject Request"]}),e.jsx(T,{children:e.jsxs(W,{children:[e.jsx(U,{asChild:!0,children:e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs(q,{className:"flex items-center gap-2 w-full sm:w-auto",onClick:i,disabled:r||!a,children:[e.jsx(Ne,{className:"h-4 w-4"}),"Approve Request"]})})}),!a&&e.jsx(H,{children:e.jsx("p",{children:"Insufficient wallet balance for commission payment"})})]})})]}):s?e.jsx(R,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-4 justify-end",children:e.jsxs(q,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto",onClick:l,disabled:r,children:[e.jsx(L,{className:"h-4 w-4"}),"Cancel Request"]})}):e.jsx(R,{className:"border-t bg-card p-6",children:e.jsx(T,{children:e.jsxs(W,{children:[e.jsx(U,{asChild:!0,children:e.jsxs("div",{className:"flex items-center text-muted-foreground gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Only car owners can approve requests"})]})}),e.jsx(H,{children:e.jsx("p",{children:"You don't have permission to manage this booking request"})})]})})}),as=()=>{const{id:t}=ae(),s=ie(),{toast:a}=ne(),i=$(),{userId:l}=de();he();const{data:r,isLoading:x}=A({queryKey:["booking-request",t],queryFn:async()=>{console.log("Fetching booking request details for ID:",t);const{data:c,error:f}=await _.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            full_name,
            avatar_url
          ),
          car:cars (
            brand,
            model,
            image_url,
            location,
            price_per_day,
            owner_id
          )
        `).eq("id",t).single();if(f)throw f;return c}}),m=l===(r==null?void 0:r.car.owner_id),w=l===(r==null?void 0:r.renter_id),{data:k}=A({queryKey:["renter-rating",r==null?void 0:r.renter_id],queryFn:async()=>{if(!(r!=null&&r.renter_id))return null;const{data:c}=await _.rpc("calculate_user_rating",{user_uuid:r.renter_id});return c},enabled:!!(r!=null&&r.renter_id)}),{data:d}=A({queryKey:["wallet-acceptance-check",l,r==null?void 0:r.total_price],queryFn:async()=>!l||!(r!=null&&r.total_price)||!m?null:await S.checkHostCanAcceptBooking(l,r.total_price),enabled:!!l&&!!(r!=null&&r.total_price)&&m}),p=ke({mutationFn:async({status:c})=>{if(console.log("Updating booking status:",c),c==="confirmed"&&r&&l){const C=await S.checkHostCanAcceptBooking(l,r.total_price);if(!C.canAccept)throw new Error(C.message||"Insufficient wallet balance");if(!await S.deductCommissionOnBookingAcceptance(l,r.id,r.total_price))throw new Error("Failed to process commission payment")}const{error:f}=await _.from("bookings").update({status:c}).eq("id",t);if(f)throw f},onSuccess:(c,f)=>{const C=f.status==="confirmed"?"approved":"cancelled";a({title:`Booking ${C}`,description:f.status==="confirmed"?"Booking approved and commission deducted from your wallet.":"The booking request has been cancelled."}),i.invalidateQueries({queryKey:["booking-request",t]}),i.invalidateQueries({queryKey:["wallet-balance"]})},onError:c=>{console.error("Error updating booking status:",c),a({title:"Error",description:c.message||"Failed to update the booking status. Please try again.",variant:"destructive"})}}),V=()=>{p.mutate({status:"confirmed"})},Z=()=>{p.mutate({status:"cancelled"})};if(x)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})});if(!r)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Booking request not found"})});const D=(d==null?void 0:d.canAccept)??!0;return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(q,{variant:"ghost",className:"mb-6 flex items-center",onClick:()=>s(-1),children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(z,{className:"overflow-hidden",children:[e.jsx(Ce,{status:r.status}),e.jsxs(X,{className:"p-6 space-y-8",children:[e.jsx(_e,{renter:r.renter,renterRating:k}),e.jsx(qe,{car:r.car}),e.jsx(Be,{startDate:r.start_date,endDate:r.end_date}),e.jsx(Pe,{totalPrice:r.total_price})]}),m&&r.status==="pending"&&e.jsx(Ae,{bookingTotal:r.total_price,canApproveBooking:D}),r.status==="pending"&&e.jsx(Re,{isCarOwner:m,isRenter:w,canApproveBooking:D,onApprove:V,onCancel:Z,isLoading:p.isPending})]})}),e.jsx(ce,{})]})};export{as as default};
