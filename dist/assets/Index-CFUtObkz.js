import{j as t,u as O,d as Y}from"./query-vendor-BOSMW7hd.js";import{r as u,u as I,f as $}from"./react-vendor-DmU5vXC9.js";import{H as Q}from"./Header-DXH60Mck.js";import{N as ee}from"./Navigation-fdodg-AN.js";import{u as re}from"./useAuthStatus-hqGqvzqY.js";import{c as q,B as C,A as te,T as se,s as S,a as D,J as L,L as ae}from"./index-ByqmTec-.js";import{C as U}from"./CarGrid-B7K8vBEI.js";import{C as ne}from"./card-Dn1_7TKZ.js";import{C as F}from"./clock-Dg92kA5o.js";import{M as oe}from"./map-pin-B-9tSSOy.js";import{C as ie}from"./car-DcHPLaSp.js";import{a as ce}from"./date-vendor-Dhms5dOu.js";import{u as z}from"./useHandoverPrompts-xQnFIKSR.js";import"./sheet-DHpFSv7b.js";import"./SearchFilters-B8OP1btf.js";import"./calendar-DZfUN7jn.js";import"./chevron-left-BS5IGisg.js";import"./popover-BGqOibZX.js";import"./select-qP77FLvJ.js";import"./index-CEVvJeOa.js";import"./chevron-down-CR2ALfoj.js";import"./LocationSearchInput-DwVh7Fg9.js";import"./star-Dt-lKoZi.js";import"./calendar-Cn2gPQb0.js";import"./arrow-up-down-C8afjVxo.js";import"./useVerificationStatus-DqwvtjbH.js";import"./circle-check-big-BdHHmxBu.js";import"./circle-alert-CcellCUN.js";import"./shield-fAaK4GMV.js";import"./navigation-BoaKLUi7.js";import"./bell-sR4KUoYm.js";import"./user-CrwdbYLY.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./savedCarService-xHNir3Dd.js";import"./VerificationRequiredDialog-DaP3vWFb.js";import"./file-text-4CeUdrl2.js";import"./camera-DAu_2Lp7.js";import"./arrow-right-RRvKZqjh.js";/* empty css                  */import"./skeleton-CLXLgSMQ.js";import"./circle-check-D1fO9Ysx.js";import"./separator-D3RZtFXH.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=q("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=q("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=q("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]),le=()=>{const[e,r]=u.useState(!1),[a,s]=u.useState("signin"),n=I(),o=u.useCallback(()=>{s("signin"),r(!0),n("/?auth=signin",{replace:!0})},[n]),i=u.useCallback(()=>{s("signup"),r(!0),n("/?auth=signup",{replace:!0})},[n]),l=u.useCallback(()=>{r(!1),n("/",{replace:!0})},[n]);return{isOpen:e,defaultTab:a,openSignIn:o,openSignUp:i,close:l,setIsOpen:r}},ue=()=>{const{isOpen:e,defaultTab:r,openSignIn:a,close:s}=le(),n=$();return u.useEffect(()=>{const i=new URLSearchParams(n.search).get("auth");(i==="signin"||i==="signup")&&i==="signin"&&a()},[n.search,a]),t.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[t.jsxs("div",{className:"p-8 rounded-lg",children:[t.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),t.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),t.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:a,children:[t.jsx(de,{className:"h-4 w-4 text-primary"}),t.jsx("span",{className:"hidden md:inline-block",children:t.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),t.jsx(te,{isOpen:e,onClose:s,defaultTab:r})]})},K=({prompt:e,onStartHandover:r})=>{const a=I(),s=()=>{switch(e.urgencyLevel){case"immediate":return"bg-destructive text-destructive-foreground border-destructive";case"soon":return"bg-orange-50 text-orange-900 border-orange-200 dark:bg-orange-950 dark:text-orange-100 dark:border-orange-800";case"morning":return"bg-blue-50 text-blue-900 border-blue-200 dark:bg-blue-950 dark:text-blue-100 dark:border-blue-800";default:return"bg-muted text-muted-foreground"}},n=()=>{switch(e.urgencyLevel){case"immediate":return t.jsx(se,{className:"h-5 w-5 animate-pulse"});case"soon":return t.jsx(F,{className:"h-5 w-5"});default:return t.jsx(ie,{className:"h-5 w-5"})}},o=()=>{r(e.bookingId)},i=()=>{a(`/rental-details/${e.bookingId}`)};return t.jsx(ne,{className:`p-4 border-l-4 ${s()}`,children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:"flex-shrink-0 mt-0.5",children:n()}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("h3",{className:"font-semibold text-sm",children:e.handoverType==="pickup"?"Car Pickup Required":"Car Return Required"}),e.isUrgent&&t.jsx("span",{className:"px-2 py-1 text-xs bg-current/10 rounded-full font-medium",children:"URGENT"})]}),t.jsxs("p",{className:"text-sm opacity-90 mb-2",children:[e.carBrand," ",e.carModel," â€¢ ",e.otherPartyName]}),t.jsxs("div",{className:"flex items-center gap-4 text-xs opacity-75 mb-3",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(F,{className:"h-3 w-3"}),ce(e.handoverType==="pickup"?e.startDate:e.endDate,"MMM d, h:mm a")]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(oe,{className:"h-3 w-3"}),e.location]})]}),t.jsxs("div",{className:"flex gap-2",children:[e.shouldInitiate?t.jsxs(C,{onClick:o,size:"sm",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",variant:"outline",children:["Start ",e.handoverType==="pickup"?"Pickup":"Return"]}):t.jsxs(C,{onClick:i,size:"sm",variant:"outline",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",children:["Prepare for ",e.handoverType==="pickup"?"Pickup":"Return"]}),t.jsx(C,{onClick:i,size:"sm",variant:"ghost",className:"text-current hover:bg-current/10",children:"View Details"})]})]})]})})},me=({searchQuery:e})=>{const[r,a]=u.useState(null),[s,n]=u.useState("asc"),o=u.useRef(null),i=I(),{handoverPrompts:l,hasHandoverPrompts:h,refetch:x}=z(),{data:f,isLoading:y,error:M}=O({queryKey:["host-cars",e,s,r],queryFn:async()=>{var v;console.log("Fetching host cars with search:",e,"brand:",r);const{data:{session:m}}=await S.auth.getSession();if(!((v=m==null?void 0:m.user)!=null&&v.id))return[];let c=S.from("cars").select("*").eq("owner_id",m.user.id);e&&(c=c.or(`brand.ilike.%${e}%,model.ilike.%${e}%`)),r&&(c=c.eq("brand",r)),c=c.order("price_per_day",{ascending:s==="asc"});const{data:g,error:p}=await c;if(p)throw p;return console.log("Host cars fetched:",g),g}}),j=f||[],N=()=>{n(m=>m==="asc"?"desc":"asc")},w=()=>{console.log("Load more triggered in HostView")},k=async m=>{try{console.log("Starting handover for booking:",m);const{data:c,error:g}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",m).single();if(g)throw g;if(!c)throw new Error("Booking not found");const p=c.cars.owner_id,v=c.renter_id;await D(m,p,v,"pickup")&&(L.success("Handover process started"),i(`/map?bookingId=${m}&mode=handover&role=host`),x())}catch(c){console.error("Error starting handover:",c),L.error("Failed to start handover process")}};return t.jsxs("div",{className:"space-y-6",children:[h&&t.jsx("div",{className:"space-y-3",children:l.map(m=>t.jsx(K,{prompt:m,onStartHandover:k},m.id))}),t.jsx("div",{className:"flex justify-end",children:t.jsx(C,{variant:s?"secondary":"outline",onClick:N,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?t.jsxs(t.Fragment,{children:["Price: Low to High",t.jsx(G,{className:"h-4 w-4"})]}):t.jsxs(t.Fragment,{children:["Price: High to Low",t.jsx(Z,{className:"h-4 w-4"})]})})}),t.jsx("div",{className:"text-left flex items-center ",children:t.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),t.jsx(U,{cars:j,isLoading:y,error:M,loadMoreRef:o,onLoadMore:w,isFetchingNextPage:!1,isAuthenticated:!0})]})};var H=new Map,E=new WeakMap,B=0,he=void 0;function ge(e){return e?(E.has(e)||(B+=1,E.set(e,B.toString())),E.get(e)):"0"}function xe(e){return Object.keys(e).sort().filter(r=>e[r]!==void 0).map(r=>`${r}_${r==="root"?ge(e.root):e[r]}`).toString()}function pe(e){const r=xe(e);let a=H.get(r);if(!a){const s=new Map;let n;const o=new IntersectionObserver(i=>{i.forEach(l=>{var h;const x=l.isIntersecting&&n.some(f=>l.intersectionRatio>=f);e.trackVisibility&&typeof l.isVisible>"u"&&(l.isVisible=x),(h=s.get(l.target))==null||h.forEach(f=>{f(x,l)})})},e);n=o.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),a={id:r,observer:o,elements:s},H.set(r,a)}return a}function fe(e,r,a={},s=he){if(typeof window.IntersectionObserver>"u"&&s!==void 0){const h=e.getBoundingClientRect();return r(s,{isIntersecting:s,target:e,intersectionRatio:typeof a.threshold=="number"?a.threshold:0,time:0,boundingClientRect:h,intersectionRect:h,rootBounds:h}),()=>{}}const{id:n,observer:o,elements:i}=pe(a),l=i.get(e)||[];return i.has(e)||i.set(e,l),l.push(r),o.observe(e),function(){l.splice(l.indexOf(r),1),l.length===0&&(i.delete(e),o.unobserve(e)),i.size===0&&(o.disconnect(),H.delete(n))}}function ve({threshold:e,delay:r,trackVisibility:a,rootMargin:s,root:n,triggerOnce:o,skip:i,initialInView:l,fallbackInView:h,onChange:x}={}){var f;const[y,M]=u.useState(null),j=u.useRef(x),[N,w]=u.useState({inView:!!l,entry:void 0});j.current=x,u.useEffect(()=>{if(i||!y)return;let g;return g=fe(y,(p,v)=>{w({inView:p,entry:v}),j.current&&j.current(p,v),v.isIntersecting&&o&&g&&(g(),g=void 0)},{root:n,rootMargin:s,threshold:e,trackVisibility:a,delay:r},h),()=>{g&&g()}},[Array.isArray(e)?e.toString():e,y,n,s,o,i,a,h,r]);const k=(f=N.entry)==null?void 0:f.target,m=u.useRef(void 0);!y&&k&&!o&&!i&&m.current!==k&&(m.current=k,w({inView:!!l,entry:void 0}));const c=[M,N.inView,N.entry];return c.ref=c[0],c.inView=c[1],c.entry=c[2],c}const T=10,be=async({pageParam:e=0,filters:r,searchParams:a})=>{console.log("Starting car fetch with params:",{pageParam:e,filters:r,searchParams:a});let s=S.from("cars").select("*",{count:"exact"});s=s.range(e*T,(e+1)*T-1),a!=null&&a.searchTerm&&(console.log("Applying search term:",a.searchTerm),s=s.or(`brand.ilike.%${a.searchTerm}%,model.ilike.%${a.searchTerm}%`)),a!=null&&a.brand&&(console.log("Filtering by brand:",a.brand),s=s.eq("brand",a.brand)),r!=null&&r.model&&(s=s.ilike("model",`%${r.model}%`)),r!=null&&r.year&&(s=s.eq("year",r.year)),r!=null&&r.minPrice&&(s=s.gte("price_per_day",r.minPrice)),r!=null&&r.maxPrice&&(s=s.lte("price_per_day",r.maxPrice)),r!=null&&r.vehicleType&&(s=s.eq("vehicle_type",r.vehicleType)),r!=null&&r.location&&(s=s.ilike("location",`%${r.location}%`)),(r==null?void 0:r.sortBy)==="price"&&(s=s.order("price_per_day",{ascending:r.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:n,error:o,count:i}=await s;if(o)throw console.error("Error fetching cars:",o),o;return console.log("Cars fetched successfully:",{count:i,dataLength:n==null?void 0:n.length}),{data:n||[],nextPage:n&&n.length===T?e+1:void 0,count:i}},ye=({searchQuery:e,filters:r,onFiltersChange:a})=>{const[s,n]=u.useState(null),[o,i]=u.useState("asc"),{ref:l,inView:h}=ve(),x=u.useRef(null),f=I(),{handoverPrompts:y,hasHandoverPrompts:M,refetch:j}=z(),N=d=>{x.current!==d&&(x.current=d||null),l(d)};u.useEffect(()=>{a({...r,sortOrder:o})},[o,a]);const{data:w,isLoading:k,error:m,hasNextPage:c,fetchNextPage:g,isFetchingNextPage:p}=Y({queryKey:["available-cars",s,r,e],queryFn:({pageParam:d=0})=>be({pageParam:d,filters:r,searchParams:{...s?{brand:s}:{},...e?{searchTerm:e}:{}}}),getNextPageParam:d=>d.nextPage||void 0,initialPageParam:0}),{data:v}=O({queryKey:["saved-car-ids"],queryFn:async()=>{var A;console.log("Fetching saved car IDs for home page");const{data:{session:d}}=await S.auth.getSession();if(!((A=d==null?void 0:d.user)!=null&&A.id))return new Set;const{data:b,error:R}=await S.from("saved_cars").select("car_id").eq("user_id",d.user.id);if(R)return console.error("Error fetching saved cars:",R),new Set;const _=new Set(b.map(V=>V.car_id));return console.log("Saved car IDs for home page:",Array.from(_)),_}}),P=v||new Set,J=(w==null?void 0:w.pages.flatMap(d=>d.data.map(b=>({...b,isSaved:P.has(b.id)}))))||[];u.useEffect(()=>{h&&c&&!p&&g()},[h,c,p,g]);const W=()=>{i(d=>d==="asc"?"desc":"asc")},X=async d=>{try{console.log("Starting handover for booking:",d);const{data:b,error:R}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",d).single();if(R)throw R;if(!b)throw new Error("Booking not found");const _=b.cars.owner_id,A=b.renter_id;await D(d,_,A,"pickup")&&(L.success("Handover process started"),f(`/map?bookingId=${d}&mode=handover&role=renter`),j())}catch(b){console.error("Error starting handover:",b),L.error("Failed to start handover process")}};return t.jsxs("div",{className:"space-y-6",children:[M&&t.jsx("div",{className:"space-y-3",children:y.map(d=>t.jsx(K,{prompt:d,onStartHandover:X},d.id))}),t.jsx("div",{className:"flex justify-end",children:t.jsx(C,{variant:o?"secondary":"outline",onClick:W,className:`flex items-center gap-2 transition-colors ${o?"bg-accent text-accent-foreground":""}`,children:o==="asc"?t.jsxs(t.Fragment,{children:["Price: Low to High",t.jsx(G,{className:"h-4 w-4"})]}):t.jsxs(t.Fragment,{children:["Price: High to Low",t.jsx(Z,{className:"h-4 w-4"})]})})}),t.jsx("div",{className:"text-left flex items-center ",children:t.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),t.jsx(U,{cars:J,isLoading:k,error:m,loadMoreRef:x,isFetchingNextPage:p,isAuthenticated:!0}),c&&t.jsx("div",{ref:N,className:"h-10 w-full opacity-0",children:"Load more trigger"})]})},lr=()=>{const[e,r]=u.useState(""),[a,s]=u.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),n=$(),{isAuthenticated:o,userRole:i,isLoadingRole:l}=re(),h=u.useCallback(x=>{s(x)},[]);return u.useEffect(()=>{},[n.search]),t.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[t.jsx(Q,{searchQuery:e,onSearchChange:r,onFiltersChange:s}),t.jsx("main",{className:"container mx-auto px-4 py-8",children:l?t.jsx(ae,{}):o?i==="host"?t.jsx(me,{searchQuery:e}):t.jsx(ye,{searchQuery:e,filters:a,onFiltersChange:h}):t.jsx(ue,{})}),t.jsx(ee,{})]})};export{lr as default};
