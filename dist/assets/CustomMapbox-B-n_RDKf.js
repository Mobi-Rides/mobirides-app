import{c as M,j as o,B as y,r as c,$ as J,a6 as l,J as k}from"./index-B1v-fdDy.js";import{A as F}from"./arrow-left-C5bMyyle.js";import{S as V}from"./send-BDkAZ2Oi.js";import{A as W}from"./arrow-right-wlC4lylp.js";import{O as Z}from"./OnlineStatusToggle-jbesaRgw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=M("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=M("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);function X({onUp:f,onDown:g,onLeft:m,onRight:p,onReset:h}){return o.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[o.jsx("div",{className:"flex gap-1",children:o.jsx(y,{variant:"default",onClick:f,style:{height:40},children:o.jsx(Q,{name:"arrow-up",size:24,color:"white"})})}),o.jsxs("div",{className:"flex gap-1",children:[o.jsx(y,{variant:"default",onClick:m,style:{width:20},children:o.jsx(F,{name:"arrow-left",size:24,color:"white"})}),o.jsx(y,{variant:"default",onClick:h,children:o.jsx(V,{name:"arrow-left",size:24,color:"white"})}),o.jsx(y,{variant:"default",onClick:p,style:{width:20},children:o.jsx(W,{name:"arrow-right",size:24,color:"white"})})]}),o.jsx("div",{className:"flex gap-1",children:o.jsx(y,{variant:"default",onClick:g,style:{height:40},children:o.jsx(K,{name:"arrow-down",size:24,color:"white"})})})]})}const ne=({mapbox_token:f,longitude:g,latitude:m,onlineHosts:p,mapStyle:h="mapbox://styles/mapbox/streets-v12",isHandoverMode:u=!1,bookingId:Y,zoom:j,interactive:L,dpad:T,locationToggle:$,destination:x,returnLocation:E})=>{const b=c.useRef(null),t=c.useRef(null),w=c.useRef(null),[i,S]=c.useState(!1),[d,P]=c.useState({latitude:m,longitude:g}),[A,C]=c.useState([]),[B,N]=c.useState([]),z=J(),a=u?z:null;c.useEffect(()=>{if(!E)return;const n=d.longitude,r=d.latitude;E(n,r)},[d]),c.useEffect(()=>{if(f&&(l.accessToken=f),!t.current&&b.current&&f){t.current=new l.Map({container:b.current,style:h,center:[g,m],zoom:j||14,interactive:L||!0}),t.current.addControl(new l.NavigationControl,"top-right");const n=new l.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});t.current.addControl(n,"top-right"),w.current=n,n.on("error",r=>{console.error("Geolocation error:",r),k.error("Unable to access your location. Please check your browser permissions."),u&&a&&k.error("Location sharing is required for the handover process. Please enable location access.")}),t.current.on("load",()=>{console.log("Map loaded successfully"),S(!0),w.current&&w.current.on("geolocate",r=>{const e={longitude:r.coords.longitude,latitude:r.coords.latitude};P(e),u&&a&&D(e.latitude,e.longitude).then(s=>{a.updateLocation({latitude:e.latitude,longitude:e.longitude,address:s||"Unknown location"})})}),setTimeout(()=>{w.current&&w.current.trigger()},1e3)}),t.current.on("error",r=>{console.error("Map error:",r),k.error("Error loading map. Please refresh.")})}return()=>{if(t.current)try{t.current.remove()}catch(n){console.warn("Error removing map:",n)}finally{t.current=null,S(!1)}}},[f,g,m,h,u,a]);const D=async(n,r)=>{try{const s=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${r},${n}.json?access_token=${f}`)).json();return s.features&&s.features.length>0?s.features[0].place_name:null}catch(e){return console.error("Error fetching address:",e),null}};c.useEffect(()=>{t.current&&i&&t.current.setStyle(h)},[h,i]),c.useEffect(()=>{if(!t.current||!i||!(p!=null&&p.length)||u)return;A.forEach(r=>r.remove()),C([]);const n=p.map(r=>{if(!r.latitude||!r.longitude)return null;const e=document.createElement("div");return e.className="host-marker",e.style.width="20px",e.style.height="20px",e.style.borderRadius="50%",e.style.backgroundColor="#4ade80",e.style.border="2px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",new l.Marker(e).setLngLat([r.longitude,r.latitude]).setPopup(new l.Popup({offset:25}).setHTML(`<p class="font-medium">${r.full_name||"Host"}</p>`)).addTo(t.current)}).filter(Boolean);C(n)},[p,i,u]),c.useEffect(()=>{if(!t.current||!i||!x)return;const{latitude:n,longitude:r}=x,e=document.createElement("div");e.className="destination-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#f59e0b",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const s=new l.Marker(e).setLngLat([r,n]).setPopup(new l.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(t.current);return()=>{s.remove()}}),c.useEffect(()=>{if(!t.current||!i||!x)return;const{latitude:n,longitude:r}=x;return(async()=>{try{const v=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${d.longitude},${d.latitude};${r},${n}?geometries=geojson&access_token=${l.accessToken}`)).json();if(v.routes&&v.routes.length>0&&t.current){const R=v.routes[0].geometry;try{t.current.getSource("route")?t.current.getSource("route").setData(R):(t.current.addSource("route",{type:"geojson",data:R}),t.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}catch(G){console.warn("Error adding route to map:",G)}}}catch(s){console.error("Error fetching route:",s)}})(),()=>{if(t.current&&i)try{t.current.getLayer("route")&&t.current.removeLayer("route"),t.current.getSource("route")&&t.current.removeSource("route")}catch(s){console.warn("Error cleaning up route layer:",s)}}},[i,x,d]),c.useEffect(()=>{if(!t.current||!i||!u||!(a!=null&&a.handoverStatus))return;B.forEach(r=>r.remove()),N([]);const n=[];if(a.handoverStatus.host_location){const r=a.handoverStatus.host_location,e=document.createElement("div");e.className="host-handover-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#3b82f6",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const s=new l.Marker(e).setLngLat([r.longitude,r.latitude]).setPopup(new l.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${r.address}</p>`)).addTo(t.current);n.push(s)}if(a.handoverStatus.renter_location){const r=a.handoverStatus.renter_location,e=document.createElement("div");e.className="renter-handover-marker",e.style.width="24px",e.style.height="24px",e.style.borderRadius="50%",e.style.backgroundColor="#ec4899",e.style.border="3px solid white",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const s=new l.Marker(e).setLngLat([r.longitude,r.latitude]).setPopup(new l.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${r.address}</p>`)).addTo(t.current);n.push(s)}if(n.length===2&&t.current){const r=new l.LngLatBounds;n.forEach(e=>{r.extend(e.getLngLat())}),t.current.fitBounds(r,{padding:100,maxZoom:15})}N(n)},[a==null?void 0:a.handoverStatus,i,u]);const U=()=>{t.current&&t.current.panBy([0,-100],{duration:500})},_=()=>{t.current&&t.current.panBy([0,100],{duration:500})},I=()=>{t.current&&t.current.panBy([-100,0],{duration:500})},q=()=>{t.current&&t.current.panBy([100,0],{duration:500})},O=()=>{t.current&&t.current.flyTo({center:[d.longitude,d.latitude],zoom:20,essential:!0})};return o.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[o.jsx("div",{ref:b,className:"w-full h-full"}),!u&&o.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:o.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:$&&o.jsx(Z,{lat:d.latitude,long:d.longitude})})}),u&&(a==null?void 0:a.handoverStatus)&&o.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:o.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 
                        border border-gray-200 dark:border-gray-700`,children:o.jsxs("div",{className:"text-center",children:[o.jsxs("p",{className:"text-sm font-medium",children:[a.isHost?"Host":"Renter"," Mode"]}),o.jsx("p",{className:"text-xs text-muted-foreground",children:a.handoverStatus.host_location&&a.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),T&&o.jsx(X,{onUp:U,onDown:_,onLeft:I,onRight:q,onReset:O})]})};export{ne as C};
