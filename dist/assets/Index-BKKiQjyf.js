import{i as z,h as me,a as xe,c as L,r as d,j as e,O as ee,b as V,C as te,d as ge,X as pe,T as ae,D as se,P as fe,e as ye,R as ve,f as be,J as U,L as E,I,B as C,S as H,g as G,k as K,l as W,m as _,u as T,n as $,o as je,s as P,A as re}from"./index-BAM2AQzj.js";import{C as we}from"./calendar-D1EmOoAD.js";import{P as Ne,a as ke,b as Se}from"./popover-CRuTd8jV.js";import{S as Pe}from"./scroll-area-C8WYL-tw.js";import{C as Ce}from"./calendar-m5gla_Sa.js";import{M as Ae}from"./map-pin-CoQHT-KY.js";import{A as Me}from"./arrow-up-down-BLFjvb34.js";import{f as Z}from"./format-BOBWS5Wu.js";import{A as Q,a as Fe,b as J}from"./avatar-A32ilikL.js";import{B as oe}from"./badge-La64XLSg.js";import{Q as Re,u as Le,a as D}from"./useQuery-BBHzqejZ.js";import{u as Ee}from"./useVerificationStatus-B0uRCjL0.js";import{C as X}from"./clock-DcRTzakL.js";import{C as Ie}from"./circle-check-big-CU0Wzt6B.js";import{C as Oe}from"./circle-alert-CkQrh4MB.js";import{S as De}from"./shield-CL09y3a_.js";import{P as Ve}from"./plus-bFfdWSCz.js";import{S as _e,N as qe}from"./Navigation-DcFnTla_.js";import{u as Be}from"./useAuthStatus-DIZuW2dv.js";import{C as ne,L as Te}from"./CarGrid-CBVDP3JY.js";import"./addDays-Di48Ycau.js";import"./chevron-right-DpKt2Wag.js";import"./card-C82ETfr4.js";import"./savedCarService-tYJGOOrr.js";import"./alert-7WYzCt2j.js";import"./VerificationRequiredDialog-s2VCs-lA.js";import"./file-text-CCBm04K0.js";import"./camera-DYAoZQND.js";import"./arrow-right-CC1csBZ0.js";import"./CustomMapbox-DZ6yZBZD.js";import"./OnlineStatusToggle-D0TJLYj4.js";import"./arrow-left-ZSxCSMqd.js";import"./send-CyKCJr7A.js";import"./handoverService-DSRl_wMq.js";import"./skeleton-nH5YszIf.js";import"./separator-BlDr0iOF.js";import"./users-Bgk7JC4M.js";var $e=class extends Re{constructor(a,t){super(a,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(a,t){super.setOptions({...a,behavior:z()},t)}getOptimisticResult(a){return a.behavior=z(),super.getOptimisticResult(a)}fetchNextPage(a){return this.fetch({...a,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(a){return this.fetch({...a,meta:{fetchMore:{direction:"backward"}}})}createResult(a,t){var f,v;const{state:o}=a,r=super.createResult(a,t),{isFetching:n,isRefetching:s,isError:l,isRefetchError:i}=r,h=(v=(f=o.fetchMeta)==null?void 0:f.fetchMore)==null?void 0:v.direction,c=l&&h==="forward",x=n&&h==="forward",g=l&&h==="backward",p=n&&h==="backward";return{...r,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:me(t,o.data),hasPreviousPage:xe(t,o.data),isFetchNextPageError:c,isFetchingNextPage:x,isFetchPreviousPageError:g,isFetchingPreviousPage:p,isRefetchError:i&&!c&&!g,isRefetching:s&&!x&&!p}}};function ze(a,t){return Le(a,$e)}/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=L("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=L("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=L("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=L("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=L("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),Ke=ve,We=be,Ze=fe,le=d.forwardRef(({className:a,...t},o)=>e.jsx(ee,{className:V("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...t,ref:o}));le.displayName=ee.displayName;const Qe=ye("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),de=d.forwardRef(({side:a="right",className:t,children:o,...r},n)=>e.jsxs(Ze,{children:[e.jsx(le,{}),e.jsxs(te,{ref:n,className:V(Qe({side:a}),t),...r,children:[o,e.jsxs(ge,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));de.displayName=te.displayName;const Je=d.forwardRef(({className:a,...t},o)=>e.jsx(ae,{ref:o,className:V("text-lg font-semibold text-foreground",a),...t}));Je.displayName=ae.displayName;const Xe=d.forwardRef(({className:a,...t},o)=>e.jsx(se,{ref:o,className:V("text-sm text-muted-foreground",a),...t}));Xe.displayName=se.displayName;const Ye=({onFiltersChange:a})=>{const[t,o]=d.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"distance",sortOrder:"asc",model:void 0,year:void 0,minPrice:void 0,maxPrice:void 0,searchQuery:""}),r=(s,l)=>{console.log(`Updating filter ${s} with value:`,l),o(i=>({...i,[s]:l}))},n=d.useCallback(()=>{if(console.log("Applying filters:",t),t.minPrice&&t.maxPrice&&t.minPrice>t.maxPrice){U.error("Minimum price cannot be greater than maximum price");return}a(t),U.success("Filters applied successfully")},[t,a]);return e.jsxs("div",{className:"w-full rounded-lg border bg-card shadow-sm my-5 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 h-6 bg-gradient-to-b from-background to-transparent z-10"}),e.jsx(Pe,{className:"h-[calc(100vh-200px)]",children:e.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"model",children:"Model"}),e.jsx(I,{id:"model",placeholder:"Search by model...",value:t.model||"",onChange:s=>r("model",s.target.value)})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"year",children:"Year"}),e.jsx(I,{id:"year",type:"number",placeholder:"Search by year...",value:t.year||"",onChange:s=>r("year",s.target.value?parseInt(s.target.value):void 0)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"minPrice",children:"Min Price (BWP)"}),e.jsx(I,{id:"minPrice",type:"number",placeholder:"Min price...",value:t.minPrice||"",onChange:s=>r("minPrice",s.target.value?parseInt(s.target.value):void 0)})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"maxPrice",children:"Max Price (BWP)"}),e.jsx(I,{id:"maxPrice",type:"number",placeholder:"Max price...",value:t.maxPrice||"",onChange:s=>r("maxPrice",s.target.value?parseInt(s.target.value):void 0)})]})]})]}),e.jsxs(Ne,{children:[e.jsx(ke,{asChild:!0,children:e.jsxs(C,{variant:"outline",className:"w-full",children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),t.startDate&&t.endDate?`${Z(t.startDate,"PP")} - ${Z(t.endDate,"PP")}`:"Select dates"]})}),e.jsx(Se,{className:"w-auto p-0",align:"start",children:e.jsx(we,{mode:"range",selected:{from:t.startDate,to:t.endDate},onSelect:s=>{r("startDate",s==null?void 0:s.from),r("endDate",s==null?void 0:s.to)},numberOfMonths:2})})]}),e.jsxs(H,{value:t.vehicleType,onValueChange:s=>r("vehicleType",s),children:[e.jsx(G,{children:e.jsx(K,{placeholder:"Vehicle type"})}),e.jsx(W,{children:["Basic","Standard","Executive","4x4","SUV","Electric","Exotic"].map(s=>e.jsx(_,{value:s,children:s},s))})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Enter pickup location",className:"w-full pl-10 pr-4 py-2 border rounded-md",value:t.location,onChange:s=>r("location",s.target.value)})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(H,{value:t.sortBy,onValueChange:s=>r("sortBy",s),children:[e.jsx(G,{className:"flex-1",children:e.jsx(K,{placeholder:"Sort by"})}),e.jsxs(W,{children:[e.jsx(_,{value:"distance",children:"Distance"}),e.jsx(_,{value:"price",children:"Price"})]})]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>r("sortOrder",t.sortOrder==="asc"?"desc":"asc"),children:e.jsx(Me,{className:`h-4 w-4 ${t.sortOrder==="desc"?"rotate-180":""}`})})]}),e.jsx(C,{className:"w-full mt-2",onClick:n,children:"Apply Filters"})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-b from-transparent to-background z-10"})]})},et=({showText:a=!0,variant:t="badge",size:o="md"})=>{const{isVerified:r,isLoading:n,verificationData:s}=Ee(),l=T(),i=()=>{l("/verification")},c=n?{icon:e.jsx(X,{className:"h-3 w-3"}),text:"Checking...",variant:"outline",clickable:!1}:r?{icon:e.jsx(Ie,{className:"h-3 w-3"}),text:"Verified",variant:"secondary",className:"bg-green-100 text-green-700 border-green-200",clickable:!1}:s&&s.overallStatus==="pending_review"?{icon:e.jsx(X,{className:"h-3 w-3"}),text:"Under Review",variant:"secondary",className:"bg-blue-100 text-blue-700 border-blue-200",clickable:!0}:s&&s.currentStep?{icon:e.jsx(Oe,{className:"h-3 w-3"}),text:"In Progress",variant:"secondary",className:"bg-orange-100 text-orange-700 border-orange-200",clickable:!0}:{icon:e.jsx(De,{className:"h-3 w-3"}),text:"Not Verified",variant:"outline",className:"border-orange-300 text-orange-600 hover:bg-orange-50",clickable:!0};return t==="button"&&c.clickable?e.jsxs(C,{variant:"outline",size:o==="md"?"default":o,onClick:i,className:`flex items-center space-x-2 ${c.className||""}`,children:[c.icon,a&&e.jsx("span",{children:c.text})]}):e.jsxs(oe,{variant:c.variant,className:`flex items-center space-x-1 cursor-pointer ${c.className||""}`,onClick:c.clickable?i:void 0,children:[c.icon,a&&e.jsx("span",{children:c.text})]})},tt=({searchQuery:a,onSearchChange:t,onFiltersChange:o})=>{const r=T(),n=$(),{user:s}=je(),[l,i]=d.useState(!1),[h,c]=d.useState("signin"),[x,g]=d.useState({city:"Gaborone",country:"Botswana",loading:!0,error:null});d.useEffect(()=>{const y=async()=>{try{const b=await navigator.permissions.query({name:"geolocation"});b.state==="granted"?await u():b.state==="denied"?await A():await A()}catch{try{await u()}catch{await A()}}},u=async()=>{var b,k;try{const S=await new Promise((ue,he)=>{navigator.geolocation.getCurrentPosition(ue,he,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),F=await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${S.coords.latitude}+${S.coords.longitude}&key=4382106d8cc34d2e9c95f4dc83f23736`);if(!F.ok)throw new Error("Failed to fetch location data");const R=(k=(b=(await F.json()).results)==null?void 0:b[0])==null?void 0:k.components;R&&g({city:R.city||R.town||R.state||R.county||"Unknown",country:R.country||"Unknown",loading:!1,error:null})}catch(S){console.error("Location error:",S),g(F=>({...F,loading:!1,error:S instanceof Error?S.message:"Failed to get location"}))}},A=async()=>{try{const b=await fetch("https://ipapi.co/json/");if(!b.ok)throw new Error("Failed to fetch location data");const k=await b.json();g({city:k.city||"Gaborone",country:k.country_name||"Botswana",loading:!1,error:null})}catch(b){console.error("IP Location error:",b),g(k=>({...k,loading:!1,error:null,city:"Gaborone",country:"Botswana"}))}};y()},[]);const{data:p}=D({queryKey:["profile"],queryFn:async()=>{if(!s)return null;const{data:y}=await P.from("profiles").select("avatar_url, full_name").eq("id",s.id).single();return y},enabled:!!s}),{data:m}=D({queryKey:["notification-count"],queryFn:async()=>{if(!s)return{messages:0,notifications:0};const[y,u]=await Promise.all([P.from("messages").select("id",{count:"exact"}).eq("receiver_id",s.id).eq("status","sent"),P.from("notifications").select("id",{count:"exact"}).eq("user_id",s.id).eq("is_read",!1)]);return{messages:y.count||0,notifications:u.count||0}},refetchInterval:3e4,enabled:!!s}),f=((m==null?void 0:m.messages)||0)+((m==null?void 0:m.notifications)||0),v=p!=null&&p.avatar_url?P.storage.from("avatars").getPublicUrl(p.avatar_url).data.publicUrl:null,j=y=>{console.log("Filters changed:",y),o({...y,searchQuery:a})},M=()=>{s?r("/profile"):(c("signin"),i(!0),r(`${n.pathname}?auth=signin`,{replace:!0}))},w=()=>{i(!1),r(n.pathname,{replace:!0})};d.useEffect(()=>{const u=new URLSearchParams(n.search).get("auth");(u==="signin"||u==="signup")&&(c(u),i(!0))},[n.search]);const N=x.loading?"Loading location...":x.error?"Gaborone, Botswana":`${x.city}, ${x.country}`;return e.jsxs("header",{className:"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-900 sticky top-0 z-10 shadow-sm p-6 md:p-8 rounded-b-3xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 mb-4",children:[e.jsx("img",{src:"/lovable-uploads/9bb8c367-3153-4561-870a-faadfe15b30c.png",alt:"Mobirides Logo",className:"h-14 w-14 cursor-pointer",onClick:()=>r("/")}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-center",children:[e.jsx(He,{className:"text-white h-4 w-4 flex-shrink-0"}),e.jsx("h3",{className:"text-xs md:text-sm lg:text-base font-normal text-gray-500 dark:text-white truncate",children:N})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl  md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2",onClick:()=>r("/add-car"),children:[e.jsx(Ve,{className:"h-4 w-4 text-[#581CFA] dark:text-white"}),e.jsx("span",{className:"hidden md:inline-block",children:e.jsx("p",{className:"text-[#581CFA] dark:text-white text-xs md:text-sm lg:text-base font-semibold",children:"Add A Car"})})]}),s&&e.jsx("div",{className:"hidden sm:block",children:e.jsx(et,{variant:"button",size:"sm"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"rounded-full bg-gray-100 flex items-center justify-center",onClick:M,children:v&&s?e.jsxs(Q,{className:"h-10 w-10",children:[e.jsx(Fe,{src:v,alt:"Profile"}),e.jsx(J,{children:"👤"})]}):e.jsx(Q,{className:"h-10 w-10",children:e.jsx(J,{children:"👤"})})}),f>0&&s&&e.jsx(oe,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:f})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-8",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(_e,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-[#581CFA] h-4 w-4 md:h-5 md:w-5  lg:h-6 lg:w-6"}),e.jsx("input",{type:"text",placeholder:"Search cars...",value:a,onChange:y=>t(y.target.value),className:"w-full h-12 md:h-14 pl-10 pr-4 py-2 rounded-2xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:border-primary dark:focus:border-primary text-xs md:text-sm lg:text-base placeholder:text-xs md:placeholder:text-sm lg:placeholder:text-base dark:placeholder:text-gray-400"})]}),e.jsxs(Ke,{children:[e.jsx(We,{asChild:!0,children:e.jsx(C,{variant:"outline",size:"icon",className:"rounded-2xl w-12 md:w-14 h-12 md:h-14 flex items-center justify-center",children:e.jsx(Ge,{className:"h-4 w-4"})})}),e.jsx(de,{children:e.jsx(Ye,{onFiltersChange:j})})]})]}),e.jsx(re,{isOpen:l,onClose:w,defaultTab:h})]})},at=()=>{const[a,t]=d.useState(!1),[o,r]=d.useState("signin"),n=$(),s=T();d.useEffect(()=>{const c=new URLSearchParams(n.search).get("auth");(c==="signin"||c==="signup")&&(r(c),t(!0))},[n.search]);const l=()=>{r("signin"),t(!0),s("/?auth=signin",{replace:!0})},i=()=>{t(!1),s("/",{replace:!0})};return e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[e.jsxs("div",{className:"p-8 rounded-lg",children:[e.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),e.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:l,children:[e.jsx(Ue,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"hidden md:inline-block",children:e.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),e.jsx(re,{isOpen:a,onClose:i,defaultTab:o})]})},st=({searchQuery:a})=>{const[t,o]=d.useState(null),[r,n]=d.useState("asc"),s=d.useRef(null),{data:l,isLoading:i,error:h}=D({queryKey:["host-cars",a,r,t],queryFn:async()=>{var j;console.log("Fetching host cars with search:",a,"brand:",t);const{data:{session:p}}=await P.auth.getSession();if(!((j=p==null?void 0:p.user)!=null&&j.id))return[];let m=P.from("cars").select("*").eq("owner_id",p.user.id);a&&(m=m.or(`brand.ilike.%${a}%,model.ilike.%${a}%`)),t&&(m=m.eq("brand",t)),m=m.order("price_per_day",{ascending:r==="asc"});const{data:f,error:v}=await m;if(v)throw v;return console.log("Host cars fetched:",f),f}}),c=l||[],x=()=>{n(p=>p==="asc"?"desc":"asc")},g=()=>{console.log("Load more triggered in HostView")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(C,{variant:r?"secondary":"outline",onClick:x,className:`flex items-center gap-2 transition-colors ${r?"bg-accent text-accent-foreground":""}`,children:r==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(ce,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ie,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),e.jsx(ne,{cars:c,isLoading:i,error:h,loadMoreRef:s,onLoadMore:g,isFetchingNextPage:!1,isAuthenticated:!0})]})};var B=new Map,O=new WeakMap,Y=0,rt=void 0;function ot(a){return a?(O.has(a)||(Y+=1,O.set(a,Y.toString())),O.get(a)):"0"}function nt(a){return Object.keys(a).sort().filter(t=>a[t]!==void 0).map(t=>`${t}_${t==="root"?ot(a.root):a[t]}`).toString()}function it(a){const t=nt(a);let o=B.get(t);if(!o){const r=new Map;let n;const s=new IntersectionObserver(l=>{l.forEach(i=>{var h;const c=i.isIntersecting&&n.some(x=>i.intersectionRatio>=x);a.trackVisibility&&typeof i.isVisible>"u"&&(i.isVisible=c),(h=r.get(i.target))==null||h.forEach(x=>{x(c,i)})})},a);n=s.thresholds||(Array.isArray(a.threshold)?a.threshold:[a.threshold||0]),o={id:t,observer:s,elements:r},B.set(t,o)}return o}function ct(a,t,o={},r=rt){if(typeof window.IntersectionObserver>"u"&&r!==void 0){const h=a.getBoundingClientRect();return t(r,{isIntersecting:r,target:a,intersectionRatio:typeof o.threshold=="number"?o.threshold:0,time:0,boundingClientRect:h,intersectionRect:h,rootBounds:h}),()=>{}}const{id:n,observer:s,elements:l}=it(o),i=l.get(a)||[];return l.has(a)||l.set(a,i),i.push(t),s.observe(a),function(){i.splice(i.indexOf(t),1),i.length===0&&(l.delete(a),s.unobserve(a)),l.size===0&&(s.disconnect(),B.delete(n))}}function lt({threshold:a,delay:t,trackVisibility:o,rootMargin:r,root:n,triggerOnce:s,skip:l,initialInView:i,fallbackInView:h,onChange:c}={}){var x;const[g,p]=d.useState(null),m=d.useRef(c),[f,v]=d.useState({inView:!!i,entry:void 0});m.current=c,d.useEffect(()=>{if(l||!g)return;let N;return N=ct(g,(y,u)=>{v({inView:y,entry:u}),m.current&&m.current(y,u),u.isIntersecting&&s&&N&&(N(),N=void 0)},{root:n,rootMargin:r,threshold:a,trackVisibility:o,delay:t},h),()=>{N&&N()}},[Array.isArray(a)?a.toString():a,g,n,r,s,l,o,h,t]);const j=(x=f.entry)==null?void 0:x.target,M=d.useRef(void 0);!g&&j&&!s&&!l&&M.current!==j&&(M.current=j,v({inView:!!i,entry:void 0}));const w=[p,f.inView,f.entry];return w.ref=w[0],w.inView=w[1],w.entry=w[2],w}const q=10,dt=async({pageParam:a=0,filters:t,searchParams:o})=>{console.log("Starting car fetch with params:",{pageParam:a,filters:t,searchParams:o});let r=P.from("cars").select("*",{count:"exact"});r=r.range(a*q,(a+1)*q-1),o!=null&&o.searchTerm&&(console.log("Applying search term:",o.searchTerm),r=r.or(`brand.ilike.%${o.searchTerm}%,model.ilike.%${o.searchTerm}%`)),o!=null&&o.brand&&(console.log("Filtering by brand:",o.brand),r=r.eq("brand",o.brand)),t!=null&&t.model&&(r=r.ilike("model",`%${t.model}%`)),t!=null&&t.year&&(r=r.eq("year",t.year)),t!=null&&t.minPrice&&(r=r.gte("price_per_day",t.minPrice)),t!=null&&t.maxPrice&&(r=r.lte("price_per_day",t.maxPrice)),t!=null&&t.vehicleType&&(r=r.eq("vehicle_type",t.vehicleType)),t!=null&&t.location&&(r=r.ilike("location",`%${t.location}%`)),(t==null?void 0:t.sortBy)==="price"&&(r=r.order("price_per_day",{ascending:t.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:n,error:s,count:l}=await r;if(s)throw console.error("Error fetching cars:",s),s;return console.log("Cars fetched successfully:",{count:l,dataLength:n==null?void 0:n.length}),{data:n||[],nextPage:n&&n.length===q?a+1:void 0,count:l}},ut=({searchQuery:a,filters:t,onFiltersChange:o})=>{const[r,n]=d.useState(null),[s,l]=d.useState("asc"),{ref:i,inView:h}=lt(),c=d.useRef(null),x=u=>{c.current!==u&&(c.current=u||null),i(u)};d.useEffect(()=>{o({...t,sortOrder:s})},[s,o]);const{data:g,isLoading:p,error:m,hasNextPage:f,fetchNextPage:v,isFetchingNextPage:j}=ze({queryKey:["available-cars",r,t,a],queryFn:({pageParam:u=0})=>dt({pageParam:u,filters:t,searchParams:{...r?{brand:r}:{},...a?{searchTerm:a}:{}}}),getNextPageParam:u=>u.nextPage||void 0,initialPageParam:0}),{data:M}=D({queryKey:["saved-car-ids"],queryFn:async()=>{var S;console.log("Fetching saved car IDs for home page");const{data:{session:u}}=await P.auth.getSession();if(!((S=u==null?void 0:u.user)!=null&&S.id))return new Set;const{data:A,error:b}=await P.from("saved_cars").select("car_id").eq("user_id",u.user.id);if(b)return console.error("Error fetching saved cars:",b),new Set;const k=new Set(A.map(F=>F.car_id));return console.log("Saved car IDs for home page:",Array.from(k)),k}}),w=M||new Set,N=(g==null?void 0:g.pages.flatMap(u=>u.data.map(A=>({...A,isSaved:w.has(A.id)}))))||[];d.useEffect(()=>{h&&f&&!j&&v()},[h,f,j,v]);const y=()=>{l(u=>u==="asc"?"desc":"asc")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(C,{variant:s?"secondary":"outline",onClick:y,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(ce,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ie,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),e.jsx(ne,{cars:N,isLoading:p,error:m,loadMoreRef:c,isFetchingNextPage:j,isAuthenticated:!0}),f&&e.jsx("div",{ref:x,className:"h-10 w-full opacity-0",children:"Load more trigger"})]})},Qt=()=>{const[a,t]=d.useState(""),[o,r]=d.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),n=$(),{isAuthenticated:s,userRole:l,isLoadingRole:i}=Be(),h=d.useCallback(c=>{r(c)},[]);return d.useEffect(()=>{},[n.search]),e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx(tt,{searchQuery:a,onSearchChange:t,onFiltersChange:r}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:i?e.jsx(Te,{}):s?l==="host"?e.jsx(st,{searchQuery:a}):e.jsx(ut,{searchQuery:a,filters:o,onFiltersChange:h}):e.jsx(at,{})}),e.jsx(qe,{})]})};export{Qt as default};
