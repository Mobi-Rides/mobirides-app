import{c as Y,s as y,J as v,az as Le,D as K,b as Z,d as Q,e as ee,m as ue,t as $e,B as S,F as Ee,_ as z,E as Me,$ as De,ao as _e,l as Te,g as oe,aA as ne,h as ie}from"./index-ahmQo-Zq.js";import{j as e}from"./query-vendor-BOSMW7hd.js";import{r,u as me}from"./react-vendor-DmU5vXC9.js";import{C as Ae}from"./calendar-D_cFmEe6.js";import{s as Re,a as w}from"./date-vendor-Dhms5dOu.js";import{C as fe,g as Ie,c as le,i as Oe}from"./availabilityService-D7WpCdEl.js";import{u as qe}from"./useVerificationStatus-5lh3U-on.js";import{V as Ue}from"./VerificationRequiredDialog-DSKmhISw.js";/* empty css                  */import{S as Fe}from"./skeleton-DFMY7FuM.js";import{L as ze}from"./LocationSearchInput-CT6ABk2G.js";import{m as F}from"./mapbox-vendor-ueN8uhVJ.js";import{C as he}from"./clock-gtBamCUv.js";import{C as He}from"./calendar-CpXOYIBo.js";import{C as Ve}from"./circle-alert-C0uJq2nf.js";import{M as Je}from"./map-pin-BTmNqwoj.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Y("CalendarX",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"m14 14-4 4",key:"rymu2i"}],["path",{d:"m10 14 4 4",key:"3sz06r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vt=Y("CircleGauge",[["path",{d:"M15.6 2.7a10 10 0 1 0 5.7 5.7",key:"1e0p6d"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M13.4 10.6 19 5",key:"1kr7tw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=Y("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=Y("Locate",[["line",{x1:"2",x2:"5",y1:"12",y2:"12",key:"bvdh0s"}],["line",{x1:"19",x2:"22",y1:"12",y2:"12",key:"1tbv5k"}],["line",{x1:"12",x2:"12",y1:"2",y2:"5",key:"11lu5j"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}],["circle",{cx:"12",cy:"12",r:"7",key:"fim9np"}]]),ce=async()=>{console.log("Checking for expired booking requests...");try{const t=Re(new Date),{data:s,error:a}=await y.from("bookings").select("*").eq("status","pending").lt("start_date",t.toISOString());if(a)throw a;if(s&&s.length>0){const{error:o}=await y.from("bookings").update({status:"expired"}).in("id",s.map(i=>i.id));if(o)throw o;console.log(`Updated ${s.length} expired booking requests`)}}catch(t){console.error("Error in handleExpiredBookings:",t instanceof Error?t.message:JSON.stringify(t,null,2))}};var de=["light","dark"],We="(prefers-color-scheme: dark)",Xe=r.createContext(void 0),Ke={setTheme:t=>{},themes:[]},Ze=()=>{var t;return(t=r.useContext(Xe))!=null?t:Ke};r.memo(({forcedTheme:t,storageKey:s,attribute:a,enableSystem:o,enableColorScheme:i,defaultTheme:n,value:h,attrs:b,nonce:u})=>{let f=n==="system",N=a==="class"?`var d=document.documentElement,c=d.classList;${`c.remove(${b.map(p=>`'${p}'`).join(",")})`};`:`var d=document.documentElement,n='${a}',s='setAttribute';`,k=i?de.includes(n)&&n?`if(e==='light'||e==='dark'||!e)d.style.colorScheme=e||'${n}'`:"if(e==='light'||e==='dark')d.style.colorScheme=e":"",l=(p,T=!1,I=!0)=>{let C=h?h[p]:p,L=T?p+"|| ''":`'${C}'`,j="";return i&&I&&!T&&de.includes(p)&&(j+=`d.style.colorScheme = '${p}';`),a==="class"?T||C?j+=`c.add(${L})`:j+="null":C&&(j+=`d[s](n,${L})`),j},c=t?`!function(){${N}${l(t)}}()`:o?`!function(){try{${N}var e=localStorage.getItem('${s}');if('system'===e||(!e&&${f})){var t='${We}',m=window.matchMedia(t);if(m.media!==t||m.matches){${l("dark")}}else{${l("light")}}}else if(e){${h?`var x=${JSON.stringify(h)};`:""}${l(h?"x[e]":"e",!0)}}${f?"":"else{"+l(n,!1,!1)+"}"}${k}}catch(e){}}()`:`!function(){try{${N}var e=localStorage.getItem('${s}');if(e){${h?`var x=${JSON.stringify(h)};`:""}${l(h?"x[e]":"e",!0)}}else{${l(n,!1,!1)};}${k}}catch(t){}}();`;return r.createElement("script",{nonce:u,dangerouslySetInnerHTML:{__html:c}})});const Qe=({mapboxToken:t,selectedLocation:s,onMapClick:a,onMapRef:o,onGeolocateRef:i,onUserLocationUpdate:n,mapStyle:h="mapbox://styles/mapbox/streets-v12"})=>{const b=r.useRef(null),u=r.useRef(null),f=r.useRef(null),[N,k]=r.useState(!1);return r.useEffect(()=>{if(!t||!b.current||u.current)return;F.accessToken=t,u.current=new F.Map({container:b.current,style:h,center:[25.9087,-24.6541],zoom:14,interactive:!0}),u.current.addControl(new F.NavigationControl,"top-right");const l=new F.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0,showUserHeading:!0});return u.current.addControl(l,"top-right"),i(l),l.on("geolocate",c=>{console.log("Geolocate event:",c.coords),n({latitude:c.coords.latitude,longitude:c.coords.longitude})}),l.on("error",c=>{console.error("Geolocation error:",c),v.error("Unable to access your location. Please check permissions.")}),u.current.on("load",()=>{console.log("Map loaded successfully"),k(!0),o(u.current)}),u.current.on("error",c=>{console.error("Map error:",c),v.error("Error loading map. Please refresh.")}),u.current.on("click",c=>{console.log("Map clicked at:",c.lngLat),a(c.lngLat.lng,c.lngLat.lat)}),()=>{u.current&&(u.current.remove(),u.current=null,o(null),i(null))}},[t,h]),r.useEffect(()=>{if(!(!u.current||!N)&&(f.current&&(f.current.remove(),f.current=null),s)){const l=document.createElement("div");if(l.className="location-marker",l.style.width="20px",l.style.height="20px",l.style.borderRadius="50%",l.style.backgroundColor="#ef4444",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",l.style.cursor="pointer",l.style.animation="pulse 2s infinite",!document.querySelector("#location-marker-styles")){const c=document.createElement("style");c.id="location-marker-styles",c.textContent=`
          @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
          }
        `,document.head.appendChild(c)}f.current=new F.Marker(l,{draggable:!0}).setLngLat([s.lng,s.lat]).addTo(u.current),f.current.on("dragend",()=>{var p;const c=(p=f.current)==null?void 0:p.getLngLat();c&&(console.log("Marker dragged to:",c),a(c.lng,c.lat))}),u.current.flyTo({center:[s.lng,s.lat],zoom:16,essential:!0})}},[s,N]),e.jsx("div",{className:"relative w-full h-full",children:e.jsx("div",{ref:b,className:"w-full h-full"})})},et=({isOpen:t,onClose:s,onLocationSelected:a})=>{const[o,i]=r.useState(null),[n,h]=r.useState(""),b=r.useRef(null),u=r.useRef(null),[f,N]=r.useState(null),[k,l]=r.useState(!0),[c,p]=r.useState(null),{theme:T}=Ze(),I=r.useCallback((d,m)=>{console.log("Map clicked at:",{lat:m,lng:d}),i({lat:m,lng:d}),L(m,d)},[]),C=r.useCallback(d=>{b.current=d},[]),L=async(d,m)=>{if(f)try{const q=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${m},${d}.json?access_token=${f}`)).json();q.features&&q.features.length>0&&h(q.features[0].place_name)}catch(P){console.error("Error fetching address:",P)}},j=()=>T==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1";r.useEffect(()=>{(async()=>{try{const m=await Ee();if(!m){v.error("Failed to get the map token");return}console.log("Mapbox token retrieved successfully"),N(m),l(!1)}catch(m){console.error("Error getting Mapbox token:",m),v.error("Failed to load map configuration")}})()},[]);const H=()=>{o?(a(o.lat,o.lng),s()):v.error("Please select a location first")},V=()=>{u.current?u.current.trigger():v.error("Geolocation not available")},O=r.useCallback(d=>{console.log("User location updated:",d),p({lat:d.latitude,lng:d.longitude}),i({lat:d.latitude,lng:d.longitude}),L(d.latitude,d.longitude)},[]),W=d=>{const[m,P]=d.coordinates;i({lat:P,lng:m}),h(d.full_address),b.current&&b.current.flyTo({center:[m,P],zoom:16,essential:!0})};return r.useEffect(()=>{t&&(i(null),h(""),p(null))},[t]),e.jsx(Le,{children:e.jsx(K,{open:t,onOpenChange:d=>{d||s()},children:e.jsxs(Z,{className:"sm:max-w-[700px] h-[85vh] max-h-[900px] flex flex-col overflow-hidden p-0",children:[e.jsxs(Q,{className:"p-6 pb-4",children:[e.jsx(ee,{children:"Select Pickup Location"}),e.jsx(ue,{className:"text-sm text-muted-foreground",children:"Search for a location, click on the map, or use your current location."})]}),e.jsx("div",{className:"px-6 pb-4",children:e.jsx(ze,{placeholder:"Search for addresses, landmarks, places...",onLocationSelect:W,className:"w-full"})}),e.jsxs($e,{className:"flex-1 overflow-auto px-6 py-2",children:[e.jsxs("div",{className:"relative w-full rounded-md overflow-hidden border border-border mb-4",style:{height:"400px",minHeight:"300px"},children:[(k||!f)&&e.jsx("div",{className:"absolute inset-0 bg-background/80 backdrop-blur-sm",children:e.jsx(Fe,{className:"w-full h-full"})}),e.jsx(Qe,{mapboxToken:f,selectedLocation:o,onMapClick:I,onMapRef:C,onGeolocateRef:d=>u.current=d,onUserLocationUpdate:O,mapStyle:j()}),o&&e.jsxs("div",{className:"absolute top-2 left-2 bg-background/90 p-2 rounded-md shadow-sm border border-border text-xs max-w-[200px]",children:[e.jsx("p",{className:"font-medium",children:"Selected Location"}),e.jsxs("p",{children:["Lat: ",o.lat.toFixed(6)]}),e.jsxs("p",{children:["Lng: ",o.lng.toFixed(6)]}),n&&e.jsx("p",{className:"mt-1 text-muted-foreground truncate",children:n})]}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsxs(S,{size:"sm",variant:"secondary",className:"h-8 shadow-sm",onClick:V,disabled:!f||k,children:[e.jsx(Ye,{className:"h-4 w-4 mr-1"}),"Use My Location"]})})]}),e.jsx("div",{className:"flex flex-col gap-2 mb-4",children:e.jsx("p",{className:"text-xs text-muted-foreground",children:k?"Loading map...":f?o?`Location selected${n?`: ${n}`:". Click confirm to use this location."}`:"Search for a location above, click on the map, or use your current location.":"Map configuration not available"})})]}),e.jsxs("div",{className:"flex justify-end gap-2 p-4 border-t sticky bottom-0 bg-background",children:[e.jsx(S,{variant:"outline",onClick:s,children:"Cancel"}),e.jsx(S,{onClick:H,disabled:!o,children:"Confirm Location"})]})]})})})},ge=r.forwardRef(({...t},s)=>e.jsx("nav",{ref:s,"aria-label":"breadcrumb",...t}));ge.displayName="Breadcrumb";const xe=r.forwardRef(({className:t,...s},a)=>e.jsx("ol",{ref:a,className:z("flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",t),...s}));xe.displayName="BreadcrumbList";const pe=r.forwardRef(({className:t,...s},a)=>e.jsx("li",{ref:a,className:z("inline-flex items-center gap-1.5",t),...s}));pe.displayName="BreadcrumbItem";const tt=r.forwardRef(({asChild:t,className:s,...a},o)=>{const i=t?De:"a";return e.jsx(i,{ref:o,className:z("transition-colors hover:text-foreground",s),...a})});tt.displayName="BreadcrumbLink";const be=r.forwardRef(({className:t,...s},a)=>e.jsx("span",{ref:a,role:"link","aria-disabled":"true","aria-current":"page",className:z("font-normal text-foreground",t),...s}));be.displayName="BreadcrumbPage";const ye=({children:t,className:s,...a})=>e.jsx("li",{role:"presentation","aria-hidden":"true",className:z("[&>svg]:size-3.5",s),...a,children:t??e.jsx(Me,{})});ye.displayName="BreadcrumbSeparator";const ve=({currentStep:t,bookingId:s})=>{const a=[{key:"selection",label:"Car Selection",completed:!0},{key:"confirmation",label:"Booking Details",completed:t!=="selection"},{key:"success",label:"Confirmation",completed:["success","handover"].includes(t)},{key:"handover",label:"Handover",completed:t==="handover"}],o=i=>i.completed&&t!==i.key?e.jsx(fe,{className:"h-4 w-4 text-green-600"}):t===i.key?e.jsx(he,{className:"h-4 w-4 text-primary"}):e.jsx(_e,{className:"h-4 w-4 text-muted-foreground"});return e.jsxs("div",{className:"p-4 bg-muted/50 border-b",children:[e.jsx(ge,{children:e.jsx(xe,{children:a.map((i,n)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs(pe,{className:"flex items-center gap-2",children:[o(i),t===i.key?e.jsx(be,{className:"font-medium",children:i.label}):e.jsx("span",{className:`text-sm ${i.completed?"text-green-600 font-medium":"text-muted-foreground"}`,children:i.label})]}),n<a.length-1&&e.jsx(ye,{})]},i.key))})}),s&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Booking ID: ",s]})]})},st=({isOpen:t,onClose:s,bookingData:a})=>{const o=me(),[i,n]=r.useState(5);r.useEffect(()=>{if(!t)return;const u=setInterval(()=>{n(f=>f<=1?(h(),0):f-1)},1e3);return()=>clearInterval(u)},[t]);const h=()=>{s(),o("/bookings")},b=()=>{s()};return e.jsx(K,{open:t,onOpenChange:b,children:e.jsxs(Z,{className:"sm:max-w-[500px] p-0",children:[e.jsx(ve,{currentStep:"success",bookingId:a==null?void 0:a.id}),e.jsxs("div",{className:"p-6",children:[e.jsxs(Q,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(fe,{className:"h-8 w-8 text-green-600"})}),e.jsx(ee,{className:"text-xl font-semibold",children:"Booking Request Submitted!"})]}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-4 space-y-3",children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground uppercase tracking-wide",children:"Booking Details"}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center",children:e.jsx(He,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[a.carBrand," ",a.carModel]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["BWP ",a.totalPrice]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Rental Period"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[a.startDate," to ",a.endDate]})]})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-100 mb-2",children:"What happens next?"}),e.jsxs("ul",{className:"space-y-1 text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("li",{children:"• The car owner will review your request"}),e.jsx("li",{children:"• You'll be notified once it's approved"}),e.jsx("li",{children:"• Pickup details will be shared via messages"}),e.jsx("li",{children:"• Handover process will be available on booking day"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-4",children:[e.jsx(S,{variant:"outline",onClick:b,className:"flex-1",children:"Close"}),e.jsxs(S,{onClick:h,className:"flex-1",children:["View My Bookings ",i>0&&`(${i}s)`]})]})]})]})]})})},jt=({car:t,isOpen:s,onClose:a})=>{const[o,i]=r.useState(),[n,h]=r.useState(),[b,u]=r.useState("09:00"),[f,N]=r.useState("18:00"),[k,l]=r.useState(!1),[c,p]=r.useState(!1),[T,I]=r.useState(null),[C,L]=r.useState([]),[j,H]=r.useState(!1),[V,O]=r.useState(!0),[W,d]=r.useState(!1),[m,P]=r.useState(null),[q,X]=r.useState(!1),[ke,te]=r.useState(!1),[je,we]=r.useState(null),A=r.useRef(!0),{toast:$}=Te(),Ne=me(),{isVerified:J,isLoading:U}=qe();r.useEffect(()=>{(async()=>{var M,B;const{data:x}=await y.auth.getSession(),E=(B=(M=x.session)==null?void 0:M.user)==null?void 0:B.id;A.current&&(I(E),E&&t.owner_id===E&&p(!0))})()},[t.owner_id]),r.useEffect(()=>{s&&t.id&&((async()=>{const x=await Ie(t.id);L(x)})(),ce().catch(console.error))},[s,t.id]),r.useEffect(()=>{o&&n?(async()=>{if(o&&n&&t.id){H(!0);try{const x=await le(t.id,o,n);O(x)}catch(x){console.error("Error checking availability:",x),O(!1)}finally{H(!1)}}})():O(!0)},[o,n,t.id]),r.useEffect(()=>(s&&ce().catch(console.error),()=>{}),[s]),r.useEffect(()=>{t.latitude&&t.longitude&&P({latitude:t.latitude,longitude:t.longitude})},[t]),r.useEffect(()=>()=>{A.current=!1},[]);const se=async(g,x,E,M,B)=>{console.log("Creating notification:",{userId:g,type:x,content:E,carId:M,bookingId:B});const{error:R}=await y.from("notifications").insert({user_id:g,type:x,content:E,related_car_id:M,related_booking_id:B});return R?(console.error("Error creating notification:",R.message||JSON.stringify(R,null,2)),!1):!0},Se=async()=>{var B,R;const{data:g,error:x}=await y.auth.getSession();if(x||!((B=g.session)!=null&&B.user)){$({title:"Session expired",description:"Please sign in again to continue with your booking",variant:"destructive"}),Ne("/login");return}if(!J&&!U){X(!0);return}if(c){$({title:"Not allowed",description:"You cannot book your own car",variant:"destructive"});return}if(!o||!n){$({title:"Error",description:"Please select both start and end dates",variant:"destructive"});return}if(!await le(t.id,o,n)){$({title:"Not available",description:"This car is not available for the selected dates. Please choose different dates."});return}if(!m){$({title:"Error",description:"Please select a pickup location",variant:"destructive"});return}l(!0);const M=setTimeout(()=>{A.current&&(l(!1),$({title:"Timeout",description:"Booking is taking longer than expected. Please check your bookings page.",variant:"destructive"}))},3e4);try{console.log("[BookingDialog] Starting booking process...");const{data:D}=await y.auth.getSession();if(!((R=D.session)!=null&&R.user))throw new Error("No authenticated user");const re=(Math.ceil((n.getTime()-o.getTime())/(1e3*60*60*24))+1)*t.price_per_day;console.log("[BookingDialog] Creating booking in database...");const{data:G,error:ae}=await y.from("bookings").insert({car_id:t.id,renter_id:D.session.user.id,start_date:w(o,"yyyy-MM-dd"),end_date:w(n,"yyyy-MM-dd"),start_time:b,end_time:f,total_price:re,latitude:m.latitude,longitude:m.longitude,status:"pending"}).select().single();if(ae)throw ae;console.log("[BookingDialog] Booking created successfully:",G.id),console.log("[BookingDialog] Creating notifications...");try{await se(D.session.user.id,"booking_request",`Your booking request for ${t.brand} ${t.model} from ${w(o,"PPP")} to ${w(n,"PPP")} has been submitted.`,t.id,G.id)}catch(_){console.error("Failed to create renter notification (non-blocking):",_ instanceof Error?_.message:JSON.stringify(_,null,2))}try{await se(t.owner_id,"booking_request",`New booking request received for your ${t.brand} ${t.model} from ${w(o,"PPP")} to ${w(n,"PPP")}.`,t.id,G.id)}catch(_){console.error("Failed to create host notification (non-blocking):",_ instanceof Error?_.message:JSON.stringify(_,null,2))}if(!A.current)return;console.log("[BookingDialog] Booking flow completed successfully, showing success modal..."),we({id:G.id,carBrand:t.brand,carModel:t.model,startDate:w(o,"PPP"),endDate:w(n,"PPP"),totalPrice:re}),a(),te(!0)}catch(D){if(!A.current)return;console.error("Booking error:",D instanceof Error?D.message:JSON.stringify(D,null,2)),$({title:"Error",description:"Failed to create booking. Please try again.",variant:"destructive"})}finally{clearTimeout(M),A.current&&l(!1)}},Ce=(g,x)=>{P({latitude:g,longitude:x})},Pe=()=>m?m.latitude===t.latitude&&m.longitude===t.longitude?`Default: ${t.location}`:`Custom location (${m.latitude.toFixed(4)}, ${m.longitude.toFixed(4)})`:"No location selected",Be=g=>{const x=new Date;return x.setDate(x.getDate()),x.setHours(0,0,0,0),g<x?!0:Oe(g,C)};return e.jsxs(e.Fragment,{children:[e.jsx(K,{open:s,onOpenChange:a,children:e.jsxs(Z,{className:"sm:max-w-[425px] max-h-[90vh] overflow-y-auto p-0",children:[e.jsx(ve,{currentStep:"confirmation"}),e.jsxs("div",{className:"p-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:["Book ",t.brand," ",t.model]}),e.jsx(ue,{className:"text-muted-foreground",children:"Select your rental dates and pickup location"})]}),c&&e.jsxs(oe,{variant:"destructive",className:"mb-4",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx(ne,{children:"Not allowed"}),e.jsx(ie,{children:"You cannot book your own car. This is for other renters only."})]}),!V&&o&&n&&e.jsxs(oe,{variant:"destructive",className:"mb-4",children:[e.jsx(Ge,{className:"h-4 w-4"}),e.jsx(ne,{children:"Not available"}),e.jsx(ie,{children:"This car is not available for the selected dates. Please choose different dates."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Select dates"}),e.jsx(Ae,{mode:"range",selected:{from:o,to:n},onSelect:g=>{i(g==null?void 0:g.from),h(g==null?void 0:g.to)},numberOfMonths:1,disabled:Be,modifiers:{booked:C},modifiersStyles:{booked:{backgroundColor:"rgba(239, 68, 68, 0.1)",color:"rgb(239, 68, 68)",textDecoration:"line-through"}}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Pickup Location"}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Je,{className:"h-5 w-5 text-primary mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"text-sm",children:e.jsx("p",{children:Pe()})})]}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>d(!0),children:"Change"})]})]}),o&&n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Summary"}),e.jsxs("div",{className:"text-sm space-y-1 p-4 bg-primary/5 rounded-md",children:[e.jsxs("p",{children:["Start date: ",w(o,"PPP")]}),e.jsxs("p",{children:["End date: ",w(n,"PPP")]}),e.jsx("div",{className:"border-t border-border pt-2 mt-2",children:e.jsxs("p",{className:"font-medium text-primary",children:["Total: BWP"," ",Math.ceil((n.getTime()-o.getTime())/(1e3*60*60*24)+1)*t.price_per_day]})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>d(!0),children:"Change"})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 pt-4 border-t",children:[e.jsx(S,{variant:"outline",onClick:a,className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(S,{onClick:!J&&!U?()=>X(!0):Se,disabled:!o||!n||k||c||j||!V||!m||U,className:"w-full sm:w-auto",variant:!J&&!U?"outline":"default",children:k?"Booking...":j?"Checking...":U?"Checking verification...":J?"Confirm":"Start Verification"})]})]})]})}),e.jsx(Ue,{isOpen:q,onClose:()=>X(!1),action:"booking",carData:t}),e.jsx(et,{isOpen:W,onClose:()=>d(!1),onLocationSelected:Ce}),e.jsx(st,{isOpen:ke,onClose:()=>te(!1),bookingData:je})]})},wt=async t=>{try{console.log("Saving car:",t);const{data:{session:s}}=await y.auth.getSession();if(!(s!=null&&s.user))return console.log("No active session found when trying to save car"),v.error("Please sign in to save cars"),!1;const{data:a}=await y.from("saved_cars").select("id").eq("user_id",s.user.id).eq("car_id",t).maybeSingle();if(a)return console.log("Car already saved:",t),!0;const{error:o}=await y.from("saved_cars").insert({user_id:s.user.id,car_id:t});return o?(console.error("Error saving car:",o),v.error("Failed to save car. Please try again."),!1):(v.success("Car saved to your favorites"),!0)}catch(s){return console.error("Error in saveCar:",s),v.error("An error occurred while saving the car"),!1}},Nt=async t=>{try{console.log("Unsaving car:",t);const{data:{session:s}}=await y.auth.getSession();if(!(s!=null&&s.user))return console.log("No active session found when trying to unsave car"),v.error("Please sign in to manage saved cars"),!1;const{error:a}=await y.from("saved_cars").delete().eq("user_id",s.user.id).eq("car_id",t);return a?(console.error("Error unsaving car:",a),v.error("Failed to remove car from favorites. Please try again."),!1):(v.success("Car removed from your favorites"),!0)}catch(s){return console.error("Error in unsaveCar:",s),v.error("An error occurred while removing the car from favorites"),!1}},St=async t=>{try{const{data:{session:s}}=await y.auth.getSession();if(!(s!=null&&s.user))return!1;const{data:a}=await y.from("saved_cars").select("id").eq("user_id",s.user.id).eq("car_id",t).maybeSingle();return!!a}catch(s){return console.error("Error checking if car is saved:",s),!1}};export{jt as B,vt as C,kt as H,St as i,wt as s,Nt as u};
