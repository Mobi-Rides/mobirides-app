import{c as G,s as T,K as S,r as u,j as e,B as D,X as se,M as He,I as he,N as Le,S as Ae,U as $e,V as K,W as X,Y as Ue,Z as J,_ as Ke,b as ze,g as de,$ as fe,a0 as Be,z as qe,a1 as Oe,a2 as Ye}from"./index-B1v-fdDy.js";import{N as We}from"./Navigation-B7IoAuwX.js";import{C as Xe}from"./CustomMapbox-B-n_RDKf.js";import{C as A,a as z,b as B,d as $}from"./card-BByP0N-G.js";import{P as Ge}from"./progress-BdAEPFoL.js";import{B as W}from"./badge-CMWgFMV2.js";import{T as ge}from"./textarea-iq9NORl0.js";import{C as Y}from"./camera-BVx23dB2.js";import{U as pe}from"./upload-BHCRT7r9.js";import{C as re}from"./check-BnE2eJB3.js";import{P as xe}from"./plus-CDk_XeRs.js";import{S as Je,a as Qe,b as Ze,c as et,d as ee,u as tt}from"./select-DXEtncUe.js";import{c as ve}from"./index-BdQq_4o_.js";import{G as st}from"./gauge-Bk1GUCbY.js";import{C as te}from"./checkbox-ldtIqlPC.js";import{C as ne}from"./circle-check-big-BC5npB6H.js";import{R as rt}from"./rotate-ccw-CZKC6MAN.js";import{C as nt}from"./clock-CASyaKu3.js";import{M as at}from"./user-ClMVbWgE.js";import"./arrow-left-C5bMyyle.js";import"./send-BDkAZ2Oi.js";import"./arrow-right-wlC4lylp.js";import"./OnlineStatusToggle-jbesaRgw.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ot=G("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=G("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=G("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=G("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),je=async()=>{try{const{data:t,error:r}=await T.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(r)return console.error("Error checking location columns:",r),!1;if(!t||t.length===0)return console.error("No profiles found to check columns"),!1;const s=t[0];return s?"latitude"in s&&"longitude"in s&&"is_sharing_location"in s:!1}catch(t){return console.error("Error in checkLocationColumns:",t),!1}},be=t=>!t||typeof t!="object"?null:{id:typeof t.id=="string"?t.id:"",full_name:t.full_name||null,avatar_url:t.avatar_url||null,latitude:typeof t.latitude=="number"?t.latitude:null,longitude:typeof t.longitude=="number"?t.longitude:null,updated_at:t.updated_at||null},ct=async()=>{try{if(console.log("Fetching online hosts..."),!await je())return console.error("Required location columns don't exist in profiles table"),[];const{data:r,error:s}=await T.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(s)return console.error("Error fetching online hosts:",s),[];if(!r||!Array.isArray(r))return console.error("Expected array of hosts but got:",r),[];console.log(`Found ${r.length} online hosts`);const a=[];for(const o of r){const n=be(o);n&&a.push(n)}return a}catch(t){return console.error("Error in fetchOnlineHosts:",t),[]}},dt=async t=>{try{if(console.log("Fetching host by ID:",t),!await je())return console.error("Required location columns don't exist in profiles table"),null;const{data:s,error:a}=await T.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("id",t).single();return a?(console.error("Error fetching host:",a),null):s?be(s):(console.error("No host found with ID:",t),null)}catch(r){return console.error("Error in fetchHostById:",r),null}},O=[{name:"identity_verification",order:1,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:2,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:3,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:4,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:5,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:6,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:7,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:8,title:"Handover Complete",description:"Finalize the handover process"}],ut=async t=>{try{const{data:r}=await T.from("handover_step_completion").select("id").eq("handover_session_id",t);if(r&&r.length>0)return console.log("Handover steps already initialized"),!0;const s=O.map(o=>({handover_session_id:t,step_name:o.name,step_order:o.order,is_completed:!1})),{error:a}=await T.from("handover_step_completion").insert(s);if(a)throw a;return console.log("Handover steps initialized successfully"),!0}catch(r){return console.error("Error initializing handover steps:",r),S.error("Failed to initialize handover steps"),!1}},ue=async t=>{try{const{data:r,error:s}=await T.from("handover_step_completion").select("*").eq("handover_session_id",t).order("step_order");if(s)throw s;return r||[]}catch(r){return console.error("Error fetching handover steps:",r),[]}},mt=async(t,r,s)=>{var a;try{const{data:o}=await T.auth.getUser();if(!((a=o==null?void 0:o.user)!=null&&a.id))throw new Error("User not authenticated");const n=await ht(t,r,s);if(!n.isValid)return S.error(n.message),!1;const{error:i}=await T.from("handover_step_completion").update({is_completed:!0,completed_by:o.user.id,completion_data:s,completed_at:new Date().toISOString()}).eq("handover_session_id",t).eq("step_name",r);if(i)throw i;return console.log(`Step ${r} completed successfully`),!0}catch(o){return console.error("Error completing handover step:",o),S.error("Failed to complete handover step"),!1}},ht=async(t,r,s)=>{switch(r){case"fuel_mileage_check":if(!(s!=null&&s.fuel_level)||!(s!=null&&s.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};if(s.fuel_level<0||s.fuel_level>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(s.mileage<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(s!=null&&s.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},le=async(t,r,s,a=3)=>{var n;let o=0;for(;o<a;)try{const{data:i}=await T.auth.getUser();if(!((n=i==null?void 0:i.user)!=null&&n.id))throw new Error("User not authenticated");const h=t.name.split(".").pop(),d=`${i.user.id}/${r}/${s}_${Date.now()}.${h}`,{error:p}=await T.storage.from("handover-photos").upload(d,t);if(p)throw p;const{data:{publicUrl:v}}=T.storage.from("handover-photos").getPublicUrl(d);return console.log(`Photo uploaded successfully: ${d}`),v}catch(i){if(o++,console.error(`Photo upload attempt ${o} failed:`,i),o>=a)return S.error("Failed to upload photo after multiple attempts"),null;await new Promise(h=>setTimeout(h,1e3*o))}return null},ft=async t=>{var r;try{const{data:s}=await T.auth.getUser();if(!((r=s==null?void 0:s.user)!=null&&r.id))throw new Error("User not authenticated");const a={handover_session_id:t.handover_session_id,booking_id:t.booking_id,car_id:t.car_id,report_type:t.report_type,vehicle_photos:JSON.stringify(t.vehicle_photos),damage_reports:JSON.stringify(t.damage_reports),fuel_level:t.fuel_level,mileage:t.mileage,exterior_condition_notes:t.exterior_condition_notes,interior_condition_notes:t.interior_condition_notes,additional_notes:t.additional_notes,digital_signature_data:t.digital_signature_data,is_acknowledged:t.is_acknowledged},{data:o,error:n}=await T.from("vehicle_condition_reports").insert(a).select().single();if(n)throw n;return console.log("Vehicle condition report created successfully"),o}catch(s){return console.error("Error creating vehicle condition report:",s),S.error("Failed to create condition report"),null}},gt=async t=>{var r;try{const{data:s}=await T.auth.getUser();if(!((r=s==null?void 0:s.user)!=null&&r.id))throw new Error("User not authenticated");const a={handover_session_id:t.handover_session_id,verifier_id:s.user.id,verified_user_id:t.verified_user_id,verification_photo_url:t.verification_photo_url,license_photo_url:t.license_photo_url,verification_status:t.verification_status,verification_notes:t.verification_notes},{data:o,error:n}=await T.from("identity_verification_checks").insert(a).select().single();if(n)throw n;return o}catch(s){return console.error("Error creating identity verification check:",s),S.error("Failed to create identity verification"),null}},pt=({handoverSessionId:t,otherUserId:r,otherUserName:s,isHost:a,onStepComplete:o})=>{const[n,i]=u.useState(null),[h,d]=u.useState(!1),[p,v]=u.useState("pending"),[g,x]=u.useState(""),[w,b]=u.useState(!1),m=async c=>{var _;const y=(_=c.target.files)==null?void 0:_[0];if(y){d(!0);try{const f=await le(y,t,"identity_verification");f&&(i(f),await gt({handover_session_id:t,verifier_id:"",verified_user_id:r,verification_photo_url:f,verification_status:"pending"}),S.success("Verification photo uploaded successfully"))}catch{S.error("Failed to upload verification photo")}finally{d(!1)}}},l=async c=>{b(!0);try{v(c),c==="verified"?(S.success(`${s}'s identity verified successfully`),o()):S.error("Identity verification failed")}catch{S.error("Failed to update verification status")}finally{b(!1)}};return e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",s,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx($,{className:"space-y-4",children:n?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:n,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(W,{variant:p==="verified"?"default":p==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[p==="verified"&&e.jsx(re,{className:"h-3 w-3 mr-1"}),p==="failed"&&e.jsx(se,{className:"h-3 w-3 mr-1"}),p.charAt(0).toUpperCase()+p.slice(1)]})]}),p==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(ge,{placeholder:"Add any notes about the verification...",value:g,onChange:c=>x(c.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(D,{onClick:()=>l("verified"),disabled:w,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(D,{onClick:()=>l("failed"),disabled:w,variant:"destructive",className:"flex-1",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),p==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),p==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",s," for identity verification"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:m,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:h}),e.jsx(D,{disabled:h,className:"flex items-center gap-2",children:h?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4"}),"Take Photo"]})})]})]})})]})},xt={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},me=({handoverSessionId:t,inspectionType:r,onPhotosUpdate:s,onStepComplete:a,initialPhotos:o=[]})=>{const[n,i]=u.useState(o),[h,d]=u.useState(!1),[p,v]=u.useState(null),g=xt[r],x=g.filter(f=>f.required),w=x.filter(f=>n.some(N=>N.type===f.type)),b=async(f,N)=>{d(!0),v(f);try{const R=await le(N,t,f);if(R){const P={id:`${Date.now()}-${f}`,type:f,url:R,timestamp:new Date().toISOString()},E=[...n,P];i(E),s(E),S.success("Photo uploaded successfully")}}catch{S.error("Failed to upload photo")}finally{d(!1),v(null)}},m=f=>{var R;const N=(R=f.target.files)==null?void 0:R[0];N&&b(p,N)},l=f=>{const N=n.filter(R=>R.id!==f);i(N),s(N)},c=f=>n.find(N=>N.type===f),y=w.length===x.length,_=()=>{y&&(a(),S.success(`${r} inspection completed`))};return e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"h-5 w-5"}),r==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(W,{variant:y?"default":"secondary",children:[w.length,"/",x.length," Required Photos"]})})]}),e.jsxs($,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:g.map(f=>{const N=c(f.type),R=p===f.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:f.label}),f.required&&e.jsx(W,{variant:"outline",className:"text-xs",children:"Required"})]}),N?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:N.url,alt:f.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(D,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>l(N.id),children:e.jsx(ye,{className:"h-4 w-4"})})})]}):e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center",children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:m,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:R}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:R?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-6 w-6 animate-spin text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})})]},f.type)})}),y&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(D,{onClick:_,className:"w-full",children:["Complete ",r==="exterior"?"Exterior":"Interior"," Inspection"]})}),!y&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},vt=({handoverSessionId:t,onDamageReportsUpdate:r,onStepComplete:s,initialReports:a=[]})=>{const[o,n]=u.useState(a),[i,h]=u.useState(!1),[d,p]=u.useState({location:"",severity:"minor",description:"",photos:[]}),[v,g]=u.useState(!1),x=async l=>{g(!0);try{const c=await le(l,t,"damage_specific");c&&(p(y=>({...y,photos:[...y.photos,c]})),S.success("Damage photo uploaded"))}catch{S.error("Failed to upload damage photo")}finally{g(!1)}},w=()=>{if(!d.location||!d.description){S.error("Please fill in location and description");return}const l={id:`damage-${Date.now()}`,location:d.location,severity:d.severity,description:d.description,photos:d.photos,timestamp:new Date().toISOString()},c=[...o,l];n(c),r(c),p({location:"",severity:"minor",description:"",photos:[]}),h(!1),S.success("Damage report added")},b=l=>{const c=o.filter(y=>y.id!==l);n(c),r(c)},m=l=>{switch(l){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(He,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs($,{className:"space-y-4",children:[o.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",o.length,")"]}),o.map(l=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:l.location}),e.jsx(W,{className:`ml-2 ${m(l.severity)}`,children:l.severity})]}),e.jsx(D,{size:"sm",variant:"outline",onClick:()=>b(l.id),children:e.jsx(ye,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:l.description}),l.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:l.photos.map((c,y)=>e.jsx("img",{src:c,alt:`Damage ${y+1}`,className:"w-full h-20 object-cover rounded"},y))})]},l.id))]}),i?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(he,{placeholder:"e.g., Front bumper, Driver door",value:d.location,onChange:l=>p(c=>({...c,location:l.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(Je,{value:d.severity,onValueChange:l=>p(c=>({...c,severity:l})),children:[e.jsx(Qe,{children:e.jsx(Ze,{})}),e.jsxs(et,{children:[e.jsx(ee,{value:"minor",children:"Minor"}),e.jsx(ee,{value:"moderate",children:"Moderate"}),e.jsx(ee,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(ge,{placeholder:"Describe the damage in detail...",value:d.description,onChange:l=>p(c=>({...c,description:l.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[d.photos.map((l,c)=>e.jsx("img",{src:l,alt:`Damage photo ${c+1}`,className:"w-full h-20 object-cover rounded"},c)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:l=>{var y;const c=(y=l.target.files)==null?void 0:y[0];c&&x(c)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:v}),e.jsx(Y,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{onClick:w,className:"flex-1",children:"Save Damage Report"}),e.jsx(D,{variant:"outline",onClick:()=>h(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(D,{onClick:()=>h(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(D,{onClick:s,className:"w-full",children:o.length>0?`Complete Documentation (${o.length} damage reports)`:"No Damage - Complete Step"})})]})]})};var Ne=["PageUp","PageDown"],we=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],_e={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},q="Slider",[ae,yt,jt]=Le(q),[Se,ds]=Ae(q,[jt]),[bt,Q]=Se(q),ke=u.forwardRef((t,r)=>{const{name:s,min:a=0,max:o=100,step:n=1,orientation:i="horizontal",disabled:h=!1,minStepsBetweenThumbs:d=0,defaultValue:p=[a],value:v,onValueChange:g=()=>{},onValueCommit:x=()=>{},inverted:w=!1,form:b,...m}=t,l=u.useRef(new Set),c=u.useRef(0),_=i==="horizontal"?Nt:wt,[f=[],N]=$e({prop:v,defaultProp:p,onChange:I=>{var j;(j=[...l.current][c.current])==null||j.focus(),g(I)}}),R=u.useRef(f);function P(I){const H=Pt(f,I);L(I,H)}function E(I){L(I,c.current)}function Z(){const I=R.current[c.current];f[c.current]!==I&&x(f)}function L(I,H,{commit:j}={commit:!1}){const V=Dt(n),k=Mt(Math.round((I-a)/n)*n+a,V),F=ve(k,[a,o]);N((C=[])=>{const M=kt(C,F,H);if(It(M,d*n)){c.current=M.indexOf(F);const U=String(M)!==String(C);return U&&j&&x(M),U?M:C}else return C})}return e.jsx(bt,{scope:t.__scopeSlider,name:s,disabled:h,min:a,max:o,valueIndexToChangeRef:c,thumbs:l.current,values:f,orientation:i,form:b,children:e.jsx(ae.Provider,{scope:t.__scopeSlider,children:e.jsx(ae.Slot,{scope:t.__scopeSlider,children:e.jsx(_,{"aria-disabled":h,"data-disabled":h?"":void 0,...m,ref:r,onPointerDown:K(m.onPointerDown,()=>{h||(R.current=f)}),min:a,max:o,inverted:w,onSlideStart:h?void 0:P,onSlideMove:h?void 0:E,onSlideEnd:h?void 0:Z,onHomeKeyDown:()=>!h&&L(a,0,{commit:!0}),onEndKeyDown:()=>!h&&L(o,f.length-1,{commit:!0}),onStepKeyDown:({event:I,direction:H})=>{if(!h){const k=Ne.includes(I.key)||I.shiftKey&&we.includes(I.key)?10:1,F=c.current,C=f[F],M=n*k*H;L(C+M,F,{commit:!0})}}})})})})});ke.displayName=q;var[Ce,Pe]=Se(q,{startEdge:"left",endEdge:"right",size:"width",direction:1}),Nt=u.forwardRef((t,r)=>{const{min:s,max:a,dir:o,inverted:n,onSlideStart:i,onSlideMove:h,onSlideEnd:d,onStepKeyDown:p,...v}=t,[g,x]=u.useState(null),w=X(r,_=>x(_)),b=u.useRef(),m=Ue(o),l=m==="ltr",c=l&&!n||!l&&n;function y(_){const f=b.current||g.getBoundingClientRect(),N=[0,f.width],P=ce(N,c?[s,a]:[a,s]);return b.current=f,P(_-f.left)}return e.jsx(Ce,{scope:t.__scopeSlider,startEdge:c?"left":"right",endEdge:c?"right":"left",direction:c?1:-1,size:"width",children:e.jsx(Re,{dir:m,"data-orientation":"horizontal",...v,ref:w,style:{...v.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:_=>{const f=y(_.clientX);i==null||i(f)},onSlideMove:_=>{const f=y(_.clientX);h==null||h(f)},onSlideEnd:()=>{b.current=void 0,d==null||d()},onStepKeyDown:_=>{const N=_e[c?"from-left":"from-right"].includes(_.key);p==null||p({event:_,direction:N?-1:1})}})})}),wt=u.forwardRef((t,r)=>{const{min:s,max:a,inverted:o,onSlideStart:n,onSlideMove:i,onSlideEnd:h,onStepKeyDown:d,...p}=t,v=u.useRef(null),g=X(r,v),x=u.useRef(),w=!o;function b(m){const l=x.current||v.current.getBoundingClientRect(),c=[0,l.height],_=ce(c,w?[a,s]:[s,a]);return x.current=l,_(m-l.top)}return e.jsx(Ce,{scope:t.__scopeSlider,startEdge:w?"bottom":"top",endEdge:w?"top":"bottom",size:"height",direction:w?1:-1,children:e.jsx(Re,{"data-orientation":"vertical",...p,ref:g,style:{...p.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:m=>{const l=b(m.clientY);n==null||n(l)},onSlideMove:m=>{const l=b(m.clientY);i==null||i(l)},onSlideEnd:()=>{x.current=void 0,h==null||h()},onStepKeyDown:m=>{const c=_e[w?"from-bottom":"from-top"].includes(m.key);d==null||d({event:m,direction:c?-1:1})}})})}),Re=u.forwardRef((t,r)=>{const{__scopeSlider:s,onSlideStart:a,onSlideMove:o,onSlideEnd:n,onHomeKeyDown:i,onEndKeyDown:h,onStepKeyDown:d,...p}=t,v=Q(q,s);return e.jsx(J.span,{...p,ref:r,onKeyDown:K(t.onKeyDown,g=>{g.key==="Home"?(i(g),g.preventDefault()):g.key==="End"?(h(g),g.preventDefault()):Ne.concat(we).includes(g.key)&&(d(g),g.preventDefault())}),onPointerDown:K(t.onPointerDown,g=>{const x=g.target;x.setPointerCapture(g.pointerId),g.preventDefault(),v.thumbs.has(x)?x.focus():a(g)}),onPointerMove:K(t.onPointerMove,g=>{g.target.hasPointerCapture(g.pointerId)&&o(g)}),onPointerUp:K(t.onPointerUp,g=>{const x=g.target;x.hasPointerCapture(g.pointerId)&&(x.releasePointerCapture(g.pointerId),n(g))})})}),Ee="SliderTrack",Ie=u.forwardRef((t,r)=>{const{__scopeSlider:s,...a}=t,o=Q(Ee,s);return e.jsx(J.span,{"data-disabled":o.disabled?"":void 0,"data-orientation":o.orientation,...a,ref:r})});Ie.displayName=Ee;var oe="SliderRange",De=u.forwardRef((t,r)=>{const{__scopeSlider:s,...a}=t,o=Q(oe,s),n=Pe(oe,s),i=u.useRef(null),h=X(r,i),d=o.values.length,p=o.values.map(x=>Te(x,o.min,o.max)),v=d>1?Math.min(...p):0,g=100-Math.max(...p);return e.jsx(J.span,{"data-orientation":o.orientation,"data-disabled":o.disabled?"":void 0,...a,ref:h,style:{...t.style,[n.startEdge]:v+"%",[n.endEdge]:g+"%"}})});De.displayName=oe;var ie="SliderThumb",Me=u.forwardRef((t,r)=>{const s=yt(t.__scopeSlider),[a,o]=u.useState(null),n=X(r,h=>o(h)),i=u.useMemo(()=>a?s().findIndex(h=>h.ref.current===a):-1,[s,a]);return e.jsx(_t,{...t,ref:n,index:i})}),_t=u.forwardRef((t,r)=>{const{__scopeSlider:s,index:a,name:o,...n}=t,i=Q(ie,s),h=Pe(ie,s),[d,p]=u.useState(null),v=X(r,y=>p(y)),g=d?i.form||!!d.closest("form"):!0,x=Ke(d),w=i.values[a],b=w===void 0?0:Te(w,i.min,i.max),m=Ct(a,i.values.length),l=x==null?void 0:x[h.size],c=l?Rt(l,b,h.direction):0;return u.useEffect(()=>{if(d)return i.thumbs.add(d),()=>{i.thumbs.delete(d)}},[d,i.thumbs]),e.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[h.startEdge]:`calc(${b}% + ${c}px)`},children:[e.jsx(ae.ItemSlot,{scope:t.__scopeSlider,children:e.jsx(J.span,{role:"slider","aria-label":t["aria-label"]||m,"aria-valuemin":i.min,"aria-valuenow":w,"aria-valuemax":i.max,"aria-orientation":i.orientation,"data-orientation":i.orientation,"data-disabled":i.disabled?"":void 0,tabIndex:i.disabled?void 0:0,...n,ref:v,style:w===void 0?{display:"none"}:t.style,onFocus:K(t.onFocus,()=>{i.valueIndexToChangeRef.current=a})})}),g&&e.jsx(St,{name:o??(i.name?i.name+(i.values.length>1?"[]":""):void 0),form:i.form,value:w},a)]})});Me.displayName=ie;var St=t=>{const{value:r,...s}=t,a=u.useRef(null),o=tt(r);return u.useEffect(()=>{const n=a.current,i=window.HTMLInputElement.prototype,d=Object.getOwnPropertyDescriptor(i,"value").set;if(o!==r&&d){const p=new Event("input",{bubbles:!0});d.call(n,r),n.dispatchEvent(p)}},[o,r]),e.jsx("input",{style:{display:"none"},...s,ref:a,defaultValue:r})};function kt(t=[],r,s){const a=[...t];return a[s]=r,a.sort((o,n)=>o-n)}function Te(t,r,s){const n=100/(s-r)*(t-r);return ve(n,[0,100])}function Ct(t,r){return r>2?`Value ${t+1} of ${r}`:r===2?["Minimum","Maximum"][t]:void 0}function Pt(t,r){if(t.length===1)return 0;const s=t.map(o=>Math.abs(o-r)),a=Math.min(...s);return s.indexOf(a)}function Rt(t,r,s){const a=t/2,n=ce([0,50],[0,a]);return(a-n(r)*s)*s}function Et(t){return t.slice(0,-1).map((r,s)=>t[s+1]-r)}function It(t,r){if(r>0){const s=Et(t);return Math.min(...s)>=r}return!0}function ce(t,r){return s=>{if(t[0]===t[1]||r[0]===r[1])return r[0];const a=(r[1]-r[0])/(t[1]-t[0]);return r[0]+a*(s-t[0])}}function Dt(t){return(String(t).split(".")[1]||"").length}function Mt(t,r){const s=Math.pow(10,r);return Math.round(t*s)/s}var Ve=ke,Tt=Ie,Vt=De,Ft=Me;const Fe=u.forwardRef(({className:t,...r},s)=>e.jsxs(Ve,{ref:s,className:ze("relative flex w-full touch-none select-none items-center",t),...r,children:[e.jsx(Tt,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(Vt,{className:"absolute h-full bg-primary"})}),e.jsx(Ft,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));Fe.displayName=Ve.displayName;const Ht=({handoverSessionId:t,onFuelLevelChange:r,onMileageChange:s,onStepComplete:a,initialFuelLevel:o,initialMileage:n})=>{const[i,h]=u.useState(o||50),[d,p]=u.useState((n==null?void 0:n.toString())||""),v=b=>{const m=b[0];h(m),r(m)},g=b=>{p(b);const m=parseInt(b,10);isNaN(m)||s(m)},x=d!==""&&!isNaN(parseInt(d,10))&&parseInt(d,10)>0,w=()=>{x?(a(),S.success("Fuel level and mileage recorded successfully")):S.error("Please enter a valid mileage reading")};return e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(st,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs($,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(de,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(Fe,{value:[i],onValueChange:v,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[i,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${i<=25?"#ef4444":i<=50?"#f59e0b":"#10b981"} 0deg,
                    ${i<=25?"#ef4444":i<=50?"#f59e0b":"#10b981"} ${i/100*360}deg,
                    #e5e7eb ${i/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[i,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(de,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(ot,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(he,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:d,onChange:b=>g(b.target.value),className:"pl-10",min:"0"})]}),d&&!isNaN(parseInt(d,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(d,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[i,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:d?`${parseInt(d,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(D,{onClick:w,disabled:!x,className:"w-full",children:"Complete Fuel & Mileage Check"}),!x&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},Lt=({handoverSessionId:t,otherUserName:r,isHost:s,onStepComplete:a})=>{const[o,n]=u.useState(!1),[i,h]=u.useState(!1),[d,p]=u.useState(!1),v=o&&i&&d,g=()=>{v&&(a(),S.success("Key transfer completed successfully"))};return e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(it,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s?`Transfer vehicle keys to ${r}`:`Receive vehicle keys from ${r}`})]}),e.jsxs($,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(te,{id:"key-transferred",checked:o,onCheckedChange:x=>n(x)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:s?`I have handed over the main vehicle key to ${r}`:`I have received the main vehicle key from ${r}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(te,{id:"key-received",checked:i,onCheckedChange:x=>h(x)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:s?`${r} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(te,{id:"spares-confirmed",checked:d,onCheckedChange:x=>p(x)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:o&&i?e.jsxs(e.Fragment,{children:[e.jsx(ne,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(D,{onClick:g,disabled:!v,className:"w-full",children:"Complete Key Transfer"}),!v&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},At=({handoverSessionId:t,onSignatureComplete:r,initialSignature:s})=>{const a=u.useRef(null),[o,n]=u.useState(!1),[i,h]=u.useState(!!s),[d,p]=u.useState(s||null),v=m=>{n(!0);const l=a.current;if(!l)return;const c=l.getBoundingClientRect(),y=l.getContext("2d");if(!y)return;y.lineWidth=2,y.lineCap="round",y.strokeStyle="#000";let _,f;"touches"in m?(_=m.touches[0].clientX-c.left,f=m.touches[0].clientY-c.top):(_=m.clientX-c.left,f=m.clientY-c.top),y.beginPath(),y.moveTo(_,f)},g=m=>{if(!o)return;const l=a.current,c=l==null?void 0:l.getContext("2d");if(!l||!c)return;const y=l.getBoundingClientRect();let _,f;"touches"in m?(_=m.touches[0].clientX-y.left,f=m.touches[0].clientY-y.top):(_=m.clientX-y.left,f=m.clientY-y.top),c.lineTo(_,f),c.stroke(),h(!0)},x=()=>{n(!1)},w=()=>{const m=a.current,l=m==null?void 0:m.getContext("2d");!m||!l||(l.clearRect(0,0,m.width,m.height),h(!1),p(null))},b=()=>{const m=a.current;if(!m||!i)return;const l=m.toDataURL("image/png");p(l),r(l),S.success("Digital signature captured successfully")};return u.useState(()=>{if(s&&a.current){const l=a.current.getContext("2d"),c=new Image;c.onload=()=>{l==null||l.drawImage(c,0,0)},c.src=s}}),e.jsxs(A,{className:"w-full",children:[e.jsxs(z,{children:[e.jsxs(B,{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:a,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:v,onMouseMove:g,onMouseUp:x,onMouseLeave:x,onTouchStart:v,onTouchMove:g,onTouchEnd:x,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(D,{variant:"outline",onClick:w,disabled:!i,className:"flex-1",children:[e.jsx(rt,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(D,{onClick:b,disabled:!i,className:"flex-1",children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),d&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},$t=({isOpen:t,onClose:r,handoverSessionId:s})=>{var I,H;const{isLoading:a,isHost:o,bookingDetails:n}=fe(),[i,h]=u.useState(0),[d,p]=u.useState([]),[v,g]=u.useState([]),[x,w]=u.useState([]),[b,m]=u.useState(),[l,c]=u.useState(),[y,_]=u.useState();u.useEffect(()=>{s&&t&&f()},[s,t]);const f=async()=>{await ut(s);const j=await ue(s);p(j);const V=j.findIndex(k=>!k.is_completed);h(V>=0?V:j.length)},N=async(j,V)=>{if(await mt(s,j,V)){const F=await ue(s);p(F);const C=F.findIndex(M=>!M.is_completed);C>=0?h(C):await R()}},R=async()=>{var j;try{(v.length>0||x.length>0||b||l)&&await ft({handover_session_id:s,booking_id:(n==null?void 0:n.id)||"",car_id:((j=n==null?void 0:n.car)==null?void 0:j.id)||"",report_type:"pickup",vehicle_photos:v,damage_reports:x,fuel_level:b,mileage:l,digital_signature_data:y,is_acknowledged:!0}),S.success("Handover completed successfully!"),r()}catch(V){console.error("Error completing handover:",V),S.error("Failed to complete handover")}},P=j=>{switch(j){case"identity_verification":return!0;case"vehicle_inspection_exterior":return v.filter(k=>k.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return v.filter(k=>k.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(k.type)).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return b!==void 0&&l!==void 0;case"key_transfer":return!0;case"digital_signature":return y!==void 0;default:return!0}},E=(j,V)=>{var F;const k=o?n==null?void 0:n.renter:(F=n==null?void 0:n.car)==null?void 0:F.owner;switch(j.name){case"identity_verification":return e.jsx(pt,{handoverSessionId:s,otherUserId:(k==null?void 0:k.id)||"",otherUserName:(k==null?void 0:k.full_name)||"User",isHost:o,onStepComplete:()=>N(j.name)});case"vehicle_inspection_exterior":return e.jsx(me,{handoverSessionId:s,inspectionType:"exterior",onPhotosUpdate:C=>{const M=v.filter(U=>!U.type.startsWith("exterior_"));g([...M,...C])},onStepComplete:()=>N(j.name),initialPhotos:v.filter(C=>C.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return e.jsx(me,{handoverSessionId:s,inspectionType:"interior",onPhotosUpdate:C=>{const M=v.filter(U=>!U.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(U.type));g([...M,...C])},onStepComplete:()=>N(j.name),initialPhotos:v.filter(C=>C.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(C.type))});case"damage_documentation":return e.jsx(vt,{handoverSessionId:s,onDamageReportsUpdate:w,onStepComplete:()=>N(j.name),initialReports:x});case"fuel_mileage_check":return e.jsx(Ht,{handoverSessionId:s,onFuelLevelChange:m,onMileageChange:c,onStepComplete:()=>N(j.name,{fuel_level:b,mileage:l}),initialFuelLevel:b,initialMileage:l});case"key_transfer":return e.jsx(Lt,{handoverSessionId:s,otherUserName:(k==null?void 0:k.full_name)||"User",isHost:o,onStepComplete:()=>N(j.name)});case"digital_signature":return e.jsx(At,{handoverSessionId:s,onSignatureComplete:C=>{_(C),N(j.name,{signature:C})},initialSignature:y});default:return e.jsx(A,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:j.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:j.description}),e.jsxs(D,{onClick:()=>N(j.name),disabled:!P(j.name),children:["Complete ",j.title]})]})})})}};if(a)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(A,{className:"w-96",children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:"Loading handover process..."})]})})})});const Z=d.filter(j=>j.is_completed).length/O.length*100,L=O[i];return e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:t?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:r}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[90vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(I=n==null?void 0:n.car)==null?void 0:I.brand," ",(H=n==null?void 0:n.car)==null?void 0:H.model]})]}),e.jsx("button",{onClick:r,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(se,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Progress"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[d.filter(j=>j.is_completed).length," of ",O.length," steps"]})]}),e.jsx(Ge,{value:Z,className:"h-2"})]}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:O.map((j,V)=>{const k=d.find(M=>M.step_name===j.name),F=(k==null?void 0:k.is_completed)||!1,C=V===i;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${F?"bg-green-50 border-green-200 text-green-800":C?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:F?e.jsx(ne,{className:"h-4 w-4"}):C?e.jsx(nt,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:j.title})]},j.name)})})}),L?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(W,{variant:"outline",children:["Step ",i+1]}),e.jsx("span",{className:"font-medium",children:L.title})]}),E(L)]}):e.jsx(A,{children:e.jsx($,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ne,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})},us=()=>{const[t]=Be(),r=t.get("mode"),s=t.get("bookingId"),[a,o]=u.useState(""),[n,i]=u.useState(!0),[h,d]=u.useState([]),[p,v]=u.useState(!1),[g,x]=u.useState({latitude:null,longitude:null}),{theme:w}=qe(),{handoverStatus:b}=fe(),m=!!(r==="handover"&&s),[l,c]=u.useState(null),[y,_]=u.useState(!1);u.useCallback((P,E)=>{console.log("Setting destination",P,E),x({latitude:P,longitude:E})},[]),u.useCallback(P=>{console.log("Handover host",P),c(P)},[]),u.useCallback(P=>{console.log("Is user host?",P),_(P)},[]),u.useEffect(()=>{m&&v(!0)},[m]),u.useEffect(()=>{(async()=>{i(!0);try{const E=await Oe();if(!E){S.error("Failed to get the map token"),console.error("Failed to get the map token");return}o(E)}catch(E){console.error("Error getting the map token:",E),S.error("Failed to get the map token")}finally{i(!1)}})()},[]);const f=async()=>{console.log("Fetching host locations...");try{const P=await ct(),E=l?await dt(l):null;if(P.length||S.info("No hosts are currently online"),l&&E)return d([E]);console.log("Host locations",P),d(P)}catch(P){console.error("Error fetching host locations:",P),S.error("Failed to fetch host locations")}};u.useEffect(()=>{m||(f(),console.log("Location",g))},[m]);const N=()=>w==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",R=()=>n?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:"Loading map..."}),e.jsx(Ye,{color:"#7c3aed",width:100})]}):a?e.jsx(Xe,{mapbox_token:a,longitude:25.90859,latitude:-24.65451,onlineHosts:m?[]:h,mapStyle:N(),isHandoverMode:m,bookingId:s,dpad:!0,locationToggle:!0,destination:g}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]});return e.jsxs("div",{className:"min-h-screen bg-background dark:bg-gray-900",children:[e.jsxs("main",{className:"pb-16",children:[e.jsx("div",{className:"h-[calc(100vh-4rem)]",children:R()}),m&&e.jsx("div",{className:"fixed bottom-20 left-0 right-0 z-10 flex justify-center",children:e.jsxs(D,{className:"shadow-lg",onClick:()=>v(!0),children:[e.jsx(at,{className:"mr-2 h-4 w-4"}),"Handover Details"]})})]}),m&&e.jsx($t,{isOpen:p,onClose:()=>v(!1),handoverSessionId:(b==null?void 0:b.id)||s||""}),e.jsx(We,{})]})};export{us as default};
