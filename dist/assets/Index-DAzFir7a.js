import{j as e,u as Z,d as oe}from"./query-vendor-C7aRRP05.js";import{r as o,u as V,f as G,h as ie}from"./react-vendor-mnpoGfEl.js";import{u as K,H as ce}from"./useHandoverPrompts-B0D5R7xW.js";import{N as de}from"./Navigation-BvJCQdva.js";import{u as le}from"./useAuthStatus-BpX-txE6.js";import{c as B,B as R,A as ue,T as me,s as C,a as J,J as T,X as he,L as ge}from"./index-D9LOOiBY.js";import{C as Y}from"./CarGrid-BRZPfSXi.js";import{C as X,a as xe}from"./card-0dd-x2VS.js";import{C as $}from"./clock-CFBaLxjz.js";import{M as fe}from"./map-pin-BtopcvdL.js";import{C as Q}from"./car-DvspwSJC.js";import{a as pe}from"./date-vendor-Dhms5dOu.js";import{C as ve}from"./circle-check-big-rGt2oTzx.js";import{S as be}from"./shield-Tr4U0OA6.js";import"./sheet-DtJlGaaJ.js";import"./SearchFilters-VrHWTHyS.js";import"./calendar-DMqauZ4Q.js";import"./chevron-left-D__dulFx.js";import"./popover-Bp7nue1Y.js";import"./LocationSearchInput-B1hE09ig.js";import"./star-BwZJAYBL.js";import"./calendar-hLJryCgl.js";import"./arrow-up-down-BOupC7AP.js";import"./useVerificationStatus-xe-R1DUW.js";import"./circle-alert-DI0VRaYv.js";import"./navigation-VfAfb5mz.js";import"./supabase-vendor-BOn0LdFJ.js";import"./bell-C2_b2vq0.js";import"./user-B9gAMDWP.js";import"./mapbox-vendor-fnXFVHMy.js";import"./savedCarService-CS6qo-fP.js";import"./separator-YD7IlT-d.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=B("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=B("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=B("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]),we=()=>{const[t,r]=o.useState(!1),[a,s]=o.useState("signin"),n=V(),i=o.useCallback(()=>{s("signin"),r(!0),n("/?auth=signin",{replace:!0})},[n]),c=o.useCallback(()=>{s("signup"),r(!0),n("/?auth=signup",{replace:!0})},[n]),d=o.useCallback(()=>{r(!1),n("/",{replace:!0})},[n]);return{isOpen:t,defaultTab:a,openSignIn:i,openSignUp:c,close:d,setIsOpen:r}},ye=()=>{const{isOpen:t,defaultTab:r,openSignIn:a,close:s}=we(),n=G();return o.useEffect(()=>{const c=new URLSearchParams(n.search).get("auth");(c==="signin"||c==="signup")&&c==="signin"&&a()},[n.search,a]),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[e.jsxs("div",{className:"p-8 rounded-lg",children:[e.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),e.jsxs(R,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:a,children:[e.jsx(je,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"hidden md:inline-block",children:e.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),e.jsx(ue,{isOpen:t,onClose:s,defaultTab:r,idPrefix:"home"})]})},re=({prompt:t,onStartHandover:r})=>{const a=V(),s=()=>{switch(t.urgencyLevel){case"immediate":return"bg-destructive text-destructive-foreground border-destructive";case"soon":return"bg-orange-50 text-orange-900 border-orange-200 dark:bg-orange-950 dark:text-orange-100 dark:border-orange-800";case"morning":return"bg-blue-50 text-blue-900 border-blue-200 dark:bg-blue-950 dark:text-blue-100 dark:border-blue-800";default:return"bg-muted text-muted-foreground"}},n=()=>{switch(t.urgencyLevel){case"immediate":return e.jsx(me,{className:"h-5 w-5 animate-pulse"});case"soon":return e.jsx($,{className:"h-5 w-5"});default:return e.jsx(Q,{className:"h-5 w-5"})}},i=()=>{r(t.bookingId)},c=()=>{a(`/rental-details/${t.bookingId}`)};return e.jsx(X,{className:`p-4 border-l-4 ${s()}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:n()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h3",{className:"font-semibold text-sm",children:t.handoverType==="pickup"?"Car Pickup Required":"Car Return Required"}),t.isUrgent&&e.jsx("span",{className:"px-2 py-1 text-xs bg-current/10 rounded-full font-medium",children:"URGENT"})]}),e.jsxs("p",{className:"text-sm opacity-90 mb-2",children:[t.carBrand," ",t.carModel," â€¢ ",t.otherPartyName]}),e.jsxs("div",{className:"flex items-center gap-4 text-xs opacity-75 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{className:"h-3 w-3"}),pe(t.handoverType==="pickup"?t.startDate:t.endDate,"MMM d, h:mm a")]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"h-3 w-3"}),t.location]})]}),e.jsxs("div",{className:"flex gap-2",children:[t.shouldInitiate?e.jsxs(R,{onClick:i,size:"sm",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",variant:"outline",children:["Start ",t.handoverType==="pickup"?"Pickup":"Return"]}):e.jsxs(R,{onClick:c,size:"sm",variant:"outline",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",children:["Prepare for ",t.handoverType==="pickup"?"Pickup":"Return"]}),e.jsx(R,{onClick:c,size:"sm",variant:"ghost",className:"text-current hover:bg-current/10",children:"View Details"})]})]})]})})},Ne=({searchQuery:t})=>{const[r,a]=o.useState(null),[s,n]=o.useState("asc"),i=o.useRef(null),c=V(),{handoverPrompts:d,hasHandoverPrompts:m,refetch:p}=K(),{data:v,isLoading:b,error:M}=Z({queryKey:["host-cars",t,s,r],queryFn:async()=>{var j;console.log("Fetching host cars with search:",t,"brand:",r);const{data:{session:g}}=await C.auth.getSession();if(!((j=g==null?void 0:g.user)!=null&&j.id))return[];let u=C.from("cars").select("*").eq("owner_id",g.user.id);t&&(u=u.or(`brand.ilike.%${t}%,model.ilike.%${t}%`)),r&&(u=u.eq("brand",r)),u=u.order("price_per_day",{ascending:s==="asc"});const{data:h,error:y}=await u;if(y)throw y;return console.log("Host cars fetched:",h),h}}),w=v||[],S=()=>{n(g=>g==="asc"?"desc":"asc")},E=()=>{console.log("Load more triggered in HostView")},_=async g=>{try{console.log("Starting handover for booking:",g);const{data:u,error:h}=await C.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",g).single();if(h)throw h;if(!u)throw new Error("Booking not found");const y=u.cars.owner_id,j=u.renter_id;await J(g,"pickup",y,j)&&(T.success("Handover process started"),c(`/map?bookingId=${g}&mode=handover&role=host`),p())}catch(u){console.error("Error starting handover:",u),T.error("Failed to start handover process")}};return e.jsxs("div",{className:"space-y-6",children:[m&&e.jsx("div",{className:"space-y-3",children:d.map(g=>e.jsx(re,{prompt:g,onStartHandover:_},g.id))}),e.jsx("div",{className:"flex justify-end",children:e.jsx(R,{variant:s?"secondary":"outline",onClick:S,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(te,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ee,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),e.jsx(Y,{cars:w,isLoading:b,error:M,loadMoreRef:i,onLoadMore:E,isFetchingNextPage:!1,isAuthenticated:!0})]})};var F=new Map,L=new WeakMap,W=0,Se=void 0;function ke(t){return t?(L.has(t)||(W+=1,L.set(t,W.toString())),L.get(t)):"0"}function Ce(t){return Object.keys(t).sort().filter(r=>t[r]!==void 0).map(r=>`${r}_${r==="root"?ke(t.root):t[r]}`).toString()}function Re(t){const r=Ce(t);let a=F.get(r);if(!a){const s=new Map;let n;const i=new IntersectionObserver(c=>{c.forEach(d=>{var m;const p=d.isIntersecting&&n.some(v=>d.intersectionRatio>=v);t.trackVisibility&&typeof d.isVisible>"u"&&(d.isVisible=p),(m=s.get(d.target))==null||m.forEach(v=>{v(p,d)})})},t);n=i.thresholds||(Array.isArray(t.threshold)?t.threshold:[t.threshold||0]),a={id:r,observer:i,elements:s},F.set(r,a)}return a}function _e(t,r,a={},s=Se){if(typeof window.IntersectionObserver>"u"&&s!==void 0){const m=t.getBoundingClientRect();return r(s,{isIntersecting:s,target:t,intersectionRatio:typeof a.threshold=="number"?a.threshold:0,time:0,boundingClientRect:m,intersectionRect:m,rootBounds:m}),()=>{}}const{id:n,observer:i,elements:c}=Re(a),d=c.get(t)||[];return c.has(t)||c.set(t,d),d.push(r),i.observe(t),function(){d.splice(d.indexOf(r),1),d.length===0&&(c.delete(t),i.unobserve(t)),c.size===0&&(i.disconnect(),F.delete(n))}}function Ee({threshold:t,delay:r,trackVisibility:a,rootMargin:s,root:n,triggerOnce:i,skip:c,initialInView:d,fallbackInView:m,onChange:p}={}){var v;const[b,M]=o.useState(null),w=o.useRef(p),[S,E]=o.useState({inView:!!d,entry:void 0});w.current=p,o.useEffect(()=>{if(c||!b)return;let h;return h=_e(b,(y,j)=>{E({inView:y,entry:j}),w.current&&w.current(y,j),j.isIntersecting&&i&&h&&(h(),h=void 0)},{root:n,rootMargin:s,threshold:t,trackVisibility:a,delay:r},m),()=>{h&&h()}},[Array.isArray(t)?t.toString():t,b,n,s,i,c,a,m,r]);const _=(v=S.entry)==null?void 0:v.target,g=o.useRef(void 0);!b&&_&&!i&&!c&&g.current!==_&&(g.current=_,E({inView:!!d,entry:void 0}));const u=[M,S.inView,S.entry];return u.ref=u[0],u.inView=u[1],u.entry=u[2],u}const q=10,Me=async({pageParam:t=0,filters:r,searchParams:a})=>{console.log("Starting car fetch with params:",{pageParam:t,filters:r,searchParams:a});let s=C.from("cars").select("*",{count:"exact"}).eq("is_available",!0);s=s.range(t*q,(t+1)*q-1),a!=null&&a.searchTerm&&(console.log("Applying search term:",a.searchTerm),s=s.or(`brand.ilike.%${a.searchTerm}%,model.ilike.%${a.searchTerm}%`)),a!=null&&a.brand&&(console.log("Filtering by brand:",a.brand),s=s.eq("brand",a.brand)),r!=null&&r.model&&(s=s.ilike("model",`%${r.model}%`)),r!=null&&r.year&&(s=s.eq("year",r.year)),r!=null&&r.minPrice&&(s=s.gte("price_per_day",r.minPrice)),r!=null&&r.maxPrice&&(s=s.lte("price_per_day",r.maxPrice)),r!=null&&r.vehicleType&&(s=s.eq("vehicle_type",r.vehicleType)),r!=null&&r.location&&(s=s.ilike("location",`%${r.location}%`)),(r==null?void 0:r.sortBy)==="price"&&(s=s.order("price_per_day",{ascending:r.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:n,error:i,count:c}=await s;if(i)throw console.error("Error fetching cars:",i),i;const d=(n||[]).filter(m=>m&&m.id&&m.brand&&m.model);return console.log("Valid cars fetched:",d.length,"from",(n==null?void 0:n.length)||0),{data:d,nextPage:d.length===q?t+1:void 0,count:c}},Pe=t=>{if(!t||typeof t!="object")throw new Error("Invalid car object provided to toSafeCar");return{...t,description:t.description??"No description available",features:t.features??[],image_url:t.image_url??"/placeholder-car.jpg",latitude:t.latitude??0,longitude:t.longitude??0,is_available:t.is_available??!0}},Ie=({isVisible:t,onClose:r,autoCloseDelay:a=5e3})=>{const[s,n]=o.useState(Math.ceil(a/1e3));return o.useEffect(()=>{if(!t)return;const i=setTimeout(()=>{r()},a),c=setInterval(()=>{n(d=>d<=1?(clearInterval(c),0):d-1)},1e3);return()=>{clearTimeout(i),clearInterval(c)}},[t,a,r]),o.useEffect(()=>{t&&n(Math.ceil(a/1e3))},[t,a]),t?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsx(X,{className:"w-full max-w-md mx-auto animate-in fade-in-0 zoom-in-95 duration-300",children:e.jsxs(xe,{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ve,{className:"h-8 w-8 text-green-500"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Verification Complete!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Welcome to Mobirides"})]})]}),e.jsx(R,{variant:"ghost",size:"sm",onClick:r,className:"h-8 w-8 p-0 hover:bg-muted",children:e.jsx(he,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your account has been successfully verified! You can now:"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(Q,{className:"h-4 w-4 text-blue-500 flex-shrink-0"}),e.jsx("span",{children:"Browse and book available cars"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(be,{className:"h-4 w-4 text-green-500 flex-shrink-0"}),e.jsx("span",{children:"Enjoy secure and trusted transactions"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx($,{className:"h-4 w-4 text-orange-500 flex-shrink-0"}),e.jsx("span",{children:"Access 24/7 customer support"})]})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Auto-closing in ",s,"s"]}),e.jsx(R,{onClick:r,size:"sm",children:"Start Exploring"})]})})]})]})})}):null},Ae=({searchQuery:t,filters:r,onFiltersChange:a})=>{const[s,n]=o.useState(null),[i,c]=o.useState("asc"),[d,m]=o.useState(!1),{ref:p,inView:v}=Ee(),b=o.useRef(null),M=V(),[w,S]=ie(),{handoverPrompts:E,hasHandoverPrompts:_,refetch:g}=K();o.useEffect(()=>{if(w.get("verification_success")==="true"){m(!0);const x=new URLSearchParams(w);x.delete("verification_success"),S(x,{replace:!0})}},[w,S]);const u=l=>{b.current!==l&&(b.current=l||null),p(l)};o.useEffect(()=>{a({...r,sortOrder:i})},[i,a,r]);const{data:h,isLoading:y,error:j,hasNextPage:I,fetchNextPage:O,isFetchingNextPage:H}=oe({queryKey:["available-cars",s,r,t],queryFn:({pageParam:l=0})=>Me({pageParam:l,filters:r,searchParams:{...s?{brand:s}:{},...t?{searchTerm:t}:{}}}),getNextPageParam:l=>l.nextPage||void 0,initialPageParam:0}),{data:z}=Z({queryKey:["saved-car-ids"],queryFn:async()=>{var N;console.log("Fetching saved car IDs for home page");const{data:{session:l}}=await C.auth.getSession();if(!((N=l==null?void 0:l.user)!=null&&N.id))return new Set;const{data:x,error:k}=await C.from("saved_cars").select("car_id").eq("user_id",l.user.id);if(k)return console.error("Error fetching saved cars:",k),new Set;const f=new Set(x.map(P=>P.car_id));return console.log("Saved car IDs for home page:",Array.from(f)),f}}),D=o.useMemo(()=>z||new Set,[z]),[se,U]=o.useState([]),A=o.useMemo(()=>(h==null?void 0:h.pages.flatMap(l=>l.data.filter(x=>x&&typeof x=="object"&&x.id).map(x=>({...Pe(x),isSaved:D.has(x.id)}))))||[],[h==null?void 0:h.pages,D]);o.useEffect(()=>{(async()=>{if(A.length===0){U([]);return}console.log(`[RenterView] Fetching ratings for ${A.length} cars`);const x=A.map(async f=>{try{const{data:N,error:P}=await C.rpc("calculate_car_rating",{car_uuid:f.id});return P?(console.error(`[RenterView] Error fetching rating for car ${f.id}:`,P),{...f,rating:0}):(console.log(`[RenterView] Car ${f.brand} ${f.model} (${f.id}) rating:`,N),{...f,rating:N||0})}catch(N){return console.error(`[RenterView] Exception fetching rating for car ${f.id}:`,N),{...f,rating:0}}}),k=await Promise.all(x);console.log("[RenterView] Final cars with ratings:",k.map(f=>({id:f.id,brand:f.brand,model:f.model,rating:f.rating}))),U(k)})()},[A,h]),o.useEffect(()=>{v&&I&&!H&&O()},[v,I,H,O]);const ae=()=>{c(l=>l==="asc"?"desc":"asc")},ne=async l=>{try{console.log("Starting handover for booking:",l);const{data:x,error:k}=await C.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",l).single();if(k)throw k;if(!x)throw new Error("Booking not found");const f=x.cars.owner_id,N=x.renter_id;await J(l,"pickup",f,N)&&(T.success("Handover process started"),M(`/map?bookingId=${l}&mode=handover&role=renter`),g())}catch(x){console.error("Error starting handover:",x),T.error("Failed to start handover process")}};return e.jsxs("div",{className:"space-y-6",children:[_&&e.jsx("div",{className:"space-y-3",children:E.map(l=>e.jsx(re,{prompt:l,onStartHandover:ne},l.id))}),e.jsx("div",{className:"flex justify-end",children:e.jsx(R,{variant:i?"secondary":"outline",onClick:ae,className:`flex items-center gap-2 transition-colors ${i?"bg-accent text-accent-foreground":""}`,children:i==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(te,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ee,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),e.jsx(Y,{cars:se,isLoading:y,error:j,loadMoreRef:b,isFetchingNextPage:H,isAuthenticated:!0}),I&&e.jsx("div",{ref:u,className:"h-10 w-full opacity-0",children:"Load more trigger"}),e.jsx(Ie,{isVisible:d,onClose:()=>m(!1),autoCloseDelay:5e3})]})},mt=()=>{const[t,r]=o.useState(""),[a,s]=o.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),n=G(),{isAuthenticated:i,userRole:c,isLoadingRole:d}=le(),m=o.useCallback(p=>{s(p)},[]);return o.useEffect(()=>{},[n.search]),e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx(ce,{searchQuery:t,onSearchChange:r,onFiltersChange:s}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:d?e.jsx(ge,{}):i?c==="host"?e.jsx(Ne,{searchQuery:t}):e.jsx(Ae,{searchQuery:t,filters:a,onFiltersChange:m}):e.jsx(ye,{})}),e.jsx(de,{})]})};export{mt as default};
