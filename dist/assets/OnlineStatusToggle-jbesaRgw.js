import{S as H,r as g,W as F,U as z,j as s,Z as O,V as B,_ as J,b as I,s as b,J as x,g as E}from"./index-B1v-fdDy.js";import{u as V,S as W,a as Y,b as $,c as K,d as j}from"./select-DXEtncUe.js";var k="Switch",[X,ye]=H(k),[Z,Q]=X(k),U=g.forwardRef((e,t)=>{const{__scopeSwitch:o,name:r,checked:n,defaultChecked:l,required:f,disabled:a,value:i="on",onCheckedChange:c,form:d,...h}=e,[u,p]=g.useState(null),w=F(t,C=>p(C)),v=g.useRef(!1),_=u?d||!!u.closest("form"):!0,[S=!1,M]=z({prop:n,defaultProp:l,onChange:c});return s.jsxs(Z,{scope:o,checked:S,disabled:a,children:[s.jsx(O.button,{type:"button",role:"switch","aria-checked":S,"aria-required":f,"data-state":T(S),"data-disabled":a?"":void 0,disabled:a,value:i,...h,ref:w,onClick:B(e.onClick,C=>{M(G=>!G),_&&(v.current=C.isPropagationStopped(),v.current||C.stopPropagation())})}),_&&s.jsx(ee,{control:u,bubbles:!v.current,name:r,value:i,checked:S,required:f,disabled:a,form:d,style:{transform:"translateX(-100%)"}})]})});U.displayName=k;var D="SwitchThumb",R=g.forwardRef((e,t)=>{const{__scopeSwitch:o,...r}=e,n=Q(D,o);return s.jsx(O.span,{"data-state":T(n.checked),"data-disabled":n.disabled?"":void 0,...r,ref:t})});R.displayName=D;var ee=e=>{const{control:t,checked:o,bubbles:r=!0,...n}=e,l=g.useRef(null),f=V(o),a=J(t);return g.useEffect(()=>{const i=l.current,c=window.HTMLInputElement.prototype,h=Object.getOwnPropertyDescriptor(c,"checked").set;if(f!==o&&h){const u=new Event("click",{bubbles:r});h.call(i,o),i.dispatchEvent(u)}},[f,o,r]),s.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:o,...n,tabIndex:-1,ref:l,style:{...e.style,...a,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})};function T(e){return e?"checked":"unchecked"}var q=U,te=R;const L=g.forwardRef(({className:e,...t},o)=>s.jsx(q,{className:I("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",e),...t,ref:o,children:s.jsx(te,{className:I("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));L.displayName=q.displayName;const N=e=>e&&"is_sharing_location"in e&&"location_sharing_scope"in e,oe=(e,t)=>{const o={is_sharing_location:e,updated_at:new Date().toISOString()};return t&&(o.latitude=t.latitude,o.longitude=t.longitude),o},se=()=>{const[e,t]=g.useState(null),[o,r]=g.useState(!1),[n,l]=g.useState("all"),[f,a]=g.useState(!0),[i,c]=g.useState(null);g.useEffect(()=>{console.log("useLocationSharing: Initializing hook"),(async()=>{const{data:{session:p}}=await b.auth.getSession();if(!p){console.log("No active session found"),t(null),a(!1);return}console.log("Active session found, user ID:",p.user.id),t(p.user.id),d(p.user.id)})();const{data:{subscription:u}}=b.auth.onAuthStateChange((p,w)=>{console.log("Location sharing auth state changed:",p),p==="SIGNED_IN"&&w?(console.log("User signed in, fetching location status"),t(w.user.id),d(w.user.id)):p==="SIGNED_OUT"&&(console.log("User signed out, resetting location sharing state"),t(null),r(!1),l("all"),a(!1))});return()=>{console.log("useLocationSharing: Cleaning up subscription"),u.unsubscribe()}},[]);const d=async h=>{if(!h){console.log("No user ID provided to fetchUserStatus"),a(!1);return}try{console.log("Fetching user profile for location status..."),a(!0),c(null);const{data:u,error:p}=await b.from("profiles").select("is_sharing_location, location_sharing_scope, latitude, longitude").limit(1);if(p){console.error("Error checking for columns:",p),c("Could not verify location columns"),a(!1);return}if(!(u&&u.length>0&&"is_sharing_location"in u[0]&&"location_sharing_scope"in u[0])){console.error("Required location columns don't exist in the profiles table"),c("Location sharing is not supported"),a(!1);return}const{data:v,error:_}=await b.from("profiles").select("*").eq("id",h).single();if(_){console.error("Error fetching profile:",_),c("Could not fetch profile"),a(!1);return}console.log("Profile data received:",v);const S=v;N(S)?(console.log("Location fields exist, setting state based on profile:",{is_sharing_location:S.is_sharing_location,location_sharing_scope:S.location_sharing_scope}),r(S.is_sharing_location??!1),l(S.location_sharing_scope??"all"),c(null)):(console.warn("Location sharing fields may not exist in profiles table"),c("Location sharing fields not available"),r(!1),l("all"))}catch(u){console.error("Error fetching user status:",u),x.error("Could not load location sharing status")}finally{a(!1)}};return{userId:e,isSharingLocation:o,sharingScope:n,isLoading:f,errorMessage:i,setIsSharingLocation:r,fetchUserStatus:e?()=>d(e):null}},re=async({userId:e,lat:t,long:o})=>{try{return navigator.geolocation?new Promise(r=>{(async()=>{try{console.log("Got coordinates:",t,o);const n=oe(!0,{latitude:t,longitude:o}),{error:l}=await b.from("profiles").update(n).eq("id",e);if(l){console.error("Error updating location:",l),x.error("Could not update your location in the database"),r(!1);return}console.log("Location coordinates updated successfully"),x.success("Location updated successfully"),r(!0)}catch(n){console.error("Error updating location:",n),x.error("Could not update your location"),r(!1)}})()}):(console.error("Geolocation not supported"),x.error("Your browser doesn't support geolocation"),!1)}catch(r){return console.error("Error in updateUserLocation:",r),x.error("An unexpected error occurred while updating your location"),!1}};var P=Object.defineProperty,ne=Object.getOwnPropertyDescriptor,ae=Object.getOwnPropertyNames,ie=Object.prototype.hasOwnProperty,ce=(e,t)=>{for(var o in t)P(e,o,{get:t[o],enumerable:!0})},le=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ae(t))!ie.call(e,n)&&n!==o&&P(e,n,{get:()=>t[n],enumerable:!(r=ne(t,n))||r.enumerable});return e},ue=e=>le(P({},"__esModule",{value:!0}),e),de=(e,t,o)=>new Promise((r,n)=>{var l=i=>{try{a(o.next(i))}catch(c){n(c)}},f=i=>{try{a(o.throw(i))}catch(c){n(c)}},a=i=>i.done?r(i.value):Promise.resolve(i.value).then(l,f);a((o=o.apply(e,t)).next())}),A={};ce(A,{SessionContextProvider:()=>pe,useSession:()=>me,useSessionContext:()=>ge,useSupabaseClient:()=>xe,useUser:()=>Se});var he=ue(A),m=g,fe=s,y=(0,m.createContext)({isLoading:!0,session:null,error:null,supabaseClient:{}}),pe=({supabaseClient:e,initialSession:t=null,children:o})=>{const[r,n]=(0,m.useState)(t),[l,f]=(0,m.useState)(!t),[a,i]=(0,m.useState)();(0,m.useEffect)(()=>{!r&&t&&n(t)},[r,t]),(0,m.useEffect)(()=>{let d=!0;function h(){return de(this,null,function*(){const{data:{session:u},error:p}=yield e.auth.getSession();if(d){if(p){i(p),f(!1);return}n(u),f(!1)}})}return h(),()=>{d=!1}},[]),(0,m.useEffect)(()=>{const{data:{subscription:d}}=e.auth.onAuthStateChange((h,u)=>{u&&(h==="SIGNED_IN"||h==="TOKEN_REFRESHED"||h==="USER_UPDATED")&&n(u),h==="SIGNED_OUT"&&n(null)});return()=>{d.unsubscribe()}},[]);const c=(0,m.useMemo)(()=>l?{isLoading:!0,session:null,error:null,supabaseClient:e}:a?{isLoading:!1,session:null,error:a,supabaseClient:e}:{isLoading:!1,session:r,error:null,supabaseClient:e},[l,r,a]);return(0,fe.jsx)(y.Provider,{value:c,children:o})},ge=()=>{const e=(0,m.useContext)(y);if(e===void 0)throw new Error("useSessionContext must be used within a SessionContextProvider.");return e};function xe(){const e=(0,m.useContext)(y);if(e===void 0)throw new Error("useSupabaseClient must be used within a SessionContextProvider.");return e.supabaseClient}var me=()=>{const e=(0,m.useContext)(y);if(e===void 0)throw new Error("useSession must be used within a SessionContextProvider.");return e.session},Se=()=>{var e,t;const o=(0,m.useContext)(y);if(o===void 0)throw new Error("useUser must be used within a SessionContextProvider.");return(t=(e=o.session)==null?void 0:e.user)!=null?t:null};const be=({initialScope:e,isLoading:t,disabled:o=!1})=>{const[r,n]=g.useState(e),l=he.useUser(),f=async a=>{if(l)try{const{data:i}=await b.from("profiles").select("*").limit(1);if(!N(i==null?void 0:i[0])){x.error("Location sharing scope is not supported in this database");return}const{error:c}=await b.from("profiles").update({location_sharing_scope:a,updated_at:new Date().toISOString()}).eq("id",l.id);if(c)throw c;n(a),x.success(`Location sharing scope set to ${a}`)}catch(i){console.error("Error updating sharing scope:",i),x.error("Could not update sharing scope")}};return s.jsxs("div",{className:"flex items-center gap-1.5",children:[s.jsx(E,{className:"text-xs text-muted-foreground whitespace-nowrap",children:"To:"}),s.jsxs(W,{value:r,onValueChange:f,disabled:t||o,children:[s.jsx(Y,{className:"h-7 w-[100px] text-xs",children:s.jsx($,{placeholder:"Who can see you"})}),s.jsxs(K,{children:[s.jsx(j,{value:"all",children:"Everyone"}),s.jsx(j,{value:"hosts",children:"Hosts Only"}),s.jsx(j,{value:"renters",children:"Renters Only"}),s.jsx(j,{value:"none",children:"No One"})]})]})]})},we=({errorMessage:e})=>e?s.jsx("span",{className:"ml-2 text-xs text-red-500",children:e}):null,Ce=({lat:e,long:t})=>{const{userId:o,isSharingLocation:r,sharingScope:n,isLoading:l,errorMessage:f,setIsSharingLocation:a}=se(),i=async c=>{if(!o){x.error("You need to be logged in to share your location");return}try{console.log("Attempting to toggle location sharing to:",c);const{data:d,error:h}=await b.from("profiles").select("is_sharing_location, location_sharing_scope").limit(1);if(h)throw console.error("Error checking columns:",h),x.error("Could not verify table structure"),h;if(console.log("Column check result:",d),!d||!d[0]||!N(d[0])){console.error("Location fields not found in database"),x.error("Location sharing is not supported in this database");return}const{error:u}=await b.from("profiles").update({is_sharing_location:c,updated_at:new Date().toISOString()}).eq("id",o);if(u)throw console.error("Error updating location sharing:",u),u;a(c),x.success(c?"Location sharing enabled":"Location sharing disabled"),c&&await re({userId:o,lat:e,long:t})}catch(d){console.error("Error toggling location sharing:",d),x.error("Could not update location sharing status")}};return l||e===0||t===0?s.jsxs("div",{className:"flex items-center space-x-2 opacity-50",children:[s.jsx(L,{disabled:!0}),s.jsx(E,{className:"text-sm whitespace-nowrap",children:"Share Location"}),s.jsx("span",{className:"text-xs text-muted-foreground",children:"(Loading...)"})]}):o?s.jsxs("div",{className:"flex flex-row items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{checked:r,onCheckedChange:i,disabled:l||!!f,className:"data-[state=checked]:bg-primary"}),s.jsxs(E,{className:"text-sm whitespace-nowrap font-medium",children:["Share Location",s.jsx(we,{errorMessage:f})]})]}),r&&s.jsx(be,{initialScope:n,isLoading:l})]}):s.jsx("div",{className:"flex flex-row items-center justify-between w-full gap-2",children:s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(L,{checked:!1,disabled:!0,className:"data-[state=checked]:bg-primary/50"}),s.jsxs(E,{className:"text-sm whitespace-nowrap font-medium",children:["Share Location",s.jsx("span",{className:"ml-2 text-xs text-amber-500",children:"Login required"})]})]})})};export{Ce as O,L as S,he as d};
