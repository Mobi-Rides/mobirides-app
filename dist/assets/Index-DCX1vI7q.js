import{Q as me,i as U,h as xe,a as ge,u as pe,c as I,r as l,j as e,O as ee,b as D,C as te,d as fe,X as ye,T as ae,D as se,P as ve,e as be,R as je,f as we,J as z,L as Ne,g as M,I as E,B as C,k as T,l as $,m as ke,n as _,s as P,A as re,o as Se}from"./index-B1v-fdDy.js";import{C as Pe}from"./calendar-Blx7UGIQ.js";import{P as Ce,a as Ae,b as Fe}from"./popover-4EB8yVS7.js";import{S as H,a as G,b as K,c as W,d as V}from"./select-DXEtncUe.js";import{S as Le}from"./scroll-area-DG1WSctR.js";import{L as Re}from"./savedCarService-CH1V1nh4.js";import{C as Me}from"./calendar-D-otnCnk.js";import{A as Ie}from"./arrow-up-down-DHkmFeax.js";import{f as Z}from"./format-BOBWS5Wu.js";import{A as Q,a as Ee,b as J}from"./avatar-BcfxHyyU.js";import{B as oe}from"./badge-CMWgFMV2.js";import{u as Oe}from"./useVerificationStatus-BsTQxagy.js";import{C as X}from"./clock-CASyaKu3.js";import{C as _e}from"./circle-check-big-BC5npB6H.js";import{C as De}from"./circle-alert-B4G_r9SV.js";import{S as Ve}from"./shield-BbSxX3Ts.js";import{P as qe}from"./plus-CDk_XeRs.js";import{S as Be,N as Te}from"./Navigation-B7IoAuwX.js";import{u as $e}from"./useAuthStatus-GZxO7TWd.js";import{C as ne}from"./CarGrid-Bwj_3Ehp.js";import"./addDays-Di48Ycau.js";import"./chevron-right-CgiltgM9.js";import"./index-BdQq_4o_.js";import"./check-BnE2eJB3.js";import"./VerificationRequiredDialog-BhXpjI7V.js";import"./file-text-25BybcTk.js";import"./camera-BVx23dB2.js";import"./phone-C1RE3XPx.js";import"./arrow-right-wlC4lylp.js";import"./CustomMapbox-B-n_RDKf.js";import"./arrow-left-C5bMyyle.js";import"./send-BDkAZ2Oi.js";import"./OnlineStatusToggle-jbesaRgw.js";import"./skeleton-B5zSXtNC.js";import"./user-ClMVbWgE.js";import"./star-C2MEvl-w.js";import"./card-BByP0N-G.js";import"./separator-BMDiheLN.js";import"./users-BmNgVsFF.js";var Ue=class extends me{constructor(a,t){super(a,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(a,t){super.setOptions({...a,behavior:U()},t)}getOptimisticResult(a){return a.behavior=U(),super.getOptimisticResult(a)}fetchNextPage(a){return this.fetch({...a,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(a){return this.fetch({...a,meta:{fetchMore:{direction:"backward"}}})}createResult(a,t){var f,v;const{state:o}=a,s=super.createResult(a,t),{isFetching:i,isRefetching:n,isError:r,isRefetchError:c}=s,h=(v=(f=o.fetchMeta)==null?void 0:f.fetchMore)==null?void 0:v.direction,d=r&&h==="forward",x=i&&h==="forward",g=r&&h==="backward",p=i&&h==="backward";return{...s,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:xe(t,o.data),hasPreviousPage:ge(t,o.data),isFetchNextPageError:d,isFetchingNextPage:x,isFetchPreviousPageError:g,isFetchingPreviousPage:p,isRefetchError:c&&!d&&!g,isRefetching:n&&!x&&!p}}};function ze(a,t){return pe(a,Ue)}/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=I("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=I("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=I("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=I("Navigation",[["polygon",{points:"3 11 22 2 13 21 11 13 3 11",key:"1ltx0t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=I("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),We=je,Ze=we,Qe=ve,le=l.forwardRef(({className:a,...t},o)=>e.jsx(ee,{className:D("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",a),...t,ref:o}));le.displayName=ee.displayName;const Je=be("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),de=l.forwardRef(({side:a="right",className:t,children:o,...s},i)=>e.jsxs(Qe,{children:[e.jsx(le,{}),e.jsxs(te,{ref:i,className:D(Je({side:a}),t),...s,children:[o,e.jsxs(fe,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary",children:[e.jsx(ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));de.displayName=te.displayName;const Xe=l.forwardRef(({className:a,...t},o)=>e.jsx(ae,{ref:o,className:D("text-lg font-semibold text-foreground",a),...t}));Xe.displayName=ae.displayName;const Ye=l.forwardRef(({className:a,...t},o)=>e.jsx(se,{ref:o,className:D("text-sm text-muted-foreground",a),...t}));Ye.displayName=se.displayName;const et=({onFiltersChange:a})=>{const[t,o]=l.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",locationCoordinates:void 0,sortBy:"distance",sortOrder:"asc",model:void 0,year:void 0,minPrice:void 0,maxPrice:void 0,searchQuery:""}),s=(r,c)=>{console.log(`Updating filter ${r} with value:`,c),o(h=>({...h,[r]:c}))},i=l.useCallback(r=>{o(c=>({...c,location:r.name,locationCoordinates:r.coordinates})),console.log("Location selected:",r)},[]),n=l.useCallback(()=>{if(console.log("Applying filters:",t),t.minPrice&&t.maxPrice&&t.minPrice>t.maxPrice){z.error("Minimum price cannot be greater than maximum price");return}a(t),z.success("Filters applied successfully")},[t,a]);return e.jsx(Ne,{children:e.jsxs("div",{className:"w-full rounded-lg border bg-card shadow-sm my-5 relative",children:[e.jsx("div",{className:"absolute top-0 left-0 right-0 h-6 bg-gradient-to-b from-background to-transparent z-10"}),e.jsx(Le,{className:"h-[calc(100vh-200px)]",children:e.jsxs("div",{className:"flex flex-col gap-4 p-4",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"model",children:"Model"}),e.jsx(E,{id:"model",placeholder:"Search by model...",value:t.model||"",onChange:r=>s("model",r.target.value)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"year",children:"Year"}),e.jsx(E,{id:"year",type:"number",placeholder:"Search by year...",value:t.year||"",onChange:r=>s("year",r.target.value?parseInt(r.target.value):void 0)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"minPrice",children:"Min Price (BWP)"}),e.jsx(E,{id:"minPrice",type:"number",placeholder:"Min price...",value:t.minPrice||"",onChange:r=>s("minPrice",r.target.value?parseInt(r.target.value):void 0)})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"maxPrice",children:"Max Price (BWP)"}),e.jsx(E,{id:"maxPrice",type:"number",placeholder:"Max price...",value:t.maxPrice||"",onChange:r=>s("maxPrice",r.target.value?parseInt(r.target.value):void 0)})]})]})]}),e.jsxs(Ce,{children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(C,{variant:"outline",className:"w-full",children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),t.startDate&&t.endDate?`${Z(t.startDate,"PP")} - ${Z(t.endDate,"PP")}`:"Select dates"]})}),e.jsx(Fe,{className:"w-auto p-0",align:"start",children:e.jsx(Pe,{mode:"range",selected:{from:t.startDate,to:t.endDate},onSelect:r=>{s("startDate",r==null?void 0:r.from),s("endDate",r==null?void 0:r.to)},numberOfMonths:2})})]}),e.jsxs(H,{value:t.vehicleType,onValueChange:r=>s("vehicleType",r),children:[e.jsx(G,{children:e.jsx(K,{placeholder:"Vehicle type"})}),e.jsx(W,{children:["Basic","Standard","Executive","4x4","SUV","Electric","Exotic"].map(r=>e.jsx(V,{value:r,children:r},r))})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"location",children:"Pickup Location"}),e.jsx(Re,{placeholder:"Search for pickup location...",onLocationSelect:i,value:t.location,className:"w-full"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(H,{value:t.sortBy,onValueChange:r=>s("sortBy",r),children:[e.jsx(G,{className:"flex-1",children:e.jsx(K,{placeholder:"Sort by"})}),e.jsxs(W,{children:[e.jsx(V,{value:"distance",children:"Distance"}),e.jsx(V,{value:"price",children:"Price"})]})]}),e.jsx(C,{variant:"ghost",size:"icon",onClick:()=>s("sortOrder",t.sortOrder==="asc"?"desc":"asc"),children:e.jsx(Ie,{className:`h-4 w-4 ${t.sortOrder==="desc"?"rotate-180":""}`})})]}),e.jsx(C,{className:"w-full mt-2",onClick:n,children:"Apply Filters"})]})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-b from-transparent to-background z-10"})]})})},tt=({showText:a=!0,variant:t="badge",size:o="md"})=>{const{isVerified:s,isLoading:i,verificationData:n}=Oe(),r=T(),c=()=>{r("/verification")},d=i?{icon:e.jsx(X,{className:"h-3 w-3"}),text:"Checking...",variant:"outline",clickable:!1}:s?{icon:e.jsx(_e,{className:"h-3 w-3"}),text:"Verified",variant:"secondary",className:"bg-green-100 text-green-700 border-green-200",clickable:!1}:n&&n.overall_status==="pending_review"?{icon:e.jsx(X,{className:"h-3 w-3"}),text:"Under Review",variant:"secondary",className:"bg-blue-100 text-blue-700 border-blue-200",clickable:!0}:n&&n.current_step?{icon:e.jsx(De,{className:"h-3 w-3"}),text:"In Progress",variant:"secondary",className:"bg-orange-100 text-orange-700 border-orange-200",clickable:!0}:{icon:e.jsx(Ve,{className:"h-3 w-3"}),text:"Not Verified",variant:"outline",className:"border-orange-300 text-orange-600 hover:bg-orange-50",clickable:!0};return t==="button"&&d.clickable?e.jsxs(C,{variant:"outline",size:o==="md"?"default":o,onClick:c,className:`flex items-center space-x-2 ${d.className||""}`,children:[d.icon,a&&e.jsx("span",{children:d.text})]}):e.jsxs(oe,{variant:d.variant,className:`flex items-center space-x-1 cursor-pointer ${d.className||""}`,onClick:d.clickable?c:void 0,children:[d.icon,a&&e.jsx("span",{children:d.text})]})},at=({searchQuery:a,onSearchChange:t,onFiltersChange:o})=>{const s=T(),i=$(),{user:n}=ke(),[r,c]=l.useState(!1),[h,d]=l.useState("signin"),[x,g]=l.useState({city:"Gaborone",country:"Botswana",loading:!0,error:null});l.useEffect(()=>{const y=async()=>{try{const b=await navigator.permissions.query({name:"geolocation"});b.state==="granted"?await u():b.state==="denied"?await A():await A()}catch{try{await u()}catch{await A()}}},u=async()=>{var b,k;try{const S=await new Promise((ue,he)=>{navigator.geolocation.getCurrentPosition(ue,he,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),L=await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${S.coords.latitude}+${S.coords.longitude}&key=4382106d8cc34d2e9c95f4dc83f23736`);if(!L.ok)throw new Error("Failed to fetch location data");const R=(k=(b=(await L.json()).results)==null?void 0:b[0])==null?void 0:k.components;R&&g({city:R.city||R.town||R.state||R.county||"Unknown",country:R.country||"Unknown",loading:!1,error:null})}catch(S){console.error("Location error:",S),g(L=>({...L,loading:!1,error:S instanceof Error?S.message:"Failed to get location"}))}},A=async()=>{try{const b=await fetch("https://ipapi.co/json/");if(!b.ok)throw new Error("Failed to fetch location data");const k=await b.json();g({city:k.city||"Gaborone",country:k.country_name||"Botswana",loading:!1,error:null})}catch(b){console.error("IP Location error:",b),g(k=>({...k,loading:!1,error:null,city:"Gaborone",country:"Botswana"}))}};y()},[]);const{data:p}=_({queryKey:["profile"],queryFn:async()=>{if(!n)return null;const{data:y}=await P.from("profiles").select("avatar_url, full_name").eq("id",n.id).single();return y},enabled:!!n}),{data:m}=_({queryKey:["notification-count"],queryFn:async()=>{if(!n)return{messages:0,notifications:0};const[y,u]=await Promise.all([P.from("messages").select("id",{count:"exact"}).eq("receiver_id",n.id).eq("status","sent"),P.from("notifications").select("id",{count:"exact"}).eq("user_id",n.id).eq("is_read",!1)]);return{messages:y.count||0,notifications:u.count||0}},refetchInterval:3e4,enabled:!!n}),f=((m==null?void 0:m.messages)||0)+((m==null?void 0:m.notifications)||0),v=p!=null&&p.avatar_url?P.storage.from("avatars").getPublicUrl(p.avatar_url).data.publicUrl:null,j=y=>{console.log("Filters changed:",y),o({...y,searchQuery:a})},F=()=>{n?s("/profile"):(d("signin"),c(!0),s(`${i.pathname}?auth=signin`,{replace:!0}))},w=()=>{c(!1),s(i.pathname,{replace:!0})};l.useEffect(()=>{const u=new URLSearchParams(i.search).get("auth");(u==="signin"||u==="signup")&&(d(u),c(!0))},[i.search]);const N=x.loading?"Loading location...":x.error?"Gaborone, Botswana":`${x.city}, ${x.country}`;return e.jsxs("header",{className:"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-900 sticky top-0 z-10 shadow-sm p-6 md:p-8 rounded-b-3xl",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 mb-4",children:[e.jsx("img",{src:"/lovable-uploads/a065be26-80b7-4e50-b683-b6afb0add925.png",alt:"Mobirides Logo",className:"h-14 w-14 cursor-pointer",onClick:()=>s("/")}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-center",children:[e.jsx(Ge,{className:"text-white h-4 w-4 flex-shrink-0"}),e.jsx("h3",{className:"text-xs md:text-sm lg:text-base font-normal text-gray-500 dark:text-white truncate",children:N})]})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl  md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2",onClick:()=>s("/add-car"),children:[e.jsx(qe,{className:"h-4 w-4 text-[#581CFA] dark:text-white"}),e.jsx("span",{className:"hidden md:inline-block",children:e.jsx("p",{className:"text-[#581CFA] dark:text-white text-xs md:text-sm lg:text-base font-semibold",children:"Add A Car"})})]}),n&&e.jsx("div",{className:"hidden sm:block",children:e.jsx(tt,{variant:"button",size:"sm"})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{className:"rounded-full bg-gray-100 flex items-center justify-center",onClick:F,children:v&&n?e.jsxs(Q,{className:"h-10 w-10",children:[e.jsx(Ee,{src:v,alt:"Profile"}),e.jsx(J,{children:"ðŸ‘¤"})]}):e.jsx(Q,{className:"h-10 w-10",children:e.jsx(J,{children:"ðŸ‘¤"})})}),f>0&&n&&e.jsx(oe,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:f})]})]})]}),e.jsxs("div",{className:"flex gap-2 mt-8",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Be,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-[#581CFA] h-4 w-4 md:h-5 md:w-5  lg:h-6 lg:w-6"}),e.jsx("input",{type:"text",placeholder:"Search cars...",value:a,onChange:y=>t(y.target.value),className:"w-full h-12 md:h-14 pl-10 pr-4 py-2 rounded-2xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:border-primary dark:focus:border-primary text-xs md:text-sm lg:text-base placeholder:text-xs md:placeholder:text-sm lg:placeholder:text-base dark:placeholder:text-gray-400"})]}),e.jsxs(We,{children:[e.jsx(Ze,{asChild:!0,children:e.jsx(C,{variant:"outline",size:"icon",className:"rounded-2xl w-12 md:w-14 h-12 md:h-14 flex items-center justify-center",children:e.jsx(Ke,{className:"h-4 w-4"})})}),e.jsx(de,{children:e.jsx(et,{onFiltersChange:j})})]})]}),e.jsx(re,{isOpen:r,onClose:w,defaultTab:h})]})},st=()=>{const[a,t]=l.useState(!1),[o,s]=l.useState("signin"),i=T(),n=l.useCallback(()=>{s("signin"),t(!0),i("/?auth=signin",{replace:!0})},[i]),r=l.useCallback(()=>{s("signup"),t(!0),i("/?auth=signup",{replace:!0})},[i]),c=l.useCallback(()=>{t(!1),i("/",{replace:!0})},[i]);return{isOpen:a,defaultTab:o,openSignIn:n,openSignUp:r,close:c,setIsOpen:t}},rt=()=>{const{isOpen:a,defaultTab:t,openSignIn:o,close:s}=st(),i=$();return l.useEffect(()=>{const r=new URLSearchParams(i.search).get("auth");(r==="signin"||r==="signup")&&r==="signin"&&o()},[i.search,o]),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[e.jsxs("div",{className:"p-8 rounded-lg",children:[e.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),e.jsxs(C,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:o,children:[e.jsx(He,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"hidden md:inline-block",children:e.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),e.jsx(re,{isOpen:a,onClose:s,defaultTab:t})]})},ot=({searchQuery:a})=>{const[t,o]=l.useState(null),[s,i]=l.useState("asc"),n=l.useRef(null),{data:r,isLoading:c,error:h}=_({queryKey:["host-cars",a,s,t],queryFn:async()=>{var j;console.log("Fetching host cars with search:",a,"brand:",t);const{data:{session:p}}=await P.auth.getSession();if(!((j=p==null?void 0:p.user)!=null&&j.id))return[];let m=P.from("cars").select("*").eq("owner_id",p.user.id);a&&(m=m.or(`brand.ilike.%${a}%,model.ilike.%${a}%`)),t&&(m=m.eq("brand",t)),m=m.order("price_per_day",{ascending:s==="asc"});const{data:f,error:v}=await m;if(v)throw v;return console.log("Host cars fetched:",f),f}}),d=r||[],x=()=>{i(p=>p==="asc"?"desc":"asc")},g=()=>{console.log("Load more triggered in HostView")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(C,{variant:s?"secondary":"outline",onClick:x,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(ce,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ie,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),e.jsx(ne,{cars:d,isLoading:c,error:h,loadMoreRef:n,onLoadMore:g,isFetchingNextPage:!1,isAuthenticated:!0})]})};var B=new Map,O=new WeakMap,Y=0,nt=void 0;function it(a){return a?(O.has(a)||(Y+=1,O.set(a,Y.toString())),O.get(a)):"0"}function ct(a){return Object.keys(a).sort().filter(t=>a[t]!==void 0).map(t=>`${t}_${t==="root"?it(a.root):a[t]}`).toString()}function lt(a){const t=ct(a);let o=B.get(t);if(!o){const s=new Map;let i;const n=new IntersectionObserver(r=>{r.forEach(c=>{var h;const d=c.isIntersecting&&i.some(x=>c.intersectionRatio>=x);a.trackVisibility&&typeof c.isVisible>"u"&&(c.isVisible=d),(h=s.get(c.target))==null||h.forEach(x=>{x(d,c)})})},a);i=n.thresholds||(Array.isArray(a.threshold)?a.threshold:[a.threshold||0]),o={id:t,observer:n,elements:s},B.set(t,o)}return o}function dt(a,t,o={},s=nt){if(typeof window.IntersectionObserver>"u"&&s!==void 0){const h=a.getBoundingClientRect();return t(s,{isIntersecting:s,target:a,intersectionRatio:typeof o.threshold=="number"?o.threshold:0,time:0,boundingClientRect:h,intersectionRect:h,rootBounds:h}),()=>{}}const{id:i,observer:n,elements:r}=lt(o),c=r.get(a)||[];return r.has(a)||r.set(a,c),c.push(t),n.observe(a),function(){c.splice(c.indexOf(t),1),c.length===0&&(r.delete(a),n.unobserve(a)),r.size===0&&(n.disconnect(),B.delete(i))}}function ut({threshold:a,delay:t,trackVisibility:o,rootMargin:s,root:i,triggerOnce:n,skip:r,initialInView:c,fallbackInView:h,onChange:d}={}){var x;const[g,p]=l.useState(null),m=l.useRef(d),[f,v]=l.useState({inView:!!c,entry:void 0});m.current=d,l.useEffect(()=>{if(r||!g)return;let N;return N=dt(g,(y,u)=>{v({inView:y,entry:u}),m.current&&m.current(y,u),u.isIntersecting&&n&&N&&(N(),N=void 0)},{root:i,rootMargin:s,threshold:a,trackVisibility:o,delay:t},h),()=>{N&&N()}},[Array.isArray(a)?a.toString():a,g,i,s,n,r,o,h,t]);const j=(x=f.entry)==null?void 0:x.target,F=l.useRef(void 0);!g&&j&&!n&&!r&&F.current!==j&&(F.current=j,v({inView:!!c,entry:void 0}));const w=[p,f.inView,f.entry];return w.ref=w[0],w.inView=w[1],w.entry=w[2],w}const q=10,ht=async({pageParam:a=0,filters:t,searchParams:o})=>{console.log("Starting car fetch with params:",{pageParam:a,filters:t,searchParams:o});let s=P.from("cars").select("*",{count:"exact"});s=s.range(a*q,(a+1)*q-1),o!=null&&o.searchTerm&&(console.log("Applying search term:",o.searchTerm),s=s.or(`brand.ilike.%${o.searchTerm}%,model.ilike.%${o.searchTerm}%`)),o!=null&&o.brand&&(console.log("Filtering by brand:",o.brand),s=s.eq("brand",o.brand)),t!=null&&t.model&&(s=s.ilike("model",`%${t.model}%`)),t!=null&&t.year&&(s=s.eq("year",t.year)),t!=null&&t.minPrice&&(s=s.gte("price_per_day",t.minPrice)),t!=null&&t.maxPrice&&(s=s.lte("price_per_day",t.maxPrice)),t!=null&&t.vehicleType&&(s=s.eq("vehicle_type",t.vehicleType)),t!=null&&t.location&&(s=s.ilike("location",`%${t.location}%`)),(t==null?void 0:t.sortBy)==="price"&&(s=s.order("price_per_day",{ascending:t.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:i,error:n,count:r}=await s;if(n)throw console.error("Error fetching cars:",n),n;return console.log("Cars fetched successfully:",{count:r,dataLength:i==null?void 0:i.length}),{data:i||[],nextPage:i&&i.length===q?a+1:void 0,count:r}},mt=({searchQuery:a,filters:t,onFiltersChange:o})=>{const[s,i]=l.useState(null),[n,r]=l.useState("asc"),{ref:c,inView:h}=ut(),d=l.useRef(null),x=u=>{d.current!==u&&(d.current=u||null),c(u)};l.useEffect(()=>{o({...t,sortOrder:n})},[n,o]);const{data:g,isLoading:p,error:m,hasNextPage:f,fetchNextPage:v,isFetchingNextPage:j}=ze({queryKey:["available-cars",s,t,a],queryFn:({pageParam:u=0})=>ht({pageParam:u,filters:t,searchParams:{...s?{brand:s}:{},...a?{searchTerm:a}:{}}}),getNextPageParam:u=>u.nextPage||void 0,initialPageParam:0}),{data:F}=_({queryKey:["saved-car-ids"],queryFn:async()=>{var S;console.log("Fetching saved car IDs for home page");const{data:{session:u}}=await P.auth.getSession();if(!((S=u==null?void 0:u.user)!=null&&S.id))return new Set;const{data:A,error:b}=await P.from("saved_cars").select("car_id").eq("user_id",u.user.id);if(b)return console.error("Error fetching saved cars:",b),new Set;const k=new Set(A.map(L=>L.car_id));return console.log("Saved car IDs for home page:",Array.from(k)),k}}),w=F||new Set,N=(g==null?void 0:g.pages.flatMap(u=>u.data.map(A=>({...A,isSaved:w.has(A.id)}))))||[];l.useEffect(()=>{h&&f&&!j&&v()},[h,f,j,v]);const y=()=>{r(u=>u==="asc"?"desc":"asc")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(C,{variant:n?"secondary":"outline",onClick:y,className:`flex items-center gap-2 transition-colors ${n?"bg-accent text-accent-foreground":""}`,children:n==="asc"?e.jsxs(e.Fragment,{children:["Price: Low to High",e.jsx(ce,{className:"h-4 w-4"})]}):e.jsxs(e.Fragment,{children:["Price: High to Low",e.jsx(ie,{className:"h-4 w-4"})]})})}),e.jsx("div",{className:"text-left flex items-center ",children:e.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),e.jsx(ne,{cars:N,isLoading:p,error:m,loadMoreRef:d,isFetchingNextPage:j,isAuthenticated:!0}),f&&e.jsx("div",{ref:x,className:"h-10 w-full opacity-0",children:"Load more trigger"})]})},ea=()=>{const[a,t]=l.useState(""),[o,s]=l.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),i=$(),{isAuthenticated:n,userRole:r,isLoadingRole:c}=$e(),h=l.useCallback(d=>{s(d)},[]);return l.useEffect(()=>{},[i.search]),e.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[e.jsx(at,{searchQuery:a,onSearchChange:t,onFiltersChange:s}),e.jsx("main",{className:"container mx-auto px-4 py-8",children:c?e.jsx(Se,{}):n?r==="host"?e.jsx(ot,{searchQuery:a}):e.jsx(mt,{searchQuery:a,filters:o,onFiltersChange:h}):e.jsx(rt,{})}),e.jsx(Te,{})]})};export{ea as default};
