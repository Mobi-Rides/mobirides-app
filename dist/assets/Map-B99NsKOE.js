var xt=Object.defineProperty;var vt=(s,r,t)=>r in s?xt(s,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[r]=t;var ne=(s,r,t)=>vt(s,typeof r!="symbol"?r+"":r,t);import{j as e,u as yt}from"./query-vendor-Bsfdn-Hb.js";import{r as d,u as Ve,d as jt,h as wt}from"./react-vendor-mnpoGfEl.js";import{N as bt}from"./Navigation-KGq2NUYw.js";import{m as z}from"./mapbox-vendor-fnXFVHMy.js";import{G as Nt}from"./mapbox-gl-BwZeHHIL.js";import{c as te,B as A,q as _t,r as St,s as F,X as pe,t as Be,n as ee,v as ze,J as ue,w as S,C as Ne,x as qe,y as Oe,z as Ke,T as Ye,I as We,E as kt,F as Ct,G as Pt,H as le,K as ve,M as he,N as Et,O as Ge,Q as Rt,R as Mt,f as Te,V as se,W as It,Y as Xe,Z as Dt,_ as Tt,$ as Ht,a0 as Lt,a1 as At,g as $t,h as Ft,a2 as He,a3 as Ut,u as Vt,a4 as Bt,a5 as zt,a6 as qt}from"./index-DIwI39m3.js";import{A as Ot}from"./arrow-right-CzM9touV.js";import{O as Kt}from"./OnlineStatusToggle-MXpgYlHI.js";import{U as Qe}from"./user-73y0UjJF.js";import{S as _e}from"./star-Dr5DDkue.js";import{C as q,d as O,a as re,b as ae}from"./card-CixI4yIN.js";import{C as Je}from"./car-C76bGp2A.js";import{M as ye}from"./map-pin-CT3A4T4Q.js";import{C as me}from"./camera-BnBcxSnp.js";import{U as Ze}from"./upload-uwFiP8ov.js";import{S as Yt,a as Wt,b as Gt,c as Xt,d as we}from"./select-C3KnjN1h.js";import{u as Qt}from"./index-DXD4kVr2.js";import{C as be}from"./checkbox-Cj4Cpy1D.js";import{R as Jt,P as Se}from"./progress-aFZAPNQQ.js";import{C as Me}from"./clock-BiQSirFY.js";import{F as Zt}from"./flag-C-outJhr.js";import{N as Le}from"./navigation-DSrTows_.js";import{C as xe}from"./circle-alert-DpU2jVv3.js";import{L as es}from"./loader-circle-C8DAvCKp.js";import{u as ts}from"./useAuthStatus-8dnyuaTR.js";import{C as ss}from"./calendar-CTQ9n6gm.js";import{D as rs}from"./dollar-sign-Cl-j6ONT.js";import{a as Ae}from"./date-vendor-Dhms5dOu.js";import{H as as}from"./house-Bw_DA-8N.js";import"./bell-DqNyqWGa.js";import"./supabase-vendor-BOn0LdFJ.js";import"./switch-C17IWp8R.js";import"./index-BAdw-eVA.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=te("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=te("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=te("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=te("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=te("Map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=te("Navigation2",[["polygon",{points:"12 2 19 21 12 17 5 21 12 2",key:"x8c0qg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=te("PenTool",[["path",{d:"M15.707 21.293a1 1 0 0 1-1.414 0l-1.586-1.586a1 1 0 0 1 0-1.414l5.586-5.586a1 1 0 0 1 1.414 0l1.586 1.586a1 1 0 0 1 0 1.414z",key:"nt11vn"}],["path",{d:"m18 13-1.375-6.874a1 1 0 0 0-.746-.776L3.235 2.028a1 1 0 0 0-1.207 1.207L5.35 15.879a1 1 0 0 0 .776.746L13 18",key:"15qc1e"}],["path",{d:"m2.3 2.3 7.286 7.286",key:"1wuzzi"}],["circle",{cx:"11",cy:"11",r:"2",key:"xmgehs"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const et=te("Timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=te("Volume2",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["path",{d:"M16 9a5 5 0 0 1 0 6",key:"1q6k2b"}],["path",{d:"M19.364 18.364a9 9 0 0 0 0-12.728",key:"ijwkga"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=te("VolumeX",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]);function hs({onUp:s,onDown:r,onLeft:t,onRight:n,onReset:c}){return e.jsxs("div",{className:"flex flex-col items-center justify-center absolute bottom-20 right-4 z-10 gap-2",children:[e.jsx("div",{className:"flex gap-1",children:e.jsx(A,{variant:"default",onClick:s,style:{height:40},children:e.jsx(os,{name:"arrow-up",size:24,color:"white"})})}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(A,{variant:"default",onClick:t,style:{width:20},children:e.jsx(_t,{name:"arrow-left",size:24,color:"white"})}),e.jsx(A,{variant:"default",onClick:c,children:e.jsx(St,{name:"arrow-left",size:24,color:"white"})}),e.jsx(A,{variant:"default",onClick:n,style:{width:20},children:e.jsx(Ot,{name:"arrow-right",size:24,color:"white"})})]}),e.jsx("div",{className:"flex gap-1",children:e.jsx(A,{variant:"default",onClick:r,style:{height:40},children:e.jsx(ns,{name:"arrow-down",size:24,color:"white"})})})]})}const fs=({host:s,onViewCars:r})=>{const t=()=>s.avatar_url?F.storage.from("avatars").getPublicUrl(s.avatar_url).data.publicUrl:"/placeholder.svg";return e.jsx("div",{className:"bg-background border rounded-lg shadow-lg p-3 min-w-[200px] cursor-pointer hover:bg-muted/50 transition-colors",onClick:()=>r(s.id),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden bg-muted flex items-center justify-center",children:s.avatar_url?e.jsx("img",{src:t(),alt:s.full_name||"Host",className:"w-full h-full object-cover"}):e.jsx(Qe,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:s.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(_e,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32)"})]}),e.jsx("p",{className:"text-xs text-primary mt-1",children:"View available cars →"})]})]})})},gs=({isOpen:s,onClose:r,host:t})=>{const[n,c]=d.useState([]),[o,i]=d.useState(!1),f=Ve();d.useEffect(()=>{s&&(t!=null&&t.id)&&a(t.id)},[s,t==null?void 0:t.id]);const a=async u=>{i(!0),console.log("Fetching cars for host:",u);try{console.log("Step 1: Checking if host has any cars...");const{data:P,error:l}=await F.from("cars").select("*").eq("owner_id",u);console.log("All cars for host:",P),l&&console.error("Error fetching all cars:",l),console.log("Step 2: Checking available cars...");const{data:p,error:m}=await F.from("cars").select("*").eq("owner_id",u).eq("is_available",!0);if(console.log("Available cars for host:",p),m&&console.error("Error fetching available cars:",m),p&&p.length>0){console.log("Step 3: Checking car images...");const b=p.map(H=>H.id),{data:L,error:N}=await F.from("car_images").select("*").in("car_id",b);console.log("Car images:",L),N&&console.error("Error fetching car images:",N)}console.log("Step 4: Trying with left join...");const{data:v,error:w}=await F.from("cars").select(`
          *,
          car_images(
            image_url,
            is_primary
          )
        `).eq("owner_id",u).eq("is_available",!0);if(w){console.error("Error fetching host cars with left join:",w);return}console.log("Cars with left join:",v);const M=(v==null?void 0:v.map(b=>{var N,H,U;const L=(N=b.car_images)==null?void 0:N.find(B=>B.is_primary);return{...b,image_url:(L==null?void 0:L.image_url)||((U=(H=b.car_images)==null?void 0:H[0])==null?void 0:U.image_url)||b.image_url}}))||[];console.log("Transformed cars:",M),c(M)}catch(P){console.error("Error in fetchHostCars:",P)}finally{i(!1)}},g=u=>u?F.storage.from("car-images").getPublicUrl(u).data.publicUrl:"/placeholder.svg",y=()=>t!=null&&t.avatar_url?F.storage.from("avatars").getPublicUrl(t.avatar_url).data.publicUrl:"/placeholder.svg",h=u=>{f(`/cars/${u}`),r()};return s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/50 z-40",onClick:r}),e.jsx("div",{className:"fixed left-0 top-0 h-full w-80 bg-background border-r shadow-xl z-50 transform transition-transform duration-300",children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Host's Cars"}),e.jsx(A,{variant:"ghost",size:"sm",onClick:r,children:e.jsx(pe,{className:"w-4 h-4"})})]}),t&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:y(),alt:t.full_name||"Host",className:"w-10 h-10 rounded-full object-cover"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:t.full_name||"Host"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.8 (32 reviews)"})]})]})]})]}),e.jsx(Be,{className:"flex-1",children:e.jsx("div",{className:"p-4 space-y-4",children:o?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading cars..."})}):n.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Je,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"No available cars"})]}):n.map(u=>e.jsx(q,{className:"cursor-pointer hover:shadow-md transition-shadow",onClick:()=>h(u.id),children:e.jsxs(O,{className:"p-3",children:[e.jsx("div",{className:"aspect-video w-full mb-3 rounded-lg overflow-hidden bg-muted",children:e.jsx("img",{src:g(u.image_url),alt:`${u.brand} ${u.model}`,className:"w-full h-full object-cover"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-sm",children:[u.brand," ",u.model]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u.year})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-bold text-sm",children:["P",u.price_per_day]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"per day"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(ye,{className:"w-3 h-3"}),e.jsx("span",{className:"truncate",children:u.location})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx(ee,{variant:"secondary",className:"text-xs px-2 py-1",children:u.vehicle_type}),e.jsxs("span",{className:"text-muted-foreground",children:[u.seats," seats"]}),e.jsx("span",{className:"text-muted-foreground",children:"•"}),e.jsx("span",{className:"text-muted-foreground",children:u.transmission})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_e,{className:"w-3 h-3 fill-yellow-400 text-yellow-400"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"4.5 (12)"})]})]})]})},u.id))})})]})})]}):null},ps=({mapbox_token:s,longitude:r,latitude:t,onlineHosts:n,mapStyle:c="mapbox://styles/mapbox/streets-v12",isHandoverMode:o=!1,bookingId:i,zoom:f,interactive:a,dpad:g,locationToggle:y,destination:h,returnLocation:u})=>{const P=d.useRef(null),l=d.useRef(null),p=d.useRef(null),[m,v]=d.useState(!1),[w,M]=d.useState({latitude:t,longitude:r}),[b,L]=d.useState([]),[N,H]=d.useState([]),[U,B]=d.useState(null),[E,C]=d.useState(!1),T=ze(),R=o?T:null;d.useEffect(()=>{if(!u)return;const _=w.longitude,j=w.latitude;u(_,j)},[w]),d.useEffect(()=>{if(s&&(z.accessToken=s),!l.current&&P.current&&s){l.current=new z.Map({container:P.current,style:c,center:[r,t],zoom:f||14,interactive:a||!0}),l.current.addControl(new z.NavigationControl,"top-right");const _=new z.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0});l.current.addControl(_,"top-right"),p.current=_,_.on("error",j=>{console.error("Geolocation error:",j),ue.error("Unable to access your location. Please check your browser permissions."),o&&R&&ue.error("Location sharing is required for the handover process. Please enable location access.")}),l.current.on("load",()=>{console.log("Map loaded successfully"),v(!0),p.current&&p.current.on("geolocate",j=>{console.log("Geolocate event fired:",j.coords);const x={longitude:j.coords.longitude,latitude:j.coords.latitude};M(x),console.log("User location updated:",x),o&&R&&(console.log("In handover mode, updating handover location..."),V(x.latitude,x.longitude).then(D=>{console.log("Address fetched:",D),R.updateLocation({latitude:x.latitude,longitude:x.longitude,address:D||"Unknown location"})}))}),setTimeout(()=>{p.current&&p.current.trigger()},1e3)}),l.current.on("error",j=>{console.error("Map error:",j),ue.error("Error loading map. Please refresh.")}),u&&l.current.on("click",j=>{console.log("Map clicked at coordinates:",j.lngLat),u(j.lngLat.lng,j.lngLat.lat)})}return()=>{l.current&&(l.current.remove(),l.current=null)}},[s,r,t,c,o,R]);const V=async(_,j)=>{try{const D=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${j},${_}.json?access_token=${s}`)).json();return D.features&&D.features.length>0?D.features[0].place_name:null}catch(x){return console.error("Error fetching address:",x),null}};d.useEffect(()=>{l.current&&m&&l.current.setStyle(c)},[c,m]);const Q=_=>{console.log("Trying to view cars for host:",_);const j=n==null?void 0:n.find(x=>x.id===_);if(console.log("Found host:",j),j){const x={id:j.id,full_name:j.full_name,avatar_url:j.avatar_url,latitude:j.latitude,longitude:j.longitude,updated_at:j.updated_at};console.log("Setting selected host:",x),B(x),C(!0)}else console.log("No host found with ID:",_)},K=_=>{if(!l.current||!m||!w.latitude||!w.longitude)return;(async()=>{try{const D=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${_.longitude},${_.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(D.routes&&D.routes.length>0){const X=D.routes[0].geometry;l.current.getSource("host-route")?l.current.getSource("host-route").setData(X):(l.current.addSource("host-route",{type:"geojson",data:X}),l.current.addLayer({id:"host-route",type:"line",source:"host-route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":_.isActiveHandover?"#ef4444":"#3b82f6","line-width":_.isActiveHandover?6:4}}));const $=new z.LngLatBounds().extend([w.longitude,w.latitude]).extend([_.longitude,_.latitude]);l.current.fitBounds($,{padding:50,maxZoom:15})}}catch(x){console.error("Error fetching route to host:",x),ue.error("Unable to calculate route")}})()};d.useEffect(()=>{if(!l.current||!m||!(n!=null&&n.length))return;b.forEach(x=>x.remove()),L([]);const _=n.map(x=>{if(!x.latitude||!x.longitude)return null;const D=document.createElement("div");D.className="host-marker",D.style.width=x.isActiveHandover?"24px":"20px",D.style.height=x.isActiveHandover?"24px":"20px",D.style.borderRadius="50%",D.style.backgroundColor=x.isActiveHandover?"#ef4444":"#4ade80",D.style.border=x.isActiveHandover?"3px solid white":"2px solid white",D.style.boxShadow=x.isActiveHandover?"0 0 15px rgba(239, 68, 68, 0.5)":"0 0 10px rgba(0, 0, 0, 0.3)",D.style.cursor="pointer",x.isActiveHandover&&(D.style.animation="pulse 2s infinite");const X=document.createElement("div"),$=new z.Marker(D).setLngLat([x.longitude,x.latitude]).addTo(l.current);return D.addEventListener("mouseenter",()=>{jt.render(e.jsx(fs,{host:x,onViewCars:Q}),X);const J=new z.Popup({offset:25,closeButton:!1,closeOnClick:!1,className:"host-popup"}).setDOMContent(X).addTo(l.current);$.setPopup(J),J.addTo(l.current)}),D.addEventListener("mouseleave",()=>{setTimeout(()=>{const J=$.getPopup();J&&J.remove()},100)}),D.addEventListener("click",()=>{Q(x.id),l.current&&m&&(async()=>{try{const ie=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${x.longitude},${x.latitude}?geometries=geojson&access_token=${z.accessToken}`)).json();if(ie.routes&&ie.routes.length>0){const de=ie.routes[0].geometry;l.current.getSource("route")?l.current.getSource("route").setData(de):(l.current.addSource("route",{type:"geojson",data:de}),l.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}));const fe=new z.LngLatBounds().extend([w.longitude,w.latitude]).extend([x.longitude,x.latitude]);l.current.fitBounds(fe,{padding:50,maxZoom:15})}}catch(Z){console.error("Error fetching route to host:",Z),ue.error("Unable to calculate route")}})()}),$}).filter(Boolean);L(_);const j=n==null?void 0:n.find(x=>x.isActiveHandover);j&&w.latitude&&w.longitude&&setTimeout(()=>{K(j)},1e3)},[n,m,o,w]),d.useEffect(()=>{if(!l.current||!m||!h)return;const{latitude:_,longitude:j}=h,x=document.createElement("div");x.className="destination-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#f59e0b",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const D=new z.Marker(x).setLngLat([j,_]).setPopup(new z.Popup({offset:25}).setHTML('<p class="font-medium">Destination</p>')).addTo(l.current);return()=>{D.remove()}}),d.useEffect(()=>{if(!l.current||!m||!h)return;const{latitude:_,longitude:j}=h;return(async()=>{try{const X=await(await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${w.longitude},${w.latitude};${j},${_}?geometries=geojson&access_token=${z.accessToken}`)).json();if(X.routes&&X.routes.length>0){const $=X.routes[0].geometry;l.current.getSource("route")?l.current.getSource("route").setData($):(l.current.addSource("route",{type:"geojson",data:$}),l.current.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#3b82f6","line-width":5}}))}}catch(D){console.error("Error fetching route:",D)}})(),()=>{l.current&&(l.current.getStyle()&&l.current.getLayer("route")&&l.current.removeLayer("route"),l.current.getStyle()&&l.current.getSource("route")&&l.current.removeSource("route"))}},[m,h,w]),d.useEffect(()=>{if(!l.current||!m||!o||!(R!=null&&R.handoverStatus))return;N.forEach(j=>j.remove()),H([]);const _=[];if(R.handoverStatus.host_location){const j=R.handoverStatus.host_location,x=document.createElement("div");x.className="host-handover-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#3b82f6",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const D=new z.Marker(x).setLngLat([j.longitude,j.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Host Location</p>
             <p class="text-xs">${j.address}</p>`)).addTo(l.current);_.push(D)}if(R.handoverStatus.renter_location){const j=R.handoverStatus.renter_location,x=document.createElement("div");x.className="renter-handover-marker",x.style.width="24px",x.style.height="24px",x.style.borderRadius="50%",x.style.backgroundColor="#ec4899",x.style.border="3px solid white",x.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)";const D=new z.Marker(x).setLngLat([j.longitude,j.latitude]).setPopup(new z.Popup({offset:25}).setHTML(`<p class="font-medium">Renter Location</p>
             <p class="text-xs">${j.address}</p>`)).addTo(l.current);_.push(D)}if(_.length===2&&l.current){const j=new z.LngLatBounds;_.forEach(x=>{j.extend(x.getLngLat())}),l.current.fitBounds(j,{padding:100,maxZoom:15})}H(_)},[R==null?void 0:R.handoverStatus,m,o]);const Y=()=>{l.current&&l.current.panBy([0,-100],{duration:500})},G=()=>{l.current&&l.current.panBy([0,100],{duration:500})},k=()=>{l.current&&l.current.panBy([-100,0],{duration:500})},W=()=>{l.current&&l.current.panBy([100,0],{duration:500})},I=()=>{l.current&&l.current.flyTo({center:[w.longitude,w.latitude],zoom:20,essential:!0})};return e.jsxs("div",{className:"relative w-full h-full bottom-0 left-0 right-0 top-0",children:[e.jsx("div",{ref:P,className:"w-full h-full"}),!o&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:y&&e.jsx(Kt,{lat:w.latitude,long:w.longitude})})}),o&&(R==null?void 0:R.handoverStatus)&&e.jsx("div",{className:"absolute top-4 left-0 right-0 z-10 mx-auto flex justify-center pointer-events-none",children:e.jsx("div",{className:`bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm shadow-lg rounded-full py-2 px-4 \r
                        max-w-xs w-auto pointer-events-auto transition-all duration-300 \r
                        border border-gray-200 dark:border-gray-700`,children:e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-sm font-medium",children:[R.isHost?"Host":"Renter"," Mode"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:R.handoverStatus.host_location&&R.handoverStatus.renter_location?"Both locations shared":"Waiting for location..."})]})})}),g&&e.jsx(hs,{onUp:Y,onDown:G,onLeft:k,onRight:W,onReset:I}),e.jsx(gs,{isOpen:E,onClose:()=>C(!1),host:U})]})},xs=async()=>{try{const{data:s,error:r}=await F.from("profiles").select("is_sharing_location, latitude, longitude").limit(1);if(r)return console.error("Error checking location columns:",r),!1;if(!s||s.length===0)return console.error("No profiles found to check columns"),!1;const t=s[0];return t?"latitude"in t&&"longitude"in t&&"is_sharing_location"in t:!1}catch(s){return console.error("Error in checkLocationColumns:",s),!1}},vs=s=>!s||typeof s!="object"?null:{id:typeof s.id=="string"?s.id:"",full_name:s.full_name||null,avatar_url:s.avatar_url||null,latitude:typeof s.latitude=="number"?s.latitude:null,longitude:typeof s.longitude=="number"?s.longitude:null,updated_at:s.updated_at||null},ys=async()=>{try{if(console.log("Fetching online hosts..."),!await xs())return console.error("Required location columns don't exist in profiles table"),[];const{data:r,error:t}=await F.from("profiles").select("id, full_name, avatar_url, latitude, longitude, updated_at").eq("is_sharing_location",!0).not("latitude","is",null).not("longitude","is",null);if(t)return console.error("Error fetching online hosts:",t),[];if(!r||!Array.isArray(r))return console.error("Expected array of hosts but got:",r),[];console.log(`Found ${r.length} online hosts`);const n=[];for(const c of r){const o=vs(c);o&&n.push(o)}return n}catch(s){return console.error("Error in fetchOnlineHosts:",s),[]}},ge=[{name:"navigation",order:1,title:"Navigate to Location",description:"Get directions to the handover location"},{name:"identity_verification",order:2,title:"Identity Verification",description:"Verify each other's identity"},{name:"vehicle_inspection_exterior",order:3,title:"Exterior Inspection",description:"Document vehicle exterior condition"},{name:"vehicle_inspection_interior",order:4,title:"Interior Inspection",description:"Document vehicle interior condition"},{name:"damage_documentation",order:5,title:"Damage Documentation",description:"Record any existing damage"},{name:"fuel_mileage_check",order:6,title:"Fuel & Mileage",description:"Record current fuel level and mileage"},{name:"key_transfer",order:7,title:"Key Transfer",description:"Physical transfer of vehicle keys"},{name:"digital_signature",order:8,title:"Digital Acknowledgment",description:"Sign handover agreement"},{name:"completion",order:9,title:"Handover Complete",description:"Finalize the handover process"}],js=async s=>{try{const{data:r}=await F.from("handover_step_completion").select("id").eq("handover_session_id",s);if(r&&r.length>0)return console.log("Handover steps already initialized"),!0;const t=ge.map(c=>({handover_session_id:s,step_name:c.name,step_order:c.order,is_completed:!1})),{error:n}=await F.from("handover_step_completion").insert(t);if(n)throw n;return console.log("Handover steps initialized successfully"),!0}catch(r){return console.error("Error initializing handover steps:",r),S.error("Failed to initialize handover steps"),!1}},$e=async s=>{try{const{data:r,error:t}=await F.from("handover_step_completion").select("*").eq("handover_session_id",s).order("step_order");if(t)throw t;return r||[]}catch(r){return console.error("Error fetching handover steps:",r),[]}},ws=async(s,r,t)=>{var n;try{const{data:c}=await F.auth.getUser();if(!((n=c==null?void 0:c.user)!=null&&n.id))throw new Error("User not authenticated");const{data:o}=await F.from("handover_step_completion").select("step_order").eq("handover_session_id",s).eq("step_name",r).single();if(!o)throw new Error("Step not found");const i=await bs(s,r,t);if(!i.isValid)return S.error(i.message),!1;const{error:f}=await F.from("handover_step_completion").update({is_completed:!0,completed_by:c.user.id,completion_data:t,completed_at:new Date().toISOString()}).eq("handover_session_id",s).eq("step_name",r);if(f){if(f.message.includes("Previous steps must be completed"))S.error("Please complete previous steps first");else throw f;return!1}return console.log(`Step ${r} completed successfully`),S.success(`${r.replace("_"," ")} completed`),!0}catch(c){return console.error("Error completing handover step:",c),c.message.includes("Previous steps must be completed")?S.error("Please complete previous steps in order"):S.error("Failed to complete handover step"),!1}},bs=async(s,r,t)=>{switch(r){case"fuel_mileage_check":if(!(t!=null&&t.fuel_level)||!(t!=null&&t.mileage))return{isValid:!1,message:"Fuel level and mileage are required"};if(Number(t.fuel_level)<0||Number(t.fuel_level)>100)return{isValid:!1,message:"Fuel level must be between 0 and 100%"};if(Number(t.mileage)<0)return{isValid:!1,message:"Mileage must be a positive number"};break;case"digital_signature":if(!(t!=null&&t.signature))return{isValid:!1,message:"Digital signature is required"};break}return{isValid:!0,message:"Validation passed"}},Ie=async(s,r,t,n=3)=>{var o;let c=0;for(;c<n;)try{const{data:i}=await F.auth.getUser();if(!((o=i==null?void 0:i.user)!=null&&o.id))throw new Error("User not authenticated");const f=s.name.split(".").pop(),a=`${i.user.id}/${r}/${t}_${Date.now()}.${f}`,{error:g}=await F.storage.from("handover-photos").upload(a,s);if(g)throw g;const{data:{publicUrl:y}}=F.storage.from("handover-photos").getPublicUrl(a);return console.log(`Photo uploaded successfully: ${a}`),y}catch(i){if(c++,console.error(`Photo upload attempt ${c} failed:`,i),c>=n)return S.error("Failed to upload photo after multiple attempts"),null;await new Promise(f=>setTimeout(f,1e3*c))}return null},Ns=async s=>{var r;try{const{data:t}=await F.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const n={handover_session_id:s.handover_session_id,booking_id:s.booking_id,car_id:s.car_id,report_type:s.report_type,vehicle_photos:JSON.stringify(s.vehicle_photos),damage_reports:JSON.stringify(s.damage_reports),fuel_level:s.fuel_level,mileage:s.mileage,exterior_condition_notes:s.exterior_condition_notes,interior_condition_notes:s.interior_condition_notes,additional_notes:s.additional_notes,digital_signature_data:s.digital_signature_data,is_acknowledged:s.is_acknowledged,reporter_id:s.reporter_id||t.user.id},{data:c,error:o}=await F.from("vehicle_condition_reports").insert(n).select().single();if(o)throw o;return console.log("Vehicle condition report created successfully"),c}catch(t){return console.error("Error creating vehicle condition report:",t),S.error("Failed to create condition report"),null}},_s=async s=>{var r;try{const{data:t}=await F.auth.getUser();if(!((r=t==null?void 0:t.user)!=null&&r.id))throw new Error("User not authenticated");const n={handover_session_id:s.handover_session_id,verifier_id:t.user.id,verified_user_id:s.verified_user_id,verification_photo_url:s.verification_photo_url,license_photo_url:s.license_photo_url,verification_status:s.verification_status,verification_notes:s.verification_notes},{data:c,error:o}=await F.from("identity_verification_checks").insert(n).select().single();if(o)throw o;return c}catch(t){return console.error("Error creating identity verification check:",t),S.error("Failed to create identity verification"),null}},Ss=({handoverSessionId:s,otherUserId:r,otherUserName:t,isHost:n,onStepComplete:c})=>{const[o,i]=d.useState(null),[f,a]=d.useState(!1),[g,y]=d.useState("pending"),[h,u]=d.useState(""),[P,l]=d.useState(!1),p=async v=>{var M;const w=(M=v.target.files)==null?void 0:M[0];if(w){a(!0);try{const b=await Ie(w,s,"identity_verification");b&&(i(b),await _s({handover_session_id:s,verifier_id:"",verified_user_id:r,verification_photo_url:b,verification_status:"pending"}),S.success("Verification photo uploaded successfully"))}catch{S.error("Failed to upload verification photo")}finally{a(!1)}}},m=async v=>{l(!0);try{y(v),v==="verified"?(S.success(`${t}'s identity verified successfully`),c()):S.error("Identity verification failed")}catch{S.error("Failed to update verification status")}finally{l(!1)}};return e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-5 w-5"}),"Identity Verification"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Verify ",t,"'s identity by taking their photo and comparing with their profile"]})]}),e.jsx(O,{className:"space-y-4",children:o?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:o,alt:"Verification photo",className:"w-full h-48 object-cover rounded-lg"}),e.jsxs(ee,{variant:g==="verified"?"default":g==="failed"?"destructive":"secondary",className:"absolute top-2 right-2",children:[g==="verified"&&e.jsx(Ne,{className:"h-3 w-3 mr-1"}),g==="failed"&&e.jsx(pe,{className:"h-3 w-3 mr-1"}),g.charAt(0).toUpperCase()+g.slice(1)]})]}),g==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx(qe,{placeholder:"Add any notes about the verification...",value:h,onChange:v=>u(v.target.value),className:"min-h-[80px]"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(A,{onClick:()=>m("verified"),disabled:P,className:"flex-1 bg-green-600 hover:bg-green-700",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Verify Identity"]}),e.jsxs(A,{onClick:()=>m("failed"),disabled:P,variant:"destructive",className:"flex-1",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Reject"]})]})]}),g==="verified"&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Identity verification completed successfully"})}),g==="failed"&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 text-sm",children:"❌ Identity verification failed. Please contact support if needed."})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 text-center",children:[e.jsx(me,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Take a photo of ",t," for identity verification"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"user",onChange:p,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:f}),e.jsx(A,{disabled:f,className:"flex items-center gap-2",children:f?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"h-4 w-4 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"h-4 w-4"}),"Take Photo"]})})]})]})})]})},ks={exterior:[{type:"exterior_front",label:"Front View",required:!0},{type:"exterior_back",label:"Rear View",required:!0},{type:"exterior_left",label:"Left Side",required:!0},{type:"exterior_right",label:"Right Side",required:!0}],interior:[{type:"interior_dashboard",label:"Dashboard",required:!0},{type:"interior_seats",label:"Seats",required:!0},{type:"fuel_gauge",label:"Fuel Gauge",required:!0},{type:"odometer",label:"Odometer",required:!0}]},Fe=({handoverSessionId:s,inspectionType:r,onPhotosUpdate:t,onStepComplete:n,initialPhotos:c=[]})=>{const[o,i]=d.useState(c),[f,a]=d.useState(!1),[g,y]=d.useState(null),h=d.useRef({}),u=ks[r],P=u.filter(N=>N.required),l=P.filter(N=>o.some(H=>H.type===N.type)),p=async(N,H)=>{a(!0),y(N);try{const U=await Ie(H,s,N);if(U){const B={id:`${Date.now()}-${N}`,type:N,url:U,timestamp:new Date().toISOString()},E=[...o,B];i(E),t(E),S.success("Photo uploaded successfully")}}catch{S.error("Failed to upload photo")}finally{a(!1),y(null)}},m=N=>{const H=h.current[N];H&&(y(N),H.click())},v=(N,H)=>{var B;const U=(B=N.target.files)==null?void 0:B[0];U&&p(H,U),N.target.value=""},w=N=>{const H=o.filter(U=>U.id!==N);i(H),t(H)},M=N=>o.find(H=>H.type===N),b=l.length===P.length,L=()=>{b&&(n(),S.success(`${r} inspection completed`))};return e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"h-5 w-5"}),r==="exterior"?"Exterior":"Interior"," Inspection"]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(ee,{variant:b?"default":"secondary",children:[l.length,"/",P.length," Required Photos"]})})]}),e.jsxs(O,{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:u.map(N=>{const H=M(N.type),U=g===N.type;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:N.label}),N.required&&e.jsx(ee,{variant:"outline",className:"text-xs",children:"Required"})]}),H?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:H.url,alt:N.label,className:"w-full h-32 object-cover rounded-lg"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all rounded-lg flex items-center justify-center",children:e.jsx(A,{size:"sm",variant:"destructive",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>w(H.id),children:e.jsx(Oe,{className:"h-4 w-4"})})})]}):e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg h-32 flex flex-col items-center justify-center cursor-pointer hover:border-gray-400 transition-colors",onClick:()=>m(N.type),children:[e.jsx("input",{ref:B=>h.current[N.type]=B,type:"file",accept:"image/*",capture:"environment",onChange:B=>v(B,N.type),className:"hidden"}),e.jsx("div",{className:"flex flex-col items-center justify-center h-full",children:U&&g===N.type?e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"h-6 w-6 animate-spin text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Uploading..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"h-6 w-6 text-gray-400 mb-2"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Add Photo"})]})})]})]},N.type)})}),b&&e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(A,{onClick:L,className:"w-full",children:["Complete ",r==="exterior"?"Exterior":"Interior"," Inspection"]})}),!b&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all required photos to proceed"})})]})]})},Cs=({handoverSessionId:s,onDamageReportsUpdate:r,onStepComplete:t,initialReports:n=[]})=>{const[c,o]=d.useState(n),[i,f]=d.useState(!1),[a,g]=d.useState({location:"",severity:"minor",description:"",photos:[]}),[y,h]=d.useState(!1),u=async m=>{h(!0);try{const v=await Ie(m,s,"damage_specific");v&&(g(w=>({...w,photos:[...w.photos,v]})),S.success("Damage photo uploaded"))}catch{S.error("Failed to upload damage photo")}finally{h(!1)}},P=()=>{if(!a.location||!a.description){S.error("Please fill in location and description");return}const m={id:`damage-${Date.now()}`,location:a.location,severity:a.severity,description:a.description,photos:a.photos,timestamp:new Date().toISOString()},v=[...c,m];o(v),r(v),g({location:"",severity:"minor",description:"",photos:[]}),f(!1),S.success("Damage report added")},l=m=>{const v=c.filter(w=>w.id!==m);o(v),r(v)},p=m=>{switch(m){case"minor":return"bg-yellow-100 text-yellow-800";case"moderate":return"bg-orange-100 text-orange-800";case"major":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Ye,{className:"h-5 w-5"}),"Damage Documentation"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Document any existing damage to the vehicle. If no damage is present, you can skip this step."})]}),e.jsxs(O,{className:"space-y-4",children:[c.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium",children:["Documented Damage (",c.length,")"]}),c.map(m=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:m.location}),e.jsx(ee,{className:`ml-2 ${p(m.severity)}`,children:m.severity})]}),e.jsx(A,{size:"sm",variant:"outline",onClick:()=>l(m.id),children:e.jsx(Oe,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:m.description}),m.photos.length>0&&e.jsx("div",{className:"grid grid-cols-3 gap-2",children:m.photos.map((v,w)=>e.jsx("img",{src:v,alt:`Damage ${w+1}`,className:"w-full h-20 object-cover rounded"},w))})]},m.id))]}),i?e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Add Damage Report"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Location"}),e.jsx(We,{placeholder:"e.g., Front bumper, Driver door",value:a.location,onChange:m=>g(v=>({...v,location:m.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Severity"}),e.jsxs(Yt,{value:a.severity,onValueChange:m=>g(v=>({...v,severity:m})),children:[e.jsx(Wt,{children:e.jsx(Gt,{})}),e.jsxs(Xt,{children:[e.jsx(we,{value:"minor",children:"Minor"}),e.jsx(we,{value:"moderate",children:"Moderate"}),e.jsx(we,{value:"major",children:"Major"})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Description"}),e.jsx(qe,{placeholder:"Describe the damage in detail...",value:a.description,onChange:m=>g(v=>({...v,description:m.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[a.photos.map((m,v)=>e.jsx("img",{src:m,alt:`Damage photo ${v+1}`,className:"w-full h-20 object-cover rounded"},v)),e.jsxs("div",{className:"relative border-2 border-dashed border-gray-300 rounded h-20 flex items-center justify-center",children:[e.jsx("input",{type:"file",accept:"image/*",capture:"environment",onChange:m=>{var w;const v=(w=m.target.files)==null?void 0:w[0];v&&u(v)},className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",disabled:y}),e.jsx(me,{className:"h-6 w-6 text-gray-400"})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(A,{onClick:P,className:"flex-1",children:"Save Damage Report"}),e.jsx(A,{variant:"outline",onClick:()=>f(!1),className:"flex-1",children:"Cancel"})]})]}):e.jsxs(A,{onClick:()=>f(!0),variant:"outline",className:"w-full flex items-center gap-2",children:[e.jsx(Ke,{className:"h-4 w-4"}),"Add Damage Report"]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(A,{onClick:t,className:"w-full",children:c.length>0?`Complete Documentation (${c.length} damage reports)`:"No Damage - Complete Step"})})]})]})};var tt=["PageUp","PageDown"],st=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],rt={"from-left":["Home","PageDown","ArrowDown","ArrowLeft"],"from-right":["Home","PageDown","ArrowDown","ArrowRight"],"from-bottom":["Home","PageDown","ArrowDown","ArrowLeft"],"from-top":["Home","PageDown","ArrowUp","ArrowLeft"]},ce="Slider",[Ce,Ps,Es]=Pt(ce),[at,Fr]=Ct(ce,[Es]),[Rs,je]=at(ce),nt=d.forwardRef((s,r)=>{const{name:t,min:n=0,max:c=100,step:o=1,orientation:i="horizontal",disabled:f=!1,minStepsBetweenThumbs:a=0,defaultValue:g=[n],value:y,onValueChange:h=()=>{},onValueCommit:u=()=>{},inverted:P=!1,form:l,...p}=s,m=d.useRef(new Set),v=d.useRef(0),M=i==="horizontal"?Ms:Is,[b=[],L]=kt({prop:y,defaultProp:g,onChange:C=>{var R;(R=[...m.current][v.current])==null||R.focus(),h(C)}}),N=d.useRef(b);function H(C){const T=As(b,C);E(C,T)}function U(C){E(C,v.current)}function B(){const C=N.current[v.current];b[v.current]!==C&&u(b)}function E(C,T,{commit:R}={commit:!1}){const V=Vs(o),Q=Bs(Math.round((C-n)/o)*o+n,V),K=Ge(Q,[n,c]);L((Y=[])=>{const G=Hs(Y,K,T);if(Us(G,a*o)){v.current=G.indexOf(K);const k=String(G)!==String(Y);return k&&R&&u(G),k?G:Y}else return Y})}return e.jsx(Rs,{scope:s.__scopeSlider,name:t,disabled:f,min:n,max:c,valueIndexToChangeRef:v,thumbs:m.current,values:b,orientation:i,form:l,children:e.jsx(Ce.Provider,{scope:s.__scopeSlider,children:e.jsx(Ce.Slot,{scope:s.__scopeSlider,children:e.jsx(M,{"aria-disabled":f,"data-disabled":f?"":void 0,...p,ref:r,onPointerDown:le(p.onPointerDown,()=>{f||(N.current=b)}),min:n,max:c,inverted:P,onSlideStart:f?void 0:H,onSlideMove:f?void 0:U,onSlideEnd:f?void 0:B,onHomeKeyDown:()=>!f&&E(n,0,{commit:!0}),onEndKeyDown:()=>!f&&E(c,b.length-1,{commit:!0}),onStepKeyDown:({event:C,direction:T})=>{if(!f){const Q=tt.includes(C.key)||C.shiftKey&&st.includes(C.key)?10:1,K=v.current,Y=b[K],G=o*Q*T;E(Y+G,K,{commit:!0})}}})})})})});nt.displayName=ce;var[ot,it]=at(ce,{startEdge:"left",endEdge:"right",size:"width",direction:1}),Ms=d.forwardRef((s,r)=>{const{min:t,max:n,dir:c,inverted:o,onSlideStart:i,onSlideMove:f,onSlideEnd:a,onStepKeyDown:g,...y}=s,[h,u]=d.useState(null),P=he(r,M=>u(M)),l=d.useRef(),p=Et(c),m=p==="ltr",v=m&&!o||!m&&o;function w(M){const b=l.current||h.getBoundingClientRect(),L=[0,b.width],H=De(L,v?[t,n]:[n,t]);return l.current=b,H(M-b.left)}return e.jsx(ot,{scope:s.__scopeSlider,startEdge:v?"left":"right",endEdge:v?"right":"left",direction:v?1:-1,size:"width",children:e.jsx(lt,{dir:p,"data-orientation":"horizontal",...y,ref:P,style:{...y.style,"--radix-slider-thumb-transform":"translateX(-50%)"},onSlideStart:M=>{const b=w(M.clientX);i==null||i(b)},onSlideMove:M=>{const b=w(M.clientX);f==null||f(b)},onSlideEnd:()=>{l.current=void 0,a==null||a()},onStepKeyDown:M=>{const L=rt[v?"from-left":"from-right"].includes(M.key);g==null||g({event:M,direction:L?-1:1})}})})}),Is=d.forwardRef((s,r)=>{const{min:t,max:n,inverted:c,onSlideStart:o,onSlideMove:i,onSlideEnd:f,onStepKeyDown:a,...g}=s,y=d.useRef(null),h=he(r,y),u=d.useRef(),P=!c;function l(p){const m=u.current||y.current.getBoundingClientRect(),v=[0,m.height],M=De(v,P?[n,t]:[t,n]);return u.current=m,M(p-m.top)}return e.jsx(ot,{scope:s.__scopeSlider,startEdge:P?"bottom":"top",endEdge:P?"top":"bottom",size:"height",direction:P?1:-1,children:e.jsx(lt,{"data-orientation":"vertical",...g,ref:h,style:{...g.style,"--radix-slider-thumb-transform":"translateY(50%)"},onSlideStart:p=>{const m=l(p.clientY);o==null||o(m)},onSlideMove:p=>{const m=l(p.clientY);i==null||i(m)},onSlideEnd:()=>{u.current=void 0,f==null||f()},onStepKeyDown:p=>{const v=rt[P?"from-bottom":"from-top"].includes(p.key);a==null||a({event:p,direction:v?-1:1})}})})}),lt=d.forwardRef((s,r)=>{const{__scopeSlider:t,onSlideStart:n,onSlideMove:c,onSlideEnd:o,onHomeKeyDown:i,onEndKeyDown:f,onStepKeyDown:a,...g}=s,y=je(ce,t);return e.jsx(ve.span,{...g,ref:r,onKeyDown:le(s.onKeyDown,h=>{h.key==="Home"?(i(h),h.preventDefault()):h.key==="End"?(f(h),h.preventDefault()):tt.concat(st).includes(h.key)&&(a(h),h.preventDefault())}),onPointerDown:le(s.onPointerDown,h=>{const u=h.target;u.setPointerCapture(h.pointerId),h.preventDefault(),y.thumbs.has(u)?u.focus():n(h)}),onPointerMove:le(s.onPointerMove,h=>{h.target.hasPointerCapture(h.pointerId)&&c(h)}),onPointerUp:le(s.onPointerUp,h=>{const u=h.target;u.hasPointerCapture(h.pointerId)&&(u.releasePointerCapture(h.pointerId),o(h))})})}),ct="SliderTrack",dt=d.forwardRef((s,r)=>{const{__scopeSlider:t,...n}=s,c=je(ct,t);return e.jsx(ve.span,{"data-disabled":c.disabled?"":void 0,"data-orientation":c.orientation,...n,ref:r})});dt.displayName=ct;var Pe="SliderRange",ut=d.forwardRef((s,r)=>{const{__scopeSlider:t,...n}=s,c=je(Pe,t),o=it(Pe,t),i=d.useRef(null),f=he(r,i),a=c.values.length,g=c.values.map(u=>ht(u,c.min,c.max)),y=a>1?Math.min(...g):0,h=100-Math.max(...g);return e.jsx(ve.span,{"data-orientation":c.orientation,"data-disabled":c.disabled?"":void 0,...n,ref:f,style:{...s.style,[o.startEdge]:y+"%",[o.endEdge]:h+"%"}})});ut.displayName=Pe;var Ee="SliderThumb",mt=d.forwardRef((s,r)=>{const t=Ps(s.__scopeSlider),[n,c]=d.useState(null),o=he(r,f=>c(f)),i=d.useMemo(()=>n?t().findIndex(f=>f.ref.current===n):-1,[t,n]);return e.jsx(Ds,{...s,ref:o,index:i})}),Ds=d.forwardRef((s,r)=>{const{__scopeSlider:t,index:n,name:c,...o}=s,i=je(Ee,t),f=it(Ee,t),[a,g]=d.useState(null),y=he(r,w=>g(w)),h=a?i.form||!!a.closest("form"):!0,u=Rt(a),P=i.values[n],l=P===void 0?0:ht(P,i.min,i.max),p=Ls(n,i.values.length),m=u==null?void 0:u[f.size],v=m?$s(m,l,f.direction):0;return d.useEffect(()=>{if(a)return i.thumbs.add(a),()=>{i.thumbs.delete(a)}},[a,i.thumbs]),e.jsxs("span",{style:{transform:"var(--radix-slider-thumb-transform)",position:"absolute",[f.startEdge]:`calc(${l}% + ${v}px)`},children:[e.jsx(Ce.ItemSlot,{scope:s.__scopeSlider,children:e.jsx(ve.span,{role:"slider","aria-label":s["aria-label"]||p,"aria-valuemin":i.min,"aria-valuenow":P,"aria-valuemax":i.max,"aria-orientation":i.orientation,"data-orientation":i.orientation,"data-disabled":i.disabled?"":void 0,tabIndex:i.disabled?void 0:0,...o,ref:y,style:P===void 0?{display:"none"}:s.style,onFocus:le(s.onFocus,()=>{i.valueIndexToChangeRef.current=n})})}),h&&e.jsx(Ts,{name:c??(i.name?i.name+(i.values.length>1?"[]":""):void 0),form:i.form,value:P},n)]})});mt.displayName=Ee;var Ts=s=>{const{value:r,...t}=s,n=d.useRef(null),c=Qt(r);return d.useEffect(()=>{const o=n.current,i=window.HTMLInputElement.prototype,a=Object.getOwnPropertyDescriptor(i,"value").set;if(c!==r&&a){const g=new Event("input",{bubbles:!0});a.call(o,r),o.dispatchEvent(g)}},[c,r]),e.jsx("input",{style:{display:"none"},...t,ref:n,defaultValue:r})};function Hs(s=[],r,t){const n=[...s];return n[t]=r,n.sort((c,o)=>c-o)}function ht(s,r,t){const o=100/(t-r)*(s-r);return Ge(o,[0,100])}function Ls(s,r){return r>2?`Value ${s+1} of ${r}`:r===2?["Minimum","Maximum"][s]:void 0}function As(s,r){if(s.length===1)return 0;const t=s.map(c=>Math.abs(c-r)),n=Math.min(...t);return t.indexOf(n)}function $s(s,r,t){const n=s/2,o=De([0,50],[0,n]);return(n-o(r)*t)*t}function Fs(s){return s.slice(0,-1).map((r,t)=>s[t+1]-r)}function Us(s,r){if(r>0){const t=Fs(s);return Math.min(...t)>=r}return!0}function De(s,r){return t=>{if(s[0]===s[1]||r[0]===r[1])return r[0];const n=(r[1]-r[0])/(s[1]-s[0]);return r[0]+n*(t-s[0])}}function Vs(s){return(String(s).split(".")[1]||"").length}function Bs(s,r){const t=Math.pow(10,r);return Math.round(s*t)/t}var ft=nt,zs=dt,qs=ut,Os=mt;const gt=d.forwardRef(({className:s,...r},t)=>e.jsxs(ft,{ref:t,className:Mt("relative flex w-full touch-none select-none items-center",s),...r,children:[e.jsx(zs,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(qs,{className:"absolute h-full bg-primary"})}),e.jsx(Os,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));gt.displayName=ft.displayName;const Ks=({handoverSessionId:s,onFuelLevelChange:r,onMileageChange:t,onStepComplete:n,initialFuelLevel:c,initialMileage:o})=>{const[i,f]=d.useState(c||50),[a,g]=d.useState((o==null?void 0:o.toString())||""),y=l=>{const p=l[0];f(p),r(p)},h=l=>{g(l);const p=parseInt(l,10);isNaN(p)||t(p)},u=a!==""&&!isNaN(parseInt(a,10))&&parseInt(a,10)>0,P=()=>{u?(n(),S.success("Fuel level and mileage recorded successfully")):S.error("Please enter a valid mileage reading")};return e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Nt,{className:"h-5 w-5"}),"Fuel Level & Mileage Check"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Record the current fuel level and vehicle mileage for documentation"})]}),e.jsxs(O,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Te,{className:"text-sm font-medium",children:"Fuel Level (%)"}),e.jsxs("div",{className:"mt-2",children:[e.jsx(gt,{value:[i],onValueChange:y,max:100,min:0,step:5,className:"w-full"}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground mt-1",children:[e.jsx("span",{children:"Empty (0%)"}),e.jsxs("span",{className:"font-medium",children:[i,"%"]}),e.jsx("span",{children:"Full (100%)"})]})]})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("div",{className:"relative w-32 h-32 border-4 border-gray-300 rounded-full",children:[e.jsx("div",{className:"absolute inset-2 rounded-full transition-all duration-300",style:{background:`conic-gradient(
                    ${i<=25?"#ef4444":i<=50?"#f59e0b":"#10b981"} 0deg,
                    ${i<=25?"#ef4444":i<=50?"#f59e0b":"#10b981"} ${i/100*360}deg,
                    #e5e7eb ${i/100*360}deg
                  )`}}),e.jsx("div",{className:"absolute inset-4 bg-white rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-bold",children:[i,"%"]})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Te,{htmlFor:"mileage",className:"text-sm font-medium",children:"Current Mileage (km)"}),e.jsxs("div",{className:"relative",children:[e.jsx(is,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(We,{id:"mileage",type:"number",placeholder:"Enter current mileage",value:a,onChange:l=>h(l.target.value),className:"pl-10",min:"0"})]}),a&&!isNaN(parseInt(a,10))&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Recorded: ",parseInt(a,10).toLocaleString()," kilometers"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Summary"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Fuel Level:"}),e.jsxs("p",{className:"font-medium",children:[i,"%"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Mileage:"}),e.jsx("p",{className:"font-medium",children:a?`${parseInt(a,10).toLocaleString()} km`:"Not entered"})]})]})]}),e.jsx(A,{onClick:P,disabled:!u,className:"w-full",children:"Complete Fuel & Mileage Check"}),!u&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please enter a valid mileage reading to proceed"})})]})]})},Ys=({handoverSessionId:s,otherUserName:r,isHost:t,onStepComplete:n})=>{const[c,o]=d.useState(!1),[i,f]=d.useState(!1),[a,g]=d.useState(!1),y=c&&i&&a,h=()=>{y&&(n(),S.success("Key transfer completed successfully"))};return e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"h-5 w-5"}),"Key Transfer"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?`Transfer vehicle keys to ${r}`:`Receive vehicle keys from ${r}`})]}),e.jsxs(O,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(be,{id:"key-transferred",checked:c,onCheckedChange:u=>o(u)}),e.jsx("label",{htmlFor:"key-transferred",className:"text-sm font-medium",children:t?`I have handed over the main vehicle key to ${r}`:`I have received the main vehicle key from ${r}`})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(be,{id:"key-received",checked:i,onCheckedChange:u=>f(u)}),e.jsx("label",{htmlFor:"key-received",className:"text-sm font-medium",children:t?`${r} has confirmed receipt of the vehicle key`:"I confirm that the vehicle key is working properly"})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(be,{id:"spares-confirmed",checked:a,onCheckedChange:u=>g(u)}),e.jsx("label",{htmlFor:"spares-confirmed",className:"text-sm font-medium",children:"All spare keys and remote controls have been accounted for"})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Key Transfer Instructions"}),e.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[e.jsx("li",{children:"• Ensure all keys and remotes are functioning properly"}),e.jsx("li",{children:"• Test remote locking/unlocking if applicable"}),e.jsx("li",{children:"• Verify spare key locations if any"}),e.jsx("li",{children:"• Check if any keys have special instructions"})]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsx("span",{className:"text-sm font-medium",children:"Main Vehicle Key"}),e.jsx("div",{className:"flex items-center gap-2",children:c&&i?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm text-green-600",children:"Transferred"})]}):e.jsx("span",{className:"text-sm text-muted-foreground",children:"Pending"})})]})}),e.jsx(A,{onClick:h,disabled:!y,className:"w-full",children:"Complete Key Transfer"}),!y&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-sm",children:"Please complete all key transfer confirmations to proceed"})})]})]})},Ws=({handoverSessionId:s,onSignatureComplete:r,initialSignature:t})=>{const n=d.useRef(null),[c,o]=d.useState(!1),[i,f]=d.useState(!!t),[a,g]=d.useState(t||null),y=p=>{p.preventDefault(),o(!0);const m=n.current;if(!m)return;const v=m.getBoundingClientRect(),w=m.width/v.width,M=m.height/v.height,b=m.getContext("2d");if(!b)return;b.lineWidth=2,b.lineCap="round",b.strokeStyle="#000";let L,N;"touches"in p?(L=(p.touches[0].clientX-v.left)*w,N=(p.touches[0].clientY-v.top)*M):(L=(p.clientX-v.left)*w,N=(p.clientY-v.top)*M),b.beginPath(),b.moveTo(L,N)},h=p=>{if(!c)return;p.preventDefault();const m=n.current,v=m==null?void 0:m.getContext("2d");if(!m||!v)return;const w=m.getBoundingClientRect(),M=m.width/w.width,b=m.height/w.height;let L,N;"touches"in p?(L=(p.touches[0].clientX-w.left)*M,N=(p.touches[0].clientY-w.top)*b):(L=(p.clientX-w.left)*M,N=(p.clientY-w.top)*b),v.lineTo(L,N),v.stroke(),f(!0)},u=()=>{o(!1)},P=()=>{const p=n.current,m=p==null?void 0:p.getContext("2d");!p||!m||(m.clearRect(0,0,p.width,p.height),f(!1),g(null))},l=()=>{const p=n.current;if(!p||!i)return;const m=p.toDataURL("image/png");g(m),r(m),S.success("Digital signature captured successfully")};return d.useState(()=>{if(t&&n.current){const m=n.current.getContext("2d"),v=new Image;v.onload=()=>{m==null||m.drawImage(v,0,0)},v.src=t}}),e.jsxs(q,{className:"w-full",children:[e.jsxs(re,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(ds,{className:"h-5 w-5"}),"Digital Signature"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please sign below to acknowledge the handover agreement"})]}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:[e.jsx("canvas",{ref:n,width:400,height:200,className:"w-full h-48 border border-gray-200 rounded cursor-crosshair touch-none",onMouseDown:y,onMouseMove:h,onMouseUp:u,onMouseLeave:u,onTouchStart:y,onTouchMove:h,onTouchEnd:u,style:{touchAction:"none"}}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Sign above using your mouse or finger"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(A,{variant:"outline",onClick:P,disabled:!i,className:"flex-1",children:[e.jsx(Jt,{className:"h-4 w-4 mr-2"}),"Clear"]}),e.jsxs(A,{onClick:l,disabled:!i,className:"flex-1",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"Confirm Signature"]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 text-sm",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Handover Agreement"}),e.jsx("p",{className:"text-muted-foreground",children:"By signing above, I acknowledge that:"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• I have completed the vehicle inspection process"}),e.jsx("li",{children:"• All documented conditions are accurate"}),e.jsx("li",{children:"• I understand my responsibilities during the rental period"}),e.jsx("li",{children:"• I agree to the terms and conditions of this handover"})]})]}),a&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsx("p",{className:"text-green-800 text-sm",children:"✅ Digital signature captured and ready for submission"})})]})]})},Gs=({currentStep:s,totalDistance:r,totalDuration:t,isNavigating:n,onToggleVoice:c,isVoiceEnabled:o,onStopNavigation:i,onArrived:f,destination:a,showArrivedButton:g=!1})=>{const[y,h]=d.useState("");d.useEffect(()=>{if(t>0){const l=new Date(Date.now()+t*1e3);h(l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}))}},[t]);const u=l=>l<1e3?`${Math.round(l)}m`:`${(l/1e3).toFixed(1)}km`,P=l=>{const p=Math.floor(l/60);if(p<1)return"< 1 min";if(p<60)return`${p} min`;const m=Math.floor(p/60),v=p%60;return`${m}h ${v}m`};return!n||!s?null:e.jsx(q,{className:"mx-4 mt-4 shadow-lg border-primary/20",children:e.jsxs(O,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ye,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["To ",a]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{variant:"ghost",size:"sm",onClick:c,className:"h-8 w-8 p-0",children:o?e.jsx(us,{className:"h-4 w-4"}):e.jsx(ms,{className:"h-4 w-4"})}),e.jsx(A,{variant:"outline",size:"sm",onClick:i,className:"text-xs",children:"Stop"})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 mb-4",children:[e.jsx("div",{className:"bg-primary/10 p-2 rounded-lg mt-1",children:e.jsx(ke,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-lg font-semibold text-foreground mb-1",children:s.instruction}),s.road_name&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["on ",s.road_name]}),e.jsx("div",{className:"flex items-center space-x-1 mt-2",children:e.jsx(ee,{variant:"secondary",className:"text-xs",children:u(s.distance)})})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm bg-muted/50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(et,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:P(t)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"text-muted-foreground",children:u(r)})}),y&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("span",{className:"text-muted-foreground",children:["ETA ",y]})]})]}),g&&f&&e.jsx("div",{className:"mt-4 pt-4 border-t border-muted",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Used alternative navigation or already arrived?"}),e.jsx(A,{onClick:f,className:"bg-green-600 hover:bg-green-700 text-white",size:"sm",children:"I've Arrived"})]})})]})})},Xs=({steps:s,currentStepIndex:r,onStepClick:t,className:n=""})=>{const c=a=>a<1e3?`${Math.round(a)}m`:`${(a/1e3).toFixed(1)}km`,o=a=>a===0?e.jsx(ye,{className:"h-4 w-4"}):a===s.length-1?e.jsx(Zt,{className:"h-4 w-4"}):e.jsx(ke,{className:"h-4 w-4"}),i=a=>a<r?"text-muted-foreground":a===r?"text-primary":"text-foreground",f=a=>a<r?"bg-muted/50":a===r?"bg-primary/10 border-primary/20":"bg-background";return e.jsxs(q,{className:n,children:[e.jsx(re,{className:"pb-3",children:e.jsxs(ae,{className:"text-lg flex items-center gap-2",children:[e.jsx(ke,{className:"h-5 w-5"}),"Turn-by-Turn Directions"]})}),e.jsx(O,{className:"p-0",children:e.jsx(Be,{className:"h-[400px]",children:e.jsx("div",{className:"space-y-2 p-4",children:s.map((a,g)=>e.jsxs("div",{className:`
                  flex items-start space-x-3 p-3 rounded-lg border transition-all
                  ${f(g)}
                  ${t?"cursor-pointer hover:bg-muted/30":""}
                  ${g===r?"border-primary/20":"border-transparent"}
                `,onClick:()=>t==null?void 0:t(g),children:[e.jsx("div",{className:`mt-1 ${i(g)}`,children:o(g)}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:`text-sm font-medium ${i(g)}`,children:a.instruction}),a.road_name&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["on ",a.road_name]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-2",children:[e.jsx(ee,{variant:"secondary",className:"text-xs shrink-0",children:c(a.distance)}),g===r&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full animate-pulse"})]})]})}),t&&e.jsx(It,{className:"h-4 w-4 text-muted-foreground mt-1"})]},g))})})})]})},Qs=()=>{const[s,r]=d.useState(null),[t,n]=d.useState(!1),[c,o]=d.useState(null);return{userLocation:s,isTracking:t,error:c,startTracking:()=>{if(!navigator.geolocation){const h="Geolocation is not supported by this browser";o(h),S.error(h);return}n(!0),o(null);const g={enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4},y=navigator.geolocation.watchPosition(h=>{const u={latitude:h.coords.latitude,longitude:h.coords.longitude,accuracy:h.coords.accuracy};r(u),o(null)},h=>{let u="Failed to get location";switch(h.code){case h.PERMISSION_DENIED:u="Location access denied. Please enable location permissions.";break;case h.POSITION_UNAVAILABLE:u="Location information is unavailable.";break;case h.TIMEOUT:u="Location request timed out.";break}o(u),S.error(u),n(!1)},g);return()=>{navigator.geolocation.clearWatch(y),n(!1)}},stopTracking:()=>{n(!1),r(null),o(null)},getCurrentLocation:()=>new Promise((g,y)=>{if(!navigator.geolocation){y(new Error("Geolocation is not supported"));return}navigator.geolocation.getCurrentPosition(h=>{const u={latitude:h.coords.latitude,longitude:h.coords.longitude,accuracy:h.coords.accuracy};g(u)},h=>{let u="Failed to get location";switch(h.code){case h.PERMISSION_DENIED:u="Location access denied";break;case h.POSITION_UNAVAILABLE:u="Location information unavailable";break;case h.TIMEOUT:u="Location request timed out";break}y(new Error(u))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4})})}},oe=class oe{constructor(){ne(this,"mapboxToken",null)}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}async initialize(){try{return this.mapboxToken=await Xe(),!!this.mapboxToken}catch(r){return console.error("Failed to initialize navigation service:",r),S.error("Navigation service unavailable"),!1}}async getRoute(r){if(!this.mapboxToken&&(await this.initialize(),!this.mapboxToken))throw new Error("Navigation service not initialized");const{origin:t,destination:n,profile:c="driving"}=r;try{const o=await fetch(`https://api.mapbox.com/directions/v5/mapbox/${c}/${t.longitude},${t.latitude};${n.longitude},${n.latitude}?steps=true&geometries=geojson&overview=full&access_token=${this.mapboxToken}`),i=await o.json();if(!o.ok)throw new Error(i.message||"Failed to get route");if(!i.routes||i.routes.length===0)throw new Error("No route found");const f=i.routes[0];return{geometry:f.geometry,distance:f.distance,duration:f.duration,steps:f.legs[0].steps.map(a=>({instruction:a.maneuver.instruction,distance:a.distance,duration:a.duration,maneuver:a.maneuver.type,road_name:a.name,geometry:a.geometry}))}}catch(o){return console.error("Error fetching route:",o),S.error("Unable to calculate route"),null}}async getDirections(r,t){const n=await this.getRoute({origin:r,destination:t});return(n==null?void 0:n.steps)||[]}calculateDistance(r,t,n,c){const i=r*Math.PI/180,f=n*Math.PI/180,a=(n-r)*Math.PI/180,g=(c-t)*Math.PI/180,y=Math.sin(a/2)*Math.sin(a/2)+Math.cos(i)*Math.cos(f)*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y)))}formatDistance(r){return r<1e3?`${Math.round(r)}m`:`${(r/1e3).toFixed(1)}km`}formatDuration(r){const t=Math.floor(r/60);if(t<1)return"< 1 min";if(t<60)return`${t} min`;const n=Math.floor(t/60),c=t%60;return`${n}h ${c}m`}};ne(oe,"instance");let Re=oe;const Ue=Re.getInstance(),Js=({handoverSessionId:s,destinationLocation:r,otherUserName:t,isHost:n,onStepComplete:c,onNavigationStart:o})=>{const{userLocation:i,getCurrentLocation:f}=Qs(),[a,g]=d.useState(!1),[y,h]=d.useState(!1),[u,P]=d.useState([]),[l,p]=d.useState(0),[m,v]=d.useState(0),[w,M]=d.useState(0),[b,L]=d.useState(!1),[N]=d.useState(50),[H,U]=d.useState(!1),[B,E]=d.useState(null),[C,T]=d.useState(!1);d.useEffect(()=>{(async()=>{const x=await Ue.initialize();U(x)})()},[]);const R=(j,x,D,X)=>{const J=j*Math.PI/180,Z=D*Math.PI/180,ie=(D-j)*Math.PI/180,de=(X-x)*Math.PI/180,fe=Math.sin(ie/2)*Math.sin(ie/2)+Math.cos(J)*Math.cos(Z)*Math.sin(de/2)*Math.sin(de/2);return 6371e3*(2*Math.atan2(Math.sqrt(fe),Math.sqrt(1-fe)))};d.useEffect(()=>{if(!i||!a||y)return;if(R(i.latitude,i.longitude,r.latitude,r.longitude)<=N&&(h(!0),g(!1),S.success("You have arrived at the handover location!"),b&&"speechSynthesis"in window)){const x=new SpeechSynthesisUtterance("You have arrived at your destination");speechSynthesis.speak(x)}},[i,r,a,y,N,b]);const V=async()=>{let j=i;if(!j)try{j=await f(),E(null)}catch{return E("Unable to access your location. Please check your GPS settings."),T(!0),!1}if(!H)return E("Navigation service is not available."),T(!0),!1;try{const x=await Ue.getRoute({origin:j,destination:r});if(x)return v(x.distance),M(x.duration),P(x.steps),!0;throw new Error("No route found")}catch(x){return console.error("Error fetching route:",x),E("Unable to calculate route."),T(!0),!1}},Q=async()=>{await V()&&(g(!0),p(0),o==null||o(),S.success("Navigation started"))},K=()=>{h(!0),S.success("You've arrived at the handover location!")},Y=()=>{g(!1),p(0),S.info("Navigation stopped")},G=()=>{L(!b),S.info(b?"Voice guidance disabled":"Voice guidance enabled")},k=()=>{c(),S.success("Ready to begin handover process")},W=()=>{h(!0),g(!1),S.success("Marked as arrived - ready for handover!")},I=u[l]||null,_=y?100:l/Math.max(u.length-1,1)*100;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(q,{children:[e.jsx(re,{children:e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Le,{className:"h-5 w-5"}),"Navigate to Handover Location"]})}),e.jsxs(O,{className:"space-y-4",children:[!a&&!y&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs(A,{onClick:Q,size:"lg",className:"w-full",disabled:!H,children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Start Navigation"]}),e.jsxs(A,{onClick:()=>T(!0),variant:"outline",size:"lg",className:"w-full",children:[e.jsx(cs,{className:"h-4 w-4 mr-2"}),"I've Already Arrived"]}),!H&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx(xe,{className:"h-4 w-4 inline mr-1"}),"Loading navigation service..."]})]}),B&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsx(xe,{className:"h-5 w-5 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-medium text-yellow-800",children:"Location Access Issue"}),e.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:B})]})]})}),C&&!y&&e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-blue-800 mb-2",children:"Alternative Options"}),e.jsx("p",{className:"text-sm text-blue-700 mb-3",children:"If you're unable to use GPS navigation, you can still proceed:"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(A,{onClick:K,size:"lg",className:"w-full",variant:"default",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"I've Arrived at Location"]}),e.jsx(A,{onClick:()=>{T(!1),E(null)},size:"sm",variant:"ghost",className:"w-full",children:"Try Navigation Again"})]})]})}),(a||y)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(et,{className:"h-4 w-4"}),"Navigation Progress"]}),e.jsxs("span",{children:[Math.round(_),"%"]})]}),e.jsx(Se,{value:_,className:"h-2"})]}),y&&e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx(se,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"text-green-800 font-medium",children:"You've arrived at the handover location!"}),e.jsx("p",{className:"text-green-700 text-sm mt-1",children:n?"Wait for the renter to arrive":"Look for the host and their vehicle"})]}),e.jsxs(A,{onClick:k,size:"lg",className:"w-full",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"I'm Ready for Handover"]})]})]})]}),a&&I&&e.jsx(Gs,{currentStep:I,totalDistance:m,totalDuration:w,isNavigating:a,onToggleVoice:G,isVoiceEnabled:b,onStopNavigation:Y,onArrived:W,destination:r.address,showArrivedButton:!0}),a&&u.length>0&&e.jsx(Xs,{steps:u,currentStepIndex:l,onStepClick:j=>p(j)})]})},Zs=({isHost:s,onClose:r,duration:t=3e3})=>{const[n,c]=d.useState(!0);d.useEffect(()=>{console.log("HandoverSuccessPopup mounted with duration:",t);const i=setTimeout(()=>{console.log("HandoverSuccessPopup timer fired, setting invisible"),c(!1),setTimeout(()=>{console.log("HandoverSuccessPopup calling onClose"),r()},300)},t);return()=>{console.log("HandoverSuccessPopup cleanup"),clearTimeout(i)}},[t,r]);const o=s?"See you soon!":"Have a nice trip!";return e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-50 pointer-events-none",children:e.jsx(q,{className:`
          bg-white/95 backdrop-blur-sm shadow-2xl border-2 border-primary/20 
          p-6 rounded-2xl transition-all duration-300 transform
          ${n?"scale-100 opacity-100":"scale-95 opacity-0"}
        `,children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Je,{className:"h-8 w-8 text-primary"}),e.jsx(se,{className:"h-4 w-4 text-green-500 absolute -top-1 -right-1 bg-white rounded-full"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-1",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:o})]})]})})})},pt=s=>{const[r,t]=d.useState(null),[n,c]=d.useState(!0),[o,i]=d.useState(null),f=async()=>{if(!s){c(!1);return}try{c(!0);const{data:a,error:g}=await F.rpc("calculate_handover_progress",{handover_session_id_param:s});if(g)throw g;t(a&&typeof a=="object"?a:null),i(null)}catch(a){console.error("Error fetching handover progress:",a),i("Failed to load handover progress")}finally{c(!1)}};return d.useEffect(()=>{f()},[s]),d.useEffect(()=>{if(!s)return;console.log("Setting up real-time subscription for handover:",s);const a=F.channel(`handover_progress_${s}`).on("postgres_changes",{event:"*",schema:"public",table:"handover_step_completion",filter:`handover_session_id=eq.${s}`},async g=>{var y,h;if(console.log("Handover step completion changed:",g),await f(),g.eventType==="UPDATE"&&((y=g.new)!=null&&y.is_completed)){const u=(h=g.new.step_name)==null?void 0:h.replace(/_/g," ");S.success(`${u} completed!`)}}).on("postgres_changes",{event:"*",schema:"public",table:"handover_sessions",filter:`id=eq.${s}`},g=>{var y;console.log("Handover session changed:",g),g.eventType==="UPDATE"&&((y=g.new)!=null&&y.handover_completed)&&S.success("Handover process completed successfully!")}).subscribe(g=>{console.log("Real-time subscription status:",g),g==="SUBSCRIBED"?console.log("Successfully subscribed to handover updates"):g==="CHANNEL_ERROR"&&(console.error("Failed to subscribe to handover updates"),i("Real-time updates unavailable"))});return()=>{console.log("Cleaning up handover real-time subscription"),F.removeChannel(a)}},[s]),{handoverProgress:r,isLoading:n,error:o}},er=({handoverSessionId:s,showDetailed:r=!1})=>{const{handoverProgress:t,isLoading:n,error:c}=pt(s);if(n)return e.jsx(q,{className:"w-full",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(es,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Loading progress..."})]})})});if(c||!t)return e.jsx(q,{className:"w-full",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2 text-destructive",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:c||"Unable to load progress"})]})})});const o=()=>t.is_completed?e.jsx(se,{className:"h-5 w-5 text-green-600"}):e.jsx(Me,{className:"h-5 w-5 text-blue-600"}),i=()=>t.is_completed?"Handover Complete":`Step ${t.current_step} of ${t.total_steps}`;return r?e.jsxs(q,{className:"w-full",children:[e.jsx(re,{className:"pb-3",children:e.jsxs(ae,{className:"flex items-center space-x-2",children:[o(),e.jsx("span",{children:"Handover Progress"})]})}),e.jsxs(O,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:i()}),e.jsxs(ee,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]}),e.jsx(Se,{value:t.progress_percentage,className:"h-3"})]}),e.jsxs("div",{className:"flex justify-between text-sm text-muted-foreground",children:[e.jsxs("span",{children:[t.completed_steps," completed"]}),e.jsxs("span",{children:[t.total_steps-t.completed_steps," remaining"]})]}),t.is_completed&&e.jsx("div",{className:"mt-4 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(se,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-800",children:"All handover steps completed successfully!"})]})})]})]}):e.jsxs("div",{className:"flex items-center space-x-2",children:[o(),e.jsx("div",{className:"flex-1",children:e.jsx(Se,{value:t.progress_percentage,className:"h-2"})}),e.jsxs(ee,{variant:t.is_completed?"default":"secondary",children:[Math.round(t.progress_percentage),"%"]})]})},tr=({isOpen:s,onClose:r,bookingId:t})=>{var Y,G;const n=Ve(),{isLoading:c,isHandoverSessionLoading:o,isHost:i,bookingDetails:f,handoverId:a,currentUserId:g}=ze();pt(a);const[y,h]=d.useState(0),[u,P]=d.useState([]),[l,p]=d.useState([]),[m,v]=d.useState([]),[w,M]=d.useState(),[b,L]=d.useState(),[N,H]=d.useState(),[U,B]=d.useState(!1),E=d.useCallback(async()=>{if(!a){console.error("Cannot initialize handover: missing handover session ID"),S.error("Handover session not found");return}console.log("Initializing handover for session:",a);try{await js(a);const k=await $e(a);console.log("Loaded handover steps:",k),console.log("Steps completion status:",k.map(j=>({name:j.step_name,completed:j.is_completed}))),P(k);const W=k.findIndex(j=>!j.is_completed),I=W>=0?W:k.length;console.log("First incomplete step index:",W),console.log("Setting current step to:",I),h(I);const _=k.filter(j=>j.is_completed).length;_>0&&S.success(`Continuing handover process - ${_}/${k.length} steps completed`),console.log("Handover initialized successfully")}catch(k){console.error("Error initializing handover:",k),S.error("Failed to initialize handover process")}},[a]);d.useEffect(()=>{a&&s&&!o&&E()},[a,s,o,E]);const C=async(k,W)=>{if(!a){S.error("Handover session not found");return}if(console.log(`Attempting to complete step: ${k}`),await ws(a,k,W)){const _=await $e(a);P(_);const j=_.findIndex(x=>!x.is_completed);j>=0?(h(j),console.log(`Moving to next step: ${j}`)):(console.log("All steps completed, checking if handover should be finalized"),_.every(D=>D.is_completed)&&await T())}},T=async()=>{console.log("Starting handover completion...");try{if(a&&(console.log("Completing handover session:",a),await Dt(a)),l.length>0||m.length>0||w!==void 0||b!==void 0){console.log("Creating vehicle condition report...");const k={handover_session_id:a,booking_id:(f==null?void 0:f.id)||"",car_id:(f==null?void 0:f.car_id)||"",report_type:"pickup",vehicle_photos:l,damage_reports:m,fuel_level:w,mileage:b,digital_signature_data:N,is_acknowledged:!0,reporter_id:g};if(!await Ns(k))throw new Error("Failed to create vehicle condition report");console.log("Vehicle condition report created successfully")}console.log("Setting handover completed to true, isHost:",i),B(!0)}catch(k){console.error("Error completing handover:",k),S.error("Failed to complete handover. Please try again.")}},R=()=>{console.log("Success popup closing, isHost:",i),B(!1);const k=new URL(window.location.href);k.searchParams.delete("mode"),k.searchParams.delete("bookingId"),window.history.replaceState({},"",k.pathname+k.search),r(),i?(console.log("Navigating to host-bookings"),n("/host-bookings")):(console.log("Navigating to renter-bookings"),n("/renter-bookings"))},V=k=>{switch(k){case"navigation":return!0;case"identity_verification":return!0;case"vehicle_inspection_exterior":return l.filter(I=>I.type&&I.type.startsWith("exterior_")).length>=4;case"vehicle_inspection_interior":return l.filter(I=>I.type&&(I.type.startsWith("interior_")||["fuel_gauge","odometer"].includes(I.type))).length>=4;case"damage_documentation":return!0;case"fuel_mileage_check":return w!==void 0&&b!==void 0;case"key_transfer":return!0;case"digital_signature":return N!==void 0;default:return!0}},Q=(k,W)=>{var j,x,D,X;const I=f,_=i?I==null?void 0:I.renter:(j=I==null?void 0:I.cars)==null?void 0:j.owner;switch(k.name){case"navigation":{const $={latitude:(I==null?void 0:I.latitude)||((x=I==null?void 0:I.cars)==null?void 0:x.latitude)||-24.65451,longitude:(I==null?void 0:I.longitude)||((D=I==null?void 0:I.cars)==null?void 0:D.longitude)||25.90859,address:((X=I==null?void 0:I.cars)==null?void 0:X.location)||"Handover Location"};return e.jsx(Js,{handoverSessionId:a||"",destinationLocation:$,otherUserName:(_==null?void 0:_.full_name)||"User",isHost:i,onStepComplete:()=>C(k.name),onNavigationStart:()=>S.info("Navigation started. Follow the directions to reach the handover location.")})}case"identity_verification":return e.jsx(Ss,{handoverSessionId:a||"",otherUserId:(_==null?void 0:_.id)||"",otherUserName:(_==null?void 0:_.full_name)||"User",isHost:i,onStepComplete:()=>C(k.name)});case"vehicle_inspection_exterior":return l.filter($=>$.type.startsWith("exterior_")),e.jsx(Fe,{handoverSessionId:a||"",inspectionType:"exterior",onPhotosUpdate:$=>{const J=l.filter(Z=>Z.type&&!Z.type.startsWith("exterior_"));p([...J,...$])},onStepComplete:()=>C(k.name),initialPhotos:l.filter($=>$.type&&$.type.startsWith("exterior_"))});case"vehicle_inspection_interior":return l.filter($=>$.type.startsWith("interior_")||["fuel_gauge","odometer"].includes($.type)),e.jsx(Fe,{handoverSessionId:a||"",inspectionType:"interior",onPhotosUpdate:$=>{const J=l.filter(Z=>Z.type&&!Z.type.startsWith("interior_")&&!["fuel_gauge","odometer"].includes(Z.type));p([...J,...$])},onStepComplete:()=>C(k.name),initialPhotos:l.filter($=>$.type&&($.type.startsWith("interior_")||["fuel_gauge","odometer"].includes($.type)))});case"damage_documentation":return e.jsx(Cs,{handoverSessionId:a||"",onDamageReportsUpdate:v,onStepComplete:()=>C(k.name),initialReports:m});case"fuel_mileage_check":return e.jsx(Ks,{handoverSessionId:a||"",onFuelLevelChange:M,onMileageChange:L,onStepComplete:()=>C(k.name,{fuel_level:w,mileage:b}),initialFuelLevel:w,initialMileage:b});case"key_transfer":return e.jsx(Ys,{handoverSessionId:a||"",otherUserName:(_==null?void 0:_.full_name)||"User",isHost:i,onStepComplete:()=>C(k.name)});case"digital_signature":return e.jsx(Ws,{handoverSessionId:a||"",onSignatureComplete:$=>{H($),C(k.name,{signature:$})},initialSignature:N});default:return e.jsx(q,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-medium mb-2",children:k.title}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:k.description}),e.jsxs(A,{onClick:()=>C(k.name),disabled:!V(k.name),children:["Complete ",k.title]})]})})})}};if(c||o)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(q,{className:"w-96",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:o?"Setting up handover session...":"Loading handover process..."})]})})})});if(!a&&!o)return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/50",children:e.jsx(q,{className:"w-96",children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(xe,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Session Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Unable to load the handover session. Please try refreshing the page."}),e.jsx(A,{onClick:r,variant:"outline",children:"Close"})]})})})});u.filter(k=>k.is_completed).length/ge.length*100;const K=ge[y];return e.jsxs(e.Fragment,{children:[U&&e.jsxs(e.Fragment,{children:[console.log("Rendering HandoverSuccessPopup with isHost:",i),e.jsx(Zs,{isHost:i,onClose:R})]}),e.jsxs("div",{className:"fixed inset-0 z-[9999] pointer-events-none",style:{display:s?"block":"none"},children:[e.jsx("div",{className:"absolute inset-0 bg-black/50 pointer-events-auto",onClick:r}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 h-[90vh] bg-background rounded-t-xl shadow-lg overflow-y-auto pointer-events-auto",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Vehicle Handover"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[(Y=f==null?void 0:f.cars)==null?void 0:Y.brand," ",(G=f==null?void 0:f.cars)==null?void 0:G.model]})]}),e.jsx("button",{onClick:r,className:"rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",children:e.jsx(pe,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(er,{handoverSessionId:a,showDetailed:!1})}),e.jsx("div",{className:"mb-6",children:e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-2",children:ge.map((k,W)=>{const I=u.find(x=>x.step_name===k.name),_=(I==null?void 0:I.is_completed)||!1,j=W===y;return e.jsxs("div",{className:`p-2 rounded-lg text-center border ${_?"bg-green-50 border-green-200 text-green-800":j?"bg-blue-50 border-blue-200 text-blue-800":"bg-gray-50 border-gray-200 text-gray-600"}`,children:[e.jsx("div",{className:"flex items-center justify-center mb-1",children:_?e.jsx(se,{className:"h-4 w-4"}):j?e.jsx(Me,{className:"h-4 w-4"}):e.jsx("div",{className:"h-4 w-4 rounded-full border-2 border-current"})}),e.jsx("span",{className:"text-xs font-medium",children:k.title})]},k.name)})})}),K?e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(ee,{variant:"outline",children:["Step ",y+1]}),e.jsx("span",{className:"font-medium",children:K.title})]}),Q(K)]}):e.jsx(q,{children:e.jsx(O,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx(se,{className:"h-12 w-12 text-green-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Handover Complete!"}),e.jsx("p",{className:"text-muted-foreground",children:"All handover steps have been completed successfully."})]})})})]})})]})]})},sr=({onBookingClick:s})=>{const{userId:r,userRole:t}=ts(),{data:n=[]}=yt({queryKey:["handover-bookings",r,t],queryFn:async()=>{try{if(!r||!t)return console.log("HandoverBookingButtons: No userId or userRole"),[];const o=new Date,i=new Date().toISOString().split("T")[0],f=new Date(Date.now()+24*60*60*1e3).toISOString().split("T")[0];console.log("HandoverBookingButtons: Fetching bookings",{userId:r,userRole:t,today:i,tomorrow:f});let a=F.from("bookings").select(`
            *,
            cars (
              brand,
              model,
              location,
              image_url,
              owner_id,
              price_per_day
            ),
            renter:profiles!renter_id (
              id,
              full_name,
              avatar_url,
              phone_number
            ),
            handover_sessions (
              id,
              handover_completed,
              created_at
            )
          `).eq("status","confirmed").or(`start_date.eq.${i},start_date.eq.${f},end_date.eq.${i}`);t==="renter"?a=a.eq("renter_id",r):t==="host"&&(a=a.eq("cars.owner_id",r));const{data:g,error:y}=await a;if(y)throw console.error("HandoverBookingButtons: Error fetching bookings:",y),new Error(`Failed to fetch handover bookings: ${y.message}`);if(!g)return console.log("HandoverBookingButtons: No data returned"),[];console.log("HandoverBookingButtons: Raw bookings data",g);const h=g.filter(u=>{var b;const P=new Date(u.start_date),l=new Date(u.end_date),p=(b=u.handover_sessions)==null?void 0:b[0];if(p!=null&&p.handover_completed)return!1;const v=P.toDateString()===o.toDateString()&&!p,M=l.toDateString()===o.toDateString()&&p&&!p.handover_completed;return v||M});return console.log("HandoverBookingButtons: Filtered bookings",h),h}catch(o){return console.error("HandoverBookingButtons: Query failed:",o),[]}},enabled:!!r&&!!t,refetchInterval:3e4,retry:(o,i)=>(console.warn("HandoverBookingButtons: Query failed, retry attempt",{failureCount:o,error:i}),o<2),retryDelay:o=>Math.min(1e3*2**o,3e4)}),c=({booking:o,index:i})=>{var p,m,v,w,M,b,L;const f=((p=o.cars)==null?void 0:p.image_url)||"/placeholder.svg",a=new Date,g=new Date(o.start_date),y=new Date(o.end_date),h=(m=o.handover_sessions)==null?void 0:m[0],u=g.toDateString()===a.toDateString(),P=y.toDateString()===a.toDateString();let l="pickup";return P&&h&&!h.handover_completed?l="return":u&&!h&&(l="pickup"),e.jsx(Tt,{children:e.jsxs(Ht,{children:[e.jsx(Lt,{asChild:!0,children:e.jsx("button",{onClick:N=>{N.preventDefault(),console.log("Handover button clicked for booking:",o.id,"type:",l),s(o.id,l)},className:`
                w-16 h-16 rounded-full border-4 border-primary/30 
                overflow-hidden shadow-lg hover:shadow-xl
                transition-all duration-300 hover:scale-110
                animate-pulse bg-background
                mb-3
              `,style:{animationDuration:`${2+i*.5}s`},children:e.jsx("img",{src:f,alt:`${(v=o.cars)==null?void 0:v.brand} ${(w=o.cars)==null?void 0:w.model}`,className:"w-full h-full object-cover",onError:N=>{N.currentTarget.src="/placeholder.svg"}})})}),e.jsx(At,{side:"right",className:"max-w-xs p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold text-sm",children:[(M=o.cars)==null?void 0:M.brand," ",(b=o.cars)==null?void 0:b.model]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(ss,{className:"h-3 w-3 mr-1"}),Ae(new Date(o.start_date),"MMM dd")," - ",Ae(new Date(o.end_date),"MMM dd")]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(ye,{className:"h-3 w-3 mr-1"}),(L=o.cars)==null?void 0:L.location]}),t==="host"&&o.renter&&e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(Qe,{className:"h-3 w-3 mr-1"}),o.renter.full_name]}),e.jsxs("div",{className:"flex items-center text-xs text-muted-foreground",children:[e.jsx(rs,{className:"h-3 w-3 mr-1"}),"BWP ",o.total_price]}),e.jsx("div",{className:"text-xs text-primary font-medium mt-2",children:"Click for handover details"})]})})]})},o.id)};return n.length?(console.log("Rendering handover buttons for bookings:",n.map(o=>o.id)),e.jsx("div",{className:"absolute top-4 left-4 z-10 flex flex-col",children:n.map((o,i)=>e.jsx(c,{booking:o,index:i},o.id))})):(console.log("No handover bookings found for user:",r,"role:",t),null)};class rr extends d.Component{constructor(){super(...arguments);ne(this,"maxRetries",3);ne(this,"state",{hasError:!1,error:null,errorInfo:null,retryCount:0});ne(this,"handleRetry",()=>{this.state.retryCount<this.maxRetries?(this.setState(t=>({hasError:!1,error:null,errorInfo:null,retryCount:t.retryCount+1})),S.info("Retrying handover process...")):S.error("Maximum retry attempts reached. Please refresh the page.")});ne(this,"handleReset",()=>{this.setState({hasError:!1,error:null,errorInfo:null,retryCount:0})});ne(this,"handleNavigateHome",()=>{const t=new URL(window.location.href);t.searchParams.delete("mode"),t.searchParams.delete("bookingId"),window.history.replaceState({},"",t.pathname),window.location.href="/"})}static getDerivedStateFromError(t){return{hasError:!0,error:t}}componentDidCatch(t,n){console.error("HandoverErrorBoundary caught an error:",t,n),this.setState({errorInfo:n}),this.props.onError&&this.props.onError(t,n);const c={error:t.message,stack:t.stack,componentStack:n.componentStack,timestamp:new Date().toISOString(),userAgent:navigator.userAgent};console.error("Handover Error Report:",c),S.error("A handover system error occurred. Please try again.")}render(){var t;if(this.state.hasError){if(this.props.fallback)return this.props.fallback;const n=this.state.retryCount<this.maxRetries,c=((t=this.state.error)==null?void 0:t.message)||"An unexpected error occurred";return e.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:e.jsxs($t,{className:"max-w-md",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsxs(Ft,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Handover System Error"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:c}),this.state.retryCount>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Retry attempt: ",this.state.retryCount,"/",this.maxRetries]})]}),e.jsxs("div",{className:"flex flex-col space-y-2",children:[n&&e.jsxs(A,{onClick:this.handleRetry,className:"w-full",variant:"outline",children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Retry Handover"]}),e.jsxs(A,{onClick:this.handleReset,className:"w-full",variant:"outline",children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Reset Process"]}),e.jsxs(A,{onClick:this.handleNavigateHome,className:"w-full",variant:"secondary",children:[e.jsx(as,{className:"mr-2 h-4 w-4"}),"Return to Dashboard"]})]}),!1]})]})})}return this.props.children}}const Ur=()=>{const[s]=wt(),r=s.get("mode"),t=s.get("bookingId"),{user:n}=Ut(),[c,o]=d.useState(""),[i,f]=d.useState(!0),[a,g]=d.useState([]),[y,h]=d.useState(!1),[u]=d.useState({latitude:null,longitude:null}),{theme:P}=Vt(),[l,p]=d.useState(!1),[m,v]=d.useState(!1),[w]=d.useState(null),M=async E=>{var C;try{const{data:T,error:R}=await F.from("bookings").select(`
          id, 
          status, 
          start_date, 
          end_date, 
          renter_id,
          cars!inner (
            owner_id
          )
        `).eq("id",E).eq("status","confirmed").single();if(R||!T)return console.log("Booking not found or not confirmed:",E),!1;const V=(C=T.cars)==null?void 0:C.owner_id;if(!n||n.id!==T.renter_id&&n.id!==V)return console.log("User does not have permission to access booking:",E),!1;const Q=new Date().toISOString().split("T")[0],K=T.start_date===Q,Y=T.end_date===Q;return!K&&!Y?(console.log("Booking is not eligible for handover today:",E),!1):!0}catch(T){return console.error("Error validating booking:",T),!1}};d.useEffect(()=>{(async()=>{if(!(r==="handover"&&t)){p(!1);return}if(!n)return;if(v(!0),await M(t))p(!0);else{const R=new URL(window.location.href);R.searchParams.delete("mode"),R.searchParams.delete("bookingId"),window.history.replaceState({},"",R.pathname+R.search),S.info("Invalid handover request - showing standard map"),p(!1)}v(!1)})()},[r,t,n]),d.useEffect(()=>{l&&!y&&h(!0)},[l]),d.useEffect(()=>{(async()=>{f(!0);try{const C=await Xe();if(!C){S.error("Failed to get the map token"),console.error("Failed to get the map token");return}o(C)}catch(C){console.error("Error getting the map token:",C),S.error("Failed to get the map token")}finally{f(!1)}})()},[]);const b=async()=>{var E,C;if(!n)return null;try{const{data:T,error:R}=await F.from("handover_sessions").select(`
          host_id,
          host_location,
          bookings!inner(
            car_id,
            cars!inner(
              owner_id,
              profiles!owner_id(id, full_name, avatar_url, latitude, longitude)
            )
          )
        `).eq("renter_id",n.id).eq("handover_completed",!1).single();if(R||!T)return console.log("No active handover session found"),null;const V=(C=(E=T.bookings)==null?void 0:E.cars)==null?void 0:C.profiles;if(V!=null&&V.latitude&&(V!=null&&V.longitude))return{id:V.id,full_name:V.full_name,avatar_url:V.avatar_url,latitude:V.latitude,longitude:V.longitude,updated_at:null,isActiveHandover:!0}}catch(T){console.error("Error fetching active handover host:",T)}return null},L=async()=>{console.log("Fetching host locations...");try{const E=await ys();console.log("Online hosts fetched:",E);const C=await b();console.log("Active handover host:",C);const T=[...E];if(C){const R=T.findIndex(V=>V.id===C.id);R>=0?T[R]=C:T.push(C)}T.length||S.info("No hosts are currently online"),console.log("All host locations to display:",T),g(T)}catch(E){console.error("Error fetching host locations:",E),S.error("Failed to fetch host locations")}};d.useEffect(()=>{l||(L(),console.log("Location",u))},[l]);const N=()=>P==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1",H=()=>i||m?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-muted-foreground dark:text-gray-400 mb-3",children:m?"Validating handover...":"Loading map..."}),e.jsx(qt,{color:"#7c3aed",width:100})]}):c?e.jsx(ps,{mapbox_token:c,longitude:25.90859,latitude:-24.65451,onlineHosts:l?[]:a,mapStyle:N(),isHandoverMode:l,bookingId:t,dpad:!0,locationToggle:!0,destination:u}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full w-full bg-muted/20 dark:bg-gray-800/20",children:[e.jsx("p",{className:"text-sm text-destructive font-medium",children:"Could not load the map"}),e.jsx("p",{className:"text-xs text-muted-foreground dark:text-gray-400 mt-1",children:"Please check your connection"})]}),U=!!n&&l,B=e.jsxs("div",{className:"flex flex-col h-screen bg-background",children:[e.jsxs("main",{className:"flex-1 relative overflow-hidden",children:[H(),U&&e.jsxs(rr,{children:[e.jsx(sr,{onBookingClick:(E,C)=>{if(console.log("Map received booking click for:",E,"type:",C),console.log("Current booking ID from URL:",t),console.log("Current handover sheet state:",y),C==="return"){window.location.href=`/rental-details/${E}`;return}E!==t&&(console.log("Updating URL with new booking ID"),window.history.replaceState({},"",`/map?mode=handover&bookingId=${E}`)),console.log("Opening handover sheet"),h(!0)}}),e.jsx(tr,{isOpen:y,onClose:()=>{h(!1);const E=new URL(window.location.href);E.searchParams.delete("mode"),E.searchParams.delete("bookingId"),window.history.replaceState({},"",E.pathname+E.search)},bookingId:t||""})]})]}),e.jsx(bt,{})]});return e.jsx(Bt,{children:U?e.jsx(zt,{children:B}):B})};export{Ur as default};
