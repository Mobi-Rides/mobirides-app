import{j as e}from"./query-vendor-C7aRRP05.js";import{s as f,J as i,f as y,S as E,g as C,h as I,i as v,k as w}from"./index-CfXH57CA.js";import{S as L}from"./switch-CP7ZR25t.js";import{r as m}from"./react-vendor-mnpoGfEl.js";import{d as U}from"./index-DE7TNQN2.js";const j=o=>o&&typeof o=="object"&&"is_sharing_location"in o&&"location_sharing_scope"in o,k=(o,s)=>{const t={is_sharing_location:o,updated_at:new Date().toISOString()};return s&&(t.latitude=s.latitude,t.longitude=s.longitude),t},O=()=>{const[o,s]=m.useState(null),[t,r]=m.useState(!1),[g,c]=m.useState("all"),[x,n]=m.useState(!0),[h,a]=m.useState(null);m.useEffect(()=>{console.log("useLocationSharing: Initializing hook"),(async()=>{const{data:{session:u}}=await f.auth.getSession();if(!u){console.log("No active session found"),s(null),n(!1);return}console.log("Active session found, user ID:",u.user.id),s(u.user.id),d(u.user.id)})();const{data:{subscription:l}}=f.auth.onAuthStateChange((u,_)=>{console.log("Location sharing auth state changed:",u),u==="SIGNED_IN"&&_?(console.log("User signed in, fetching location status"),s(_.user.id),d(_.user.id)):u==="SIGNED_OUT"&&(console.log("User signed out, resetting location sharing state"),s(null),r(!1),c("all"),n(!1))});return()=>{console.log("useLocationSharing: Cleaning up subscription"),l.unsubscribe()}},[]);const d=async p=>{if(!p){console.log("No user ID provided to fetchUserStatus"),n(!1);return}try{console.log("Fetching user profile for location status..."),n(!0),a(null);const{data:l,error:u}=await f.from("profiles").select("is_sharing_location, location_sharing_scope, latitude, longitude").limit(1);if(u){console.error("Error checking for columns:",u),a("Could not verify location columns"),n(!1);return}if(!(l&&l.length>0&&"is_sharing_location"in l[0]&&"location_sharing_scope"in l[0])){console.error("Required location columns don't exist in the profiles table"),a("Location sharing is not supported"),n(!1);return}const{data:b,error:N}=await f.from("profiles").select("*").eq("id",p).single();if(N){console.error("Error fetching profile:",N),a("Could not fetch profile"),n(!1);return}console.log("Profile data received:",b);const S=b;j(S)?(console.log("Location fields exist, setting state based on profile:",{is_sharing_location:S.is_sharing_location,location_sharing_scope:S.location_sharing_scope}),r(S.is_sharing_location??!1),c(S.location_sharing_scope??"all"),a(null)):(console.warn("Location sharing fields may not exist in profiles table"),a("Location sharing fields not available"),r(!1),c("all"))}catch(l){console.error("Error fetching user status:",l),i.error("Could not load location sharing status")}finally{n(!1)}};return{userId:o,isSharingLocation:t,sharingScope:g,isLoading:x,errorMessage:h,setIsSharingLocation:r,fetchUserStatus:o?()=>d(o):null}},D=async({userId:o,lat:s,long:t})=>{try{return navigator.geolocation?new Promise(r=>{(async()=>{try{console.log("Got coordinates:",s,t);const g=k(!0,{latitude:s,longitude:t}),{error:c}=await f.from("profiles").update(g).eq("id",o);if(c){console.error("Error updating location:",c),i.error("Could not update your location in the database"),r(!1);return}console.log("Location coordinates updated successfully"),i.success("Location updated successfully"),r(!0)}catch(g){console.error("Error updating location:",g),i.error("Could not update your location"),r(!1)}})()}):(console.error("Geolocation not supported"),i.error("Your browser doesn't support geolocation"),!1)}catch(r){return console.error("Error in updateUserLocation:",r),i.error("An unexpected error occurred while updating your location"),!1}},q=({initialScope:o,isLoading:s,disabled:t=!1})=>{const[r,g]=m.useState(o),c=U.useUser(),x=async n=>{if(c)try{const{data:h}=await f.from("profiles").select("*").limit(1);if(!j(h==null?void 0:h[0])){i.error("Location sharing scope is not supported in this database");return}const{error:a}=await f.from("profiles").update({location_sharing_scope:n,updated_at:new Date().toISOString()}).eq("id",c.id);if(a)throw a;g(n),i.success(`Location sharing scope set to ${n}`)}catch(h){console.error("Error updating sharing scope:",h),i.error("Could not update sharing scope")}};return e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(y,{className:"text-xs text-muted-foreground whitespace-nowrap",children:"To:"}),e.jsxs(E,{value:r,onValueChange:x,disabled:s||t,children:[e.jsx(C,{className:"h-7 w-[100px] text-xs",children:e.jsx(I,{placeholder:"Who can see you"})}),e.jsxs(v,{children:[e.jsx(w,{value:"all",children:"Everyone"}),e.jsx(w,{value:"hosts",children:"Hosts Only"}),e.jsx(w,{value:"renters",children:"Renters Only"}),e.jsx(w,{value:"none",children:"No One"})]})]})]})},T=({errorMessage:o})=>o?e.jsx("span",{className:"ml-2 text-xs text-red-500",children:o}):null,J=({lat:o,long:s})=>{const{userId:t,isSharingLocation:r,sharingScope:g,isLoading:c,errorMessage:x,setIsSharingLocation:n}=O(),h=async a=>{if(!t){i.error("You need to be logged in to share your location");return}try{console.log("Attempting to toggle location sharing to:",a);const{data:d,error:p}=await f.from("profiles").select("is_sharing_location, location_sharing_scope").limit(1);if(p)throw console.error("Error checking columns:",p),i.error("Could not verify table structure"),p;if(console.log("Column check result:",d),!d||!d[0]||!j(d[0])){console.error("Location fields not found in database"),i.error("Location sharing is not supported in this database");return}const{error:l}=await f.from("profiles").update({is_sharing_location:a,updated_at:new Date().toISOString()}).eq("id",t);if(l)throw console.error("Error updating location sharing:",l),l;n(a),i.success(a?"Location sharing enabled":"Location sharing disabled"),a&&await D({userId:t,lat:o,long:s})}catch(d){console.error("Error toggling location sharing:",d),i.error("Could not update location sharing status")}};return c||o===0||s===0?e.jsxs("div",{className:"flex items-center space-x-2 opacity-50",children:[e.jsx(L,{disabled:!0}),e.jsx(y,{className:"text-sm whitespace-nowrap",children:"Share Location"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"(Loading...)"})]}):t?e.jsxs("div",{className:"flex flex-row items-center justify-between w-full gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{checked:r,onCheckedChange:h,disabled:c||!!x,className:"data-[state=checked]:bg-primary"}),e.jsxs(y,{className:"text-sm whitespace-nowrap font-medium",children:["Share Location",e.jsx(T,{errorMessage:x})]})]}),r&&e.jsx(q,{initialScope:g,isLoading:c})]}):e.jsx("div",{className:"flex flex-row items-center justify-between w-full gap-2",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{checked:!1,disabled:!0,className:"data-[state=checked]:bg-primary/50"}),e.jsxs(y,{className:"text-sm whitespace-nowrap font-medium",children:["Share Location",e.jsx("span",{className:"ml-2 text-xs text-amber-500",children:"Login required"})]})]})})};export{J as O};
