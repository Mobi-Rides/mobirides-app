var G=Object.defineProperty;var R=(l,e,r)=>e in l?G(l,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):l[e]=r;var F=(l,e,r)=>R(l,typeof e!="symbol"?e+"":e,r);import{j as t,u as $}from"./query-vendor-C7aRRP05.js";import{u as E,f as V,r as C}from"./react-vendor-mnpoGfEl.js";import{c as K,B as L,v as H,a9 as Y,s as j,M as W,o as q,p as J,q as M,ao as Q,A as X}from"./index-D9LOOiBY.js";import{S as Z,a as ee,b as te}from"./sheet-DtJlGaaJ.js";import{S as re}from"./SearchFilters-VrHWTHyS.js";import{u as ae}from"./useVerificationStatus-xe-R1DUW.js";import{C as U}from"./clock-CFBaLxjz.js";import{C as se}from"./circle-check-big-rGt2oTzx.js";import{C as ne}from"./circle-alert-DI0VRaYv.js";import{S as oe}from"./shield-Tr4U0OA6.js";import{N as ie}from"./navigation-VfAfb5mz.js";import{u as ce}from"./useAuthStatus-BpX-txE6.js";import{_ as le}from"./supabase-vendor-BOn0LdFJ.js";import{a as T,b as I}from"./date-vendor-Dhms5dOu.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=K("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),ue=({showText:l=!0,variant:e="badge",size:r="md"})=>{const{isVerified:c,isLoading:s,verificationData:i}=ae(),w=E(),u=()=>{w("/verification")},n=s?{icon:t.jsx(U,{className:"h-3 w-3"}),text:"Checking...",variant:"outline",className:"border-blue-300 text-blue-600 hover:bg-blue-50",clickable:!1}:c?{icon:t.jsx(se,{className:"h-3 w-3"}),text:"Verified",variant:"secondary",className:"bg-green-100 text-green-700 border-green-200",clickable:!1}:i&&i.overall_status==="pending_review"?{icon:t.jsx(U,{className:"h-3 w-3"}),text:"Under Review",variant:"secondary",className:"bg-blue-100 text-blue-700 border-blue-200",clickable:!0}:i&&i.current_step?{icon:t.jsx(ne,{className:"h-3 w-3"}),text:"In Progress",variant:"secondary",className:"bg-orange-100 text-orange-700 border-orange-200",clickable:!0}:{icon:t.jsx(oe,{className:"h-3 w-3"}),text:"Not Verified",variant:"outline",className:"border-gray-300 text-gray-600 hover:bg-gray-50",clickable:!0};return e==="button"&&n.clickable?t.jsxs(L,{variant:"outline",size:r==="md"?"default":r,onClick:u,className:`flex items-center space-x-2 ${n.className||""}`,children:[n.icon,l&&t.jsx("span",{children:n.text})]}):t.jsxs(H,{variant:n.variant,className:`flex items-center space-x-1 cursor-pointer ${n.className||""}`,onClick:n.clickable?u:void 0,children:[n.icon,l&&t.jsx("span",{children:n.text})]})},Ae=({searchQuery:l,onSearchChange:e,onFiltersChange:r})=>{const c=E(),s=V(),{user:i}=Y(),[w,u]=C.useState(!1),[m,n]=C.useState("signin"),[a,p]=C.useState({city:"Gaborone",country:"Botswana",loading:!0,error:null});C.useEffect(()=>{const f=async()=>{try{const h=await navigator.permissions.query({name:"geolocation"});h.state==="granted"?await b():h.state==="denied"?await P():await P()}catch{try{await b()}catch{await P()}}},b=async()=>{var h,x;try{const d=await new Promise((O,z)=>{navigator.geolocation.getCurrentPosition(O,z,{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}),v=await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${d.coords.latitude}+${d.coords.longitude}&key=4382106d8cc34d2e9c95f4dc83f23736`);if(!v.ok)throw new Error("Failed to fetch location data");const k=(x=(h=(await v.json()).results)==null?void 0:h[0])==null?void 0:x.components;k&&p({city:k.city||k.town||k.state||k.county||"Unknown",country:k.country||"Unknown",loading:!1,error:null})}catch(d){console.error("Location error:",d),p(v=>({...v,loading:!1,error:d instanceof Error?d.message:"Failed to get location"}))}},P=async()=>{try{const h=await fetch("https://ipapi.co/json/");if(!h.ok)throw new Error("Failed to fetch location data");const x=await h.json();p({city:x.city||"Gaborone",country:x.country_name||"Botswana",loading:!1,error:null})}catch{p(x=>({...x,loading:!1,error:null,city:"Gaborone",country:"Botswana"}))}};f()},[]);const{data:g}=$({queryKey:["profile"],queryFn:async()=>{if(!i)return null;const{data:f}=await j.from("profiles").select("avatar_url, full_name").eq("id",i.id).single();return f},enabled:!!i}),{data:y}=$({queryKey:["notification-count"],queryFn:async()=>{if(!i)return 0;const{count:f}=await j.from("notifications").select("id",{count:"exact"}).eq("user_id",i.id).eq("is_read",!1);return f||0},refetchInterval:3e4,enabled:!!i}),o=g!=null&&g.avatar_url?j.storage.from("avatars").getPublicUrl(g.avatar_url).data.publicUrl:null,_=f=>{console.log("Filters changed:",f),r({...f,searchQuery:l})},N=()=>{i?c("/profile"):(n("signin"),u(!0),c(`${s.pathname}?auth=signin`,{replace:!0}))},D=()=>{u(!1),c(s.pathname,{replace:!0})};C.useEffect(()=>{const b=new URLSearchParams(s.search).get("auth");(b==="signin"||b==="signup")&&(n(b),u(!0))},[s.search]);const A=a.loading?"Loading location...":a.error?"Gaborone, Botswana":`${a.city}, ${a.country}`;return t.jsxs("header",{className:"bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-900 sticky top-0 z-10 shadow-sm p-6 md:p-8 rounded-b-3xl",children:[t.jsxs("div",{className:"flex items-center justify-between gap-4 mb-4",children:[t.jsx("img",{src:"/lovable-uploads/a065be26-80b7-4e50-b683-b6afb0add925.png",alt:"Mobirides Logo",className:"h-14 w-14 cursor-pointer",onClick:()=>c("/")}),t.jsx("div",{className:"flex-1",children:t.jsxs("div",{className:"flex items-center justify-center gap-1 text-center",children:[t.jsx(ie,{className:"text-white h-4 w-4 flex-shrink-0"}),t.jsx("h3",{className:"text-xs md:text-sm lg:text-base font-normal text-gray-500 dark:text-white truncate",children:A})]})}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(L,{variant:"outline",size:"icon",className:"rounded-2xl  md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2",onClick:()=>c("/add-car"),children:[t.jsx(W,{className:"h-4 w-4 text-[#581CFA] dark:text-white"}),t.jsx("span",{className:"hidden md:inline-block",children:t.jsx("p",{className:"text-[#581CFA] dark:text-white text-xs md:text-sm lg:text-base font-semibold",children:"Add A Car"})})]}),i&&t.jsx("div",{className:"hidden sm:block",children:t.jsx(ue,{variant:"button",size:"sm"})}),t.jsxs("div",{className:"relative",children:[t.jsx("button",{className:"rounded-full bg-gray-100 flex items-center justify-center",onClick:N,children:o&&i?t.jsxs(q,{className:"h-10 w-10",children:[t.jsx(J,{src:o,alt:"Profile"}),t.jsx(M,{children:"ðŸ‘¤"})]}):t.jsx(q,{className:"h-10 w-10",children:t.jsx(M,{children:"ðŸ‘¤"})})}),i&&typeof y=="number"&&y>0&&t.jsx(H,{variant:"destructive",className:"absolute -top-2 -right-2 h-5 w-5 flex items-center justify-center p-0 text-xs",children:y})]})]})]}),t.jsxs("div",{className:"flex gap-2 mt-8",children:[t.jsxs("div",{className:"relative flex-1",children:[t.jsx(Q,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-[#581CFA] h-4 w-4 md:h-5 md:w-5  lg:h-6 lg:w-6"}),t.jsx("input",{type:"text",placeholder:"Search cars...",value:l,onChange:f=>e(f.target.value),className:"w-full h-12 md:h-14 pl-10 pr-4 py-2 rounded-2xl border border-gray-200 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-100 focus:outline-none focus:border-primary dark:focus:border-primary text-xs md:text-sm lg:text-base placeholder:text-xs md:placeholder:text-sm lg:placeholder:text-base dark:placeholder:text-gray-400"})]}),t.jsxs(Z,{children:[t.jsx(ee,{asChild:!0,children:t.jsx(L,{variant:"outline",size:"icon",className:"rounded-2xl w-12 md:w-14 h-12 md:h-14 flex items-center justify-center",children:t.jsx(de,{className:"h-4 w-4"})})}),t.jsx(te,{children:t.jsx(re,{onFiltersChange:_})})]})]}),t.jsx(X,{isOpen:w,onClose:D,defaultTab:m,idPrefix:"header"})]})};class me{static async detectHandoverPrompts(e,r){const{logger:c}=await le(async()=>{const{logger:s}=await Promise.resolve().then(()=>pe);return{logger:s}},void 0);try{if(!e||!r)return[];const s=new Date,i=new Date(s.getFullYear(),s.getMonth(),s.getDate()),w=new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59);let u=j.from("bookings").select(`
          id,
          car_id,
          start_date,
          end_date,
          status,
          cars (
            brand,
            model,
            location,
            owner_id,
            image_url,
            price_per_day,
            owner:profiles!owner_id (
              full_name
            )
          ),
          renter:profiles!renter_id (
            full_name
          )
        `).eq("status","confirmed").or(`start_date.eq.${T(s,"yyyy-MM-dd")},end_date.eq.${T(s,"yyyy-MM-dd")}`);if(r==="host"){const{data:o}=await j.from("cars").select("id").eq("owner_id",e);if(!(o!=null&&o.length))return[];const _=o.map(N=>N.id);u=u.in("car_id",_)}else u=u.eq("renter_id",e);const{data:m,error:n}=await u;if(n)throw c.error("Error fetching handover prompts:",n),new Error(`Failed to fetch handover prompts: ${n.message}`);if(!(m!=null&&m.length))return[];const a=m.map(o=>o.id),{data:p}=await j.from("handover_sessions").select(`
          booking_id, 
          handover_completed,
          created_at,
          handover_type,
          handover_step_completion (
            step_name,
            is_completed,
            step_order
          )
        `).in("booking_id",a).order("created_at",{ascending:!0}),g=new Map;p==null||p.forEach(o=>{g.has(o.booking_id)||g.set(o.booking_id,[]),g.get(o.booking_id).push(o)});const y=[];for(const o of m){const _=g.get(o.id)||[],N=new Date(o.start_date),D=new Date(o.end_date),A=I(N),f=I(D),b=_.filter(d=>d.handover_type==="pickup"),P=_.filter(d=>d.handover_type==="return"),h=b.some(d=>{var v;return d.handover_completed||((v=d.handover_step_completion)==null?void 0:v.length)>0&&d.handover_step_completion.every(S=>S.is_completed)}),x=P.some(d=>{var v;return d.handover_completed||((v=d.handover_step_completion)==null?void 0:v.length)>0&&d.handover_step_completion.every(S=>S.is_completed)});h&&x||(A&&!h&&y.push(this.createHandoverPrompt(o,"pickup",r)),f&&h&&!x&&y.push(this.createHandoverPrompt(o,"return",r)))}return y}catch(s){return c.error("Error in detectHandoverPrompts:",s),[]}}static createHandoverPrompt(e,r,c){var y,o;const s=new Date(e.start_date),i=new Date(e.end_date),w=new Date,m=((r==="pickup"?s:i).getTime()-w.getTime())/(1e3*60*60);let n="morning",a=!1;m<=.5?(n="immediate",a=!0):m<=2?(n="soon",a=!0):m<=8&&(n="morning",a=!1);let p=!1;(r==="pickup"&&c==="renter"||r==="return"&&c==="renter")&&(p=!0);const g=c==="renter"?((y=e.cars.owner)==null?void 0:y.full_name)||"Host":((o=e.renter)==null?void 0:o.full_name)||"Renter";return{id:e.id,bookingId:e.id,carId:e.car_id,handoverType:r,isUrgent:a,urgencyLevel:n,carBrand:e.cars.brand,carModel:e.cars.model,startDate:s,endDate:i,userRole:c,shouldInitiate:p,otherPartyName:g,location:e.cars.location}}static getUrgencyMessage(e){switch(e.handoverType,e.urgencyLevel){case"immediate":return`ðŸš¨ URGENT: ${e.handoverType} time is now!`;case"soon":return`â° ${e.handoverType.charAt(0).toUpperCase()+e.handoverType.slice(1)} in less than 2 hours`;case"morning":return`ðŸ“… ${e.handoverType.charAt(0).toUpperCase()+e.handoverType.slice(1)} today`;default:return`${e.handoverType.charAt(0).toUpperCase()+e.handoverType.slice(1)} today`}}static getActionMessage(e){return e.shouldInitiate?e.handoverType==="pickup"?`Start pickup process with ${e.otherPartyName}`:`Start return process with ${e.otherPartyName}`:e.handoverType==="pickup"?`Prepare for pickup by ${e.otherPartyName}`:`Prepare for return from ${e.otherPartyName}`}}class he{constructor(){F(this,"isDevelopment",!1)}shouldLog(e){return this.isDevelopment?!0:e==="warn"||e==="error"}debug(e,...r){this.shouldLog("debug")&&console.log(`[DEBUG] ${e}`,...r)}info(e,...r){this.shouldLog("info")&&console.info(`[INFO] ${e}`,...r)}warn(e,...r){this.shouldLog("warn")&&console.warn(`[WARN] ${e}`,...r)}error(e,r,...c){this.shouldLog("error")&&console.error(`[ERROR] ${e}`,r,...c)}}const B=new he,pe=Object.freeze(Object.defineProperty({__proto__:null,logger:B},Symbol.toStringTag,{value:"Module"})),$e=()=>{const{userId:l,userRole:e}=ce(),{data:r=[],isLoading:c,error:s,refetch:i}=$({queryKey:["handover-prompts",l,e],queryFn:async()=>{try{return!l||!e?[]:await me.detectHandoverPrompts(l,e)}catch(a){return B.error("useHandoverPrompts: Failed to fetch handover prompts",a),[]}},enabled:!!l&&!!e,refetchInterval:5*60*1e3,staleTime:2*60*1e3,retry:(a,p)=>a<2,retryDelay:a=>Math.min(1e3*2**a,3e4)}),w=r.filter(a=>a.isUrgent),u=r.filter(a=>!a.isUrgent),m=r.filter(a=>a.shouldInitiate),n=r.filter(a=>!a.shouldInitiate);return{handoverPrompts:r,urgentPrompts:w,todayPrompts:u,userShouldInitiate:m,userShouldPrepare:n,hasHandoverPrompts:r.length>0,hasUrgentPrompts:w.length>0,isLoading:c,error:s,refetch:i}};export{Ae as H,$e as u};
