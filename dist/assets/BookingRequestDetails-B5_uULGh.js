import{j as e,a as O,u as j,b as Q}from"./query-vendor-BOSMW7hd.js";import{n as E,s as d,g as V,h as z,B as u,a0 as _,H as P,K as q,M as B,N as F,l as G,a1 as X,q as J}from"./index-ByqmTec-.js";import{N as Z}from"./Navigation-fdodg-AN.js";import{u as L}from"./useAuthStatus-hqGqvzqY.js";import{a as I,C as w,d as C,e as b,b as ee}from"./card-Dn1_7TKZ.js";import{W as se,c as N}from"./WalletBalanceIndicator-BOYTmTYz.js";import{S as A}from"./star-Dt-lKoZi.js";import{C as re}from"./car-DcHPLaSp.js";import{M as v}from"./map-pin-B-9tSSOy.js";import{C as S}from"./credit-card-IpVO2Hzm.js";import{C as y}from"./calendar-Cn2gPQb0.js";import{a as R}from"./date-vendor-Dhms5dOu.js";import{W as te}from"./wallet-BBXAdpKD.js";import{T as ae}from"./trending-up-CXNUhyI7.js";import{C as W}from"./circle-alert-CcellCUN.js";import{C as D}from"./circle-x-B9MBqLgQ.js";import{C as p}from"./circle-check-big-BdHHmxBu.js";import{C as $}from"./clock-Dg92kA5o.js";import{F as T}from"./file-text-4CeUdrl2.js";import{k as ie,u as ne}from"./react-vendor-DmU5vXC9.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./bell-sR4KUoYm.js";import"./user-CrwdbYLY.js";import"./TopUpModal-BpSgFFFs.js";import"./select-qP77FLvJ.js";import"./index-CEVvJeOa.js";import"./chevron-down-CR2ALfoj.js";import"./loader-circle-9OeoyYcF.js";const oe=({status:r})=>{const a=i=>{switch(i){case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"confirmed":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"cancelled":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"completed":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"}};return e.jsx(I,{className:"bg-primary/5 dark:bg-primary/10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-semibold text-primary dark:text-primary-foreground",children:"Booking Request Details"}),e.jsx(E,{className:a(r),children:r.charAt(0).toUpperCase()+r.slice(1)})]})})},le=({renter:r,renterRating:a})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(A,{className:"h-4 w-4 text-primary"})}),"Renter Information"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:r.avatar_url?d.storage.from("avatars").getPublicUrl(r.avatar_url).data.publicUrl:"/placeholder.svg",alt:r.full_name,className:"w-16 h-16 rounded-full object-cover border-2 border-primary/20"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:r.full_name}),typeof a=="number"&&e.jsxs("div",{className:"flex items-center gap-1 text-yellow-500 mt-1",children:[e.jsx(A,{className:"h-4 w-4 fill-current"}),e.jsx("span",{children:a.toFixed(1)})]})]})]})]}),ce=({car:r})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(re,{className:"h-4 w-4 text-primary"})}),"Requested Car"]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("img",{src:r.image_url||"/placeholder.svg",alt:`${r.brand} ${r.model}`,className:"w-full md:w-48 h-32 object-cover rounded-lg"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"font-medium text-lg text-foreground",children:[r.brand," ",r.model]}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(v,{className:"h-4 w-4 mr-1"}),r.location]}),e.jsxs("p",{className:"text-sm font-medium flex items-center",children:[e.jsx(S,{className:"h-4 w-4 mr-1 text-primary"}),"BWP ",r.price_per_day," per day"]})]})]})]}),de=({startDate:r,endDate:a,startTime:i,endTime:o})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(y,{className:"h-4 w-4 text-primary"})}),"Booking Dates"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(y,{className:"h-4 w-4 mr-2 text-primary"}),R(new Date(r),"PPP"),i&&` at ${i}`]})]}),e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"End Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(y,{className:"h-4 w-4 mr-2 text-primary"}),R(new Date(a),"PPP"),o&&` at ${o}`]})]})]})]}),me=({totalPrice:r})=>e.jsx("div",{className:"bg-card rounded-lg p-4 border",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(S,{className:"h-4 w-4 text-primary"})}),e.jsx("p",{className:"font-semibold",children:"Total Price"})]}),e.jsxs("p",{className:"text-xl font-bold",children:["BWP ",r]})]})}),ue=({bookingTotal:r,canApproveBooking:a})=>{const o=r*.15;return e.jsxs("div",{className:"space-y-4 p-6 border-t",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(te,{className:"h-4 w-4 text-primary"})}),"Wallet & Commission"]}),e.jsx(se,{bookingTotal:r,showCommissionBreakdown:!0}),e.jsx(w,{className:"bg-blue-50 border-blue-200 dark:bg-blue-950 dark:border-blue-800",children:e.jsx(C,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ae,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-blue-800 dark:text-blue-200",children:"Commission Payment"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-700 dark:text-blue-300",children:[e.jsxs("p",{children:["Total Booking: P",r.toFixed(2)]}),e.jsxs("p",{children:["Platform Commission (15%): P",o.toFixed(2)]}),e.jsx("p",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Will be deducted from your wallet balance"})]}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["You'll receive the full rental amount (P",r.toFixed(2),") while commission is paid from your wallet."]})]})]})})}),!a&&e.jsxs(V,{variant:"destructive",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsxs(z,{children:["You need sufficient wallet balance to cover the P",o.toFixed(2)," commission plus P50 minimum balance to accept this booking."]})]})]})},xe=({isCarOwner:r,isRenter:a,canApproveBooking:i,onApprove:o,onCancel:n,onContact:s,isLoading:c})=>r?e.jsxs(b,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(u,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-3 sm:order-1",onClick:s,disabled:c,children:[e.jsx(_,{className:"h-4 w-4"}),"Contact Renter"]}),e.jsxs(u,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-2 sm:order-2 text-destructive border-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:n,disabled:c,children:[e.jsx(D,{className:"h-4 w-4"}),"Reject Request"]}),e.jsx(P,{children:e.jsxs(q,{children:[e.jsx(B,{asChild:!0,children:e.jsx("div",{className:"w-full sm:w-auto order-1 sm:order-3",children:e.jsxs(u,{variant:"default",className:"flex items-center gap-2 w-full sm:w-auto",onClick:o,disabled:c||!i,children:[e.jsx(p,{className:"h-4 w-4"}),"Approve Request"]})})}),!i&&e.jsx(F,{children:e.jsx("p",{children:"Insufficient wallet balance for commission payment"})})]})})]}):a?e.jsxs(b,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(u,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-2 sm:order-1",onClick:s,disabled:c,children:[e.jsx(_,{className:"h-4 w-4"}),"Contact Host"]}),e.jsxs(u,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-1 sm:order-2 text-destructive border-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:n,disabled:c,children:[e.jsx(D,{className:"h-4 w-4"}),"Cancel Request"]})]}):e.jsx(b,{className:"border-t bg-card p-6",children:e.jsx(P,{children:e.jsxs(q,{children:[e.jsx(B,{asChild:!0,children:e.jsxs("div",{className:"flex items-center text-muted-foreground gap-2",children:[e.jsx(W,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Only car owners can approve requests"})]})}),e.jsx(F,{children:e.jsx("p",{children:"You don't have permission to manage this booking request"})})]})})}),pe=({userRole:r,startDate:a,startTime:i,carName:o})=>{const n=r==="host"?[{icon:e.jsx(p,{className:"h-5 w-5 text-green-600"}),title:"Prepare Your Vehicle",description:`Clean your ${o} inside and out. Check fluids, tire pressure, and ensure it's in perfect condition.`},{icon:e.jsx(v,{className:"h-5 w-5 text-blue-600"}),title:"Fuel Up",description:"Fill the fuel tank completely before handover. This ensures a smooth start for your renter."},{icon:e.jsx($,{className:"h-5 w-5 text-orange-600"}),title:"Be Ready Early",description:`Arrive 15 minutes before ${i||"09:00"} on ${a} for a smooth handover process.`},{icon:e.jsx(T,{className:"h-5 w-5 text-purple-600"}),title:"Documentation",description:"Have your vehicle registration and any relevant documents ready for the renter."}]:[{icon:e.jsx(T,{className:"h-5 w-5 text-blue-600"}),title:"Verify Your Documents",description:"Ensure your driver's license is valid and complete any required verification steps."},{icon:e.jsx($,{className:"h-5 w-5 text-green-600"}),title:"Plan Your Pickup",description:`Arrive 15 minutes early on ${a} at ${i||"09:00"} for vehicle inspection.`},{icon:e.jsx(p,{className:"h-5 w-5 text-orange-600"}),title:"Inspect the Vehicle",description:`Thoroughly inspect the ${o} and document any existing damage before driving.`},{icon:e.jsx(v,{className:"h-5 w-5 text-purple-600"}),title:"Contact Information",description:"Save the host's contact information and familiarize yourself with the pickup location."}];return e.jsxs(w,{className:"mt-4",children:[e.jsx(I,{children:e.jsxs(ee,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5 text-green-600"}),"What's Next?",e.jsx(E,{variant:"secondary",className:"ml-auto",children:r==="host"?"For Host":"For Renter"})]})}),e.jsx(C,{children:e.jsx("div",{className:"space-y-4",children:n.map((s,c)=>e.jsxs("div",{className:"flex gap-3 p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:s.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]})]},c))})})]})},Ye=()=>{const{id:r}=ie(),a=ne(),{toast:i}=G(),o=O(),{userId:n}=L();X();const{data:s,isLoading:c}=j({queryKey:["booking-request",r],queryFn:async()=>{console.log("Fetching booking request details for ID:",r);const{data:t,error:l}=await d.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            full_name,
            avatar_url
          ),
          car:cars (
            brand,
            model,
            image_url,
            location,
            price_per_day,
            owner_id
          )
        `).eq("id",r).single();if(l)throw l;return t}}),x=n===(s==null?void 0:s.car.owner_id),H=n===(s==null?void 0:s.renter_id),{data:K}=j({queryKey:["renter-rating",s==null?void 0:s.renter_id],queryFn:async()=>{if(!(s!=null&&s.renter_id))return null;const{data:t}=await d.rpc("calculate_user_rating",{user_uuid:s.renter_id});return t},enabled:!!(s!=null&&s.renter_id)}),{data:h}=j({queryKey:["wallet-acceptance-check",n,s==null?void 0:s.total_price],queryFn:async()=>!n||!(s!=null&&s.total_price)||!x?null:await N.checkHostCanAcceptBooking(n,s.total_price),enabled:!!n&&!!(s!=null&&s.total_price)&&x}),f=Q({mutationFn:async({status:t})=>{if(console.log("Updating booking status:",t),t==="confirmed"&&s&&n){const m=await N.checkHostCanAcceptBooking(n,s.total_price);if(!m.canAccept)throw new Error(m.message||"Insufficient wallet balance");if(!await N.processCommissionOnBookingConfirmation(n,s.id,s.total_price))throw new Error("Failed to process commission payment")}const{error:l}=await d.from("bookings").update({status:t}).eq("id",r);if(l)throw l},onSuccess:(t,l)=>{const m=l.status==="confirmed"?"approved":"cancelled";i({title:`Booking ${m}`,description:l.status==="confirmed"?"Booking approved and commission deducted from your wallet.":"The booking request has been cancelled."}),o.invalidateQueries({queryKey:["booking-request",r]}),o.invalidateQueries({queryKey:["wallet-balance"]})},onError:t=>{console.error("Error updating booking status:",t),i({title:"Error",description:t.message||"Failed to update the booking status. Please try again.",variant:"destructive"})}}),M=()=>{f.mutate({status:"confirmed"})},U=()=>{f.mutate({status:"cancelled"})},Y=async()=>{if(s!=null&&s.renter_id)try{const{data:t}=await d.from("conversations").select("id").eq("type","direct").single();let l=t==null?void 0:t.id;if(!l){const{data:m,error:g}=await d.from("conversations").insert({type:"direct",created_by:n}).select("id").single();if(g)throw g;l=m.id,await d.from("conversation_participants").insert([{conversation_id:l,user_id:n},{conversation_id:l,user_id:s.renter_id}])}a("/messages"),i({title:"Opening conversation",description:`Starting conversation with ${s.renter.full_name}`})}catch(t){console.error("Error creating conversation:",t),i({title:"Error",description:"Failed to start conversation. Please try again.",variant:"destructive"})}};if(c)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})});if(!s)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Booking request not found"})});const k=(h==null?void 0:h.canAccept)??!0;return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(u,{variant:"ghost",className:"mb-6 flex items-center",onClick:()=>a(-1),children:[e.jsx(J,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(w,{className:"overflow-hidden",children:[e.jsx(oe,{status:s.status}),e.jsxs(C,{className:"p-6 space-y-8",children:[e.jsx(le,{renter:s.renter,renterRating:K}),e.jsx(ce,{car:s.car}),e.jsx(de,{startDate:s.start_date,endDate:s.end_date,startTime:s.start_time,endTime:s.end_time}),e.jsx(me,{totalPrice:s.total_price})]}),x&&s.status==="pending"&&e.jsx(ue,{bookingTotal:s.total_price,canApproveBooking:k}),s.status==="pending"&&e.jsx(xe,{isCarOwner:x,isRenter:H,canApproveBooking:k,onApprove:M,onCancel:U,onContact:Y,isLoading:f.isPending}),s.status==="confirmed"&&e.jsx(pe,{userRole:x?"host":"renter",startDate:s.start_date,startTime:s.start_time,carName:`${s.car.brand} ${s.car.model}`})]})}),e.jsx(Z,{})]})};export{Ye as default};
