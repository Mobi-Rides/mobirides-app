import{c as Y,s as y,J as v,at as $e,D as K,b as Z,d as Q,e as ee,m as me,t as Le,B as S,F as Me,_ as H,E as De,$ as _e,au as Te,l as Ae,g as oe,av as ne,h as ie}from"./index-ByqmTec-.js";import{j as e}from"./query-vendor-BOSMW7hd.js";import{r as a,u as fe}from"./react-vendor-DmU5vXC9.js";import{C as Ie}from"./calendar-DZfUN7jn.js";import{s as Re,p as le,a as k}from"./date-vendor-Dhms5dOu.js";import{u as qe}from"./useVerificationStatus-DqwvtjbH.js";import{V as Oe}from"./VerificationRequiredDialog-DaP3vWFb.js";/* empty css                  */import{S as Fe}from"./skeleton-CLXLgSMQ.js";import{L as Ue}from"./LocationSearchInput-DwVh7Fg9.js";import{m as U}from"./mapbox-vendor-ueN8uhVJ.js";import{C as he}from"./circle-check-D1fO9Ysx.js";import{C as ge}from"./clock-Dg92kA5o.js";import{C as He}from"./calendar-Cn2gPQb0.js";import{C as ze}from"./circle-alert-CcellCUN.js";import{M as Ve}from"./map-pin-B-9tSSOy.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=Y("CalendarX",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"m14 14-4 4",key:"rymu2i"}],["path",{d:"m10 14 4 4",key:"3sz06r"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kt=Y("CircleGauge",[["path",{d:"M15.6 2.7a10 10 0 1 0 5.7 5.7",key:"1e0p6d"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"M13.4 10.6 19 5",key:"1kr7tw"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=Y("Heart",[["path",{d:"M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z",key:"c3ymky"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=Y("Locate",[["line",{x1:"2",x2:"5",y1:"12",y2:"12",key:"bvdh0s"}],["line",{x1:"19",x2:"22",y1:"12",y2:"12",key:"1tbv5k"}],["line",{x1:"12",x2:"12",y1:"2",y2:"5",key:"11lu5j"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}],["circle",{cx:"12",cy:"12",r:"7",key:"fim9np"}]]),ce=async()=>{console.log("Checking for expired booking requests...");try{const t=Re(new Date),{data:r,error:s}=await y.from("bookings").select("*").eq("status","pending").lt("start_date",t.toISOString());if(s)throw s;if(r&&r.length>0){const{error:o}=await y.from("bookings").update({status:"expired"}).in("id",r.map(i=>i.id));if(o)throw o;console.log(`Updated ${r.length} expired booking requests`)}}catch(t){console.error("Error in handleExpiredBookings:",t instanceof Error?t.message:JSON.stringify(t,null,2))}},de=async(t,r,s,o)=>{try{let i=y.from("bookings").select("*").eq("car_id",t).in("status",["confirmed","pending"]).or(`and(start_date.lte.${k(s,"yyyy-MM-dd")},end_date.gte.${k(r,"yyyy-MM-dd")})`);const{data:n,error:u}=await i;return u?(console.error("Error checking car availability:",u),!1):!n||n.length===0}catch(i){return console.error("Error in checkCarAvailability:",i),!1}},Ye=async t=>{try{const{data:r,error:s}=await y.from("bookings").select("start_date, end_date").eq("car_id",t).in("status",["confirmed","pending"]);if(s)return console.error("Error fetching booked dates:",s),[];const o=[];return r==null||r.forEach(i=>{const n=le(i.start_date),u=le(i.end_date);let g=new Date(n);for(;g<=u;)o.push(new Date(g)),g.setDate(g.getDate()+1)}),o}catch(r){return console.error("Error in getBookedDates:",r),[]}},We=(t,r)=>r.some(s=>t.getDate()===s.getDate()&&t.getMonth()===s.getMonth()&&t.getFullYear()===s.getFullYear());var ue=["light","dark"],Xe="(prefers-color-scheme: dark)",Ke=a.createContext(void 0),Ze={setTheme:t=>{},themes:[]},Qe=()=>{var t;return(t=a.useContext(Ke))!=null?t:Ze};a.memo(({forcedTheme:t,storageKey:r,attribute:s,enableSystem:o,enableColorScheme:i,defaultTheme:n,value:u,attrs:g,nonce:m})=>{let h=n==="system",N=s==="class"?`var d=document.documentElement,c=d.classList;${`c.remove(${g.map(b=>`'${b}'`).join(",")})`};`:`var d=document.documentElement,n='${s}',s='setAttribute';`,j=i?ue.includes(n)&&n?`if(e==='light'||e==='dark'||!e)d.style.colorScheme=e||'${n}'`:"if(e==='light'||e==='dark')d.style.colorScheme=e":"",l=(b,T=!1,R=!0)=>{let C=u?u[b]:b,B=T?b+"|| ''":`'${C}'`,w="";return i&&R&&!T&&ue.includes(b)&&(w+=`d.style.colorScheme = '${b}';`),s==="class"?T||C?w+=`c.add(${B})`:w+="null":C&&(w+=`d[s](n,${B})`),w},c=t?`!function(){${N}${l(t)}}()`:o?`!function(){try{${N}var e=localStorage.getItem('${r}');if('system'===e||(!e&&${h})){var t='${Xe}',m=window.matchMedia(t);if(m.media!==t||m.matches){${l("dark")}}else{${l("light")}}}else if(e){${u?`var x=${JSON.stringify(u)};`:""}${l(u?"x[e]":"e",!0)}}${h?"":"else{"+l(n,!1,!1)+"}"}${j}}catch(e){}}()`:`!function(){try{${N}var e=localStorage.getItem('${r}');if(e){${u?`var x=${JSON.stringify(u)};`:""}${l(u?"x[e]":"e",!0)}}else{${l(n,!1,!1)};}${j}}catch(t){}}();`;return a.createElement("script",{nonce:m,dangerouslySetInnerHTML:{__html:c}})});const et=({mapboxToken:t,selectedLocation:r,onMapClick:s,onMapRef:o,onGeolocateRef:i,onUserLocationUpdate:n,mapStyle:u="mapbox://styles/mapbox/streets-v12"})=>{const g=a.useRef(null),m=a.useRef(null),h=a.useRef(null),[N,j]=a.useState(!1);return a.useEffect(()=>{if(!t||!g.current||m.current)return;U.accessToken=t,m.current=new U.Map({container:g.current,style:u,center:[25.9087,-24.6541],zoom:14,interactive:!0}),m.current.addControl(new U.NavigationControl,"top-right");const l=new U.GeolocateControl({positionOptions:{enableHighAccuracy:!0},trackUserLocation:!0,showUserHeading:!0});return m.current.addControl(l,"top-right"),i(l),l.on("geolocate",c=>{console.log("Geolocate event:",c.coords),n({latitude:c.coords.latitude,longitude:c.coords.longitude})}),l.on("error",c=>{console.error("Geolocation error:",c),v.error("Unable to access your location. Please check permissions.")}),m.current.on("load",()=>{console.log("Map loaded successfully"),j(!0),o(m.current)}),m.current.on("error",c=>{console.error("Map error:",c),v.error("Error loading map. Please refresh.")}),m.current.on("click",c=>{console.log("Map clicked at:",c.lngLat),s(c.lngLat.lng,c.lngLat.lat)}),()=>{m.current&&(m.current.remove(),m.current=null,o(null),i(null))}},[t,u]),a.useEffect(()=>{if(!(!m.current||!N)&&(h.current&&(h.current.remove(),h.current=null),r)){const l=document.createElement("div");if(l.className="location-marker",l.style.width="20px",l.style.height="20px",l.style.borderRadius="50%",l.style.backgroundColor="#ef4444",l.style.border="3px solid white",l.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.3)",l.style.cursor="pointer",l.style.animation="pulse 2s infinite",!document.querySelector("#location-marker-styles")){const c=document.createElement("style");c.id="location-marker-styles",c.textContent=`
          @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
          }
        `,document.head.appendChild(c)}h.current=new U.Marker(l,{draggable:!0}).setLngLat([r.lng,r.lat]).addTo(m.current),h.current.on("dragend",()=>{var b;const c=(b=h.current)==null?void 0:b.getLngLat();c&&(console.log("Marker dragged to:",c),s(c.lng,c.lat))}),m.current.flyTo({center:[r.lng,r.lat],zoom:16,essential:!0})}},[r,N]),e.jsx("div",{className:"relative w-full h-full",children:e.jsx("div",{ref:g,className:"w-full h-full"})})},tt=({isOpen:t,onClose:r,onLocationSelected:s})=>{const[o,i]=a.useState(null),[n,u]=a.useState(""),g=a.useRef(null),m=a.useRef(null),[h,N]=a.useState(null),[j,l]=a.useState(!0),[c,b]=a.useState(null),{theme:T}=Qe(),R=a.useCallback((d,f)=>{console.log("Map clicked at:",{lat:f,lng:d}),i({lat:f,lng:d}),B(f,d)},[]),C=a.useCallback(d=>{g.current=d},[]),B=async(d,f)=>{if(h)try{const O=await(await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${f},${d}.json?access_token=${h}`)).json();O.features&&O.features.length>0&&u(O.features[0].place_name)}catch(P){console.error("Error fetching address:",P)}},w=()=>T==="dark"?"mapbox://styles/mapbox/navigation-night-v1":"mapbox://styles/mapbox/navigation-day-v1";a.useEffect(()=>{(async()=>{try{const f=await Me();if(!f){v.error("Failed to get the map token");return}console.log("Mapbox token retrieved successfully"),N(f),l(!1)}catch(f){console.error("Error getting Mapbox token:",f),v.error("Failed to load map configuration")}})()},[]);const z=()=>{o?(s(o.lat,o.lng),r()):v.error("Please select a location first")},V=()=>{m.current?m.current.trigger():v.error("Geolocation not available")},q=a.useCallback(d=>{console.log("User location updated:",d),b({lat:d.latitude,lng:d.longitude}),i({lat:d.latitude,lng:d.longitude}),B(d.latitude,d.longitude)},[]),W=d=>{const[f,P]=d.coordinates;i({lat:P,lng:f}),u(d.full_address),g.current&&g.current.flyTo({center:[f,P],zoom:16,essential:!0})};return a.useEffect(()=>{t&&(i(null),u(""),b(null))},[t]),e.jsx($e,{children:e.jsx(K,{open:t,onOpenChange:d=>{d||r()},children:e.jsxs(Z,{className:"sm:max-w-[700px] h-[85vh] max-h-[900px] flex flex-col overflow-hidden p-0",children:[e.jsxs(Q,{className:"p-6 pb-4",children:[e.jsx(ee,{children:"Select Pickup Location"}),e.jsx(me,{className:"text-sm text-muted-foreground",children:"Search for a location, click on the map, or use your current location."})]}),e.jsx("div",{className:"px-6 pb-4",children:e.jsx(Ue,{placeholder:"Search for addresses, landmarks, places...",onLocationSelect:W,className:"w-full"})}),e.jsxs(Le,{className:"flex-1 overflow-auto px-6 py-2",children:[e.jsxs("div",{className:"relative w-full rounded-md overflow-hidden border border-border mb-4",style:{height:"400px",minHeight:"300px"},children:[(j||!h)&&e.jsx("div",{className:"absolute inset-0 bg-background/80 backdrop-blur-sm",children:e.jsx(Fe,{className:"w-full h-full"})}),e.jsx(et,{mapboxToken:h,selectedLocation:o,onMapClick:R,onMapRef:C,onGeolocateRef:d=>m.current=d,onUserLocationUpdate:q,mapStyle:w()}),o&&e.jsxs("div",{className:"absolute top-2 left-2 bg-background/90 p-2 rounded-md shadow-sm border border-border text-xs max-w-[200px]",children:[e.jsx("p",{className:"font-medium",children:"Selected Location"}),e.jsxs("p",{children:["Lat: ",o.lat.toFixed(6)]}),e.jsxs("p",{children:["Lng: ",o.lng.toFixed(6)]}),n&&e.jsx("p",{className:"mt-1 text-muted-foreground truncate",children:n})]}),e.jsx("div",{className:"absolute top-2 right-2",children:e.jsxs(S,{size:"sm",variant:"secondary",className:"h-8 shadow-sm",onClick:V,disabled:!h||j,children:[e.jsx(Ge,{className:"h-4 w-4 mr-1"}),"Use My Location"]})})]}),e.jsx("div",{className:"flex flex-col gap-2 mb-4",children:e.jsx("p",{className:"text-xs text-muted-foreground",children:j?"Loading map...":h?o?`Location selected${n?`: ${n}`:". Click confirm to use this location."}`:"Search for a location above, click on the map, or use your current location.":"Map configuration not available"})})]}),e.jsxs("div",{className:"flex justify-end gap-2 p-4 border-t sticky bottom-0 bg-background",children:[e.jsx(S,{variant:"outline",onClick:r,children:"Cancel"}),e.jsx(S,{onClick:z,disabled:!o,children:"Confirm Location"})]})]})})})},xe=a.forwardRef(({...t},r)=>e.jsx("nav",{ref:r,"aria-label":"breadcrumb",...t}));xe.displayName="Breadcrumb";const pe=a.forwardRef(({className:t,...r},s)=>e.jsx("ol",{ref:s,className:H("flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",t),...r}));pe.displayName="BreadcrumbList";const ye=a.forwardRef(({className:t,...r},s)=>e.jsx("li",{ref:s,className:H("inline-flex items-center gap-1.5",t),...r}));ye.displayName="BreadcrumbItem";const rt=a.forwardRef(({asChild:t,className:r,...s},o)=>{const i=t?_e:"a";return e.jsx(i,{ref:o,className:H("transition-colors hover:text-foreground",r),...s})});rt.displayName="BreadcrumbLink";const be=a.forwardRef(({className:t,...r},s)=>e.jsx("span",{ref:s,role:"link","aria-disabled":"true","aria-current":"page",className:H("font-normal text-foreground",t),...r}));be.displayName="BreadcrumbPage";const ve=({children:t,className:r,...s})=>e.jsx("li",{role:"presentation","aria-hidden":"true",className:H("[&>svg]:size-3.5",r),...s,children:t??e.jsx(De,{})});ve.displayName="BreadcrumbSeparator";const ke=({currentStep:t,bookingId:r})=>{const s=[{key:"selection",label:"Car Selection",completed:!0},{key:"confirmation",label:"Booking Details",completed:t!=="selection"},{key:"success",label:"Confirmation",completed:["success","handover"].includes(t)},{key:"handover",label:"Handover",completed:t==="handover"}],o=i=>i.completed&&t!==i.key?e.jsx(he,{className:"h-4 w-4 text-green-600"}):t===i.key?e.jsx(ge,{className:"h-4 w-4 text-primary"}):e.jsx(Te,{className:"h-4 w-4 text-muted-foreground"});return e.jsxs("div",{className:"p-4 bg-muted/50 border-b",children:[e.jsx(xe,{children:e.jsx(pe,{children:s.map((i,n)=>e.jsxs("div",{className:"flex items-center",children:[e.jsxs(ye,{className:"flex items-center gap-2",children:[o(i),t===i.key?e.jsx(be,{className:"font-medium",children:i.label}):e.jsx("span",{className:`text-sm ${i.completed?"text-green-600 font-medium":"text-muted-foreground"}`,children:i.label})]}),n<s.length-1&&e.jsx(ve,{})]},i.key))})}),r&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Booking ID: ",r]})]})},st=({isOpen:t,onClose:r,bookingData:s})=>{const o=fe(),[i,n]=a.useState(5);a.useEffect(()=>{if(!t)return;const m=setInterval(()=>{n(h=>h<=1?(u(),0):h-1)},1e3);return()=>clearInterval(m)},[t]);const u=()=>{r(),o("/bookings")},g=()=>{r()};return e.jsx(K,{open:t,onOpenChange:g,children:e.jsxs(Z,{className:"sm:max-w-[500px] p-0",children:[e.jsx(ke,{currentStep:"success",bookingId:s==null?void 0:s.id}),e.jsxs("div",{className:"p-6",children:[e.jsxs(Q,{className:"text-center",children:[e.jsx("div",{className:"mx-auto mb-4 w-16 h-16 bg-green-100 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"h-8 w-8 text-green-600"})}),e.jsx(ee,{className:"text-xl font-semibold",children:"Booking Request Submitted!"})]}),e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsxs("div",{className:"bg-muted/50 rounded-lg p-4 space-y-3",children:[e.jsx("h3",{className:"font-medium text-sm text-muted-foreground uppercase tracking-wide",children:"Booking Details"}),s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center",children:e.jsx(He,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[s.carBrand," ",s.carModel]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["BWP ",s.totalPrice]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-50 rounded-full flex items-center justify-center",children:e.jsx(ge,{className:"h-4 w-4 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Rental Period"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[s.startDate," to ",s.endDate]})]})]})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 dark:text-blue-100 mb-2",children:"What happens next?"}),e.jsxs("ul",{className:"space-y-1 text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("li",{children:"• The car owner will review your request"}),e.jsx("li",{children:"• You'll be notified once it's approved"}),e.jsx("li",{children:"• Pickup details will be shared via messages"}),e.jsx("li",{children:"• Handover process will be available on booking day"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 pt-4",children:[e.jsx(S,{variant:"outline",onClick:g,className:"flex-1",children:"Close"}),e.jsxs(S,{onClick:u,className:"flex-1",children:["View My Bookings ",i>0&&`(${i}s)`]})]})]})]})]})})},wt=({car:t,isOpen:r,onClose:s})=>{const[o,i]=a.useState(),[n,u]=a.useState(),[g,m]=a.useState("09:00"),[h,N]=a.useState("18:00"),[j,l]=a.useState(!1),[c,b]=a.useState(!1),[T,R]=a.useState(null),[C,B]=a.useState([]),[w,z]=a.useState(!1),[V,q]=a.useState(!0),[W,d]=a.useState(!1),[f,P]=a.useState(null),[O,X]=a.useState(!1),[je,te]=a.useState(!1),[we,Ne]=a.useState(null),A=a.useRef(!0),{toast:$}=Ae(),Se=fe(),{isVerified:J,isLoading:F}=qe();a.useEffect(()=>{(async()=>{var M,E;const{data:p}=await y.auth.getSession(),L=(E=(M=p.session)==null?void 0:M.user)==null?void 0:E.id;A.current&&(R(L),L&&t.owner_id===L&&b(!0))})()},[t.owner_id]),a.useEffect(()=>{r&&t.id&&((async()=>{const p=await Ye(t.id);B(p)})(),ce().catch(console.error))},[r,t.id]),a.useEffect(()=>{o&&n?(async()=>{if(o&&n&&t.id){z(!0);try{const p=await de(t.id,o,n);q(p)}catch(p){console.error("Error checking availability:",p),q(!1)}finally{z(!1)}}})():q(!0)},[o,n,t.id]),a.useEffect(()=>(r&&ce().catch(console.error),()=>{}),[r]),a.useEffect(()=>{t.latitude&&t.longitude&&P({latitude:t.latitude,longitude:t.longitude})},[t]),a.useEffect(()=>()=>{A.current=!1},[]);const re=async(x,p,L,M,E)=>{console.log("Creating notification:",{userId:x,type:p,content:L,carId:M,bookingId:E});const{error:I}=await y.from("notifications").insert({user_id:x,type:p,content:L,related_car_id:M,related_booking_id:E});return I?(console.error("Error creating notification:",I.message||JSON.stringify(I,null,2)),!1):!0},Ce=async()=>{var E,I;const{data:x,error:p}=await y.auth.getSession();if(p||!((E=x.session)!=null&&E.user)){$({title:"Session expired",description:"Please sign in again to continue with your booking",variant:"destructive"}),Se("/login");return}if(!J&&!F){X(!0);return}if(c){$({title:"Not allowed",description:"You cannot book your own car",variant:"destructive"});return}if(!o||!n){$({title:"Error",description:"Please select both start and end dates",variant:"destructive"});return}if(!await de(t.id,o,n)){$({title:"Not available",description:"This car is not available for the selected dates. Please choose different dates."});return}if(!f){$({title:"Error",description:"Please select a pickup location",variant:"destructive"});return}l(!0);const M=setTimeout(()=>{A.current&&(l(!1),$({title:"Timeout",description:"Booking is taking longer than expected. Please check your bookings page.",variant:"destructive"}))},3e4);try{console.log("[BookingDialog] Starting booking process...");const{data:D}=await y.auth.getSession();if(!((I=D.session)!=null&&I.user))throw new Error("No authenticated user");const se=(Math.ceil((n.getTime()-o.getTime())/(1e3*60*60*24))+1)*t.price_per_day;console.log("[BookingDialog] Creating booking in database...");const{data:G,error:ae}=await y.from("bookings").insert({car_id:t.id,renter_id:D.session.user.id,start_date:k(o,"yyyy-MM-dd"),end_date:k(n,"yyyy-MM-dd"),start_time:g,end_time:h,total_price:se,latitude:f.latitude,longitude:f.longitude,status:"pending"}).select().single();if(ae)throw ae;console.log("[BookingDialog] Booking created successfully:",G.id),console.log("[BookingDialog] Creating notifications...");try{await re(D.session.user.id,"booking_request",`Your booking request for ${t.brand} ${t.model} from ${k(o,"PPP")} to ${k(n,"PPP")} has been submitted.`,t.id,G.id)}catch(_){console.error("Failed to create renter notification (non-blocking):",_ instanceof Error?_.message:JSON.stringify(_,null,2))}try{await re(t.owner_id,"booking_request",`New booking request received for your ${t.brand} ${t.model} from ${k(o,"PPP")} to ${k(n,"PPP")}.`,t.id,G.id)}catch(_){console.error("Failed to create host notification (non-blocking):",_ instanceof Error?_.message:JSON.stringify(_,null,2))}if(!A.current)return;console.log("[BookingDialog] Booking flow completed successfully, showing success modal..."),Ne({id:G.id,carBrand:t.brand,carModel:t.model,startDate:k(o,"PPP"),endDate:k(n,"PPP"),totalPrice:se}),s(),te(!0)}catch(D){if(!A.current)return;console.error("Booking error:",D instanceof Error?D.message:JSON.stringify(D,null,2)),$({title:"Error",description:"Failed to create booking. Please try again.",variant:"destructive"})}finally{clearTimeout(M),A.current&&l(!1)}},Pe=(x,p)=>{P({latitude:x,longitude:p})},Ee=()=>f?f.latitude===t.latitude&&f.longitude===t.longitude?`Default: ${t.location}`:`Custom location (${f.latitude.toFixed(4)}, ${f.longitude.toFixed(4)})`:"No location selected",Be=x=>{const p=new Date;return p.setDate(p.getDate()),p.setHours(0,0,0,0),x<p?!0:We(x,C)};return e.jsxs(e.Fragment,{children:[e.jsx(K,{open:r,onOpenChange:s,children:e.jsxs(Z,{className:"sm:max-w-[425px] max-h-[90vh] overflow-y-auto p-0",children:[e.jsx(ke,{currentStep:"confirmation"}),e.jsxs("div",{className:"p-6",children:[e.jsxs(Q,{children:[e.jsxs(ee,{children:["Book ",t.brand," ",t.model]}),e.jsx(me,{className:"text-muted-foreground",children:"Select your rental dates and pickup location"})]}),c&&e.jsxs(oe,{variant:"destructive",className:"mb-4",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx(ne,{children:"Not allowed"}),e.jsx(ie,{children:"You cannot book your own car. This is for other renters only."})]}),!V&&o&&n&&e.jsxs(oe,{variant:"destructive",className:"mb-4",children:[e.jsx(Je,{className:"h-4 w-4"}),e.jsx(ne,{children:"Not available"}),e.jsx(ie,{children:"This car is not available for the selected dates. Please choose different dates."})]}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Select dates"}),e.jsx(Ie,{mode:"range",selected:{from:o,to:n},onSelect:x=>{i(x==null?void 0:x.from),u(x==null?void 0:x.to)},numberOfMonths:1,disabled:Be,modifiers:{booked:C},modifiersStyles:{booked:{backgroundColor:"rgba(239, 68, 68, 0.1)",color:"rgb(239, 68, 68)",textDecoration:"line-through"}}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Pickup Location"}),e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ve,{className:"h-5 w-5 text-primary mt-0.5 flex-shrink-0"}),e.jsx("div",{className:"text-sm",children:e.jsx("p",{children:Ee()})})]}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>d(!0),children:"Change"})]})]}),o&&n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Summary"}),e.jsxs("div",{className:"text-sm space-y-1 p-4 bg-primary/5 rounded-md",children:[e.jsxs("p",{children:["Start date: ",k(o,"PPP")]}),e.jsxs("p",{children:["End date: ",k(n,"PPP")]}),e.jsx("div",{className:"border-t border-border pt-2 mt-2",children:e.jsxs("p",{className:"font-medium text-primary",children:["Total: BWP"," ",Math.ceil((n.getTime()-o.getTime())/(1e3*60*60*24)+1)*t.price_per_day]})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>d(!0),children:"Change"})]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-2 pt-4 border-t",children:[e.jsx(S,{variant:"outline",onClick:s,className:"w-full sm:w-auto",children:"Cancel"}),e.jsx(S,{onClick:!J&&!F?()=>X(!0):Ce,disabled:!o||!n||j||c||w||!V||!f||F,className:"w-full sm:w-auto",variant:!J&&!F?"outline":"default",children:j?"Booking...":w?"Checking...":F?"Checking verification...":J?"Confirm":"Start Verification"})]})]})]})}),e.jsx(Oe,{isOpen:O,onClose:()=>X(!1),action:"booking",carData:t}),e.jsx(tt,{isOpen:W,onClose:()=>d(!1),onLocationSelected:Pe}),e.jsx(st,{isOpen:je,onClose:()=>te(!1),bookingData:we})]})},Nt=async t=>{try{console.log("Saving car:",t);const{data:{session:r}}=await y.auth.getSession();if(!(r!=null&&r.user))return console.log("No active session found when trying to save car"),v.error("Please sign in to save cars"),!1;const{data:s}=await y.from("saved_cars").select("id").eq("user_id",r.user.id).eq("car_id",t).maybeSingle();if(s)return console.log("Car already saved:",t),!0;const{error:o}=await y.from("saved_cars").insert({user_id:r.user.id,car_id:t});return o?(console.error("Error saving car:",o),v.error("Failed to save car. Please try again."),!1):(v.success("Car saved to your favorites"),!0)}catch(r){return console.error("Error in saveCar:",r),v.error("An error occurred while saving the car"),!1}},St=async t=>{try{console.log("Unsaving car:",t);const{data:{session:r}}=await y.auth.getSession();if(!(r!=null&&r.user))return console.log("No active session found when trying to unsave car"),v.error("Please sign in to manage saved cars"),!1;const{error:s}=await y.from("saved_cars").delete().eq("user_id",r.user.id).eq("car_id",t);return s?(console.error("Error unsaving car:",s),v.error("Failed to remove car from favorites. Please try again."),!1):(v.success("Car removed from your favorites"),!0)}catch(r){return console.error("Error in unsaveCar:",r),v.error("An error occurred while removing the car from favorites"),!1}},Ct=async t=>{try{const{data:{session:r}}=await y.auth.getSession();if(!(r!=null&&r.user))return!1;const{data:s}=await y.from("saved_cars").select("id").eq("user_id",r.user.id).eq("car_id",t).maybeSingle();return!!s}catch(r){return console.error("Error checking if car is saved:",r),!1}};export{wt as B,kt as C,jt as H,Ct as i,Nt as s,St as u};
