import{u as y,j as o}from"./query-vendor-BOSMW7hd.js";import{B as d,q as f,J as s,s as g}from"./index-ByqmTec-.js";import{N as x}from"./Navigation-fdodg-AN.js";import{N as b}from"./NotificationClassifier-DRBvVVRC.js";import{k,u as w}from"./react-vendor-DmU5vXC9.js";import{A as N}from"./arrow-right-RRvKZqjh.js";import{M as v}from"./map-pin-B-9tSSOy.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./date-vendor-Dhms5dOu.js";import"./bell-sR4KUoYm.js";import"./user-CrwdbYLY.js";const M=()=>{const{id:c}=k(),l=w(),{data:e,isLoading:h}=y({queryKey:["notification",c],queryFn:async()=>{console.log("Fetching notification details for ID:",c);try{const{data:r,error:i}=await g.from("notifications").select(`
            *,
            booking:bookings!related_booking_id (
              id,
              cars (
                owner_id
              )
            )
          `).eq("id",c).single();if(i)throw console.error("Error fetching notification:",i),i;return await g.from("notifications").update({is_read:!0}).eq("id",c),r}catch(r){throw console.error("Error in notification query:",r),s.error("Failed to load notification details"),r}}}),p=async()=>{var r,i,m;if(console.log("Location request initiated"),!((r=e==null?void 0:e.booking)!=null&&r.id)||!((m=(i=e==null?void 0:e.booking)==null?void 0:i.cars)!=null&&m.owner_id)){console.error("Missing booking information:",{notification:e}),s.error("Booking information not found");return}try{if(!navigator.geolocation){console.error("Geolocation not supported"),s.error("Geolocation is not supported by your browser");return}const n=navigator.geolocation.watchPosition(async t=>{console.log("Position received:",{lat:t.coords.latitude,lng:t.coords.longitude});try{const{data:{user:a},error:u}=await g.auth.getUser();if(u)throw new Error("Authentication error: "+u.message);if(!a)throw new Error("User not authenticated");l(`/map?bookingId=${e.booking.id}&hostId=${e.booking.cars.owner_id}&mode=handover`)}catch(a){console.error("Error processing location update:",a),s.error(a instanceof Error?a.message:"Failed to process location update"),navigator.geolocation.clearWatch(n),localStorage.removeItem("locationWatchId")}},t=>{console.error("Geolocation error:",t);let a="Failed to get your location";switch(t.code){case t.PERMISSION_DENIED:a="Location permission denied. Please enable location services.";break;case t.POSITION_UNAVAILABLE:a="Location information is unavailable.";break;case t.TIMEOUT:a="Location request timed out.";break}s.error(a)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0});localStorage.setItem("locationWatchId",n.toString()),console.log("Location watch started with ID:",n)}catch(n){console.error("Error in location request handler:",n),s.error("Failed to process location request. Please try again.")}};return h?o.jsx("div",{className:"container mx-auto px-4 py-8",children:o.jsxs("div",{className:"animate-pulse space-y-4",children:[o.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),o.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})}):o.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[o.jsxs(d,{variant:"ghost",className:"mb-6",onClick:()=>l(-1),children:[o.jsx(f,{className:"mr-2 h-4 w-4"}),"Back"]}),o.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700",children:[o.jsx("h1",{className:"text-2xl font-semibold mb-4 dark:text-white",children:"Notification Details"}),e?(()=>{const r=b.classifyNotification(e);return o.jsxs("div",{className:"space-y-4",children:[o.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:e.content}),o.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:["Type: ",r.type," (",r.confidence,"%)"]}),o.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:["Received on: ",new Date(e.created_at).toLocaleDateString()]}),r.type==="booking"&&e.related_booking_id&&o.jsxs("div",{className:"space-y-2",children:[o.jsxs(d,{className:"w-full",onClick:()=>l(`/booking-requests/${e.related_booking_id}`),children:["View Booking Request",o.jsx(N,{className:"ml-2 h-4 w-4"})]}),e.content.includes("requesting your location")&&o.jsxs(d,{variant:"default",className:"w-full bg-primary hover:bg-primary/90",onClick:p,children:["Share Location & View Host",o.jsx(v,{className:"ml-2 h-4 w-4"})]})]})]})})():o.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Notification not found"})]}),o.jsx(x,{})]})};export{M as default};
