import{u as W,j as e}from"./query-vendor-BOSMW7hd.js";import{a as ne,J as ie,s as B,B as c,q as H,n as le,H as oe,K as I,M as S,N as T}from"./index-ByqmTec-.js";import{N as E}from"./Navigation-fdodg-AN.js";import{k as ce,f as J,r as A,u as w}from"./react-vendor-DmU5vXC9.js";import{c as de,d as me,e as xe,a as Y}from"./date-vendor-Dhms5dOu.js";import{K as he,a as ue,C as pe}from"./CarDescription-BIHQBOuO.js";import{C as je}from"./circle-help-3n1y1IyQ.js";import{C as O}from"./circle-alert-CcellCUN.js";import{C as z}from"./circle-check-D1fO9Ysx.js";import{C as F}from"./clock-Dg92kA5o.js";import{C as v,a as _,b as k,d as y,e as fe}from"./card-Dn1_7TKZ.js";import{C as ge}from"./car-DcHPLaSp.js";import{M as Q}from"./map-pin-B-9tSSOy.js";import{C as Ne}from"./calendar-Cn2gPQb0.js";import{S as we}from"./separator-D3RZtFXH.js";import{C as ve}from"./credit-card-IpVO2Hzm.js";import{S as ye}from"./star-Dt-lKoZi.js";import{U as be}from"./user-CrwdbYLY.js";import{S as N}from"./skeleton-CLXLgSMQ.js";import{R as Ce}from"./receipt-ByYkD0_m.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./bell-sR4KUoYm.js";var U=(s=>(s.PICKUP="pickup",s.RETURN="return",s))(U||{});const _e=()=>{var V;const{id:s}=ce(),i=J().search.includes("print=true"),[l,n]=A.useState(!1),{data:a,isLoading:d}=W({queryKey:["rental-details",s],queryFn:async()=>{console.log("Fetching rental details for ID:",s);const{data:r,error:x}=await B.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            id,
            full_name,
            avatar_url
          ),
          car:cars (
            *,
            owner:profiles!owner_id (
              id,
              full_name,
              avatar_url
            )
          ),
          handover_sessions (
            id,
            handover_completed,
            created_at,
            handover_step_completion (
              step_name,
              is_completed,
              step_order
            )
          )
        `).eq("id",s).single();if(x)throw x;return r}}),{data:o,isLoading:h}=W({queryKey:["current-user"],queryFn:async()=>{const{data:{user:r}}=await B.auth.getUser();return r}});A.useEffect(()=>{if(i&&a&&!d){const r=setTimeout(()=>{window.print()},500);return()=>clearTimeout(r)}},[i,a,d]);const u=a&&o&&a.renter_id===o.id,D=a&&o&&a.car.owner_id===o.id,g=((a==null?void 0:a.handover_sessions)||[]).sort((r,x)=>new Date(r.created_at).getTime()-new Date(x.created_at).getTime()),b=g.find(r=>{const x=r.handover_step_completion||[],te=x.length>0&&x.every(re=>re.is_completed);return r.handover_completed||te}),p=g.length>1?g[1]:null,C=p&&(p.handover_completed||((V=p.handover_step_completion)==null?void 0:V.length)>0&&p.handover_step_completion.every(r=>r.is_completed)),m=new Date,j=a?new Date(a.start_date):null,f=a?new Date(a.end_date):null,G=a&&de(m,{start:new Date(a.start_date),end:me(new Date(a.end_date),1)}),L=a&&a.status==="confirmed"&&!b&&j&&m>=j,R=a&&a.status==="confirmed"&&b&&!C&&G,q=a&&a.status==="confirmed"&&b&&!C&&f&&m>=f,K=a&&(a.status==="completed"||C),X=R,Z=K;j&&m.getDate()===j.getDate()&&m.getMonth()===j.getMonth()&&(m.getFullYear(),j.getFullYear()),f&&m.getDate()===f.getDate()&&m.getMonth()===f.getMonth()&&(m.getFullYear(),f.getFullYear());const P=L,M=(R||q)&&!C,ee=P||M,se=P?U.PICKUP:U.RETURN,ae=a?xe(new Date(a.end_date),new Date(a.start_date))+1:0;return{booking:a,isBookingLoading:d,isUserLoading:h,currentUser:o,isRenter:u,isOwner:D,isActiveRental:X,isCompletedRental:Z,isPendingPickup:L,isInProgress:R,isPendingReturn:q,isCompleted:K,canHandover:ee,canInitiatePickup:P,canInitiateReturn:M,handoverType:se,rentalDurationDays:ae,isInitiatingHandover:l,handleInitiateHandover:async()=>{if(!a||!o)return null;n(!0);try{return await ne(a.id,a.car.owner_id,a.renter_id)}catch(r){return console.error("Error initiating handover:",r),ie.error("Failed to initiate handover process"),null}finally{n(!1)}},id:s}},ke=({status:s,onBack:t})=>{const i=()=>{let l="outline",n=e.jsx(je,{className:"h-3 w-3 mr-1"});switch(s){case"confirmed":l="success",n=e.jsx(z,{className:"h-3 w-3 mr-1"});break;case"pending":l="warning",n=e.jsx(F,{className:"h-3 w-3 mr-1"});break;case"completed":l="default",n=e.jsx(z,{className:"h-3 w-3 mr-1"});break;case"cancelled":l="destructive",n=e.jsx(O,{className:"h-3 w-3 mr-1"});break}return e.jsxs(le,{variant:l,className:"flex items-center",children:[n,e.jsx("span",{className:"capitalize",children:s})]})};return e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs(c,{variant:"ghost",onClick:t,children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Back"]}),i()]})},De=({car:s})=>{const t=w();return e.jsxs(v,{className:"overflow-hidden border-border shadow-sm",children:[e.jsx(_,{className:"p-4 bg-muted/30",children:e.jsxs(k,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ge,{className:"h-5 w-5 text-primary"}),"Vehicle Information"]})}),e.jsx(y,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("img",{src:s.image_url||"/placeholder.svg",alt:`${s.brand} ${s.model}`,className:"w-full sm:w-32 h-32 sm:h-24 object-cover rounded-lg"}),e.jsxs("div",{className:"flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-lg",children:[s.brand," ",s.model," (",s.year,")"]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground mt-1",children:[e.jsx(Q,{className:"h-4 w-4"}),e.jsx("span",{children:s.location})]})]}),e.jsxs("p",{className:"text-lg font-medium mt-2",children:["BWP ",s.price_per_day," per day"]})]})]})}),e.jsx(fe,{className:"p-4 bg-muted/10 border-t",children:e.jsx(c,{variant:"outline",size:"sm",onClick:()=>t(`/car/${s.id}`),className:"text-xs",children:"View Vehicle Details"})})]})},Re=({startDate:s,endDate:t,durationDays:i})=>e.jsxs(v,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(_,{className:"pb-2",children:e.jsxs(k,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Rental Duration"]})}),e.jsxs(y,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Start Date"}),e.jsx("p",{className:"font-medium",children:Y(new Date(s),"PPP")})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"End Date"}),e.jsx("p",{className:"font-medium",children:Y(new Date(t),"PPP")})]})]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(F,{className:"h-4 w-4 text-muted-foreground mr-2"}),e.jsxs("span",{className:"text-sm",children:[i," day",i!==1?"s":""]})]})]})]}),Pe=({pricePerDay:s,durationDays:t,totalPrice:i})=>e.jsxs(v,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(_,{className:"pb-2",children:e.jsxs(k,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(ve,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Payment Details"]})}),e.jsxs(y,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Daily Rate"}),e.jsxs("p",{children:["BWP ",s]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Duration"}),e.jsxs("p",{children:[t," day",t!==1?"s":""]})]}),e.jsx(we,{}),e.jsxs("div",{className:"flex justify-between font-bold",children:[e.jsx("p",{children:"Total"}),e.jsxs("p",{children:["BWP ",i]})]})]})]}),Ie=({bookingId:s,canHandover:t,handoverType:i,isInitiatingHandover:l,isCompletedRental:n,isActiveRental:a,isRenter:d,onHandoverInitiate:o})=>{const h=w(),u=()=>{console.log("Extend rental clicked for booking:",s)};return e.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-end pt-4",children:e.jsxs(oe,{children:[n&&e.jsxs(I,{children:[e.jsx(S,{asChild:!0,children:e.jsxs(c,{className:"w-full sm:w-auto flex items-center gap-2",onClick:()=>h(`/rental-review/${s}`),children:[e.jsx(ye,{className:"h-4 w-4"}),"Write Review"]})}),e.jsx(T,{children:e.jsx("p",{children:"Share your experience with this vehicle"})})]}),a&&d&&e.jsxs(I,{children:[e.jsx(S,{asChild:!0,children:e.jsxs(c,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:u,children:[e.jsx(F,{className:"h-4 w-4"}),"Extend Rental"]})}),e.jsx(T,{children:e.jsx("p",{children:"Request to extend your rental period"})})]}),t&&e.jsxs(c,{className:"w-full sm:w-auto flex items-center gap-2",variant:"default",onClick:o,disabled:l,children:[e.jsx(he,{className:"h-4 w-4"}),l?"Initiating...":`Initiate ${i==="pickup"?"Pickup":"Return"}`]}),a&&!t&&e.jsxs(I,{children:[e.jsx(S,{asChild:!0,children:e.jsxs(c,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:()=>h(`/map?handover=true&bookingId=${s}&role=${d?"renter":"host"}`),children:[e.jsx(Q,{className:"h-4 w-4"}),"View Handover Status"]})}),e.jsx(T,{children:e.jsx("p",{children:"See the real-time status of your car handover"})})]})]})})},Se=({user:s,role:t})=>e.jsxs(v,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(_,{className:"pb-2",children:e.jsxs(k,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(be,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),t]})}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:s.avatar_url?B.storage.from("avatars").getPublicUrl(s.avatar_url).data.publicUrl:"/placeholder.svg",alt:s.full_name||t,className:"w-12 h-12 rounded-full object-cover bg-muted"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:s.full_name||t}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Vehicle ",t]})]})]})})]}),Te=()=>{const s=w();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(c,{variant:"ghost",onClick:()=>s(-1),children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(N,{className:"h-8 w-48 ml-4"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(N,{className:"h-64 w-full rounded-lg"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(N,{className:"h-48 w-full rounded-lg"}),e.jsx(N,{className:"h-48 w-full rounded-lg"})]}),e.jsx(N,{className:"h-48 w-full rounded-lg"})]}),e.jsx(E,{})]})},Be=()=>{const s=w();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(c,{variant:"ghost",className:"mb-6",onClick:()=>s(-1),children:[e.jsx(H,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(v,{children:e.jsx(y,{className:"py-10",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-3",children:[e.jsx(O,{className:"h-10 w-10 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Rental details not found"}),e.jsx("p",{className:"text-muted-foreground",children:"The rental information you're looking for could not be found."}),e.jsx(c,{onClick:()=>s("/bookings"),children:"View All Bookings"})]})})}),e.jsx(E,{})]})},rs=()=>{const s=w();J();const{booking:t,isBookingLoading:i,isUserLoading:l,isRenter:n,isActiveRental:a,isCompletedRental:d,canHandover:o,handoverType:h,rentalDurationDays:u,isInitiatingHandover:D,handleInitiateHandover:$}=_e(),g=async()=>{if(await $()){const p=n?"renter":"host";s(`/map?bookingId=${t.id}&mode=handover&role=${p}`)}};return i||l?e.jsx(Te,{}):t?e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20 animate-fade-in",children:[e.jsx(ke,{status:t.status,onBack:()=>s(-1)}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Rental Details"}),d&&e.jsxs(c,{variant:"outline",size:"sm",className:"mt-2 sm:mt-0 flex items-center gap-2",onClick:()=>window.print(),children:[e.jsx(Ce,{className:"h-4 w-4"}),"Download Receipt"]})]}),e.jsx(De,{car:t.car}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n?e.jsx(ue,{ownerName:t.car.owner.full_name,avatarUrl:t.car.owner.avatar_url,ownerId:t.car.owner.id}):e.jsx(Se,{user:t.renter,role:"Renter"}),e.jsx(Re,{startDate:t.start_date,endDate:t.end_date,durationDays:u})]}),e.jsx(pe,{description:t.car.description}),e.jsx(Pe,{pricePerDay:t.car.price_per_day,durationDays:u,totalPrice:t.total_price}),e.jsx(Ie,{bookingId:t.id,canHandover:o,handoverType:h,isInitiatingHandover:D,isCompletedRental:d,isActiveRental:a,isRenter:n,onHandoverInitiate:g})]}),e.jsx(E,{})]}):e.jsx(Be,{})};export{rs as default};
