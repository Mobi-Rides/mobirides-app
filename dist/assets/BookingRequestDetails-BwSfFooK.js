import{j as e,a as Y,u as g,b as O}from"./query-vendor-BOSMW7hd.js";import{n as T,s as x,g as Q,h as V,B as d,a3 as k,H as _,K as P,M as q,N as B,l as z,a4 as G,q as X}from"./index-BnOLzhwz.js";import{N as J}from"./Navigation-k0oYb1zd.js";import{u as Z}from"./useAuthStatus-C5dzrHBE.js";import{a as I,C as v,d as w,e as j,b as L}from"./card-CDc_xlrS.js";import{W as ee,c as b}from"./WalletBalanceIndicator-DHKYfiex.js";import{S as F}from"./star-CW-HfHZw.js";import{C as se}from"./car-CQMiUMTl.js";import{M as y}from"./map-pin-cZ2IpURy.js";import{C as E}from"./credit-card-CRqtuAGB.js";import{C as N}from"./calendar-BNv8_YNk.js";import{a as A}from"./date-vendor-Dhms5dOu.js";import{W as re}from"./wallet-faTPLuFw.js";import{T as te}from"./trending-up-B6zEQKnc.js";import{C as S}from"./circle-alert-FqYpxmOc.js";import{C as R}from"./circle-x-BaGiqzw9.js";import{C as p}from"./circle-check-big-Bkn7QkAB.js";import{C as D}from"./clock-C62Gyxh0.js";import{F as $}from"./file-text-BxtABGWy.js";import{k as ae,u as ie}from"./react-vendor-DmU5vXC9.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./bell-Ogze43Aj.js";import"./user-txy-ji6A.js";import"./TopUpModal-ME58Tvqo.js";import"./select-BMlCfmgX.js";import"./index-CEVvJeOa.js";import"./chevron-down-BUo5rrj4.js";import"./loader-circle-0W2tavOT.js";const ne=({status:r})=>{const t=a=>{switch(a){case"pending":return"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";case"confirmed":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"cancelled":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";case"completed":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";default:return"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200"}};return e.jsx(I,{className:"bg-primary/5 dark:bg-primary/10",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-semibold text-primary dark:text-primary-foreground",children:"Booking Request Details"}),e.jsx(T,{className:t(r),children:r.charAt(0).toUpperCase()+r.slice(1)})]})})},le=({renter:r,renterRating:t})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(F,{className:"h-4 w-4 text-primary"})}),"Renter Information"]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:r.avatar_url?x.storage.from("avatars").getPublicUrl(r.avatar_url).data.publicUrl:"/placeholder.svg",alt:r.full_name,className:"w-16 h-16 rounded-full object-cover border-2 border-primary/20"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:r.full_name}),typeof t=="number"&&e.jsxs("div",{className:"flex items-center gap-1 text-yellow-500 mt-1",children:[e.jsx(F,{className:"h-4 w-4 fill-current"}),e.jsx("span",{children:t.toFixed(1)})]})]})]})]}),oe=({car:r})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(se,{className:"h-4 w-4 text-primary"})}),"Requested Car"]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("img",{src:r.image_url||"/placeholder.svg",alt:`${r.brand} ${r.model}`,className:"w-full md:w-48 h-32 object-cover rounded-lg"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"font-medium text-lg text-foreground",children:[r.brand," ",r.model]}),e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(y,{className:"h-4 w-4 mr-1"}),r.location]}),e.jsxs("p",{className:"text-sm font-medium flex items-center",children:[e.jsx(E,{className:"h-4 w-4 mr-1 text-primary"}),"BWP ",r.price_per_day," per day"]})]})]})]}),ce=({startDate:r,endDate:t,startTime:a,endTime:n})=>e.jsxs("div",{className:"bg-card rounded-lg p-4 border",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(N,{className:"h-4 w-4 text-primary"})}),"Booking Dates"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Start Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(N,{className:"h-4 w-4 mr-2 text-primary"}),A(new Date(r),"PPP"),a&&` at ${a}`]})]}),e.jsxs("div",{className:"p-3 rounded-md bg-background",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"End Date"}),e.jsxs("p",{className:"font-medium flex items-center",children:[e.jsx(N,{className:"h-4 w-4 mr-2 text-primary"}),A(new Date(t),"PPP"),n&&` at ${n}`]})]})]})]}),de=({totalPrice:r})=>e.jsx("div",{className:"bg-card rounded-lg p-4 border",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(E,{className:"h-4 w-4 text-primary"})}),e.jsx("p",{className:"font-semibold",children:"Total Price"})]}),e.jsxs("p",{className:"text-xl font-bold",children:["BWP ",r]})]})}),me=({bookingTotal:r,canApproveBooking:t})=>{const n=r*.15;return e.jsxs("div",{className:"space-y-4 p-6 border-t",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4 flex items-center",children:[e.jsx("span",{className:"p-1.5 rounded-full bg-primary/10 dark:bg-primary/20 mr-2",children:e.jsx(re,{className:"h-4 w-4 text-primary"})}),"Wallet & Commission"]}),e.jsx(ee,{bookingTotal:r,showCommissionBreakdown:!0}),e.jsx(v,{className:"bg-blue-50 border-blue-200 dark:bg-blue-950 dark:border-blue-800",children:e.jsx(w,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(te,{className:"h-5 w-5 text-blue-600 dark:text-blue-400 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-medium text-blue-800 dark:text-blue-200",children:"Commission Payment"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-700 dark:text-blue-300",children:[e.jsxs("p",{children:["Total Booking: P",r.toFixed(2)]}),e.jsxs("p",{children:["Platform Commission (15%): P",n.toFixed(2)]}),e.jsx("p",{className:"font-semibold text-blue-800 dark:text-blue-200",children:"Will be deducted from your wallet balance"})]}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:["You'll receive the full rental amount (P",r.toFixed(2),") while commission is paid from your wallet."]})]})]})})}),!t&&e.jsxs(Q,{variant:"destructive",children:[e.jsx(S,{className:"h-4 w-4"}),e.jsxs(V,{children:["You need sufficient wallet balance to cover the P",n.toFixed(2)," commission plus P50 minimum balance to accept this booking."]})]})]})},ue=({isCarOwner:r,isRenter:t,canApproveBooking:a,onApprove:n,onCancel:i,onContact:s,isLoading:o})=>r?e.jsxs(j,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(d,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-3 sm:order-1",onClick:s,disabled:o,children:[e.jsx(k,{className:"h-4 w-4"}),"Contact Renter"]}),e.jsxs(d,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-2 sm:order-2 text-destructive border-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:i,disabled:o,children:[e.jsx(R,{className:"h-4 w-4"}),"Reject Request"]}),e.jsx(_,{children:e.jsxs(P,{children:[e.jsx(q,{asChild:!0,children:e.jsx("div",{className:"w-full sm:w-auto order-1 sm:order-3",children:e.jsxs(d,{variant:"default",className:"flex items-center gap-2 w-full sm:w-auto",onClick:n,disabled:o||!a,children:[e.jsx(p,{className:"h-4 w-4"}),"Approve Request"]})})}),!a&&e.jsx(B,{children:e.jsx("p",{children:"Insufficient wallet balance for commission payment"})})]})})]}):t?e.jsxs(j,{className:"border-t bg-card p-6 flex flex-col sm:flex-row gap-3 justify-end",children:[e.jsxs(d,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-2 sm:order-1",onClick:s,disabled:o,children:[e.jsx(k,{className:"h-4 w-4"}),"Contact Host"]}),e.jsxs(d,{variant:"outline",className:"flex items-center gap-2 w-full sm:w-auto order-1 sm:order-2 text-destructive border-destructive hover:bg-destructive hover:text-destructive-foreground",onClick:i,disabled:o,children:[e.jsx(R,{className:"h-4 w-4"}),"Cancel Request"]})]}):e.jsx(j,{className:"border-t bg-card p-6",children:e.jsx(_,{children:e.jsxs(P,{children:[e.jsx(q,{asChild:!0,children:e.jsxs("div",{className:"flex items-center text-muted-foreground gap-2",children:[e.jsx(S,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Only car owners can approve requests"})]})}),e.jsx(B,{children:e.jsx("p",{children:"You don't have permission to manage this booking request"})})]})})}),xe=({userRole:r,startDate:t,startTime:a,carName:n})=>{const i=r==="host"?[{icon:e.jsx(p,{className:"h-5 w-5 text-green-600"}),title:"Prepare Your Vehicle",description:`Clean your ${n} inside and out. Check fluids, tire pressure, and ensure it's in perfect condition.`},{icon:e.jsx(y,{className:"h-5 w-5 text-blue-600"}),title:"Fuel Up",description:"Fill the fuel tank completely before handover. This ensures a smooth start for your renter."},{icon:e.jsx(D,{className:"h-5 w-5 text-orange-600"}),title:"Be Ready Early",description:`Arrive 15 minutes before ${a||"09:00"} on ${t} for a smooth handover process.`},{icon:e.jsx($,{className:"h-5 w-5 text-purple-600"}),title:"Documentation",description:"Have your vehicle registration and any relevant documents ready for the renter."}]:[{icon:e.jsx($,{className:"h-5 w-5 text-blue-600"}),title:"Verify Your Documents",description:"Ensure your driver's license is valid and complete any required verification steps."},{icon:e.jsx(D,{className:"h-5 w-5 text-green-600"}),title:"Plan Your Pickup",description:`Arrive 15 minutes early on ${t} at ${a||"09:00"} for vehicle inspection.`},{icon:e.jsx(p,{className:"h-5 w-5 text-orange-600"}),title:"Inspect the Vehicle",description:`Thoroughly inspect the ${n} and document any existing damage before driving.`},{icon:e.jsx(y,{className:"h-5 w-5 text-purple-600"}),title:"Contact Information",description:"Save the host's contact information and familiarize yourself with the pickup location."}];return e.jsxs(v,{className:"mt-4",children:[e.jsx(I,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5 text-green-600"}),"What's Next?",e.jsx(T,{variant:"secondary",className:"ml-auto",children:r==="host"?"For Host":"For Renter"})]})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-4",children:i.map((s,o)=>e.jsxs("div",{className:"flex gap-3 p-3 rounded-lg bg-muted/50",children:[e.jsx("div",{className:"flex-shrink-0 mt-0.5",children:s.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-sm mb-1",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]})]},o))})})]})},Ye=()=>{const{id:r}=ae(),t=ie(),{toast:a}=z(),n=Y(),{userId:i}=Z();G();const{data:s,isLoading:o}=g({queryKey:["booking-request",r],queryFn:async()=>{console.log("Fetching booking request details for ID:",r);const{data:l,error:c}=await x.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            full_name,
            avatar_url
          ),
          car:cars (
            brand,
            model,
            image_url,
            location,
            price_per_day,
            owner_id
          )
        `).eq("id",r).single();if(c)throw c;return l}}),m=i===(s==null?void 0:s.car.owner_id),W=i===(s==null?void 0:s.renter_id),{data:H}=g({queryKey:["renter-rating",s==null?void 0:s.renter_id],queryFn:async()=>{if(!(s!=null&&s.renter_id))return null;const{data:l}=await x.rpc("calculate_user_rating",{user_uuid:s.renter_id});return l},enabled:!!(s!=null&&s.renter_id)}),{data:h}=g({queryKey:["wallet-acceptance-check",i,s==null?void 0:s.total_price],queryFn:async()=>!i||!(s!=null&&s.total_price)||!m?null:await b.checkHostCanAcceptBooking(i,s.total_price),enabled:!!i&&!!(s!=null&&s.total_price)&&m}),f=O({mutationFn:async({status:l})=>{if(console.log("Updating booking status:",l),l==="confirmed"&&s&&i){const u=await b.checkHostCanAcceptBooking(i,s.total_price);if(!u.canAccept)throw new Error(u.message||"Insufficient wallet balance");if(!await b.processCommissionOnBookingConfirmation(i,s.id,s.total_price))throw new Error("Failed to process commission payment")}const{error:c}=await x.from("bookings").update({status:l}).eq("id",r);if(c)throw c},onSuccess:(l,c)=>{const u=c.status==="confirmed"?"approved":"cancelled";a({title:`Booking ${u}`,description:c.status==="confirmed"?"Booking approved and commission deducted from your wallet.":"The booking request has been cancelled."}),n.invalidateQueries({queryKey:["booking-request",r]}),n.invalidateQueries({queryKey:["wallet-balance"]})},onError:l=>{console.error("Error updating booking status:",l),a({title:"Error",description:l.message||"Failed to update the booking status. Please try again.",variant:"destructive"})}}),K=()=>{f.mutate({status:"confirmed"})},M=()=>{f.mutate({status:"cancelled"})},U=async()=>{if(s!=null&&s.renter_id)try{t("/messages",{state:{recipientId:s.renter_id,recipientName:s.renter.full_name}}),a({title:"Opening conversation",description:`Starting conversation with ${s.renter.full_name}`})}catch(l){console.error("Error navigating to messages:",l),a({title:"Error",description:"Failed to start conversation. Please try again.",variant:"destructive"})}};if(o)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),e.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})});if(!s)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Booking request not found"})});const C=(h==null?void 0:h.canAccept)??!0;return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(d,{variant:"ghost",className:"mb-6 flex items-center",onClick:()=>t(-1),children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(v,{className:"overflow-hidden",children:[e.jsx(ne,{status:s.status}),e.jsxs(w,{className:"p-6 space-y-8",children:[e.jsx(le,{renter:s.renter,renterRating:H}),e.jsx(oe,{car:s.car}),e.jsx(ce,{startDate:s.start_date,endDate:s.end_date,startTime:s.start_time,endTime:s.end_time}),e.jsx(de,{totalPrice:s.total_price})]}),m&&s.status==="pending"&&e.jsx(me,{bookingTotal:s.total_price,canApproveBooking:C}),s.status==="pending"&&e.jsx(ue,{isCarOwner:m,isRenter:W,canApproveBooking:C,onApprove:K,onCancel:M,onContact:U,isLoading:f.isPending}),s.status==="confirmed"&&e.jsx(xe,{userRole:m?"host":"renter",startDate:s.start_date,startTime:s.start_time,carName:`${s.car.brand} ${s.car.model}`})]})}),e.jsx(J,{})]})};export{Ye as default};
