import{j as e,u as E,a as R}from"./query-vendor-C7aRRP05.js";import{c as $,ao as F,I as z,S as T,g as A,h as K,i as Q,k as g,B as k,v as p,C as _,X as I,s as h,r as V,y as S}from"./index-CV3rVyoS.js";import{C as H,N as P}from"./Navigation-NsQjHjAL.js";import{S as N}from"./skeleton-CYOfnvba.js";import{u as q,r as b}from"./react-vendor-mnpoGfEl.js";import{C as j,d as v}from"./card-BYz0HUlZ.js";import{M as U}from"./map-pin-DSTFqCgm.js";import{R as W}from"./rotate-ccw-j14JiNRn.js";import{C as D}from"./clock-DmPI1L3z.js";import{a as y}from"./date-vendor-Dhms5dOu.js";import{C as X}from"./car-Bf051nla.js";import{C as Y}from"./circle-check-big-vUkh3tr9.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./bell-Dr02D-Bx.js";import"./user-BnZM330N.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const B=$("CalendarDays",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]),G=({searchTerm:s,onSearchChange:c,statusFilter:d,onStatusChange:a})=>e.jsx("div",{className:"px-4 space-y-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(F,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(z,{placeholder:"Search by car, location...",value:s,onChange:r=>c(r.target.value),className:"pl-10"})]}),e.jsxs(T,{value:d,onValueChange:a,children:[e.jsx(A,{className:"w-full sm:w-[180px]",children:e.jsx(K,{placeholder:"Filter by status"})}),e.jsxs(Q,{children:[e.jsx(g,{value:"all",children:"All Status"}),e.jsx(g,{value:"pending",children:"Pending"}),e.jsx(g,{value:"confirmed",children:"Confirmed"}),e.jsx(g,{value:"completed",children:"Completed"}),e.jsx(g,{value:"cancelled",children:"Cancelled"})]})]})]})}),J=({booking:s,onCancelBooking:c})=>{const d=q(),a=()=>{d(`/rental-details/${s.id}`)},r=x=>{x.stopPropagation(),c(s.id)},i=()=>{if(s.early_return&&s.status==="completed")return e.jsxs(p,{variant:"secondary",className:"bg-purple-100 text-purple-800 flex items-center gap-1 text-xs",children:[e.jsx(W,{className:"h-3 w-3"})," Returned Early"]});switch(s.status){case"pending":return e.jsxs(p,{variant:"outline",className:"flex items-center gap-1 text-xs",children:[e.jsx(D,{className:"h-3 w-3"})," Pending"]});case"confirmed":return e.jsxs(p,{variant:"success",className:"bg-green-100 text-green-800 flex items-center gap-1 text-xs",children:[e.jsx(_,{className:"h-3 w-3"})," Confirmed"]});case"cancelled":return e.jsxs(p,{variant:"destructive",className:"flex items-center gap-1 text-xs",children:[e.jsx(I,{className:"h-3 w-3"})," Cancelled"]});case"completed":return e.jsxs(p,{variant:"default",className:"flex items-center gap-1 text-xs",children:[e.jsx(_,{className:"h-3 w-3"})," Completed"]});default:return e.jsx(p,{className:"text-xs",children:s.status})}};return e.jsx(j,{className:"cursor-pointer hover:bg-muted/50 transition-colors overflow-hidden",onClick:a,children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("img",{src:s.cars.image_url||"/placeholder.svg",alt:`${s.cars.brand} ${s.cars.model}`,className:"w-20 h-20 object-cover rounded-md flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium truncate",children:[s.cars.brand," ",s.cars.model]}),e.jsxs("p",{className:"text-xs text-muted-foreground truncate flex items-center gap-1 mt-1",children:[e.jsx(U,{size:12,className:"text-red-500"}),s.cars.location]})]}),e.jsx("div",{children:i()})]})})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsx("div",{className:"flex flex-col justify-start items-start",children:e.jsxs("span",{className:"font-medium flex gap-1 text-xs",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{size:12,className:"text-blue-500"}),y(new Date(s.start_date),"PP")," -"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{size:12,className:"text-blue-500"}),y(new Date(s.end_date),"PP")]})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-medium text-base text-primary",children:["BWP ",s.total_price]}),s.status==="pending"&&e.jsx(k,{variant:"outline",size:"sm",onClick:r,children:"Cancel"})]})]})]})})})},M=()=>{const{data:s,isLoading:c}=E({queryKey:["renter-booking-stats"],queryFn:async()=>{const{data:{user:a}}=await h.auth.getUser();if(!a)throw new Error("No user found");const{data:r,error:i}=await h.from("bookings").select("status, start_date, end_date").eq("renter_id",a.id);if(i)throw i;const x=new Date;x.setHours(0,0,0,0);const m=r.length,C=r.filter(o=>o.status==="confirmed"&&new Date(o.start_date)<=x&&new Date(o.end_date)>=x).length,f=r.filter(o=>o.status==="completed").length,w=r.filter(o=>o.status==="pending").length;return{total:m,active:C,completed:f,pending:w}}});if(c)return e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 px-4",children:[...Array(4)].map((a,r)=>e.jsx(N,{className:"h-20 w-full"},r))});const d=[{title:"Total Bookings",value:(s==null?void 0:s.total)||0,icon:X,iconColor:"text-blue-600",bgColor:"bg-blue-50"},{title:"Active Trips",value:(s==null?void 0:s.active)||0,icon:H,iconColor:"text-green-600",bgColor:"bg-green-50"},{title:"Completed",value:(s==null?void 0:s.completed)||0,icon:Y,iconColor:"text-purple-600",bgColor:"bg-purple-50"},{title:"Pending",value:(s==null?void 0:s.pending)||0,icon:D,iconColor:"text-amber-600",bgColor:"bg-amber-50"}];return e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 px-4",children:d.map((a,r)=>e.jsx(j,{className:"overflow-hidden",children:e.jsx(v,{className:"p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground font-medium",children:a.title}),e.jsx("p",{className:"text-lg font-bold",children:a.value})]}),e.jsx("div",{className:`p-2 rounded-full ${a.bgColor}`,children:e.jsx(a.icon,{className:`h-4 w-4 ${a.iconColor}`})})]})})},r))})},ue=()=>{const s=q(),{toast:c}=V(),d=R(),[a,r]=b.useState(""),[i,x]=b.useState("all"),{data:m,isLoading:C,error:f}=E({queryKey:["renter-bookings"],queryFn:async()=>{console.log("Fetching renter bookings");const{data:t}=await h.auth.getSession();if(!t.session)throw new Error("No active session found");const{data:l,error:n}=await h.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            image_url,
            owner_id,
            location,
            price_per_day
          ),
          reviews!reviews_booking_id_fkey (
            id
          )
        `).eq("renter_id",t.session.user.id).order("created_at",{ascending:!1});if(n)throw console.error("Error fetching bookings:",n),n;return console.log("Renter bookings fetched:",l),l},retry:2}),w=async t=>{var n;const{data:l}=await h.auth.getSession();(n=l.session)!=null&&n.user&&await h.rpc("create_booking_notification",{p_booking_id:t.id,p_notification_type:"booking_cancelled",p_content:`Booking for ${t.cars.brand} ${t.cars.model} from ${y(new Date(t.start_date),"PPP")} to ${y(new Date(t.end_date),"PPP")} has been cancelled.`})},o=async t=>{try{const l=m==null?void 0:m.find(L=>L.id===t);if(!l)return;const{error:n}=await h.from("bookings").update({status:"cancelled"}).eq("id",t);if(n)throw console.error("Error updating booking:",n),n;await w(l),await d.invalidateQueries({queryKey:["renter-bookings"]}),c({title:"Success",description:"Booking cancelled successfully",variant:"default"})}catch(l){console.error("Error cancelling booking:",l),c({title:"Error",description:"Failed to cancel booking",variant:"destructive"}),d.invalidateQueries({queryKey:["renter-bookings"]})}},u=m==null?void 0:m.filter(t=>{const l=a===""||t.cars.brand.toLowerCase().includes(a.toLowerCase())||t.cars.model.toLowerCase().includes(a.toLowerCase())||t.cars.location.toLowerCase().includes(a.toLowerCase()),n=i==="all"||t.status===i;return l&&n});return b.useEffect(()=>{f&&(console.error("Booking query error:",f),c({title:"Error loading bookings",description:"Please try again later or contact support",variant:"destructive"}))},[f,c]),C?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(k,{variant:"ghost",size:"icon",disabled:!0,children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Bookings"})]}),e.jsx(M,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsx(N,{className:"h-20 w-full"})})}),e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsx(N,{className:"h-20 w-full"})})}),e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsx(N,{className:"h-20 w-full"})})})]})]}),e.jsx(P,{})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"container py-4 space-y-4",children:[e.jsxs("div",{className:"px-4 py-4 mb-4 flex items-center gap-4",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>s(-1),children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx("h1",{className:"text-xl md:text-2xl text-left font-semibold",children:"My Bookings"})]}),e.jsx(M,{}),e.jsx(G,{searchTerm:a,onSearchChange:r,statusFilter:i,onStatusChange:x}),e.jsx("div",{className:"px-4",children:(u==null?void 0:u.length)===0?e.jsx("div",{className:"text-center py-8 border rounded-md",children:e.jsx("p",{className:"text-muted-foreground",children:a||i!=="all"?"No bookings match your search criteria.":"You don't have any bookings yet."})}):e.jsx("div",{className:"space-y-4",children:u==null?void 0:u.map(t=>e.jsx(J,{booking:t,onCancelBooking:o},t.id))})})]}),e.jsx(P,{})]})};export{ue as default};
