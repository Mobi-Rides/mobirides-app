import{u as M,j as t}from"./query-vendor-C7aRRP05.js";import{R as f,k as Y,u as G,r as h}from"./react-vendor-mnpoGfEl.js";import{B as j,y as R,H as Q,s as d,J as I}from"./index-DJr5SZzu.js";import{C as D,a as k,b as L,d as B}from"./card-DMFn2_TK.js";import{I as V}from"./ImageUpload-DI_uX5HM.js";import{S as N}from"./separator-Bx5yWe5w.js";import{S as X}from"./star-DQurhe2X.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./date-vendor-Dhms5dOu.js";import"./camera-BcCOKkLE.js";var U={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},z=f.createContext&&f.createContext(U),Z=["attr","size","title"];function ee(e,r){if(e==null)return{};var s=te(e,r),a,l;if(Object.getOwnPropertySymbols){var m=Object.getOwnPropertySymbols(e);for(l=0;l<m.length;l++)a=m[l],!(r.indexOf(a)>=0)&&Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}function te(e,r){if(e==null)return{};var s={};for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){if(r.indexOf(a)>=0)continue;s[a]=e[a]}return s}function b(){return b=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var s=arguments[r];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a])}return e},b.apply(this,arguments)}function F(e,r){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,a)}return s}function y(e){for(var r=1;r<arguments.length;r++){var s=arguments[r]!=null?arguments[r]:{};r%2?F(Object(s),!0).forEach(function(a){re(e,a,s[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):F(Object(s)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(s,a))})}return e}function re(e,r,s){return r=se(r),r in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s,e}function se(e){var r=ae(e,"string");return typeof r=="symbol"?r:r+""}function ae(e,r){if(typeof e!="object"||!e)return e;var s=e[Symbol.toPrimitive];if(s!==void 0){var a=s.call(e,r);if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(e)}function q(e){return e&&e.map((r,s)=>f.createElement(r.tag,y({key:s},r.attr),q(r.child)))}function ne(e){return r=>f.createElement(ie,b({attr:y({},e.attr)},r),q(e.child))}function ie(e){var r=s=>{var{attr:a,size:l,title:m}=e,w=ee(e,Z),g=l||s.size||"1em",c;return s.className&&(c=s.className),e.className&&(c=(c?c+" ":"")+e.className),f.createElement("svg",b({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},s.attr,a,w,{className:c,style:y(y({color:e.color||s.color},s.style),e.style),height:g,width:g,xmlns:"http://www.w3.org/2000/svg"}),m&&f.createElement("title",null,m),e.children)};return z!==void 0?f.createElement(z.Consumer,null,s=>r(s)):r(U)}function oe(e){return ne({attr:{viewBox:"0 0 576 512"},child:[{tag:"path",attr:{d:"M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z"},child:[]}]})(e)}const je=()=>{const{bookingId:e}=Y(),r=G(),[s,a]=h.useState(0),[l,m]=h.useState(""),[w,g]=h.useState(!1),[c,T]=h.useState([]),[_,$]=h.useState(!1),{data:i,isLoading:A}=M({queryKey:["booking-review",e],queryFn:async()=>{const{data:n,error:o}=await d.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            owner_id,
            vehicle_type,
            image_url,
            owner:profiles!owner_id(
              full_name
            )
          ),
          renter:profiles!renter_id(
            full_name
          )
        `).eq("id",e).single();if(o)throw o;const{data:{user:x}}=await d.auth.getUser(),v=(x==null?void 0:x.id)===n.renter_id;if(v&&(!n.cars.owner||!n.cars.owner.full_name)){const{data:u,error:p}=await d.from("profiles").select("full_name").eq("id",n.cars.owner_id).single();!p&&u&&(n.cars.owner=u)}else if(!v&&(!n.renter||!n.renter.full_name)){const{data:u,error:p}=await d.from("profiles").select("full_name").eq("id",n.renter_id).single();!p&&u&&(n.renter=u)}return console.log("Booking data:",n),n}});h.useEffect(()=>{(async()=>{const{data:{user:o}}=await d.auth.getUser();i&&o&&$(o.id===i.renter_id)})()},[i]);const H=n=>{if(n.target.files){const o=Array.from(n.target.files);T(o)}},W=async()=>{var n;try{g(!0);const{data:{user:o}}=await d.auth.getUser();if(!o)throw new Error("No authenticated user");const x=_?(n=i==null?void 0:i.cars)==null?void 0:n.owner_id:i==null?void 0:i.renter_id;if(!x)throw new Error("No reviewee found");const v=c.map(async E=>{const J=E.name.split(".").pop(),K=`${Date.now()}-${Math.random().toString(36).substring(7)}.${J}`,S=`${i==null?void 0:i.id}/${K}`,{error:P,data:le}=await d.storage.from("return-photos").upload(S,E);if(P)throw P;return S}),u=await Promise.all(v),p="car",{error:O}=await d.from("reviews").insert({booking_id:e,reviewer_id:o.id,reviewee_id:x,car_id:i.car_id,rating:s,comment:l,review_images:u,review_type:p,updated_at:new Date().toISOString()});if(O)throw O;const{error:C}=await d.from("bookings").update({status:"completed"}).eq("id",e);if(C)throw C;I.success("Review submitted successfully"),r("/dashboard")}catch(o){console.error("Error submitting review:",o),I.error("Failed to submit review")}finally{g(!1)}};return A?t.jsx("div",{children:"Loading..."}):!i||!i.cars?t.jsxs("div",{className:"container max-w-2xl py-8",children:[t.jsxs(j,{variant:"ghost",onClick:()=>r(-1),className:"",children:[t.jsx(R,{className:"mr-2 h-4 w-4"}),"Back"]}),t.jsxs(D,{children:[t.jsx(k,{className:"text-left",children:t.jsx(L,{children:"Booking Not Found"})}),t.jsx(B,{children:t.jsx("p",{children:"This booking doesn't exist or has been removed."})})]})]}):t.jsxs("div",{className:"container max-w-2xl py-8",children:[t.jsx("div",{className:"  rounded-lg overflow-hidden mb-6",children:t.jsxs("div",{className:"flex items-center mb-4 relative ",children:[t.jsx("div",{className:"absolute left-0",children:t.jsx(j,{variant:"ghost",onClick:()=>r(-1),className:"p-0",children:t.jsx("div",{className:"flex items-center bg-gray-200 rounded-full p-1",children:t.jsx(R,{className:"h-10 w-10"})})})}),t.jsx("div",{className:"flex-1 text-center",children:t.jsx("h2",{className:"text-base md:text-lg text-slate-800 font-semibold",children:"Leave Review"})})]})}),t.jsxs(D,{className:"rounded-lg overflow-hidden border-none",children:[t.jsx("div",{className:"flex justify-center mt-8",children:t.jsx("img",{src:i.cars.image_url,alt:"Car Image",className:"w-80 h-full rounded-2xl"})}),t.jsxs(k,{className:"text-left",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"px-3 py-1 rounded-2xl text-sm bg-[#F1F0FB] text-[#7C3AED] w-fit mb-2",children:i.cars.vehicle_type}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(oe,{className:"h-4 w-4 text-yellow-400"}),t.jsx("p",{className:"text-sm md:text-base font-medium text-gray-300",children:"4.9"})]})]}),t.jsxs(L,{className:"font-medium mb-4 text-left text-lg md:text-xl text-gray-800",children:[i.cars.brand," ",i.cars.model]}),t.jsx(N,{})]}),t.jsxs(B,{className:"space-y-6",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"font-medium mb-4 text-left text-2xl md:text-2xl text-gray-800 text-center",children:"How is Your Rental Experience?"}),t.jsx(N,{})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx("h6",{className:"font-normal text-gray-400 text-sm md:text-base text-center",children:"Your Overall Rating"}),t.jsx("div",{className:"flex gap-1 text-center justify-center",children:[1,2,3,4,5].map(n=>t.jsx(j,{variant:"ghost",size:"sm",className:n<=s?"text-yellow-500":"",onClick:()=>a(n),children:t.jsx(X,{className:"h-8 w-8 ",fill:n<=s?"currentColor":"none",stroke:(n<=s,"currentColor")})},n))}),t.jsx(N,{})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx("h6",{className:"font-medium text-xs",children:"Enter Detailed Review"}),t.jsx(Q,{placeholder:`Share your experience with this ${_?"host":"renter"}...`,value:l,onChange:n=>m(n.target.value),className:"min-h-[100px] bg-gray-200 rounded-2xl p-4 placeholder:text-xs"})]}),t.jsxs("div",{className:"space-y-2 text-left",children:[t.jsx(V,{onImageChange:H}),c.length>0&&t.jsxs("p",{className:"text-sm text-muted-foreground",children:[c.length," photo(s) selected"]})]}),t.jsx(j,{onClick:W,disabled:s===0||w,className:"w-full",children:w?"Submitting...":"Submit Review"})]})]})]})};export{je as RentalReview,je as default};
