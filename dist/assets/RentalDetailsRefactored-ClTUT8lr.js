import{u as Q,j as e}from"./query-vendor-C7aRRP05.js";import{k as ie,f as Z,r as b,u as P}from"./react-vendor-mnpoGfEl.js";import{a as le,J as oe,s as $,B as m,y as O,v as ce,a4 as de,a5 as H,a6 as L,a7 as F,a9 as me}from"./index-CfXH57CA.js";import{N as A}from"./Navigation-BJhO5yqx.js";import{c as xe,d as he,e as ue,a as G}from"./date-vendor-Dhms5dOu.js";import{K as pe,a as fe,C as je}from"./CarDescription-DYkk2YiS.js";import{C as ge}from"./circle-help-DkWo2E9S.js";import{C as ee}from"./circle-alert-Co0W9q0l.js";import{C as X}from"./circle-check-Dbby2nzi.js";import{C as V}from"./clock-COZh9gHT.js";import{C as I,a as M,b as q,d as S,e as we}from"./card-CZf4UH4z.js";import{C as Ne}from"./car-LgBAYQxH.js";import{M as se}from"./map-pin-BHt1iARb.js";import{C as ve}from"./calendar-I50EbTE7.js";import{S as ye}from"./separator-DiGfKIlq.js";import{C as _e}from"./credit-card-C3Wl-UQ1.js";import{S as Ce}from"./star-B5qnmJNw.js";import{P as De}from"./pen-line-DL1X8j1f.js";import{U as Re}from"./user-FiBtLMcV.js";import{S as k}from"./skeleton-CMwq_CyE.js";import{R as ke}from"./receipt-Bpt_517F.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./bell-vK77m_ng.js";var K=(a=>(a.PICKUP="pickup",a.RETURN="return",a))(K||{});const be=()=>{var z,J;const{id:a}=ie(),i=Z().search.includes("print=true"),[x,c]=b.useState(!1),{data:t,isLoading:s}=Q({queryKey:["rental-details",a],queryFn:async()=>{console.log("Fetching rental details for ID:",a);const{data:n,error:d}=await $.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            id,
            full_name,
            avatar_url
          ),
          cars (
            *,
            owner:profiles!owner_id (
              id,
              full_name,
              avatar_url
            )
          ),
          handover_sessions (
            id,
            handover_completed,
            created_at,
            handover_step_completion (
              step_name,
              is_completed,
              step_order
            )
          )
        `).eq("id",a).single();if(d)throw console.error("Rental details fetch error:",d),d;return console.log("Rental details fetched successfully:",n),n}}),{data:l,isLoading:y}=Q({queryKey:["current-user"],queryFn:async()=>{const{data:{user:n}}=await $.auth.getUser();return n}});b.useEffect(()=>{if(i&&t&&!s){const n=setTimeout(()=>{window.print()},500);return()=>clearTimeout(n)}},[i,t,s]);const g=t&&l&&t.renter_id===l.id,w=t&&l&&((z=t.cars)==null?void 0:z.owner_id)===l.id,j=((t==null?void 0:t.handover_sessions)||[]).sort((n,d)=>new Date(n.created_at).getTime()-new Date(d.created_at).getTime()),N=j.find(n=>{const d=n.handover_step_completion||[],re=d.length>0&&d.every(ne=>ne.is_completed);return n.handover_completed||re}),h=j.length>1?j[1]:null,u=h&&(h.handover_completed||((J=h.handover_step_completion)==null?void 0:J.length)>0&&h.handover_step_completion.every(n=>n.is_completed)),o=new Date,p=t?new Date(t.start_date):null,f=t?new Date(t.end_date):null,B=t&&xe(o,{start:new Date(t.start_date),end:he(new Date(t.end_date),1)}),_=t&&t.status==="confirmed"&&!N&&p&&o>=p,v=t&&t.status==="confirmed"&&N&&!u&&B,C=t&&t.status==="confirmed"&&N&&!u&&f&&o>=f,D=t&&(t.status==="completed"||u),T=v,E=D;p&&o.getDate()===p.getDate()&&o.getMonth()===p.getMonth()&&(o.getFullYear(),p.getFullYear()),f&&o.getDate()===f.getDate()&&o.getMonth()===f.getMonth()&&(o.getFullYear(),f.getFullYear());const R=_,W=(v||C)&&!u,ae=R||W,Y=R?K.PICKUP:K.RETURN;t&&!l&&console.error("User authentication required for handover operations");const te=t?ue(new Date(t.end_date),new Date(t.start_date))+1:0;return{booking:t,isBookingLoading:s,isUserLoading:y,currentUser:l,isRenter:g,isOwner:w,isActiveRental:T,isCompletedRental:E,isPendingPickup:_,isInProgress:v,isPendingReturn:C,isCompleted:D,canHandover:ae,canInitiatePickup:R,canInitiateReturn:W,handoverType:Y,rentalDurationDays:te,isInitiatingHandover:x,handleInitiateHandover:async()=>{var n;if(!t||!l)return null;c(!0);try{return await le(t.id,Y,(n=t.cars)==null?void 0:n.owner_id,t.renter_id)}catch(d){return console.error("Error initiating handover:",d),oe.error("Failed to initiate handover process"),null}finally{c(!1)}},id:a}},Pe=({status:a,onBack:r})=>{const i=()=>{let x="outline",c=e.jsx(ge,{className:"h-3 w-3 mr-1"});switch(a){case"confirmed":x="success",c=e.jsx(X,{className:"h-3 w-3 mr-1"});break;case"pending":x="warning",c=e.jsx(V,{className:"h-3 w-3 mr-1"});break;case"completed":x="default",c=e.jsx(X,{className:"h-3 w-3 mr-1"});break;case"cancelled":x="destructive",c=e.jsx(ee,{className:"h-3 w-3 mr-1"});break}return e.jsxs(ce,{variant:x,className:"flex items-center",children:[c,e.jsx("span",{className:"capitalize",children:a})]})};return e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs(m,{variant:"ghost",onClick:r,children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"Back"]}),i()]})},Ie=({car:a})=>{const r=P();return e.jsxs(I,{className:"overflow-hidden border-border shadow-sm",children:[e.jsx(M,{className:"p-4 bg-muted/30",children:e.jsxs(q,{className:"flex items-center gap-2 text-lg",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Vehicle Information"]})}),e.jsx(S,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("img",{src:a.image_url||"/placeholder.svg",alt:`${a.brand} ${a.model}`,className:"w-full sm:w-32 h-32 sm:h-24 object-cover rounded-lg"}),e.jsxs("div",{className:"flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-lg",children:[a.brand," ",a.model," (",a.year,")"]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground mt-1",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{children:a.location})]})]}),e.jsxs("p",{className:"text-lg font-medium mt-2",children:["BWP ",a.price_per_day," per day"]})]})]})}),e.jsx(we,{className:"p-4 bg-muted/10 border-t",children:e.jsx(m,{variant:"outline",size:"sm",onClick:()=>r(`/car/${a.id}`),className:"text-xs",children:"View Vehicle Details"})})]})},Se=({startDate:a,endDate:r,durationDays:i})=>e.jsxs(I,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(M,{className:"pb-2",children:e.jsxs(q,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(ve,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Rental Duration"]})}),e.jsxs(S,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Start Date"}),e.jsx("p",{className:"font-medium",children:G(new Date(a),"PPP")})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"End Date"}),e.jsx("p",{className:"font-medium",children:G(new Date(r),"PPP")})]})]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(V,{className:"h-4 w-4 text-muted-foreground mr-2"}),e.jsxs("span",{className:"text-sm",children:[i," day",i!==1?"s":""]})]})]})]}),Ue=({pricePerDay:a,durationDays:r,totalPrice:i})=>e.jsxs(I,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(M,{className:"pb-2",children:e.jsxs(q,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(_e,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Payment Details"]})}),e.jsxs(S,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Daily Rate"}),e.jsxs("p",{children:["BWP ",a]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Duration"}),e.jsxs("p",{children:[r," day",r!==1?"s":""]})]}),e.jsx(ye,{}),e.jsxs("div",{className:"flex justify-between font-bold",children:[e.jsx("p",{children:"Total"}),e.jsxs("p",{children:["BWP ",i]})]})]})]}),Be=({bookingId:a,booking:r,canHandover:i,handoverType:x,isInitiatingHandover:c,isCompletedRental:t,isActiveRental:s,isRenter:l,onHandoverInitiate:y,onExtensionRequested:g})=>{const w=P(),[U,j]=b.useState(!1),[N,h]=b.useState(!1),u=()=>{j(!0)},o=()=>{h(!0)};return e.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-end pt-4",children:e.jsxs(de,{children:[t&&e.jsxs(H,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(m,{className:"w-full sm:w-auto flex items-center gap-2",onClick:()=>w(`/rental-review/${a}`),children:[e.jsx(Ce,{className:"h-4 w-4"}),"Write Review"]})}),e.jsx(F,{children:e.jsx("p",{children:"Share your experience with this vehicle"})})]}),s&&l&&e.jsxs(H,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(m,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:u,children:[e.jsx(V,{className:"h-4 w-4"}),"Extend Rental"]})}),e.jsx(F,{children:e.jsx("p",{children:"Request to extend your rental period"})})]}),(s||r.status==="confirmed")&&l&&e.jsxs(H,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(m,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:o,children:[e.jsx(De,{className:"h-4 w-4"}),"Modify Booking"]})}),e.jsx(F,{children:e.jsx("p",{children:"Change pickup time or location"})})]}),i&&e.jsxs(m,{className:"w-full sm:w-auto flex items-center gap-2",variant:"default",onClick:y,disabled:c,children:[e.jsx(pe,{className:"h-4 w-4"}),c?"Initiating...":`Initiate ${x==="pickup"?"Pickup":"Return"}`]}),s&&!i&&e.jsxs(H,{children:[e.jsx(L,{asChild:!0,children:e.jsxs(m,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:()=>w(`/map?handover=true&bookingId=${a}&role=${l?"renter":"host"}`),children:[e.jsx(se,{className:"h-4 w-4"}),"View Handover Status"]})}),e.jsx(F,{children:e.jsx("p",{children:"See the real-time status of your car handover"})})]})]})})},Te=({user:a,role:r})=>e.jsxs(I,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(M,{className:"pb-2",children:e.jsxs(q,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(Re,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),r]})}),e.jsx(S,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:a.avatar_url?$.storage.from("avatars").getPublicUrl(a.avatar_url).data.publicUrl:"/placeholder.svg",alt:a.full_name||r,className:"w-12 h-12 rounded-full object-cover bg-muted"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:a.full_name||r}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Vehicle ",r]})]})]})})]}),Ee=()=>{const a=P();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(m,{variant:"ghost",onClick:()=>a(-1),children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(k,{className:"h-8 w-48 ml-4"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(k,{className:"h-64 w-full rounded-lg"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(k,{className:"h-48 w-full rounded-lg"}),e.jsx(k,{className:"h-48 w-full rounded-lg"})]}),e.jsx(k,{className:"h-48 w-full rounded-lg"})]}),e.jsx(A,{})]})},He=()=>{const a=P();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(m,{variant:"ghost",className:"mb-6",onClick:()=>a(-1),children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(I,{children:e.jsx(S,{className:"py-10",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-3",children:[e.jsx(ee,{className:"h-10 w-10 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Rental details not found"}),e.jsx("p",{className:"text-muted-foreground",children:"The rental information you're looking for could not be found."}),e.jsx(m,{onClick:()=>a("/bookings"),children:"View All Bookings"})]})})}),e.jsx(A,{})]})},os=()=>{var B,_,v,C,D,T;const a=P();Z();const[r,i]=b.useState(0),{user:x,isAuthenticated:c,isLoading:t}=me(),{booking:s,isBookingLoading:l,isUserLoading:y,isRenter:g,isActiveRental:w,isCompletedRental:U,canHandover:j,handoverType:N,rentalDurationDays:h,isInitiatingHandover:u,handleInitiateHandover:o}=be(),p=()=>{i(E=>E+1)},f=async()=>{if(await o()){const R=g?"renter":"host";a(`/map?bookingId=${s.id}&mode=handover&role=${R}`)}};return l||y?e.jsx(Ee,{}):s?e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20 animate-fade-in",children:[e.jsx(Pe,{status:(s==null?void 0:s.status)||"unknown",onBack:()=>a(-1)}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Rental Details"}),U&&e.jsxs(m,{variant:"outline",size:"sm",className:"mt-2 sm:mt-0 flex items-center gap-2",onClick:()=>window.print(),children:[e.jsx(ke,{className:"h-4 w-4"}),"Download Receipt"]})]}),(s==null?void 0:s.cars)&&e.jsx(Ie,{car:s.cars}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[g&&((B=s==null?void 0:s.cars)!=null&&B.owner)?e.jsx(fe,{ownerName:((_=s.cars.owner)==null?void 0:_.full_name)||"Unknown Owner",avatarUrl:((v=s.cars.owner)==null?void 0:v.avatar_url)||"",ownerId:((C=s.cars.owner)==null?void 0:C.id)||""}):s!=null&&s.renter?e.jsx(Te,{user:s.renter,role:"Renter"}):null,(s==null?void 0:s.start_date)&&(s==null?void 0:s.end_date)&&e.jsx(Se,{startDate:s.start_date,endDate:s.end_date,durationDays:h})]}),((D=s==null?void 0:s.cars)==null?void 0:D.description)&&e.jsx(je,{description:s.cars.description}),((T=s==null?void 0:s.cars)==null?void 0:T.price_per_day)&&(s==null?void 0:s.total_price)&&e.jsx(Ue,{pricePerDay:s.cars.price_per_day,durationDays:h,totalPrice:s.total_price}),(s==null?void 0:s.id)&&e.jsx(Be,{bookingId:s.id,booking:s,canHandover:j,handoverType:N,isInitiatingHandover:u,isCompletedRental:U,isActiveRental:w,isRenter:g,onHandoverInitiate:f,onExtensionRequested:p})]}),e.jsx(A,{})]}):e.jsx(He,{})};export{os as default};
