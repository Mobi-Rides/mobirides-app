import{j as r}from"./query-vendor-C7aRRP05.js";import{r as a,h as M}from"./react-vendor-mnpoGfEl.js";import{B as $,s as S,J as B}from"./index-DJr5SZzu.js";import{C as T}from"./CarGrid-CFFEem4e.js";import{S as k}from"./SearchFilters-DYicadUf.js";import{S as i}from"./skeleton-BhL2eYwv.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./date-vendor-Dhms5dOu.js";import"./card-DMFn2_TK.js";import"./savedCarService-BmxknAfR.js";import"./separator-Bx5yWe5w.js";import"./star-DQurhe2X.js";import"./popover-BK9ujFOl.js";import"./chevron-left-B1nGMQIr.js";import"./LocationSearchInput-DI27tYf8.js";import"./map-pin-ZtPByMlX.js";import"./clock-B-BcoQFY.js";import"./calendar-DXV6iOkH.js";import"./arrow-up-down-CTAHKhNN.js";const h=12,ar=()=>{const[n,p]=a.useState([]),[m,u]=a.useState(!0),[l,f]=a.useState(1),[q,w]=a.useState(0),[x,A]=M(),[o,j]=a.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),[y,E]=a.useState(!0);a.useEffect(()=>{const t=x.get("location")||"";j(e=>({...e,location:t}))},[x]),a.useEffect(()=>{(async()=>{u(!0);try{let e=S.from("cars").select("*",{count:"exact"}).eq("is_available",!0).range((l-1)*h,l*h-1);o.location&&(e=e.ilike("location",`%${o.location}%`)),o.vehicleType&&(e=e.eq("vehicle_type",o.vehicleType));const L=o.sortBy==="price"?"rental_price":"created_at";e=e.order(L,{ascending:o.sortOrder==="asc"});const{data:c,error:v,count:P}=await e;if(v)throw v;console.log("ðŸ” Fetching ratings for",(c==null?void 0:c.length)||0,"cars");const g=await Promise.all((c||[]).map(async s=>{try{const{data:d,error:C}=await S.rpc("calculate_car_rating",{car_uuid:s.id});return C?(console.error("Error fetching rating for car:",s.id,C),{...s,rating:0}):(console.log(`âœ… Car ${s.brand} ${s.model} (${s.id}): Rating ${d||0}`),{...s,rating:d||0})}catch(d){return console.error("Error calculating rating for car:",s.id,d),{...s,rating:0}}}));console.log("ðŸŽ¯ Final cars with ratings:",g.map(s=>({id:s.id,brand:s.brand,model:s.model,rating:s.rating}))),p(s=>l===1?g:[...s,...g]),w(P||0),E(c.length===h)}catch(e){console.error("Error fetching cars:",e),B.error("Failed to fetch cars.")}finally{u(!1)}})()},[o,l]);const _=t=>{p([]),f(1),j(t)},F=()=>{f(t=>t+1)},b=m&&n.length===0,N=m&&n.length>0;return r.jsxs("div",{className:"container mx-auto px-4 py-8",children:[r.jsx("h1",{className:"text-3xl font-semibold mb-4",children:"Car Listings"}),r.jsx(k,{onFiltersChange:_}),b?r.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[...Array(8)].map((t,e)=>r.jsxs("div",{className:"space-y-3",children:[r.jsx(i,{className:"h-[150px] w-full rounded-md"}),r.jsxs("div",{className:"space-y-1.5",children:[r.jsx(i,{className:"h-4 w-3/4"}),r.jsx(i,{className:"h-4 w-1/2"})]})]},e))}):r.jsxs(r.Fragment,{children:[r.jsx(T,{cars:n,hasMoreItems:y}),N&&r.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4",children:[...Array(4)].map((t,e)=>r.jsxs("div",{className:"space-y-3",children:[r.jsx(i,{className:"h-[150px] w-full rounded-md"}),r.jsxs("div",{className:"space-y-1.5",children:[r.jsx(i,{className:"h-4 w-3/4"}),r.jsx(i,{className:"h-4 w-1/2"})]})]},e))}),y&&!N&&r.jsx($,{onClick:F,className:"w-full mt-4",children:"Load More"}),n.length===0&&!m&&r.jsx("div",{className:"text-center mt-4",children:"No cars found."})]})]})};export{ar as default};
