import{u as Y,j as e}from"./query-vendor-Bsfdn-Hb.js";import{k as ie,f as Q,r as D,u as R}from"./react-vendor-mnpoGfEl.js";import{a as le,J as ce,s as $,B as x,q as L,n as oe,_ as de,$ as U,a0 as T,a1 as E}from"./index-CEKMvnhM.js";import{N as K}from"./Navigation-DrpfU0Fc.js";import{c as me,d as xe,e as he,a as z}from"./date-vendor-Dhms5dOu.js";import{C as J,K as ue,b as pe,a as je}from"./CarDescription-injjabL-.js";import{C as fe}from"./circle-help-cs8iWs3V.js";import{C as G}from"./circle-alert-BQKScKl8.js";import{C as O}from"./clock-BYxaZ7Am.js";import{C as k,a as H,b as F,d as b,e as ge}from"./card-DVWWM3IP.js";import{C as we}from"./car-CVWSXvWw.js";import{M as X}from"./map-pin-DSx0xkt_.js";import{C as Ne}from"./calendar-BxEe8nw1.js";import{S as ve}from"./separator-CNMPkK_g.js";import{C as ye}from"./credit-card-CocXzOfZ.js";import{S as _e}from"./star-CEtrV90q.js";import{P as Ce}from"./pen-line-DPen9Zz9.js";import{U as De}from"./user-C-qQU3Ry.js";import{S as C}from"./skeleton-CHo5tvc9.js";import{R as Re}from"./receipt-D8OU_YBc.js";import"./supabase-vendor-BOn0LdFJ.js";import"./mapbox-vendor-fnXFVHMy.js";import"./bell-B1Cg_jQL.js";var q=(a=>(a.PICKUP="pickup",a.RETURN="return",a))(q||{});const ke=()=>{var W,A;const{id:a}=ie(),i=Q().search.includes("print=true"),[s,c]=D.useState(!1),{data:t,isLoading:d}=Y({queryKey:["rental-details",a],queryFn:async()=>{console.log("Fetching rental details for ID:",a);const{data:n,error:m}=await $.from("bookings").select(`
          *,
          renter:profiles!renter_id (
            id,
            full_name,
            avatar_url
          ),
          cars (
            *,
            owner:profiles!owner_id (
              id,
              full_name,
              avatar_url
            )
          ),
          handover_sessions (
            id,
            handover_completed,
            created_at,
            handover_step_completion (
              step_name,
              is_completed,
              step_order
            )
          )
        `).eq("id",a).single();if(m)throw console.error("Rental details fetch error:",m),m;return console.log("Rental details fetched successfully:",n),n}}),{data:o,isLoading:g}=Y({queryKey:["current-user"],queryFn:async()=>{const{data:{user:n}}=await $.auth.getUser();return n}});D.useEffect(()=>{if(i&&t&&!d){const n=setTimeout(()=>{window.print()},500);return()=>clearTimeout(n)}},[i,t,d]);const P=t&&o&&t.renter_id===o.id,w=t&&o&&((W=t.cars)==null?void 0:W.owner_id)===o.id,f=((t==null?void 0:t.handover_sessions)||[]).sort((n,m)=>new Date(n.created_at).getTime()-new Date(m.created_at).getTime()),N=f.find(n=>{const m=n.handover_step_completion||[],re=m.length>0&&m.every(ne=>ne.is_completed);return n.handover_completed||re}),p=f.length>1?f[1]:null,j=p&&(p.handover_completed||((A=p.handover_step_completion)==null?void 0:A.length)>0&&p.handover_step_completion.every(n=>n.is_completed)),l=new Date,h=t?new Date(t.start_date):null,u=t?new Date(t.end_date):null,S=t&&me(l,{start:new Date(t.start_date),end:xe(new Date(t.end_date),1)}),y=t&&t.status==="confirmed"&&!N&&h&&l>=h,v=t&&t.status==="confirmed"&&N&&!j&&S,_=t&&t.status==="confirmed"&&N&&!j&&u&&l>=u,B=t&&(t.status==="completed"||j),Z=v,ee=B;h&&l.getDate()===h.getDate()&&l.getMonth()===h.getMonth()&&(l.getFullYear(),h.getFullYear()),u&&l.getDate()===u.getDate()&&l.getMonth()===u.getMonth()&&(l.getFullYear(),u.getFullYear());const M=y,V=(v||_)&&!j,se=M||V,ae=M?q.PICKUP:q.RETURN,te=t?he(new Date(t.end_date),new Date(t.start_date))+1:0;return{booking:t,isBookingLoading:d,isUserLoading:g,currentUser:o,isRenter:P,isOwner:w,isActiveRental:Z,isCompletedRental:ee,isPendingPickup:y,isInProgress:v,isPendingReturn:_,isCompleted:B,canHandover:se,canInitiatePickup:M,canInitiateReturn:V,handoverType:ae,rentalDurationDays:te,isInitiatingHandover:s,handleInitiateHandover:async()=>{var n;if(!t||!o)return null;c(!0);try{return await le(t.id,(n=t.cars)==null?void 0:n.owner_id,t.renter_id)}catch(m){return console.error("Error initiating handover:",m),ce.error("Failed to initiate handover process"),null}finally{c(!1)}},id:a}},be=({status:a,onBack:r})=>{const i=()=>{let s="outline",c=e.jsx(fe,{className:"h-3 w-3 mr-1"});switch(a){case"confirmed":s="success",c=e.jsx(J,{className:"h-3 w-3 mr-1"});break;case"pending":s="warning",c=e.jsx(O,{className:"h-3 w-3 mr-1"});break;case"completed":s="default",c=e.jsx(J,{className:"h-3 w-3 mr-1"});break;case"cancelled":s="destructive",c=e.jsx(G,{className:"h-3 w-3 mr-1"});break}return e.jsxs(oe,{variant:s,className:"flex items-center",children:[c,e.jsx("span",{className:"capitalize",children:a})]})};return e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs(x,{variant:"ghost",onClick:r,children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]}),i()]})},Pe=({car:a})=>{const r=R();return e.jsxs(k,{className:"overflow-hidden border-border shadow-sm",children:[e.jsx(H,{className:"p-4 bg-muted/30",children:e.jsxs(F,{className:"flex items-center gap-2 text-lg",children:[e.jsx(we,{className:"h-5 w-5 text-primary"}),"Vehicle Information"]})}),e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("img",{src:a.image_url||"/placeholder.svg",alt:`${a.brand} ${a.model}`,className:"w-full sm:w-32 h-32 sm:h-24 object-cover rounded-lg"}),e.jsxs("div",{className:"flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-semibold text-lg",children:[a.brand," ",a.model," (",a.year,")"]}),e.jsxs("div",{className:"flex items-center gap-1 text-muted-foreground mt-1",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx("span",{children:a.location})]})]}),e.jsxs("p",{className:"text-lg font-medium mt-2",children:["BWP ",a.price_per_day," per day"]})]})]})}),e.jsx(ge,{className:"p-4 bg-muted/10 border-t",children:e.jsx(x,{variant:"outline",size:"sm",onClick:()=>r(`/car/${a.id}`),className:"text-xs",children:"View Vehicle Details"})})]})},Ie=({startDate:a,endDate:r,durationDays:i})=>e.jsxs(k,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(H,{className:"pb-2",children:e.jsxs(F,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Rental Duration"]})}),e.jsxs(b,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Start Date"}),e.jsx("p",{className:"font-medium",children:z(new Date(a),"PPP")})]}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"End Date"}),e.jsx("p",{className:"font-medium",children:z(new Date(r),"PPP")})]})]}),e.jsxs("div",{className:"flex items-center mt-2",children:[e.jsx(O,{className:"h-4 w-4 text-muted-foreground mr-2"}),e.jsxs("span",{className:"text-sm",children:[i," day",i!==1?"s":""]})]})]})]}),Se=({pricePerDay:a,durationDays:r,totalPrice:i})=>e.jsxs(k,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(H,{className:"pb-2",children:e.jsxs(F,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(ye,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),"Payment Details"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Daily Rate"}),e.jsxs("p",{children:["BWP ",a]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{children:"Duration"}),e.jsxs("p",{children:[r," day",r!==1?"s":""]})]}),e.jsx(ve,{}),e.jsxs("div",{className:"flex justify-between font-bold",children:[e.jsx("p",{children:"Total"}),e.jsxs("p",{children:["BWP ",i]})]})]})]}),Be=({bookingId:a,booking:r,canHandover:i,handoverType:s,isInitiatingHandover:c,isCompletedRental:t,isActiveRental:d,isRenter:o,onHandoverInitiate:g,onExtensionRequested:P})=>{const w=R(),[I,f]=D.useState(!1),[N,p]=D.useState(!1),j=()=>{f(!0)},l=()=>{p(!0)};return e.jsx("div",{className:"flex flex-col sm:flex-row gap-3 justify-end pt-4",children:e.jsxs(de,{children:[t&&e.jsxs(U,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(x,{className:"w-full sm:w-auto flex items-center gap-2",onClick:()=>w(`/rental-review/${a}`),children:[e.jsx(_e,{className:"h-4 w-4"}),"Write Review"]})}),e.jsx(E,{children:e.jsx("p",{children:"Share your experience with this vehicle"})})]}),d&&o&&e.jsxs(U,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(x,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:j,children:[e.jsx(O,{className:"h-4 w-4"}),"Extend Rental"]})}),e.jsx(E,{children:e.jsx("p",{children:"Request to extend your rental period"})})]}),(d||r.status==="confirmed")&&o&&e.jsxs(U,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(x,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:l,children:[e.jsx(Ce,{className:"h-4 w-4"}),"Modify Booking"]})}),e.jsx(E,{children:e.jsx("p",{children:"Change pickup time or location"})})]}),i&&e.jsxs(x,{className:"w-full sm:w-auto flex items-center gap-2",variant:"default",onClick:g,disabled:c,children:[e.jsx(ue,{className:"h-4 w-4"}),c?"Initiating...":`Initiate ${s==="pickup"?"Pickup":"Return"}`]}),d&&!i&&e.jsxs(U,{children:[e.jsx(T,{asChild:!0,children:e.jsxs(x,{className:"w-full sm:w-auto flex items-center gap-2",variant:"outline",onClick:()=>w(`/map?handover=true&bookingId=${a}&role=${o?"renter":"host"}`),children:[e.jsx(X,{className:"h-4 w-4"}),"View Handover Status"]})}),e.jsx(E,{children:e.jsx("p",{children:"See the real-time status of your car handover"})})]})]})})},Ue=({user:a,role:r})=>e.jsxs(k,{className:"dark:bg-gray-800 dark:border-gray-700",children:[e.jsx(H,{className:"pb-2",children:e.jsxs(F,{className:"text-lg flex items-center gap-2 dark:text-white",children:[e.jsx(De,{className:"h-5 w-5 text-primary dark:text-primary-foreground"}),r]})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("img",{src:a.avatar_url?$.storage.from("avatars").getPublicUrl(a.avatar_url).data.publicUrl:"/placeholder.svg",alt:a.full_name||r,className:"w-12 h-12 rounded-full object-cover bg-muted"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:a.full_name||r}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Vehicle ",r]})]})]})})]}),Te=()=>{const a=R();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsxs(x,{variant:"ghost",onClick:()=>a(-1),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(C,{className:"h-8 w-48 ml-4"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{className:"h-64 w-full rounded-lg"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(C,{className:"h-48 w-full rounded-lg"}),e.jsx(C,{className:"h-48 w-full rounded-lg"})]}),e.jsx(C,{className:"h-48 w-full rounded-lg"})]}),e.jsx(K,{})]})},Ee=()=>{const a=R();return e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[e.jsxs(x,{variant:"ghost",className:"mb-6",onClick:()=>a(-1),children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsx(k,{children:e.jsx(b,{className:"py-10",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-3",children:[e.jsx(G,{className:"h-10 w-10 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Rental details not found"}),e.jsx("p",{className:"text-muted-foreground",children:"The rental information you're looking for could not be found."}),e.jsx(x,{onClick:()=>a("/bookings"),children:"View All Bookings"})]})})}),e.jsx(K,{})]})},is=()=>{var l,h,u,S,y,v;const a=R();Q();const[r,i]=D.useState(0),{booking:s,isBookingLoading:c,isUserLoading:t,isRenter:d,isActiveRental:o,isCompletedRental:g,canHandover:P,handoverType:w,rentalDurationDays:I,isInitiatingHandover:f,handleInitiateHandover:N}=ke(),p=()=>{i(_=>_+1)},j=async()=>{if(await N()){const B=d?"renter":"host";a(`/map?bookingId=${s.id}&mode=handover&role=${B}`)}};return c||t?e.jsx(Te,{}):s?e.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20 animate-fade-in",children:[e.jsx(be,{status:(s==null?void 0:s.status)||"unknown",onBack:()=>a(-1)}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Rental Details"}),g&&e.jsxs(x,{variant:"outline",size:"sm",className:"mt-2 sm:mt-0 flex items-center gap-2",onClick:()=>window.print(),children:[e.jsx(Re,{className:"h-4 w-4"}),"Download Receipt"]})]}),(s==null?void 0:s.cars)&&e.jsx(Pe,{car:s.cars}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[d&&((l=s==null?void 0:s.cars)!=null&&l.owner)?e.jsx(pe,{ownerName:((h=s.cars.owner)==null?void 0:h.full_name)||"Unknown Owner",avatarUrl:((u=s.cars.owner)==null?void 0:u.avatar_url)||"",ownerId:((S=s.cars.owner)==null?void 0:S.id)||""}):s!=null&&s.renter?e.jsx(Ue,{user:s.renter,role:"Renter"}):null,(s==null?void 0:s.start_date)&&(s==null?void 0:s.end_date)&&e.jsx(Ie,{startDate:s.start_date,endDate:s.end_date,durationDays:I})]}),((y=s==null?void 0:s.cars)==null?void 0:y.description)&&e.jsx(je,{description:s.cars.description}),((v=s==null?void 0:s.cars)==null?void 0:v.price_per_day)&&(s==null?void 0:s.total_price)&&e.jsx(Se,{pricePerDay:s.cars.price_per_day,durationDays:I,totalPrice:s.total_price}),(s==null?void 0:s.id)&&e.jsx(Be,{bookingId:s.id,booking:s,canHandover:P,handoverType:w,isInitiatingHandover:f,isCompletedRental:g,isActiveRental:o,isRenter:d,onHandoverInitiate:j,onExtensionRequested:p})]}),e.jsx(K,{})]}):e.jsx(Ee,{})};export{is as default};
