import{p as f,a4 as se,k as ae,r as h,n as ne,j as e,B as v,g as S,s as x,J as $}from"./index-B1v-fdDy.js";import{C as F,a as q,b as B,d as T}from"./card-BByP0N-G.js";import{T as ie}from"./textarea-iq9NORl0.js";import{I as le}from"./ImageUpload-iLTkREmh.js";import{S as O}from"./separator-BMDiheLN.js";import{A}from"./arrow-left-C5bMyyle.js";import{S as W}from"./star-C2MEvl-w.js";import"./camera-BVx23dB2.js";var Y={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},M=f.createContext&&f.createContext(Y),oe=["attr","size","title"];function ce(t,a){if(t==null)return{};var r=de(t,a),n,l;if(Object.getOwnPropertySymbols){var g=Object.getOwnPropertySymbols(t);for(l=0;l<g.length;l++)n=g[l],!(a.indexOf(n)>=0)&&Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}function de(t,a){if(t==null)return{};var r={};for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){if(a.indexOf(n)>=0)continue;r[n]=t[n]}return r}function C(){return C=Object.assign?Object.assign.bind():function(t){for(var a=1;a<arguments.length;a++){var r=arguments[a];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},C.apply(this,arguments)}function G(t,a){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);a&&(n=n.filter(function(l){return Object.getOwnPropertyDescriptor(t,l).enumerable})),r.push.apply(r,n)}return r}function P(t){for(var a=1;a<arguments.length;a++){var r=arguments[a]!=null?arguments[a]:{};a%2?G(Object(r),!0).forEach(function(n){me(t,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):G(Object(r)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(r,n))})}return t}function me(t,a,r){return a=ue(a),a in t?Object.defineProperty(t,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[a]=r,t}function ue(t){var a=he(t,"string");return typeof a=="symbol"?a:a+""}function he(t,a){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var n=r.call(t,a||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(a==="string"?String:Number)(t)}function J(t){return t&&t.map((a,r)=>f.createElement(a.tag,P({key:r},a.attr),J(a.child)))}function xe(t){return a=>f.createElement(ge,C({attr:P({},t.attr)},a),J(t.child))}function ge(t){var a=r=>{var{attr:n,size:l,title:g}=t,N=ce(t,oe),j=l||r.size||"1em",u;return r.className&&(u=r.className),t.className&&(u=(u?u+" ":"")+t.className),f.createElement("svg",C({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},r.attr,n,N,{className:u,style:P(P({color:t.color||r.color},r.style),t.style),height:j,width:j,xmlns:"http://www.w3.org/2000/svg"}),g&&f.createElement("title",null,g),t.children)};return M!==void 0?f.createElement(M.Consumer,null,r=>a(r)):a(Y)}function fe(t){return xe({tag:"svg",attr:{viewBox:"0 0 576 512"},child:[{tag:"path",attr:{d:"M259.3 17.8L194 150.2 47.9 171.5c-26.2 3.8-36.7 36.1-17.7 54.6l105.7 103-25 145.5c-4.5 26.3 23.2 46 46.4 33.7L288 439.6l130.7 68.7c23.2 12.2 50.9-7.4 46.4-33.7l-25-145.5 105.7-103c19-18.5 8.5-50.8-17.7-54.6L382 150.2 316.7 17.8c-11.7-23.6-45.6-23.9-57.4 0z"},child:[]}]})(t)}const Pe=()=>{const{bookingId:t}=se(),a=ae(),[r,n]=h.useState(0),[l,g]=h.useState(""),[N,j]=h.useState(!1),[u,R]=h.useState([]),[w,K]=h.useState(!1),[p,Q]=h.useState({cleanliness:0,punctuality:0,responsiveness:0,car_condition:0,rental_experience:0});h.useState(1);const[b,E]=h.useState([]),_=w?{title:"Rate Your Host & Car Experience",subtitle:"Help future renters by sharing your experience",categories:{cleanliness:"How clean was the car when you picked it up?",punctuality:"Was the host on time for pickup and return?",responsiveness:"How quickly did the host respond to messages?",car_condition:"How was the overall condition of the car?",rental_experience:"How was your overall rental experience?"},placeholder:"Share details about your rental experience, the car condition, and interaction with the host..."}:{title:"Rate Your Renter Experience",subtitle:"Help future hosts by sharing your experience",categories:{cleanliness:"How did the renter return the car?",punctuality:"Was the renter on time for pickup and return?",responsiveness:"How well did the renter communicate?",car_condition:"Did the renter take good care of your car?",rental_experience:"How was your overall hosting experience?"},placeholder:"Share details about the renter's behavior, communication, and how they treated your car..."},{data:o,isLoading:V}=ne({queryKey:["booking-review",t],queryFn:async()=>{const{data:s,error:i}=await x.from("bookings").select(`
          *,
          cars (
            brand,
            model,
            owner_id,
            vehicle_type,
            image_url
          ),
          renter:profiles!renter_id(
            full_name
          ),
          owner:profiles(
            full_name
          )
        `).eq("id",t).single();if(i)throw i;const{data:{user:c}}=await x.auth.getUser(),m=(c==null?void 0:c.id)===s.renter_id;if(m&&(!s.owner||!s.owner.full_name)){const{data:d,error:y}=await x.from("profiles").select("full_name").eq("id",s.cars.owner_id).single();!y&&d&&(s.owner=d)}else if(!m&&(!s.renter||!s.renter.full_name)){const{data:d,error:y}=await x.from("profiles").select("full_name").eq("id",s.renter_id).single();!y&&d&&(s.renter=d)}return console.log("Booking data:",s),s}});h.useEffect(()=>{(async()=>{const{data:{user:i}}=await x.auth.getUser();o&&i&&K(i.id===o.renter_id)})()},[o]);const X=s=>{if(s.target.files){const i=Array.from(s.target.files);R(i);const c=i.map(m=>URL.createObjectURL(m));E(c)}},Z=s=>{const i=u.filter((m,d)=>d!==s),c=b.filter((m,d)=>d!==s);URL.revokeObjectURL(b[s]),R(i),E(c)},I=()=>{let s=0;r>0&&(s+=20),l.trim().length>0&&(s+=20);const i=Object.values(p).filter(c=>c>0).length;return s+=i/5*40,u.length>0&&(s+=20),Math.min(s,100)},k=()=>r>0&&l.trim().length>=10,ee=async()=>{var s;try{j(!0);const{data:{user:i}}=await x.auth.getUser();if(!i)throw new Error("No authenticated user");const c=w?(s=o==null?void 0:o.cars)==null?void 0:s.owner_id:o==null?void 0:o.renter_id;if(!c)throw new Error("No reviewee found");const m=u.map(async D=>{const te=D.name.split(".").pop(),re=`${Date.now()}-${Math.random().toString(36).substring(7)}.${te}`,H=`${o==null?void 0:o.id}/${re}`,{error:z,data:ve}=await x.storage.from("handover-photos").upload(H,D);if(z)throw z;return H}),d=await Promise.all(m),y=w?"renter_to_host":"host_to_renter",{error:L}=await x.from("reviews").insert({booking_id:t,reviewer_id:i.id,reviewee_id:c,rating:r,comment:l,review_images:d,category_ratings:p,review_type:y,status:"published",updated_at:new Date().toISOString()});if(L)throw L;const{error:U}=await x.from("bookings").update({status:"completed"}).eq("id",t);if(U)throw U;$.success("Review submitted successfully"),a("/dashboard")}catch(i){console.error("Error submitting review:",i),$.error("Failed to submit review")}finally{j(!1)}};return V?e.jsx("div",{children:"Loading..."}):!o||!o.cars?e.jsxs("div",{className:"container max-w-2xl py-8",children:[e.jsxs(v,{variant:"ghost",onClick:()=>a(-1),className:"",children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Back"]}),e.jsxs(F,{children:[e.jsx(q,{className:"text-left",children:e.jsx(B,{children:"Booking Not Found"})}),e.jsx(T,{children:e.jsx("p",{children:"This booking doesn't exist or has been removed."})})]})]}):e.jsxs("div",{className:"container max-w-2xl py-8",children:[e.jsx("div",{className:"  rounded-lg overflow-hidden mb-6",children:e.jsxs("div",{className:"flex items-center mb-4 relative ",children:[e.jsx("div",{className:"absolute left-0",children:e.jsx(v,{variant:"ghost",onClick:()=>a(-1),className:"p-0",children:e.jsx("div",{className:"flex items-center bg-gray-200 rounded-full p-1",children:e.jsx(A,{className:"h-10 w-10"})})})}),e.jsx("div",{className:"flex-1 text-center",children:e.jsx("h2",{className:"text-base md:text-lg text-slate-800 font-semibold",children:"Leave Review"})})]})}),e.jsxs(F,{className:"rounded-lg overflow-hidden border-none",children:[e.jsx("div",{className:"flex justify-center mt-8",children:e.jsx("img",{src:o.cars.image_url,alt:"Car Image",className:"w-80 h-full rounded-2xl"})}),e.jsxs(q,{className:"text-left",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"px-3 py-1 rounded-2xl text-sm bg-[#F1F0FB] text-[#7C3AED] w-fit mb-2",children:o.cars.vehicle_type}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-yellow-400"}),e.jsx("p",{className:"text-sm md:text-base font-medium text-gray-300",children:"4.9"})]})]}),e.jsx(B,{children:e.jsxs("h3",{className:"font-medium mb-4 text-left text-lg md:text-xl text-gray-800",children:[o.cars.brand," ",o.cars.model]})}),e.jsx(O,{})]}),e.jsxs(T,{className:"space-y-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-medium text-xl text-gray-800",children:_.title}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Math.round(I()),"% complete"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:_.subtitle}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all duration-300",style:{width:`${I()}%`}})}),e.jsx(O,{className:"mt-4"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h6",{className:"font-medium text-lg mb-2",children:"Overall Rating"}),e.jsxs("p",{className:"text-sm text-muted-foreground mb-4",children:["Rate your overall ",w?"rental":"hosting"," experience"]})]}),e.jsx("div",{className:"flex gap-2 justify-center",children:[1,2,3,4,5].map(s=>e.jsx(v,{variant:"ghost",size:"lg",className:`p-2 transition-all duration-200 ${s<=r?"text-yellow-500 scale-110":"text-gray-300 hover:text-yellow-400 hover:scale-105"}`,onClick:()=>n(s),children:e.jsx(W,{className:"h-10 w-10",fill:s<=r?"currentColor":"none",stroke:"currentColor"})},s))}),r>0&&e.jsx("p",{className:"text-center text-sm font-medium text-primary",children:r===5?"Excellent!":r===4?"Great!":r===3?"Good":r===2?"Fair":"Poor"}),e.jsx(O,{})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h6",{className:"font-medium text-lg mb-2",children:"Detailed Ratings"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Help others by rating specific aspects (optional)"})]}),e.jsx("div",{className:"grid gap-4",children:Object.entries(_.categories).map(([s,i])=>e.jsxs("div",{className:"p-4 border rounded-lg bg-muted/30",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx(S,{className:"font-medium capitalize",children:s.replace("_"," ")}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:i})]}),e.jsx("div",{className:"text-sm font-medium text-primary",children:p[s]>0?`${p[s]}/5`:"Not rated"})]}),e.jsx("div",{className:"flex gap-1 justify-center mt-3",children:[1,2,3,4,5].map(c=>e.jsx(v,{variant:"ghost",size:"sm",className:`p-1 transition-all duration-200 ${c<=p[s]?"text-yellow-500 scale-110":"text-gray-300 hover:text-yellow-400"}`,onClick:()=>Q(m=>({...m,[s]:c})),children:e.jsx(W,{className:"h-6 w-6",fill:c<=p[s]?"currentColor":"none",stroke:"currentColor"})},c))})]},s))}),e.jsx(O,{})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(S,{className:"font-medium text-lg",children:"Share Your Experience"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Tell others about your experience (minimum 10 characters)"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ie,{placeholder:_.placeholder,value:l,onChange:s=>g(s.target.value),className:`min-h-[120px] bg-background rounded-lg p-4 resize-none transition-colors ${l.trim().length<10&&l.length>0?"border-orange-300 focus:border-orange-500":l.trim().length>=10?"border-green-300 focus:border-green-500":""}`,maxLength:500}),e.jsxs("div",{className:"absolute bottom-2 right-2 text-xs text-muted-foreground",children:[l.length,"/500"]})]}),l.length>0&&l.trim().length<10&&e.jsx("p",{className:"text-sm text-orange-600",children:"Please write at least 10 characters for a meaningful review"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(S,{className:"font-medium text-lg",children:"Add Photos (Optional)"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Share photos to help other users"})]}),e.jsx(le,{onImageChange:X}),b.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium",children:[b.length," photo(s) selected"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:b.map((s,i)=>e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:s,alt:`Preview ${i+1}`,className:"w-full h-24 object-cover rounded-lg border"}),e.jsx(v,{variant:"destructive",size:"sm",className:"absolute top-1 right-1 h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>Z(i),children:"×"})]},i))})]})]}),e.jsxs("div",{className:"pt-4",children:[e.jsx(v,{onClick:ee,disabled:!k()||N,className:"w-full h-12 text-lg font-medium",size:"lg",children:N?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Publishing Review..."]}):`Publish ${w?"Host":"Renter"} Review`}),!k()&&e.jsx("div",{className:"mt-3 p-3 bg-muted rounded-lg",children:e.jsxs("p",{className:"text-sm text-muted-foreground text-center",children:[e.jsx("span",{className:"font-medium",children:"Required to publish:"}),e.jsx("br",{}),r===0&&"• Overall rating",r>0&&l.trim().length<10&&"• At least 10 characters in review"]})})]})]})]})]})};export{Pe as RentalReview,Pe as default};
