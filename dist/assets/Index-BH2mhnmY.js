import{j as r,u as D,d as ee}from"./query-vendor-C7aRRP05.js";import{r as u,u as P,f as U}from"./react-vendor-mnpoGfEl.js";import{u as z,H as te}from"./useHandoverPrompts-DcaY8r3L.js";import{N as re}from"./Navigation-PKFoOZ-i.js";import{u as se}from"./useAuthStatus-DsPl9L_E.js";import{c as q,B as E,A as ae,T as ne,s as S,a as W,J as V,L as oe}from"./index-DJr5SZzu.js";import{C as Z}from"./CarGrid-CFFEem4e.js";import{C as ie}from"./card-DMFn2_TK.js";import{C as B}from"./clock-B-BcoQFY.js";import{M as ce}from"./map-pin-ZtPByMlX.js";import{C as de}from"./car-DLlpGS8d.js";import{a as le}from"./date-vendor-Dhms5dOu.js";import"./sheet-ButSOKiq.js";import"./SearchFilters-DYicadUf.js";import"./popover-BK9ujFOl.js";import"./chevron-left-B1nGMQIr.js";import"./LocationSearchInput-DI27tYf8.js";import"./star-DQurhe2X.js";import"./calendar-DXV6iOkH.js";import"./arrow-up-down-CTAHKhNN.js";import"./useVerificationStatus-DbVU-ikZ.js";import"./circle-alert-rcKd2uBC.js";import"./shield-CWWsRMeH.js";import"./navigation-BDD7imCe.js";import"./supabase-vendor-BOn0LdFJ.js";import"./bell-B7yjendS.js";import"./user-CCMNZbkj.js";import"./mapbox-vendor-fnXFVHMy.js";import"./savedCarService-BmxknAfR.js";import"./separator-Bx5yWe5w.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=q("ArrowDownAZ",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=q("ArrowUpAZ",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M20 8h-5",key:"1vsyxs"}],["path",{d:"M15 10V6.5a2.5 2.5 0 0 1 5 0V10",key:"ag13bf"}],["path",{d:"M15 14h5l-5 6h5",key:"ur5jdg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=q("LogIn",[["path",{d:"M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4",key:"u53s6r"}],["polyline",{points:"10 17 15 12 10 7",key:"1ail0h"}],["line",{x1:"15",x2:"3",y1:"12",y2:"12",key:"v6grx8"}]]),ge=()=>{const[e,t]=u.useState(!1),[a,s]=u.useState("signin"),n=P(),o=u.useCallback(()=>{s("signin"),t(!0),n("/?auth=signin",{replace:!0})},[n]),i=u.useCallback(()=>{s("signup"),t(!0),n("/?auth=signup",{replace:!0})},[n]),c=u.useCallback(()=>{t(!1),n("/",{replace:!0})},[n]);return{isOpen:e,defaultTab:a,openSignIn:o,openSignUp:i,close:c,setIsOpen:t}},he=()=>{const{isOpen:e,defaultTab:t,openSignIn:a,close:s}=ge(),n=U();return u.useEffect(()=>{const i=new URLSearchParams(n.search).get("auth");(i==="signin"||i==="signup")&&i==="signin"&&a()},[n.search,a]),r.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 min-h-[400px] text-center max-w-md mx-auto",children:[r.jsxs("div",{className:"p-8 rounded-lg",children:[r.jsxs("h2",{className:"text-3xl md:text-4xl font-semibold mb-4 text-gray-600",children:["Welcome to Mobirides"," "]}),r.jsx("p",{className:"text-muted-foreground mb-6",children:"Please sign in to browse our collection of cars for rent, save your favorites, and book your next ride!"}),r.jsxs(E,{variant:"outline",size:"icon",className:"rounded-2xl border-primary md:size-auto md:px-4 md:py-2 md:flex md:items-center md:gap-2 mx-auto",onClick:a,children:[r.jsx(ue,{className:"h-4 w-4 text-primary"}),r.jsx("span",{className:"hidden md:inline-block",children:r.jsx("p",{className:"text-primary text-xs md:text-sm lg:text-base font-semibold",children:"Sign in"})})]})]}),r.jsx(ae,{isOpen:e,onClose:s,defaultTab:t,idPrefix:"home"})]})},J=({prompt:e,onStartHandover:t})=>{const a=P(),s=()=>{switch(e.urgencyLevel){case"immediate":return"bg-destructive text-destructive-foreground border-destructive";case"soon":return"bg-orange-50 text-orange-900 border-orange-200 dark:bg-orange-950 dark:text-orange-100 dark:border-orange-800";case"morning":return"bg-blue-50 text-blue-900 border-blue-200 dark:bg-blue-950 dark:text-blue-100 dark:border-blue-800";default:return"bg-muted text-muted-foreground"}},n=()=>{switch(e.urgencyLevel){case"immediate":return r.jsx(ne,{className:"h-5 w-5 animate-pulse"});case"soon":return r.jsx(B,{className:"h-5 w-5"});default:return r.jsx(de,{className:"h-5 w-5"})}},o=()=>{t(e.bookingId)},i=()=>{a(`/rental-details/${e.bookingId}`)};return r.jsx(ie,{className:`p-4 border-l-4 ${s()}`,children:r.jsxs("div",{className:"flex items-start gap-3",children:[r.jsx("div",{className:"flex-shrink-0 mt-0.5",children:n()}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[r.jsx("h3",{className:"font-semibold text-sm",children:e.handoverType==="pickup"?"Car Pickup Required":"Car Return Required"}),e.isUrgent&&r.jsx("span",{className:"px-2 py-1 text-xs bg-current/10 rounded-full font-medium",children:"URGENT"})]}),r.jsxs("p",{className:"text-sm opacity-90 mb-2",children:[e.carBrand," ",e.carModel," â€¢ ",e.otherPartyName]}),r.jsxs("div",{className:"flex items-center gap-4 text-xs opacity-75 mb-3",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(B,{className:"h-3 w-3"}),le(e.handoverType==="pickup"?e.startDate:e.endDate,"MMM d, h:mm a")]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx(ce,{className:"h-3 w-3"}),e.location]})]}),r.jsxs("div",{className:"flex gap-2",children:[e.shouldInitiate?r.jsxs(E,{onClick:o,size:"sm",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",variant:"outline",children:["Start ",e.handoverType==="pickup"?"Pickup":"Return"]}):r.jsxs(E,{onClick:i,size:"sm",variant:"outline",className:"bg-current/20 hover:bg-current/30 text-current border-current/30",children:["Prepare for ",e.handoverType==="pickup"?"Pickup":"Return"]}),r.jsx(E,{onClick:i,size:"sm",variant:"ghost",className:"text-current hover:bg-current/10",children:"View Details"})]})]})]})})},me=({searchQuery:e})=>{const[t,a]=u.useState(null),[s,n]=u.useState("asc"),o=u.useRef(null),i=P(),{handoverPrompts:c,hasHandoverPrompts:g,refetch:p}=z(),{data:b,isLoading:N,error:M}=D({queryKey:["host-cars",e,s,t],queryFn:async()=>{var y;console.log("Fetching host cars with search:",e,"brand:",t);const{data:{session:h}}=await S.auth.getSession();if(!((y=h==null?void 0:h.user)!=null&&y.id))return[];let d=S.from("cars").select("*").eq("owner_id",h.user.id);e&&(d=d.or(`brand.ilike.%${e}%,model.ilike.%${e}%`)),t&&(d=d.eq("brand",t)),d=d.order("price_per_day",{ascending:s==="asc"});const{data:f,error:v}=await d;if(v)throw v;return console.log("Host cars fetched:",f),f}}),C=b||[],R=()=>{n(h=>h==="asc"?"desc":"asc")},w=()=>{console.log("Load more triggered in HostView")},_=async h=>{try{console.log("Starting handover for booking:",h);const{data:d,error:f}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",h).single();if(f)throw f;if(!d)throw new Error("Booking not found");const v=d.cars.owner_id,y=d.renter_id;await W(h,"pickup",v,y)&&(V.success("Handover process started"),i(`/map?bookingId=${h}&mode=handover&role=host`),p())}catch(d){console.error("Error starting handover:",d),V.error("Failed to start handover process")}};return r.jsxs("div",{className:"space-y-6",children:[g&&r.jsx("div",{className:"space-y-3",children:c.map(h=>r.jsx(J,{prompt:h,onStartHandover:_},h.id))}),r.jsx("div",{className:"flex justify-end",children:r.jsx(E,{variant:s?"secondary":"outline",onClick:R,className:`flex items-center gap-2 transition-colors ${s?"bg-accent text-accent-foreground":""}`,children:s==="asc"?r.jsxs(r.Fragment,{children:["Price: Low to High",r.jsx(K,{className:"h-4 w-4"})]}):r.jsxs(r.Fragment,{children:["Price: High to Low",r.jsx(G,{className:"h-4 w-4"})]})})}),r.jsx("div",{className:"text-left flex items-center ",children:r.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"My Cars"})}),r.jsx(Z,{cars:C,isLoading:N,error:M,loadMoreRef:o,onLoadMore:w,isFetchingNextPage:!1,isAuthenticated:!0})]})};var H=new Map,L=new WeakMap,O=0,xe=void 0;function fe(e){return e?(L.has(e)||(O+=1,L.set(e,O.toString())),L.get(e)):"0"}function pe(e){return Object.keys(e).sort().filter(t=>e[t]!==void 0).map(t=>`${t}_${t==="root"?fe(e.root):e[t]}`).toString()}function ve(e){const t=pe(e);let a=H.get(t);if(!a){const s=new Map;let n;const o=new IntersectionObserver(i=>{i.forEach(c=>{var g;const p=c.isIntersecting&&n.some(b=>c.intersectionRatio>=b);e.trackVisibility&&typeof c.isVisible>"u"&&(c.isVisible=p),(g=s.get(c.target))==null||g.forEach(b=>{b(p,c)})})},e);n=o.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),a={id:t,observer:o,elements:s},H.set(t,a)}return a}function be(e,t,a={},s=xe){if(typeof window.IntersectionObserver>"u"&&s!==void 0){const g=e.getBoundingClientRect();return t(s,{isIntersecting:s,target:e,intersectionRatio:typeof a.threshold=="number"?a.threshold:0,time:0,boundingClientRect:g,intersectionRect:g,rootBounds:g}),()=>{}}const{id:n,observer:o,elements:i}=ve(a),c=i.get(e)||[];return i.has(e)||i.set(e,c),c.push(t),o.observe(e),function(){c.splice(c.indexOf(t),1),c.length===0&&(i.delete(e),o.unobserve(e)),i.size===0&&(o.disconnect(),H.delete(n))}}function ye({threshold:e,delay:t,trackVisibility:a,rootMargin:s,root:n,triggerOnce:o,skip:i,initialInView:c,fallbackInView:g,onChange:p}={}){var b;const[N,M]=u.useState(null),C=u.useRef(p),[R,w]=u.useState({inView:!!c,entry:void 0});C.current=p,u.useEffect(()=>{if(i||!N)return;let f;return f=be(N,(v,y)=>{w({inView:v,entry:y}),C.current&&C.current(v,y),y.isIntersecting&&o&&f&&(f(),f=void 0)},{root:n,rootMargin:s,threshold:e,trackVisibility:a,delay:t},g),()=>{f&&f()}},[Array.isArray(e)?e.toString():e,N,n,s,o,i,a,g,t]);const _=(b=R.entry)==null?void 0:b.target,h=u.useRef(void 0);!N&&_&&!o&&!i&&h.current!==_&&(h.current=_,w({inView:!!c,entry:void 0}));const d=[M,R.inView,R.entry];return d.ref=d[0],d.inView=d[1],d.entry=d[2],d}const T=10,we=async({pageParam:e=0,filters:t,searchParams:a})=>{console.log("Starting car fetch with params:",{pageParam:e,filters:t,searchParams:a});let s=S.from("cars").select("*",{count:"exact"}).eq("is_available",!0);s=s.range(e*T,(e+1)*T-1),a!=null&&a.searchTerm&&(console.log("Applying search term:",a.searchTerm),s=s.or(`brand.ilike.%${a.searchTerm}%,model.ilike.%${a.searchTerm}%`)),a!=null&&a.brand&&(console.log("Filtering by brand:",a.brand),s=s.eq("brand",a.brand)),t!=null&&t.model&&(s=s.ilike("model",`%${t.model}%`)),t!=null&&t.year&&(s=s.eq("year",t.year)),t!=null&&t.minPrice&&(s=s.gte("price_per_day",t.minPrice)),t!=null&&t.maxPrice&&(s=s.lte("price_per_day",t.maxPrice)),t!=null&&t.vehicleType&&(s=s.eq("vehicle_type",t.vehicleType)),t!=null&&t.location&&(s=s.ilike("location",`%${t.location}%`)),(t==null?void 0:t.sortBy)==="price"&&(s=s.order("price_per_day",{ascending:t.sortOrder==="asc"})),console.log("Executing Supabase query...");const{data:n,error:o,count:i}=await s;if(o)throw console.error("Error fetching cars:",o),o;const c=(n||[]).filter(g=>g&&g.id&&g.brand&&g.model);return console.log("Valid cars fetched:",c.length,"from",(n==null?void 0:n.length)||0),{data:c,nextPage:c.length===T?e+1:void 0,count:i}},je=e=>{if(!e||typeof e!="object")throw new Error("Invalid car object provided to toSafeCar");return{...e,description:e.description??"No description available",features:e.features??[],image_url:e.image_url??"/placeholder-car.jpg",latitude:e.latitude??0,longitude:e.longitude??0,is_available:e.is_available??!0}},Ne=({searchQuery:e,filters:t,onFiltersChange:a})=>{const[s,n]=u.useState(null),[o,i]=u.useState("asc"),{ref:c,inView:g}=ye(),p=u.useRef(null),b=P(),{handoverPrompts:N,hasHandoverPrompts:M,refetch:C}=z(),R=l=>{p.current!==l&&(p.current=l||null),c(l)};u.useEffect(()=>{a({...t,sortOrder:o})},[o,a,t]);const{data:w,isLoading:_,error:h,hasNextPage:d,fetchNextPage:f,isFetchingNextPage:v}=ee({queryKey:["available-cars",s,t,e],queryFn:({pageParam:l=0})=>we({pageParam:l,filters:t,searchParams:{...s?{brand:s}:{},...e?{searchTerm:e}:{}}}),getNextPageParam:l=>l.nextPage||void 0,initialPageParam:0}),{data:y}=D({queryKey:["saved-car-ids"],queryFn:async()=>{var j;console.log("Fetching saved car IDs for home page");const{data:{session:l}}=await S.auth.getSession();if(!((j=l==null?void 0:l.user)!=null&&j.id))return new Set;const{data:x,error:k}=await S.from("saved_cars").select("car_id").eq("user_id",l.user.id);if(k)return console.error("Error fetching saved cars:",k),new Set;const m=new Set(x.map(A=>A.car_id));return console.log("Saved car IDs for home page:",Array.from(m)),m}}),$=y||new Set,[X,F]=u.useState([]),I=(w==null?void 0:w.pages.flatMap(l=>l.data.filter(x=>x&&typeof x=="object"&&x.id).map(x=>({...je(x),isSaved:$.has(x.id)}))))||[];u.useEffect(()=>{(async()=>{if(I.length===0){F([]);return}console.log(`[RenterView] Fetching ratings for ${I.length} cars`);const x=I.map(async m=>{try{const{data:j,error:A}=await S.rpc("calculate_car_rating",{car_uuid:m.id});return A?(console.error(`[RenterView] Error fetching rating for car ${m.id}:`,A),{...m,rating:0}):(console.log(`[RenterView] Car ${m.brand} ${m.model} (${m.id}) rating:`,j),{...m,rating:j||0})}catch(j){return console.error(`[RenterView] Exception fetching rating for car ${m.id}:`,j),{...m,rating:0}}}),k=await Promise.all(x);console.log("[RenterView] Final cars with ratings:",k.map(m=>({id:m.id,brand:m.brand,model:m.model,rating:m.rating}))),F(k)})()},[I.length,w]),u.useEffect(()=>{g&&d&&!v&&f()},[g,d,v,f]);const Y=()=>{i(l=>l==="asc"?"desc":"asc")},Q=async l=>{try{console.log("Starting handover for booking:",l);const{data:x,error:k}=await S.from("bookings").select(`
          id,
          renter_id,
          cars!inner(owner_id)
        `).eq("id",l).single();if(k)throw k;if(!x)throw new Error("Booking not found");const m=x.cars.owner_id,j=x.renter_id;await W(l,"pickup",m,j)&&(V.success("Handover process started"),b(`/map?bookingId=${l}&mode=handover&role=renter`),C())}catch(x){console.error("Error starting handover:",x),V.error("Failed to start handover process")}};return r.jsxs("div",{className:"space-y-6",children:[M&&r.jsx("div",{className:"space-y-3",children:N.map(l=>r.jsx(J,{prompt:l,onStartHandover:Q},l.id))}),r.jsx("div",{className:"flex justify-end",children:r.jsx(E,{variant:o?"secondary":"outline",onClick:Y,className:`flex items-center gap-2 transition-colors ${o?"bg-accent text-accent-foreground":""}`,children:o==="asc"?r.jsxs(r.Fragment,{children:["Price: Low to High",r.jsx(K,{className:"h-4 w-4"})]}):r.jsxs(r.Fragment,{children:["Price: High to Low",r.jsx(G,{className:"h-4 w-4"})]})})}),r.jsx("div",{className:"text-left flex items-center ",children:r.jsx("h3",{className:"font-bold  break-words line-clamp-2 text-sm md:text-base text-gray-500 dark:text-white",children:"Available Cars"})}),r.jsx(Z,{cars:X,isLoading:_,error:h,loadMoreRef:p,isFetchingNextPage:v,isAuthenticated:!0}),d&&r.jsx("div",{ref:R,className:"h-10 w-full opacity-0",children:"Load more trigger"})]})},et=()=>{const[e,t]=u.useState(""),[a,s]=u.useState({startDate:void 0,endDate:void 0,vehicleType:void 0,location:"",sortBy:"price",sortOrder:"asc"}),n=U(),{isAuthenticated:o,userRole:i,isLoadingRole:c}=se(),g=u.useCallback(p=>{s(p)},[]);return u.useEffect(()=>{},[n.search]),r.jsxs("div",{className:"min-h-screen bg-background pb-20",children:[r.jsx(te,{searchQuery:e,onSearchChange:t,onFiltersChange:s}),r.jsx("main",{className:"container mx-auto px-4 py-8",children:c?r.jsx(oe,{}):o?i==="host"?r.jsx(me,{searchQuery:e}):r.jsx(Ne,{searchQuery:e,filters:a,onFiltersChange:g}):r.jsx(he,{})}),r.jsx(re,{})]})};export{et as default};
