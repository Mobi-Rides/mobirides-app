import{a as E,u as M,b as z,j as t}from"./query-vendor-BOSMW7hd.js";import{r as S,u as F}from"./react-vendor-DmU5vXC9.js";import{a3 as I,s as l,J as P,n as y,B as k,C as K,X as H,ak as L,y as O,W as U,D as G,al as J,b as V,d as W,e as X,I as Z,af as ee,ag as te,ah as b,ai as se}from"./index-BZNlRMb5.js";import{N as R}from"./Navigation-z5f_RoHO.js";import{C as ie,d as ae}from"./card-B-j8bacD.js";import{B}from"./bell-8rHeSCpD.js";import{C as re}from"./credit-card-BMie6ekS.js";import{C as ne}from"./car-DZKAUCoq.js";import{f as oe}from"./date-vendor-Dhms5dOu.js";import{S as $}from"./skeleton-CFM6Me78.js";import{S as ce}from"./settings-BE9fjUFx.js";import"./supabase-vendor-B3A6ooRR.js";import"./mapbox-vendor-ueN8uhVJ.js";import"./map-pin-DGKLSCI6.js";import"./user-IUVdgFgk.js";const de=()=>{const{user:e}=I(),a=E(),{data:s=[],isLoading:n,error:g}=M({queryKey:["notifications",e==null?void 0:e.id],queryFn:async()=>{if(!(e!=null&&e.id))return[];const{data:c,error:d}=await l.from("notifications").select(`
          *,
          bookings:related_booking_id (
            id,
            start_date,
            end_date,
            total_price,
            status,
            cars (
              id,
              brand,
              model,
              image_url
            )
          ),
          cars:related_car_id (
            id,
            brand,
            model,
            image_url
          )
        `).eq("user_id",e.id).order("created_at",{ascending:!1});if(d)throw d;return c||[]},enabled:!!(e!=null&&e.id)}),o=s.filter(c=>!c.is_read).length;return S.useEffect(()=>{if(!(e!=null&&e.id))return;const c=l.channel("notifications-changes").on("postgres_changes",{event:"*",schema:"public",table:"notifications",filter:`user_id=eq.${e.id}`},()=>{a.invalidateQueries({queryKey:["notifications",e.id]})}).subscribe();return()=>{l.removeChannel(c)}},[e==null?void 0:e.id,a]),{notifications:s,unreadCount:o,isLoading:n,error:g,markAsRead:async c=>{const{error:d}=await l.from("notifications").update({is_read:!0}).eq("id",c);return d||a.invalidateQueries({queryKey:["notifications",e==null?void 0:e.id]}),{error:d}},markAllAsRead:async()=>{if(!(e!=null&&e.id))return{error:new Error("No user")};const{error:c}=await l.from("notifications").update({is_read:!0}).eq("user_id",e.id).eq("is_read",!1);return c||a.invalidateQueries({queryKey:["notifications",e.id]}),{error:c}},deleteNotification:async c=>{const{error:d}=await l.from("notifications").delete().eq("id",c);return d||a.invalidateQueries({queryKey:["notifications",e==null?void 0:e.id]}),{error:d}}}};class le{static async createBookingReminders(){try{const a=new Date,s=new Date(a);s.setDate(s.getDate()+1);const n=new Date(a);n.setHours(n.getHours()+2);const g=new Date(a);g.setMinutes(g.getMinutes()+30);const{data:o}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",s.toISOString().split("T")[0]).eq("preparation_reminder_sent",!1),{data:m}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",a.toISOString().split("T")[0]),{data:u}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("status","confirmed").eq("start_date",a.toISOString().split("T")[0]);if(o)for(const i of o){const c=`${i.cars.brand} ${i.cars.model}`;await l.from("notifications").insert({user_id:i.renter_id,type:"pickup_reminder_renter",title:"Pickup Reminder",description:`Your rental of ${c} starts tomorrow at ${i.start_time}. Please prepare for pickup.`,content:`Your rental of ${c} starts tomorrow at ${i.start_time}. Please prepare for pickup.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:i.cars.owner_id,type:"pickup_reminder_host",title:"Pickup Reminder",description:`Your ${c} rental starts tomorrow at ${i.start_time}. Please prepare for handover.`,content:`Your ${c} rental starts tomorrow at ${i.start_time}. Please prepare for handover.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"host_only",metadata:{}}),await l.from("bookings").update({preparation_reminder_sent:!0}).eq("id",i.id)}if(m)for(const i of m){const _=(new Date(`${i.start_date}T${i.start_time}`).getTime()-a.getTime())/(1e3*60*60);if(_<=2.5&&_>=1.5){const p=`${i.cars.brand} ${i.cars.model}`;await l.from("notifications").insert({user_id:i.renter_id,type:"pickup_reminder_renter",title:"2 Hour Pickup Reminder",description:`Your rental of ${p} starts in 2 hours at ${i.start_time}. Time to head to pickup location!`,content:`Your rental of ${p} starts in 2 hours at ${i.start_time}. Time to head to pickup location!`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:i.cars.owner_id,type:"pickup_reminder_host",title:"2 Hour Pickup Reminder",description:`Your ${p} handover is in 2 hours at ${i.start_time}. Please ensure the car is ready.`,content:`Your ${p} handover is in 2 hours at ${i.start_time}. Please ensure the car is ready.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"host_only",metadata:{}})}}if(u)for(const i of u){const _=(new Date(`${i.start_date}T${i.start_time}`).getTime()-a.getTime())/(1e3*60);if(_<=35&&_>=25){const p=`${i.cars.brand} ${i.cars.model}`;await l.from("notifications").insert({user_id:i.renter_id,type:"pickup_reminder_renter",title:"30 Minute Pickup Reminder",description:`Your rental of ${p} starts in 30 minutes! Time for final preparations.`,content:`Your rental of ${p} starts in 30 minutes! Time for final preparations.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"renter_only",metadata:{}}),await l.from("notifications").insert({user_id:i.cars.owner_id,type:"pickup_reminder_host",title:"30 Minute Pickup Reminder",description:`Your ${p} handover is in 30 minutes! Please be ready at the pickup location.`,content:`Your ${p} handover is in 30 minutes! Please be ready at the pickup location.`,related_booking_id:i.id,related_car_id:i.cars.id,role_target:"host_only",metadata:{}})}}}catch(a){console.error("Error creating booking reminders:",a)}}static async sendPostConfirmationGuidance(a,s){try{const{data:n}=await l.from("bookings").select(`
          id,
          start_date,
          start_time,
          renter_id,
          cars (
            id,
            brand,
            model,
            owner_id
          )
        `).eq("id",a).single();if(!n)return;const g=`${n.cars.brand} ${n.cars.model}`,o=`${n.start_date} at ${n.start_time}`;s==="host"?await l.from("notifications").insert({user_id:n.cars.owner_id,type:"booking_confirmed_host",title:"Booking Confirmed - Next Steps",description:`Booking confirmed! Next steps: 1) Prepare your ${g} for handover on ${o}. 2) Ensure fuel tank is full. 3) Clean the vehicle. 4) Be ready 15 minutes early.`,content:`Booking confirmed! Next steps: 1) Prepare your ${g} for handover on ${o}. 2) Ensure fuel tank is full. 3) Clean the vehicle. 4) Be ready 15 minutes early.`,related_booking_id:n.id,related_car_id:n.cars.id,role_target:"host_only",metadata:{}}):await l.from("notifications").insert({user_id:n.renter_id,type:"booking_confirmed_renter",title:"Booking Confirmed - Next Steps",description:`Booking confirmed! Next steps: 1) Prepare for pickup on ${o}. 2) Bring your driver's license. 3) Complete any required verification. 4) Arrive 15 minutes early.`,content:`Booking confirmed! Next steps: 1) Prepare for pickup on ${o}. 2) Bring your driver's license. 3) Complete any required verification. 4) Arrive 15 minutes early.`,related_booking_id:n.id,related_car_id:n.cars.id,role_target:"renter_only",metadata:{}})}catch(n){console.error("Error sending post-confirmation guidance:",n)}}}const me=()=>{const e=E(),{user:a}=I(),s=z({mutationFn:async({bookingId:o,status:m})=>{const{error:u}=await l.from("bookings").update({status:m}).eq("id",o);if(u)throw u},onSuccess:(o,m)=>{const u=m.status==="confirmed"?"approved":"cancelled";P.success(`Booking ${u}`),m.status==="confirmed"&&a&&le.sendPostConfirmationGuidance(m.bookingId,"host"),e.invalidateQueries({queryKey:["booking-request",m.bookingId]}),e.invalidateQueries({queryKey:["notifications"]}),e.invalidateQueries({queryKey:["bookings"]})},onError:o=>{P.error("Failed to update the booking status. Please try again.")}});return{acceptBooking:o=>{s.mutate({bookingId:o,status:"confirmed"})},declineBooking:o=>{s.mutate({bookingId:o,status:"cancelled"})},isLoading:s.status==="pending",error:s.error}};class v{static classifyNotification(a){const s=String(a.type);return s.includes("booking")||s.includes("request")||s.includes("confirmed")||s.includes("cancelled")?{type:"booking",confidence:95,details:`Classified as booking notification based on type: ${s}`}:s.includes("wallet")||s.includes("payment")||s.includes("topup")||s.includes("deduction")||s==="payment_received"||s==="payment_failed"?{type:"payment",confidence:95,details:`Classified as payment notification based on type: ${s}`}:s.includes("pickup")||s.includes("return")||s.includes("handover")||s.includes("navigation")||s.includes("arrival")||s.includes("location_shared")?{type:"handover",confidence:90,details:`Classified as handover notification based on type: ${s}`}:s==="system_notification"||s.includes("system")?{type:"system",confidence:95,details:`Classified as system notification based on type: ${s}`}:{type:"system",confidence:50,details:`Default classification for type: ${s}`}}static isBookingNotification(a){const s=String(a.type);return s.includes("booking")||s.includes("request")||s.includes("confirmed")||s.includes("cancelled")}static isPaymentNotification(a){const s=String(a.type);return s.includes("wallet")||s.includes("payment")||s.includes("topup")||s.includes("deduction")||s==="payment_received"||s==="payment_failed"}static isActiveRentalNotification(a){const s=String(a.type);return s.includes("pickup")||s.includes("return")||s.includes("handover")||s.includes("navigation")||s.includes("arrival")||s.includes("location_shared")}static isSystemNotification(a){const s=String(a.type);return s==="system_notification"||s.includes("system")}}function Y({notification:e,onMarkAsRead:a,onDelete:s,onAcceptBooking:n,onDeclineBooking:g,compact:o=!1}){const m=F(),u=v.classifyNotification(e),i=()=>{switch(u.type){case"booking":return t.jsx(ne,{className:"h-5 w-5"});case"payment":return t.jsx(re,{className:"h-5 w-5"});default:return t.jsx(B,{className:"h-5 w-5"})}},c=()=>{switch(u.type){case"booking":return e.type.includes("booking_confirmed")?"text-green-600":e.type.includes("booking_cancelled")?"text-red-600":"text-blue-600";case"payment":return"text-emerald-600";default:return"text-gray-600"}},d=()=>{switch(u.type){case"booking":return e.type.includes("booking_confirmed")?"default":e.type.includes("booking_cancelled")?"destructive":"secondary";case"payment":return"default";default:return"outline"}},_=()=>{var f,x;!e.is_read&&a&&a(((f=e.id)==null?void 0:f.toString())||""),e.related_booking_id?m(`/bookings/${e.related_booking_id}`):u.type==="payment"?m("/wallet"):m(`/notifications/${(x=e.id)==null?void 0:x.toString()}`)},p=e.type.includes("booking_request")&&!e.is_read&&n&&g;return t.jsx(ie,{className:`
        transition-all duration-200 hover:shadow-md cursor-pointer
        ${e.is_read?"hover:bg-muted/50":"border-primary/50 bg-primary/5"}
        ${o?"p-3":""}
      `,onClick:_,children:t.jsx(ae,{className:o?"p-0":"p-4",children:t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("div",{className:`mt-1 ${c()}`,children:i()}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-start justify-between gap-2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("p",{className:`text-sm ${e.is_read?"":"font-medium"}`,children:e.content}),e.bookings&&t.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[e.bookings.brand," ",e.bookings.model]})]}),t.jsxs("div",{className:"flex flex-col items-end gap-1",children:[t.jsx(y,{variant:d(),className:"text-xs",children:u.type}),t.jsx("span",{className:"text-xs text-muted-foreground",children:oe(new Date(e.created_at),{addSuffix:!0})})]})]}),p&&t.jsxs("div",{className:"flex gap-2 mt-3",onClick:f=>f.stopPropagation(),children:[t.jsxs(k,{size:"sm",onClick:()=>n(e.related_booking_id),className:"flex-1",children:[t.jsx(K,{className:"h-4 w-4 mr-1"}),"Accept"]}),t.jsxs(k,{size:"sm",variant:"outline",onClick:()=>g(e.related_booking_id),className:"flex-1",children:[t.jsx(H,{className:"h-4 w-4 mr-1"}),"Decline"]})]}),!o&&t.jsxs("div",{className:"flex items-center gap-2 mt-3",onClick:f=>f.stopPropagation(),children:[!e.is_read&&a&&t.jsxs(k,{size:"sm",variant:"ghost",onClick:()=>{var f;return a(((f=e.id)==null?void 0:f.toString())||"")},children:[t.jsx(L,{className:"h-4 w-4 mr-1"}),"Mark as read"]}),s&&t.jsxs(k,{size:"sm",variant:"ghost",onClick:()=>{var f;return s(((f=e.id)==null?void 0:f.toString())||"")},children:[t.jsx(O,{className:"h-4 w-4 mr-1"}),"Delete"]}),t.jsx("div",{className:"flex-1"}),t.jsx(U,{className:"h-4 w-4 text-muted-foreground"})]})]})]})})})}function C(e){var a;return{id:e.id,user_id:e.user_id||"",type:e.type,title:e.title||"",description:e.description||e.content||e.title||"",content:e.content||e.description||e.title||"",is_read:e.is_read||!1,created_at:e.created_at||new Date().toISOString(),updated_at:e.updated_at||e.created_at||new Date().toISOString(),expires_at:e.expires_at||null,metadata:e.metadata||{},role_target:e.role_target||"system_wide",related_booking_id:e.related_booking_id||null,related_car_id:e.related_car_id||null,bookings:(a=e.bookings)!=null&&a.cars?{brand:e.bookings.cars.brand,model:e.bookings.cars.model}:null}}const Se=()=>{const{notifications:e,unreadCount:a,isLoading:s,markAsRead:n,markAllAsRead:g,deleteNotification:o}=de(),{acceptBooking:m,declineBooking:u}=me(),[i,c]=S.useState(""),[d,_]=S.useState("all"),p=e.filter(r=>{const h=C(r),w=`${h.content} ${h.title||""}`.toLowerCase();return i&&!w.includes(i.toLowerCase())?!1:d==="all"?!0:d==="active_rentals"?v.isActiveRentalNotification(h):v.classifyNotification(h).type===d}),f=p.filter(r=>!r.is_read),x=p.filter(r=>r.is_read),q=async r=>{await n(r)},T=async r=>{await o(r)},Q=async()=>{await g()},D=async r=>{await m(r)},A=async r=>{await u(r)},N=(()=>{const r={all:e.length,booking:0,payment:0,active_rentals:0,system:0};return e.forEach(h=>{const w=C(h),j=v.classifyNotification(w);j.type==="booking"&&r.booking++,j.type==="payment"&&r.payment++,j.type==="system"&&r.system++,v.isActiveRentalNotification(w)&&r.active_rentals++}),r})();return s?t.jsxs("div",{className:"min-h-screen bg-background",children:[t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx($,{className:"h-8 w-32"}),t.jsx($,{className:"h-8 w-8 rounded-full"})]}),t.jsx($,{className:"h-10 w-full"}),t.jsx("div",{className:"space-y-3",children:[...Array(5)].map((r,h)=>t.jsx($,{className:"h-20 w-full"},h))})]}),t.jsx(R,{})]}):t.jsxs("div",{className:"min-h-screen bg-background",children:[t.jsxs("div",{className:"p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-6",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(B,{className:"h-6 w-6 text-primary"}),t.jsx("h1",{className:"text-2xl font-bold",children:"Notifications"}),a>0&&t.jsx(y,{variant:"destructive",className:"ml-2",children:a})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsxs(G,{children:[t.jsx(J,{asChild:!0,children:t.jsx(k,{variant:"outline",size:"sm",children:t.jsx(ce,{className:"h-4 w-4"})})}),t.jsxs(V,{children:[t.jsx(W,{children:t.jsx(X,{children:"Notification Settings"})}),t.jsx("div",{className:"p-4",children:t.jsx("p",{className:"text-muted-foreground",children:"Notification preferences coming soon..."})})]})]}),a>0&&t.jsx(k,{onClick:Q,variant:"outline",size:"sm",children:"Mark all read"})]})]}),t.jsx("div",{className:"mb-4",children:t.jsx(Z,{placeholder:"Search notifications...",value:i,onChange:r=>c(r.target.value),className:"w-full"})}),t.jsxs(ee,{value:d,onValueChange:_,className:"w-full mb-6",children:[t.jsxs(te,{className:"grid w-full grid-cols-5",children:[t.jsxs(b,{value:"all",className:"flex items-center gap-2",children:["All",t.jsx(y,{variant:"secondary",className:"text-xs",children:N.all})]}),t.jsxs(b,{value:"booking",className:"flex items-center gap-2",children:["Bookings",t.jsx(y,{variant:"secondary",className:"text-xs",children:N.booking})]}),t.jsxs(b,{value:"payment",className:"flex items-center gap-2",children:["Payments",t.jsx(y,{variant:"secondary",className:"text-xs",children:N.payment})]}),t.jsxs(b,{value:"active_rentals",className:"flex items-center gap-2",children:["Rentals",t.jsx(y,{variant:"secondary",className:"text-xs",children:N.active_rentals})]}),t.jsxs(b,{value:"system",className:"flex items-center gap-2",children:["System",t.jsx(y,{variant:"secondary",className:"text-xs",children:N.system})]})]}),t.jsx(se,{value:d,className:"mt-4",children:t.jsxs("div",{className:"space-y-4",children:[f.length>0&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h3",{className:"text-sm font-medium text-muted-foreground",children:["Unread (",f.length,")"]}),f.map(r=>t.jsx(Y,{notification:C(r),onMarkAsRead:q,onDelete:T,onAcceptBooking:D,onDeclineBooking:A},`unread-${r.id}`))]}),x.length>0&&t.jsxs("div",{className:"space-y-3",children:[t.jsxs("h3",{className:"text-sm font-medium text-muted-foreground",children:["Read (",x.length,")"]}),x.map(r=>t.jsx(Y,{notification:C(r),onMarkAsRead:q,onDelete:T,onAcceptBooking:D,onDeclineBooking:A},`read-${r.id}`))]}),p.length===0&&t.jsxs("div",{className:"text-center py-12",children:[t.jsx(B,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium mb-2",children:"No notifications found"}),t.jsx("p",{className:"text-muted-foreground",children:i?"Try adjusting your search terms":d==="all"?"You're all caught up!":`No ${d} notifications found`})]})]})})]})]}),t.jsx(R,{})]})};export{Se as default};
