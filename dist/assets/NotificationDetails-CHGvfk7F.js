import{M as b,u as f,j as o,B as c,J as s,s as g}from"./index-BAM2AQzj.js";import{a as w}from"./useQuery-BBHzqejZ.js";import{N as k}from"./Navigation-DcFnTla_.js";import{A as N}from"./arrow-left-ZSxCSMqd.js";import{A as y}from"./arrow-right-CC1csBZ0.js";import{M as p}from"./map-pin-CoQHT-KY.js";import"./badge-La64XLSg.js";const A=()=>{const{id:l}=b(),d=f(),{data:e,isLoading:x}=w({queryKey:["notification",l],queryFn:async()=>{console.log("Fetching notification details for ID:",l);try{const{data:t,error:i}=await g.from("notifications").select(`
            *,
            booking:bookings!related_booking_id (
              id,
              cars (
                owner_id
              )
            )
          `).eq("id",l).single();if(i)throw console.error("Error fetching notification:",i),i;return await g.from("notifications").update({is_read:!0}).eq("id",l),t}catch(t){throw console.error("Error in notification query:",t),s.error("Failed to load notification details"),t}}}),m=async()=>{var t,i,u;if(console.log("Location request initiated"),!((t=e==null?void 0:e.booking)!=null&&t.id)||!((u=(i=e==null?void 0:e.booking)==null?void 0:i.cars)!=null&&u.owner_id)){console.error("Missing booking information:",{notification:e}),s.error("Booking information not found");return}try{if(!navigator.geolocation){console.error("Geolocation not supported"),s.error("Geolocation is not supported by your browser");return}const n=navigator.geolocation.watchPosition(async r=>{console.log("Position received:",{lat:r.coords.latitude,lng:r.coords.longitude});try{const{data:{user:a},error:h}=await g.auth.getUser();if(h)throw new Error("Authentication error: "+h.message);if(!a)throw new Error("User not authenticated");d(`/map?bookingId=${e.booking.id}&hostId=${e.booking.cars.owner_id}&mode=handover`)}catch(a){console.error("Error processing location update:",a),s.error(a instanceof Error?a.message:"Failed to process location update"),navigator.geolocation.clearWatch(n),localStorage.removeItem("locationWatchId")}},r=>{console.error("Geolocation error:",r);let a="Failed to get your location";switch(r.code){case r.PERMISSION_DENIED:a="Location permission denied. Please enable location services.";break;case r.POSITION_UNAVAILABLE:a="Location information is unavailable.";break;case r.TIMEOUT:a="Location request timed out.";break}s.error(a)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0});localStorage.setItem("locationWatchId",n.toString()),console.log("Location watch started with ID:",n)}catch(n){console.error("Error in location request handler:",n),s.error("Failed to process location request. Please try again.")}};return x?o.jsx("div",{className:"container mx-auto px-4 py-8",children:o.jsxs("div",{className:"animate-pulse space-y-4",children:[o.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"}),o.jsx("div",{className:"h-32 bg-gray-200 dark:bg-gray-700 rounded"})]})}):o.jsxs("div",{className:"container mx-auto px-4 py-8 pb-20",children:[o.jsxs(c,{variant:"ghost",className:"mb-6",onClick:()=>d(-1),children:[o.jsx(N,{className:"mr-2 h-4 w-4"}),"Back"]}),o.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700",children:[o.jsx("h1",{className:"text-2xl font-semibold mb-4 dark:text-white",children:"Notification Details"}),e?o.jsxs("div",{className:"space-y-4",children:[o.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:e.content}),o.jsxs("p",{className:"text-sm text-gray-400 dark:text-gray-500",children:["Received on:"," ",new Date(e.created_at).toLocaleDateString()]}),e.type==="booking_request"&&e.related_booking_id&&o.jsxs("div",{className:"space-y-2",children:[o.jsxs(c,{className:"w-full",onClick:()=>d(`/booking-requests/${e.related_booking_id}`),children:["View Booking Request",o.jsx(y,{className:"ml-2 h-4 w-4"})]}),e.content.includes("requesting your location")&&o.jsxs(c,{variant:"default",className:"w-full bg-primary hover:bg-primary/90",onClick:m,children:["Share Location & View Host",o.jsx(p,{className:"ml-2 h-4 w-4"})]})]}),e.type==="message_received"&&e.related_booking_id&&e.content.includes("requesting your location")&&o.jsxs("div",{className:"space-y-2",children:[o.jsxs(c,{className:"w-full",onClick:()=>d(`/rental-details/${e.related_booking_id}`),children:["View Booking",o.jsx(y,{className:"ml-2 h-4 w-4"})]}),o.jsxs(c,{variant:"default",className:"w-full bg-primary hover:bg-primary/90",onClick:m,children:["Share Location & View Host",o.jsx(p,{className:"ml-2 h-4 w-4"})]})]})]}):o.jsx("p",{className:"text-gray-600 dark:text-gray-300",children:"Notification not found"})]}),o.jsx(k,{})]})};export{A as default};
